<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>mia_processes.utils.tools &#8212; mia_processes 2.6.1-dev+2e50262f documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=659b1fac" />
    <link rel="stylesheet" type="text/css" href="../../../_static/haiku.css?v=d31ea6cb" />
    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js?v=5071eacb"></script>
    <script src="../../../_static/doctools.js?v=888ff710"></script>
    <script src="../../../_static/sphinx_highlight.js?v=4825356b"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
  </head><body>
      <div class="header" role="banner"><h1 class="heading"><a href="../../../index.html">
          <span>mia_processes 2.6.1-dev+2e50262f documentation</span></a></h1>
        <h2 class="heading"><span>mia_processes.utils.tools</span></h2>
      </div>
      <div class="topnav" role="navigation" aria-label="top navigation">
      
        <p>
        <a class="uplink" href="../../../index.html">Contents</a>
        </p>

      </div>
      <div class="content" role="main">
        
        
  <h1>Source code for mia_processes.utils.tools</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Module that contains multiple functions used across mia_processes</span>

<span class="sd">:Contains:</span>
<span class="sd">    :Class:</span>
<span class="sd">        - PageNumCanvas</span>
<span class="sd">        - ReportLine</span>
<span class="sd">    :Functions:</span>
<span class="sd">        - checkFileExt</span>
<span class="sd">        - del_dbFieldValue</span>
<span class="sd">        - dict4runtime_update</span>
<span class="sd">        - get_dbFieldValue</span>
<span class="sd">        - mriqc_get_all_run</span>
<span class="sd">        - mriqc_group_iqms_tsv</span>
<span class="sd">        - plot_boxplot_points</span>
<span class="sd">        - plot_qi2</span>
<span class="sd">        - plot_segmentation</span>
<span class="sd">        - plot_slice_planes</span>
<span class="sd">        - plot_realignment_parameters</span>
<span class="sd">        - set_dbFieldValue</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c1">##########################################################################</span>
<span class="c1"># Populse_mia - Copyright (C) IRMaGe/CEA, 2018</span>
<span class="c1"># Distributed under the terms of the CeCILL license, as published by</span>
<span class="c1"># the CEA-CNRS-INRIA. Refer to the LICENSE file or to</span>
<span class="c1"># http://www.cecill.info/licences/Licence_CeCILL_V2.1-en.html</span>
<span class="c1"># for details.</span>
<span class="c1">##########################################################################</span>

<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">pi</span><span class="p">,</span> <span class="n">sqrt</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">nibabel</span> <span class="k">as</span> <span class="nn">nib</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">colormaps</span>
<span class="kn">from</span> <span class="nn">matplotlib.colors</span> <span class="kn">import</span> <span class="n">LinearSegmentedColormap</span>
<span class="kn">from</span> <span class="nn">mpl_toolkits.axes_grid1</span> <span class="kn">import</span> <span class="n">ImageGrid</span>
<span class="kn">from</span> <span class="nn">nilearn.image</span> <span class="kn">import</span> <span class="n">resample_to_img</span>
<span class="kn">from</span> <span class="nn">nilearn.plotting</span> <span class="kn">import</span> <span class="n">plot_anat</span>
<span class="kn">from</span> <span class="nn">nitransforms.io.afni</span> <span class="kn">import</span> <span class="n">_dicom_real_to_card</span>
<span class="kn">from</span> <span class="nn">populse_mia.data_manager.data_history_inspect</span> <span class="kn">import</span> <span class="n">data_history_pipeline</span>
<span class="kn">from</span> <span class="nn">populse_mia.data_manager.project</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">COLLECTION_CURRENT</span><span class="p">,</span>
    <span class="n">COLLECTION_INITIAL</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">reportlab.lib.units</span> <span class="kn">import</span> <span class="n">mm</span>
<span class="kn">from</span> <span class="nn">reportlab.pdfgen</span> <span class="kn">import</span> <span class="n">canvas</span>
<span class="kn">from</span> <span class="nn">reportlab.platypus</span> <span class="kn">import</span> <span class="n">Flowable</span>
<span class="kn">from</span> <span class="nn">traits.api</span> <span class="kn">import</span> <span class="n">Undefined</span>


<div class="viewcode-block" id="PageNumCanvas"><a class="viewcode-back" href="../../../mia_processes.utils.html#mia_processes.utils.tools.PageNumCanvas">[docs]</a><span class="k">class</span> <span class="nc">PageNumCanvas</span><span class="p">(</span><span class="n">canvas</span><span class="o">.</span><span class="n">Canvas</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;For add \&quot;page number of total\&quot; in each footer.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="PageNumCanvas.__init__"><a class="viewcode-back" href="../../../mia_processes.utils.html#mia_processes.utils.tools.PageNumCanvas.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Constructor.&quot;&quot;&quot;</span>
        <span class="n">canvas</span><span class="o">.</span><span class="n">Canvas</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pages</span> <span class="o">=</span> <span class="p">[]</span></div>

<div class="viewcode-block" id="PageNumCanvas.showPage"><a class="viewcode-back" href="../../../mia_processes.utils.html#mia_processes.utils.tools.PageNumCanvas.showPage">[docs]</a>    <span class="k">def</span> <span class="nf">showPage</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;On a page break, add information to the list.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_startPage</span><span class="p">()</span></div>

<div class="viewcode-block" id="PageNumCanvas.save"><a class="viewcode-back" href="../../../mia_processes.utils.html#mia_processes.utils.tools.PageNumCanvas.save">[docs]</a>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add the page number to each page (page x of y).&quot;&quot;&quot;</span>
        <span class="n">page_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pages</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">page</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">draw_page_number</span><span class="p">(</span><span class="n">page_count</span><span class="p">)</span>
            <span class="n">canvas</span><span class="o">.</span><span class="n">Canvas</span><span class="o">.</span><span class="n">showPage</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="n">canvas</span><span class="o">.</span><span class="n">Canvas</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>

<div class="viewcode-block" id="PageNumCanvas.draw_page_number"><a class="viewcode-back" href="../../../mia_processes.utils.html#mia_processes.utils.tools.PageNumCanvas.draw_page_number">[docs]</a>    <span class="k">def</span> <span class="nf">draw_page_number</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">page_count</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add the page number.&quot;&quot;&quot;</span>
        <span class="n">page</span> <span class="o">=</span> <span class="s2">&quot;Page </span><span class="si">%s</span><span class="s2"> of </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pageNumber</span><span class="p">,</span> <span class="n">page_count</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setFont</span><span class="p">(</span><span class="s2">&quot;Helvetica&quot;</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">drawRightString</span><span class="p">(</span><span class="mi">195</span> <span class="o">*</span> <span class="n">mm</span><span class="p">,</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">mm</span><span class="p">,</span> <span class="n">page</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="ReportLine"><a class="viewcode-back" href="../../../mia_processes.utils.html#mia_processes.utils.tools.ReportLine">[docs]</a><span class="k">class</span> <span class="nc">ReportLine</span><span class="p">(</span><span class="n">Flowable</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Line flowable --- draws a line in a flowable&quot;&quot;&quot;</span>

<div class="viewcode-block" id="ReportLine.__init__"><a class="viewcode-back" href="../../../mia_processes.utils.html#mia_processes.utils.tools.ReportLine.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">Flowable</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">width</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">height</span></div>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Customise the string representation of the ReportLine object</span>

<span class="sd">        :returns: the string representation of the object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;Line(w=</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span>

<div class="viewcode-block" id="ReportLine.draw"><a class="viewcode-back" href="../../../mia_processes.utils.html#mia_processes.utils.tools.ReportLine.draw">[docs]</a>    <span class="k">def</span> <span class="nf">draw</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Draw the line&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">canv</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">height</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="checkFileExt"><a class="viewcode-back" href="../../../mia_processes.utils.html#mia_processes.utils.tools.checkFileExt">[docs]</a><span class="k">def</span> <span class="nf">checkFileExt</span><span class="p">(</span><span class="n">in_file</span><span class="p">,</span> <span class="n">ext_dic</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check file extension</span>

<span class="sd">    :param in_file: file name (a string)</span>
<span class="sd">    :param ext_dic: dictionary of the valid extensions for the file</span>
<span class="sd">                    (dictionary, ex:</span>
<span class="sd">                    EXT = {&#39;NIFTI_GZ&#39;: &#39;nii.gz&#39;, &#39;NIFTI&#39;: &#39;nii&#39;})</span>
<span class="sd">    :returns:</span>
<span class="sd">        - valid_bool: True if extension is valid (a boolean)</span>
<span class="sd">        - in_ext: file extension (a string)</span>
<span class="sd">        - file_name: file name without extension (a string)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Get file extension</span>
    <span class="n">valid_bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">ifile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">in_file</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">file_name</span><span class="p">,</span> <span class="n">in_ext</span> <span class="o">=</span> <span class="n">ifile</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">in_ext</span> <span class="o">==</span> <span class="s2">&quot;gz&quot;</span><span class="p">:</span>
        <span class="p">(</span><span class="n">file_name_2</span><span class="p">,</span> <span class="n">in_ext_2</span><span class="p">)</span> <span class="o">=</span> <span class="n">file_name</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">in_ext</span> <span class="o">=</span> <span class="n">in_ext_2</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">in_ext</span>
        <span class="n">file_name</span> <span class="o">=</span> <span class="n">file_name_2</span>

    <span class="n">valid_ext</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">ext_dic</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

    <span class="k">if</span> <span class="n">in_ext</span> <span class="ow">in</span> <span class="n">valid_ext</span><span class="p">:</span>
        <span class="n">valid_bool</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">return</span> <span class="n">valid_bool</span><span class="p">,</span> <span class="n">in_ext</span><span class="p">,</span> <span class="n">file_name</span></div>


<div class="viewcode-block" id="del_dbFieldValue"><a class="viewcode-back" href="../../../mia_processes.utils.html#mia_processes.utils.tools.del_dbFieldValue">[docs]</a><span class="k">def</span> <span class="nf">del_dbFieldValue</span><span class="p">(</span><span class="n">project</span><span class="p">,</span> <span class="n">document</span><span class="p">,</span> <span class="n">tags2del</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Delete for a document, the value for a field in the db.</span>

<span class="sd">    :param project: the project.</span>
<span class="sd">    :param document: the absolute path of the document.</span>
<span class="sd">    :param tag_to_del: a list of fields where values will be deleted</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">file_position</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">document</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">project</span><span class="o">.</span><span class="n">getName</span><span class="p">())</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">project</span><span class="o">.</span><span class="n">getName</span><span class="p">())</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="p">)</span>
    <span class="n">database_filename</span> <span class="o">=</span> <span class="n">document</span><span class="p">[</span><span class="n">file_position</span><span class="p">:]</span>

    <span class="k">for</span> <span class="n">tag_to_del</span> <span class="ow">in</span> <span class="n">tags2del</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">project</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">remove_value</span><span class="p">(</span>
                <span class="n">COLLECTION_CURRENT</span><span class="p">,</span> <span class="n">database_filename</span><span class="p">,</span> <span class="n">tag_to_del</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="c1"># The collection does not exist</span>
            <span class="c1"># or the field does not exist</span>
            <span class="c1"># or the document does not exist</span>
            <span class="k">pass</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">project</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">remove_value</span><span class="p">(</span>
                <span class="n">COLLECTION_INITIAL</span><span class="p">,</span> <span class="n">database_filename</span><span class="p">,</span> <span class="n">tag_to_del</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="c1"># The collection does not exist</span>
            <span class="c1"># or the field does not exist</span>
            <span class="c1"># or the document does not exist</span>
            <span class="k">pass</span></div>


<div class="viewcode-block" id="dict4runtime_update"><a class="viewcode-back" href="../../../mia_processes.utils.html#mia_processes.utils.tools.dict4runtime_update">[docs]</a><span class="k">def</span> <span class="nf">dict4runtime_update</span><span class="p">(</span><span class="n">dict4runtime</span><span class="p">,</span> <span class="n">database</span><span class="p">,</span> <span class="n">db_filename</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Update the dict4runtime dictionary object with tags values</span>

<span class="sd">    :param dict4runtime: the dict used in mia_processes bricks to pass data</span>
<span class="sd">                         from the list_outputs method to the run_process_mia</span>
<span class="sd">                         method</span>
<span class="sd">    :param database: the database object (for example: self.project.session)</span>
<span class="sd">    :param db_filename: the name of the database file from which the tag value</span>
<span class="sd">                        will be retrieved</span>
<span class="sd">    :param args: the tags to be recovered</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">database</span><span class="o">.</span><span class="n">get_fields_names</span><span class="p">(</span><span class="n">COLLECTION_CURRENT</span><span class="p">):</span>
            <span class="n">dict4runtime</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span>
                <span class="n">COLLECTION_CURRENT</span><span class="p">,</span> <span class="n">db_filename</span><span class="p">,</span> <span class="n">tag</span>
            <span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">dict4runtime</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Undefined&quot;</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dict4runtime</span><span class="p">[</span><span class="n">tag</span><span class="p">],</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">):</span>
            <span class="n">dict4runtime</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">dict4runtime</span><span class="p">[</span><span class="n">tag</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">dict4runtime</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dict4runtime</span><span class="p">[</span><span class="n">tag</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Undefined&quot;</span></div>


<div class="viewcode-block" id="get_dbFieldValue"><a class="viewcode-back" href="../../../mia_processes.utils.html#mia_processes.utils.tools.get_dbFieldValue">[docs]</a><span class="k">def</span> <span class="nf">get_dbFieldValue</span><span class="p">(</span><span class="n">project</span><span class="p">,</span> <span class="n">document</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return, for a document, the field value from the database.</span>

<span class="sd">    :param project: the project.</span>
<span class="sd">    :param document: the absolute path of the document.</span>
<span class="sd">    :param field: the field name.</span>
<span class="sd">    :returns: the value of the field for the document in the database.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">file_position</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">document</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">project</span><span class="o">.</span><span class="n">getName</span><span class="p">())</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">project</span><span class="o">.</span><span class="n">getName</span><span class="p">())</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="p">)</span>
    <span class="n">database_filename</span> <span class="o">=</span> <span class="n">document</span><span class="p">[</span><span class="n">file_position</span><span class="p">:]</span>

    <span class="k">return</span> <span class="n">project</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span>
        <span class="n">COLLECTION_CURRENT</span><span class="p">,</span> <span class="n">database_filename</span><span class="p">,</span> <span class="n">field</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="mriqc_get_all_run"><a class="viewcode-back" href="../../../mia_processes.utils.html#mia_processes.utils.tools.mriqc_get_all_run">[docs]</a><span class="k">def</span> <span class="nf">mriqc_get_all_run</span><span class="p">(</span><span class="n">modality</span><span class="p">,</span> <span class="n">project</span><span class="p">,</span> <span class="n">output_directory</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get all raw files name with a mriqc run for one project and</span>
<span class="sd">    for one modality.</span>

<span class="sd">    :param modality: modality (a string, &#39;bold&#39; or &#39;anat&#39;)</span>
<span class="sd">    :param project: the project (Project Object)</span>
<span class="sd">    :param output_directory: output directory where all json files are stored</span>
<span class="sd">                             (a string that representing a path)</span>
<span class="sd">    :returns:</span>
<span class="sd">        - files_names (a list)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Get all json</span>
    <span class="n">jsonfiles</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_directory</span><span class="p">,</span> <span class="s2">&quot;*&quot;</span> <span class="o">+</span> <span class="n">modality</span> <span class="o">+</span> <span class="s2">&quot;_qc.json&quot;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">jsonfiles</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="n">files_name</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">jsonfile</span> <span class="ow">in</span> <span class="n">jsonfiles</span><span class="p">:</span>
        <span class="n">file_position</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">jsonfile</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">project</span><span class="o">.</span><span class="n">getName</span><span class="p">())</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">project</span><span class="o">.</span><span class="n">getName</span><span class="p">())</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="p">)</span>
        <span class="n">json_database_filename</span> <span class="o">=</span> <span class="n">jsonfile</span><span class="p">[</span><span class="n">file_position</span><span class="p">:]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">file_name</span> <span class="o">=</span> <span class="n">data_history_pipeline</span><span class="p">(</span>
                <span class="n">json_database_filename</span><span class="p">,</span> <span class="n">project</span>
            <span class="p">)</span><span class="o">.</span><span class="n">in_file</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="c1"># if we removed all mriqc data except json and pdf</span>
            <span class="n">file_name</span> <span class="o">=</span> <span class="n">json_database_filename</span>
        <span class="n">files_name</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">files_name</span></div>


<div class="viewcode-block" id="mriqc_group_iqms_tsv"><a class="viewcode-back" href="../../../mia_processes.utils.html#mia_processes.utils.tools.mriqc_group_iqms_tsv">[docs]</a><span class="k">def</span> <span class="nf">mriqc_group_iqms_tsv</span><span class="p">(</span><span class="n">modality</span><span class="p">,</span> <span class="n">output_directory</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get all IQMs from mriqc json report for one project</span>
<span class="sd">    and for one modality and put them together in one tsv file.</span>

<span class="sd">    :param modality: modality (a string, &#39;bold&#39; or &#39;anat&#39;)</span>
<span class="sd">    :param output_directory: output directory where all json files are stored</span>
<span class="sd">                             (a string that representing a path)</span>
<span class="sd">    :returns:</span>
<span class="sd">        - dataframe: all IQMs in a panda dataframe</span>
<span class="sd">        - out_tsv: out tsv file (a string that representing a file)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;_%Y_%m_</span><span class="si">%d</span><span class="s2">_%H_%M_%S_</span><span class="si">%f</span><span class="s2">&quot;</span><span class="p">)[:</span><span class="mi">22</span><span class="p">]</span>
    <span class="c1"># Get all json</span>
    <span class="n">jsonfiles</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_directory</span><span class="p">,</span> <span class="s2">&quot;*&quot;</span> <span class="o">+</span> <span class="n">modality</span> <span class="o">+</span> <span class="s2">&quot;_qc.json&quot;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">jsonfiles</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>

    <span class="n">tags_to_remove</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;histogram_qi2_x_grid&quot;</span><span class="p">,</span>
        <span class="s2">&quot;histogram_qi2_ref_pdf&quot;</span><span class="p">,</span>
        <span class="s2">&quot;histogram_qi2_fit_pdf&quot;</span><span class="p">,</span>
        <span class="s2">&quot;histogram_qi2_ref_data&quot;</span><span class="p">,</span>
        <span class="s2">&quot;histogram_qi2_cutoff_idx&quot;</span><span class="p">,</span>
        <span class="s2">&quot;vec_outliers&quot;</span><span class="p">,</span>
        <span class="s2">&quot;vec_fd&quot;</span><span class="p">,</span>
        <span class="s2">&quot;vec_dvars&quot;</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="n">datalist</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">jsonfile</span> <span class="ow">in</span> <span class="n">jsonfiles</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">jsonfile</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">tags_to_remove</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">tag</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                    <span class="n">data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="k">if</span> <span class="s2">&quot;vec_spikes&quot;</span> <span class="ow">in</span> <span class="n">tag</span><span class="p">:</span>
                    <span class="n">data</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;file_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">jsonfile</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;anat_qc.json&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;bold_qc.json&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;mean_reg_&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">datalist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="n">dataframe</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">datalist</span><span class="p">)</span>
    <span class="n">cols</span> <span class="o">=</span> <span class="n">dataframe</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">dataframe</span> <span class="o">=</span> <span class="n">dataframe</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;file_name&quot;</span><span class="p">])</span>

    <span class="n">out_tsv</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="n">output_directory</span><span class="p">,</span> <span class="s2">&quot;mriqc_group_report_&quot;</span> <span class="o">+</span> <span class="n">modality</span> <span class="o">+</span> <span class="n">date</span> <span class="o">+</span> <span class="s2">&quot;.tsv&quot;</span>
    <span class="p">)</span>

    <span class="c1"># Set filename at front</span>
    <span class="n">cols</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">cols</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">cols</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;file_name&quot;</span><span class="p">)))</span>
    <span class="n">dataframe</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">out_tsv</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">dataframe</span><span class="p">,</span> <span class="n">out_tsv</span></div>


<div class="viewcode-block" id="plot_realignment_parameters"><a class="viewcode-back" href="../../../mia_processes.utils.html#mia_processes.utils.tools.plot_realignment_parameters">[docs]</a><span class="k">def</span> <span class="nf">plot_realignment_parameters</span><span class="p">(</span>
    <span class="n">realignment_parameters</span><span class="p">,</span>
    <span class="n">vox_size</span><span class="p">,</span>
    <span class="n">out_file_tra</span><span class="p">,</span>
    <span class="n">out_file_rot</span><span class="p">,</span>
    <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mf">5.6</span><span class="p">),</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot SPM realignment parameters.</span>

<span class="sd">    :param realignment_parameters: realignment parameters file</span>
<span class="sd">                                   (a string representing an existing file) or</span>
<span class="sd">                                   realignment parameters (a numpy.ndarray</span>
<span class="sd">                                   object with shape[1] == 6)</span>
<span class="sd">    :param vox_size: voxel size of the data (a list of 3 float or integer)</span>
<span class="sd">    :param out_file_tra: out path for the translation figure (a string</span>
<span class="sd">                         representing a path file)</span>
<span class="sd">    :param out_file_rot: out path for the rotation figure (a string</span>
<span class="sd">                         representing a path file)</span>
<span class="sd">    :param figsize: width, height of parametric maps plot, in inches (float,</span>
<span class="sd">                    float)</span>

<span class="sd">    :returns:</span>
<span class="sd">        - qc: result of the quality check (a boolean). True: OK</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># TODO: it seems that this function is not sufficiently protected against</span>
    <span class="c1">#       exceptions being thrown</span>

    <span class="n">qc</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">(</span>
        <span class="n">rmsdTra</span><span class="p">,</span>
        <span class="n">maxRmsdTra</span><span class="p">,</span>
        <span class="n">maxTra</span><span class="p">,</span>
        <span class="n">maxTraCheck</span><span class="p">,</span>
        <span class="n">minTra</span><span class="p">,</span>
        <span class="n">rmsdRot</span><span class="p">,</span>
        <span class="n">maxRmsdRot</span><span class="p">,</span>
        <span class="n">maxRot</span><span class="p">,</span>
        <span class="n">maxRotCheck</span><span class="p">,</span>
        <span class="n">minRot</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>

    <span class="c1"># Ensure realignment_parameters is a valid path or a NumPy array with</span>
    <span class="c1"># the expected shape</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span>
        <span class="n">realignment_parameters</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span><span class="p">)</span>
    <span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">realignment_parameters</span><span class="p">):</span>
        <span class="c1"># If it&#39;s a valid file path, load the data</span>
        <span class="n">data_rp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">realignment_parameters</span><span class="p">)</span>

    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">realignment_parameters</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>

        <span class="c1"># If it&#39;s a NumPy array, check if it has the expected shape</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">realignment_parameters</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="ow">and</span> <span class="n">realignment_parameters</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">6</span>
        <span class="p">):</span>
            <span class="n">data_rp</span> <span class="o">=</span> <span class="n">realignment_parameters</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;The NumPy array must have 6 columns and &quot;</span> <span class="s2">&quot;non-zero size.&quot;</span>
            <span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># TODO: perhaps we should protect the next steps if</span>
        <span class="c1">#  realignment_parameters is neither an existing file</span>
        <span class="c1">#  nor a numpy array?</span>
        <span class="k">pass</span>

    <span class="n">data_rp</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">:]</span> <span class="o">=</span> <span class="n">data_rp</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">:]</span> <span class="o">*</span> <span class="mi">180</span> <span class="o">/</span> <span class="n">pi</span>  <span class="c1"># Rad to deg conversion</span>
    <span class="n">xLim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_rp</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="c1"># Create x-values starting from 1</span>
    <span class="n">x_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_rp</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">data_rp</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]:</span>
            <span class="n">rmsdTra</span> <span class="o">=</span> <span class="n">rmsdTra</span> <span class="o">+</span> <span class="n">n</span><span class="o">**</span><span class="mi">2</span>

        <span class="n">rmsdTra</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">rmsdTra</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_rp</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]))</span>

        <span class="k">if</span> <span class="n">rmsdTra</span> <span class="o">&gt;</span> <span class="n">maxRmsdTra</span><span class="p">:</span>
            <span class="c1"># maxRmsdTra: Maximum root-mean-square deviation for</span>
            <span class="c1"># x, y, z linear motion</span>
            <span class="n">maxRmsdTra</span> <span class="o">=</span> <span class="n">rmsdTra</span>

        <span class="n">rmsdTra</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">data_rp</span><span class="p">[:,</span> <span class="n">i</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">maxTra</span><span class="p">:</span>
            <span class="c1"># maxTra: Maximum x, y, z linear motion in</span>
            <span class="c1"># POSITIVE direction</span>
            <span class="n">maxTra</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">data_rp</span><span class="p">[:,</span> <span class="n">i</span><span class="p">])</span>

        <span class="k">if</span> <span class="nb">min</span><span class="p">(</span><span class="n">data_rp</span><span class="p">[:,</span> <span class="n">i</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">minTra</span><span class="p">:</span>
            <span class="c1"># minTra: Maximum x, y, z linear motion in</span>
            <span class="c1"># NEGATIVE direction</span>
            <span class="n">minTra</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">data_rp</span><span class="p">[:,</span> <span class="n">i</span><span class="p">])</span>

    <span class="n">maxTraCheck</span> <span class="o">=</span> <span class="n">maxTra</span>

    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">minTra</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">maxTra</span><span class="p">:</span>
        <span class="n">maxTraCheck</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">minTra</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">data_rp</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]:</span>
            <span class="n">rmsdRot</span> <span class="o">=</span> <span class="n">rmsdRot</span> <span class="o">+</span> <span class="n">n</span><span class="o">**</span><span class="mi">2</span>

        <span class="n">rmsdRot</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">rmsdRot</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">data_rp</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]))</span>

        <span class="k">if</span> <span class="n">rmsdRot</span> <span class="o">&gt;</span> <span class="n">maxRmsdRot</span><span class="p">:</span>
            <span class="c1"># maxRmsdRot: Maximum root-mean-square deviation for</span>
            <span class="c1"># roll, pitch, yaw rotational motion</span>
            <span class="n">maxRmsdRot</span> <span class="o">=</span> <span class="n">rmsdRot</span>

        <span class="n">rmsdRot</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="nb">max</span><span class="p">(</span><span class="n">data_rp</span><span class="p">[:,</span> <span class="n">i</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">maxRot</span><span class="p">:</span>
            <span class="c1"># maxRot: Maximum roll, pitch, yaw rotational motion in</span>
            <span class="c1"># POSITIVE direction</span>
            <span class="n">maxRot</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">data_rp</span><span class="p">[:,</span> <span class="n">i</span><span class="p">])</span>

        <span class="k">if</span> <span class="nb">min</span><span class="p">(</span><span class="n">data_rp</span><span class="p">[:,</span> <span class="n">i</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">minRot</span><span class="p">:</span>
            <span class="c1"># minRot: Maximum roll, pitch, yaw rotational motion in</span>
            <span class="c1"># NEGATIVE direction</span>
            <span class="n">minRot</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">data_rp</span><span class="p">[:,</span> <span class="n">i</span><span class="p">])</span>

    <span class="n">maxRotCheck</span> <span class="o">=</span> <span class="n">maxRot</span>

    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">minRot</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">maxRot</span><span class="p">:</span>
        <span class="n">maxRotCheck</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">minRot</span><span class="p">)</span>

    <span class="k">if</span> <span class="s2">&quot;Undefined&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">vox_size</span><span class="p">:</span>
        <span class="c1"># Mean x,y,z voxel dimension calculation.</span>
        <span class="n">traLim</span> <span class="o">=</span> <span class="p">(</span><span class="n">vox_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">vox_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">vox_size</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">*</span> <span class="mi">1</span> <span class="o">/</span> <span class="mi">3</span>

        <span class="c1"># maxRot for quality fixed to 2deg</span>
        <span class="c1"># maxTra(nslation) for quality fixed to</span>
        <span class="c1"># mean x,y,z voxel dim (traLim)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">maxTraCheck</span> <span class="o">&lt;</span> <span class="n">traLim</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">maxRotCheck</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">):</span>
            <span class="n">qc</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># Plot translation</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">)</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span>
        <span class="n">left</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">bottom</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">right</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">top</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">wspace</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">hspace</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Linear head motion parameters&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">1.03</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Dynamic scans&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Linear motion -X, Y, Z- (mm)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="c1"># Plot using x_values for the x-axis</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_values</span><span class="p">,</span> <span class="n">data_rp</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">3</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;X&quot;</span><span class="p">,</span> <span class="s2">&quot;Y&quot;</span><span class="p">,</span> <span class="s2">&quot;Z&quot;</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;best&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">xLim</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">minTra</span> <span class="o">*</span> <span class="mf">1.1</span><span class="p">,</span> <span class="n">maxTra</span> <span class="o">*</span> <span class="mf">1.1</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s2">&quot;major&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;grey&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s2">&quot;major&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;grey&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">get_yaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_tick_params</span><span class="p">(</span><span class="n">direction</span><span class="o">=</span><span class="s2">&quot;out&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">get_xaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_tick_params</span><span class="p">(</span><span class="n">direction</span><span class="o">=</span><span class="s2">&quot;out&quot;</span><span class="p">)</span>
    <span class="c1"># High resolution: 2000px  1118px.</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">out_file_tra</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;png&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="c1"># Plot rotation</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Rotational head motion parameters&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">1.03</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Dynamic scans&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Rotational motion -Roll, Pitch, Yaw- ()&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_values</span><span class="p">,</span> <span class="n">data_rp</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">:],</span> <span class="n">label</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;Roll&quot;</span><span class="p">,</span> <span class="s2">&quot;Pitch&quot;</span><span class="p">,</span> <span class="s2">&quot;Yaw&quot;</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;best&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">xLim</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">minRot</span> <span class="o">*</span> <span class="mf">1.1</span><span class="p">,</span> <span class="n">maxRot</span> <span class="o">*</span> <span class="mf">1.1</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s2">&quot;major&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;grey&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s2">&quot;major&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;grey&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="c1"># High resolution: 2000px  1118px.</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">out_file_rot</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;png&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">qc</span></div>


<div class="viewcode-block" id="plot_boxplot_points"><a class="viewcode-back" href="../../../mia_processes.utils.html#mia_processes.utils.tools.plot_boxplot_points">[docs]</a><span class="k">def</span> <span class="nf">plot_boxplot_points</span><span class="p">(</span><span class="n">dataframe</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">ylabel</span><span class="p">,</span> <span class="n">out_file</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot boxplot with points data and save the figure in a png image</span>

<span class="sd">    :param dataframe: tabular data (a pandas dataframe)</span>
<span class="sd">    :param title: figure title (a string)</span>
<span class="sd">    :param ylabel: y axis label (a string)</span>
<span class="sd">    :param out_file: out figure path (a string)</span>

<span class="sd">    :returns:</span>
<span class="sd">        - out_file: out figure path (a string)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">vals</span><span class="p">,</span> <span class="n">names</span><span class="p">,</span> <span class="n">xs</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dataframe</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
        <span class="n">vals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dataframe</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="n">names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
        <span class="n">xs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mf">1.3</span><span class="p">,</span> <span class="mf">0.04</span><span class="p">,</span> <span class="n">dataframe</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">vals</span><span class="p">,</span> <span class="n">sym</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">names</span><span class="p">)</span>

    <span class="n">palette</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="s2">&quot;g&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;c&quot;</span><span class="p">,</span> <span class="s2">&quot;m&quot;</span><span class="p">]</span>
    <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">palette</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">vals</span><span class="p">):</span>
        <span class="n">palette</span> <span class="o">+=</span> <span class="n">palette</span>

    <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">vals</span><span class="p">,</span> <span class="n">palette</span><span class="p">):</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">c</span><span class="p">)</span>

    <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">axisbelow</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="n">ylabel</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">labelrotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">out_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">out_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s2">&quot;box_plot.png&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">out_file</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;png&quot;</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">out_file</span></div>


<div class="viewcode-block" id="plot_qi2"><a class="viewcode-back" href="../../../mia_processes.utils.html#mia_processes.utils.tools.plot_qi2">[docs]</a><span class="k">def</span> <span class="nf">plot_qi2</span><span class="p">(</span><span class="n">x_grid</span><span class="p">,</span> <span class="n">ref_pdf</span><span class="p">,</span> <span class="n">fit_pdf</span><span class="p">,</span> <span class="n">ref_data</span><span class="p">,</span> <span class="n">cutoff_idx</span><span class="p">,</span> <span class="n">out_file</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;bla bla&quot;&quot;&quot;</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
        <span class="n">x_grid</span><span class="p">,</span>
        <span class="n">ref_pdf</span><span class="p">,</span>
        <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="s2">&quot;background&quot;</span><span class="p">,</span>
        <span class="n">color</span><span class="o">=</span><span class="s2">&quot;dodgerblue&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">refmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">ref_data</span><span class="p">,</span> <span class="mf">99.95</span><span class="p">)</span>
    <span class="n">x_max</span> <span class="o">=</span> <span class="n">x_grid</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span>
        <span class="n">ref_data</span><span class="p">,</span>
        <span class="mi">40</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">refmax</span> <span class="o">/</span> <span class="n">x_max</span><span class="p">),</span> <span class="mi">1</span><span class="p">),</span>
        <span class="n">fc</span><span class="o">=</span><span class="s2">&quot;dodgerblue&quot;</span><span class="p">,</span>
        <span class="n">histtype</span><span class="o">=</span><span class="s2">&quot;stepfilled&quot;</span><span class="p">,</span>
        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
        <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">fit_pdf</span><span class="p">[</span><span class="n">fit_pdf</span> <span class="o">&gt;</span> <span class="mf">1.0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
        <span class="n">x_grid</span><span class="p">,</span>
        <span class="n">fit_pdf</span><span class="p">,</span>
        <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="s2">&quot;chi2&quot;</span><span class="p">,</span>
        <span class="n">color</span><span class="o">=</span><span class="s2">&quot;darkorange&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">ylims</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span>
        <span class="n">x_grid</span><span class="p">[</span><span class="o">-</span><span class="n">cutoff_idx</span><span class="p">],</span>
        <span class="n">ymax</span><span class="o">=</span><span class="n">ref_pdf</span><span class="p">[</span><span class="o">-</span><span class="n">cutoff_idx</span><span class="p">]</span> <span class="o">/</span> <span class="n">ylims</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
        <span class="n">color</span><span class="o">=</span><span class="s2">&quot;dodgerblue&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Intensity within &quot;hat&quot; mask&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Frequency&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">x_max</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">out_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">out_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="s2">&quot;qi2_plot.png&quot;</span><span class="p">)</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">out_file</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">,</span> <span class="n">pad_inches</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out_file</span></div>


<div class="viewcode-block" id="plot_segmentation"><a class="viewcode-back" href="../../../mia_processes.utils.html#mia_processes.utils.tools.plot_segmentation">[docs]</a><span class="k">def</span> <span class="nf">plot_segmentation</span><span class="p">(</span><span class="n">anat_file</span><span class="p">,</span> <span class="n">segmentation</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">out_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Adapted from</span>
<span class="sd">    &lt;https://github.com/nipreps/mriqc/blob/5a0f0408bd0c176dbc46088c6ffe279269180f3f/mriqc/viz/utils.py#L550&gt;</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">vmax</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;vmax&quot;</span><span class="p">)</span>
    <span class="n">vmin</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;vmin&quot;</span><span class="p">)</span>

    <span class="n">anat_ras</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">as_closest_canonical</span><span class="p">(</span><span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">anat_file</span><span class="p">))</span>
    <span class="n">anat_ras_plumb</span> <span class="o">=</span> <span class="n">anat_ras</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span>
        <span class="n">anat_ras</span><span class="o">.</span><span class="n">dataobj</span><span class="p">,</span> <span class="n">_dicom_real_to_card</span><span class="p">(</span><span class="n">anat_ras</span><span class="o">.</span><span class="n">affine</span><span class="p">),</span> <span class="n">anat_ras</span><span class="o">.</span><span class="n">header</span>
    <span class="p">)</span>

    <span class="n">seg_ras</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">as_closest_canonical</span><span class="p">(</span><span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">segmentation</span><span class="p">))</span>
    <span class="n">seg_ras_plumb</span> <span class="o">=</span> <span class="n">seg_ras</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span>
        <span class="n">seg_ras</span><span class="o">.</span><span class="n">dataobj</span><span class="p">,</span> <span class="n">_dicom_real_to_card</span><span class="p">(</span><span class="n">seg_ras</span><span class="o">.</span><span class="n">affine</span><span class="p">),</span> <span class="n">seg_ras</span><span class="o">.</span><span class="n">header</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;saturate&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
        <span class="n">vmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">anat_ras</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="mi">70</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">vmax</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">vmin</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">vmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">anat_ras</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="mi">10</span><span class="p">)</span>
        <span class="n">vmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">anat_ras</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="mi">99</span><span class="p">)</span>

    <span class="n">disp</span> <span class="o">=</span> <span class="n">plot_anat</span><span class="p">(</span>
        <span class="n">anat_ras_plumb</span><span class="p">,</span>
        <span class="n">display_mode</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;display_mode&quot;</span><span class="p">,</span> <span class="s2">&quot;ortho&quot;</span><span class="p">),</span>
        <span class="n">cut_coords</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cut_coords&quot;</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span>
        <span class="n">title</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">),</span>
        <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span>
        <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">disp</span><span class="o">.</span><span class="n">add_contours</span><span class="p">(</span>
        <span class="n">seg_ras_plumb</span><span class="p">,</span>
        <span class="n">levels</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;levels&quot;</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
        <span class="n">colors</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;colors&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="n">fname</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">anat_file</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">out_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">out_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">fname</span> <span class="o">+</span> <span class="s2">&quot;_slice_planes_plot.png&quot;</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">out_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="n">fname</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;.png&quot;</span><span class="p">)</span>

    <span class="n">disp</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">out_file</span><span class="p">)</span>
    <span class="n">disp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">disp</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">out_file</span></div>


<div class="viewcode-block" id="set_dbFieldValue"><a class="viewcode-back" href="../../../mia_processes.utils.html#mia_processes.utils.tools.set_dbFieldValue">[docs]</a><span class="k">def</span> <span class="nf">set_dbFieldValue</span><span class="p">(</span><span class="n">project</span><span class="p">,</span> <span class="n">document</span><span class="p">,</span> <span class="n">tag_to_add</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Creates for a document, the field and the corresponding value in the db.</span>

<span class="sd">    :param project: the project.</span>
<span class="sd">    :param document: the absolute path of the document.</span>
<span class="sd">    :param tag_to_add: a dictionary with &#39;default_value&#39;, &#39;description&#39;,</span>
<span class="sd">                      &#39;field_type&#39;, &#39;name&#39;, &#39;origin&#39;, &#39;unit&#39;, &#39;value&#39;,</span>
<span class="sd">                      &#39;visibility&#39; keys.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">file_position</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">document</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">project</span><span class="o">.</span><span class="n">getName</span><span class="p">())</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">project</span><span class="o">.</span><span class="n">getName</span><span class="p">())</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="p">)</span>
    <span class="n">database_filename</span> <span class="o">=</span> <span class="n">document</span><span class="p">[</span><span class="n">file_position</span><span class="p">:]</span>

    <span class="k">if</span> <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">project</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get_fields_names</span><span class="p">(</span>
        <span class="n">COLLECTION_CURRENT</span>
    <span class="p">):</span>
        <span class="n">project</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add_field</span><span class="p">(</span>
            <span class="n">COLLECTION_CURRENT</span><span class="p">,</span>
            <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span>
            <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;field_type&quot;</span><span class="p">],</span>
            <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">],</span>
            <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;visibility&quot;</span><span class="p">],</span>
            <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;origin&quot;</span><span class="p">],</span>
            <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;unit&quot;</span><span class="p">],</span>
            <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;default_value&quot;</span><span class="p">],</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">project</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get_fields_names</span><span class="p">(</span>
        <span class="n">COLLECTION_INITIAL</span>
    <span class="p">):</span>
        <span class="n">project</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add_field</span><span class="p">(</span>
            <span class="n">COLLECTION_INITIAL</span><span class="p">,</span>
            <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span>
            <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;field_type&quot;</span><span class="p">],</span>
            <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">],</span>
            <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;visibility&quot;</span><span class="p">],</span>
            <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;origin&quot;</span><span class="p">],</span>
            <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;unit&quot;</span><span class="p">],</span>
            <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;default_value&quot;</span><span class="p">],</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">project</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get_document</span><span class="p">(</span><span class="n">COLLECTION_CURRENT</span><span class="p">,</span> <span class="n">database_filename</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Path </span><span class="si">{0}</span><span class="s2"> already in database.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">database_filename</span><span class="p">))</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">project</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add_document</span><span class="p">(</span><span class="n">COLLECTION_CURRENT</span><span class="p">,</span> <span class="n">database_filename</span><span class="p">)</span>
        <span class="n">project</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add_document</span><span class="p">(</span><span class="n">COLLECTION_INITIAL</span><span class="p">,</span> <span class="n">database_filename</span><span class="p">)</span>

    <span class="n">project</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">set_values</span><span class="p">(</span>
        <span class="n">COLLECTION_CURRENT</span><span class="p">,</span>
        <span class="n">database_filename</span><span class="p">,</span>
        <span class="p">{</span><span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]:</span> <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]},</span>
    <span class="p">)</span>
    <span class="n">project</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">set_values</span><span class="p">(</span>
        <span class="n">COLLECTION_INITIAL</span><span class="p">,</span>
        <span class="n">database_filename</span><span class="p">,</span>
        <span class="p">{</span><span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]:</span> <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]},</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="plot_slice_planes"><a class="viewcode-back" href="../../../mia_processes.utils.html#mia_processes.utils.tools.plot_slice_planes">[docs]</a><span class="k">def</span> <span class="nf">plot_slice_planes</span><span class="p">(</span>
    <span class="n">data_1</span><span class="p">,</span>
    <span class="n">data_2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">plane</span><span class="o">=</span><span class="s2">&quot;ax&quot;</span><span class="p">,</span>
    <span class="n">fig_rows</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
    <span class="n">fig_cols</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
    <span class="n">slice_start</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">slice_step</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">dyn</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">cmap_1</span><span class="o">=</span><span class="s2">&quot;Greys_r&quot;</span><span class="p">,</span>
    <span class="n">vmin_1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">vmax_1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">cmap_2</span><span class="o">=</span><span class="s2">&quot;rainbow&quot;</span><span class="p">,</span>
    <span class="n">vmin_2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">vmax_2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">out_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">only_noise</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">out_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create a PNG file with a mosaic display of volume slices.</span>

<span class="sd">    Several images can be overlaid. data_1, the only mandatory argument,</span>
<span class="sd">    is the background image (or the only image displayed). data_2 is the</span>
<span class="sd">    image (or images) superimposed on data_1.</span>

<span class="sd">    fig_rows, fig_cols, slice_start and slice_step are optional. If they are</span>
<span class="sd">    not known, plot_slice_planes will try to adapt as best it can to obtain</span>
<span class="sd">    an acceptable display. The default values for fig_rows, fig_cols and dyn</span>
<span class="sd">    are 4, 4 and 1 respectively.</span>

<span class="sd">    :param data_1: an existing, image file (valid extensions: .nii).</span>
<span class="sd">    :param data_2: an existing, image file or a list of existing image files</span>
<span class="sd">                   (valid extensions: .nii).</span>
<span class="sd">    :param plane: orientation plane (ax, sag or cor)</span>
<span class="sd">    :param fig_rows: the number of rows in the images panel (integer).</span>
<span class="sd">    :param fig_cols: the number of columns in the images panel (integer).</span>
<span class="sd">    :param slice_start: starting slice number to be displayed (integer).</span>
<span class="sd">    :param slice_step: the gap between each slice to be displayed (integer).</span>
<span class="sd">    :param dyn: the volume number in the space-time, for 4D (integer).</span>
<span class="sd">    :param cmap_1: the color map name (string) for data_1.</span>
<span class="sd">    :param vmin_1: the low value of the range used for data_1 display(float).</span>
<span class="sd">    :param vmax_1: the high value of the range used for data_1 display(float).</span>
<span class="sd">    :param cmap_2: the color map name (string) or a list of RGB tuple</span>
<span class="sd">                   (ex. [(255, 0, 0), (0, 0, 255)]).</span>
<span class="sd">    :param vmin_2: the low value of the range used for data_2 display(float).</span>
<span class="sd">    :param vmax_2: the high value of the range used for data_2 display(float).</span>
<span class="sd">    :param out_dir: the output directory where the mosaic images will be saved.</span>
<span class="sd">    :param only_noise: if True, shows the noise (boolean).</span>
<span class="sd">    :param out_name: the suffix added to form the output name (string).</span>

<span class="sd">    Note: cmap for parametric display can be, gist_rainbow, RdYlBu, Spectral,</span>
<span class="sd">          rainbow_r, jet_r, seismic_r, bwr_r</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">plane</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;ax&quot;</span><span class="p">,</span> <span class="s2">&quot;cor&quot;</span><span class="p">,</span> <span class="s2">&quot;sag&quot;</span><span class="p">]:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Parameter plane should be either ax, sag or cor&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="n">brain_img_1</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">as_closest_canonical</span><span class="p">(</span><span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">data_1</span><span class="p">))</span>
    <span class="n">brain_data_1</span> <span class="o">=</span> <span class="n">brain_img_1</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">()</span>
    <span class="n">brain_data_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">brain_data_1</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">cmap_1</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">Undefined</span><span class="p">):</span>
        <span class="n">cmap_1</span> <span class="o">=</span> <span class="s2">&quot;Greys_r&quot;</span>

    <span class="n">cmap_1</span> <span class="o">=</span> <span class="n">colormaps</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">cmap_1</span><span class="p">)</span>
    <span class="n">cmap_1</span><span class="o">.</span><span class="n">set_bad</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>
    <span class="n">brain_data_2</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">data_2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">brain_data_2</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">cmap_2_tmp</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">vmin_2_tmp</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">vmax_2_tmp</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data_2</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="n">data_2</span> <span class="o">=</span> <span class="p">[</span><span class="n">data_2</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">fil</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data_2</span><span class="p">):</span>
            <span class="n">brain_img_2</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">as_closest_canonical</span><span class="p">(</span><span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fil</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">brain_img_1</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="n">brain_img_2</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">3</span><span class="p">]:</span>
                <span class="n">brain_img_2</span> <span class="o">=</span> <span class="n">resample_to_img</span><span class="p">(</span>
                    <span class="n">brain_img_2</span><span class="p">,</span> <span class="n">brain_img_1</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span>
                <span class="p">)</span>

            <span class="n">data</span> <span class="o">=</span> <span class="n">brain_img_2</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

            <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">nan_indexes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">cmap_2</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">Undefined</span><span class="p">):</span>
                <span class="n">cmap</span> <span class="o">=</span> <span class="s2">&quot;rainbow&quot;</span>

            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cmap_2</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">cmap</span> <span class="o">=</span> <span class="n">cmap_2</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cmap_2</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">cmap</span> <span class="o">=</span> <span class="n">cmap_2</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fix</span><span class="p">(</span><span class="n">i</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))]</span>
                <span class="n">norm_mask_color</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">channel</span> <span class="o">/</span> <span class="mi">255</span> <span class="k">for</span> <span class="n">channel</span> <span class="ow">in</span> <span class="n">cmap</span><span class="p">)</span>
                <span class="n">cmap</span> <span class="o">=</span> <span class="n">LinearSegmentedColormap</span><span class="o">.</span><span class="n">from_list</span><span class="p">(</span>
                    <span class="s2">&quot;CustomCmap&quot;</span><span class="p">,</span> <span class="p">[</span><span class="n">norm_mask_color</span><span class="p">,</span> <span class="n">norm_mask_color</span><span class="p">]</span>
                <span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">cmap</span> <span class="o">=</span> <span class="n">colormaps</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">cmap</span><span class="p">)</span>

            <span class="n">cmap</span><span class="o">.</span><span class="n">set_bad</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

            <span class="c1"># Remainder:</span>
            <span class="c1"># Amigo beta cmap vmin - vmax:0.01 - 0.25</span>
            <span class="c1"># Amigo SPMt cmap vmin - vmax:3 - 16</span>

            <span class="k">if</span> <span class="n">vmin_2</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">Undefined</span><span class="p">):</span>
                <span class="n">vmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="o">~</span><span class="n">nan_indexes</span><span class="p">])</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">vmin</span> <span class="o">=</span> <span class="n">vmin_2</span>

            <span class="k">if</span> <span class="n">vmin</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">vmin</span> <span class="o">=</span> <span class="mf">0.1</span>

            <span class="k">if</span> <span class="n">vmax_2</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">Undefined</span><span class="p">):</span>
                <span class="n">vmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="o">~</span><span class="n">nan_indexes</span><span class="p">])</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">vmax</span> <span class="o">=</span> <span class="n">vmax_2</span>

            <span class="n">brain_data_2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">cmap_2_tmp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cmap</span><span class="p">)</span>
            <span class="n">vmin_2_tmp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vmin</span><span class="p">)</span>
            <span class="n">vmax_2_tmp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vmax</span><span class="p">)</span>

        <span class="n">cmap_2</span> <span class="o">=</span> <span class="n">cmap_2_tmp</span>
        <span class="n">vmin_2</span> <span class="o">=</span> <span class="n">vmin_2_tmp</span>
        <span class="n">vmax_2</span> <span class="o">=</span> <span class="n">vmax_2_tmp</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">brain_data_1</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
        <span class="n">brain_data_1</span> <span class="o">=</span> <span class="n">brain_data_1</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">dyn</span><span class="p">]</span>

    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">brain_data_1</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">:</span>
        <span class="c1"># TODO: what we do in this case?</span>
        <span class="k">pass</span>

    <span class="n">min_thres</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">brain_data_1</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
    <span class="n">mask_data_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">brain_data_1</span><span class="p">)</span>
    <span class="n">mask_data_1</span><span class="p">[</span><span class="n">brain_data_1</span> <span class="o">&lt;=</span> <span class="n">min_thres</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">ind_non_zero</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">mask_data_1</span><span class="p">)</span>
    <span class="p">(</span><span class="n">ystart</span><span class="p">,</span> <span class="n">xstart</span><span class="p">,</span> <span class="n">zstart</span><span class="p">),</span> <span class="p">(</span><span class="n">ystop</span><span class="p">,</span> <span class="n">xstop</span><span class="p">,</span> <span class="n">zstop</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">ind_non_zero</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
        <span class="n">ind_non_zero</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">brain_data_1</span> <span class="o">=</span> <span class="n">brain_data_1</span><span class="p">[</span><span class="n">ystart</span><span class="p">:</span><span class="n">ystop</span><span class="p">,</span> <span class="n">xstart</span><span class="p">:</span><span class="n">xstop</span><span class="p">,</span> <span class="n">zstart</span><span class="p">:</span><span class="n">zstop</span><span class="p">]</span>
    <span class="n">mask_data_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">brain_data_1</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">only_noise</span><span class="p">:</span>
        <span class="n">vmin_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">brain_data_1</span><span class="p">[</span><span class="n">mask_data_1</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">vmax_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">brain_data_1</span><span class="p">[</span><span class="n">mask_data_1</span><span class="p">],</span> <span class="mi">61</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">vmin_1</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">Undefined</span><span class="p">):</span>
        <span class="n">vmin_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">brain_data_1</span><span class="p">[</span><span class="n">mask_data_1</span><span class="p">],</span> <span class="mf">0.5</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">vmax_1</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">Undefined</span><span class="p">):</span>
        <span class="n">vmax_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">brain_data_1</span><span class="p">[</span><span class="n">mask_data_1</span><span class="p">],</span> <span class="mf">99.5</span><span class="p">)</span>

    <span class="n">disp_slices</span> <span class="o">=</span> <span class="n">fig_rows</span> <span class="o">*</span> <span class="n">fig_cols</span>
    <span class="n">lst</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="n">brain_data_1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">step</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">slice_start</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">Undefined</span><span class="p">):</span>
        <span class="c1"># fmt: off</span>
        <span class="n">lst</span> <span class="o">=</span> <span class="n">lst</span><span class="p">[</span><span class="n">slice_start</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">slice_start</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">:]</span>
        <span class="c1"># fmt: on</span>

    <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">ind_slices</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="n">disp_slices</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">lst</span><span class="p">):</span>
        <span class="n">disp_slices</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lst</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">slice_step</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">Undefined</span><span class="p">):</span>
        <span class="n">avg</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lst</span><span class="p">)</span> <span class="o">//</span> <span class="n">disp_slices</span>
        <span class="n">remainder</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lst</span><span class="p">)</span> <span class="o">%</span> <span class="n">disp_slices</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">avg</span> <span class="o">=</span> <span class="n">slice_step</span>
        <span class="n">remainder</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">disp_slices</span><span class="p">):</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">avg</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">remainder</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">start</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lst</span><span class="p">):</span>
            <span class="k">break</span>

        <span class="n">ind_slices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lst</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">end</span><span class="p">])</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">end</span>

    <span class="k">if</span> <span class="nb">all</span><span class="p">(</span>
        <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">element</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">ind_slices</span>
    <span class="p">):</span>
        <span class="n">ind_slices</span> <span class="o">=</span> <span class="p">[</span><span class="n">element</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">ind_slices</span><span class="p">]</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">middle_idx</span> <span class="o">=</span> <span class="p">[(</span><span class="nb">len</span><span class="p">(</span><span class="n">element</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span> <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">ind_slices</span><span class="p">]</span>
        <span class="n">ind_slices</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">element</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="k">for</span> <span class="n">element</span><span class="p">,</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ind_slices</span><span class="p">,</span> <span class="n">middle_idx</span><span class="p">)</span>
        <span class="p">]</span>

    <span class="c1"># Reminder: 19cm == 7.4803inch; 23cm == 9.0551</span>
    <span class="c1"># Width, height in inches</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">7.4803</span><span class="p">,</span> <span class="mf">9.0551</span><span class="p">),</span> <span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>
    <span class="c1"># fig.patch.set_facecolor(&quot;black&quot;)</span>
    <span class="n">zooms</span> <span class="o">=</span> <span class="n">brain_img_1</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">get_zooms</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">brain_data_2</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">brain_data_2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">grid</span> <span class="o">=</span> <span class="n">ImageGrid</span><span class="p">(</span>
            <span class="n">fig</span><span class="p">,</span>
            <span class="mi">111</span><span class="p">,</span>
            <span class="n">nrows_ncols</span><span class="o">=</span><span class="p">(</span><span class="n">fig_rows</span><span class="p">,</span> <span class="n">fig_cols</span><span class="p">),</span>
            <span class="n">axes_pad</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">brain_data_2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">grid</span> <span class="o">=</span> <span class="n">ImageGrid</span><span class="p">(</span>
            <span class="n">fig</span><span class="p">,</span>
            <span class="mi">111</span><span class="p">,</span>
            <span class="n">nrows_ncols</span><span class="o">=</span><span class="p">(</span><span class="n">fig_rows</span><span class="p">,</span> <span class="n">fig_cols</span><span class="p">),</span>
            <span class="n">axes_pad</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">cbar_mode</span><span class="o">=</span><span class="s2">&quot;single&quot;</span><span class="p">,</span>
            <span class="n">cbar_location</span><span class="o">=</span><span class="s2">&quot;bottom&quot;</span><span class="p">,</span>
            <span class="n">cbar_pad</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">cbar_size</span><span class="o">=</span><span class="s2">&quot;2%&quot;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">disp_slices</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
        <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">18</span>

    <span class="k">elif</span> <span class="n">disp_slices</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
        <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">16</span>

    <span class="k">elif</span> <span class="n">disp_slices</span> <span class="o">&lt;</span> <span class="mi">15</span><span class="p">:</span>
        <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">14</span>

    <span class="k">elif</span> <span class="n">disp_slices</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">:</span>
        <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">12</span>

    <span class="k">elif</span> <span class="n">disp_slices</span> <span class="o">&lt;</span> <span class="mi">25</span><span class="p">:</span>
        <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">10</span>

    <span class="k">elif</span> <span class="n">disp_slices</span> <span class="o">&lt;</span> <span class="mi">40</span><span class="p">:</span>
        <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">8</span>

    <span class="k">elif</span> <span class="n">disp_slices</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">:</span>
        <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">6</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">fontsize</span> <span class="o">=</span> <span class="mi">4</span>

    <span class="k">for</span> <span class="n">slice_numb</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">grid</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">slice_numb</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ind_slices</span><span class="p">):</span>
            <span class="n">displ_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
            <span class="n">ind_slice</span> <span class="o">=</span> <span class="mi">1</span>

            <span class="k">if</span> <span class="n">brain_data_2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">displ_2</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">))]</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">displ_2</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">displ_1</span> <span class="o">=</span> <span class="n">brain_data_1</span>
            <span class="n">ind_slice</span> <span class="o">=</span> <span class="n">ind_slices</span><span class="p">[</span><span class="n">slice_numb</span><span class="p">]</span>
            <span class="n">displ_2</span> <span class="o">=</span> <span class="n">brain_data_2</span>

        <span class="k">if</span> <span class="n">plane</span> <span class="o">==</span> <span class="s2">&quot;ax&quot;</span><span class="p">:</span>
            <span class="n">phys_sp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">zooms</span><span class="p">[:</span><span class="mi">2</span><span class="p">])</span> <span class="o">*</span> <span class="n">brain_data_1</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">ind_slice</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">displ_1</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">ind_slice</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                <span class="n">vmin</span><span class="o">=</span><span class="n">vmin_1</span><span class="p">,</span>
                <span class="n">vmax</span><span class="o">=</span><span class="n">vmax_1</span><span class="p">,</span>
                <span class="n">cmap</span><span class="o">=</span><span class="n">cmap_1</span><span class="p">,</span>
                <span class="n">interpolation</span><span class="o">=</span><span class="s2">&quot;nearest&quot;</span><span class="p">,</span>
                <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;lower&quot;</span><span class="p">,</span>
                <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">phys_sp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">phys_sp</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">plane</span> <span class="o">==</span> <span class="s2">&quot;sag&quot;</span><span class="p">:</span>
            <span class="n">phys_sp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">zooms</span><span class="p">[:</span><span class="mi">2</span><span class="p">])</span> <span class="o">*</span> <span class="n">brain_data_1</span><span class="p">[</span><span class="n">ind_slice</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">displ_1</span><span class="p">[</span><span class="n">ind_slice</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                <span class="n">vmin</span><span class="o">=</span><span class="n">vmin_1</span><span class="p">,</span>
                <span class="n">vmax</span><span class="o">=</span><span class="n">vmax_1</span><span class="p">,</span>
                <span class="n">cmap</span><span class="o">=</span><span class="n">cmap_1</span><span class="p">,</span>
                <span class="n">interpolation</span><span class="o">=</span><span class="s2">&quot;nearest&quot;</span><span class="p">,</span>
                <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;lower&quot;</span><span class="p">,</span>
                <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">phys_sp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">phys_sp</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">plane</span> <span class="o">==</span> <span class="s2">&quot;cor&quot;</span><span class="p">:</span>
            <span class="n">phys_sp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">zooms</span><span class="p">[:</span><span class="mi">2</span><span class="p">])</span> <span class="o">*</span> <span class="n">brain_data_1</span><span class="p">[:,</span> <span class="n">ind_slice</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">displ_1</span><span class="p">[:,</span> <span class="n">ind_slice</span><span class="p">,</span> <span class="p">:],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                <span class="n">vmin</span><span class="o">=</span><span class="n">vmin_1</span><span class="p">,</span>
                <span class="n">vmax</span><span class="o">=</span><span class="n">vmax_1</span><span class="p">,</span>
                <span class="n">cmap</span><span class="o">=</span><span class="n">cmap_1</span><span class="p">,</span>
                <span class="n">interpolation</span><span class="o">=</span><span class="s2">&quot;nearest&quot;</span><span class="p">,</span>
                <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;lower&quot;</span><span class="p">,</span>
                <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">phys_sp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">phys_sp</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">displ_2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">displ</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">displ_2</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">plane</span> <span class="o">==</span> <span class="s2">&quot;ax&quot;</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">displ</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">ind_slice</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">im2</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
                        <span class="n">data</span><span class="p">,</span>
                        <span class="n">vmin</span><span class="o">=</span><span class="n">vmin_2</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                        <span class="n">vmax</span><span class="o">=</span><span class="n">vmax_2</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                        <span class="n">cmap</span><span class="o">=</span><span class="n">cmap_2</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                        <span class="n">alpha</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">data</span> <span class="o">&lt;=</span> <span class="n">vmin_2</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span>
                        <span class="c1"># alpha=np.where(data &lt;= vmin_2[i], 0, 1.0),</span>
                        <span class="n">interpolation</span><span class="o">=</span><span class="s2">&quot;nearest&quot;</span><span class="p">,</span>
                        <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;lower&quot;</span><span class="p">,</span>
                        <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">phys_sp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">phys_sp</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span>
                    <span class="p">)</span>
                <span class="k">elif</span> <span class="n">plane</span> <span class="o">==</span> <span class="s2">&quot;sag&quot;</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">displ</span><span class="p">[</span><span class="n">ind_slice</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">im2</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
                        <span class="n">data</span><span class="p">,</span>
                        <span class="n">vmin</span><span class="o">=</span><span class="n">vmin_2</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                        <span class="n">vmax</span><span class="o">=</span><span class="n">vmax_2</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                        <span class="n">cmap</span><span class="o">=</span><span class="n">cmap_2</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                        <span class="n">alpha</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">data</span> <span class="o">&lt;=</span> <span class="n">vmin_2</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span>
                        <span class="c1"># alpha=np.where(data &lt;= vmin_2[i], 0, 1.0),</span>
                        <span class="n">interpolation</span><span class="o">=</span><span class="s2">&quot;nearest&quot;</span><span class="p">,</span>
                        <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;lower&quot;</span><span class="p">,</span>
                        <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">phys_sp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">phys_sp</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span>
                    <span class="p">)</span>
                <span class="k">elif</span> <span class="n">plane</span> <span class="o">==</span> <span class="s2">&quot;cor&quot;</span><span class="p">:</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="n">displ</span><span class="p">[:,</span> <span class="n">ind_slice</span><span class="p">,</span> <span class="p">:],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">im2</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span>
                        <span class="n">data</span><span class="p">,</span>
                        <span class="n">vmin</span><span class="o">=</span><span class="n">vmin_2</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                        <span class="n">vmax</span><span class="o">=</span><span class="n">vmax_2</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                        <span class="n">cmap</span><span class="o">=</span><span class="n">cmap_2</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                        <span class="n">alpha</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">data</span> <span class="o">&lt;=</span> <span class="n">vmin_2</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span>
                        <span class="c1"># alpha=np.where(data &lt;= vmin_2[i], 0, 1.0),</span>
                        <span class="n">interpolation</span><span class="o">=</span><span class="s2">&quot;nearest&quot;</span><span class="p">,</span>
                        <span class="n">origin</span><span class="o">=</span><span class="s2">&quot;lower&quot;</span><span class="p">,</span>
                        <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">phys_sp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">phys_sp</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span>
                    <span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
        <span class="c1"># ax.set_facecolor(&#39;black&#39;)</span>
        <span class="n">bgcolor</span> <span class="o">=</span> <span class="n">cmap_1</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">vmin_1</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">))</span>
        <span class="n">fgcolor</span> <span class="o">=</span> <span class="n">cmap_1</span><span class="p">(</span><span class="n">vmax_1</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">slice_numb</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">ind_slices</span><span class="p">):</span>
            <span class="n">ind_slice</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
            <span class="mf">0.98</span><span class="p">,</span>
            <span class="mf">0.01</span><span class="p">,</span>
            <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ind_slice</span><span class="p">),</span>
            <span class="n">color</span><span class="o">=</span><span class="n">fgcolor</span><span class="p">,</span>
            <span class="n">transform</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span>
            <span class="n">horizontalalignment</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">,</span>
            <span class="n">verticalalignment</span><span class="o">=</span><span class="s2">&quot;bottom&quot;</span><span class="p">,</span>
            <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">,</span>
            <span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
                <span class="n">boxstyle</span><span class="o">=</span><span class="s2">&quot;square,pad=0&quot;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="n">bgcolor</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="n">bgcolor</span>
            <span class="p">),</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">brain_data_2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">brain_data_2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">cbar</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">cbar_axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im2</span><span class="p">)</span>
        <span class="n">cbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">)</span>
        <span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s2">&quot;Intensity&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">data_2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fname</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">data_1</span><span class="p">))</span>

    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">brain_data_2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">fname</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">fname</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">data_2</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

    <span class="k">if</span> <span class="n">out_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fname</span> <span class="o">+=</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">out_name</span>

    <span class="k">if</span> <span class="n">out_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">out_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">data_1</span><span class="p">)</span>

    <span class="n">out_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_dir</span><span class="p">,</span> <span class="n">fname</span> <span class="o">+</span> <span class="s2">&quot;_slice_planes_plot.png&quot;</span><span class="p">)</span>
    <span class="n">counter</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">while</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">out_file</span><span class="p">):</span>
        <span class="n">b_name</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">out_file</span><span class="p">)</span>
        <span class="n">out_file</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">b_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">counter</span><span class="si">:</span><span class="s2">03d</span><span class="si">}{</span><span class="n">ext</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">out_file</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;png&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out_file</span></div>


<div class="viewcode-block" id="check_orientations"><a class="viewcode-back" href="../../../mia_processes.utils.html#mia_processes.utils.tools.check_orientations">[docs]</a><span class="k">def</span> <span class="nf">check_orientations</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check the dimensions and orientations of the images.</span>

<span class="sd">    images: images from nibabel</span>
<span class="sd">    verbose: whether to create a verbose returned message.</span>

<span class="sd">    returns:    status: status (True means OK)</span>
<span class="sd">                message: string describing status (empty if OK)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">status</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">images</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">status</span><span class="p">,</span> <span class="n">message</span>

    <span class="n">dimensions</span> <span class="o">=</span> <span class="p">[</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span> <span class="k">for</span> <span class="n">img</span> <span class="ow">in</span> <span class="n">images</span><span class="p">]</span>
    <span class="n">orientations</span> <span class="o">=</span> <span class="p">[</span><span class="n">img</span><span class="o">.</span><span class="n">affine</span> <span class="k">for</span> <span class="n">img</span> <span class="ow">in</span> <span class="n">images</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">dimensions</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">status</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">message</span> <span class="o">+=</span> <span class="s2">&quot;The images do not all have the same dimensions.</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">+=</span> <span class="p">(</span>
                <span class="s2">&quot;The function assumes that a voxel in one image &quot;</span>
                <span class="s2">&quot;corresponds to the same voxel in another.</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="n">message</span> <span class="o">+=</span> <span class="p">(</span>
                <span class="s2">&quot;This is not a safe assumption if the dimensions &quot;</span>
                <span class="s2">&quot;of the images differ.</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="n">message</span> <span class="o">+=</span> <span class="p">(</span>
                <span class="s2">&quot;Please ensure that you have processed all the &quot;</span>
                <span class="s2">&quot;image data in the same way (eg. check spatial &quot;</span>
                <span class="s2">&quot;normalisation bounding-boxes, voxel-sizes etc).</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="n">message</span> <span class="o">+=</span> <span class="s2">&quot;Here are the dimensions of the image volumes:</span><span class="se">\n</span><span class="s2">&quot;</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">dim</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dimensions</span><span class="p">):</span>
                <span class="n">message</span> <span class="o">+=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s1">&#39;[</span><span class="si">{</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span><span class="w"> </span><span class="n">dim</span><span class="p">))</span><span class="si">}</span><span class="s1">]:&#39;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">images</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">get_filename</span><span class="p">()</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="p">)</span>
            <span class="n">message</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">orientations</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">status</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">message</span> <span class="o">+=</span> <span class="p">(</span>
            <span class="s2">&quot;The images do not all have the same orientation &quot;</span>
            <span class="s2">&quot;and/or voxel size.</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">+=</span> <span class="p">(</span>
                <span class="s2">&quot;The function assumes that a voxel in one image &quot;</span>
                <span class="s2">&quot;corresponds exactly with the same voxel &quot;</span>
                <span class="s2">&quot;in another.</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="n">message</span> <span class="o">+=</span> <span class="p">(</span>
                <span class="s2">&quot;This is not a safe assumption if the orientation &quot;</span>
                <span class="s2">&quot;information in the headers files indicates that</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="n">message</span> <span class="o">+=</span> <span class="p">(</span>
                <span class="s2">&quot;the images are oriented differently. Please ensure &quot;</span>
                <span class="s2">&quot;that you process all data correctly.</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="n">message</span> <span class="o">+=</span> <span class="p">(</span>
                <span class="s2">&quot;For example, you may have realigned the images, &quot;</span>
                <span class="s2">&quot;but not actually resliced them to be in voxel-wise &quot;</span>
                <span class="s2">&quot;alignment.</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="n">message</span> <span class="o">+=</span> <span class="p">(</span>
                <span class="s2">&quot;Here are the orientation matrices of the &quot;</span> <span class="s2">&quot;image volumes:</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">orient</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">orientations</span><span class="p">):</span>
                <span class="n">message</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">orient</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>

    <span class="k">return</span> <span class="n">status</span><span class="p">,</span> <span class="n">message</span></div>
</pre></div>

      </div>
      <div class="bottomnav" role="navigation" aria-label="bottom navigation">
      
        <p>
        <a class="uplink" href="../../../index.html">Contents</a>
        </p>

      </div>

    <div class="footer" role="contentinfo">
    &#169; Copyright 2019, populse.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.1.2.
    </div>
  </body>
</html>