
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>mia_processes.bricks.stat.spm.model &#8212; mia_processes 2.2.1-dev+416c37b documentation</title>
    <link rel="stylesheet" href="../../../../../_static/haiku.css" type="text/css" />
    <link rel="stylesheet" href="../../../../../_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="../../../../../" src="../../../../../_static/documentation_options.js"></script>
    <script src="../../../../../_static/jquery.js"></script>
    <script src="../../../../../_static/underscore.js"></script>
    <script src="../../../../../_static/doctools.js"></script>
    <script src="../../../../../_static/language_data.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../search.html" /> 
  </head><body>
      <div class="header" role="banner"><h1 class="heading"><a href="../../../../../index.html">
          <span>mia_processes 2.2.1-dev+416c37b documentation</span></a></h1>
        <h2 class="heading"><span>mia_processes.bricks.stat.spm.model</span></h2>
      </div>
      <div class="topnav" role="navigation" aria-label="top navigation">
      
        <p>
        <a class="uplink" href="../../../../../index.html">Contents</a>
        </p>

      </div>
      <div class="content" role="main">
        
        
  <h1>Source code for mia_processes.bricks.stat.spm.model</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>

<span class="sd">&quot;&quot;&quot;The library for the SPM fMRI statistical analysis of the mia_processes</span>
<span class="sd">package.</span>

<span class="sd">The purpose of this module is to customise the main spm statistical analysis</span>
<span class="sd">bricks provided by nipype and to correct some things that do not work directly</span>
<span class="sd">in populse_mia.</span>

<span class="sd">:Contains:</span>
<span class="sd">    :Class:</span>
<span class="sd">        - EstimateContrast</span>
<span class="sd">        - EstimateModel</span>
<span class="sd">        - Level1Design</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="c1">##########################################################################</span>
<span class="c1"># mia_processes - Copyright (C) IRMaGe/CEA, 2018</span>
<span class="c1"># Distributed under the terms of the CeCILL license, as published by</span>
<span class="c1"># the CEA-CNRS-INRIA. Refer to the LICENSE file or to</span>
<span class="c1"># http://www.cecill.info/licences/Licence_CeCILL_V2.1-en.html</span>
<span class="c1"># for details.</span>
<span class="c1">##########################################################################</span>

<span class="c1"># Other import</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">scipy.io</span>

<span class="c1"># nipype import</span>
<span class="kn">from</span> <span class="nn">nipype.interfaces.base</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">File</span><span class="p">,</span>
    <span class="n">InputMultiPath</span><span class="p">,</span>
    <span class="n">OutputMultiPath</span><span class="p">,</span>
    <span class="n">traits</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">nipype.interfaces.spm.base</span> <span class="kn">import</span> <span class="n">ImageFileSPM</span>
<span class="kn">from</span> <span class="nn">populse_db.database</span> <span class="kn">import</span> <span class="n">FIELD_TYPE_INTEGER</span><span class="p">,</span> <span class="n">FIELD_TYPE_STRING</span>
<span class="kn">from</span> <span class="nn">populse_mia.data_manager.database_mia</span> <span class="kn">import</span> <span class="n">TAG_ORIGIN_USER</span>

<span class="c1"># populse_db and populse_mia import</span>
<span class="kn">from</span> <span class="nn">populse_mia.data_manager.project</span> <span class="kn">import</span> <span class="n">COLLECTION_CURRENT</span>

<span class="c1"># populse_mia imports</span>
<span class="kn">from</span> <span class="nn">populse_mia.user_interface.pipeline_manager.process_mia</span> <span class="kn">import</span> <span class="n">ProcessMIA</span>

<span class="c1"># soma-base imports</span>
<span class="kn">from</span> <span class="nn">soma.qt_gui.qt_backend.Qt</span> <span class="kn">import</span> <span class="n">QMessageBox</span>
<span class="kn">from</span> <span class="nn">traits.api</span> <span class="kn">import</span> <span class="n">Undefined</span>

<span class="c1"># mia_processes import</span>
<span class="kn">from</span> <span class="nn">mia_processes.utils</span> <span class="kn">import</span> <span class="n">get_dbFieldValue</span><span class="p">,</span> <span class="n">set_dbFieldValue</span>

<span class="c1"># from .stats_pop_ups import _SessionQuery # currently in ec_dev package</span>


<div class="viewcode-block" id="EstimateContrast"><a class="viewcode-back" href="../../../../../mia_processes.bricks.stat.spm.html#mia_processes.bricks.stat.spm.model.EstimateContrast">[docs]</a><span class="k">class</span> <span class="nc">EstimateContrast</span><span class="p">(</span><span class="n">ProcessMIA</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    * Estimate contrasts of interest.</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="EstimateContrast.__init__"><a class="viewcode-back" href="../../../../../mia_processes.bricks.stat.spm.html#mia_processes.bricks.stat.spm.model.EstimateContrast.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the attributes initialisation / instantiation.</span>

<span class="sd">        The input and output plugs are defined here. The special</span>
<span class="sd">        &#39;self.requirement&#39; attribute (optional) is used to define the</span>
<span class="sd">        third-party products necessary for the running of the brick.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Initialisation of the objects needed for the launch of the brick</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">EstimateContrast</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1"># Third party softwares required for the execution of the brick</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requirement</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;spm&quot;</span><span class="p">,</span> <span class="s2">&quot;nipype&quot;</span><span class="p">]</span>

        <span class="c1"># Inputs description</span>
        <span class="n">spm_mat_file_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;SPM.mat file (a pathlike object or string &quot;</span> <span class="s2">&quot;representing a file)&quot;</span>
        <span class="p">)</span>
        <span class="n">session_type_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Selects the contrast type. One of tcon &quot;</span>
            <span class="s2">&quot;(T-contrast), fcon (F-contrast) or tconsess &quot;</span>
            <span class="s2">&quot;(T-contrast cond/sess based)&quot;</span>
        <span class="p">)</span>
        <span class="n">contrast_name_desc</span> <span class="o">=</span> <span class="s2">&quot;Name of contrasts (a list of string)&quot;</span>
        <span class="n">condition_name_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Conditions information (a list of list of string)&quot;</span>
        <span class="p">)</span>
        <span class="n">contrast_weight_desc</span> <span class="o">=</span> <span class="s2">&quot;Contrast weights (list of list of float)&quot;</span>
        <span class="n">session_desc</span> <span class="o">=</span> <span class="s2">&quot;Session list (a list of list of float)&quot;</span>
        <span class="n">multi_reg_desc</span> <span class="o">=</span> <span class="s2">&quot;The regressor files(a list of file)&quot;</span>

        <span class="c1"># Inputs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;spm_mat_file&quot;</span><span class="p">,</span>
            <span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">copyfile</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">spm_mat_file_desc</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;session_type&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">Enum</span><span class="p">(</span>
                <span class="s2">&quot;tcon&quot;</span><span class="p">,</span>
                <span class="s2">&quot;fcon&quot;</span><span class="p">,</span>
                <span class="s2">&quot;tconsess&quot;</span><span class="p">,</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">session_type_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># self.add_trait(&quot;contrast_session_name&quot;,</span>
        <span class="c1">#                traits.String(output=False,</span>
        <span class="c1">#                              optional=False))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;contrast_name&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">(</span>
                <span class="n">traits</span><span class="o">.</span><span class="n">String</span><span class="p">(),</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">contrast_name_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">contrast_name</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;+&quot;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;condition_name&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">(</span>
                <span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">traits</span><span class="o">.</span><span class="n">String</span><span class="p">()),</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">condition_name_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">condition_name</span> <span class="o">=</span> <span class="p">[[</span><span class="s2">&quot;R1_1&quot;</span><span class="p">]]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;contrast_weight&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">(</span>
                <span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">traits</span><span class="o">.</span><span class="n">Float</span><span class="p">()),</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">contrast_weight_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">contrast_weight</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">1.0</span><span class="p">]]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;session&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">Either</span><span class="p">(</span>
                <span class="n">Undefined</span><span class="p">,</span>
                <span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">(</span>
                    <span class="n">traits</span><span class="o">.</span><span class="n">Either</span><span class="p">(</span><span class="n">Undefined</span><span class="p">,</span> <span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">traits</span><span class="o">.</span><span class="n">Float</span><span class="p">()))</span>
                <span class="p">),</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">session_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">Undefined</span>

        <span class="c1"># self.add_trait(&quot;replicate&quot;,</span>
        <span class="c1">#                traits.Enum(&quot;none&quot;,</span>
        <span class="c1">#                            &quot;repl&quot;,</span>
        <span class="c1">#                            &quot;replsc&quot;,</span>
        <span class="c1">#                            &quot;sess&quot;,</span>
        <span class="c1">#                            &quot;both&quot;,</span>
        <span class="c1">#                            &quot;bothsc&quot;,</span>
        <span class="c1">#                            output=False,</span>
        <span class="c1">#                            optional=True))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;multi_reg&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">Either</span><span class="p">(</span>
                <span class="n">Undefined</span><span class="p">,</span>
                <span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">File</span><span class="p">()),</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">multi_reg_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># self.add_trait(&quot;multi_reg&quot;, traits.List(output=False, optional=True))</span>
        <span class="c1"># self.add_trait(&quot;contrasts&quot;,</span>
        <span class="c1">#                traits.List([(&#39;+&#39;, &#39;T&#39;, [&#39;R1_1&#39;], [1])],</span>
        <span class="c1">#                output=False,</span>
        <span class="c1">#                optional=True))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;beta_images&quot;</span><span class="p">,</span> <span class="n">InputMultiPath</span><span class="p">(</span><span class="n">File</span><span class="p">(),</span> <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">copyfile</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;residual_image&quot;</span><span class="p">,</span> <span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">copyfile</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;use_derivs&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">Bool</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">xor</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;group_contrast&quot;</span><span class="p">]),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;group_contrast&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">Bool</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">xor</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;use_derivs&quot;</span><span class="p">]),</span>
        <span class="p">)</span>

        <span class="c1"># Outputs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;con_images&quot;</span><span class="p">,</span> <span class="n">OutputMultiPath</span><span class="p">(</span><span class="n">File</span><span class="p">(),</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;spmT_images&quot;</span><span class="p">,</span> <span class="n">OutputMultiPath</span><span class="p">(</span><span class="n">File</span><span class="p">(),</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;spmF_images&quot;</span><span class="p">,</span> <span class="n">OutputMultiPath</span><span class="p">(</span><span class="n">File</span><span class="p">(),</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;out_spm_mat_file&quot;</span><span class="p">,</span> <span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">copyfile</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">init_default_traits</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_process</span><span class="p">(</span><span class="s2">&quot;nipype.interfaces.spm.EstimateContrast&quot;</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_get_contrasts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">session_type</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;blabla&quot;&quot;&quot;</span>
        <span class="c1"># contrast = tuple()</span>
        <span class="n">contrasts</span> <span class="o">=</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">()]</span>

        <span class="c1"># if session_type == &#39;tcon&#39;:</span>
        <span class="c1">#     contrast[0] = self.contrast_session_name</span>
        <span class="c1">#     contrast[1] = &#39;T&#39;</span>
        <span class="c1">#     contrast[2] = self.contrast_weight</span>
        <span class="c1">#     contrast[3] = self.replicate</span>
        <span class="c1">#</span>
        <span class="c1"># elif session_type == &#39;fcon&#39;:</span>
        <span class="c1">#     contrast[0] = self.contrast_session_name</span>
        <span class="c1">#     contrast[1] = &#39;F&#39;</span>
        <span class="c1">#     contrast[2] = self.contrast_weight</span>
        <span class="c1">#     contrast[3] = self.replicate</span>
        <span class="c1">#</span>
        <span class="c1"># elif session_type == &#39;tconsess&#39;:</span>
        <span class="c1">#     pass</span>
        <span class="k">if</span> <span class="n">session_type</span> <span class="o">==</span> <span class="s2">&quot;tcon&quot;</span><span class="p">:</span>
            <span class="n">stat</span> <span class="o">=</span> <span class="s2">&quot;T&quot;</span>

        <span class="k">elif</span> <span class="n">session_type</span> <span class="o">==</span> <span class="s2">&quot;fcon&quot;</span><span class="p">:</span>
            <span class="n">stat</span> <span class="o">=</span> <span class="s2">&quot;F&quot;</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">stat</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">stat</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="ow">is</span> <span class="n">Undefined</span><span class="p">:</span>
                <span class="n">contrasts</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">(</span><span class="n">cont_name</span><span class="p">,</span> <span class="n">stat</span><span class="p">,</span> <span class="n">condition</span><span class="p">,</span> <span class="n">cont_weight</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">cont_name</span><span class="p">,</span> <span class="n">condition</span><span class="p">,</span> <span class="n">cont_weight</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">contrast_name</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">condition_name</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">contrast_weight</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">contrasts</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">(</span><span class="n">cont_name</span><span class="p">,</span> <span class="n">stat</span><span class="p">,</span> <span class="n">condition</span><span class="p">,</span> <span class="n">cont_weight</span><span class="p">,</span> <span class="n">sess</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">sess</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">Undefined</span>
                    <span class="k">else</span> <span class="p">(</span><span class="n">cont_name</span><span class="p">,</span> <span class="n">stat</span><span class="p">,</span> <span class="n">condition</span><span class="p">,</span> <span class="n">cont_weight</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">cont_name</span><span class="p">,</span> <span class="n">condition</span><span class="p">,</span> <span class="n">cont_weight</span><span class="p">,</span> <span class="n">sess</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">contrast_name</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">condition_name</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">contrast_weight</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">]</span>

        <span class="k">return</span> <span class="n">contrasts</span>

<div class="viewcode-block" id="EstimateContrast.list_outputs"><a class="viewcode-back" href="../../../../../mia_processes.bricks.stat.spm.html#mia_processes.bricks.stat.spm.model.EstimateContrast.list_outputs">[docs]</a>    <span class="k">def</span> <span class="nf">list_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_plugged</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;blabla&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">EstimateContrast</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">list_outputs</span><span class="p">()</span>

        <span class="c1"># Old version calling Nipype&#39;s method</span>
        <span class="sd">&quot;&quot;&quot;process = spm.EstimateContrast()</span>
<span class="sd">        if not self.spm_mat_file:</span>
<span class="sd">            return {}, {}</span>
<span class="sd">        else:</span>
<span class="sd">            process.inputs.spm_mat_file = self.spm_mat_file</span>

<span class="sd">        if not self.contrasts:</span>
<span class="sd">            return {}, {}</span>
<span class="sd">        else:</span>
<span class="sd">            process.inputs.contrasts = self.contrasts</span>

<span class="sd">        if not self.beta_images:</span>
<span class="sd">            return {}, {}</span>
<span class="sd">        else:</span>
<span class="sd">            process.inputs.beta_images = self.beta_images</span>

<span class="sd">        if not self.residual_image:</span>
<span class="sd">            return {}, {}</span>
<span class="sd">        else:</span>
<span class="sd">            process.inputs.residual_image = self.residual_image</span>

<span class="sd">        outputs = process._list_outputs()</span>
<span class="sd">        outputs[&quot;out_spm_mat_file&quot;] = outputs.pop(&quot;spm_mat_file&quot;)</span>
<span class="sd">        return outputs, {}&quot;&quot;&quot;</span>

        <span class="c1"># Own list_outputs to avoid to read in the SPM.mat file</span>
        <span class="c1"># if not self.spm_mat_file:</span>
        <span class="c1">#     return {}, {}</span>
        <span class="c1">#</span>
        <span class="c1"># if not self.contrasts:</span>
        <span class="c1">#     return {}, {}</span>
        <span class="c1">#</span>
        <span class="c1"># if not self.beta_images:</span>
        <span class="c1">#     return {}, {}</span>
        <span class="c1">#</span>
        <span class="c1"># if not self.residual_image:</span>
        <span class="c1">#     return {}, {}</span>

        <span class="c1"># if self.outputs:</span>
        <span class="c1">#    self.outputs = {}</span>

        <span class="c1"># if self.inheritance_dict:</span>
        <span class="c1">#    self.inheritance_dict = {}</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spm_mat_file</span><span class="p">)</span>
            <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spm_mat_file</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;&lt;undefined&gt;&quot;</span><span class="p">,</span> <span class="n">Undefined</span><span class="p">])</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">multi_reg</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">Undefined</span><span class="p">,</span> <span class="s2">&quot;&lt;undefined&gt;&quot;</span><span class="p">,</span> <span class="p">[]]</span>
        <span class="p">):</span>
            <span class="c1"># The management of self.process.output_directory could be</span>
            <span class="c1"># delegated to the</span>
            <span class="c1"># populse_mia.user_interface.pipeline_manager.process_mia</span>
            <span class="c1"># module. We can&#39;t do it at the moment because the</span>
            <span class="c1"># sync_process_output_traits() of the</span>
            <span class="c1"># capsul/process/nipype_process module raises an exception</span>
            <span class="c1"># in nipype if the mandatory parameter are not yet defined!</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">output_directory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No output_directory was found...!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">_</span><span class="p">,</span> <span class="n">spm_mat_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spm_mat_file</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;out_spm_mat_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span> <span class="n">spm_mat_file</span>
            <span class="p">)</span>

            <span class="c1"># Counting the number of spmT and con files to create</span>
            <span class="c1"># if self.multi_reg not in [Undefined, &#39;&lt;undefined&gt;&#39;, []]:</span>
            <span class="n">nb_spmT</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">for</span> <span class="n">reg_file</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">multi_reg</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">reg_file</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;.txt&quot;</span><span class="p">:</span>
                    <span class="n">nb_spmT</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="n">spmT_files</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">con_files</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nb_spmT</span><span class="p">):</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">spmT_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span> <span class="s2">&quot;spmT_</span><span class="si">{:04d}</span><span class="s2">.nii&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="n">con_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span> <span class="s2">&quot;con_</span><span class="si">{:04d}</span><span class="s2">.nii&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="c1"># spmT_files.append(os.path.join(path,</span>
                <span class="c1">#                                &#39;spmT_{:04d}.nii&#39;.format(i)))</span>
                <span class="c1"># con_files.append(os.path.join(path,</span>
                <span class="c1">#                               &#39;con_{:04d}.nii&#39;.format(i)))</span>

            <span class="k">if</span> <span class="n">spmT_files</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;spmT_images&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spmT_files</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;con_images&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">con_files</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inheritance_dict</span><span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;out_spm_mat_file&quot;</span><span class="p">]</span>
            <span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spm_mat_file</span>

            <span class="k">if</span> <span class="n">spmT_files</span><span class="p">:</span>
                <span class="c1"># FIXME: Quick and dirty. This brick was written quickly and</span>
                <span class="c1">#        will need to be reworked to cover all cases. At that</span>
                <span class="c1">#        time, inheritance will also need to be reviewed.</span>
                <span class="c1">#        Currently we take the first element of the lists, but</span>
                <span class="c1">#        in the general case there can be several elements in</span>
                <span class="c1">#        the lists</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">inheritance_dict</span><span class="p">[</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;spmT_images&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spm_mat_file</span>
                <span class="c1"># FIXME: In the latest version of mia, indexing of the</span>
                <span class="c1">#        database with particular tags defined in the</span>
                <span class="c1">#        processes is done only at the end of the</span>
                <span class="c1">#        initialisation of the whole pipeline. So we</span>
                <span class="c1">#        cannot use the value of these tags in other</span>
                <span class="c1">#        processes of the pipeline at the time of</span>
                <span class="c1">#        initialisation (see populse_mia #290). Unti</span>
                <span class="c1">#        better we use a quick and dirty hack with the</span>
                <span class="c1">#        set_dbFieldValue() function !</span>

                <span class="n">tag_to_add</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;PatientName&quot;</span>
                <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;field_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;string&quot;</span>
                <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;visibility&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;origin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;user&quot;</span>
                <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;unit&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;default_value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_dbFieldValue</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">spm_mat_file</span><span class="p">,</span> <span class="s2">&quot;PatientName&quot;</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">set_dbFieldValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="n">spmT_files</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">tag_to_add</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">EstimateContrast brick:</span><span class="se">\n</span><span class="s2">The &#39;PatientName&#39; &quot;</span>
                        <span class="s2">&quot;tag could not be added to the database for &quot;</span>
                        <span class="s2">&quot;the &#39;</span><span class="si">{}</span><span class="s2">&#39; parameter. This can lead to a &quot;</span>
                        <span class="s2">&quot;subsequent issue during &quot;</span>
                        <span class="s2">&quot;initialization!!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spmT_files</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="p">)</span>

                <span class="n">age</span> <span class="o">=</span> <span class="n">get_dbFieldValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">spm_mat_file</span><span class="p">,</span> <span class="s2">&quot;Age&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">age</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">tag_to_add</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                    <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Age&quot;</span>
                    <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;field_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;int&quot;</span>
                    <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                    <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;visibility&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;origin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;user&quot;</span>
                    <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;unit&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;default_value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">age</span>
                    <span class="n">set_dbFieldValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="n">spmT_files</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">tag_to_add</span><span class="p">)</span>

                <span class="n">pathology</span> <span class="o">=</span> <span class="n">get_dbFieldValue</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">spm_mat_file</span><span class="p">,</span> <span class="s2">&quot;Pathology&quot;</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="n">pathology</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">tag_to_add</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                    <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Pathology&quot;</span>
                    <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;field_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;string&quot;</span>
                    <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                    <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;visibility&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;origin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;user&quot;</span>
                    <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;unit&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;default_value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pathology</span>
                    <span class="n">set_dbFieldValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="n">spmT_files</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">tag_to_add</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">inheritance_dict</span><span class="p">[</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;con_images&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spm_mat_file</span>

        <span class="c1"># What about spmF images ?</span>
        <span class="c1"># return outputs</span>

        <span class="c1"># Return the requirement, outputs and inheritance_dict</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_initResult</span><span class="p">()</span></div>

<div class="viewcode-block" id="EstimateContrast.run_process_mia"><a class="viewcode-back" href="../../../../../mia_processes.bricks.stat.spm.html#mia_processes.bricks.stat.spm.model.EstimateContrast.run_process_mia">[docs]</a>    <span class="k">def</span> <span class="nf">run_process_mia</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;blabla&quot;&quot;&quot;</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">EstimateContrast</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">run_process_mia</span><span class="p">()</span>

        <span class="c1"># self.process.spm_mat_file = os.path.abspath(self.spm_mat_file)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">spm_mat_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spm_mat_file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">contrasts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_contrasts</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session_type</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">beta_images</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta_images</span>
        <span class="c1"># self.process.residual_image = os.path.abspath(self.residual_image)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">residual_image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">residual_image</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_derivs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">use_derivs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_derivs</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_contrast</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">group_contrast</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">group_contrast</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">use_derivs</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># self.process.run()</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">configuration_dict</span><span class="o">=</span><span class="p">{})</span></div></div>


<div class="viewcode-block" id="EstimateModel"><a class="viewcode-back" href="../../../../../mia_processes.bricks.stat.spm.html#mia_processes.bricks.stat.spm.model.EstimateModel">[docs]</a><span class="k">class</span> <span class="nc">EstimateModel</span><span class="p">(</span><span class="n">ProcessMIA</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">     - EstimateModel (User_processes.stats.spm.stats.EstimateModel) &lt;=&gt;</span>
<span class="sd">       Model estimation (SPM12 name).</span>
<span class="sd">    *** Estimation of model parameters using classical (ReML - Restricted</span>
<span class="sd">        Maximum Likelihood) or Bayesian algorithms.***</span>
<span class="sd">        * Input parameters:</span>
<span class="sd">            # spm_mat_file &lt;=&gt; spmmat:</span>
<span class="sd">              The SPM.mat file that contains the design specification</span>
<span class="sd">              (a file object).</span>
<span class="sd">                  &lt;ex. /home/ArthurBlair/data/raw_data/SPM.mat&gt;</span>
<span class="sd">            # estimation_method &lt;=&gt; method:</span>
<span class="sd">              Estimation  procedures for fMRI models (A dictionary with keys</span>
<span class="sd">              which are ‘Classical’ or ‘Bayesian’ or ‘Bayesian2’ and with</span>
<span class="sd">              values which are 1).</span>
<span class="sd">                 - Classical: Restricted Maximum Likelihood (ReML) estimation</span>
<span class="sd">                              of first or second level models</span>
<span class="sd">                 - Bayesian: Bayesian estimation of first level models</span>
<span class="sd">                             (not yet fully implemented)</span>
<span class="sd">                 - Bayesian2: Bayesian estimation of second level models</span>
<span class="sd">                              (not yet fully implemented)</span>
<span class="sd">                  &lt;ex. {&#39;Classical&#39;: 1}&gt;</span>
<span class="sd">            # write_residuals &lt;=&gt; write_residuals:</span>
<span class="sd">              Write images of residuals to disk. This is only implemented for</span>
<span class="sd">              classical inference (a boolean)</span>
<span class="sd">                  &lt;ex. True&gt;</span>
<span class="sd">            # flags:</span>
<span class="sd">              Additional arguments (a dictionary with keys which are any value</span>
<span class="sd">              and with values which are any value)</span>
<span class="sd">                  &lt;ex. {}&gt;</span>
<span class="sd">            # version:</span>
<span class="sd">              Version of spm (a string)</span>
<span class="sd">                  &lt;ex. spm12&gt;</span>
<span class="sd">            # tot_reg_num:</span>
<span class="sd">              The total number of estimated regression coefficients</span>
<span class="sd">              (an integer).</span>
<span class="sd">                  &lt;ex. 8&gt;</span>
<span class="sd">        * Output parameters:</span>
<span class="sd">            # out_spm_mat_file:</span>
<span class="sd">              The SPM.mat file containing specification of the design and</span>
<span class="sd">              estimated model parameters (a pathlike object or string</span>
<span class="sd">              representing an existing file).</span>
<span class="sd">                  &lt;ex. /home/ArthurBlair/data/raw_data/SPM.mat&gt;</span>
<span class="sd">            # beta_images:</span>
<span class="sd">              Images of estimated regression coefficients beta_000k.img where</span>
<span class="sd">              k indexes the kth regression coefficient (a list of items which</span>
<span class="sd">              are a pathlike object or string representing an existing file).</span>
<span class="sd">                  &lt;ex. [&#39;/home/ArthurBlair/data/raw_data/beta_0001.nii&#39;,</span>
<span class="sd">                        &#39;/home/ArthurBlair/data/raw_data/beta_0002.nii&#39;,</span>
<span class="sd">                        &#39;/home/ArthurBlair/data/raw_data/beta_0003.nii&#39;,</span>
<span class="sd">                        &#39;/home/ArthurBlair/data/raw_data/beta_0004.nii&#39;,</span>
<span class="sd">                        &#39;/home/ArthurBlair/data/raw_data/beta_0005.nii&#39;,</span>
<span class="sd">                        &#39;/home/ArthurBlair/data/raw_data/beta_0006.nii&#39;,</span>
<span class="sd">                        &#39;/home/ArthurBlair/data/raw_data/beta_0007.nii&#39;,</span>
<span class="sd">                        &#39;/home/ArthurBlair/data/raw_data/beta_0008.nii&#39;]&gt;</span>
<span class="sd">            # mask_image:</span>
<span class="sd">              The mask.img image indicating which voxels were included in the</span>
<span class="sd">              analysis (a pathlike object or string representing an</span>
<span class="sd">              existing file).</span>
<span class="sd">                  &lt;ex. /home/ArthurBlair/data/raw_data/mask.nii&gt;</span>
<span class="sd">            # residual_image:</span>
<span class="sd">              The ResMS.img image of the variance of the error (a pathlike</span>
<span class="sd">              object or string representing an existing file).</span>
<span class="sd">                  &lt;ex. /home/ArthurBlair/data/raw_data/ResMS.nii &gt;</span>
<span class="sd">            # residual_images:</span>
<span class="sd">              The individual error Res_000k.img images (a list of items which</span>
<span class="sd">              are a pathlike object or string representing an existing file)</span>
<span class="sd">              where k indexes the kth dynamic (fourth dimensional points of</span>
<span class="sd">              the fuctional). These images are generated only if</span>
<span class="sd">              write_residuals is True.</span>
<span class="sd">                  &lt;ex. [&#39;/home/ArthurBlair/data/raw_data/Res_0001.nii&#39;,</span>
<span class="sd">                        &#39;/home/ArthurBlair/data/raw_data/Res_0002.nii&#39;,</span>
<span class="sd">                        &#39;/home/ArthurBlair/data/raw_data/Res_0003.nii&#39;,</span>
<span class="sd">                        ...,</span>
<span class="sd">                        &#39;/home/ArthurBlair/data/raw_data/Res_0238.nii&#39;,</span>
<span class="sd">                        &#39;/home/ArthurBlair/data/raw_data/Res_0239.nii&#39;,</span>
<span class="sd">                        &#39;/home/ArthurBlair/data/raw_data/Res_0240.nii&#39;]&gt;</span>
<span class="sd">            # RPVimage:</span>
<span class="sd">              The RPV.img image of the estimated resolution elements per voxel</span>
<span class="sd">              (a pathlike object or string representing an existing file).</span>
<span class="sd">                  &lt;ex. /home/ArthurBlair/data/raw_data/RPV.nii&gt;</span>
<span class="sd">            # labels:</span>
<span class="sd">                  &lt;ex. &gt;</span>
<span class="sd">            # SDerror:</span>
<span class="sd">                  &lt;ex. &gt;</span>
<span class="sd">            # ARcoef:</span>
<span class="sd">              Images of the autoregressive (AR) coefficient (a list of items</span>
<span class="sd">              which are a pathlike object or string representing an</span>
<span class="sd">              existing file).</span>
<span class="sd">                  &lt;ex. &gt;</span>
<span class="sd">            # Cbetas:</span>
<span class="sd">                  &lt;ex. &gt;</span>
<span class="sd">            # SDbetas:</span>
<span class="sd">                  &lt;ex. &gt;</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="EstimateModel.__init__"><a class="viewcode-back" href="../../../../../mia_processes.bricks.stat.spm.html#mia_processes.bricks.stat.spm.model.EstimateModel.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the attributes initialisation / instantiation.</span>

<span class="sd">        The input and output plugs are defined here. The special</span>
<span class="sd">        &#39;self.requirement&#39; attribute (optional) is used to define the</span>
<span class="sd">        third-party products necessary for the running of the brick.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Initialisation of the objects needed for the launch of the brick</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">EstimateModel</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1"># Third party softwares required for the execution of the brick</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requirement</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;spm&quot;</span><span class="p">,</span> <span class="s2">&quot;nipype&quot;</span><span class="p">]</span>

        <span class="c1"># Inputs description</span>
        <span class="n">spm_mat_file_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;The SPM.mat file that contains the design &quot;</span>
            <span class="s2">&quot;specification (a file object)&quot;</span>
        <span class="p">)</span>
        <span class="n">estimation_method_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;A dictionary of either Classical: 1, &quot;</span>
            <span class="s2">&quot;Bayesian: 1, or Bayesian2: 1&quot;</span>
        <span class="p">)</span>
        <span class="n">write_residuals_desc</span> <span class="o">=</span> <span class="s2">&quot;Write individual residual images (a boolean)&quot;</span>
        <span class="n">flags_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Additional arguments (a dictionary with keys which are &quot;</span>
            <span class="s2">&quot;any value and with values which are any value)&quot;</span>
        <span class="p">)</span>
        <span class="n">version_desc</span> <span class="o">=</span> <span class="s2">&quot;Version of spm (a string)&quot;</span>
        <span class="n">tot_reg_num_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;The total number of estimated regression&quot;</span>
            <span class="s2">&quot;coefficients (an integer)&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Outputs description</span>
        <span class="n">out_spm_mat_file_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;The file containing specification of the &quot;</span>
            <span class="s2">&quot;design and estimated model parameters (a &quot;</span>
            <span class="s2">&quot;pathlike object or string representing an &quot;</span>
            <span class="s2">&quot;existing file)&quot;</span>
        <span class="p">)</span>
        <span class="n">beta_images_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Images of estimated regression coefficients (a &quot;</span>
            <span class="s2">&quot;list of items which are a pathlike object or &quot;</span>
            <span class="s2">&quot;string representing an existing file)&quot;</span>
        <span class="p">)</span>
        <span class="n">mask_image_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;The image indicating which voxels were included in &quot;</span>
            <span class="s2">&quot;the analysis (a pathlike object or string &quot;</span>
            <span class="s2">&quot;representing an existing file)&quot;</span>
        <span class="p">)</span>
        <span class="n">residual_image_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;The image of the variance of the error (a &quot;</span>
            <span class="s2">&quot;pathlike object or string representing an &quot;</span>
            <span class="s2">&quot;existing file)&quot;</span>
        <span class="p">)</span>
        <span class="n">residual_images_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;The individual error images (a list of items &quot;</span>
            <span class="s2">&quot;which are a pathlike object or string &quot;</span>
            <span class="s2">&quot;representing an existing file)&quot;</span>
        <span class="p">)</span>
        <span class="n">RPVimage_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;The image of the estimated resolution elements per &quot;</span>
            <span class="s2">&quot;voxel (a pathlike object or string representing an &quot;</span>
            <span class="s2">&quot;existing file).&quot;</span>
        <span class="p">)</span>
        <span class="n">labels_desc</span> <span class="o">=</span> <span class="s2">&quot;blabla&quot;</span>
        <span class="n">SDerror_desc</span> <span class="o">=</span> <span class="s2">&quot;blabla&quot;</span>
        <span class="n">ARcoef_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Images of the autoregressive (AR) coefficient (a list &quot;</span>
            <span class="s2">&quot;of items which are a pathlike object or string &quot;</span>
            <span class="s2">&quot;representing an existing file).&quot;</span>
        <span class="p">)</span>
        <span class="n">Cbetas_desc</span> <span class="o">=</span> <span class="s2">&quot;blabla&quot;</span>
        <span class="n">SDbetas_desc</span> <span class="o">=</span> <span class="s2">&quot;blabla&quot;</span>

        <span class="c1"># Inputs traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;spm_mat_file&quot;</span><span class="p">,</span>
            <span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">spm_mat_file_desc</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;estimation_method&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">Dict</span><span class="p">(</span>
                <span class="n">traits</span><span class="o">.</span><span class="n">Enum</span><span class="p">(</span><span class="s2">&quot;Classical&quot;</span><span class="p">,</span> <span class="s2">&quot;Bayesian&quot;</span><span class="p">,</span> <span class="s2">&quot;Bayesian2&quot;</span><span class="p">),</span>
                <span class="n">traits</span><span class="o">.</span><span class="n">Enum</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
                <span class="n">usedefault</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">estimation_method_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">estimation_method</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Classical&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;write_residuals&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">Bool</span><span class="p">(</span>
                <span class="n">usedefault</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">write_residuals_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;flags&quot;</span><span class="p">,</span> <span class="n">traits</span><span class="o">.</span><span class="n">Dict</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">flags_desc</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;version&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">String</span><span class="p">(</span>
                <span class="s2">&quot;spm12&quot;</span><span class="p">,</span>
                <span class="n">usedefault</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">version_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;tot_reg_num&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">Either</span><span class="p">(</span>
                <span class="p">(</span><span class="n">traits</span><span class="o">.</span><span class="n">Int</span><span class="p">(),</span> <span class="n">Undefined</span><span class="p">),</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">tot_reg_num_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tot_reg_num</span> <span class="o">=</span> <span class="n">Undefined</span>

        <span class="c1"># Output traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;out_spm_mat_file&quot;</span><span class="p">,</span>
            <span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">out_spm_mat_file_desc</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;beta_images&quot;</span><span class="p">,</span>
            <span class="n">OutputMultiPath</span><span class="p">(</span>
                <span class="n">ImageFileSPM</span><span class="p">(),</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">beta_images_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;mask_image&quot;</span><span class="p">,</span>
            <span class="n">ImageFileSPM</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">mask_image_desc</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;residual_image&quot;</span><span class="p">,</span>
            <span class="n">ImageFileSPM</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">residual_image_desc</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;residual_images&quot;</span><span class="p">,</span>
            <span class="n">OutputMultiPath</span><span class="p">(</span>
                <span class="n">ImageFileSPM</span><span class="p">(),</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">residual_images_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;RPVimage&quot;</span><span class="p">,</span>
            <span class="n">ImageFileSPM</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">RPVimage_desc</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;labels&quot;</span><span class="p">,</span>
            <span class="n">ImageFileSPM</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">labels_desc</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;SDerror&quot;</span><span class="p">,</span>
            <span class="n">OutputMultiPath</span><span class="p">(</span>
                <span class="n">ImageFileSPM</span><span class="p">(),</span> <span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">SDerror_desc</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;ARcoef&quot;</span><span class="p">,</span>
            <span class="n">OutputMultiPath</span><span class="p">(</span>
                <span class="n">ImageFileSPM</span><span class="p">(),</span> <span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">ARcoef_desc</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;Cbetas&quot;</span><span class="p">,</span>
            <span class="n">OutputMultiPath</span><span class="p">(</span>
                <span class="n">ImageFileSPM</span><span class="p">(),</span> <span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">Cbetas_desc</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;SDbetas&quot;</span><span class="p">,</span>
            <span class="n">OutputMultiPath</span><span class="p">(</span>
                <span class="n">ImageFileSPM</span><span class="p">(),</span> <span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">SDbetas_desc</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">init_default_traits</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_process</span><span class="p">(</span><span class="s2">&quot;nipype.interfaces.spm.EstimateModel&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="EstimateModel.list_outputs"><a class="viewcode-back" href="../../../../../mia_processes.bricks.stat.spm.html#mia_processes.bricks.stat.spm.model.EstimateModel.list_outputs">[docs]</a>    <span class="k">def</span> <span class="nf">list_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_plugged</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the initialisation step of the brick.</span>

<span class="sd">        The main objective of this method is to produce the outputs of the</span>
<span class="sd">        bricks (self.outputs) and the associated tags (self.inheritance_dict),</span>
<span class="sd">        if defined here. In order not to include an output in the database,</span>
<span class="sd">        this output must be a value of the optional key &#39;notInDb&#39; of the</span>
<span class="sd">        self.outputs dictionary. To work properly this method must return</span>
<span class="sd">        self.make_initResult() object.</span>

<span class="sd">        :param is_plugged: the state, linked or not, of the plugs.</span>
<span class="sd">        :returns: a dictionary with requirement, outputs and inheritance_dict.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Using the inheritance to ProcessMIA class, list_outputs method</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">EstimateModel</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">list_outputs</span><span class="p">()</span>

        <span class="c1"># Outputs definition and tags inheritance (optional)</span>
        <span class="c1"># if self.outputs:</span>
        <span class="c1">#    self.outputs = {}</span>

        <span class="c1"># if self.inheritance_dict:</span>
        <span class="c1">#    self.inheritance_dict = {}</span>

        <span class="c1"># Old version calling Nipype&#39;s method</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        process = spm.EstimateModel()</span>
<span class="sd">        if not self.spm_mat_file:</span>
<span class="sd">            return {}, {}</span>
<span class="sd">        else:</span>
<span class="sd">            process.inputs.spm_mat_file = self.spm_mat_file</span>
<span class="sd">        if not self.estimation_method:</span>
<span class="sd">            return {}, {}</span>
<span class="sd">        else:</span>
<span class="sd">            process.inputs.estimation_method = self.estimation_method</span>

<span class="sd">        process.inputs.write_residuals = self.write_residuals</span>
<span class="sd">        process.inputs.flags = self.flags</span>

<span class="sd">        outputs = process._list_outputs()</span>
<span class="sd">        outputs[&quot;out_spm_mat_file&quot;] = outputs.pop(&quot;spm_mat_file&quot;)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Own list_outputs to avoid reading in the SPM.mat file</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spm_mat_file</span><span class="p">)</span>
            <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spm_mat_file</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;&lt;undefined&gt;&quot;</span><span class="p">,</span> <span class="n">Undefined</span><span class="p">])</span>
            <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">estimation_method</span><span class="p">)</span>
            <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">estimation_method</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;&lt;undefined&gt;&quot;</span><span class="p">,</span> <span class="n">Undefined</span><span class="p">])</span>
        <span class="p">):</span>
            <span class="n">im_form</span> <span class="o">=</span> <span class="s2">&quot;nii&quot;</span> <span class="k">if</span> <span class="s2">&quot;12&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="k">else</span> <span class="s2">&quot;img&quot;</span>
            <span class="c1"># The management of self.process.output_directory could be</span>
            <span class="c1"># delegated to the</span>
            <span class="c1"># populse_mia.user_interface.pipeline_manager.process_mia</span>
            <span class="c1"># module. We can&#39;t do it at the moment because the</span>
            <span class="c1"># sync_process_output_traits() of the</span>
            <span class="c1"># capsul/process/nipype_process module raises an exception</span>
            <span class="c1"># in nipype if the mandatory parameter are not yet defined!</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">output_directory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No output_directory was found...!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">_</span><span class="p">,</span> <span class="n">spm_mat_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spm_mat_file</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;out_spm_mat_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span> <span class="n">spm_mat_file</span>
            <span class="p">)</span>
            <span class="c1"># Detecting the number of beta files to create</span>
            <span class="n">betas</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="c1"># Those lines are false, we cannot read in the</span>
            <span class="c1"># self.spm_mat_file because it is not created yet! (1)</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            try:</span>
<span class="sd">                spm_matFile = scipy.io.loadmat(self.spm_mat_file)</span>
<span class="sd">                nb_reg = spm_matFile[&#39;SPM&#39;][0,0][&#39;Sess&#39;][0,0][&#39;col&#39;].shape[1]</span>
<span class="sd">                print(&quot;\n EstimateModel brick: {} regressors &quot;</span>
<span class="sd">                      &quot;found ...\n&quot;.format(nb_reg))</span>
<span class="sd">                nb_reg += 1  # Adding the constant value</span>

<span class="sd">            except Exception as e:</span>
<span class="sd">                print(&quot;\nEstimateModel brick exception; &quot;</span>
<span class="sd">                      &quot;{0}: {1}\n&quot;.format(e.__class__, e))</span>
<span class="sd">            if (  (not nb_reg) and (self.multi_reg) and</span>
<span class="sd">              (self.multi_reg not in [&#39;&lt;undefined&gt;&#39;, Undefined])  ):</span>

<span class="sd">                for reg_file in self.multi_reg:</span>
<span class="sd">                    # Those lines are false, we cannot read in all files in</span>
<span class="sd">                    # self.multi_reg because they are not created yet! (2)</span>

<span class="sd">                    if os.path.splitext(reg_file)[1] == &#39;.txt&#39;:</span>

<span class="sd">                        with open(reg_file) as f:</span>
<span class="sd">                            first_line = f.readline()</span>
<span class="sd">                            print(&#39;FIRST LINE&#39;, first_line)</span>
<span class="sd">                            # Adding the constant value</span>
<span class="sd">                            nb_reg += len(first_line.split()) + 1</span>

<span class="sd">                    # and for other reg_file?</span>

<span class="sd">                    # The current workaround to try to detect the number of</span>
<span class="sd">                    # beta files to be created!</span>
<span class="sd">                    # TODO: find a better way</span>
<span class="sd">                    if os.path.basename(reg_file)[0:3] == &#39;rp_&#39;:</span>
<span class="sd">                        nb_reg += 6</span>

<span class="sd">                    if (os.path.basename(reg_file)[0:22] ==</span>
<span class="sd">                            &#39;regressor_physio_EtCO2&#39;):</span>
<span class="sd">                        nb_reg += 1</span>

<span class="sd">                if nb_reg:</span>
<span class="sd">                    nb_reg += 1 # Adding the constant value</span>
<span class="sd">            &quot;&quot;&quot;</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tot_reg_num</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;&lt;undefined&gt;&quot;</span><span class="p">,</span> <span class="n">Undefined</span><span class="p">]:</span>
                <span class="n">tot_reg_numb</span> <span class="o">=</span> <span class="n">get_dbFieldValue</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">spm_mat_file</span><span class="p">,</span> <span class="s2">&quot;Regress num&quot;</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="n">tot_reg_numb</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">tot_reg_num</span> <span class="o">=</span> <span class="n">tot_reg_numb</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">EstimateModel brick:</span><span class="se">\n</span><span class="s1"> The &quot;tot_reg_num&quot; parameter&#39;</span>
                        <span class="s2">&quot; could not be determined automatically because the &quot;</span>
                        <span class="s1">&#39;&quot;Regress num&quot; tag for the </span><span class="si">{}</span><span class="s1"> file is not filled &#39;</span>
                        <span class="s2">&quot;in the database. Please set this value and launch &quot;</span>
                        <span class="s2">&quot;the calculation &quot;</span>
                        <span class="s2">&quot;again!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spm_mat_file</span><span class="p">)</span>
                    <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_initResult</span><span class="p">()</span>

            <span class="c1"># Bayesian and Bayesian2 are not yet fully implemented</span>
            <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;Bayesian&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimation_method</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="ow">or</span> <span class="p">(</span>
                <span class="s2">&quot;Bayesian2&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimation_method</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span> <span class="s2">&quot;labels.</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">im_form</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                outputs[&#39;SDerror&#39;] = glob(os.path.join(path, &#39;Sess*_SDerror*&#39;))</span>
<span class="sd">                outputs[&#39;ARcoef&#39;] = glob(os.path.join(path, &#39;Sess*_AR_*&#39;))</span>
<span class="sd">                &quot;&quot;&quot;</span>

            <span class="k">if</span> <span class="s2">&quot;Classical&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimation_method</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;residual_image&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span> <span class="s2">&quot;ResMS.</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">im_form</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;RPVimage&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span> <span class="s2">&quot;RPV.</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">im_form</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;mask_image&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span> <span class="s2">&quot;mask.</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">im_form</span><span class="p">)</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_residuals</span><span class="p">:</span>
                    <span class="n">nb_dyn</span> <span class="o">=</span> <span class="n">get_dbFieldValue</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">spm_mat_file</span><span class="p">,</span> <span class="s2">&quot;Dynamic Number&quot;</span>
                    <span class="p">)</span>

                    <span class="k">if</span> <span class="n">nb_dyn</span><span class="p">:</span>
                        <span class="n">nb_dyn</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">nb_dyn</span><span class="p">)</span>
                        <span class="n">ress</span> <span class="o">=</span> <span class="p">[]</span>

                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nb_dyn</span><span class="p">):</span>
                            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="n">ress</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Res_</span><span class="si">{:04d}</span><span class="s2">.</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">im_form</span><span class="p">))</span>

                        <span class="k">if</span> <span class="n">ress</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;residual_images&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span> <span class="n">res</span><span class="p">)</span>
                                <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">ress</span>
                            <span class="p">]</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span>
                            <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">EstimateModel brick:</span><span class="se">\n</span><span class="s2">The number of dynamics &quot;</span>
                            <span class="s2">&quot;could not be determined automatically because &quot;</span>
                            <span class="s1">&#39;the &quot;Dynamic Number&quot; tag is not filled in the&#39;</span>
                            <span class="s2">&quot;database for the </span><span class="si">{}</span><span class="s2"> file.</span><span class="se">\n</span><span class="s2">As a result, it is &quot;</span>
                            <span class="s2">&quot;not possible to safely create the &quot;</span>
                            <span class="s1">&#39;&quot;residual_images&quot; output &#39;</span>
                            <span class="s2">&quot;parameter!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spm_mat_file</span><span class="p">)</span>
                        <span class="p">)</span>

                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span>
                    <span class="nb">int</span><span class="p">(</span>
                        <span class="mi">0</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tot_reg_num</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;&lt;undefined&gt;&quot;</span><span class="p">,</span> <span class="n">Undefined</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>
                        <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">tot_reg_num</span>
                    <span class="p">)</span>
                <span class="p">):</span>
                    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">betas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;beta_</span><span class="si">{:04d}</span><span class="s2">.</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">im_form</span><span class="p">))</span>

                <span class="k">if</span> <span class="n">betas</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;beta_images&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span> <span class="n">beta</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">beta</span> <span class="ow">in</span> <span class="n">betas</span>
                    <span class="p">]</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">EstimateModel brick:</span><span class="se">\n</span><span class="s2">No beta image were found to&quot;</span>
                        <span class="s2">&quot; be added to the database ...&quot;</span>
                    <span class="p">)</span>

            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tot_reg_num</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;&lt;undefined&gt;&quot;</span><span class="p">,</span> <span class="n">Undefined</span><span class="p">,</span> <span class="kc">None</span><span class="p">])</span> <span class="ow">or</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_residuals</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">nb_dyn</span>
            <span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;out_spm_mat_file&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">inheritance_dict</span><span class="p">[</span><span class="n">value</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spm_mat_file</span>

                <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;beta_images&quot;</span><span class="p">:</span>
                    <span class="n">patient_name</span> <span class="o">=</span> <span class="n">get_dbFieldValue</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">spm_mat_file</span><span class="p">,</span> <span class="s2">&quot;PatientName&quot;</span>
                    <span class="p">)</span>

                    <span class="k">for</span> <span class="n">fullname</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">inheritance_dict</span><span class="p">[</span><span class="n">fullname</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spm_mat_file</span>
                        <span class="c1"># FIXME: In the latest version of mia, indexing of the</span>
                        <span class="c1">#        database with particular tags defined in the</span>
                        <span class="c1">#        processes is done only at the end of the</span>
                        <span class="c1">#        initialisation of the whole pipeline. So we</span>
                        <span class="c1">#        cannot use the value of these tags in other</span>
                        <span class="c1">#        processes of the pipeline at the time of</span>
                        <span class="c1">#        initialisation (see populse_mia #290). Unti</span>
                        <span class="c1">#        better we use a quick and dirty hack with the</span>
                        <span class="c1">#        set_dbFieldValue() function !</span>

                        <span class="k">if</span> <span class="n">patient_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">tag_to_add</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;PatientName&quot;</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;field_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;string&quot;</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;visibility&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;origin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;user&quot;</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;unit&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;default_value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">patient_name</span>
                            <span class="n">set_dbFieldValue</span><span class="p">(</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="n">fullname</span><span class="p">,</span> <span class="n">tag_to_add</span>
                            <span class="p">)</span>

                        <span class="k">else</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span>
                                <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">EstimateModel brick:</span><span class="se">\n</span><span class="s2">The &#39;PatientName&#39; &quot;</span>
                                <span class="s2">&quot;tag could not be added to the database for &quot;</span>
                                <span class="s2">&quot;the &#39;</span><span class="si">{}</span><span class="s2">&#39; parameter. This can lead to a &quot;</span>
                                <span class="s2">&quot;subsequent issue during &quot;</span>
                                <span class="s2">&quot;initialization!!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fullname</span><span class="p">)</span>
                            <span class="p">)</span>

                        <span class="n">age</span> <span class="o">=</span> <span class="n">get_dbFieldValue</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">spm_mat_file</span><span class="p">,</span> <span class="s2">&quot;Age&quot;</span>
                        <span class="p">)</span>

                        <span class="k">if</span> <span class="n">age</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">tag_to_add</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Age&quot;</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;field_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;int&quot;</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;visibility&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;origin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;user&quot;</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;unit&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;default_value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">age</span>
                            <span class="n">set_dbFieldValue</span><span class="p">(</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="n">fullname</span><span class="p">,</span> <span class="n">tag_to_add</span>
                            <span class="p">)</span>

                        <span class="n">pathology</span> <span class="o">=</span> <span class="n">get_dbFieldValue</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">spm_mat_file</span><span class="p">,</span> <span class="s2">&quot;Pathology&quot;</span>
                        <span class="p">)</span>

                        <span class="k">if</span> <span class="n">pathology</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">tag_to_add</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Pathology&quot;</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;field_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;string&quot;</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;visibility&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;origin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;user&quot;</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;unit&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;default_value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pathology</span>
                            <span class="n">set_dbFieldValue</span><span class="p">(</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="n">fullname</span><span class="p">,</span> <span class="n">tag_to_add</span>
                            <span class="p">)</span>

                <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;mask_image&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">inheritance_dict</span><span class="p">[</span><span class="n">value</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spm_mat_file</span>

                <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;residual_image&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">inheritance_dict</span><span class="p">[</span><span class="n">value</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spm_mat_file</span>

                <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;residual_images&quot;</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">fullname</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">inheritance_dict</span><span class="p">[</span><span class="n">fullname</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spm_mat_file</span>

                <span class="k">elif</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;RPVimage&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">inheritance_dict</span><span class="p">[</span><span class="n">value</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spm_mat_file</span>

        <span class="c1"># Return the requirement, outputs and inheritance_dict</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_initResult</span><span class="p">()</span></div>

<div class="viewcode-block" id="EstimateModel.run_process_mia"><a class="viewcode-back" href="../../../../../mia_processes.bricks.stat.spm.html#mia_processes.bricks.stat.spm.model.EstimateModel.run_process_mia">[docs]</a>    <span class="k">def</span> <span class="nf">run_process_mia</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the process launch step of the brick.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">EstimateModel</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">run_process_mia</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">spm_mat_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spm_mat_file</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">estimation_method</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimation_method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">write_residuals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_residuals</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">flags</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flags</span>

        <span class="c1"># Removing the image files to avoid a bug</span>
        <span class="c1"># I do not observe the bug now, i comment the following lines:</span>
        <span class="c1"># TODO: In fact, self.outputs is == {} at this point(see issue #272).</span>
        <span class="c1">#       If necessary, we can use the dict4runtine object?</span>
        <span class="c1">#</span>
        <span class="c1"># for key, value in self.outputs.items():</span>

        <span class="c1">#   if key not in [&quot;out_spm_mat_file&quot;]:</span>

        <span class="c1">#        if value not in [&quot;&lt;undefined&gt;&quot;, Undefined]:</span>

        <span class="c1">#            if type(value) in [list, traits.TraitListObject,</span>
        <span class="c1">#                               traits.List]:</span>

        <span class="c1">#                for element in value:</span>

        <span class="c1">#                    if os.path.isfile(element):</span>
        <span class="c1">#                        os.remove(element)</span>

        <span class="c1">#           else:</span>

        <span class="c1">#                if os.path.isfile(value):</span>
        <span class="c1">#                    os.remove(value)</span>

        <span class="c1"># self.process.run()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">configuration_dict</span><span class="o">=</span><span class="p">{})</span></div></div>


<div class="viewcode-block" id="Level1Design"><a class="viewcode-back" href="../../../../../mia_processes.bricks.stat.spm.html#mia_processes.bricks.stat.spm.model.Level1Design">[docs]</a><span class="k">class</span> <span class="nc">Level1Design</span><span class="p">(</span><span class="n">ProcessMIA</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    * Specification of the GLM design matrix, fMRI data files and filtering.</span>

<span class="sd">    Please, see the complete documentation for the Level1Design brick in the</span>
<span class="sd">    https://gricad-gitlab.univ-grenoble-alpes.fr/condamie/ec_dev web site</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Level1Design.__init__"><a class="viewcode-back" href="../../../../../mia_processes.bricks.stat.spm.html#mia_processes.bricks.stat.spm.model.Level1Design.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the attributes initialisation / instantiation.</span>

<span class="sd">        The input and output plugs are defined here. The special</span>
<span class="sd">        &#39;self.requirement&#39; attribute (optional) is used to define the</span>
<span class="sd">        third-party products necessary for the running of the brick.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Initialisation of the objects needed for the launch of the brick</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Level1Design</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1"># Third party softwares required for the execution of the brick</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requirement</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;spm&quot;</span><span class="p">,</span> <span class="s2">&quot;nipype&quot;</span><span class="p">]</span>

        <span class="c1"># Inputs description</span>
        <span class="n">timing_units_desc</span> <span class="o">=</span> <span class="s2">&quot;One of &#39;scans&#39; or &#39;secs&#39;&quot;</span>
        <span class="n">interscan_interval_desc</span> <span class="o">=</span> <span class="s2">&quot;TR in secs (a float)&quot;</span>
        <span class="n">microtime_resolution_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;The number of time-bins per scan used &quot;</span>
            <span class="s2">&quot;to build regressors (an integer)&quot;</span>
        <span class="p">)</span>
        <span class="n">microtime_onset_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;The reference time-bin at which the &quot;</span>
            <span class="s2">&quot;regressors are resampled to coincide with &quot;</span>
            <span class="s2">&quot;data acquisition (an integer)&quot;</span>
        <span class="p">)</span>
        <span class="n">sess_scans_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;The fMRI scan for each session (a list of items &quot;</span>
            <span class="s2">&quot;which are a pathlike object or string representing &quot;</span>
            <span class="s2">&quot;an existing file)&quot;</span>
        <span class="p">)</span>
        <span class="n">sess_cond_names_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;The name of each condition (list of items &quot;</span>
            <span class="s2">&quot;which are a list of items which are a &quot;</span>
            <span class="s2">&quot;string)&quot;</span>
        <span class="p">)</span>
        <span class="n">sess_cond_onsets_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;The onset times (in seconds or in scans) of &quot;</span>
            <span class="s2">&quot;the epochs or events within each condition &quot;</span>
            <span class="s2">&quot;(a list of items which are a list of items &quot;</span>
            <span class="s2">&quot;which are a list of items which are a &quot;</span>
            <span class="s2">&quot;float)&quot;</span>
        <span class="p">)</span>
        <span class="n">sess_cond_durations_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;The duration times (in seconds or in &quot;</span>
            <span class="s2">&quot;scans) of the epochs within each &quot;</span>
            <span class="s2">&quot;condition (a list of items which are a &quot;</span>
            <span class="s2">&quot;list of items which are a list of items &quot;</span>
            <span class="s2">&quot;which are a float)&quot;</span>
        <span class="p">)</span>
        <span class="n">sess_cond_tmod_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Allows for the characterisation of linear or &quot;</span>
            <span class="s2">&quot;nonlinear time effects (a list of items which &quot;</span>
            <span class="s2">&quot;are a list of items which are 0 or 1 or 2 or 3 &quot;</span>
            <span class="s2">&quot;or 4 or 5 or 6)&quot;</span>
        <span class="p">)</span>
        <span class="n">sess_cond_pmod_names_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;The name of the parametric modulation (a &quot;</span>
            <span class="s2">&quot;list of items which are a list of items &quot;</span>
            <span class="s2">&quot;which are a list of items which are a &quot;</span>
            <span class="s2">&quot;string)&quot;</span>
        <span class="p">)</span>
        <span class="n">sess_cond_pmod_values_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;The values used for the parametric &quot;</span>
            <span class="s2">&quot;modulation, one for each occurence of &quot;</span>
            <span class="s2">&quot;the event (a list of items which are a &quot;</span>
            <span class="s2">&quot;list of items which are a list of items &quot;</span>
            <span class="s2">&quot;which are a list of items which are a &quot;</span>
            <span class="s2">&quot;float)&quot;</span>
        <span class="p">)</span>
        <span class="n">sess_cond_pmod_polys_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;The polynomial expansion used for the &quot;</span>
            <span class="s2">&quot;parametric modulation (a list of items &quot;</span>
            <span class="s2">&quot;which are a list of items which are a &quot;</span>
            <span class="s2">&quot;list of items which are 1 or 2 or 3 or 4 &quot;</span>
            <span class="s2">&quot;or 5 or 6)&quot;</span>
        <span class="p">)</span>
        <span class="n">sess_cond_orth_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Orthogonalise regressors within trial types &quot;</span>
            <span class="s2">&quot;(a list of items which are a list of items &quot;</span>
            <span class="s2">&quot;which are 0 or 1)&quot;</span>
        <span class="p">)</span>
        <span class="n">sess_multi_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;A *.mat file containing details of the multiple &quot;</span>
            <span class="s2">&quot;experimental conditions for each session (a list &quot;</span>
            <span class="s2">&quot;of items which are a filename)&quot;</span>
        <span class="p">)</span>
        <span class="n">sess_regress_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Additional columns included in the design &quot;</span>
            <span class="s2">&quot;matrix, which may model effects that would not &quot;</span>
            <span class="s2">&quot;be convolved with the haemodynamic response (a &quot;</span>
            <span class="s2">&quot;list of items which are a list of items which &quot;</span>
            <span class="s2">&quot;are a dictionary with keys which are &#39;name&#39; or &quot;</span>
            <span class="s2">&quot;&#39;val&#39; and with values which are a string or a &quot;</span>
            <span class="s2">&quot;list of float)&quot;</span>
        <span class="p">)</span>
        <span class="n">sess_multi_reg_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;The .mat/.txt file(s) containing details of &quot;</span>
            <span class="s2">&quot;multiple regressors (a list of items which are &quot;</span>
            <span class="s2">&quot;a filename)&quot;</span>
        <span class="p">)</span>
        <span class="n">sess_hpf_desc</span> <span class="o">=</span> <span class="s2">&quot;High-pass filter (a list of items which are a float)&quot;</span>
        <span class="n">factor_info_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;A list of items which are a dictionary for each &quot;</span>
            <span class="s2">&quot;factor with keys which are &#39;name&#39; or &#39;levels&#39; &quot;</span>
            <span class="s2">&quot;and with values which are a string (name of the &quot;</span>
            <span class="s2">&quot;factor) or an integer (number of levels for the &quot;</span>
            <span class="s2">&quot;factor)&quot;</span>
        <span class="p">)</span>
        <span class="n">bases_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;To define basic functions for modeling hemodynamic &quot;</span>
            <span class="s2">&quot;response (a &#39;none&#39; string or a dictionary with keys &quot;</span>
            <span class="s2">&quot;which are &#39;hrf&#39; or &#39;fourier&#39; or &#39;fourier_han&#39; or &quot;</span>
            <span class="s2">&quot;&#39;gamma&#39; or &#39;fir&#39; and with values which are a dictionary &quot;</span>
            <span class="s2">&quot;with keys which are &#39;derivs&#39; or &#39;length&#39; or &#39;order&#39; and &quot;</span>
            <span class="s2">&quot;with values which are a list or a float or an integer)&quot;</span>
        <span class="p">)</span>
        <span class="n">volterra_expansion_order_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;One of 1 or 2 (1: do not model &quot;</span>
            <span class="s2">&quot;interactions, 2: model interactions)&quot;</span>
        <span class="p">)</span>
        <span class="n">global_intensity_normalization_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Global intensity normalisation &quot;</span>
            <span class="s2">&quot;with scaling or not (one of &quot;</span>
            <span class="s2">&quot;&#39;none&#39; or &#39;scaling&#39;)&quot;</span>
        <span class="p">)</span>
        <span class="n">mask_threshold_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Masking threshold, defined as proportion of &quot;</span> <span class="s2">&quot;globals (a float)&quot;</span>
        <span class="p">)</span>
        <span class="n">mask_image_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Image for explicitly masking the analysis (a &quot;</span>
            <span class="s2">&quot;pathlike object or string representing a file)&quot;</span>
        <span class="p">)</span>
        <span class="n">model_serial_correlations_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;one of AR(1), or FAST or none &quot;</span>
            <span class="s2">&quot;(AR(1): autoregressive model, &quot;</span>
            <span class="s2">&quot;FAST: available in SPM12, &quot;</span>
            <span class="s2">&quot;none: serial correlation is &quot;</span>
            <span class="s2">&quot;ignored)&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Outputs description</span>
        <span class="n">spm_mat_file_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;SPM.mat file (a pathlike object or string &quot;</span> <span class="s2">&quot;representing a file&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Inputs traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;timing_units&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">Enum</span><span class="p">(</span>
                <span class="s2">&quot;scans&quot;</span><span class="p">,</span>
                <span class="s2">&quot;secs&quot;</span><span class="p">,</span>
                <span class="n">usedefault</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">timing_units_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># Plan to retrieve this parameter automatically from the database?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;interscan_interval&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">Either</span><span class="p">(</span>
                <span class="n">traits</span><span class="o">.</span><span class="n">Float</span><span class="p">(),</span>
                <span class="n">Undefined</span><span class="p">,</span>
                <span class="n">usedefault</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">interscan_interval_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interscan_interval</span> <span class="o">=</span> <span class="n">Undefined</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;microtime_resolution&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">Int</span><span class="p">(</span>
                <span class="mi">16</span><span class="p">,</span>
                <span class="n">usedefault</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">microtime_resolution_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># In study without slice-timing correction, as cevastoc32,</span>
        <span class="c1"># it should be 8?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;microtime_onset&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">Int</span><span class="p">(</span>
                <span class="mi">8</span><span class="p">,</span>
                <span class="n">usedefault</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">microtime_onset_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="c1"># TODO: mictotime onset (fmri_spec.timing.fmri_t0) = 1 in Amigo</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;sess_scans&quot;</span><span class="p">,</span>
            <span class="n">InputMultiPath</span><span class="p">(</span>
                <span class="n">File</span><span class="p">(</span><span class="n">exists</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
                <span class="n">usedefault</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">sess_scans_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;sess_cond_names&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">(</span>
                <span class="n">traits</span><span class="o">.</span><span class="n">Either</span><span class="p">(</span><span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">traits</span><span class="o">.</span><span class="n">String</span><span class="p">()),</span> <span class="kc">None</span><span class="p">),</span>
                <span class="n">value</span><span class="o">=</span><span class="p">[[]],</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">sess_cond_names_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;sess_cond_onsets&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">(</span>
                <span class="n">traits</span><span class="o">.</span><span class="n">Either</span><span class="p">(</span><span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">traits</span><span class="o">.</span><span class="n">Float</span><span class="p">())),</span> <span class="kc">None</span><span class="p">),</span>
                <span class="n">value</span><span class="o">=</span><span class="p">[[[]]],</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">sess_cond_onsets_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;sess_cond_durations&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">(</span>
                <span class="n">traits</span><span class="o">.</span><span class="n">Either</span><span class="p">(</span><span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">traits</span><span class="o">.</span><span class="n">Float</span><span class="p">())),</span> <span class="kc">None</span><span class="p">),</span>
                <span class="n">value</span><span class="o">=</span><span class="p">[[[]]],</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">sess_cond_durations_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;sess_cond_tmod&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">(</span>
                <span class="n">traits</span><span class="o">.</span><span class="n">Either</span><span class="p">(</span>
                    <span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">traits</span><span class="o">.</span><span class="n">Enum</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">)),</span> <span class="kc">None</span>
                <span class="p">),</span>
                <span class="n">value</span><span class="o">=</span><span class="p">[[</span><span class="mi">0</span><span class="p">]],</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">sess_cond_tmod_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;sess_cond_pmod_names&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">(</span>
                <span class="n">traits</span><span class="o">.</span><span class="n">Either</span><span class="p">(</span>
                    <span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">(</span>
                        <span class="n">traits</span><span class="o">.</span><span class="n">Either</span><span class="p">(</span><span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">traits</span><span class="o">.</span><span class="n">String</span><span class="p">()),</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="p">),</span>
                    <span class="kc">None</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">value</span><span class="o">=</span><span class="p">[[[]]],</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">sess_cond_pmod_names_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;sess_cond_pmod_values&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">(</span>
                <span class="n">traits</span><span class="o">.</span><span class="n">Either</span><span class="p">(</span>
                    <span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">(</span>
                        <span class="n">traits</span><span class="o">.</span><span class="n">Either</span><span class="p">(</span>
                            <span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">traits</span><span class="o">.</span><span class="n">Float</span><span class="p">())),</span> <span class="kc">None</span>
                        <span class="p">)</span>
                    <span class="p">),</span>
                    <span class="kc">None</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">value</span><span class="o">=</span><span class="p">[[[[]]]],</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">sess_cond_pmod_values_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;sess_cond_pmod_polys&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">(</span>
                <span class="n">traits</span><span class="o">.</span><span class="n">Either</span><span class="p">(</span>
                    <span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">(</span>
                        <span class="n">traits</span><span class="o">.</span><span class="n">Either</span><span class="p">(</span>
                            <span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">traits</span><span class="o">.</span><span class="n">Enum</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">)),</span> <span class="kc">None</span>
                        <span class="p">)</span>
                    <span class="p">),</span>
                    <span class="kc">None</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">value</span><span class="o">=</span><span class="p">[[[]]],</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">sess_cond_pmod_polys_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;sess_cond_orth&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">(</span>
                <span class="n">traits</span><span class="o">.</span><span class="n">Either</span><span class="p">(</span><span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">traits</span><span class="o">.</span><span class="n">Enum</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span> <span class="kc">None</span><span class="p">),</span>
                <span class="n">value</span><span class="o">=</span><span class="p">[[]],</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">sess_cond_orth_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;sess_multi&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">(</span>
                <span class="n">traits</span><span class="o">.</span><span class="n">File</span><span class="p">(),</span>
                <span class="n">value</span><span class="o">=</span><span class="p">[],</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">sess_multi_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;sess_regress&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">(</span>
                <span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">(</span>
                    <span class="n">traits</span><span class="o">.</span><span class="n">Dict</span><span class="p">(</span>
                        <span class="n">traits</span><span class="o">.</span><span class="n">Enum</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;val&quot;</span><span class="p">),</span>
                        <span class="n">traits</span><span class="o">.</span><span class="n">Union</span><span class="p">(</span><span class="n">traits</span><span class="o">.</span><span class="n">Str</span><span class="p">,</span> <span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">traits</span><span class="o">.</span><span class="n">Float</span><span class="p">())),</span>
                    <span class="p">)</span>
                <span class="p">),</span>
                <span class="n">value</span><span class="o">=</span><span class="p">[[]],</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">sess_regress_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;sess_multi_reg&quot;</span><span class="p">,</span>
            <span class="n">InputMultiPath</span><span class="p">(</span>
                <span class="n">traits</span><span class="o">.</span><span class="n">Either</span><span class="p">(</span><span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">traits</span><span class="o">.</span><span class="n">File</span><span class="p">()),</span> <span class="kc">None</span><span class="p">),</span>
                <span class="n">value</span><span class="o">=</span><span class="p">[[]],</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">sess_multi_reg_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;sess_hpf&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">(</span>
                <span class="n">traits</span><span class="o">.</span><span class="n">Float</span><span class="p">(),</span>
                <span class="n">value</span><span class="o">=</span><span class="p">[</span><span class="mf">427.2</span><span class="p">],</span>
                <span class="n">usedefault</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">sess_hpf_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="c1"># TODO: 427.2 corresponds to the value used in Amigo</span>
        <span class="c1">#       Duration * TR * 3.56 = 427.2 if Duration == 40 and</span>
        <span class="c1">#       TR == 3s; why 3.56 ?</span>
        <span class="c1">#       I was expecting rather to:</span>
        <span class="c1">#       (time between first block start</span>
        <span class="c1">#        - second block start) * TR *2 = 80 *3 *2 = 480</span>
        <span class="c1">#       Can we code an automatic recovery procedure for the</span>
        <span class="c1">#       hpf parameter ?</span>
        <span class="c1">#       (in this case, the user would have to declare additional</span>
        <span class="c1">#       tags in the database, like the block duration !)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;factor_info&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">(</span>
                <span class="n">traits</span><span class="o">.</span><span class="n">Dict</span><span class="p">(</span>
                    <span class="n">traits</span><span class="o">.</span><span class="n">Enum</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;levels&quot;</span><span class="p">),</span>
                    <span class="n">traits</span><span class="o">.</span><span class="n">Either</span><span class="p">(</span><span class="n">traits</span><span class="o">.</span><span class="n">Str</span><span class="p">,</span> <span class="n">traits</span><span class="o">.</span><span class="n">Int</span><span class="p">),</span>
                <span class="p">),</span>
                <span class="n">usedefault</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">factor_info_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># traits.Union available from traits 6.1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;bases&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">Union</span><span class="p">(</span>
                <span class="n">traits</span><span class="o">.</span><span class="n">Dict</span><span class="p">(</span>
                    <span class="n">traits</span><span class="o">.</span><span class="n">Enum</span><span class="p">(</span>
                        <span class="s2">&quot;hrf&quot;</span><span class="p">,</span> <span class="s2">&quot;fourier&quot;</span><span class="p">,</span> <span class="s2">&quot;fourier_han&quot;</span><span class="p">,</span> <span class="s2">&quot;gamma&quot;</span><span class="p">,</span> <span class="s2">&quot;fir&quot;</span>
                    <span class="p">),</span>
                    <span class="n">traits</span><span class="o">.</span><span class="n">Dict</span><span class="p">(</span>
                        <span class="n">traits</span><span class="o">.</span><span class="n">Enum</span><span class="p">(</span><span class="s2">&quot;derivs&quot;</span><span class="p">,</span> <span class="s2">&quot;length&quot;</span><span class="p">,</span> <span class="s2">&quot;order&quot;</span><span class="p">),</span>
                        <span class="n">traits</span><span class="o">.</span><span class="n">Union</span><span class="p">(</span>
                            <span class="n">traits</span><span class="o">.</span><span class="n">Enum</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span>
                            <span class="n">traits</span><span class="o">.</span><span class="n">Int</span><span class="p">,</span>
                            <span class="n">traits</span><span class="o">.</span><span class="n">Float</span><span class="p">,</span>
                        <span class="p">),</span>
                    <span class="p">),</span>
                <span class="p">),</span>
                <span class="n">traits</span><span class="o">.</span><span class="n">Enum</span><span class="p">([</span><span class="s2">&quot;none&quot;</span><span class="p">]),</span>
                <span class="n">usedefault</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">bases_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bases</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;hrf&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;derivs&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]}}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;volterra_expansion_order&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">Enum</span><span class="p">(</span>
                <span class="mi">1</span><span class="p">,</span>
                <span class="mi">2</span><span class="p">,</span>
                <span class="n">usedefault</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">volterra_expansion_order_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;global_intensity_normalization&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">Enum</span><span class="p">(</span>
                <span class="s2">&quot;none&quot;</span><span class="p">,</span>
                <span class="s2">&quot;scaling&quot;</span><span class="p">,</span>
                <span class="n">usedefault</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">global_intensity_normalization_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;mask_threshold&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">Float</span><span class="p">(</span>
                <span class="mf">0.8</span><span class="p">,</span>
                <span class="n">usedefault</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">mask_threshold_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;mask_image&quot;</span><span class="p">,</span>
            <span class="n">ImageFileSPM</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">mask_image_desc</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;model_serial_correlations&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">Enum</span><span class="p">(</span>
                <span class="s2">&quot;AR(1)&quot;</span><span class="p">,</span>
                <span class="s2">&quot;FAST&quot;</span><span class="p">,</span>
                <span class="s2">&quot;none&quot;</span><span class="p">,</span>
                <span class="n">usedefault</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">model_serial_correlations_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># Output traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;spm_mat_file&quot;</span><span class="p">,</span> <span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">spm_mat_file_desc</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Special parameter used as a messenger for the run_process_mia method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;dict4runtime&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">Dict</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">userlevel</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">init_default_traits</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_process</span><span class="p">(</span><span class="s2">&quot;nipype.interfaces.spm.Level1Design&quot;</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_get_conditions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx_session</span><span class="p">,</span> <span class="n">idx_cond</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generate the condition dictionary.</span>

<span class="sd">        One condition dictionary is generated for each condition.</span>
<span class="sd">        The condition dictionary has the following keys:</span>
<span class="sd">        - name (a string)</span>
<span class="sd">        - onset (a list of float)</span>
<span class="sd">        - duration (a list of float)</span>
<span class="sd">        - tmod (an integer between 0 and 6)</span>
<span class="sd">        - pmod a dictionary</span>
<span class="sd">        - orth (0 or 1)</span>

<span class="sd">        :param idx_session: session index.</span>
<span class="sd">        :param idx_cond: condition index</span>
<span class="sd">        :returns: conditions dictionary</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cond</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">cond</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sess_cond_names</span><span class="p">[</span><span class="n">idx_session</span><span class="p">][</span><span class="n">idx_cond</span><span class="p">]</span>
        <span class="n">onset</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sess_cond_onsets</span><span class="p">[</span><span class="n">idx_session</span><span class="p">][</span><span class="n">idx_cond</span><span class="p">]</span>
        <span class="p">):</span>
            <span class="n">onset</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>

        <span class="n">cond</span><span class="p">[</span><span class="s2">&quot;onset&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">onset</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sess_cond_durations</span><span class="p">[</span><span class="n">idx_session</span><span class="p">][</span><span class="n">idx_cond</span><span class="p">])</span>
            <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sess_cond_onsets</span><span class="p">[</span><span class="n">idx_session</span><span class="p">][</span><span class="n">idx_cond</span><span class="p">])</span>
        <span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sess_cond_durations</span><span class="p">[</span><span class="n">idx_session</span><span class="p">][</span><span class="n">idx_cond</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">duration</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sess_cond_durations</span><span class="p">[</span><span class="n">idx_session</span><span class="p">][</span><span class="n">idx_cond</span><span class="p">]</span>
            <span class="p">):</span>
                <span class="n">duration</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
            <span class="n">cond</span><span class="p">[</span><span class="s2">&quot;duration&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">duration</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">QMessageBox</span><span class="p">()</span>
            <span class="n">msg</span><span class="o">.</span><span class="n">setIcon</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Warning</span><span class="p">)</span>
            <span class="n">msg</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="s2">&quot;User_processes_ECdev - Level1Design Error!&quot;</span><span class="p">)</span>
            <span class="n">msg</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span>
                <span class="s2">&quot;Warning: The number of values in the &quot;</span>
                <span class="s2">&quot;sess_cond_durations parameter does not correspond to &quot;</span>
                <span class="s2">&quot;the number of values in the sess_cond_onsets &quot;</span>
                <span class="s2">&quot;parameter, for the session &#39;</span><span class="si">{0}</span><span class="s2">&#39; and the &quot;</span>
                <span class="s2">&quot;condition &#39;</span><span class="si">{1}</span><span class="s2">&#39;! Pease, check your &quot;</span>
                <span class="s2">&quot;settings ...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">idx_session</span><span class="p">,</span> <span class="n">cond</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">])</span>
            <span class="p">)</span>
            <span class="n">msg</span><span class="o">.</span><span class="n">setStandardButtons</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Close</span><span class="p">)</span>
            <span class="n">msg</span><span class="o">.</span><span class="n">buttonClicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
            <span class="n">msg</span><span class="o">.</span><span class="n">exec</span><span class="p">()</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">cond</span><span class="p">[</span><span class="s2">&quot;tmod&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sess_cond_tmod</span><span class="p">[</span><span class="n">idx_session</span><span class="p">][</span><span class="n">idx_cond</span><span class="p">]</span>

        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">QMessageBox</span><span class="p">()</span>
            <span class="n">msg</span><span class="o">.</span><span class="n">setIcon</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Warning</span><span class="p">)</span>
            <span class="n">msg</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="s2">&quot;User_processes_ECdev - Level1Design Error!&quot;</span><span class="p">)</span>
            <span class="n">msg</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span>
                <span class="s2">&quot;Warning: It seems that not all sess_cond_tmod &quot;</span>
                <span class="s2">&quot;parameter values are defined for all conditions. &quot;</span>
                <span class="s2">&quot;Each condition must have a value for the &quot;</span>
                <span class="s2">&quot;sess_cond_tmod parameter. Please, check the &quot;</span>
                <span class="s2">&quot;sess_cond_tmod parameter and try again to initialize &quot;</span>
                <span class="s2">&quot;the pipeline ...!&quot;</span>
            <span class="p">)</span>
            <span class="n">msg</span><span class="o">.</span><span class="n">setStandardButtons</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Close</span><span class="p">)</span>
            <span class="n">msg</span><span class="o">.</span><span class="n">buttonClicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
            <span class="n">msg</span><span class="o">.</span><span class="n">exec</span><span class="p">()</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sess_cond_pmod_names</span><span class="p">[</span><span class="n">idx_session</span><span class="p">])</span> <span class="ow">and</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sess_cond_pmod_names</span><span class="p">[</span><span class="n">idx_session</span><span class="p">][</span><span class="n">idx_cond</span><span class="p">]</span>
        <span class="p">):</span>
            <span class="n">pmods</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sess_cond_pmod_names</span><span class="p">[</span><span class="n">idx_session</span><span class="p">][</span><span class="n">idx_cond</span><span class="p">]</span>
            <span class="p">):</span>
                <span class="n">pmod</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                <span class="n">pmod</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
                <span class="n">param</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">sess_cond_pmod_values</span><span class="p">[</span><span class="n">idx_session</span><span class="p">][</span><span class="n">idx_cond</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                <span class="p">):</span>
                    <span class="n">param</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>

                <span class="n">pmod</span><span class="p">[</span><span class="s2">&quot;param&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">param</span>
                <span class="n">pmod</span><span class="p">[</span><span class="s2">&quot;poly&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sess_cond_pmod_polys</span><span class="p">[</span><span class="n">idx_session</span><span class="p">][</span>
                    <span class="n">idx_cond</span>
                <span class="p">][</span><span class="n">i</span><span class="p">]</span>
                <span class="n">pmods</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pmod</span><span class="p">)</span>

            <span class="n">cond</span><span class="p">[</span><span class="s2">&quot;pmod&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pmods</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">cond</span><span class="p">[</span><span class="s2">&quot;orth&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sess_cond_orth</span><span class="p">[</span><span class="n">idx_session</span><span class="p">][</span><span class="n">idx_cond</span><span class="p">]</span>

        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">QMessageBox</span><span class="p">()</span>
            <span class="n">msg</span><span class="o">.</span><span class="n">setIcon</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Warning</span><span class="p">)</span>
            <span class="n">msg</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="s2">&quot;User_processes_ECdev - Level1Design Error!&quot;</span><span class="p">)</span>
            <span class="n">msg</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span>
                <span class="s2">&quot;Warning: It seems that not all sess_cond_orth &quot;</span>
                <span class="s2">&quot;parameter values are defined for all conditions. &quot;</span>
                <span class="s2">&quot;Each condition must have a value for the &quot;</span>
                <span class="s2">&quot;sess_cond_orth parameter. Please, check the &quot;</span>
                <span class="s2">&quot;sess_cond_orth parameter and try again to initialize &quot;</span>
                <span class="s2">&quot;the pipeline ...!&quot;</span>
            <span class="p">)</span>
            <span class="n">msg</span><span class="o">.</span><span class="n">setStandardButtons</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Close</span><span class="p">)</span>
            <span class="n">msg</span><span class="o">.</span><span class="n">buttonClicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
            <span class="n">msg</span><span class="o">.</span><span class="n">exec</span><span class="p">()</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="n">cond</span>

    <span class="k">def</span> <span class="nf">_get_session_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx_session</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generate the session_info parameter for each session.</span>

<span class="sd">        The &#39;session_info&#39; dictonary is equivalent to the &#39;sess&#39;</span>
<span class="sd">        structure array spm parameter, for each session. It therefore includes</span>
<span class="sd">        the &#39;scans&#39;, &#39;cond&#39;, &#39;multi&#39;, &#39;regress&#39;, &#39;multi_reg&#39; and &#39;hpf&#39; keys,</span>
<span class="sd">        like for the &#39;sess&#39; parameter of spm.</span>

<span class="sd">        :param idx_session: session index.</span>
<span class="sd">        :returns: session_info, beta_sess parameters and condition number</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">session_info</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>  <span class="c1"># The information for this session</span>
        <span class="n">beta_sess</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># The regressors number for this session</span>
        <span class="n">cond_nb</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># The condition number for this session</span>

        <span class="c1"># scans</span>
        <span class="n">session_info</span><span class="p">[</span><span class="s2">&quot;scans&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sess_scans</span><span class="p">[</span><span class="n">idx_session</span><span class="p">]</span>

        <span class="c1"># cond</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sess_cond_names</span><span class="p">[</span><span class="n">idx_session</span><span class="p">]:</span>
            <span class="n">cond</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="c1"># idx_cond: condition index</span>
            <span class="k">for</span> <span class="n">idx_cond</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sess_cond_names</span><span class="p">[</span><span class="n">idx_session</span><span class="p">])):</span>
                <span class="n">condition</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_conditions</span><span class="p">(</span><span class="n">idx_session</span><span class="p">,</span> <span class="n">idx_cond</span><span class="p">)</span>
                <span class="n">cond</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">condition</span><span class="p">)</span>
                <span class="n">beta_sess</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">cond_nb</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="k">if</span> <span class="s2">&quot;pmod&quot;</span> <span class="ow">in</span> <span class="n">condition</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">condition</span><span class="p">[</span><span class="s2">&quot;pmod&quot;</span><span class="p">]:</span>
                        <span class="n">beta_sess</span> <span class="o">+=</span> <span class="n">i</span><span class="p">[</span><span class="s2">&quot;poly&quot;</span><span class="p">]</span>

                <span class="k">if</span> <span class="s2">&quot;tmod&quot;</span> <span class="ow">in</span> <span class="n">condition</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">beta_sess</span> <span class="o">+=</span> <span class="n">condition</span><span class="p">[</span><span class="s2">&quot;tmod&quot;</span><span class="p">]</span>

            <span class="n">session_info</span><span class="p">[</span><span class="s2">&quot;cond&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cond</span>

        <span class="c1"># multi</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sess_multi</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">sess_multi</span><span class="p">[</span><span class="n">idx_session</span><span class="p">]:</span>
            <span class="n">session_info</span><span class="p">[</span><span class="s2">&quot;multi&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sess_multi</span><span class="p">[</span><span class="n">idx_session</span><span class="p">]}</span>
            <span class="n">mat</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">loadmat</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sess_multi</span><span class="p">[</span><span class="n">idx_session</span><span class="p">],</span> <span class="n">squeeze_me</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="s2">&quot;names&quot;</span> <span class="ow">in</span> <span class="n">mat</span><span class="p">:</span>
                <span class="n">beta_sess</span> <span class="o">+=</span> <span class="n">mat</span><span class="p">[</span><span class="s2">&quot;names&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">cond_nb</span> <span class="o">+=</span> <span class="n">mat</span><span class="p">[</span><span class="s2">&quot;names&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">if</span> <span class="s2">&quot;pmod&quot;</span> <span class="ow">in</span> <span class="n">mat</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mat</span><span class="p">[</span><span class="s2">&quot;pmod&quot;</span><span class="p">])):</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mat</span><span class="p">[</span><span class="s2">&quot;pmod&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span> <span class="nb">int</span><span class="p">):</span>
                        <span class="n">beta_sess</span> <span class="o">+=</span> <span class="n">mat</span><span class="p">[</span><span class="s2">&quot;pmod&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>

                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mat</span><span class="p">[</span><span class="s2">&quot;pmod&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mat</span><span class="p">[</span><span class="s2">&quot;pmod&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">])):</span>
                            <span class="n">beta_sess</span> <span class="o">+=</span> <span class="n">mat</span><span class="p">[</span><span class="s2">&quot;pmod&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>

            <span class="k">if</span> <span class="s2">&quot;tmod&quot;</span> <span class="ow">in</span> <span class="n">mat</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mat</span><span class="p">[</span><span class="s2">&quot;tmod&quot;</span><span class="p">])):</span>
                    <span class="n">beta_sess</span> <span class="o">+=</span> <span class="n">mat</span><span class="p">[</span><span class="s2">&quot;tmod&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>

        <span class="c1"># Don&#39;t understand what&#39;s the point of multiplier attribute.</span>
        <span class="c1"># Moreover, it does not seem to be used afterwards!</span>
        <span class="c1"># multiplier = 1</span>

        <span class="c1"># if &#39;hrf&#39; in self.bases.keys():</span>
        <span class="c1">#    if &#39;deriv&#39; in self.bases[&#39;hrf&#39;].keys():</span>
        <span class="c1">#        multiplier = sum(self.bases[&#39;hrf&#39;][&#39;deriv&#39;]) + 1</span>

        <span class="c1"># regress</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sess_regress</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;&lt;undefined&gt;&quot;</span><span class="p">,</span> <span class="n">Undefined</span><span class="p">])</span>
            <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">all</span><span class="p">([</span><span class="ow">not</span> <span class="n">elem</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sess_regress</span><span class="p">]))</span>
            <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sess_regress</span><span class="p">[</span><span class="n">idx_session</span><span class="p">])</span>
        <span class="p">):</span>
            <span class="k">for</span> <span class="n">regressor</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sess_regress</span><span class="p">[</span><span class="n">idx_session</span><span class="p">]:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">regressor</span><span class="p">[</span><span class="s2">&quot;val&quot;</span><span class="p">]):</span>
                    <span class="n">val</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>

                <span class="n">regressor</span><span class="p">[</span><span class="s2">&quot;val&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span>
                <span class="n">beta_sess</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="n">session_info</span><span class="p">[</span><span class="s2">&quot;regress&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sess_regress</span><span class="p">[</span><span class="n">idx_session</span><span class="p">]</span>

        <span class="c1"># multi_reg</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sess_multi_reg</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;&lt;undefined&gt;&quot;</span><span class="p">,</span> <span class="n">Undefined</span><span class="p">])</span>
            <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">all</span><span class="p">([</span><span class="ow">not</span> <span class="n">elem</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sess_multi_reg</span><span class="p">]))</span>
            <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sess_multi_reg</span><span class="p">[</span><span class="n">idx_session</span><span class="p">])</span>
        <span class="p">):</span>
            <span class="n">session_info</span><span class="p">[</span><span class="s2">&quot;multi_reg&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">reg_file</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sess_multi_reg</span><span class="p">[</span><span class="n">idx_session</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">reg_file</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;rp_&quot;</span><span class="p">:</span>
                    <span class="n">beta_sess</span> <span class="o">+=</span> <span class="mi">6</span>

                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">reg_file</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;.mat&quot;</span><span class="p">:</span>
                    <span class="n">mat</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">loadmat</span><span class="p">(</span><span class="n">reg_file</span><span class="p">)</span>
                    <span class="n">beta_sess</span> <span class="o">+=</span> <span class="n">mat</span><span class="p">[</span><span class="s2">&quot;R&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

                <span class="n">reg_to_add</span> <span class="o">=</span> <span class="p">[{</span><span class="n">reg_file</span><span class="p">}]</span>
                <span class="n">session_info</span><span class="p">[</span><span class="s2">&quot;multi_reg&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reg_to_add</span><span class="p">)</span>

        <span class="c1"># hpf</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sess_hpf</span><span class="p">[</span><span class="n">idx_session</span><span class="p">]:</span>
            <span class="n">session_info</span><span class="p">[</span><span class="s2">&quot;hpf&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sess_hpf</span><span class="p">[</span><span class="n">idx_session</span><span class="p">]</span>

        <span class="n">beta_sess</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">session_info</span><span class="p">,</span> <span class="n">beta_sess</span><span class="p">,</span> <span class="n">cond_nb</span>

<div class="viewcode-block" id="Level1Design.list_outputs"><a class="viewcode-back" href="../../../../../mia_processes.bricks.stat.spm.html#mia_processes.bricks.stat.spm.model.Level1Design.list_outputs">[docs]</a>    <span class="k">def</span> <span class="nf">list_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_plugged</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the initialisation step of the brick.</span>

<span class="sd">        The main objective of this method is to produce the outputs of the</span>
<span class="sd">        bricks (self.outputs) and the associated tags (self.inheritance_dict),</span>
<span class="sd">        The optional self.inheritance_dict can have two structures. On the one</span>
<span class="sd">        hand it can be a dictionary whose keys are the documents to inherit</span>
<span class="sd">        metadata and the values the documents used for the inheritance of</span>
<span class="sd">        these metadata. On the other hand, it can be a dictionary whose keys</span>
<span class="sd">        are the documents to inherit metadata and the values are dictionary</span>
<span class="sd">        with two keys; parent (for usual inheritance) or own_tags (to add a</span>
<span class="sd">        new tag or modify an existing one). In order not to include an output</span>
<span class="sd">        in the database, the name of the plug related to this output must be</span>
<span class="sd">        an element of the list corresponding to the value of the optional key</span>
<span class="sd">        &quot;notInDb&quot; of the self.outputs dictionary. To work properly this method</span>
<span class="sd">        must return self.make_initResult() object.</span>

<span class="sd">        :param is_plugged: the state, linked or not, of the plugs.</span>
<span class="sd">        :returns: a dictionary with requirement, outputs and inheritance_dict.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Using the inheritance to ProcessMIA class, list_outputs method</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Level1Design</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">list_outputs</span><span class="p">()</span>

        <span class="c1"># Outputs definition and tags inheritance (optional)</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sess_scans</span><span class="p">)</span>
            <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sess_scans</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;&lt;undefined&gt;&quot;</span><span class="p">,</span> <span class="n">Undefined</span><span class="p">])</span>
            <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sess_scans</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;&lt;undefined&gt;&quot;</span><span class="p">,</span> <span class="n">Undefined</span><span class="p">])</span>
        <span class="p">):</span>
            <span class="c1"># The management of self.process.output_directory could be</span>
            <span class="c1"># delegated to the</span>
            <span class="c1"># populse_mia.user_interface.pipeline_manager.process_mia</span>
            <span class="c1"># module. We can&#39;t do it at the moment because the</span>
            <span class="c1"># sync_process_output_traits() of the</span>
            <span class="c1"># capsul/process/nipype_process module raises an exception</span>
            <span class="c1"># in nipype if the mandatory parameter are not yet defined!</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">output_directory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No output_directory was found...!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;spm_mat_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span> <span class="s2">&quot;SPM.mat&quot;</span>
            <span class="p">)</span>

            <span class="n">sessions</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># The total session_info parameter for nipype</span>
            <span class="n">beta</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># The total number of regressors in the GLM design matrix</span>
            <span class="n">cond_totNb</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># The total number of condition in cond and multi</span>

            <span class="c1"># idx_session: session index</span>
            <span class="k">for</span> <span class="n">idx_session</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sess_scans</span><span class="p">)):</span>
                <span class="c1"># session_info: All parameters by session (Scans, Conditions,</span>
                <span class="c1"># Multiple conditions, Regressors, Multiple regressors,</span>
                <span class="c1"># High-pass filter)</span>
                <span class="c1"># beta_sess: Number of regressors by session</span>
                <span class="n">session_info</span><span class="p">,</span> <span class="n">beta_sess</span><span class="p">,</span> <span class="n">cond_nb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_session_info</span><span class="p">(</span>
                    <span class="n">idx_session</span>
                <span class="p">)</span>
                <span class="n">sessions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">session_info</span><span class="p">)</span>
                <span class="n">beta</span> <span class="o">+=</span> <span class="n">beta_sess</span>
                <span class="n">cond_totNb</span> <span class="o">+=</span> <span class="n">cond_nb</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">volterra_expansion_order</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">beta</span> <span class="o">+=</span> <span class="nb">int</span><span class="p">((</span><span class="n">cond_totNb</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">cond_totNb</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>

            <span class="c1"># self.sessions = sessions  # The session_info for nipype</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dict4runtime</span><span class="p">[</span><span class="s2">&quot;sessions&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sessions</span>

            <span class="c1"># Some tests to check that the definition of the parameters for</span>
            <span class="c1"># the self.sessions went well:</span>
            <span class="c1"># - If self.sessions have no key in [&#39;cond&#39;, &#39;multi&#39;, &#39;regress&#39;,</span>
            <span class="c1">#   &#39;multi_reg&#39;], or a condition is False, we can think there is</span>
            <span class="c1">#   an initialisation issue ...</span>
            <span class="n">check</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># Flag to stop the check processes</span>
            <span class="n">init_res</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># Initialisation result; True: Ok, False: Fail</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">sessions</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;cond&quot;</span><span class="p">,</span> <span class="s2">&quot;multi&quot;</span><span class="p">,</span> <span class="s2">&quot;regress&quot;</span><span class="p">,</span> <span class="s2">&quot;multi_reg&quot;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">i</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="n">init_res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cond&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">i</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cond&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                    <span class="n">init_res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

                <span class="k">if</span> <span class="p">(</span><span class="kc">True</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">init_res</span> <span class="ow">or</span> <span class="kc">False</span> <span class="ow">in</span> <span class="n">init_res</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">check</span><span class="p">):</span>
                    <span class="n">check</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">There seems to be a problem in the definition of &quot;</span>
                        <span class="s2">&quot;session parameters. The initialisation failed, &quot;</span>
                        <span class="s2">&quot;please, check your settings  ...&quot;</span>
                    <span class="p">)</span>

            <span class="c1"># - If sess_multi_reg is plugged and sessions have no multi_reg</span>
            <span class="c1">#   key, we can think there is an initialisation issue ...</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sess_multi_reg</span> <span class="o">!=</span> <span class="p">[[]]</span> <span class="ow">and</span> <span class="n">check</span><span class="p">:</span>
                <span class="n">init_res</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="p">[</span>
                    <span class="n">init_res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">sessions</span>
                    <span class="k">if</span> <span class="s2">&quot;multi_reg&quot;</span> <span class="ow">in</span> <span class="n">i</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                <span class="p">]</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">init_res</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">The sess_multi_reg plug is linked to a node. &quot;</span>
                        <span class="s2">&quot;However, no parameters for multi_reg have been &quot;</span>
                        <span class="s2">&quot;defined in the nipype session_info during &quot;</span>
                        <span class="s2">&quot;initialisation. This leads to an initialisation &quot;</span>
                        <span class="s2">&quot;failure. Please, unplug the sess_multi_reg plug if &quot;</span>
                        <span class="s2">&quot;not needed or check your settings ...&quot;</span>
                    <span class="p">)</span>

            <span class="c1"># - If sess_multi is plugged and sessions have no multi key,</span>
            <span class="c1">#   we can think there is an initialisation issue ...</span>

            <span class="c1"># if is_plugged[&#39;sess_multi&#39;] and check:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sess_multi</span> <span class="o">!=</span> <span class="p">[]</span> <span class="ow">and</span> <span class="n">check</span><span class="p">:</span>
                <span class="n">init_res</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="p">[</span>
                    <span class="n">init_res</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">sessions</span>
                    <span class="k">if</span> <span class="s2">&quot;multi&quot;</span> <span class="ow">in</span> <span class="n">i</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                <span class="p">]</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">init_res</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">The sess_multi plug is linked to a node. However, &quot;</span>
                        <span class="s2">&quot;no parameters for sess_multi have been defined in &quot;</span>
                        <span class="s2">&quot;the nipype session_info during initialisation. This &quot;</span>
                        <span class="s2">&quot;leads to an initialisation failure. Please, unplug &quot;</span>
                        <span class="s2">&quot;the sess_multi plug if not needed or check your &quot;</span>
                        <span class="s2">&quot;settings ...&quot;</span>
                    <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inheritance_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;spm_mat_file&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="c1"># FIXME: Currently, spm_mat_file will only inherit the first scan</span>
            <span class="c1">#        if there are several scans in self.sess_scans. This</span>
            <span class="c1">#        requires some thought on how to operate in a more general</span>
            <span class="c1">#        framework</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inheritance_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;spm_mat_file&quot;</span><span class="p">]][</span>
                <span class="s2">&quot;parent&quot;</span>
            <span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sess_scans</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inheritance_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;spm_mat_file&quot;</span><span class="p">]][</span>
                <span class="s2">&quot;own_tags&quot;</span>
            <span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">tag_to_add</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Regress num&quot;</span>
            <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;field_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">FIELD_TYPE_INTEGER</span>
            <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Total number of regressors&quot;</span>
            <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;visibility&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;origin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">TAG_ORIGIN_USER</span>
            <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;unit&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;default_value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">beta</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inheritance_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;spm_mat_file&quot;</span><span class="p">]][</span>
                <span class="s2">&quot;own_tags&quot;</span>
            <span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tag_to_add</span><span class="p">)</span>
            <span class="c1"># FIXME: In the latest version of mia, indexing of the</span>
            <span class="c1">#        database with particular tags defined in the</span>
            <span class="c1">#        processes is done only at the end of the</span>
            <span class="c1">#        initialisation of the whole pipeline. So we</span>
            <span class="c1">#        cannot use the value of these tags in other</span>
            <span class="c1">#        processes of the pipeline at the time of</span>
            <span class="c1">#        initialisation (see populse_mia #290). Unti</span>
            <span class="c1">#        better we use a quick and dirty hack with the</span>
            <span class="c1">#        set_dbFieldValue() function !</span>
            <span class="n">set_dbFieldValue</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;spm_mat_file&quot;</span><span class="p">],</span> <span class="n">tag_to_add</span>
            <span class="p">)</span>
            <span class="n">dyn_num</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">for</span> <span class="n">scan</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sess_scans</span><span class="p">:</span>
                <span class="n">patient_name</span> <span class="o">=</span> <span class="n">get_dbFieldValue</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="n">scan</span><span class="p">,</span> <span class="s2">&quot;PatientName&quot;</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="n">patient_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">tag_to_add</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                    <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;PatientName&quot;</span>
                    <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;field_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">FIELD_TYPE_STRING</span>
                    <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                    <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;visibility&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;origin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">TAG_ORIGIN_USER</span>
                    <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;unit&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;default_value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">patient_name</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">inheritance_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;spm_mat_file&quot;</span><span class="p">]][</span>
                        <span class="s2">&quot;own_tags&quot;</span>
                    <span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tag_to_add</span><span class="p">)</span>
                    <span class="c1"># FIXME: In the latest version of mia, indexing of the</span>
                    <span class="c1">#        database with particular tags defined in the</span>
                    <span class="c1">#        processes is done only at the end of the</span>
                    <span class="c1">#        initialisation of the whole pipeline. So we</span>
                    <span class="c1">#        cannot use the value of these tags in other</span>
                    <span class="c1">#        processes of the pipeline at the time of</span>
                    <span class="c1">#        initialisation (see populse_mia #290). Unti</span>
                    <span class="c1">#        better we use a quick and dirty hack with the</span>
                    <span class="c1">#        set_dbFieldValue() function !</span>
                    <span class="n">set_dbFieldValue</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;spm_mat_file&quot;</span><span class="p">],</span> <span class="n">tag_to_add</span>
                    <span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Level1Design:</span><span class="se">\n</span><span class="s2"> The PatientName tag is not filled &quot;</span>
                        <span class="s2">&quot;in the database for the </span><span class="si">{}</span><span class="s2"> file ...</span><span class="se">\n</span><span class="s2">This may cause &quot;</span>
                        <span class="s2">&quot;issues in the further operation of the &quot;</span>
                        <span class="s2">&quot;pipeline...</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">scan</span><span class="p">)</span>
                    <span class="p">)</span>

                <span class="n">age</span> <span class="o">=</span> <span class="n">get_dbFieldValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="n">scan</span><span class="p">,</span> <span class="s2">&quot;Age&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">age</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">tag_to_add</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                    <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Age&quot;</span>
                    <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;field_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;int&quot;</span>
                    <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                    <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;visibility&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;origin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;user&quot;</span>
                    <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;unit&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;default_value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">age</span>
                    <span class="n">set_dbFieldValue</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;spm_mat_file&quot;</span><span class="p">],</span> <span class="n">tag_to_add</span>
                    <span class="p">)</span>

                <span class="n">pathology</span> <span class="o">=</span> <span class="n">get_dbFieldValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="n">scan</span><span class="p">,</span> <span class="s2">&quot;Pathology&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">pathology</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">tag_to_add</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                    <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Pathology&quot;</span>
                    <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;field_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;string&quot;</span>
                    <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                    <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;visibility&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;origin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;user&quot;</span>
                    <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;unit&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;default_value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pathology</span>
                    <span class="n">set_dbFieldValue</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;spm_mat_file&quot;</span><span class="p">],</span> <span class="n">tag_to_add</span>
                    <span class="p">)</span>

                <span class="n">dimensions</span> <span class="o">=</span> <span class="n">get_dbFieldValue</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span>
                    <span class="n">scan</span><span class="p">,</span>
                    <span class="s2">&quot;Dataset dimensions (Count, X,Y,Z,T...)&quot;</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="p">(</span>
                    <span class="p">(</span><span class="n">dimensions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="ow">and</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">dimensions</span><span class="p">,</span> <span class="nb">list</span><span class="p">))</span>
                    <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dimensions</span><span class="p">)</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span>
                <span class="p">):</span>
                    <span class="n">dyn_num</span> <span class="o">+=</span> <span class="n">dimensions</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
                    <span class="n">tag_to_add</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                    <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Dynamic Number&quot;</span>
                    <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;field_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">FIELD_TYPE_INTEGER</span>
                    <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="s2">&quot;Total number of dynamics in &quot;</span> <span class="s2">&quot;the functionals&quot;</span>
                    <span class="p">)</span>
                    <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;visibility&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;origin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">TAG_ORIGIN_USER</span>
                    <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;unit&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;default_value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dyn_num</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">inheritance_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;spm_mat_file&quot;</span><span class="p">]][</span>
                        <span class="s2">&quot;own_tags&quot;</span>
                    <span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tag_to_add</span><span class="p">)</span>
                    <span class="c1"># FIXME: In the latest version of mia, indexing of the</span>
                    <span class="c1">#        database with particular tags defined in the</span>
                    <span class="c1">#        processes is done only at the end of the</span>
                    <span class="c1">#        initialisation of the whole pipeline. So we</span>
                    <span class="c1">#        cannot use the value of these tags in other</span>
                    <span class="c1">#        processes of the pipeline at the time of</span>
                    <span class="c1">#        initialisation (see populse_mia #290). Unti</span>
                    <span class="c1">#        better we use a quick and dirty hack with the</span>
                    <span class="c1">#        set_dbFieldValue() function !</span>
                    <span class="n">set_dbFieldValue</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;spm_mat_file&quot;</span><span class="p">],</span> <span class="n">tag_to_add</span>
                    <span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Level1Design:</span><span class="se">\n</span><span class="s1">The &quot;dynamics number&quot; tag is not &#39;</span>
                        <span class="s2">&quot;filled in the database for the </span><span class="si">{}</span><span class="s2"> file ...</span><span class="se">\n</span><span class="s2">This &quot;</span>
                        <span class="s2">&quot;may cause issues in the further operation of the &quot;</span>
                        <span class="s2">&quot;pipeline...</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">scan</span><span class="p">)</span>
                    <span class="p">)</span>

            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">interscan_interval</span> <span class="ow">is</span> <span class="n">Undefined</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span>
                <span class="s2">&quot;RepetitionTime&quot;</span>
                <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get_fields_names</span><span class="p">(</span><span class="n">COLLECTION_CURRENT</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="c1"># FIXME: Currently, spm_mat_file will only inherit the first</span>
                <span class="c1">#        scan if there are several scans in self.sess_scans.</span>
                <span class="c1">#        This requires some thought on how to operate in a</span>
                <span class="c1">#        more general framework</span>
                <span class="n">rep_time</span> <span class="o">=</span> <span class="n">get_dbFieldValue</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sess_scans</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;RepetitionTime&quot;</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">rep_time</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">interscan_interval</span> <span class="o">=</span> <span class="n">rep_time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mi">1000</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Level1Design:</span><span class="se">\n</span><span class="s2"> The interscan_interval parameter &quot;</span>
                        <span class="s2">&quot;could not be determined automatically because the &quot;</span>
                        <span class="s1">&#39;&quot;repetition time&quot; tag for the </span><span class="si">{}</span><span class="s1"> file is not filled &#39;</span>
                        <span class="s2">&quot;in the database. Please set this value and launch &quot;</span>
                        <span class="s2">&quot;the calculation again!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sess_scans</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="p">)</span>

            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">interscan_interval</span> <span class="ow">is</span> <span class="n">Undefined</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Level1Design:</span><span class="se">\n</span><span class="s2">The interscan_interval parameter &quot;</span>
                    <span class="s2">&quot;(repetition time in seconds) could not be determined &quot;</span>
                    <span class="s2">&quot;automatically. Please set this value and launch the &quot;</span>
                    <span class="s2">&quot;calculation again!</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="p">)</span>

        <span class="c1"># Return the requirement, outputs and inheritance_dict</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_initResult</span><span class="p">()</span></div>

<div class="viewcode-block" id="Level1Design.run_process_mia"><a class="viewcode-back" href="../../../../../mia_processes.bricks.stat.spm.html#mia_processes.bricks.stat.spm.model.Level1Design.run_process_mia">[docs]</a>    <span class="k">def</span> <span class="nf">run_process_mia</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the process launch step of the brick.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Level1Design</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">run_process_mia</span><span class="p">()</span>
        <span class="c1"># Removing the spm_mat_file to avoid a bug (nipy/nipype Issues #2612)</span>
        <span class="c1"># cur_dir = os.getcwd()</span>
        <span class="c1"># out_file = os.path.join(cur_dir, &#39;SPM.mat&#39;)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">:</span>
            <span class="n">out_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span> <span class="s2">&quot;SPM.mat&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">out_file</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">out_file</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No output_directory was found...!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># if os.path.isfile(out_file):</span>
        <span class="c1">#    os.remove(out_file)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">timing_units</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">timing_units</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">interscan_interval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interscan_interval</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">microtime_resolution</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">microtime_resolution</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">microtime_onset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">microtime_onset</span>
        <span class="c1"># self.process.session_info = self.sessions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">session_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dict4runtime</span><span class="p">[</span><span class="s2">&quot;sessions&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">factor_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">factor_info</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">bases</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bases</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">volterra_expansion_order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">volterra_expansion_order</span>
        <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">global_intensity_normalization</span>
        <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_intensity_normalization</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">mask_threshold</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask_threshold</span>

        <span class="c1"># Only one mask can be defined in spm. If more than one is given, only</span>
        <span class="c1"># the first one will be used for all sessions ...</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask_image</span> <span class="o">!=</span> <span class="n">Undefined</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mask_image</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span>
                <span class="nb">list</span><span class="p">,</span>
                <span class="n">traits</span><span class="o">.</span><span class="n">TraitListObject</span><span class="p">,</span>
                <span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">,</span>
            <span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">mask_image</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mask_image</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">mask_image</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mask_image</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">model_serial_correlations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_serial_correlations</span>

        <span class="c1"># self.process.run()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">configuration_dict</span><span class="o">=</span><span class="p">{})</span></div></div>
</pre></div>

      </div>
      <div class="bottomnav" role="navigation" aria-label="bottom navigation">
      
        <p>
        <a class="uplink" href="../../../../../index.html">Contents</a>
        </p>

      </div>

    <div class="footer" role="contentinfo">
        &#169; Copyright 2019, populse.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 3.2.1.
    </div>
  </body>
</html>