
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>mia_processes.bricks.reports.processes &#8212; mia_processes 2.5.1-dev+3138be70 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/haiku.css" />
    <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
    <script src="../../../../_static/jquery.js"></script>
    <script src="../../../../_static/underscore.js"></script>
    <script src="../../../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
  </head><body>
      <div class="header" role="banner"><h1 class="heading"><a href="../../../../index.html">
          <span>mia_processes 2.5.1-dev+3138be70 documentation</span></a></h1>
        <h2 class="heading"><span>mia_processes.bricks.reports.processes</span></h2>
      </div>
      <div class="topnav" role="navigation" aria-label="top navigation">
      
        <p>
        <a class="uplink" href="../../../../index.html">Contents</a>
        </p>

      </div>
      <div class="content" role="main">
        
        
  <h1>Source code for mia_processes.bricks.reports.processes</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">The report preprocess library of the mia_processes package.</span>

<span class="sd">The purpose of this module is to provide bricks and functions to</span>
<span class="sd">compute necessary values for reporting.</span>

<span class="sd">:Contains:</span>
<span class="sd">    :Class:</span>
<span class="sd">        - AnatIQMs</span>
<span class="sd">        - BoldIQMs</span>
<span class="sd">        - BoldIQMsPlot</span>
<span class="sd">        - CarpetParcellation</span>
<span class="sd">        - ComputeDVARS</span>
<span class="sd">        - FramewiseDisplacement</span>
<span class="sd">        - PlotSignalROI</span>
<span class="sd">        - Mean_stdDev_calc</span>
<span class="sd">        - Result_collector</span>
<span class="sd">        - Spikes</span>

<span class="sd">    :Function:</span>
<span class="sd">        - art_qi1</span>
<span class="sd">        - art_qi2</span>
<span class="sd">        - cjv</span>
<span class="sd">        - cnr</span>
<span class="sd">        - efc</span>
<span class="sd">        - fber</span>
<span class="sd">        - fuzzy_jaccard</span>
<span class="sd">        - find_peaks</span>
<span class="sd">        - find_spikes</span>
<span class="sd">        - gsr</span>
<span class="sd">        - image_binary_dilation</span>
<span class="sd">        - normalize_mc_params</span>
<span class="sd">        - regress_poly</span>
<span class="sd">        - rpve</span>
<span class="sd">        - snr</span>
<span class="sd">        - snr_dietrich</span>
<span class="sd">        - summary_stats</span>
<span class="sd">        - volume_fraction</span>
<span class="sd">        - wm2max</span>
<span class="sd">        - _AR_est_YW</span>
<span class="sd">        - _flatten_dict</span>
<span class="sd">        - _prepare_mask</span>
<span class="sd">        - _robust_zscore</span>

<span class="sd">.. topic:: References</span>

<span class="sd">  .. [Atkinson1997] Atkinson et al., *Automatic correction of motion artifacts</span>
<span class="sd">    in magnetic resonance images using an entropy</span>
<span class="sd">    focus criterion*, IEEE Trans Med Imag 16(6):903-910, 1997.</span>
<span class="sd">    doi:`10.1109/42.650886 &lt;https://doi.org/10.1109/42.650886&gt;`_.</span>

<span class="sd">  .. [Dietrich2007] Dietrich et al., *Measurement of SNRs in MR images:</span>
<span class="sd">    influence of multichannel coils, parallel imaging and reconstruction</span>
<span class="sd">    filters*, JMRI 26(2):375--385. 2007.</span>
<span class="sd">    doi:`10.1002/jmri.20969 &lt;https://doi.org/10.1002/jmri.20969&gt;`_.</span>

<span class="sd">  .. [Ganzetti2016] Ganzetti et al., *Intensity inhomogeneity correction of</span>
<span class="sd">    structural MR images: a data-driven approach to define input algorithm</span>
<span class="sd">    parameters*. Front Neuroinform 10:10. 2016.</span>
<span class="sd">    doi:`10.3389/fninf.2016.00010 &lt;https://doi.org/10.3389/fninf.2016.00010&gt;`_.</span>

<span class="sd">  .. [Giannelli2010] Giannelli et al., *Characterization of Nyquist ghost in</span>
<span class="sd">    EPI-fMRI acquisition sequences implemented on two clinical 1.5 T MR scanner</span>
<span class="sd">    systems: effect of readout bandwidth and echo spacing*. J App Clin Med Phy,</span>
<span class="sd">    11(4). 2010.</span>
<span class="sd">    doi:`10.1120/jacmp.v11i4.3237 &lt;https://doi.org/10.1120/jacmp.v11i4.3237&gt;`_.</span>

<span class="sd">  .. [Magnota2006] Magnotta, VA., &amp; Friedman, L., *Measurement of</span>
<span class="sd">    signal-to-noise and contrast-to-noise in the fBIRN multicenter imaging</span>
<span class="sd">    study*. J Dig Imag 19(2):140-147, 2006.</span>
<span class="sd">    doi:`10.1007/s10278-006-0264-x</span>
<span class="sd">    &lt;https://doi.org/10.1007/s10278-006-0264-x&gt;`_.</span>

<span class="sd">  .. [Shehzad2015] Shehzad Z et al., *The Preprocessed Connectomes Project</span>
<span class="sd">     Quality Assessment Protocol - a resource for measuring the quality of MRI</span>
<span class="sd">     data*, Front. Neurosci. Conference Abstract: Neuroinformatics 2015.</span>
<span class="sd">     doi:`10.3389/conf.fnins.2015.91.00047</span>
<span class="sd">     &lt;https://doi.org/10.3389/conf.fnins.2015.91.00047&gt;`_.</span>


<span class="sd">&quot;&quot;&quot;</span>

<span class="c1">##########################################################################</span>
<span class="c1"># mia_processes - Copyright (C) IRMaGe/CEA, 2018</span>
<span class="c1"># Distributed under the terms of the CeCILL license, as published by</span>
<span class="c1"># the CEA-CNRS-INRIA. Refer to the LICENSE file or to</span>
<span class="c1"># http://www.cecill.info/licences/Licence_CeCILL_V2.1-en.html</span>
<span class="c1"># for details.</span>
<span class="c1">##########################################################################</span>

<span class="c1"># Other import</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">sqrt</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">nibabel</span> <span class="k">as</span> <span class="nn">nib</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">scipy.ndimage</span> <span class="k">as</span> <span class="nn">nd</span>
<span class="kn">from</span> <span class="nn">nilearn</span> <span class="kn">import</span> <span class="n">plotting</span>
<span class="kn">from</span> <span class="nn">nilearn.image</span> <span class="kn">import</span> <span class="n">resample_to_img</span>
<span class="kn">from</span> <span class="nn">nilearn.signal</span> <span class="kn">import</span> <span class="n">clean</span>
<span class="kn">from</span> <span class="nn">nipy.algorithms.registration</span> <span class="kn">import</span> <span class="n">aff2euler</span><span class="p">,</span> <span class="n">to_matrix44</span>

<span class="c1"># nipype import</span>
<span class="kn">from</span> <span class="nn">nipype.interfaces.base</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">File</span><span class="p">,</span>
    <span class="n">InputMultiPath</span><span class="p">,</span>
    <span class="n">OutputMultiPath</span><span class="p">,</span>
    <span class="n">TraitListObject</span><span class="p">,</span>
    <span class="n">Undefined</span><span class="p">,</span>
    <span class="n">traits</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">nipype.interfaces.spm.base</span> <span class="kn">import</span> <span class="n">ImageFileSPM</span>
<span class="kn">from</span> <span class="nn">nitime.algorithms</span> <span class="kn">import</span> <span class="n">AR_est_YW</span>
<span class="kn">from</span> <span class="nn">niworkflows.utils.timeseries</span> <span class="kn">import</span> <span class="n">_nifti_timeseries</span>
<span class="kn">from</span> <span class="nn">niworkflows.viz.plots</span> <span class="kn">import</span> <span class="n">fMRIPlot</span>
<span class="kn">from</span> <span class="nn">numpy.polynomial</span> <span class="kn">import</span> <span class="n">Legendre</span>

<span class="c1"># populse_mia import</span>
<span class="kn">from</span> <span class="nn">populse_mia.user_interface.pipeline_manager.process_mia</span> <span class="kn">import</span> <span class="n">ProcessMIA</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">kurtosis</span>  <span class="c1"># pylint: disable=E0611</span>

<span class="c1"># mia_processes import</span>
<span class="kn">from</span> <span class="nn">mia_processes.utils</span> <span class="kn">import</span> <span class="n">checkFileExt</span><span class="p">,</span> <span class="n">get_dbFieldValue</span>

<span class="n">DIETRICH_FACTOR</span> <span class="o">=</span> <span class="mf">0.6551364</span>  <span class="c1"># 1.0 / sqrt(2 / (4 - pi))</span>
<span class="n">FSL_FAST_LABELS</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;csf&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;gm&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;wm&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;bg&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
<span class="n">RAS_AXIS_ORDER</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">}</span>
<span class="n">EXT</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;NIFTI_GZ&quot;</span><span class="p">:</span> <span class="s2">&quot;nii.gz&quot;</span><span class="p">,</span> <span class="s2">&quot;NIFTI&quot;</span><span class="p">:</span> <span class="s2">&quot;nii&quot;</span><span class="p">}</span>


<div class="viewcode-block" id="AnatIQMs"><a class="viewcode-back" href="../../../../mia_processes.bricks.reports.html#mia_processes.bricks.reports.processes.AnatIQMs">[docs]</a><span class="k">class</span> <span class="nc">AnatIQMs</span><span class="p">(</span><span class="n">ProcessMIA</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    *Computes the anatomical IQMs*</span>

<span class="sd">    Please, see the complete documentation for the `AnatIQMs brick</span>
<span class="sd">    in the mia_processes website</span>
<span class="sd">    &lt;https://populse.github.io/mia_processes/html/documentation/bricks/reports/AnatIQMs.html&gt;`_</span>

<span class="sd">    adapted from `mriqc</span>
<span class="sd">    &lt;https://github.com/nipreps/mriqc/blob/e021008da0a2ef1c48e882baf932139a673349f9/mriqc/workflows/anatomical.py#L332&gt;`__</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="AnatIQMs.__init__"><a class="viewcode-back" href="../../../../mia_processes.bricks.reports.html#mia_processes.bricks.reports.processes.AnatIQMs.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Dedicated to the attributes initialisation / instantiation.</span>

<span class="sd">        The input and output plugs are defined here. The special</span>
<span class="sd">        &#39;self.requirement&#39; attribute (optional) is used to define the</span>
<span class="sd">        third-party products necessary for the running of the brick.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Initialisation of the objects needed for the launch of the brick</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">AnatIQMs</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1"># Third party softwares required for the execution of the brick</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requirement</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Inputs description</span>
        <span class="n">in_ras_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;RAS input image (a pathlike object or string &quot;</span>
            <span class="s2">&quot;representing a file).&quot;</span>
        <span class="p">)</span>
        <span class="n">airmask_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Air mask image (a pathlike object or string &quot;</span>
            <span class="s2">&quot;representing a file).&quot;</span>
        <span class="p">)</span>
        <span class="n">artmask_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Artifact mask image (a pathlike object or string &quot;</span>
            <span class="s2">&quot;representing a file).&quot;</span>
        <span class="p">)</span>
        <span class="n">headmask_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Head mask image (a pathlike object or string &quot;</span>
            <span class="s2">&quot;representing a file).&quot;</span>
        <span class="p">)</span>
        <span class="n">rotmask_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Rotation mask image (a pathlike object or string &quot;</span>
            <span class="s2">&quot;representing a file).&quot;</span>
        <span class="p">)</span>
        <span class="n">hatmask_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Hat mask image (a pathlike object or string &quot;</span>
            <span class="s2">&quot;representing a file).&quot;</span>
        <span class="p">)</span>
        <span class="n">segmentation_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Segmentation mask image (a pathlike object or &quot;</span>
            <span class="s2">&quot;string representing a file).&quot;</span>
        <span class="p">)</span>
        <span class="n">in_inu_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Input INU image (a pathlike object or string &quot;</span>
            <span class="s2">&quot;representing a file).&quot;</span>
        <span class="p">)</span>
        <span class="n">in_noinu_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Input no-INU image (a pathlike object or string &quot;</span>
            <span class="s2">&quot;representing a file).&quot;</span>
        <span class="p">)</span>
        <span class="n">pvms_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;PVMS image (a pathlike object or string representing a file).&quot;</span>
        <span class="p">)</span>
        <span class="n">mni_tpms_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;MNI TPMS file (a pathlike &quot;</span>
            <span class="s2">&quot;object or string representing a file).&quot;</span>
        <span class="p">)</span>
        <span class="n">in_fwhm_desc</span> <span class="o">=</span> <span class="s2">&quot;FWHM (a float).&quot;</span>

        <span class="c1"># Outputs description</span>
        <span class="n">out_file_desc</span> <span class="o">=</span> <span class="s2">&quot;a json file containing IQMs&quot;</span>

        <span class="c1"># Inputs traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;in_ras&quot;</span><span class="p">,</span> <span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">in_ras_desc</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;airmask&quot;</span><span class="p">,</span> <span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">airmask_desc</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;artmask&quot;</span><span class="p">,</span> <span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">artmask_desc</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;headmask&quot;</span><span class="p">,</span> <span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">headmask_desc</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;rotmask&quot;</span><span class="p">,</span> <span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">rotmask_desc</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;hatmask&quot;</span><span class="p">,</span> <span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">hatmask_desc</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;segmentation&quot;</span><span class="p">,</span>
            <span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">segmentation_desc</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;in_inu&quot;</span><span class="p">,</span> <span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">in_inu_desc</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;in_noinu&quot;</span><span class="p">,</span> <span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">in_noinu_desc</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;pvms&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">File</span><span class="p">(),</span> <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">pvms_desc</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;mni_tpms&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">(</span>
                <span class="n">File</span><span class="p">(),</span> <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">mni_tpms_desc</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;in_fwhm&quot;</span><span class="p">,</span> <span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">in_fwhm_desc</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Outputs traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;out_file&quot;</span><span class="p">,</span> <span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">out_file_desc</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">init_default_traits</span><span class="p">()</span></div>

<div class="viewcode-block" id="AnatIQMs.list_outputs"><a class="viewcode-back" href="../../../../mia_processes.bricks.reports.html#mia_processes.bricks.reports.processes.AnatIQMs.list_outputs">[docs]</a>    <span class="k">def</span> <span class="nf">list_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_plugged</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Dedicated to the initialisation step of the brick.</span>

<span class="sd">        The main objective of this method is to produce the outputs of the</span>
<span class="sd">        bricks (self.outputs) and the associated tags (self.inheritance_dic),</span>
<span class="sd">        if defined here. To work properly this method must return</span>
<span class="sd">        self.make_initResult() object.</span>

<span class="sd">        :param is_plugged: the state, linked or not, of the plugs.</span>
<span class="sd">        :returns: a dictionary with requirement, outputs and inheritance_dict.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Using the inheritance to ProcessMIA class, list_outputs method</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">AnatIQMs</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">list_outputs</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_ras</span><span class="p">:</span>
            <span class="n">valid_ext</span><span class="p">,</span> <span class="n">in_ext</span><span class="p">,</span> <span class="n">fileName</span> <span class="o">=</span> <span class="n">checkFileExt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_ras</span><span class="p">,</span> <span class="n">EXT</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_ext</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">The input image format is not recognized ...!&quot;</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="n">report_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span> <span class="p">(</span><span class="n">fileName</span> <span class="o">+</span> <span class="s2">&quot;_anat_qc.json&quot;</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">fileName</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;out_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">report_file</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s2">&quot;- There was no output file deducted during &quot;</span>
                    <span class="s2">&quot;initialisation. Please check the input parameters...!&quot;</span>
                <span class="p">)</span>

            <span class="c1"># tags inheritance (optional)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tags_inheritance</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">in_ras</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;out_file&quot;</span><span class="p">],</span>
                <span class="p">)</span>

        <span class="c1"># Return the requirement, outputs and inheritance_dict</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_initResult</span><span class="p">()</span></div>

<div class="viewcode-block" id="AnatIQMs.run_process_mia"><a class="viewcode-back" href="../../../../mia_processes.bricks.reports.html#mia_processes.bricks.reports.processes.AnatIQMs.run_process_mia">[docs]</a>    <span class="k">def</span> <span class="nf">run_process_mia</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Dedicated to the process launch step of the brick.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">AnatIQMs</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">run_process_mia</span><span class="p">()</span>

        <span class="n">results_dict</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">imdata</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_ras</span><span class="p">)</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">()</span>

        <span class="c1"># Try to load files</span>
        <span class="n">has_in_noinu</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_noinu</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">imnii</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_noinu</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span>
                <span class="n">nib</span><span class="o">.</span><span class="n">filebasedimages</span><span class="o">.</span><span class="n">ImageFileError</span><span class="p">,</span>
                <span class="ne">FileNotFoundError</span><span class="p">,</span>
                <span class="ne">TypeError</span><span class="p">,</span>
            <span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">has_in_noinu</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Error with in_noinu file: &quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Load image corrected for INU</span>
                <span class="n">inudata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">imnii</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">())</span>
                <span class="n">inudata</span><span class="p">[</span><span class="n">inudata</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">has_in_noinu</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">has_segmentation</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">segmentation</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Load binary segmentation from FSL FAST</span>
                <span class="n">segnii</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">segmentation</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span>
                <span class="n">nib</span><span class="o">.</span><span class="n">filebasedimages</span><span class="o">.</span><span class="n">ImageFileError</span><span class="p">,</span>
                <span class="ne">FileNotFoundError</span><span class="p">,</span>
                <span class="ne">TypeError</span><span class="p">,</span>
            <span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">has_segmentation</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Error with segmentation file: &quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">segdata</span> <span class="o">=</span> <span class="n">segnii</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">has_segmentation</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">has_airmask</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">airmask</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Load binary segmentation from FSL FAST</span>
                <span class="n">airnii</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">airmask</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span>
                <span class="n">nib</span><span class="o">.</span><span class="n">filebasedimages</span><span class="o">.</span><span class="n">ImageFileError</span><span class="p">,</span>
                <span class="ne">FileNotFoundError</span><span class="p">,</span>
                <span class="ne">TypeError</span><span class="p">,</span>
            <span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">has_airmask</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Error with airmask file: &quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">airdata</span> <span class="o">=</span> <span class="n">airnii</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">has_airmask</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">has_artmask</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">artmask</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Load binary segmentation from FSL FAST</span>
                <span class="n">artnii</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">artmask</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span>
                <span class="n">nib</span><span class="o">.</span><span class="n">filebasedimages</span><span class="o">.</span><span class="n">ImageFileError</span><span class="p">,</span>
                <span class="ne">FileNotFoundError</span><span class="p">,</span>
                <span class="ne">TypeError</span><span class="p">,</span>
            <span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">has_artmask</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Error with artmask file: &quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">artdata</span> <span class="o">=</span> <span class="n">artnii</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">has_artmask</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">has_headmask</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">headmask</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Load binary segmentation from FSL FAST</span>
                <span class="n">headnii</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">headmask</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span>
                <span class="n">nib</span><span class="o">.</span><span class="n">filebasedimages</span><span class="o">.</span><span class="n">ImageFileError</span><span class="p">,</span>
                <span class="ne">FileNotFoundError</span><span class="p">,</span>
                <span class="ne">TypeError</span><span class="p">,</span>
            <span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">has_headmask</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Error with headmask file: &quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">headdata</span> <span class="o">=</span> <span class="n">headnii</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">has_headmask</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">has_rotmask</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rotmask</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Load binary segmentation from FSL FAST</span>
                <span class="n">rotnii</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rotmask</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span>
                <span class="n">nib</span><span class="o">.</span><span class="n">filebasedimages</span><span class="o">.</span><span class="n">ImageFileError</span><span class="p">,</span>
                <span class="ne">FileNotFoundError</span><span class="p">,</span>
                <span class="ne">TypeError</span><span class="p">,</span>
            <span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">has_rotmask</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Error with rotmask file: &quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">rotdata</span> <span class="o">=</span> <span class="n">rotnii</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">has_rotmask</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">has_pvms</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rotmask</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Load Partial Volume Maps (pvms) from FSL FAST</span>
                <span class="n">pvmniis</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pvms</span><span class="p">:</span>
                    <span class="n">pvmniis</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fname</span><span class="p">))</span>
            <span class="k">except</span> <span class="p">(</span>
                <span class="n">nib</span><span class="o">.</span><span class="n">filebasedimages</span><span class="o">.</span><span class="n">ImageFileError</span><span class="p">,</span>
                <span class="ne">FileNotFoundError</span><span class="p">,</span>
                <span class="ne">TypeError</span><span class="p">,</span>
            <span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">has_pvms</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Error with pvms files: &quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Load Partial Volume Maps (pvms) from FSL FAST</span>
                <span class="n">pvmdata</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">pvmnii</span> <span class="ow">in</span> <span class="n">pvmniis</span><span class="p">:</span>
                    <span class="n">pvmdata</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pvmnii</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float32&quot;</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">pvmdata</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">1e-4</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                            <span class="s2">&quot;Detected less than 10 voxels &quot;</span>
                            <span class="s2">&quot;belonging to one tissue prob. &quot;</span>
                            <span class="s2">&quot;map. MRIQC failed to process this &quot;</span>
                            <span class="s2">&quot;dataset.&quot;</span>
                        <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">has_pvms</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">has_mni_tpms</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mni_tpms</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">mni_tpmsniis</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mni_tpms</span><span class="p">:</span>
                    <span class="n">mni_tpmsniis</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fname</span><span class="p">))</span>
            <span class="k">except</span> <span class="p">(</span>
                <span class="n">nib</span><span class="o">.</span><span class="n">filebasedimages</span><span class="o">.</span><span class="n">ImageFileError</span><span class="p">,</span>
                <span class="ne">FileNotFoundError</span><span class="p">,</span>
                <span class="ne">TypeError</span><span class="p">,</span>
            <span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">has_mni_tpms</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Error with mni_tpms files: &quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
                <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">has_mni_tpms</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">has_stats</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">has_in_noinu</span> <span class="ow">and</span> <span class="n">has_pvms</span> <span class="ow">and</span> <span class="n">has_airmask</span><span class="p">:</span>
            <span class="n">erode</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">imnii</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">get_zooms</span><span class="p">()[:</span><span class="mi">3</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1.9</span>
            <span class="p">)</span>

            <span class="c1"># Summary stats</span>
            <span class="n">stats</span> <span class="o">=</span> <span class="n">summary_stats</span><span class="p">(</span><span class="n">inudata</span><span class="p">,</span> <span class="n">pvmdata</span><span class="p">,</span> <span class="n">airdata</span><span class="p">,</span> <span class="n">erode</span><span class="o">=</span><span class="n">erode</span><span class="p">)</span>
            <span class="n">has_stats</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">results_dict</span><span class="p">[</span><span class="s2">&quot;summary&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stats</span>

            <span class="c1"># SNR</span>
            <span class="n">snrvals</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">results_dict</span><span class="p">[</span><span class="s2">&quot;snr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">tlabel</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;csf&quot;</span><span class="p">,</span> <span class="s2">&quot;wm&quot;</span><span class="p">,</span> <span class="s2">&quot;gm&quot;</span><span class="p">]:</span>
                <span class="n">snrvals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">snr</span><span class="p">(</span>
                        <span class="n">stats</span><span class="p">[</span><span class="n">tlabel</span><span class="p">][</span><span class="s2">&quot;median&quot;</span><span class="p">],</span>
                        <span class="n">stats</span><span class="p">[</span><span class="n">tlabel</span><span class="p">][</span><span class="s2">&quot;stdv&quot;</span><span class="p">],</span>
                        <span class="nb">int</span><span class="p">(</span><span class="n">stats</span><span class="p">[</span><span class="n">tlabel</span><span class="p">][</span><span class="s2">&quot;n&quot;</span><span class="p">]),</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="n">results_dict</span><span class="p">[</span><span class="s2">&quot;snr&quot;</span><span class="p">][</span><span class="n">tlabel</span><span class="p">]</span> <span class="o">=</span> <span class="n">snrvals</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">results_dict</span><span class="p">[</span><span class="s2">&quot;snr&quot;</span><span class="p">][</span><span class="s2">&quot;total&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">snrvals</span><span class="p">))</span>

            <span class="n">snrvals</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">results_dict</span><span class="p">[</span><span class="s2">&quot;snrd&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">tlabel</span><span class="p">:</span> <span class="n">snr_dietrich</span><span class="p">(</span>
                    <span class="n">stats</span><span class="p">[</span><span class="n">tlabel</span><span class="p">][</span><span class="s2">&quot;median&quot;</span><span class="p">],</span>
                    <span class="n">mad_air</span><span class="o">=</span><span class="n">stats</span><span class="p">[</span><span class="s2">&quot;bg&quot;</span><span class="p">][</span><span class="s2">&quot;mad&quot;</span><span class="p">],</span>
                    <span class="n">sigma_air</span><span class="o">=</span><span class="n">stats</span><span class="p">[</span><span class="s2">&quot;bg&quot;</span><span class="p">][</span><span class="s2">&quot;stdv&quot;</span><span class="p">],</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">tlabel</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;csf&quot;</span><span class="p">,</span> <span class="s2">&quot;wm&quot;</span><span class="p">,</span> <span class="s2">&quot;gm&quot;</span><span class="p">]</span>
            <span class="p">}</span>
            <span class="n">results_dict</span><span class="p">[</span><span class="s2">&quot;snrd&quot;</span><span class="p">][</span><span class="s2">&quot;total&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">val</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">results_dict</span><span class="p">[</span><span class="s2">&quot;snrd&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">())])</span>
            <span class="p">)</span>

            <span class="c1"># CNR</span>
            <span class="n">results_dict</span><span class="p">[</span><span class="s2">&quot;cnr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cnr</span><span class="p">(</span>
                <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;wm&quot;</span><span class="p">][</span><span class="s2">&quot;median&quot;</span><span class="p">],</span>
                <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;gm&quot;</span><span class="p">][</span><span class="s2">&quot;median&quot;</span><span class="p">],</span>
                <span class="n">sqrt</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">stats</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;stdv&quot;</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;bg&quot;</span><span class="p">,</span> <span class="s2">&quot;gm&quot;</span><span class="p">,</span> <span class="s2">&quot;wm&quot;</span><span class="p">])),</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">has_in_noinu</span> <span class="ow">and</span> <span class="n">has_headmask</span> <span class="ow">and</span> <span class="n">has_rotmask</span><span class="p">:</span>
            <span class="c1"># FBER</span>
            <span class="n">results_dict</span><span class="p">[</span><span class="s2">&quot;fber&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fber</span><span class="p">(</span><span class="n">inudata</span><span class="p">,</span> <span class="n">headdata</span><span class="p">,</span> <span class="n">rotdata</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">has_in_noinu</span> <span class="ow">and</span> <span class="n">has_rotmask</span><span class="p">:</span>
            <span class="c1"># EFC</span>
            <span class="n">results_dict</span><span class="p">[</span><span class="s2">&quot;efc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">efc</span><span class="p">(</span><span class="n">inudata</span><span class="p">,</span> <span class="n">rotdata</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">has_stats</span> <span class="ow">and</span> <span class="n">has_in_noinu</span><span class="p">:</span>
            <span class="c1"># M2WM</span>
            <span class="n">results_dict</span><span class="p">[</span><span class="s2">&quot;wm2max&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">wm2max</span><span class="p">(</span><span class="n">inudata</span><span class="p">,</span> <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;wm&quot;</span><span class="p">][</span><span class="s2">&quot;median&quot;</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">has_airmask</span> <span class="ow">and</span> <span class="n">has_artmask</span><span class="p">:</span>
            <span class="c1"># Artifacts</span>
            <span class="n">results_dict</span><span class="p">[</span><span class="s2">&quot;qi_1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">art_qi1</span><span class="p">(</span><span class="n">airdata</span><span class="p">,</span> <span class="n">artdata</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hatmask</span> <span class="o">!=</span> <span class="n">Undefined</span><span class="p">:</span>
            <span class="c1"># Artifacts QI2</span>
            <span class="n">results_dict</span><span class="p">[</span><span class="s2">&quot;qi_2&quot;</span><span class="p">],</span> <span class="n">results_dict</span><span class="p">[</span><span class="s2">&quot;histogram_qi2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">art_qi2</span><span class="p">(</span>
                <span class="n">imdata</span><span class="p">,</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hatmask</span><span class="p">)</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">()</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">has_stats</span><span class="p">:</span>
            <span class="c1"># CJV</span>
            <span class="n">results_dict</span><span class="p">[</span><span class="s2">&quot;cjv&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cjv</span><span class="p">(</span>
                <span class="c1"># mu_wm, mu_gm, sigma_wm, sigma_gm</span>
                <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;wm&quot;</span><span class="p">][</span><span class="s2">&quot;median&quot;</span><span class="p">],</span>
                <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;gm&quot;</span><span class="p">][</span><span class="s2">&quot;median&quot;</span><span class="p">],</span>
                <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;wm&quot;</span><span class="p">][</span><span class="s2">&quot;mad&quot;</span><span class="p">],</span>
                <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;gm&quot;</span><span class="p">][</span><span class="s2">&quot;mad&quot;</span><span class="p">],</span>
            <span class="p">)</span>

        <span class="c1"># FWHM</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_fwhm</span> <span class="ow">and</span> <span class="n">has_in_noinu</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_fwhm</span><span class="p">)</span>
                <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
                <span class="n">str_fwhm</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[-+]?\d*\.*\d+&quot;</span><span class="p">,</span> <span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">fwhm</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">str_fwhm</span><span class="p">:</span>
                    <span class="n">fwhm</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">item</span><span class="p">))</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">FileNotFoundError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Error with fwhm file: &quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fwhm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fwhm</span><span class="p">[:</span><span class="mi">3</span><span class="p">])</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                    <span class="n">imnii</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">get_zooms</span><span class="p">()[:</span><span class="mi">3</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="n">results_dict</span><span class="p">[</span><span class="s2">&quot;fwhm&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">fwhm</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                    <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">fwhm</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                    <span class="s2">&quot;z&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">fwhm</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
                    <span class="s2">&quot;avg&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">fwhm</span><span class="p">)),</span>
                <span class="p">}</span>

        <span class="k">if</span> <span class="n">has_pvms</span><span class="p">:</span>
            <span class="c1"># ICVs</span>
            <span class="n">results_dict</span><span class="p">[</span><span class="s2">&quot;icvs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">volume_fraction</span><span class="p">(</span><span class="n">pvmdata</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">has_pvms</span> <span class="ow">and</span> <span class="n">has_segmentation</span><span class="p">:</span>
            <span class="c1"># RPVE</span>
            <span class="n">results_dict</span><span class="p">[</span><span class="s2">&quot;rpve&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rpve</span><span class="p">(</span><span class="n">pvmdata</span><span class="p">,</span> <span class="n">segdata</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">has_in_noinu</span><span class="p">:</span>
            <span class="c1"># Image specs</span>
            <span class="n">results_dict</span><span class="p">[</span><span class="s2">&quot;size&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">inudata</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">inudata</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                <span class="s2">&quot;z&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">inudata</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
            <span class="p">}</span>
            <span class="n">results_dict</span><span class="p">[</span><span class="s2">&quot;spacing&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">i</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">],</span> <span class="n">imnii</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">get_zooms</span><span class="p">()[:</span><span class="mi">3</span><span class="p">])</span>
            <span class="p">}</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">results_dict</span><span class="p">[</span><span class="s2">&quot;size&quot;</span><span class="p">][</span><span class="s2">&quot;t&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">inudata</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="k">pass</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">results_dict</span><span class="p">[</span><span class="s2">&quot;spacing&quot;</span><span class="p">][</span><span class="s2">&quot;tr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span>
                    <span class="n">imnii</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">get_zooms</span><span class="p">()[</span><span class="mi">3</span><span class="p">]</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="k">if</span> <span class="n">has_segmentation</span><span class="p">:</span>
            <span class="c1"># Bias</span>
            <span class="n">bias</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_inu</span><span class="p">)</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">()[</span><span class="n">segdata</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">results_dict</span><span class="p">[</span><span class="s2">&quot;inu&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;range&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">bias</span><span class="p">,</span> <span class="mf">95.0</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">bias</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="p">),</span>
                <span class="s2">&quot;med&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">bias</span><span class="p">)),</span>
            <span class="p">}</span>  <span class="c1"># pylint: disable=E1101</span>

        <span class="k">if</span> <span class="n">has_mni_tpms</span> <span class="ow">and</span> <span class="n">has_pvms</span><span class="p">:</span>
            <span class="n">mni_tpms</span> <span class="o">=</span> <span class="p">[</span><span class="n">tpm</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">()</span> <span class="k">for</span> <span class="n">tpm</span> <span class="ow">in</span> <span class="n">mni_tpmsniis</span><span class="p">]</span>
            <span class="n">in_tpms</span> <span class="o">=</span> <span class="p">[</span><span class="n">pvm</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">()</span> <span class="k">for</span> <span class="n">pvm</span> <span class="ow">in</span> <span class="n">pvmniis</span><span class="p">]</span>
            <span class="n">overlap</span> <span class="o">=</span> <span class="n">fuzzy_jaccard</span><span class="p">(</span><span class="n">in_tpms</span><span class="p">,</span> <span class="n">mni_tpms</span><span class="p">)</span>
            <span class="n">results_dict</span><span class="p">[</span><span class="s2">&quot;tpm_overlap&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;csf&quot;</span><span class="p">:</span> <span class="n">overlap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="s2">&quot;gm&quot;</span><span class="p">:</span> <span class="n">overlap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="s2">&quot;wm&quot;</span><span class="p">:</span> <span class="n">overlap</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
            <span class="p">}</span>

        <span class="c1"># Flatten the dictionary</span>
        <span class="n">flat_results_dict</span> <span class="o">=</span> <span class="n">_flatten_dict</span><span class="p">(</span><span class="n">results_dict</span><span class="p">)</span>

        <span class="c1"># Save results as json</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_ras</span><span class="p">)</span>
        <span class="n">file_name_no_ext</span><span class="p">,</span> <span class="n">file_extension</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">file_extension</span> <span class="o">==</span> <span class="s2">&quot;.gz&quot;</span><span class="p">:</span>
            <span class="p">(</span><span class="n">file_name_no_ext_2</span><span class="p">,</span> <span class="n">file_extension_2</span><span class="p">)</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span>
                <span class="n">file_name_no_ext</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">file_extension_2</span> <span class="o">==</span> <span class="s2">&quot;.nii&quot;</span><span class="p">:</span>
                <span class="n">file_name_no_ext</span> <span class="o">=</span> <span class="n">file_name_no_ext_2</span>

        <span class="n">report_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span> <span class="p">(</span><span class="n">file_name_no_ext</span> <span class="o">+</span> <span class="s2">&quot;_anat_qc.json&quot;</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">report_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">flat_results_dict</span><span class="p">,</span> <span class="n">fp</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="BoldIQMs"><a class="viewcode-back" href="../../../../mia_processes.bricks.reports.html#mia_processes.bricks.reports.processes.BoldIQMs">[docs]</a><span class="k">class</span> <span class="nc">BoldIQMs</span><span class="p">(</span><span class="n">ProcessMIA</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    *Computes the functional IQMs*</span>

<span class="sd">    Please, see the complete documentation for the `BoldIQMs brick</span>
<span class="sd">    in the mia_processes website</span>
<span class="sd">    &lt;https://populse.github.io/mia_processes/html/documentation/bricks/reports/BoldIQMs.html&gt;`_</span>

<span class="sd">    adapted from `mriqc</span>
<span class="sd">    &lt;https://github.com/nipreps/mriqc/blob/e021008da0a2ef1c48e882baf932139a673349f9/mriqc/workflows/functional.py#L243&gt;`__</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="BoldIQMs.__init__"><a class="viewcode-back" href="../../../../mia_processes.bricks.reports.html#mia_processes.bricks.reports.processes.BoldIQMs.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Dedicated to the attributes initialisation / instantiation.</span>

<span class="sd">        The input and output plugs are defined here. The special</span>
<span class="sd">        &#39;self.requirement&#39; attribute (optional) is used to define the</span>
<span class="sd">        third-party products necessary for the running of the brick.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Initialisation of the objects needed for the launch of the brick</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">BoldIQMs</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1"># Third party softwares required for the execution of the brick</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requirement</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Inputs description</span>
        <span class="n">in_epi_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;EPI input image (a pathlike object or string &quot;</span>
            <span class="s2">&quot;representing a file).&quot;</span>
        <span class="p">)</span>
        <span class="n">in_hmc_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Motion corrected input image (a pathlike object or&quot;</span>
            <span class="s2">&quot;string representing a file).&quot;</span>
        <span class="p">)</span>
        <span class="n">in_tsnr_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;tSNR input volume (a pathlike object or string &quot;</span>
            <span class="s2">&quot;representing a file).&quot;</span>
        <span class="p">)</span>
        <span class="n">in_mask_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Input mask image (a pathlike object or string &quot;</span>
            <span class="s2">&quot;representing a file).&quot;</span>
        <span class="p">)</span>
        <span class="n">in_fd_thresh_desc</span> <span class="o">=</span> <span class="s2">&quot;Motion threshold for FD computation (a float)&quot;</span>
        <span class="n">in_outliers_file_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;outliers file (a pathlike object or string &quot;</span>
            <span class="s2">&quot;representing a file).&quot;</span>
        <span class="p">)</span>
        <span class="n">in_QI_file_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Quality index file (a pathlike object or string &quot;</span>
            <span class="s2">&quot;representing a file).&quot;</span>
        <span class="p">)</span>
        <span class="n">in_fwhm_file_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;FWHM file (a pathlike object or string representing a file).&quot;</span>
        <span class="p">)</span>
        <span class="n">in_dvars_file_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;DVARS file (a pathlike object or string representing a file).&quot;</span>
        <span class="p">)</span>
        <span class="n">in_fd_file_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;FD file (a pathlike object or string representing a file).&quot;</span>
        <span class="p">)</span>
        <span class="n">in_spikes_file_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Spikes file (a pathlike object or string representing a file).&quot;</span>
        <span class="p">)</span>
        <span class="n">in_gcor_desc</span> <span class="o">=</span> <span class="s2">&quot;Global correlation value (a float)&quot;</span>
        <span class="n">in_dummy_TRs_desc</span> <span class="o">=</span> <span class="s2">&quot;Number of dummy scans (an int)&quot;</span>

        <span class="c1"># Outputs description</span>
        <span class="n">out_file_desc</span> <span class="o">=</span> <span class="s2">&quot;a json file containing IQMs&quot;</span>

        <span class="c1"># Inputs traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;in_epi&quot;</span><span class="p">,</span> <span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">in_epi_desc</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;in_hmc&quot;</span><span class="p">,</span> <span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">in_hmc_desc</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;in_tsnr&quot;</span><span class="p">,</span> <span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">in_tsnr_desc</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;in_mask&quot;</span><span class="p">,</span> <span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">in_mask_desc</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;in_outliers_file&quot;</span><span class="p">,</span>
            <span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">in_outliers_file_desc</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;in_QI_file&quot;</span><span class="p">,</span>
            <span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">in_QI_file_desc</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;in_fwhm_file&quot;</span><span class="p">,</span>
            <span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">in_fwhm_file_desc</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;in_dvars_file&quot;</span><span class="p">,</span>
            <span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">in_dvars_file_desc</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;in_fd_file&quot;</span><span class="p">,</span>
            <span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">in_fd_file_desc</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;in_fd_thresh&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">Float</span><span class="p">(</span>
                <span class="mf">0.2</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">in_fd_thresh_desc</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;in_spikes_file&quot;</span><span class="p">,</span>
            <span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">in_spikes_file_desc</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;in_gcor&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">Float</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">in_gcor_desc</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;in_dummy_TRs&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">Int</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">in_dummy_TRs_desc</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># Outputs traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;out_file&quot;</span><span class="p">,</span> <span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">out_file_desc</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">init_default_traits</span><span class="p">()</span></div>

<div class="viewcode-block" id="BoldIQMs.list_outputs"><a class="viewcode-back" href="../../../../mia_processes.bricks.reports.html#mia_processes.bricks.reports.processes.BoldIQMs.list_outputs">[docs]</a>    <span class="k">def</span> <span class="nf">list_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_plugged</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Dedicated to the initialisation step of the brick.</span>

<span class="sd">        The main objective of this method is to produce the outputs of the</span>
<span class="sd">        bricks (self.outputs) and the associated tags (self.inheritance_dic),</span>
<span class="sd">        if defined here. To work properly this method must return</span>
<span class="sd">        self.make_initResult() object.</span>

<span class="sd">        :param is_plugged: the state, linked or not, of the plugs.</span>
<span class="sd">        :returns: a dictionary with requirement, outputs and inheritance_dict.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Using the inheritance to ProcessMIA class, list_outputs method</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">BoldIQMs</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">list_outputs</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_epi</span><span class="p">:</span>
            <span class="n">valid_ext</span><span class="p">,</span> <span class="n">in_ext</span><span class="p">,</span> <span class="n">fileName</span> <span class="o">=</span> <span class="n">checkFileExt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_epi</span><span class="p">,</span> <span class="n">EXT</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_ext</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">The input image format is not recognized ...!&quot;</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="n">report_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span> <span class="p">(</span><span class="n">fileName</span> <span class="o">+</span> <span class="s2">&quot;_bold_qc.json&quot;</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">fileName</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;out_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">report_file</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s2">&quot;- BoldIQMs brick: There was no output file deducted &quot;</span>
                    <span class="s2">&quot;during initialisation. Please check the input &quot;</span>
                    <span class="s2">&quot;parameters...!&quot;</span>
                <span class="p">)</span>

            <span class="c1"># tags inheritance (optional)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tags_inheritance</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">in_epi</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;out_file&quot;</span><span class="p">],</span>
                <span class="p">)</span>

        <span class="c1"># Return the requirement, outputs and inheritance_dict</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_initResult</span><span class="p">()</span></div>

<div class="viewcode-block" id="BoldIQMs.run_process_mia"><a class="viewcode-back" href="../../../../mia_processes.bricks.reports.html#mia_processes.bricks.reports.processes.BoldIQMs.run_process_mia">[docs]</a>    <span class="k">def</span> <span class="nf">run_process_mia</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Dedicated to the process launch step of the brick.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">BoldIQMs</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">run_process_mia</span><span class="p">()</span>

        <span class="c1"># Get the mean EPI data and get it ready</span>
        <span class="n">epinii</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_epi</span><span class="p">)</span>
        <span class="n">epidata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">epinii</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">())</span>
        <span class="n">epidata</span> <span class="o">=</span> <span class="n">epidata</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">epidata</span><span class="p">[</span><span class="n">epidata</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Get EPI data (with mc done) and get it ready</span>
        <span class="n">has_in_hmc</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_hmc</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">hmcnii</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_hmc</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span>
                <span class="n">nib</span><span class="o">.</span><span class="n">filebasedimages</span><span class="o">.</span><span class="n">ImageFileError</span><span class="p">,</span>
                <span class="ne">FileNotFoundError</span><span class="p">,</span>
                <span class="ne">TypeError</span><span class="p">,</span>
            <span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">has_in_hmc</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Error with in_hmc file: &quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">hmcdata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">hmcnii</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">())</span>
                <span class="n">hmcdata</span> <span class="o">=</span> <span class="n">hmcdata</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
                <span class="n">hmcdata</span><span class="p">[</span><span class="n">hmcdata</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">has_in_hmc</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Get EPI data (with mc done) and get it ready</span>
        <span class="n">has_in_mask</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_mask</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">msknii</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_mask</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span>
                <span class="n">nib</span><span class="o">.</span><span class="n">filebasedimages</span><span class="o">.</span><span class="n">ImageFileError</span><span class="p">,</span>
                <span class="ne">FileNotFoundError</span><span class="p">,</span>
                <span class="ne">TypeError</span><span class="p">,</span>
            <span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">has_in_mask</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Error with in_mask file: &quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mskdata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">msknii</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">())</span>
                <span class="n">mskdata</span><span class="p">[</span><span class="n">mskdata</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">mskdata</span><span class="p">[</span><span class="n">mskdata</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">mskdata</span> <span class="o">=</span> <span class="n">mskdata</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">has_in_mask</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Get tsnr data and get it ready</span>
        <span class="n">has_in_tsnr</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_tsnr</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">tsnr_nii</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_tsnr</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span>
                <span class="n">nib</span><span class="o">.</span><span class="n">filebasedimages</span><span class="o">.</span><span class="n">ImageFileError</span><span class="p">,</span>
                <span class="ne">FileNotFoundError</span><span class="p">,</span>
                <span class="ne">TypeError</span><span class="p">,</span>
            <span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">has_in_tsnr</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Error with in_mask file: &quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># nibabel: get_data() is deprecated in favour of get_fdata().</span>
                <span class="c1"># To achieve reproducibility with native mriqc results</span>
                <span class="c1"># (which use get_data() in V22.06), we can use</span>
                <span class="c1"># numpy.asanyarray(img.dataobj).</span>
                <span class="n">tsnr_data</span> <span class="o">=</span> <span class="n">tsnr_nii</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">has_in_tsnr</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">results_dict</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="n">has_in_mask</span><span class="p">:</span>
            <span class="c1"># Summary stats</span>
            <span class="n">stats</span> <span class="o">=</span> <span class="n">summary_stats</span><span class="p">(</span><span class="n">epidata</span><span class="p">,</span> <span class="n">mskdata</span><span class="p">,</span> <span class="n">erode</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">results_dict</span><span class="p">[</span><span class="s2">&quot;summary&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stats</span>

            <span class="c1"># SNR</span>
            <span class="n">results_dict</span><span class="p">[</span><span class="s2">&quot;snr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">snr</span><span class="p">(</span>
                <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;fg&quot;</span><span class="p">][</span><span class="s2">&quot;median&quot;</span><span class="p">],</span> <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;fg&quot;</span><span class="p">][</span><span class="s2">&quot;stdv&quot;</span><span class="p">],</span> <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;fg&quot;</span><span class="p">][</span><span class="s2">&quot;n&quot;</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="c1"># FBER</span>
            <span class="n">results_dict</span><span class="p">[</span><span class="s2">&quot;fber&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fber</span><span class="p">(</span><span class="n">epidata</span><span class="p">,</span> <span class="n">mskdata</span><span class="p">)</span>

        <span class="c1"># EFC</span>
        <span class="n">results_dict</span><span class="p">[</span><span class="s2">&quot;efc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">efc</span><span class="p">(</span><span class="n">epidata</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">has_in_mask</span><span class="p">:</span>
            <span class="n">results_dict</span><span class="p">[</span><span class="s2">&quot;gsr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">epidir</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">axis</span> <span class="ow">in</span> <span class="n">epidir</span><span class="p">:</span>
                <span class="n">results_dict</span><span class="p">[</span><span class="s2">&quot;gsr&quot;</span><span class="p">][</span><span class="n">axis</span><span class="p">]</span> <span class="o">=</span> <span class="n">gsr</span><span class="p">(</span>
                    <span class="n">epidata</span><span class="p">,</span> <span class="n">mskdata</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="n">axis</span>
                <span class="p">)</span>

        <span class="c1"># aor</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_outliers_file</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">outliers</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_outliers_file</span><span class="p">,</span> <span class="n">skiprows</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">FileNotFoundError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Error with aor file: &quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">results_dict</span><span class="p">[</span><span class="s2">&quot;vec_outliers&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">outliers</span><span class="p">)</span>
                <span class="n">results_dict</span><span class="p">[</span><span class="s2">&quot;aor&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">outliers</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

        <span class="c1"># aqi</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_QI_file</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_QI_file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fin</span><span class="p">:</span>
                    <span class="n">lines</span> <span class="o">=</span> <span class="n">fin</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">FileNotFoundError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Error with aqi file: &quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">results_dict</span><span class="p">[</span><span class="s2">&quot;aqi&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;++&quot;</span><span class="p">)</span>
                    <span class="p">]</span>
                <span class="p">)</span>

        <span class="c1"># DVARS</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_dvars_file</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">dvars</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">in_dvars_file</span><span class="p">,</span> <span class="n">skiprows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">usecols</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">FileNotFoundError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Error with dvars file: &quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">results_dict</span><span class="p">[</span><span class="s2">&quot;vec_dvars&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dvars</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span>
                <span class="n">dvars_avg</span> <span class="o">=</span> <span class="n">dvars</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">dvars_col</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;std&quot;</span><span class="p">,</span> <span class="s2">&quot;nstd&quot;</span><span class="p">,</span> <span class="s2">&quot;vstd&quot;</span><span class="p">]</span>
                <span class="n">results_dict</span><span class="p">[</span><span class="s2">&quot;dvars&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="n">key</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">dvars_col</span><span class="p">,</span> <span class="n">dvars_avg</span><span class="p">)</span>
                <span class="p">}</span>

        <span class="c1"># tSNR</span>
        <span class="k">if</span> <span class="n">has_in_tsnr</span><span class="p">:</span>
            <span class="n">results_dict</span><span class="p">[</span><span class="s2">&quot;tsnr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">tsnr_data</span><span class="p">[</span><span class="n">mskdata</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]))</span>

        <span class="c1"># FD</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_fd_file</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">fd_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_fd_file</span><span class="p">,</span> <span class="n">skiprows</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">FileNotFoundError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Error with fd file: &quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">results_dict</span><span class="p">[</span><span class="s2">&quot;vec_fd&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">fd_data</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_fd_thresh</span><span class="p">:</span>
                    <span class="n">num_fd</span> <span class="o">=</span> <span class="nb">float</span><span class="p">((</span><span class="n">fd_data</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_fd_thresh</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
                    <span class="n">results_dict</span><span class="p">[</span><span class="s2">&quot;fd&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">&quot;mean&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">fd_data</span><span class="o">.</span><span class="n">mean</span><span class="p">()),</span>
                        <span class="s2">&quot;num&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">num_fd</span><span class="p">),</span>
                        <span class="s2">&quot;perc&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">num_fd</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">/</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fd_data</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)),</span>
                    <span class="p">}</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">results_dict</span><span class="p">[</span><span class="s2">&quot;fd&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;mean&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">fd_data</span><span class="o">.</span><span class="n">mean</span><span class="p">())}</span>

        <span class="c1"># FWHM</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_fwhm_file</span> <span class="ow">and</span> <span class="n">has_in_hmc</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_fwhm_file</span><span class="p">)</span>
                <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
                <span class="n">str_fwhm</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[-+]?\d*\.*\d+&quot;</span><span class="p">,</span> <span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">fwhm</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">str_fwhm</span><span class="p">:</span>
                    <span class="n">fwhm</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">item</span><span class="p">))</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">FileNotFoundError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Error with fwhm file: &quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fwhm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fwhm</span><span class="p">[:</span><span class="mi">3</span><span class="p">])</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                    <span class="n">hmcnii</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">get_zooms</span><span class="p">()[:</span><span class="mi">3</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="n">results_dict</span><span class="p">[</span><span class="s2">&quot;fwhm&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">fwhm</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                    <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">fwhm</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                    <span class="s2">&quot;z&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">fwhm</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
                    <span class="s2">&quot;avg&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">fwhm</span><span class="p">)),</span>
                <span class="p">}</span>

        <span class="k">if</span> <span class="n">has_in_hmc</span><span class="p">:</span>
            <span class="c1"># Image specs</span>
            <span class="n">results_dict</span><span class="p">[</span><span class="s2">&quot;size&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">hmcdata</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">hmcdata</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                <span class="s2">&quot;z&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">hmcdata</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
            <span class="p">}</span>
            <span class="n">results_dict</span><span class="p">[</span><span class="s2">&quot;spacing&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">i</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">],</span> <span class="n">hmcnii</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">get_zooms</span><span class="p">()[:</span><span class="mi">3</span><span class="p">])</span>
            <span class="p">}</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">results_dict</span><span class="p">[</span><span class="s2">&quot;size&quot;</span><span class="p">][</span><span class="s2">&quot;t&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">hmcdata</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="k">pass</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">results_dict</span><span class="p">[</span><span class="s2">&quot;spacing&quot;</span><span class="p">][</span><span class="s2">&quot;tr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span>
                    <span class="n">hmcnii</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">get_zooms</span><span class="p">()[</span><span class="mi">3</span><span class="p">]</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="c1"># GCOR</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">gcor</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_gcor</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">gcor value error&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">results_dict</span><span class="p">[</span><span class="s2">&quot;gcor&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gcor</span>

        <span class="c1"># Dummy TRs</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">dummy_trs</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_dummy_TRs</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">dummy_trs value error&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">results_dict</span><span class="p">[</span><span class="s2">&quot;dummy_trs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dummy_trs</span>

        <span class="c1"># Spikes</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_spikes_file</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">spikes_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_spikes_file</span><span class="p">,</span> <span class="n">skiprows</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">FileNotFoundError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Error with fd file: &quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">spikes_data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])):</span>
                    <span class="n">spike_name</span> <span class="o">=</span> <span class="s2">&quot;vec_spikes_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                    <span class="n">results_dict</span><span class="p">[</span><span class="n">spike_name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">spikes_data</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:])</span>

        <span class="c1"># Flatten the dictionary</span>
        <span class="n">flat_results_dict</span> <span class="o">=</span> <span class="n">_flatten_dict</span><span class="p">(</span><span class="n">results_dict</span><span class="p">)</span>

        <span class="c1"># Save results as json</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_epi</span><span class="p">)</span>
        <span class="n">file_name_no_ext</span><span class="p">,</span> <span class="n">file_extension</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">file_extension</span> <span class="o">==</span> <span class="s2">&quot;.gz&quot;</span><span class="p">:</span>
            <span class="p">(</span><span class="n">file_name_no_ext_2</span><span class="p">,</span> <span class="n">file_extension_2</span><span class="p">)</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span>
                <span class="n">file_name_no_ext</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">file_extension_2</span> <span class="o">==</span> <span class="s2">&quot;.nii&quot;</span><span class="p">:</span>
                <span class="n">file_name_no_ext</span> <span class="o">=</span> <span class="n">file_name_no_ext_2</span>

        <span class="n">report_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span> <span class="p">(</span><span class="n">file_name_no_ext</span> <span class="o">+</span> <span class="s2">&quot;_bold_qc.json&quot;</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">report_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">flat_results_dict</span><span class="p">,</span> <span class="n">fp</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="BoldIQMsPlot"><a class="viewcode-back" href="../../../../mia_processes.bricks.reports.html#mia_processes.bricks.reports.processes.BoldIQMsPlot">[docs]</a><span class="k">class</span> <span class="nc">BoldIQMsPlot</span><span class="p">(</span><span class="n">ProcessMIA</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Plot a figure showing the slice-wise signal intensity at the extremes for</span>
<span class="sd">    the identification of spikes, the outliers metric, the DVARS, the FD and</span>
<span class="sd">    the carpetplot.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="BoldIQMsPlot.__init__"><a class="viewcode-back" href="../../../../mia_processes.bricks.reports.html#mia_processes.bricks.reports.processes.BoldIQMsPlot.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Dedicated to the attributes initialisation/instantiation.</span>

<span class="sd">        The input and output plugs are defined here. The special</span>
<span class="sd">        &#39;self.requirement&#39; attribute (optional) is used to define the</span>
<span class="sd">        third-party products necessary for the running of the brick.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Initialisation of the objects needed for the launch of the brick</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">BoldIQMsPlot</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1"># Third party softwares required for the execution of the brick</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requirement</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Inputs description</span>
        <span class="n">in_func_desc</span> <span class="o">=</span> <span class="s2">&quot;Bold image&quot;</span>
        <span class="n">in_outliers_file_desc</span> <span class="o">=</span> <span class="s2">&quot;Outliers file.&quot;</span>
        <span class="n">in_dvars_file_desc</span> <span class="o">=</span> <span class="s2">&quot;DVARS file.&quot;</span>
        <span class="n">in_fd_file_desc</span> <span class="o">=</span> <span class="s2">&quot;FD file.&quot;</span>
        <span class="n">fd_thresh_desc</span> <span class="o">=</span> <span class="s2">&quot;Motion threshold for FD computation.&quot;</span>
        <span class="n">in_spikes_file_desc</span> <span class="o">=</span> <span class="s2">&quot; Spikes file.&quot;</span>
        <span class="n">carpet_seg_desc</span> <span class="o">=</span> <span class="s2">&quot;Carpet segmentation.&quot;</span>
        <span class="n">drop_trs_desc</span> <span class="o">=</span> <span class="s2">&quot;Number of dummy scans drops.&quot;</span>
        <span class="n">tr_desc</span> <span class="o">=</span> <span class="s2">&quot;Repetition time&quot;</span>

        <span class="c1"># Outputs description</span>
        <span class="n">out_file_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;A figure with carpet and outliers/dvars/FD/spikes plot&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Inputs traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;in_func&quot;</span><span class="p">,</span> <span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">in_func_desc</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;in_outliers_file&quot;</span><span class="p">,</span>
            <span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">in_outliers_file_desc</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;in_dvars_file&quot;</span><span class="p">,</span>
            <span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">in_dvars_file_desc</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;in_fd_file&quot;</span><span class="p">,</span>
            <span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">in_fd_file_desc</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;in_spikes_file&quot;</span><span class="p">,</span>
            <span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">in_spikes_file_desc</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;carpet_seg&quot;</span><span class="p">,</span>
            <span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">carpet_seg_desc</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;drop_trs&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">Int</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">drop_trs_desc</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;fd_thresh&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">Float</span><span class="p">(</span>
                <span class="mf">0.2</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">fd_thresh_desc</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;tr&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">Either</span><span class="p">(</span>
                <span class="n">Undefined</span><span class="p">,</span>
                <span class="n">traits</span><span class="o">.</span><span class="n">Float</span><span class="p">(),</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">tr_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tr</span> <span class="o">=</span> <span class="n">Undefined</span>

        <span class="c1"># Outputs traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;out_file&quot;</span><span class="p">,</span> <span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">out_file_desc</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">init_default_traits</span><span class="p">()</span></div>

<div class="viewcode-block" id="BoldIQMsPlot.list_outputs"><a class="viewcode-back" href="../../../../mia_processes.bricks.reports.html#mia_processes.bricks.reports.processes.BoldIQMsPlot.list_outputs">[docs]</a>    <span class="k">def</span> <span class="nf">list_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_plugged</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Dedicated to the initialisation step of the brick.</span>

<span class="sd">        The main objective of this method is to produce the outputs of the</span>
<span class="sd">        bricks (self.outputs) and the associated tags (self.inheritance_dic),</span>
<span class="sd">        if defined here. In order not to include an output in the database,</span>
<span class="sd">        this output must be a value of the optional key &#39;notInDb&#39; of the</span>
<span class="sd">        self.outputs dictionary. To work properly this method must return</span>
<span class="sd">        self.make_initResult() object.</span>

<span class="sd">        :param is_plugged: the state, linked or not, of the plugs.</span>
<span class="sd">        :returns: a dictionary with requirement, outputs and inheritance_dict.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Using the inheritance to ProcessMIA class, list_outputs method</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">BoldIQMsPlot</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">list_outputs</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tr</span> <span class="ow">is</span> <span class="n">Undefined</span><span class="p">:</span>
            <span class="c1"># Get TR in the database</span>
            <span class="n">tr</span> <span class="o">=</span> <span class="n">get_dbFieldValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_func</span><span class="p">,</span> <span class="s2">&quot;RepetitionTime&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">tr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Please add TR in database for functional file&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_initResult</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">tr</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tr</span> <span class="o">=</span> <span class="n">tr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Outputs definition and tags inheritance (optional)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_func</span><span class="p">:</span>
            <span class="n">valid_ext</span><span class="p">,</span> <span class="n">in_ext</span><span class="p">,</span> <span class="n">fileName</span> <span class="o">=</span> <span class="n">checkFileExt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_func</span><span class="p">,</span> <span class="n">EXT</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_ext</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">The input image format is not recognized ...!&quot;</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;out_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span> <span class="n">fileName</span> <span class="o">+</span> <span class="s2">&quot;_fmriplot.png&quot;</span>
                <span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No output_directory was found...!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">tags_inheritance</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">in_func</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;out_file&quot;</span><span class="p">],</span>
            <span class="p">)</span>

        <span class="c1"># Return the requirement, outputs and inheritance_dict</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_initResult</span><span class="p">()</span></div>

<div class="viewcode-block" id="BoldIQMsPlot.run_process_mia"><a class="viewcode-back" href="../../../../mia_processes.bricks.reports.html#mia_processes.bricks.reports.processes.BoldIQMsPlot.run_process_mia">[docs]</a>    <span class="k">def</span> <span class="nf">run_process_mia</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Dedicated to the process launch step of the brick.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">BoldIQMsPlot</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">run_process_mia</span><span class="p">()</span>

        <span class="n">dataframe</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;outliers&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">in_outliers_file</span><span class="p">,</span> <span class="n">usecols</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
                <span class="c1"># Pick non-standardize dvars (col 1)</span>
                <span class="c1"># First timepoint is NaN (difference)</span>
                <span class="s2">&quot;DVARS&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">]</span>
                <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">in_dvars_file</span><span class="p">,</span> <span class="n">skiprows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">usecols</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
                <span class="c1"># First timepoint is zero (reference volume)</span>
                <span class="s2">&quot;FD&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span>
                <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">in_fd_file</span><span class="p">,</span> <span class="n">skiprows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">usecols</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="n">input_data</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_func</span><span class="p">)</span>
        <span class="n">seg_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">carpet_seg</span>
        <span class="n">dataset</span><span class="p">,</span> <span class="n">segments</span> <span class="o">=</span> <span class="n">_nifti_timeseries</span><span class="p">(</span><span class="n">input_data</span><span class="p">,</span> <span class="n">seg_file</span><span class="p">)</span>

        <span class="n">fig</span> <span class="o">=</span> <span class="n">fMRIPlot</span><span class="p">(</span>
            <span class="n">dataset</span><span class="p">,</span>
            <span class="n">segments</span><span class="o">=</span><span class="n">segments</span><span class="p">,</span>
            <span class="n">spikes_files</span><span class="o">=</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">in_spikes_file</span><span class="p">]),</span>
            <span class="n">tr</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tr</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">,</span>
            <span class="n">confounds</span><span class="o">=</span><span class="n">dataframe</span><span class="p">,</span>
            <span class="n">units</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;outliers&quot;</span><span class="p">:</span> <span class="s2">&quot;%&quot;</span><span class="p">,</span> <span class="s2">&quot;FD&quot;</span><span class="p">:</span> <span class="s2">&quot;mm&quot;</span><span class="p">},</span>
            <span class="n">vlines</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;FD&quot;</span><span class="p">:</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">fd_thresh</span><span class="p">]},</span>
            <span class="n">nskip</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">drop_trs</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">out_file</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="CarpetParcellation"><a class="viewcode-back" href="../../../../mia_processes.bricks.reports.html#mia_processes.bricks.reports.processes.CarpetParcellation">[docs]</a><span class="k">class</span> <span class="nc">CarpetParcellation</span><span class="p">(</span><span class="n">ProcessMIA</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    *Dilate the brain mask, remove it from itself then generate the union</span>
<span class="sd">    of the obtained crown mask and the EPI parcellation*</span>

<span class="sd">    Please, see the complete documentation for the `CarpetParcellation brick</span>
<span class="sd">    in the mia_processes website</span>
<span class="sd">    &lt;https://populse.github.io/mia_processes/html/documentation/bricks/reports/CarpetParcellation.html&gt;`_</span>

<span class="sd">    Adapted from</span>
<span class="sd">    `niworkflows binary dilatation</span>
<span class="sd">    &lt;https://github.com/nipreps/niworkflows/blob/45ab13e1bf6fdbf5e29c90cef44055b0b9cf391b/niworkflows/interfaces/morphology.py#L46&gt;`_,</span>
<span class="sd">    `niworkflows binary subtraction</span>
<span class="sd">    &lt;https://github.com/nipreps/niworkflows/blob/45ab13e1bf6fdbf5e29c90cef44055b0b9cf391b/niworkflows/interfaces/morphology.py#L79&gt;`_,</span>
<span class="sd">    `mriqc</span>
<span class="sd">    &lt;https://github.com/nipreps/mriqc/blob/e021008da0a2ef1c48e882baf932139a673349f9/mriqc/workflows/functional.py#L1022&gt;`__</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="CarpetParcellation.__init__"><a class="viewcode-back" href="../../../../mia_processes.bricks.reports.html#mia_processes.bricks.reports.processes.CarpetParcellation.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Dedicated to the attributes initialisation/instantiation.</span>

<span class="sd">        The input and output plugs are defined here. The special</span>
<span class="sd">        &#39;self.requirement&#39; attribute (optional) is used to define the</span>
<span class="sd">        third-party products necessary for the running of the brick.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Initialisation of the objects needed for the launch of the brick</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CarpetParcellation</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1"># Third party softwares required for the execution of the brick</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requirement</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Inputs description</span>
        <span class="n">segmentation_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;EPI segmentation (a pathlike object or string &quot;</span>
            <span class="s2">&quot;representing a file).&quot;</span>
        <span class="p">)</span>
        <span class="n">brainmask_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Brain mask (a pathlike object or string representing a file).&quot;</span>
        <span class="p">)</span>

        <span class="n">out_prefix_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Specify the string to be prepended to the &quot;</span>
            <span class="s2">&quot;segmentation filename of the output file (a string).&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Outputs description</span>
        <span class="n">out_file_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;The output file (a pathlike object or a &quot;</span>
            <span class="s2">&quot;string representing a file).&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Inputs traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;segmentation&quot;</span><span class="p">,</span>
            <span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">segmentation_desc</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;brainmask&quot;</span><span class="p">,</span>
            <span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">brainmask_desc</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;out_prefix&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">String</span><span class="p">(</span>
                <span class="s2">&quot;cseg_&quot;</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">out_prefix_desc</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># Outputs traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;out_file&quot;</span><span class="p">,</span> <span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">out_file_desc</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">init_default_traits</span><span class="p">()</span></div>

<div class="viewcode-block" id="CarpetParcellation.list_outputs"><a class="viewcode-back" href="../../../../mia_processes.bricks.reports.html#mia_processes.bricks.reports.processes.CarpetParcellation.list_outputs">[docs]</a>    <span class="k">def</span> <span class="nf">list_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_plugged</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Dedicated to the initialisation step of the brick.</span>

<span class="sd">        The main objective of this method is to produce the outputs of the</span>
<span class="sd">        bricks (self.outputs) and the associated tags (self.inheritance_dic),</span>
<span class="sd">        if defined here. In order not to include an output in the database,</span>
<span class="sd">        this output must be a value of the optional key &#39;notInDb&#39; of the</span>
<span class="sd">        self.outputs dictionary. To work properly this method must return</span>
<span class="sd">        self.make_initResult() object.</span>

<span class="sd">        :param is_plugged: the state, linked or not, of the plugs.</span>
<span class="sd">        :returns: a dictionary with requirement, outputs and inheritance_dict.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Using the inheritance to ProcessMIA class, list_outputs method</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CarpetParcellation</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">list_outputs</span><span class="p">()</span>

        <span class="c1"># Outputs definition and tags inheritance (optional)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">segmentation</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">brainmask</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_prefix</span> <span class="o">==</span> <span class="n">Undefined</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">out_prefix</span> <span class="o">=</span> <span class="s2">&quot;cseg_&quot;</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">CarpetParcellation brick: The out_prefix parameter is &quot;</span>
                    <span class="s2">&quot;undefined. Automatically set to &#39;cseg_&#39; ...&quot;</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">:</span>
                <span class="c1"># brainmask name used for carpetplot base name</span>
                <span class="c1"># in order to get a unique path for each subject</span>
                <span class="n">valid_ext</span><span class="p">,</span> <span class="n">in_ext</span><span class="p">,</span> <span class="n">fileName</span> <span class="o">=</span> <span class="n">checkFileExt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">brainmask</span><span class="p">,</span> <span class="n">EXT</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_ext</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">The input image format is not recognized ...!&quot;</span><span class="p">)</span>
                    <span class="k">return</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;out_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">out_prefix</span> <span class="o">+</span> <span class="n">fileName</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">in_ext</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No output_directory was found...!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">tags_inheritance</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">brainmask</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;out_file&quot;</span><span class="p">],</span>
            <span class="p">)</span>

        <span class="c1"># Return the requirement, outputs and inheritance_dict</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_initResult</span><span class="p">()</span></div>

<div class="viewcode-block" id="CarpetParcellation.run_process_mia"><a class="viewcode-back" href="../../../../mia_processes.bricks.reports.html#mia_processes.bricks.reports.processes.CarpetParcellation.run_process_mia">[docs]</a>    <span class="k">def</span> <span class="nf">run_process_mia</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Dedicated to the process launch step of the brick.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CarpetParcellation</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">run_process_mia</span><span class="p">()</span>

        <span class="c1"># Binary dilation</span>
        <span class="n">brainmask_img</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">brainmask</span><span class="p">)</span>
        <span class="n">brainmaskdata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">bool_</span><span class="p">(</span><span class="n">brainmask_img</span><span class="o">.</span><span class="n">dataobj</span><span class="p">)</span>

        <span class="c1"># Obtain dilated brain mask</span>
        <span class="n">dilated</span> <span class="o">=</span> <span class="n">image_binary_dilation</span><span class="p">(</span>
            <span class="n">brainmaskdata</span><span class="p">,</span>
            <span class="n">radius</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Binary subtraction</span>
        <span class="n">subtraction</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">bool_</span><span class="p">(</span><span class="n">dilated</span><span class="p">)</span>
        <span class="n">subtraction</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">bool_</span><span class="p">(</span><span class="n">brainmaskdata</span><span class="p">)]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Carpet parcellation</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">segmentation</span><span class="p">)</span>

        <span class="n">lut</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">256</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;uint8&quot;</span><span class="p">)</span>
        <span class="n">lut</span><span class="p">[</span><span class="mi">100</span><span class="p">:</span><span class="mi">201</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># Ctx GM</span>
        <span class="n">lut</span><span class="p">[</span><span class="mi">30</span><span class="p">:</span><span class="mi">99</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># dGM</span>
        <span class="n">lut</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span>  <span class="c1"># WM+CSF</span>
        <span class="n">lut</span><span class="p">[</span><span class="mi">255</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span>  <span class="c1"># Cerebellum</span>
        <span class="c1"># Apply lookup table</span>
        <span class="n">seg</span> <span class="o">=</span> <span class="n">lut</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">asanyarray</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">dataobj</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;uint16&quot;</span><span class="p">)]</span>
        <span class="n">seg</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">asanyarray</span><span class="p">(</span><span class="n">subtraction</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span>

        <span class="c1"># Out file name</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">brainmask</span><span class="p">)</span>

        <span class="n">file_out</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">out_prefix</span> <span class="o">+</span> <span class="n">file_name</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="n">outimg</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="n">seg</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;uint8&quot;</span><span class="p">),</span> <span class="n">img</span><span class="o">.</span><span class="n">affine</span><span class="p">,</span> <span class="n">img</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>
        <span class="n">outimg</span><span class="o">.</span><span class="n">set_data_dtype</span><span class="p">(</span><span class="s2">&quot;uint8&quot;</span><span class="p">)</span>
        <span class="n">outimg</span><span class="o">.</span><span class="n">to_filename</span><span class="p">(</span><span class="n">file_out</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="ComputeDVARS"><a class="viewcode-back" href="../../../../mia_processes.bricks.reports.html#mia_processes.bricks.reports.processes.ComputeDVARS">[docs]</a><span class="k">class</span> <span class="nc">ComputeDVARS</span><span class="p">(</span><span class="n">ProcessMIA</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    *Computes the DVARS*</span>

<span class="sd">    Please, see the complete documentation for the `ComputeDVARS brick</span>
<span class="sd">    in the mia_processes website</span>
<span class="sd">    &lt;https://populse.github.io/mia_processes/html/documentation/bricks/reports/ComputeDVARS.html&gt;`_</span>

<span class="sd">    adapted from `nipype</span>
<span class="sd">    &lt;https://github.com/nipy/nipype/blob/f662acfce8def4717e0c3414618f3a5de5913b31/nipype/algorithms/confounds.py#L100&gt;`__</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="ComputeDVARS.__init__"><a class="viewcode-back" href="../../../../mia_processes.bricks.reports.html#mia_processes.bricks.reports.processes.ComputeDVARS.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Dedicated to the attributes initialisation/instantiation.</span>

<span class="sd">        The input and output plugs are defined here. The special</span>
<span class="sd">        &#39;self.requirement&#39; attribute (optional) is used to define the</span>
<span class="sd">        third-party products necessary for the running of the brick.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Initialisation of the objects needed for the launch of the brick</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ComputeDVARS</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1"># Third party softwares required for the execution of the brick</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requirement</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Inputs description</span>
        <span class="n">in_file_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Bold image after HMC (a pathlike object or string &quot;</span>
            <span class="s2">&quot;representing a file).&quot;</span>
        <span class="p">)</span>
        <span class="n">in_mask_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Brain mask (a pathlike object or string representing a file).&quot;</span>
        <span class="p">)</span>
        <span class="n">remove_zero_variance_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Remove voxels with zero variance (a bool).&quot;</span>
        <span class="p">)</span>
        <span class="n">intensity_normalization_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Divide value in each voxel at each&quot;</span>
            <span class="s2">&quot;timepoint by the median calculated&quot;</span>
            <span class="s2">&quot;across all voxels and timepoints&quot;</span>
            <span class="s2">&quot;within the mask (if specified) and&quot;</span>
            <span class="s2">&quot;then multiply by the value specified&quot;</span>
            <span class="s2">&quot;by this parameter.&quot;</span>
            <span class="s2">&quot;By using the default (1000)&quot;</span>
            <span class="s2">&quot;output DVARS will be expressed in &quot;</span>
            <span class="s2">&quot;x10 % BOLD units compatible&quot;</span>
            <span class="s2">&quot;with Power et al.2012.&quot;</span>
            <span class="s2">&quot;Set this to 0 to disable intensity&quot;</span>
            <span class="s2">&quot;normalization altogether. (a float)&quot;</span>
        <span class="p">)</span>
        <span class="n">variance_tol_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s1">&#39;Maximum variance to consider &quot;close to&quot; zero&#39;</span>
            <span class="s2">&quot;for the purposes of removal&quot;</span>
        <span class="p">)</span>
        <span class="n">out_prefix_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Specify the string to be prepended to the &quot;</span>
            <span class="s2">&quot;filename of the output file (a string).&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Outputs description</span>
        <span class="n">out_file_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;The output file (a pathlike object or a &quot;</span>
            <span class="s2">&quot;string representing a file).&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Inputs traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;in_file&quot;</span><span class="p">,</span> <span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">in_file_desc</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;in_mask&quot;</span><span class="p">,</span> <span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">in_mask_desc</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;remove_zero_variance&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">Bool</span><span class="p">(</span>
                <span class="kc">True</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">remove_zero_variance_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;intensity_normalization&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">Float</span><span class="p">(</span>
                <span class="mf">1000.0</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">intensity_normalization_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;variance_tol&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">Float</span><span class="p">(</span>
                <span class="mf">0.0000001000</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">variance_tol_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;out_prefix&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">String</span><span class="p">(</span>
                <span class="s2">&quot;dvars_&quot;</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">out_prefix_desc</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># Outputs traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;out_file&quot;</span><span class="p">,</span> <span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">out_file_desc</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">init_default_traits</span><span class="p">()</span></div>

<div class="viewcode-block" id="ComputeDVARS.list_outputs"><a class="viewcode-back" href="../../../../mia_processes.bricks.reports.html#mia_processes.bricks.reports.processes.ComputeDVARS.list_outputs">[docs]</a>    <span class="k">def</span> <span class="nf">list_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_plugged</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Dedicated to the initialisation step of the brick.</span>

<span class="sd">        The main objective of this method is to produce the outputs of the</span>
<span class="sd">        bricks (self.outputs) and the associated tags (self.inheritance_dic),</span>
<span class="sd">        if defined here. In order not to include an output in the database,</span>
<span class="sd">        this output must be a value of the optional key &#39;notInDb&#39; of the</span>
<span class="sd">        self.outputs dictionary. To work properly this method must return</span>
<span class="sd">        self.make_initResult() object.</span>

<span class="sd">        :param is_plugged: the state, linked or not, of the plugs.</span>
<span class="sd">        :returns: a dictionary with requirement, outputs and inheritance_dict.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Using the inheritance to ProcessMIA class, list_outputs method</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ComputeDVARS</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">list_outputs</span><span class="p">()</span>

        <span class="c1"># Outputs definition and tags inheritance (optional)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_file</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_mask</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_prefix</span> <span class="o">==</span> <span class="n">Undefined</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">out_prefix</span> <span class="o">=</span> <span class="s2">&quot;dvars_&quot;</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s2">&quot;ComputeDVARS brick: The out_prefix parameter is &quot;</span>
                    <span class="s2">&quot;undefined. Automatically set to &#39;dvars_&#39; ...&quot;</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">:</span>
                <span class="n">valid_ext</span><span class="p">,</span> <span class="n">in_ext</span><span class="p">,</span> <span class="n">fileName</span> <span class="o">=</span> <span class="n">checkFileExt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_file</span><span class="p">,</span> <span class="n">EXT</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_ext</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">The input image format is not recognized ...!&quot;</span><span class="p">)</span>
                    <span class="k">return</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;out_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_prefix</span> <span class="o">+</span> <span class="n">fileName</span> <span class="o">+</span> <span class="s2">&quot;.out&quot;</span>
                <span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No output_directory was found...!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">tags_inheritance</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">in_file</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;out_file&quot;</span><span class="p">],</span>
            <span class="p">)</span>

        <span class="c1"># Return the requirement, outputs and inheritance_dict</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_initResult</span><span class="p">()</span></div>

<div class="viewcode-block" id="ComputeDVARS.run_process_mia"><a class="viewcode-back" href="../../../../mia_processes.bricks.reports.html#mia_processes.bricks.reports.processes.ComputeDVARS.run_process_mia">[docs]</a>    <span class="k">def</span> <span class="nf">run_process_mia</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Dedicated to the process launch step of the brick.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ComputeDVARS</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">run_process_mia</span><span class="p">()</span>

        <span class="c1"># Out file name</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_file</span><span class="p">)</span>
        <span class="n">file_name_no_ext</span><span class="p">,</span> <span class="n">file_extension</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">file_extension</span> <span class="o">==</span> <span class="s2">&quot;.gz&quot;</span><span class="p">:</span>
            <span class="p">(</span><span class="n">file_name_no_ext_2</span><span class="p">,</span> <span class="n">file_extension_2</span><span class="p">)</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span>
                <span class="n">file_name_no_ext</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">file_extension_2</span> <span class="o">==</span> <span class="s2">&quot;.nii&quot;</span><span class="p">:</span>
                <span class="n">file_name_no_ext</span> <span class="o">=</span> <span class="n">file_name_no_ext_2</span>

        <span class="n">file_out</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">out_prefix</span> <span class="o">+</span> <span class="n">file_name_no_ext</span> <span class="o">+</span> <span class="s2">&quot;.out&quot;</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># Load data</span>
        <span class="n">func</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_file</span><span class="p">)</span><span class="o">.</span><span class="n">dataobj</span><span class="p">)</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">bool_</span><span class="p">(</span><span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_mask</span><span class="p">)</span><span class="o">.</span><span class="n">dataobj</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Input fMRI dataset should be 4-dimensional&quot;</span><span class="p">)</span>

        <span class="n">mfunc</span> <span class="o">=</span> <span class="n">func</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">intensity_normalization</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">mfunc</span> <span class="o">=</span> <span class="p">(</span><span class="n">mfunc</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">mfunc</span><span class="p">))</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">intensity_normalization</span>

        <span class="c1"># Robust standard deviation (we are using &quot;lower&quot; interpolation</span>
        <span class="c1"># because this is what FSL is doing</span>
        <span class="n">func_sd</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">mfunc</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s2">&quot;lower&quot;</span><span class="p">)</span>
            <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">mfunc</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s2">&quot;lower&quot;</span><span class="p">)</span>
        <span class="p">)</span> <span class="o">/</span> <span class="mf">1.349</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">remove_zero_variance</span><span class="p">:</span>
            <span class="n">zero_variance_voxels</span> <span class="o">=</span> <span class="n">func_sd</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">variance_tol</span>
            <span class="n">mfunc</span> <span class="o">=</span> <span class="n">mfunc</span><span class="p">[</span><span class="n">zero_variance_voxels</span><span class="p">,</span> <span class="p">:]</span>
            <span class="n">func_sd</span> <span class="o">=</span> <span class="n">func_sd</span><span class="p">[</span><span class="n">zero_variance_voxels</span><span class="p">]</span>

        <span class="c1"># Compute (non-robust) estimate of lag-1 autocorrelation</span>
        <span class="n">ar1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">apply_along_axis</span><span class="p">(</span>
            <span class="n">_AR_est_YW</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="n">regress_poly</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">mfunc</span><span class="p">,</span> <span class="n">remove_mean</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
            <span class="mi">1</span><span class="p">,</span>
        <span class="p">)[:,</span> <span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Compute (predicted) standard deviation of temporal</span>
        <span class="c1"># difference time series</span>
        <span class="n">diff_sdhat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">ar1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()))</span> <span class="o">*</span> <span class="n">func_sd</span>
        <span class="n">diff_sd_mean</span> <span class="o">=</span> <span class="n">diff_sdhat</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

        <span class="c1"># Compute temporal difference time series</span>
        <span class="n">func_diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">mfunc</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># DVARS (no standardization)</span>
        <span class="n">dvars_nstd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">func_diff</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>

        <span class="c1"># standardization</span>
        <span class="n">dvars_stdz</span> <span class="o">=</span> <span class="n">dvars_nstd</span> <span class="o">/</span> <span class="n">diff_sd_mean</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># voxelwise standardization</span>
            <span class="n">diff_vx_stdz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span>
                <span class="n">func_diff</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">diff_sdhat</span><span class="p">]</span> <span class="o">*</span> <span class="n">func_diff</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
            <span class="p">)</span>
            <span class="n">dvars_vx_stdz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">diff_vx_stdz</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Error calculating vx-wise std DVARS...!&quot;</span><span class="p">)</span>
            <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span>
                <span class="n">file_out</span><span class="p">,</span>
                <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">dvars_stdz</span><span class="p">,</span> <span class="n">dvars_nstd</span><span class="p">))</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
                <span class="n">fmt</span><span class="o">=</span><span class="sa">b</span><span class="s2">&quot;</span><span class="si">%0.8f</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">delimiter</span><span class="o">=</span><span class="sa">b</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">header</span><span class="o">=</span><span class="s2">&quot;std DVARS</span><span class="se">\t</span><span class="s2">non-std DVARS&quot;</span><span class="p">,</span>
                <span class="n">comments</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span>
                <span class="n">file_out</span><span class="p">,</span>
                <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">dvars_stdz</span><span class="p">,</span> <span class="n">dvars_nstd</span><span class="p">,</span> <span class="n">dvars_vx_stdz</span><span class="p">))</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
                <span class="n">fmt</span><span class="o">=</span><span class="sa">b</span><span class="s2">&quot;</span><span class="si">%0.8f</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">delimiter</span><span class="o">=</span><span class="sa">b</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">header</span><span class="o">=</span><span class="s2">&quot;std DVARS</span><span class="se">\t</span><span class="s2">non-std DVARS</span><span class="se">\t</span><span class="s2">vx-wise std DVARS&quot;</span><span class="p">,</span>
                <span class="n">comments</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="p">)</span></div></div>


<div class="viewcode-block" id="FramewiseDisplacement"><a class="viewcode-back" href="../../../../mia_processes.bricks.reports.html#mia_processes.bricks.reports.processes.FramewiseDisplacement">[docs]</a><span class="k">class</span> <span class="nc">FramewiseDisplacement</span><span class="p">(</span><span class="n">ProcessMIA</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    *Calculate the FD (framewise displacement) as in [Power2012]*</span>

<span class="sd">    This implementation reproduces the calculation in fsl_motion_outliers</span>

<span class="sd">    `[Power2012] &lt;https://doi.org/10.1016/j.neuroimage.2011.10.018&gt;`_ Power</span>
<span class="sd">    et al., Spurious but systematic correlations in functional connectivity</span>
<span class="sd">    MRI networks arise from subject motion, NeuroImage 59(3).</span>

<span class="sd">    Please, see the complete documentation for the `FramewiseDisplacement</span>
<span class="sd">    brick in the mia_processes website</span>
<span class="sd">    &lt;https://populse.github.io/mia_processes/html/documentation/bricks/reports/FramewiseDisplacement.html&gt;`_</span>

<span class="sd">    adapted from `nipype</span>
<span class="sd">    &lt;https://github.com/nipy/nipype/blob/f662acfce8def4717e0c3414618f3a5de5913b31/nipype/algorithms/confounds.py#L298&gt;`__</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="FramewiseDisplacement.__init__"><a class="viewcode-back" href="../../../../mia_processes.bricks.reports.html#mia_processes.bricks.reports.processes.FramewiseDisplacement.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Dedicated to the attributes initialisation/instantiation.</span>

<span class="sd">        The input and output plugs are defined here. The special</span>
<span class="sd">        &#39;self.requirement&#39; attribute (optional) is used to define the</span>
<span class="sd">        third-party products necessary for the running of the brick.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Initialisation of the objects needed for the launch of the brick</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">FramewiseDisplacement</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1"># Third party softwares required for the execution of the brick</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requirement</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Inputs description</span>
        <span class="n">in_file_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Motion parameters file (a pathlike object or string &quot;</span>
            <span class="s2">&quot;representing a file).&quot;</span>
        <span class="p">)</span>
        <span class="n">parameter_source_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Source of movement parameters&quot;</span>
            <span class="s2">&quot;(a string which is FSL &quot;</span>
            <span class="s2">&quot;or AFNI or SPM or FSFAST or NIPY&quot;</span>
        <span class="p">)</span>
        <span class="n">radius_desc</span> <span class="o">=</span> <span class="s2">&quot;Radius in mm to calculate angular FDs (a float).&quot;</span>
        <span class="n">normalize_desc</span> <span class="o">=</span> <span class="s2">&quot;Calculate FD in mm/s (a bool).&quot;</span>
        <span class="n">out_prefix_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Specify the string to be prepended to the &quot;</span>
            <span class="s2">&quot;filename of the output file (a string).&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Outputs description</span>
        <span class="n">out_file_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;The output file (a pathlike object or a &quot;</span>
            <span class="s2">&quot;string representing a file).&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Inputs traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;in_file&quot;</span><span class="p">,</span> <span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">in_file_desc</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;parameter_source&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">Enum</span><span class="p">(</span>
                <span class="s2">&quot;FSL&quot;</span><span class="p">,</span>
                <span class="s2">&quot;AFNI&quot;</span><span class="p">,</span>
                <span class="s2">&quot;SPM&quot;</span><span class="p">,</span>
                <span class="s2">&quot;FSFAST&quot;</span><span class="p">,</span>
                <span class="s2">&quot;NIPY&quot;</span><span class="p">,</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">parameter_source_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;radius&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">Float</span><span class="p">(</span><span class="mf">50.0</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">radius_desc</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;normalize&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">Bool</span><span class="p">(</span>
                <span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">normalize_desc</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;out_prefix&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">String</span><span class="p">(</span>
                <span class="s2">&quot;fd_&quot;</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">out_prefix_desc</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># Outputs traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;out_file&quot;</span><span class="p">,</span> <span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">out_file_desc</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">init_default_traits</span><span class="p">()</span></div>

<div class="viewcode-block" id="FramewiseDisplacement.list_outputs"><a class="viewcode-back" href="../../../../mia_processes.bricks.reports.html#mia_processes.bricks.reports.processes.FramewiseDisplacement.list_outputs">[docs]</a>    <span class="k">def</span> <span class="nf">list_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_plugged</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Dedicated to the initialisation step of the brick.</span>

<span class="sd">        The main objective of this method is to produce the outputs of the</span>
<span class="sd">        bricks (self.outputs) and the associated tags (self.inheritance_dic),</span>
<span class="sd">        if defined here. In order not to include an output in the database,</span>
<span class="sd">        this output must be a value of the optional key &#39;notInDb&#39; of the</span>
<span class="sd">        self.outputs dictionary. To work properly this method must return</span>
<span class="sd">        self.make_initResult() object.</span>

<span class="sd">        :param is_plugged: the state, linked or not, of the plugs.</span>
<span class="sd">        :returns: a dictionary with requirement, outputs and inheritance_dict.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Using the inheritance to ProcessMIA class, list_outputs method</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">FramewiseDisplacement</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">list_outputs</span><span class="p">()</span>

        <span class="c1"># Outputs definition and tags inheritance (optional)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_file</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_prefix</span> <span class="o">==</span> <span class="n">Undefined</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">out_prefix</span> <span class="o">=</span> <span class="s2">&quot;fd_&quot;</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s2">&quot;FramewiseDisplacement brick: The out_prefix parameter is &quot;</span>
                    <span class="s2">&quot;undefined. Automatically set to &#39;_fd&#39; ...&quot;</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">:</span>
                <span class="n">valid_ext</span><span class="p">,</span> <span class="n">in_ext</span><span class="p">,</span> <span class="n">fileName</span> <span class="o">=</span> <span class="n">checkFileExt</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">in_file</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;TXT&quot;</span><span class="p">:</span> <span class="s2">&quot;txt&quot;</span><span class="p">}</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_ext</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">The input image format is not recognized ...!&quot;</span><span class="p">)</span>
                    <span class="k">return</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;out_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_prefix</span> <span class="o">+</span> <span class="n">fileName</span> <span class="o">+</span> <span class="s2">&quot;.out&quot;</span>
                <span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No output_directory was found...!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">tags_inheritance</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">in_file</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;out_file&quot;</span><span class="p">],</span>
            <span class="p">)</span>

        <span class="c1"># Return the requirement, outputs and inheritance_dict</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_initResult</span><span class="p">()</span></div>

<div class="viewcode-block" id="FramewiseDisplacement.run_process_mia"><a class="viewcode-back" href="../../../../mia_processes.bricks.reports.html#mia_processes.bricks.reports.processes.FramewiseDisplacement.run_process_mia">[docs]</a>    <span class="k">def</span> <span class="nf">run_process_mia</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Dedicated to the process launch step of the brick.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">FramewiseDisplacement</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">run_process_mia</span><span class="p">()</span>

        <span class="n">mpars</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_file</span><span class="p">)</span>  <span class="c1"># mpars is N_t x 6</span>
        <span class="n">mpars</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">apply_along_axis</span><span class="p">(</span>
            <span class="n">func1d</span><span class="o">=</span><span class="n">normalize_mc_params</span><span class="p">,</span>
            <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">arr</span><span class="o">=</span><span class="n">mpars</span><span class="p">,</span>
            <span class="n">source</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parameter_source</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="n">mpars</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:</span><span class="mi">6</span><span class="p">]</span> <span class="o">-</span> <span class="n">mpars</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="p">:</span><span class="mi">6</span><span class="p">]</span>
        <span class="n">diff</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">radius</span>
        <span class="n">fd_res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Image save</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_file</span><span class="p">)</span>
        <span class="n">file_name_no_ext</span><span class="p">,</span> <span class="n">file_extension</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">file_extension</span> <span class="o">==</span> <span class="s2">&quot;.gz&quot;</span><span class="p">:</span>
            <span class="p">(</span><span class="n">file_name_no_ext_2</span><span class="p">,</span> <span class="n">file_extension_2</span><span class="p">)</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span>
                <span class="n">file_name_no_ext</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">file_extension_2</span> <span class="o">==</span> <span class="s2">&quot;.nii&quot;</span><span class="p">:</span>
                <span class="n">file_name_no_ext</span> <span class="o">=</span> <span class="n">file_name_no_ext_2</span>

        <span class="n">file_out</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">out_prefix</span> <span class="o">+</span> <span class="n">file_name_no_ext</span> <span class="o">+</span> <span class="s2">&quot;.out&quot;</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span>
            <span class="n">file_out</span><span class="p">,</span> <span class="n">fd_res</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="s2">&quot;FramewiseDisplacement&quot;</span><span class="p">,</span> <span class="n">comments</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
        <span class="p">)</span></div></div>


<div class="viewcode-block" id="Mean_stdDev_calc"><a class="viewcode-back" href="../../../../mia_processes.bricks.reports.html#mia_processes.bricks.reports.processes.Mean_stdDev_calc">[docs]</a><span class="k">class</span> <span class="nc">Mean_stdDev_calc</span><span class="p">(</span><span class="n">ProcessMIA</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    *Makes the mean and standard deviation of parametric_maps*</span>

<span class="sd">    - The parametric_maps are first resized, if necessary, to the size of the</span>
<span class="sd">      rois_files. Next, the parametric_maps and the rois_files are convolved.</span>
<span class="sd">      Finally, the mean and standard deviation are calculated for the</span>
<span class="sd">      corresponding ROIs.</span>
<span class="sd">    - The PatientName_data/ROI_data/ROI_analysis directory is created to</span>
<span class="sd">      receive the results. If this directory exists at runtime, it is</span>
<span class="sd">      overwritten.</span>
<span class="sd">    - To work correctly, the database entry for the first element of</span>
<span class="sd">      parametric_maps must have the PatientName tag filled in.</span>

<span class="sd">    Please, see the complete documentation for the `Mean_stdDev_calc</span>
<span class="sd">    brick in the mia_processes website</span>
<span class="sd">    &lt;https://populse.github.io/mia_processes/html/documentation/bricks/reports/Mean_stdDev_calc.html&gt;`_</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Mean_stdDev_calc.__init__"><a class="viewcode-back" href="../../../../mia_processes.bricks.reports.html#mia_processes.bricks.reports.processes.Mean_stdDev_calc.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Dedicated to the attributes initialisation/instantiation.</span>

<span class="sd">        The input and output plugs are defined here. The special</span>
<span class="sd">        &#39;self.requirement&#39; attribute (optional) is used to define the</span>
<span class="sd">        third-party products necessary for the running of the brick.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Initialisation of the objects needed for the launch of the brick</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Mean_stdDev_calc</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1"># Inputs description</span>
        <span class="n">parametric_maps_desc</span> <span class="o">=</span> <span class="s2">&quot;A list of files (existing, uncompressed file)&quot;</span>
        <span class="n">rois_files_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;A list of regions of interest applied to the parametric maps to &quot;</span>
            <span class="s2">&quot;calculate their mean and standard deviation&quot;</span>
        <span class="p">)</span>
        <span class="n">contrast_type_desc</span> <span class="o">=</span> <span class="s2">&quot;The Contrast used (a string, ex. BOLD)&quot;</span>
        <span class="n">prefix_to_delete_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;The prefix to delete from the deduced ROI name (a string)&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Outputs description</span>
        <span class="n">mean_out_files_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;A list of .txt files with the calculated average for each &quot;</span>
            <span class="s2">&quot;ROI after convolution with parametric_maps_desc&quot;</span>
        <span class="p">)</span>
        <span class="n">std_out_files_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;A list of .txt files with the standard deviation for each ROI &quot;</span>
            <span class="s2">&quot;after convolution with parametric_maps_desc&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Inputs traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;parametric_maps&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">(</span>
                <span class="n">traits</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">exists</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">parametric_maps_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parametric_maps</span> <span class="o">=</span> <span class="n">Undefined</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;rois_files&quot;</span><span class="p">,</span>
            <span class="n">InputMultiPath</span><span class="p">(</span>
                <span class="n">ImageFileSPM</span><span class="p">(),</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">rois_files_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;contrast_type&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">String</span><span class="p">(</span>
                <span class="s2">&quot;BOLD&quot;</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">contrast_type_desc</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;prefix_to_delete&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">String</span><span class="p">(</span>
                <span class="s2">&quot;conv&quot;</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">prefix_to_delete_desc</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># Output traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;mean_out_files&quot;</span><span class="p">,</span>
            <span class="n">OutputMultiPath</span><span class="p">(</span><span class="n">File</span><span class="p">(),</span> <span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">mean_out_files_desc</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;std_out_files&quot;</span><span class="p">,</span>
            <span class="n">OutputMultiPath</span><span class="p">(</span><span class="n">File</span><span class="p">(),</span> <span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">std_out_files_desc</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># Special parameter used as a messenger for the run_process_mia method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;dict4runtime&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">Dict</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">userlevel</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">init_default_traits</span><span class="p">()</span></div>

<div class="viewcode-block" id="Mean_stdDev_calc.list_outputs"><a class="viewcode-back" href="../../../../mia_processes.bricks.reports.html#mia_processes.bricks.reports.processes.Mean_stdDev_calc.list_outputs">[docs]</a>    <span class="k">def</span> <span class="nf">list_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_plugged</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Dedicated to the initialisation step of the brick.</span>

<span class="sd">        The main objective of this method is to produce the outputs of the</span>
<span class="sd">        bricks (self.outputs) and the associated tags (self.inheritance_dic),</span>
<span class="sd">        if defined here. In order not to include an output in the database,</span>
<span class="sd">        this output must be a value of the optional key &#39;notInDb&#39; of the</span>
<span class="sd">        self.outputs dictionary. To work properly this method must return</span>
<span class="sd">        self.make_initResult() object.</span>

<span class="sd">        :param is_plugged: the state, linked or not, of the plugs.</span>
<span class="sd">        :returns: a dictionary with requirement, outputs and inheritance_dict.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Using the inheritance to ProcessMIA class, list_outputs method</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Mean_stdDev_calc</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">list_outputs</span><span class="p">()</span>

        <span class="c1"># Outputs definition and tags inheritance (optional)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parametric_maps</span> <span class="o">!=</span> <span class="n">Undefined</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">rois_files</span> <span class="o">!=</span> <span class="n">Undefined</span><span class="p">:</span>
            <span class="c1"># FIXME: We retrieve the name of the patient from the first element</span>
            <span class="c1">#        of parametric_maps. This is only fine if all the elements</span>
            <span class="c1">#        of parametric_maps correspond to the same patient.</span>
            <span class="n">patient_name</span> <span class="o">=</span> <span class="n">get_dbFieldValue</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parametric_maps</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;PatientName&quot;</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">patient_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Mean_stdDev_cal brick:</span><span class="se">\n</span><span class="s2">The PatientName tag is not &quot;</span>
                    <span class="s2">&quot;filled in the database for the </span><span class="si">{}</span><span class="s2"> file ...</span><span class="se">\n</span><span class="s2"> The &quot;</span>
                    <span class="s2">&quot;initialization is &quot;</span>
                    <span class="s2">&quot;aborted...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parametric_maps</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_initResult</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">dict4runtime</span><span class="p">[</span><span class="s2">&quot;patient_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">patient_name</span>
            <span class="n">analysis_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span>
                <span class="n">patient_name</span> <span class="o">+</span> <span class="s2">&quot;_data&quot;</span><span class="p">,</span>
                <span class="s2">&quot;ROI_data&quot;</span><span class="p">,</span>
                <span class="s2">&quot;ROI_analysis&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">mean_out_files</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">std_out_files</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">contrast_type</span><span class="o">.</span><span class="n">isspace</span><span class="p">()</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">contrast_type</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">contrast_type</span> <span class="o">=</span> <span class="s2">&quot;UnknownContrast&quot;</span>

            <span class="k">if</span> <span class="p">(</span>
                <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefix_to_delete</span><span class="p">)</span>
                <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix_to_delete</span><span class="o">.</span><span class="n">isspace</span><span class="p">())</span>
                <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix_to_delete</span> <span class="ow">in</span> <span class="p">[</span><span class="n">Undefined</span><span class="p">,</span> <span class="s2">&quot;&lt;undefined&gt;&quot;</span><span class="p">])</span>
            <span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">prefix_to_delete</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span>

            <span class="n">tag_to_add</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
            <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;PatientName&quot;</span>
            <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;field_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;string&quot;</span>
            <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;visibility&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;origin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;user&quot;</span>
            <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;unit&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;default_value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">patient_name</span>

            <span class="k">for</span> <span class="n">parametric_map</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parametric_maps</span><span class="p">:</span>
                <span class="n">param_file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">parametric_map</span><span class="p">)</span>

                <span class="k">if</span> <span class="s2">&quot;_&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">param_file_name</span><span class="p">:</span>
                    <span class="n">parameter</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">param_file_name</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">parameter</span> <span class="o">=</span> <span class="n">param_file_name</span><span class="p">[:</span> <span class="n">param_file_name</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)]</span>

                <span class="k">for</span> <span class="n">roi</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rois_files</span><span class="p">:</span>
                    <span class="n">roi_name</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">roi</span><span class="p">))</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefix_to_delete</span> <span class="o">!=</span> <span class="s2">&quot; &quot;</span> <span class="ow">and</span> <span class="n">roi_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">prefix_to_delete</span>
                    <span class="p">):</span>
                        <span class="c1"># fmt: off</span>
                        <span class="n">roi_name</span> <span class="o">=</span> <span class="n">roi_name</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix_to_delete</span><span class="p">):]</span>
                        <span class="c1"># fmt: on</span>

                    <span class="n">mean_out_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                        <span class="n">analysis_dir</span><span class="p">,</span>
                        <span class="n">roi_name</span>
                        <span class="o">+</span> <span class="s2">&quot;_mean_&quot;</span>
                        <span class="o">+</span> <span class="n">parameter</span>
                        <span class="o">+</span> <span class="s2">&quot;_&quot;</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">contrast_type</span>
                        <span class="o">+</span> <span class="s2">&quot;.txt&quot;</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">mean_out_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mean_out_file</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">tags_inheritance</span><span class="p">(</span>
                        <span class="n">parametric_map</span><span class="p">,</span>
                        <span class="n">mean_out_file</span><span class="p">,</span>
                        <span class="n">own_tags</span><span class="o">=</span><span class="p">[</span><span class="n">tag_to_add</span><span class="p">],</span>
                    <span class="p">)</span>

                    <span class="n">std_out_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                        <span class="n">analysis_dir</span><span class="p">,</span>
                        <span class="n">roi_name</span>
                        <span class="o">+</span> <span class="s2">&quot;_std_&quot;</span>
                        <span class="o">+</span> <span class="n">parameter</span>
                        <span class="o">+</span> <span class="s2">&quot;_&quot;</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">contrast_type</span>
                        <span class="o">+</span> <span class="s2">&quot;.txt&quot;</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">std_out_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">std_out_file</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">tags_inheritance</span><span class="p">(</span>
                        <span class="n">parametric_map</span><span class="p">,</span>
                        <span class="n">std_out_file</span><span class="p">,</span>
                        <span class="n">own_tags</span><span class="o">=</span><span class="p">[</span><span class="n">tag_to_add</span><span class="p">],</span>
                    <span class="p">)</span>

            <span class="k">if</span> <span class="n">mean_out_files</span> <span class="o">!=</span> <span class="p">[]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;mean_out_files&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mean_out_files</span>

            <span class="k">if</span> <span class="n">std_out_files</span> <span class="o">!=</span> <span class="p">[]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;std_out_files&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">std_out_files</span>

        <span class="c1"># Return the requirement, outputs and inheritance_dict</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_initResult</span><span class="p">()</span></div>

<div class="viewcode-block" id="Mean_stdDev_calc.run_process_mia"><a class="viewcode-back" href="../../../../mia_processes.bricks.reports.html#mia_processes.bricks.reports.processes.Mean_stdDev_calc.run_process_mia">[docs]</a>    <span class="k">def</span> <span class="nf">run_process_mia</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Dedicated to the process launch step of the brick.&quot;&quot;&quot;</span>
        <span class="c1"># No need the next line (we don&#39;t use self.process and SPM)</span>
        <span class="c1"># super(Mean_stdDev_calc, self).run_process_mia()</span>

        <span class="n">pat_name_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dict4runtime</span><span class="p">[</span><span class="s2">&quot;patient_name&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_data&quot;</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">pat_name_dir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">pat_name_dir</span><span class="p">)</span>

        <span class="n">roi_data_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pat_name_dir</span><span class="p">,</span> <span class="s2">&quot;ROI_data&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">roi_data_dir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">roi_data_dir</span><span class="p">)</span>

        <span class="n">analysis_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">roi_data_dir</span><span class="p">,</span> <span class="s2">&quot;ROI_analysis&quot;</span><span class="p">)</span>

        <span class="n">tmp</span> <span class="o">=</span> <span class="s2">&quot;None&quot;</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">analysis_dir</span><span class="p">):</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mktemp</span><span class="p">(</span><span class="nb">dir</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">roi_data_dir</span><span class="p">))</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">analysis_dir</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="s2">&quot;ROI_analysis&quot;</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Mean_stdDev_calc brick:</span><span class="se">\n</span><span class="s1">A &quot;</span><span class="si">{}</span><span class="s1">&quot; folder already exists, &#39;</span>
                <span class="s2">&quot;it will be overwritten by this new &quot;</span>
                <span class="s2">&quot;calculation...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">analysis_dir</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">analysis_dir</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">tmp</span><span class="p">):</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">parametric_map</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parametric_maps</span><span class="p">:</span>
            <span class="c1"># Reading parametric map</span>
            <span class="n">map_img</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">parametric_map</span><span class="p">)</span>
            <span class="c1"># Deduction of the parameter from the name of the parametric map</span>
            <span class="n">param_file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">parametric_map</span><span class="p">)</span>

            <span class="k">if</span> <span class="s2">&quot;_&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">param_file_name</span><span class="p">:</span>
                <span class="n">parameter</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">param_file_name</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">parameter</span> <span class="o">=</span> <span class="n">param_file_name</span><span class="p">[:</span> <span class="n">param_file_name</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)]</span>

            <span class="k">for</span> <span class="n">roi_file</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rois_files</span><span class="p">:</span>
                <span class="n">roi_img</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">roi_file</span><span class="p">)</span>
                <span class="c1"># Deduction of the ROI name from the roi_file</span>
                <span class="n">roi_name</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">roi_file</span><span class="p">))</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefix_to_delete</span> <span class="o">!=</span> <span class="s2">&quot; &quot;</span> <span class="ow">and</span> <span class="n">roi_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">prefix_to_delete</span>
                <span class="p">):</span>
                    <span class="c1"># fmt: off</span>
                    <span class="n">roi_name</span> <span class="o">=</span> <span class="n">roi_name</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix_to_delete</span><span class="p">):]</span>
                    <span class="c1"># fmt: on</span>

                <span class="c1"># Making sure that the ROIs and parametric images are at the</span>
                <span class="c1"># same size</span>
                <span class="k">if</span> <span class="n">roi_img</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="n">map_img</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">3</span><span class="p">]:</span>
                    <span class="n">roi_img</span> <span class="o">=</span> <span class="n">resample_to_img</span><span class="p">(</span>
                        <span class="n">roi_img</span><span class="p">,</span> <span class="n">map_img</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span>
                    <span class="p">)</span>

                <span class="c1"># Convolution of the parametric map with the ROI images</span>
                <span class="n">final_roi_data</span> <span class="o">=</span> <span class="n">roi_img</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
                <span class="n">final_roi_data</span><span class="p">[</span><span class="n">final_roi_data</span> <span class="o">&lt;</span> <span class="mf">1e-5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">map_data</span> <span class="o">=</span> <span class="n">map_img</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">()</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">final_roi_data</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">map_data</span><span class="p">)</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">map_data</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

                <span class="c1"># Calculating mean and standard deviation</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="n">result</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Mean_stdDev_cal brick:</span><span class="se">\n</span><span class="s2">Warning: No result found &quot;</span>
                        <span class="s2">&quot;after convolution of the </span><span class="si">{0}</span><span class="s2"> ROI and the </span><span class="si">{1}</span><span class="s2"> &quot;</span>
                        <span class="s2">&quot;data&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">roi_file</span><span class="p">,</span> <span class="n">parametric_map</span><span class="p">)</span>
                    <span class="p">)</span>
                    <span class="n">mean_result</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">std_result</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">mean_result</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="n">result</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
                    <span class="n">std_result</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="n">result</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>

                <span class="k">for</span> <span class="n">calculation</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">,</span> <span class="s2">&quot;std&quot;</span><span class="p">]:</span>
                    <span class="n">out_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                        <span class="n">analysis_dir</span><span class="p">,</span>
                        <span class="n">roi_name</span>
                        <span class="o">+</span> <span class="s2">&quot;_&quot;</span>
                        <span class="o">+</span> <span class="n">calculation</span>
                        <span class="o">+</span> <span class="s2">&quot;_&quot;</span>
                        <span class="o">+</span> <span class="n">parameter</span>
                        <span class="o">+</span> <span class="s2">&quot;_&quot;</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">contrast_type</span>
                        <span class="o">+</span> <span class="s2">&quot;.txt&quot;</span><span class="p">,</span>
                    <span class="p">)</span>

                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">out_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">calculation</span> <span class="o">==</span> <span class="s2">&quot;mean&quot;</span><span class="p">:</span>
                            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%.3f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">mean_result</span><span class="p">)</span>

                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%.3f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">std_result</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="PlotSignalROI"><a class="viewcode-back" href="../../../../mia_processes.bricks.reports.html#mia_processes.bricks.reports.processes.PlotSignalROI">[docs]</a><span class="k">class</span> <span class="nc">PlotSignalROI</span><span class="p">(</span><span class="n">ProcessMIA</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    *Plot signals from ROI using a segmentation file with label*</span>

<span class="sd">    Please, see the complete documentation for the `PlotSignalROI brick</span>
<span class="sd">    in the mia_processes website</span>
<span class="sd">    &lt;https://populse.github.io/mia_processes/html/documentation/bricks/preprocess/other/PlotSignalROI.html&gt;`_</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="PlotSignalROI.__init__"><a class="viewcode-back" href="../../../../mia_processes.bricks.reports.html#mia_processes.bricks.reports.processes.PlotSignalROI.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Dedicated to the attributes initialisation / instantiation.</span>

<span class="sd">        The input and output plugs are defined here. The special</span>
<span class="sd">        &#39;self.requirement&#39; attribute (optional) is used to define the</span>
<span class="sd">        third-party products necessary for the running of the brick.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Initialisation of the objects needed for the launch of the brick</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">PlotSignalROI</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1"># Third party softwares required for the execution of the brick</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requirement</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Inputs description</span>
        <span class="n">in_file_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Input image from which the signal has been extracted(a 3D image)&quot;</span>
            <span class="s2">&quot;(a pathlike object or string representing a file).&quot;</span>
        <span class="p">)</span>
        <span class="n">signals_whole_brain_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot; Signal of the in_file in a csv file &quot;</span>
            <span class="s2">&quot;(a pathlike object or string representing a file)&quot;</span>
        <span class="p">)</span>
        <span class="n">labels_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;The label list of the ROI to extract the signal (a list of int)&quot;</span>
        <span class="p">)</span>
        <span class="n">labels_names_desc</span> <span class="o">=</span> <span class="p">()</span>
        <span class="n">rois_files_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;List of the image with each ROI segmented (a list of file)&quot;</span>
        <span class="p">)</span>
        <span class="n">signals_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Extracted signal for each ROI in a csv file &quot;</span>
            <span class="s2">&quot;(a pathlike object or string representing a file)&quot;</span>
        <span class="p">)</span>
        <span class="n">suffix_desc</span> <span class="o">=</span> <span class="s2">&quot;Suffix for outout file ( string)&quot;</span>

        <span class="c1"># Outputs description</span>
        <span class="n">out_png_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Out file (a pathlike object or string representing a file)&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Inputs traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;in_file&quot;</span><span class="p">,</span> <span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">in_file_desc</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;labels&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">Either</span><span class="p">(</span>
                <span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">traits</span><span class="o">.</span><span class="n">Int</span><span class="p">()),</span>
                <span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">traits</span><span class="o">.</span><span class="n">String</span><span class="p">()),</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">labels_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;labels_names&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">(</span>
                <span class="n">traits</span><span class="o">.</span><span class="n">String</span><span class="p">(),</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">labels_names_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;rois_files&quot;</span><span class="p">,</span>
            <span class="n">InputMultiPath</span><span class="p">(</span>
                <span class="n">File</span><span class="p">(),</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">rois_files_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;signals&quot;</span><span class="p">,</span> <span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">signals_desc</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;signals_whole_brain&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">File</span><span class="p">(</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">signals_whole_brain_desc</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;suffix&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">suffix_desc</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># Outputs traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;out_png&quot;</span><span class="p">,</span> <span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">out_png_desc</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">init_default_traits</span><span class="p">()</span></div>

<div class="viewcode-block" id="PlotSignalROI.list_outputs"><a class="viewcode-back" href="../../../../mia_processes.bricks.reports.html#mia_processes.bricks.reports.processes.PlotSignalROI.list_outputs">[docs]</a>    <span class="k">def</span> <span class="nf">list_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_plugged</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Dedicated to the initialisation step of the brick.</span>

<span class="sd">        The main objective of this method is to produce the outputs of the</span>
<span class="sd">        bricks (self.outputs) and the associated tags (self.inheritance_dic),</span>
<span class="sd">        if defined here. To work properly this method must return</span>
<span class="sd">        self.make_initResult() object.</span>

<span class="sd">        :param is_plugged: the state, linked or not, of the plugs.</span>
<span class="sd">        :returns: a dictionary with requirement, outputs and inheritance_dict.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Using the inheritance to ProcessMIA class, list_outputs method</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">PlotSignalROI</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">list_outputs</span><span class="p">()</span>

        <span class="c1"># Outputs definition</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_file</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">:</span>
                <span class="n">valid_ext</span><span class="p">,</span> <span class="n">in_ext</span><span class="p">,</span> <span class="n">file_name</span> <span class="o">=</span> <span class="n">checkFileExt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_file</span><span class="p">,</span> <span class="n">EXT</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_ext</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="s2">&quot;PlotSignalROI brick: &quot;</span>
                        <span class="s2">&quot;The input image format is not recognized...!&quot;</span>
                    <span class="p">)</span>
                    <span class="k">return</span>
                <span class="n">labels</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span><span class="p">:</span>
                    <span class="n">labels</span> <span class="o">=</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">list_label</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels_names</span><span class="p">:</span>
                        <span class="n">list_label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels_names</span>
                    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">:</span>
                        <span class="n">list_label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span>
                    <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">list_label</span><span class="p">:</span>
                        <span class="n">labels</span> <span class="o">+=</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;out_png&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span>
                    <span class="n">file_name</span> <span class="o">+</span> <span class="s2">&quot;_extracted_signals&quot;</span> <span class="o">+</span> <span class="n">labels</span> <span class="o">+</span> <span class="s2">&quot;.png&quot;</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">tags_inheritance</span><span class="p">(</span>
                        <span class="n">in_file</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">in_file</span><span class="p">,</span>
                        <span class="n">out_file</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;out_png&quot;</span><span class="p">],</span>
                    <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s2">&quot;PlotSignalROI brick: &quot;</span>
                    <span class="s2">&quot;No output_directory was found...!</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="k">return</span>

        <span class="c1"># Return the requirement, outputs and inheritance_dict</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_initResult</span><span class="p">()</span></div>

<div class="viewcode-block" id="PlotSignalROI.run_process_mia"><a class="viewcode-back" href="../../../../mia_processes.bricks.reports.html#mia_processes.bricks.reports.processes.PlotSignalROI.run_process_mia">[docs]</a>    <span class="k">def</span> <span class="nf">run_process_mia</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Dedicated to the process launch step of the brick.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">PlotSignalROI</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">run_process_mia</span><span class="p">()</span>
        <span class="n">color</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;r&quot;</span><span class="p">,</span>
            <span class="s2">&quot;g&quot;</span><span class="p">,</span>
            <span class="s2">&quot;b&quot;</span><span class="p">,</span>
            <span class="s2">&quot;c&quot;</span><span class="p">,</span>
            <span class="s2">&quot;m&quot;</span><span class="p">,</span>
            <span class="s2">&quot;y&quot;</span><span class="p">,</span>
            <span class="s2">&quot;fuchsia&quot;</span><span class="p">,</span>
            <span class="s2">&quot;salmon&quot;</span><span class="p">,</span>
            <span class="s2">&quot;yellowgreen&quot;</span><span class="p">,</span>
            <span class="s2">&quot;teal&quot;</span><span class="p">,</span>
            <span class="s2">&quot;darkorange&quot;</span><span class="p">,</span>
            <span class="s2">&quot;magenta&quot;</span><span class="p">,</span>
            <span class="s2">&quot;navy&quot;</span><span class="p">,</span>
            <span class="s2">&quot;olive&quot;</span><span class="p">,</span>
            <span class="s2">&quot;gold&quot;</span><span class="p">,</span>
            <span class="s2">&quot;turquoise&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">color</span><span class="p">):</span>
            <span class="n">color</span> <span class="o">+=</span> <span class="n">color</span>
        <span class="c1"># Create fig</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">28</span><span class="p">,</span> <span class="mi">20</span><span class="p">))</span>
        <span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot2grid</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">colspan</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">rowspan</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">ax4</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot2grid</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">colspan</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">rowspan</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">ax2</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot2grid</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">colspan</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">rowspan</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">ax3</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot2grid</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">colspan</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">rowspan</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Create image with all the roi and plot it</span>
        <span class="n">concate_roi</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rois_files</span><span class="p">,</span> <span class="n">TraitListObject</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">roi</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rois_files</span><span class="p">:</span>
                <span class="n">roi_volume</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">roi</span><span class="p">)</span><span class="o">.</span><span class="n">dataobj</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">concate_roi</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">concate_roi</span> <span class="o">=</span> <span class="n">roi_volume</span> <span class="o">&gt;</span> <span class="mi">0</span>
                <span class="n">concate_roi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">roi_volume</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">roi_volume</span><span class="p">,</span> <span class="n">concate_roi</span><span class="p">)</span>
                <span class="n">affine</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">roi</span><span class="p">)</span><span class="o">.</span><span class="n">affine</span>
                <span class="n">header</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">roi</span><span class="p">)</span><span class="o">.</span><span class="n">header</span>
            <span class="n">concate_roi_image</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">Nifti1Image</span><span class="p">(</span>
                <span class="n">concate_roi</span><span class="p">,</span> <span class="n">affine</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">header</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">concate_roi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rois_files</span>
        <span class="n">valid_ext</span><span class="p">,</span> <span class="n">in_ext</span><span class="p">,</span> <span class="n">file_name</span> <span class="o">=</span> <span class="n">checkFileExt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_file</span><span class="p">,</span> <span class="n">EXT</span><span class="p">)</span>

        <span class="n">image</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_file</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="c1"># 3D image</span>
            <span class="n">bg_image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_file</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="c1"># 4D image</span>
            <span class="n">volume</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">dataobj</span><span class="p">)</span>
            <span class="n">first_volume</span> <span class="o">=</span> <span class="n">volume</span><span class="o">.</span><span class="n">copy</span><span class="p">()[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">bg_image</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">Nifti1Image</span><span class="p">(</span><span class="n">first_volume</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">affine</span><span class="p">)</span>

        <span class="n">plotting</span><span class="o">.</span><span class="n">plot_roi</span><span class="p">(</span>
            <span class="n">roi_img</span><span class="o">=</span><span class="n">concate_roi_image</span><span class="p">,</span>
            <span class="n">bg_img</span><span class="o">=</span><span class="n">bg_image</span><span class="p">,</span>
            <span class="n">title</span><span class="o">=</span><span class="s2">&quot;ROI&quot;</span><span class="p">,</span>
            <span class="n">axes</span><span class="o">=</span><span class="n">ax1</span><span class="p">,</span>
            <span class="n">colorbar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">txt_correspondence</span> <span class="o">=</span> <span class="s2">&quot;Colorbar correspondence:</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">list_labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels_names</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">:</span>
            <span class="n">list_labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels_names</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">):</span>
                <span class="n">txt_correspondence</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2"> : </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">labels_names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">txt_correspondence_ax</span> <span class="o">=</span> <span class="n">ax4</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
                <span class="mi">0</span><span class="p">,</span>
                <span class="mi">1</span><span class="p">,</span>
                <span class="n">txt_correspondence</span><span class="p">,</span>
                <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
                <span class="n">va</span><span class="o">=</span><span class="s2">&quot;top&quot;</span><span class="p">,</span>
                <span class="n">wrap</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">transform</span><span class="o">=</span><span class="n">ax4</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span>
                <span class="n">fontsize</span><span class="o">=</span><span class="mi">13</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">ax4</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
            <span class="n">ax4</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
            <span class="n">ax4</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
            <span class="n">txt_correspondence_ax</span><span class="o">.</span><span class="n">_get_wrap_line_width</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">ax4</span><span class="o">.</span><span class="n">bbox</span><span class="o">.</span><span class="n">width</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="c1"># Plot all signals</span>
        <span class="c1"># And create txt with average signal for each roi</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">signals_whole_brain</span><span class="p">:</span>
            <span class="n">signals_whole_brain_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">signals_whole_brain</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span>
            <span class="p">)</span>
            <span class="n">signals_whole_brain</span> <span class="o">=</span> <span class="n">signals_whole_brain_df</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
            <span class="n">average_signal_whole_brain</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">signals_whole_brain</span><span class="p">)</span>
            <span class="n">txt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Mean signal : </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">average_signal_whole_brain</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span>
        <span class="n">signals_roi_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">signals</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">signals_roi</span> <span class="o">=</span> <span class="n">signals_roi_df</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">signals_roi</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">signals_roi</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># 3D image</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">signals_roi</span><span class="p">)</span>
                <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                    <span class="mi">0</span><span class="p">,</span>
                    <span class="n">signals_roi</span><span class="p">,</span>
                    <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span>
                    <span class="n">markersize</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                    <span class="n">markeredgecolor</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="n">markerfacecolor</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="n">label</span><span class="o">=</span><span class="n">list_labels</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># 4D image</span>
                <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                    <span class="n">signals_roi</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                    <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="n">label</span><span class="o">=</span><span class="n">list_labels</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="p">)</span>
            <span class="n">average</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">signals_roi</span><span class="p">)</span>
            <span class="n">txt</span> <span class="o">+=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> </span><span class="se">\n</span><span class="s2">Mean signal ROI </span><span class="si">{</span><span class="n">list_labels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> : </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">average</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">signals_roi</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">indice</span><span class="p">,</span> <span class="n">signals</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">signals_roi</span><span class="p">):</span>
                <span class="n">label</span> <span class="o">=</span> <span class="n">list_labels</span><span class="p">[</span><span class="n">indice</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">signals_roi</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="c1"># 3D image</span>
                    <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                        <span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="p">[</span><span class="n">signals</span><span class="p">],</span>
                        <span class="n">marker</span><span class="o">=</span><span class="s2">&quot;o&quot;</span><span class="p">,</span>
                        <span class="n">markersize</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                        <span class="n">markeredgecolor</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="n">indice</span><span class="p">],</span>
                        <span class="n">markerfacecolor</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="n">indice</span><span class="p">],</span>
                        <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># 4D image</span>
                    <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                        <span class="n">signals</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">[</span><span class="n">indice</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span>
                    <span class="p">)</span>
                <span class="n">average</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">signals</span><span class="p">)</span>
                <span class="n">txt</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> </span><span class="se">\n</span><span class="s2">Mean signal ROI </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2"> : </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">average</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Average signal </span><span class="si">{</span><span class="n">file_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">25</span><span class="p">)</span>
        <span class="n">txt</span> <span class="o">=</span> <span class="n">ax3</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="n">txt</span><span class="p">,</span>
            <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
            <span class="n">va</span><span class="o">=</span><span class="s2">&quot;top&quot;</span><span class="p">,</span>
            <span class="n">wrap</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">transform</span><span class="o">=</span><span class="n">ax3</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span>
            <span class="n">fontsize</span><span class="o">=</span><span class="mi">13</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">txt</span><span class="o">.</span><span class="n">_get_wrap_line_width</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">ax3</span><span class="o">.</span><span class="n">bbox</span><span class="o">.</span><span class="n">width</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;volumes&quot;</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;signals&quot;</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.04</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper left&quot;</span><span class="p">)</span>
        <span class="n">ax3</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
        <span class="n">ax3</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
        <span class="n">ax3</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">out_png</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="Result_collector"><a class="viewcode-back" href="../../../../mia_processes.bricks.reports.html#mia_processes.bricks.reports.processes.Result_collector">[docs]</a><span class="k">class</span> <span class="nc">Result_collector</span><span class="p">(</span><span class="n">ProcessMIA</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    *Save a file.xlm with the data collection for a patient*</span>

<span class="sd">    - To work correctly, the database entry for the first element of</span>
<span class="sd">      parameter_files must have the &quot;PatientName&quot; tag filled in.</span>
<span class="sd">    - The PatientName_data/results_aggregation directory is created to</span>
<span class="sd">      receive the results. If this directory exists at runtime, new results</span>
<span class="sd">      can overwrite old results with the same name.</span>
<span class="sd">    - To work correctly, the name of each file in parameter_files must be</span>
<span class="sd">      exactly like this:</span>

<span class="sd">          ``roi`` _ ``hemi`` _ ``calcul`` _ ``param`` _ ``contrast`` .txt,</span>
<span class="sd">          where:</span>

<span class="sd">              - roi: region of interest (ex. ACA)</span>
<span class="sd">              - hemi: hemisphere (ex. L)</span>
<span class="sd">              - calcul: type of calcul (ex. mean)</span>
<span class="sd">              - param: the parameter studied (ex. spmT)</span>
<span class="sd">              - contrast: the type of contrast/effect used (ex. BOLD)</span>

<span class="sd">    Please, see the complete documentation for the `Result_collector</span>
<span class="sd">    brick in the mia_processes website</span>
<span class="sd">    &lt;https://populse.github.io/mia_processes/html/documentation/bricks/reports/Result_collector.html&gt;`_</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Result_collector.__init__"><a class="viewcode-back" href="../../../../mia_processes.bricks.reports.html#mia_processes.bricks.reports.processes.Result_collector.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Dedicated to the attributes initialisation/instantiation.</span>

<span class="sd">        The input and output plugs are defined here. The special</span>
<span class="sd">        &#39;self.requirement&#39; attribute (optional) is used to define the</span>
<span class="sd">        third-party products necessary for the running of the brick.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Initialisation of the objects needed for the launch of the brick</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Result_collector</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1"># Inputs description</span>
        <span class="n">parameter_files_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;A list of .txt files. Each file contains one (and &quot;</span>
            <span class="s2">&quot;only one) value. The name of each file is used to &quot;</span>
            <span class="s2">&quot;define this value. The name must exactly be like &quot;</span>
            <span class="s2">&quot;this: roi_hemi_calcul_param_contrast&quot;</span>
        <span class="p">)</span>
        <span class="n">laterality_index_desc</span> <span class="o">=</span> <span class="s2">&quot;Calculates the laterality indexes (a boolean)&quot;</span>
        <span class="n">patient_info_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;A dictionary whose keys/values correspond to &quot;</span>
            <span class="s2">&quot;information about the patient &quot;</span>
            <span class="s2">&quot;(e.g. {&quot;</span>
            <span class="s2">&quot;&#39;PatientRef&#39;: &#39;sub_1&#39;,&#39;Pathology&#39;: &#39;ACMD&#39;, &quot;</span>
            <span class="s2">&quot;&#39;Age&#39;: 64, &#39;Sex&#39;: &#39;M&#39;, &#39;MR&#39;: &#39;3T&#39;, &quot;</span>
            <span class="s2">&quot;&#39;Gas&#39;: &#39;BACTAL&#39;, &#39;GasAdmin&#39;: &#39;MASK&#39;}&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Outputs description</span>
        <span class="n">out_files_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;A list of .xml files containing a summary of the input parameters&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Inputs traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;parameter_files&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">(</span>
                <span class="n">traits</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">exists</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">parameter_files_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parameter_files</span> <span class="o">=</span> <span class="n">Undefined</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;laterality_index&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">Bool</span><span class="p">(</span>
                <span class="n">default_value</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">laterality_index_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;patient_info&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">Dict</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">patient_info_desc</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">patient_info</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
            <span class="n">PatientRef</span><span class="o">=</span><span class="n">Undefined</span><span class="p">,</span>
            <span class="n">Pathology</span><span class="o">=</span><span class="n">Undefined</span><span class="p">,</span>
            <span class="n">Age</span><span class="o">=</span><span class="n">Undefined</span><span class="p">,</span>
            <span class="n">Sex</span><span class="o">=</span><span class="n">Undefined</span><span class="p">,</span>
            <span class="n">MR</span><span class="o">=</span><span class="n">Undefined</span><span class="p">,</span>
            <span class="n">Gas</span><span class="o">=</span><span class="n">Undefined</span><span class="p">,</span>
            <span class="n">GasAdmin</span><span class="o">=</span><span class="n">Undefined</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Outputs traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;out_files&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">traits</span><span class="o">.</span><span class="n">File</span><span class="p">(),</span> <span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">out_files_desc</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">out_files</span> <span class="o">=</span> <span class="n">Undefined</span>

        <span class="c1"># Special parameter used as a messenger for the run_process_mia method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;dict4runtime&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">Dict</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">userlevel</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">init_default_traits</span><span class="p">()</span></div>

<div class="viewcode-block" id="Result_collector.list_outputs"><a class="viewcode-back" href="../../../../mia_processes.bricks.reports.html#mia_processes.bricks.reports.processes.Result_collector.list_outputs">[docs]</a>    <span class="k">def</span> <span class="nf">list_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_plugged</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Dedicated to the initialisation step of the brick.</span>

<span class="sd">        The main objective of this method is to produce the outputs of the</span>
<span class="sd">        bricks (self.outputs) and the associated tags (self.inheritance_dic),</span>
<span class="sd">        if defined here. In order not to include an output in the database,</span>
<span class="sd">        this output must be a value of the optional key &#39;notInDb&#39; of the</span>
<span class="sd">        self.outputs dictionary. To work properly this method must return</span>
<span class="sd">        self.make_initResult() object.</span>

<span class="sd">        :param is_plugged: the state, linked or not, of the plugs.</span>
<span class="sd">        :returns: a dictionary with requirement, outputs and inheritance_dict.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Using the inheritance to ProcessMIA class, list_outputs method</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Result_collector</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">list_outputs</span><span class="p">()</span>

        <span class="c1"># Outputs definition and tags inheritance (optional)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameter_files</span> <span class="o">!=</span> <span class="n">Undefined</span><span class="p">:</span>
            <span class="c1"># FIXME 1: We retrieve the name of the patient from the first</span>
            <span class="c1">#          element of parameter_files. This is only fine if all the</span>
            <span class="c1">#          elements of parameter_files correspond to the same</span>
            <span class="c1">#          patient.</span>
            <span class="c1"># FIXME 2: The data should be anonymized and we should use</span>
            <span class="c1">#          PatientRef instead of PatientName !</span>
            <span class="n">patient_name</span> <span class="o">=</span> <span class="n">get_dbFieldValue</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameter_files</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;PatientName&quot;</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">patient_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Result_collector brick:</span><span class="se">\n</span><span class="s2">The PatientName tag is not &quot;</span>
                    <span class="s2">&quot;filled in the database for the </span><span class="si">{}</span><span class="s2"> file ...</span><span class="se">\n</span><span class="s2"> The &quot;</span>
                    <span class="s2">&quot;initialization is &quot;</span>
                    <span class="s2">&quot;aborted...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameter_files</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="p">)</span>

                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_initResult</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">dict4runtime</span><span class="p">[</span><span class="s2">&quot;patient_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">patient_name</span>

            <span class="n">aggreg_results_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span>
                <span class="n">patient_name</span> <span class="o">+</span> <span class="s2">&quot;_data&quot;</span><span class="p">,</span>
                <span class="s2">&quot;results_aggregation&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">out_files</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="n">res</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

            <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameter_files</span><span class="p">:</span>
                <span class="c1"># FIXME: Ideally, we should make sure that they are well</span>
                <span class="c1">#          roi, hemi, etc ... This is difficult to achieve for</span>
                <span class="c1">#          this last point ...</span>
                <span class="c1"># roi: region of interest (ex. ACA)</span>
                <span class="c1"># hemi: hemisphere (ex. L)</span>
                <span class="c1"># calcul: type of calcul (ex. mean)</span>
                <span class="c1"># param: the parameter studied (ex. spmT)</span>
                <span class="c1"># contrast: The type of contrast/effect used (ex. BOLD)</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">roi</span><span class="p">,</span> <span class="n">hemi</span><span class="p">,</span> <span class="n">calcul</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">contrast</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                    <span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>

                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Result_collector brick: initialization stopped &quot;</span>
                        <span class="s2">&quot;due to the following issue:</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="s2">&quot; </span><span class="si">{}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                    <span class="p">)</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_initResult</span><span class="p">()</span>

                <span class="n">out_files</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                        <span class="n">aggreg_results_dir</span><span class="p">,</span>
                        <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">_</span><span class="si">{1}</span><span class="s2">_</span><span class="si">{2}</span><span class="s2">.xls&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">contrast</span><span class="p">,</span> <span class="n">calcul</span><span class="p">,</span> <span class="n">param</span><span class="p">),</span>
                    <span class="p">)</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="n">contrast</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
                    <span class="n">res</span><span class="p">[</span><span class="n">contrast</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

                <span class="k">if</span> <span class="n">param</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">res</span><span class="p">[</span><span class="n">contrast</span><span class="p">]:</span>
                    <span class="n">res</span><span class="p">[</span><span class="n">contrast</span><span class="p">][</span><span class="n">param</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

                <span class="k">if</span> <span class="n">calcul</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">res</span><span class="p">[</span><span class="n">contrast</span><span class="p">][</span><span class="n">param</span><span class="p">]:</span>
                    <span class="n">res</span><span class="p">[</span><span class="n">contrast</span><span class="p">][</span><span class="n">param</span><span class="p">][</span><span class="n">calcul</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

                <span class="k">if</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">laterality_index</span> <span class="ow">is</span> <span class="kc">True</span>
                    <span class="ow">and</span> <span class="s2">&quot;IL_&quot;</span> <span class="o">+</span> <span class="n">calcul</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">res</span><span class="p">[</span><span class="n">contrast</span><span class="p">][</span><span class="n">param</span><span class="p">]</span>
                <span class="p">):</span>
                    <span class="n">res</span><span class="p">[</span><span class="n">contrast</span><span class="p">][</span><span class="n">param</span><span class="p">][</span><span class="s2">&quot;IL_&quot;</span> <span class="o">+</span> <span class="n">calcul</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

                <span class="k">if</span> <span class="n">roi</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">res</span><span class="p">[</span><span class="n">contrast</span><span class="p">][</span><span class="n">param</span><span class="p">][</span><span class="n">calcul</span><span class="p">]:</span>
                    <span class="n">res</span><span class="p">[</span><span class="n">contrast</span><span class="p">][</span><span class="n">param</span><span class="p">][</span><span class="n">calcul</span><span class="p">][</span><span class="n">roi</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

                <span class="k">if</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">laterality_index</span> <span class="ow">is</span> <span class="kc">True</span>
                    <span class="ow">and</span> <span class="n">roi</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">res</span><span class="p">[</span><span class="n">contrast</span><span class="p">][</span><span class="n">param</span><span class="p">][</span><span class="s2">&quot;IL_&quot;</span> <span class="o">+</span> <span class="n">calcul</span><span class="p">]</span>
                <span class="p">):</span>
                    <span class="n">res</span><span class="p">[</span><span class="n">contrast</span><span class="p">][</span><span class="n">param</span><span class="p">][</span><span class="s2">&quot;IL_&quot;</span> <span class="o">+</span> <span class="n">calcul</span><span class="p">][</span><span class="n">roi</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

                <span class="k">if</span> <span class="n">hemi</span> <span class="ow">in</span> <span class="n">res</span><span class="p">[</span><span class="n">contrast</span><span class="p">][</span><span class="n">param</span><span class="p">][</span><span class="n">calcul</span><span class="p">][</span><span class="n">roi</span><span class="p">]:</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Result_collector brick:</span><span class="se">\n</span><span class="s2">The data for &quot;</span>
                        <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">-</span><span class="si">{1}</span><span class="s2">-</span><span class="si">{2}</span><span class="s2">-</span><span class="si">{3}</span><span class="s2">-</span><span class="si">{4}</span><span class="s2"> in </span><span class="si">{5}</span><span class="s2"> already exists &quot;</span>
                        <span class="s2">&quot;in the final result. Overwriting with the new &quot;</span>
                        <span class="s2">&quot;data ...</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">contrast</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">calcul</span><span class="p">,</span> <span class="n">roi</span><span class="p">,</span> <span class="n">hemi</span><span class="p">,</span> <span class="n">data</span>
                        <span class="p">)</span>
                    <span class="p">)</span>

                <span class="n">res</span><span class="p">[</span><span class="n">contrast</span><span class="p">][</span><span class="n">param</span><span class="p">][</span><span class="n">calcul</span><span class="p">][</span><span class="n">roi</span><span class="p">][</span><span class="n">hemi</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="k">if</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">laterality_index</span> <span class="ow">is</span> <span class="kc">True</span>
                    <span class="ow">and</span> <span class="s2">&quot;L&quot;</span> <span class="ow">in</span> <span class="n">res</span><span class="p">[</span><span class="n">contrast</span><span class="p">][</span><span class="n">param</span><span class="p">][</span><span class="n">calcul</span><span class="p">][</span><span class="n">roi</span><span class="p">]</span>
                    <span class="ow">and</span> <span class="s2">&quot;R&quot;</span> <span class="ow">in</span> <span class="n">res</span><span class="p">[</span><span class="n">contrast</span><span class="p">][</span><span class="n">param</span><span class="p">][</span><span class="n">calcul</span><span class="p">][</span><span class="n">roi</span><span class="p">]</span>
                <span class="p">):</span>
                    <span class="n">out_files</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                            <span class="n">aggreg_results_dir</span><span class="p">,</span>
                            <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">_</span><span class="si">{1}</span><span class="s2">_</span><span class="si">{2}</span><span class="s2">.xls&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="n">contrast</span><span class="p">,</span> <span class="s2">&quot;IL_&quot;</span> <span class="o">+</span> <span class="n">calcul</span><span class="p">,</span> <span class="n">param</span>
                            <span class="p">),</span>
                        <span class="p">)</span>
                    <span class="p">)</span>

            <span class="k">if</span> <span class="n">out_files</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;out_files&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">out_files</span><span class="p">)</span>

            <span class="c1"># FIXME: the data should be anonymized and we should use PatientRef</span>
            <span class="c1">#        instead of PatientName !</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">patient_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;PatientRef&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span>
                <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">patient_info</span><span class="p">[</span><span class="s2">&quot;PatientRef&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">Undefined</span>
            <span class="p">):</span>
                <span class="n">patient_ref</span> <span class="o">=</span> <span class="n">get_dbFieldValue</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameter_files</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;PatientRef&quot;</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="n">patient_ref</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">patient_info</span><span class="p">[</span><span class="s2">&quot;PatientRef&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">patient_name</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">patient_info</span><span class="p">[</span><span class="s2">&quot;PatientRef&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">patient_ref</span>

            <span class="k">if</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">patient_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Pathology&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span>
                <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">patient_info</span><span class="p">[</span><span class="s2">&quot;Pathology&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">Undefined</span>
            <span class="p">):</span>
                <span class="n">pathology</span> <span class="o">=</span> <span class="n">get_dbFieldValue</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameter_files</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;Pathology&quot;</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="n">pathology</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">patient_info</span><span class="p">[</span><span class="s2">&quot;Pathology&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Undefined&quot;</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">patient_info</span><span class="p">[</span><span class="s2">&quot;Pathology&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pathology</span>

            <span class="k">if</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">patient_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Age&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span>
                <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">patient_info</span><span class="p">[</span><span class="s2">&quot;Age&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">Undefined</span>
            <span class="p">):</span>
                <span class="n">age</span> <span class="o">=</span> <span class="n">get_dbFieldValue</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameter_files</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;Age&quot;</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="n">age</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">patient_info</span><span class="p">[</span><span class="s2">&quot;Age&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Undefined&quot;</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">patient_info</span><span class="p">[</span><span class="s2">&quot;Age&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">age</span>

            <span class="k">if</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">patient_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Sex&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span>
                <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">patient_info</span><span class="p">[</span><span class="s2">&quot;Sex&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">Undefined</span>
            <span class="p">):</span>
                <span class="n">sex</span> <span class="o">=</span> <span class="n">get_dbFieldValue</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameter_files</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;Sex&quot;</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="n">sex</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">patient_info</span><span class="p">[</span><span class="s2">&quot;Sex&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Undefined&quot;</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">patient_info</span><span class="p">[</span><span class="s2">&quot;Sex&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sex</span>

            <span class="k">if</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">patient_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;MR&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span>
                <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">patient_info</span><span class="p">[</span><span class="s2">&quot;MR&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">Undefined</span>
            <span class="p">):</span>
                <span class="n">mr</span> <span class="o">=</span> <span class="n">get_dbFieldValue</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameter_files</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;MR&quot;</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="n">mr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">patient_info</span><span class="p">[</span><span class="s2">&quot;MR&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Undefined&quot;</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">patient_info</span><span class="p">[</span><span class="s2">&quot;MR&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mr</span>

            <span class="k">if</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">patient_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Gas&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span>
                <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">patient_info</span><span class="p">[</span><span class="s2">&quot;Gas&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">Undefined</span>
            <span class="p">):</span>
                <span class="n">gas</span> <span class="o">=</span> <span class="n">get_dbFieldValue</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameter_files</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;Gas&quot;</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="n">gas</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">patient_info</span><span class="p">[</span><span class="s2">&quot;Gas&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Undefined&quot;</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">patient_info</span><span class="p">[</span><span class="s2">&quot;Gas&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gas</span>

            <span class="k">if</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">patient_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;GasAdmin&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span>
                <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">patient_info</span><span class="p">[</span><span class="s2">&quot;GasAdmin&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">Undefined</span>
            <span class="p">):</span>
                <span class="n">gas_admin</span> <span class="o">=</span> <span class="n">get_dbFieldValue</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameter_files</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;GasAdmin&quot;</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="n">gas_admin</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">patient_info</span><span class="p">[</span><span class="s2">&quot;GasAdmin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Undefined&quot;</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">patient_info</span><span class="p">[</span><span class="s2">&quot;GasAdmin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gas_admin</span>

        <span class="c1"># Return the requirement, outputs and inheritance_dict</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_initResult</span><span class="p">()</span></div>

<div class="viewcode-block" id="Result_collector.run_process_mia"><a class="viewcode-back" href="../../../../mia_processes.bricks.reports.html#mia_processes.bricks.reports.processes.Result_collector.run_process_mia">[docs]</a>    <span class="k">def</span> <span class="nf">run_process_mia</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Dedicated to the process launch step of the brick.&quot;&quot;&quot;</span>
        <span class="c1"># No need the next line (we don&#39;t use self.process and SPM)</span>
        <span class="c1"># super(Result_collector, self).run_process_mia()</span>

        <span class="n">pat_name_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dict4runtime</span><span class="p">[</span><span class="s2">&quot;patient_name&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_data&quot;</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">pat_name_dir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">pat_name_dir</span><span class="p">)</span>

        <span class="n">aggreg_results_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pat_name_dir</span><span class="p">,</span> <span class="s2">&quot;results_aggregation&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">aggreg_results_dir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">aggreg_results_dir</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;Result_collector brick warning: The </span><span class="si">{}</span><span class="s2"> directory exists &quot;</span>
                <span class="s2">&quot;before the start of the calculation. Its contents can be &quot;</span>
                <span class="s2">&quot;overwritten by the result of the current &quot;</span>
                <span class="s2">&quot;calculation ...!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">aggreg_results_dir</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="n">res</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameter_files</span><span class="p">:</span>
            <span class="c1"># roi: region of interest (ex. ACA)</span>
            <span class="c1"># hemi: hemisphere (ex. L)</span>
            <span class="c1"># calcul: type of calcul (ex. mean)</span>
            <span class="c1"># param: the parameter studied (ex. spmT)</span>
            <span class="c1"># contrast: The type of contrast/effect used (ex. BOLD)</span>
            <span class="n">roi</span><span class="p">,</span> <span class="n">hemi</span><span class="p">,</span> <span class="n">calcul</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">contrast</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">contrast</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
                <span class="n">res</span><span class="p">[</span><span class="n">contrast</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="k">if</span> <span class="n">param</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">res</span><span class="p">[</span><span class="n">contrast</span><span class="p">]:</span>
                <span class="n">res</span><span class="p">[</span><span class="n">contrast</span><span class="p">][</span><span class="n">param</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="k">if</span> <span class="n">calcul</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">res</span><span class="p">[</span><span class="n">contrast</span><span class="p">][</span><span class="n">param</span><span class="p">]:</span>
                <span class="n">res</span><span class="p">[</span><span class="n">contrast</span><span class="p">][</span><span class="n">param</span><span class="p">][</span><span class="n">calcul</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="k">if</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">laterality_index</span> <span class="ow">is</span> <span class="kc">True</span>
                <span class="ow">and</span> <span class="s2">&quot;IL_&quot;</span> <span class="o">+</span> <span class="n">calcul</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">res</span><span class="p">[</span><span class="n">contrast</span><span class="p">][</span><span class="n">param</span><span class="p">]</span>
            <span class="p">):</span>
                <span class="n">res</span><span class="p">[</span><span class="n">contrast</span><span class="p">][</span><span class="n">param</span><span class="p">][</span><span class="s2">&quot;IL_&quot;</span> <span class="o">+</span> <span class="n">calcul</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="k">if</span> <span class="n">roi</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">res</span><span class="p">[</span><span class="n">contrast</span><span class="p">][</span><span class="n">param</span><span class="p">][</span><span class="n">calcul</span><span class="p">]:</span>
                <span class="n">res</span><span class="p">[</span><span class="n">contrast</span><span class="p">][</span><span class="n">param</span><span class="p">][</span><span class="n">calcul</span><span class="p">][</span><span class="n">roi</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="k">if</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">laterality_index</span> <span class="ow">is</span> <span class="kc">True</span>
                <span class="ow">and</span> <span class="n">roi</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">res</span><span class="p">[</span><span class="n">contrast</span><span class="p">][</span><span class="n">param</span><span class="p">][</span><span class="s2">&quot;IL_&quot;</span> <span class="o">+</span> <span class="n">calcul</span><span class="p">]</span>
            <span class="p">):</span>
                <span class="n">res</span><span class="p">[</span><span class="n">contrast</span><span class="p">][</span><span class="n">param</span><span class="p">][</span><span class="s2">&quot;IL_&quot;</span> <span class="o">+</span> <span class="n">calcul</span><span class="p">][</span><span class="n">roi</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f_read</span><span class="p">:</span>
                    <span class="n">data_val</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">f_read</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>

            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Result_collector brick:</span><span class="se">\n</span><span class="s2">No result &quot;</span>
                    <span class="s2">&quot;found in </span><span class="si">{}</span><span class="s2"> ...</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="n">data_val</span> <span class="o">=</span> <span class="s2">&quot;Undefined&quot;</span>

            <span class="k">if</span> <span class="n">hemi</span> <span class="ow">in</span> <span class="n">res</span><span class="p">[</span><span class="n">contrast</span><span class="p">][</span><span class="n">param</span><span class="p">][</span><span class="n">calcul</span><span class="p">][</span><span class="n">roi</span><span class="p">]:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Result_collector brick:</span><span class="se">\n</span><span class="s2">The data for </span><span class="si">{0}</span><span class="s2">-</span><span class="si">{1}</span><span class="s2">-</span><span class="si">{2}</span><span class="s2">-</span><span class="si">{3}</span><span class="s2">&quot;</span>
                    <span class="s2">&quot;-</span><span class="si">{4}</span><span class="s2"> in </span><span class="si">{5}</span><span class="s2"> already exists in the final result. &quot;</span>
                    <span class="s2">&quot;Overwriting with the new data ...</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">contrast</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="n">calcul</span><span class="p">,</span> <span class="n">roi</span><span class="p">,</span> <span class="n">hemi</span><span class="p">,</span> <span class="n">data</span>
                    <span class="p">)</span>
                <span class="p">)</span>

            <span class="n">res</span><span class="p">[</span><span class="n">contrast</span><span class="p">][</span><span class="n">param</span><span class="p">][</span><span class="n">calcul</span><span class="p">][</span><span class="n">roi</span><span class="p">][</span><span class="n">hemi</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_val</span>

            <span class="k">if</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">laterality_index</span> <span class="ow">is</span> <span class="kc">True</span>
                <span class="ow">and</span> <span class="s2">&quot;L&quot;</span> <span class="ow">in</span> <span class="n">res</span><span class="p">[</span><span class="n">contrast</span><span class="p">][</span><span class="n">param</span><span class="p">][</span><span class="n">calcul</span><span class="p">][</span><span class="n">roi</span><span class="p">]</span>
                <span class="ow">and</span> <span class="s2">&quot;R&quot;</span> <span class="ow">in</span> <span class="n">res</span><span class="p">[</span><span class="n">contrast</span><span class="p">][</span><span class="n">param</span><span class="p">][</span><span class="n">calcul</span><span class="p">][</span><span class="n">roi</span><span class="p">]</span>
            <span class="p">):</span>
                <span class="n">left</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="n">contrast</span><span class="p">][</span><span class="n">param</span><span class="p">][</span><span class="n">calcul</span><span class="p">][</span><span class="n">roi</span><span class="p">][</span><span class="s2">&quot;L&quot;</span><span class="p">]</span>
                <span class="n">right</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="n">contrast</span><span class="p">][</span><span class="n">param</span><span class="p">][</span><span class="n">calcul</span><span class="p">][</span><span class="n">roi</span><span class="p">][</span><span class="s2">&quot;R&quot;</span><span class="p">]</span>
                <span class="n">res</span><span class="p">[</span><span class="n">contrast</span><span class="p">][</span><span class="n">param</span><span class="p">][</span><span class="s2">&quot;IL_&quot;</span> <span class="o">+</span> <span class="n">calcul</span><span class="p">][</span><span class="n">roi</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">left</span> <span class="o">-</span> <span class="n">right</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span>
                    <span class="n">left</span> <span class="o">+</span> <span class="n">right</span>
                <span class="p">)</span>

        <span class="k">for</span> <span class="n">contrast</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">res</span><span class="p">[</span><span class="n">contrast</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">calcul</span> <span class="ow">in</span> <span class="n">res</span><span class="p">[</span><span class="n">contrast</span><span class="p">][</span><span class="n">param</span><span class="p">]:</span>
                    <span class="n">out_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                        <span class="n">aggreg_results_dir</span><span class="p">,</span>
                        <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">_</span><span class="si">{1}</span><span class="s2">_</span><span class="si">{2}</span><span class="s2">.xls&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">contrast</span><span class="p">,</span> <span class="n">calcul</span><span class="p">,</span> <span class="n">param</span><span class="p">),</span>
                    <span class="p">)</span>

                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">out_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="se">\t</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;subjects&quot;</span><span class="p">))</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="se">\t</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;patho&quot;</span><span class="p">))</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="se">\t</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;age&quot;</span><span class="p">))</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="se">\t</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;sex&quot;</span><span class="p">))</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="se">\t</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;MR&quot;</span><span class="p">))</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="se">\t</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;Gaz&quot;</span><span class="p">))</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="se">\t</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;Admin&quot;</span><span class="p">))</span>

                        <span class="k">if</span> <span class="ow">not</span> <span class="n">calcul</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;IL_&quot;</span><span class="p">):</span>
                            <span class="k">for</span> <span class="n">roi</span> <span class="ow">in</span> <span class="n">res</span><span class="p">[</span><span class="n">contrast</span><span class="p">][</span><span class="n">param</span><span class="p">][</span><span class="n">calcul</span><span class="p">]:</span>
                                <span class="k">for</span> <span class="n">hemi</span> <span class="ow">in</span> <span class="n">res</span><span class="p">[</span><span class="n">contrast</span><span class="p">][</span><span class="n">param</span><span class="p">][</span><span class="n">calcul</span><span class="p">][</span><span class="n">roi</span><span class="p">]:</span>
                                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                                        <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">_</span><span class="si">{1}</span><span class="s2">_</span><span class="si">{2}</span><span class="se">\t</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                            <span class="n">param</span><span class="p">,</span> <span class="n">roi</span><span class="p">,</span> <span class="n">hemi</span>
                                        <span class="p">)</span>
                                    <span class="p">)</span>

                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">roi</span> <span class="ow">in</span> <span class="n">res</span><span class="p">[</span><span class="n">contrast</span><span class="p">][</span><span class="n">param</span><span class="p">][</span><span class="n">calcul</span><span class="p">]:</span>
                                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">_</span><span class="si">{1}</span><span class="se">\t</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">roi</span><span class="p">))</span>

                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                            <span class="s2">&quot;</span><span class="se">\n</span><span class="si">{0}</span><span class="se">\t</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">patient_info</span><span class="p">[</span><span class="s2">&quot;PatientRef&quot;</span><span class="p">])</span>
                        <span class="p">)</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="se">\t</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">patient_info</span><span class="p">[</span><span class="s2">&quot;Pathology&quot;</span><span class="p">]))</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="se">\t</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">patient_info</span><span class="p">[</span><span class="s2">&quot;Age&quot;</span><span class="p">]))</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="se">\t</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">patient_info</span><span class="p">[</span><span class="s2">&quot;Sex&quot;</span><span class="p">]))</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="se">\t</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">patient_info</span><span class="p">[</span><span class="s2">&quot;MR&quot;</span><span class="p">]))</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="se">\t</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">patient_info</span><span class="p">[</span><span class="s2">&quot;Gas&quot;</span><span class="p">]))</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="se">\t</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">patient_info</span><span class="p">[</span><span class="s2">&quot;GasAdmin&quot;</span><span class="p">]))</span>

                        <span class="k">if</span> <span class="ow">not</span> <span class="n">calcul</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;IL_&quot;</span><span class="p">):</span>
                            <span class="k">for</span> <span class="n">roi</span> <span class="ow">in</span> <span class="n">res</span><span class="p">[</span><span class="n">contrast</span><span class="p">][</span><span class="n">param</span><span class="p">][</span><span class="n">calcul</span><span class="p">]:</span>
                                <span class="k">for</span> <span class="n">hemi</span> <span class="ow">in</span> <span class="n">res</span><span class="p">[</span><span class="n">contrast</span><span class="p">][</span><span class="n">param</span><span class="p">][</span><span class="n">calcul</span><span class="p">][</span><span class="n">roi</span><span class="p">]:</span>
                                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                                        <span class="s2">&quot;</span><span class="si">{0}</span><span class="se">\t</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                            <span class="n">res</span><span class="p">[</span><span class="n">contrast</span><span class="p">][</span><span class="n">param</span><span class="p">][</span><span class="n">calcul</span><span class="p">][</span><span class="n">roi</span><span class="p">][</span>
                                                <span class="n">hemi</span>
                                            <span class="p">]</span>
                                        <span class="p">)</span>
                                    <span class="p">)</span>

                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">roi</span> <span class="ow">in</span> <span class="n">res</span><span class="p">[</span><span class="n">contrast</span><span class="p">][</span><span class="n">param</span><span class="p">][</span><span class="n">calcul</span><span class="p">]:</span>
                                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                                    <span class="s2">&quot;</span><span class="si">{0}</span><span class="se">\t</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                        <span class="n">res</span><span class="p">[</span><span class="n">contrast</span><span class="p">][</span><span class="n">param</span><span class="p">][</span><span class="n">calcul</span><span class="p">][</span><span class="n">roi</span><span class="p">]</span>
                                    <span class="p">)</span>
                                <span class="p">)</span></div></div>


<div class="viewcode-block" id="Spikes"><a class="viewcode-back" href="../../../../mia_processes.bricks.reports.html#mia_processes.bricks.reports.processes.Spikes">[docs]</a><span class="k">class</span> <span class="nc">Spikes</span><span class="p">(</span><span class="n">ProcessMIA</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    *Computes the number of spikes*</span>

<span class="sd">    Please, see the complete documentation for the `Spikes brick in the</span>
<span class="sd">    mia_processes website</span>
<span class="sd">    &lt;https://populse.github.io/mia_processes/html/documentation/bricks/reports/Spikes.html&gt;`_</span>

<span class="sd">    adapted from `mriqc spikes_mask function</span>
<span class="sd">    &lt;https://github.com/nipreps/mriqc/blob/e021008da0a2ef1c48e882baf932139a673349f9/mriqc/workflows/functional.py#L939&gt;`_</span>
<span class="sd">    and</span>
<span class="sd">    `mriqc Spikes class</span>
<span class="sd">    &lt;https://github.com/nipreps/mriqc/blob/e021008da0a2ef1c48e882baf932139a673349f9/mriqc/interfaces/functional.py#L223&gt;`_</span>


<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Spikes.__init__"><a class="viewcode-back" href="../../../../mia_processes.bricks.reports.html#mia_processes.bricks.reports.processes.Spikes.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Dedicated to the attributes initialisation/instantiation.</span>

<span class="sd">        The input and output plugs are defined here. The special</span>
<span class="sd">        &#39;self.requirement&#39; attribute (optional) is used to define the</span>
<span class="sd">        third-party products necessary for the running of the brick.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Initialisation of the objects needed for the launch of the brick</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Spikes</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1"># Third party softwares required for the execution of the brick</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requirement</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Inputs description</span>
        <span class="n">in_file_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;A bold file (a pathlike object or string representing a file).&quot;</span>
        <span class="p">)</span>
        <span class="n">no_zscore_desc</span> <span class="o">=</span> <span class="s2">&quot;Do not zscore (a boolean)&quot;</span>
        <span class="n">detrend_desc</span> <span class="o">=</span> <span class="s2">&quot;Do detrend (a boolean).&quot;</span>
        <span class="n">out_prefix_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Specify the string to be prepended to the &quot;</span>
            <span class="s2">&quot;filenames of the output image file &quot;</span>
            <span class="s2">&quot;(a string).&quot;</span>
        <span class="p">)</span>
        <span class="n">spike_thresh_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;z-score to call one timepoint of one axial&quot;</span>
            <span class="s2">&quot; slice a spike (a float)&quot;</span>
        <span class="p">)</span>
        <span class="n">skip_frames_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;number of frames to skip in the beginning &quot;</span>
            <span class="s2">&quot;of the time series (an int)&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Outputs description</span>
        <span class="n">out_file_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;The output file (a pathlike object or a &quot;</span>
            <span class="s2">&quot;string representing a file).&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Inputs traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;in_file&quot;</span><span class="p">,</span> <span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">in_file_desc</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;no_zscore&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">Bool</span><span class="p">(</span>
                <span class="kc">True</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">no_zscore_desc</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;detrend&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">Bool</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">detrend_desc</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;spike_thresh&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">Float</span><span class="p">(</span>
                <span class="mf">6.0</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">spike_thresh_desc</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;skip_frames&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">Int</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">skip_frames_desc</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;out_prefix&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">String</span><span class="p">(</span>
                <span class="s2">&quot;spikes_&quot;</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">out_prefix_desc</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># Outputs traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;out_file&quot;</span><span class="p">,</span> <span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">out_file_desc</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">init_default_traits</span><span class="p">()</span></div>

<div class="viewcode-block" id="Spikes.list_outputs"><a class="viewcode-back" href="../../../../mia_processes.bricks.reports.html#mia_processes.bricks.reports.processes.Spikes.list_outputs">[docs]</a>    <span class="k">def</span> <span class="nf">list_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_plugged</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Dedicated to the initialisation step of the brick.</span>

<span class="sd">        The main objective of this method is to produce the outputs of the</span>
<span class="sd">        bricks (self.outputs) and the associated tags (self.inheritance_dic),</span>
<span class="sd">        if defined here. In order not to include an output in the database,</span>
<span class="sd">        this output must be a value of the optional key &#39;notInDb&#39; of the</span>
<span class="sd">        self.outputs dictionary. To work properly this method must return</span>
<span class="sd">        self.make_initResult() object.</span>

<span class="sd">        :param is_plugged: the state, linked or not, of the plugs.</span>
<span class="sd">        :returns: a dictionary with requirement, outputs and inheritance_dict.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Using the inheritance to ProcessMIA class, list_outputs method</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Spikes</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">list_outputs</span><span class="p">()</span>

        <span class="c1"># Outputs definition and tags inheritance (optional)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_file</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_prefix</span> <span class="o">==</span> <span class="n">Undefined</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">out_prefix</span> <span class="o">=</span> <span class="s2">&quot;spikes_&quot;</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s2">&quot;Spikes brick: The out_prefix parameter is undefined. &quot;</span>
                    <span class="s2">&quot;Automatically set to &#39;spikes_&#39; ...&quot;</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">:</span>
                <span class="n">valid_ext</span><span class="p">,</span> <span class="n">in_ext</span><span class="p">,</span> <span class="n">fileName</span> <span class="o">=</span> <span class="n">checkFileExt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_file</span><span class="p">,</span> <span class="n">EXT</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_ext</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">The input image format is not recognized ...!&quot;</span><span class="p">)</span>
                    <span class="k">return</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;out_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_prefix</span> <span class="o">+</span> <span class="n">fileName</span> <span class="o">+</span> <span class="s2">&quot;.out&quot;</span>
                <span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No output_directory was found...!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">tags_inheritance</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">in_file</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;out_file&quot;</span><span class="p">],</span>
            <span class="p">)</span>

        <span class="c1"># Return the requirement, outputs and inheritance_dict</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_initResult</span><span class="p">()</span></div>

<div class="viewcode-block" id="Spikes.run_process_mia"><a class="viewcode-back" href="../../../../mia_processes.bricks.reports.html#mia_processes.bricks.reports.processes.Spikes.run_process_mia">[docs]</a>    <span class="k">def</span> <span class="nf">run_process_mia</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Dedicated to the process launch step of the brick.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Spikes</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">run_process_mia</span><span class="p">()</span>

        <span class="n">func_nii</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_file</span><span class="p">)</span>
        <span class="n">func_data</span> <span class="o">=</span> <span class="n">func_nii</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">()</span>
        <span class="n">func_shape</span> <span class="o">=</span> <span class="n">func_data</span><span class="o">.</span><span class="n">shape</span>

        <span class="n">orientation</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">aff2axcodes</span><span class="p">(</span><span class="n">func_nii</span><span class="o">.</span><span class="n">affine</span><span class="p">)</span>

        <span class="n">new_mask_3d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">func_nii</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">3</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">orientation</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;L&quot;</span><span class="p">,</span> <span class="s2">&quot;R&quot;</span><span class="p">]:</span>
            <span class="n">new_mask_3d</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">new_mask_3d</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new_mask_3d</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">new_mask_3d</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">3</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">ntsteps</span> <span class="o">=</span> <span class="n">func_shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">tr</span> <span class="o">=</span> <span class="n">func_nii</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">get_zooms</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">nskip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">skip_frames</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">detrend</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">func_data</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">ntsteps</span><span class="p">)</span>
            <span class="n">clean_data</span> <span class="o">=</span> <span class="n">clean</span><span class="p">(</span><span class="n">data</span><span class="p">[:,</span> <span class="n">nskip</span><span class="p">:]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">t_r</span><span class="o">=</span><span class="n">tr</span><span class="p">,</span> <span class="n">standardize</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
            <span class="n">new_shape</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">func_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">func_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">func_shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                <span class="n">clean_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="n">func_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">func_shape</span><span class="p">)</span>
            <span class="n">func_data</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">nskip</span><span class="p">:]</span> <span class="o">=</span> <span class="n">clean_data</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">new_shape</span><span class="p">)</span>

        <span class="n">mask_data</span> <span class="o">=</span> <span class="n">new_mask_3d</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
        <span class="n">mask_data</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">:</span><span class="n">nskip</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">mask_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">mask_data</span><span class="p">]</span> <span class="o">*</span> <span class="n">ntsteps</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">mask_data</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">skip_frames</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">brain</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">func_data</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="p">(</span><span class="n">mask_data</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_zscore</span><span class="p">:</span>
            <span class="n">ts_z</span> <span class="o">=</span> <span class="n">find_peaks</span><span class="p">(</span><span class="n">brain</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">ts_z</span> <span class="o">=</span> <span class="n">find_spikes</span><span class="p">(</span><span class="n">brain</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">spike_thresh</span><span class="p">)</span>

        <span class="c1"># File save</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_file</span><span class="p">)</span>
        <span class="n">file_name_no_ext</span><span class="p">,</span> <span class="n">file_extension</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">file_extension</span> <span class="o">==</span> <span class="s2">&quot;.gz&quot;</span><span class="p">:</span>
            <span class="p">(</span><span class="n">file_name_no_ext_2</span><span class="p">,</span> <span class="n">file_extension_2</span><span class="p">)</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span>
                <span class="n">file_name_no_ext</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">file_extension_2</span> <span class="o">==</span> <span class="s2">&quot;.nii&quot;</span><span class="p">:</span>
                <span class="n">file_name_no_ext</span> <span class="o">=</span> <span class="n">file_name_no_ext_2</span>

        <span class="n">file_out</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">out_prefix</span> <span class="o">+</span> <span class="n">file_name_no_ext</span> <span class="o">+</span> <span class="s2">&quot;.out&quot;</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">file_out</span><span class="p">,</span> <span class="n">ts_z</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="art_qi1"><a class="viewcode-back" href="../../../../mia_processes.bricks.reports.html#mia_processes.bricks.reports.processes.art_qi1">[docs]</a><span class="k">def</span> <span class="nf">art_qi1</span><span class="p">(</span><span class="n">airmask</span><span class="p">,</span> <span class="n">artmask</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Detect artifacts in the image using the method described in [Mortamet2009].</span>

<span class="sd">    Caculates :math:`\text{QI}_1`, as the proportion of voxels with intensity</span>
<span class="sd">    corrupted by artifacts normalized by the number of voxels in the</span>
<span class="sd">    background:</span>

<span class="sd">    .. math ::</span>
<span class="sd">        \text{QI}_1 = \frac{1}{N} \sum\limits_{x\in X_\text{art}} 1</span>

<span class="sd">    Lower values are better.</span>

<span class="sd">    :param numpy.ndarray airmask: input air mask, without artifacts</span>
<span class="sd">    :param numpy.ndarray artmask: input artifacts mask</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">airmask</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="o">-</span><span class="mf">1.0</span>

    <span class="c1"># Count the number of voxels that remain after the opening operation.</span>
    <span class="c1"># These are artifacts.</span>
    <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">artmask</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="p">(</span><span class="n">airmask</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">+</span> <span class="n">artmask</span><span class="o">.</span><span class="n">sum</span><span class="p">()))</span></div>


<div class="viewcode-block" id="art_qi2"><a class="viewcode-back" href="../../../../mia_processes.bricks.reports.html#mia_processes.bricks.reports.processes.art_qi2">[docs]</a><span class="k">def</span> <span class="nf">art_qi2</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">airmask</span><span class="p">,</span> <span class="n">min_voxels</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="mf">1e3</span><span class="p">),</span> <span class="n">max_voxels</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="mf">3e5</span><span class="p">)):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates :math:`\text{QI}_2`, based on the goodness-of-fit of a centered</span>
<span class="sd">    :math:`\chi^2` distribution onto the intensity distribution of</span>
<span class="sd">    non-artifactual background (within the &quot;hat&quot; mask):</span>

<span class="sd">    .. math ::</span>
<span class="sd">        \chi^2_n = \frac{2}{(\sigma \sqrt{2})^{2n} \,</span>
<span class="sd">                            (n - 1)!}x^{2n - 1}\, e^{-\frac{x}{2}}</span>

<span class="sd">    where :math:`n` is the number of coil elements.</span>

<span class="sd">    :param numpy.ndarray img: input data</span>
<span class="sd">    :param numpy.ndarray airmask: input air mask without artifacts</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">chi2</span>
    <span class="kn">from</span> <span class="nn">sklearn.neighbors</span> <span class="kn">import</span> <span class="n">KernelDensity</span>

    <span class="c1"># S. Ogawa was born</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">1191935</span><span class="p">)</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">img</span><span class="p">[</span><span class="n">airmask</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">data</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">min_voxels</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">0.0</span>

    <span class="n">modelx</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">data</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">max_voxels</span>
        <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">max_voxels</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="n">x_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">99</span><span class="p">),</span> <span class="mi">1000</span><span class="p">)</span>

    <span class="c1"># Estimate data pdf with KDE on a random subsample</span>
    <span class="n">kde_skl</span> <span class="o">=</span> <span class="n">KernelDensity</span><span class="p">(</span>
        <span class="n">bandwidth</span><span class="o">=</span><span class="mf">0.05</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">98</span><span class="p">),</span> <span class="n">kernel</span><span class="o">=</span><span class="s2">&quot;gaussian&quot;</span>
    <span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">modelx</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">])</span>
    <span class="n">kde</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">kde_skl</span><span class="o">.</span><span class="n">score_samples</span><span class="p">(</span><span class="n">x_grid</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]))</span>

    <span class="c1"># Find cutoff</span>
    <span class="n">kdethi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">kde</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">kde</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">)</span>

    <span class="c1"># Fit X^2</span>
    <span class="n">param</span> <span class="o">=</span> <span class="n">chi2</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">modelx</span><span class="p">[</span><span class="n">modelx</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">95</span><span class="p">)],</span> <span class="mi">32</span><span class="p">)</span>
    <span class="n">chi_pdf</span> <span class="o">=</span> <span class="n">chi2</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">x_grid</span><span class="p">,</span> <span class="o">*</span><span class="n">param</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">loc</span><span class="o">=</span><span class="n">param</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">scale</span><span class="o">=</span><span class="n">param</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

    <span class="c1"># Compute goodness-of-fit (gof)</span>
    <span class="n">gof</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">kde</span><span class="p">[</span><span class="o">-</span><span class="n">kdethi</span><span class="p">:]</span> <span class="o">-</span> <span class="n">chi_pdf</span><span class="p">[</span><span class="o">-</span><span class="n">kdethi</span><span class="p">:])</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>

    <span class="n">hist_dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;x_grid&quot;</span><span class="p">:</span> <span class="n">x_grid</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
        <span class="s2">&quot;ref_pdf&quot;</span><span class="p">:</span> <span class="n">kde</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
        <span class="s2">&quot;fit_pdf&quot;</span><span class="p">:</span> <span class="n">chi_pdf</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
        <span class="s2">&quot;ref_data&quot;</span><span class="p">:</span> <span class="n">modelx</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
        <span class="s2">&quot;cutoff_idx&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">kdethi</span><span class="p">),</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">gof</span><span class="p">,</span> <span class="n">hist_dict</span></div>


<div class="viewcode-block" id="cjv"><a class="viewcode-back" href="../../../../mia_processes.bricks.reports.html#mia_processes.bricks.reports.processes.cjv">[docs]</a><span class="k">def</span> <span class="nf">cjv</span><span class="p">(</span><span class="n">mu_wm</span><span class="p">,</span> <span class="n">mu_gm</span><span class="p">,</span> <span class="n">sigma_wm</span><span class="p">,</span> <span class="n">sigma_gm</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the :abbr:`CJV (coefficient of joint variation)`, a measure</span>
<span class="sd">    related to :abbr:`SNR (Signal-to-Noise Ratio)` and</span>
<span class="sd">    :abbr:`CNR (Contrast-to-Noise Ratio)` that is presented as a proxy for</span>
<span class="sd">    the :abbr:`INU (intensity non-uniformity)` artifact [Ganzetti2016]_.</span>

<span class="sd">    Lower is better.</span>

<span class="sd">    .. math::</span>
<span class="sd">        \text{CJV} = \frac{\sigma_\text{WM} +</span>
<span class="sd">                           \sigma_\text{GM}}{|\mu_\text{WM} -</span>
<span class="sd">                           \mu_\text{GM}|}.</span>

<span class="sd">    :param float mu_wm: mean of signal within white-matter mask.</span>
<span class="sd">    :param float mu_gm: mean of signal within gray-matter mask.</span>
<span class="sd">    :param float sigma_wm: standard deviation of signal within</span>
<span class="sd">                           white-matter mask.</span>
<span class="sd">    :param float sigma_gm: standard deviation of signal within</span>
<span class="sd">                           gray-matter mask.</span>
<span class="sd">    :return: the computed CJV</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">float</span><span class="p">((</span><span class="n">sigma_wm</span> <span class="o">+</span> <span class="n">sigma_gm</span><span class="p">)</span> <span class="o">/</span> <span class="nb">abs</span><span class="p">(</span><span class="n">mu_wm</span> <span class="o">-</span> <span class="n">mu_gm</span><span class="p">))</span></div>


<div class="viewcode-block" id="cnr"><a class="viewcode-back" href="../../../../mia_processes.bricks.reports.html#mia_processes.bricks.reports.processes.cnr">[docs]</a><span class="k">def</span> <span class="nf">cnr</span><span class="p">(</span><span class="n">mu_wm</span><span class="p">,</span> <span class="n">mu_gm</span><span class="p">,</span> <span class="n">sigma_air</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the :abbr:`CNR (Contrast-to-Noise Ratio)` [Magnota2006]_.</span>

<span class="sd">    Higher values are better.</span>

<span class="sd">    .. math::</span>
<span class="sd">        \text{CNR} = \frac{|\mu_\text{GM} -</span>
<span class="sd">                           \mu_\text{WM} |}{\sqrt{\sigma_B^2 +</span>
<span class="sd">                           \sigma_\text{WM}^2 +</span>
<span class="sd">                           \sigma_\text{GM}^2}}</span>

<span class="sd">    where :math:`\sigma_B` is the standard deviation of the noise distribution</span>
<span class="sd">    within the air (background) mask.</span>

<span class="sd">    :param float mu_wm: mean of signal within white-matter mask.</span>
<span class="sd">    :param float mu_gm: mean of signal within gray-matter mask.</span>
<span class="sd">    :param float sigma_air: standard deviation of the air surrounding the</span>
<span class="sd">                            head (&quot;hat&quot; mask).</span>

<span class="sd">    :return: the computed CNR</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">mu_wm</span> <span class="o">-</span> <span class="n">mu_gm</span><span class="p">)</span> <span class="o">/</span> <span class="n">sigma_air</span><span class="p">)</span></div>


<div class="viewcode-block" id="efc"><a class="viewcode-back" href="../../../../mia_processes.bricks.reports.html#mia_processes.bricks.reports.processes.efc">[docs]</a><span class="k">def</span> <span class="nf">efc</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">framemask</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the :abbr:`EFC (Entropy Focus Criterion)` [Atkinson1997]_.</span>

<span class="sd">    Uses the Shannon entropy of voxel intensities as an indication of ghosting</span>
<span class="sd">    and blurring induced by head motion. A range of low values is better,</span>
<span class="sd">    with EFC = 0 for all the energy concentrated in one pixel.</span>

<span class="sd">    .. math::</span>
<span class="sd">        \text{E} = - \sum_{j=1}^N \frac{x_j}{x_\text{max}}</span>
<span class="sd">        \ln \left[\frac{x_j}{x_\text{max}}\right]</span>

<span class="sd">    with :math:`x_\text{max} = \sqrt{\sum_{j=1}^N x^2_j}`.</span>

<span class="sd">    The original equation is normalized by the maximum entropy, so that the</span>
<span class="sd">    :abbr:`EFC (Entropy Focus Criterion)` can be compared across images with</span>
<span class="sd">    different dimensions:</span>

<span class="sd">    .. math::</span>
<span class="sd">        \text{EFC} =</span>
<span class="sd">        \left( \frac{N}{\sqrt{N}} \, \log{\sqrt{N}^{-1}} \right) \text{E}</span>

<span class="sd">    :param numpy.ndarray img: input data</span>
<span class="sd">    :param numpy.ndarray framemask: a mask of empty voxels inserted after</span>
<span class="sd">                                    a rotation of data</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">framemask</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">framemask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>

    <span class="n">n_vox</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">framemask</span><span class="p">)</span>
    <span class="c1"># Calculate the maximum value of the EFC (which occurs any time all</span>
    <span class="c1"># voxels have the same value)</span>
    <span class="n">efc_max</span> <span class="o">=</span> <span class="p">(</span>
        <span class="mf">1.0</span> <span class="o">*</span> <span class="n">n_vox</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">n_vox</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">n_vox</span><span class="p">))</span>
    <span class="p">)</span>

    <span class="c1"># Calculate the total image energy</span>
    <span class="n">b_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">img</span><span class="p">[</span><span class="n">framemask</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>

    <span class="c1"># Calculate EFC (add 1e-16 to the image data to keep log happy)</span>
    <span class="k">return</span> <span class="nb">float</span><span class="p">(</span>
        <span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">efc_max</span><span class="p">)</span>
        <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
            <span class="p">(</span><span class="n">img</span><span class="p">[</span><span class="n">framemask</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">b_max</span><span class="p">)</span>
            <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">((</span><span class="n">img</span><span class="p">[</span><span class="n">framemask</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mf">1e-16</span><span class="p">)</span> <span class="o">/</span> <span class="n">b_max</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="fber"><a class="viewcode-back" href="../../../../mia_processes.bricks.reports.html#mia_processes.bricks.reports.processes.fber">[docs]</a><span class="k">def</span> <span class="nf">fber</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">headmask</span><span class="p">,</span> <span class="n">rotmask</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the :abbr:`FBER (Foreground-Background Energy Ratio)`</span>
<span class="sd">    [Shehzad2015]_, defined as the mean energy of image values within the</span>
<span class="sd">    head relative to outside the head.</span>

<span class="sd">    Higher values are better.</span>

<span class="sd">    .. math::</span>
<span class="sd">        \text{FBER} = \frac{E[|F|^2]}{E[|B|^2]}</span>

<span class="sd">    :param numpy.ndarray img: input data</span>
<span class="sd">    :param numpy.ndarray headmask: a mask of the head (including skull,</span>
<span class="sd">                                   skin, etc.)</span>
<span class="sd">    :param numpy.ndarray rotmask: a mask of empty voxels inserted after</span>
<span class="sd">                                  a rotation of data</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">fg_mu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">img</span><span class="p">[</span><span class="n">headmask</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

    <span class="n">airmask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">headmask</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
    <span class="n">airmask</span><span class="p">[</span><span class="n">headmask</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">rotmask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">airmask</span><span class="p">[</span><span class="n">rotmask</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">bg_mu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">img</span><span class="p">[</span><span class="n">airmask</span> <span class="o">==</span> <span class="mi">1</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">bg_mu</span> <span class="o">&lt;</span> <span class="mf">1.0e-3</span><span class="p">:</span>
        <span class="k">return</span> <span class="o">-</span><span class="mf">1.0</span>
    <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">fg_mu</span> <span class="o">/</span> <span class="n">bg_mu</span><span class="p">)</span></div>


<div class="viewcode-block" id="find_peaks"><a class="viewcode-back" href="../../../../mia_processes.bricks.reports.html#mia_processes.bricks.reports.processes.find_peaks">[docs]</a><span class="k">def</span> <span class="nf">find_peaks</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :param data: a numpy ndarray</span>
<span class="sd">    :returns: a list</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">t_z</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">data</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">i</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="p">]</span>
    <span class="k">return</span> <span class="n">t_z</span></div>


<div class="viewcode-block" id="find_spikes"><a class="viewcode-back" href="../../../../mia_processes.bricks.reports.html#mia_processes.bricks.reports.processes.find_spikes">[docs]</a><span class="k">def</span> <span class="nf">find_spikes</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">spike_thresh</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;blabla&quot;&quot;&quot;</span>
    <span class="n">data</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">slice_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">t_z</span> <span class="o">=</span> <span class="n">_robust_zscore</span><span class="p">(</span><span class="n">slice_mean</span><span class="p">)</span>
    <span class="n">spikes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">t_z</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">spike_thresh</span>
    <span class="n">spike_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">spikes</span><span class="o">.</span><span class="n">nonzero</span><span class="p">())</span>
    <span class="c1"># mask out the spikes and recompute z-scores using variance uncontaminated</span>
    <span class="c1"># with spikes. This will catch smaller spikes that may have been swamped</span>
    <span class="c1"># by big ones.</span>
    <span class="n">data</span><span class="o">.</span><span class="n">mask</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">spike_inds</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">spike_inds</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">slice_mean2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">t_z</span> <span class="o">=</span> <span class="n">_robust_zscore</span><span class="p">(</span><span class="n">slice_mean2</span><span class="p">)</span>

    <span class="n">spikes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">spikes</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">t_z</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">spike_thresh</span><span class="p">)</span>
    <span class="n">spike_inds</span> <span class="o">=</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">spikes</span><span class="o">.</span><span class="n">nonzero</span><span class="p">())]</span>
    <span class="k">return</span> <span class="n">spike_inds</span><span class="p">,</span> <span class="n">t_z</span></div>


<div class="viewcode-block" id="fuzzy_jaccard"><a class="viewcode-back" href="../../../../mia_processes.bricks.reports.html#mia_processes.bricks.reports.processes.fuzzy_jaccard">[docs]</a><span class="k">def</span> <span class="nf">fuzzy_jaccard</span><span class="p">(</span><span class="n">in_tpms</span><span class="p">,</span> <span class="n">in_mni_tpms</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;blabla&quot;&quot;&quot;</span>
    <span class="n">overlaps</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">tpm</span><span class="p">,</span> <span class="n">mni_tpm</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">in_tpms</span><span class="p">,</span> <span class="n">in_mni_tpms</span><span class="p">):</span>
        <span class="n">tpm</span> <span class="o">=</span> <span class="n">tpm</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">mni_tpm</span> <span class="o">=</span> <span class="n">mni_tpm</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">num</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">tpm</span><span class="p">,</span> <span class="n">mni_tpm</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">den</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">tpm</span><span class="p">,</span> <span class="n">mni_tpm</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">overlaps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">num</span> <span class="o">/</span> <span class="n">den</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">overlaps</span></div>


<div class="viewcode-block" id="gsr"><a class="viewcode-back" href="../../../../mia_processes.bricks.reports.html#mia_processes.bricks.reports.processes.gsr">[docs]</a><span class="k">def</span> <span class="nf">gsr</span><span class="p">(</span><span class="n">epi_data</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="n">ref_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">out_file</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute the :abbr:`GSR (ghost to signal ratio)` [Giannelli2010]_.</span>

<span class="sd">    The procedure is as follows:</span>
<span class="sd">      #. Create a Nyquist ghost mask by circle-shifting the original</span>
<span class="sd">         mask by :math:`N/2`.</span>
<span class="sd">      #. Rotate by :math:`N/2`</span>
<span class="sd">      #. Remove the intersection with the original mask</span>
<span class="sd">      #. Generate a non-ghost background</span>
<span class="sd">      #. Calculate the :abbr:`GSR (ghost to signal ratio)`</span>

<span class="sd">    .. warning ::</span>
<span class="sd">      This should be used with EPI images for which the phase</span>
<span class="sd">      encoding direction is known.</span>

<span class="sd">    :param str epi_data: path to epi file</span>
<span class="sd">    :param str mask: path to brain mask</span>
<span class="sd">    :param str direction: the direction of phase encoding (x, y, all)</span>
<span class="sd">    :return: the computed gsr</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">direction</span> <span class="o">=</span> <span class="n">direction</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">direction</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;all&quot;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
            <span class="s2">&quot;Unknown direction </span><span class="si">{}</span><span class="s2">, should be one of x, -x, y, -y, all&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">direction</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">direction</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">newdir</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">]:</span>
            <span class="n">ofile</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">out_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">fname</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">ofile</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ext</span> <span class="o">==</span> <span class="s2">&quot;.gz&quot;</span><span class="p">:</span>
                    <span class="n">fname</span><span class="p">,</span> <span class="n">ext2</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
                    <span class="n">ext</span> <span class="o">=</span> <span class="n">ext2</span> <span class="o">+</span> <span class="n">ext</span>
                <span class="n">ofile</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">_</span><span class="si">{1}{2}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">newdir</span><span class="p">,</span> <span class="n">ext</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">+=</span> <span class="p">[</span>
                <span class="n">gsr</span><span class="p">(</span><span class="n">epi_data</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">newdir</span><span class="p">,</span> <span class="n">ref_file</span><span class="o">=</span><span class="n">ref_file</span><span class="p">,</span> <span class="n">out_file</span><span class="o">=</span><span class="n">ofile</span><span class="p">)</span>
            <span class="p">]</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="c1"># Roll data of mask through the appropriate axis</span>
    <span class="n">axis</span> <span class="o">=</span> <span class="n">RAS_AXIS_ORDER</span><span class="p">[</span><span class="n">direction</span><span class="p">]</span>
    <span class="n">n2_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">mask</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span>

    <span class="c1"># Step 3: remove from n2_mask pixels inside the brain</span>
    <span class="n">n2_mask</span> <span class="o">=</span> <span class="n">n2_mask</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">mask</span><span class="p">)</span>

    <span class="c1"># Step 4: non-ghost background region is labeled as 2</span>
    <span class="n">n2_mask</span> <span class="o">=</span> <span class="n">n2_mask</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">n2_mask</span> <span class="o">-</span> <span class="n">mask</span><span class="p">)</span>

    <span class="c1"># Step 5: signal is the entire foreground image</span>
    <span class="n">ghost</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">epi_data</span><span class="p">[</span><span class="n">n2_mask</span> <span class="o">==</span> <span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">epi_data</span><span class="p">[</span><span class="n">n2_mask</span> <span class="o">==</span> <span class="mi">2</span><span class="p">])</span>
    <span class="n">signal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">epi_data</span><span class="p">[</span><span class="n">n2_mask</span> <span class="o">==</span> <span class="mi">0</span><span class="p">])</span>
    <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">ghost</span> <span class="o">/</span> <span class="n">signal</span><span class="p">)</span></div>


<div class="viewcode-block" id="image_binary_dilation"><a class="viewcode-back" href="../../../../mia_processes.bricks.reports.html#mia_processes.bricks.reports.processes.image_binary_dilation">[docs]</a><span class="k">def</span> <span class="nf">image_binary_dilation</span><span class="p">(</span><span class="n">in_mask</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Dilate the input binary mask.</span>

<span class="sd">    :param numpy.ndarray in_mask: a 3D binary array</span>
<span class="sd">    :param int radius: the radius of the ball-shaped footprint for</span>
<span class="sd">                       dilation of the mask (optional)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">ndimage</span> <span class="k">as</span> <span class="n">ndi</span>
    <span class="kn">from</span> <span class="nn">skimage.morphology</span> <span class="kn">import</span> <span class="n">ball</span>

    <span class="k">return</span> <span class="n">ndi</span><span class="o">.</span><span class="n">binary_dilation</span><span class="p">(</span><span class="n">in_mask</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">),</span> <span class="n">ball</span><span class="p">(</span><span class="n">radius</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span></div>


<div class="viewcode-block" id="normalize_mc_params"><a class="viewcode-back" href="../../../../mia_processes.bricks.reports.html#mia_processes.bricks.reports.processes.normalize_mc_params">[docs]</a><span class="k">def</span> <span class="nf">normalize_mc_params</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">source</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Normalize a single row of motion parameters to the SPM format.</span>

<span class="sd">    SPM saves motion parameters as:</span>
<span class="sd">      - x   Right-Left          (mm)</span>
<span class="sd">      - y   Anterior-Posterior  (mm)</span>
<span class="sd">      - z   Superior-Inferior   (mm)</span>
<span class="sd">      - rx  Pitch               (rad)</span>
<span class="sd">      - ry  Roll                (rad)</span>
<span class="sd">      - rz  Yaw                 (rad)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">source</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;FSL&quot;</span><span class="p">:</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">params</span><span class="p">[[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]]</span>
    <span class="k">elif</span> <span class="n">source</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;AFNI&quot;</span><span class="p">,</span> <span class="s2">&quot;FSFAST&quot;</span><span class="p">):</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">6</span><span class="p">)]</span>
        <span class="n">params</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">180.0</span>
    <span class="k">elif</span> <span class="n">source</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;NIPY&quot;</span><span class="p">:</span>
        <span class="n">matrix</span> <span class="o">=</span> <span class="n">to_matrix44</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
        <span class="n">params</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
        <span class="n">params</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">aff2euler</span><span class="p">(</span><span class="n">matrix</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">params</span></div>


<div class="viewcode-block" id="regress_poly"><a class="viewcode-back" href="../../../../mia_processes.bricks.reports.html#mia_processes.bricks.reports.processes.regress_poly">[docs]</a><span class="k">def</span> <span class="nf">regress_poly</span><span class="p">(</span>
    <span class="n">degree</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">remove_mean</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">failure_mode</span><span class="o">=</span><span class="s2">&quot;error&quot;</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns data with degree polynomial regressed out.</span>
<span class="sd">    :param bool remove_mean: whether or not demean data (i.e. degree 0),</span>
<span class="sd">    :param int axis: numpy array axes along which regression is performed</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">datashape</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">timepoints</span> <span class="o">=</span> <span class="n">datashape</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">datashape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">failure_mode</span> <span class="o">!=</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">data</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>

    <span class="c1"># Rearrange all voxel-wise time-series in rows</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">timepoints</span><span class="p">))</span>

    <span class="c1"># Generate design matrix</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">timepoints</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>  <span class="c1"># quick way to calc degree 0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">degree</span><span class="p">):</span>
        <span class="n">polynomial_func</span> <span class="o">=</span> <span class="n">Legendre</span><span class="o">.</span><span class="n">basis</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">value_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">timepoints</span><span class="p">)</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">X</span><span class="p">,</span> <span class="n">polynomial_func</span><span class="p">(</span><span class="n">value_array</span><span class="p">)[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]))</span>

    <span class="n">non_constant_regressors</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>

    <span class="c1"># Calculate coefficients</span>
    <span class="n">betas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

    <span class="c1"># Estimation</span>
    <span class="k">if</span> <span class="n">remove_mean</span><span class="p">:</span>
        <span class="n">datahat</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">betas</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># disregard the first layer of X, which is degree 0</span>
        <span class="n">datahat</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">betas</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="o">...</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
    <span class="n">regressed_data</span> <span class="o">=</span> <span class="n">data</span> <span class="o">-</span> <span class="n">datahat</span>

    <span class="c1"># Back to original shape</span>
    <span class="k">return</span> <span class="n">regressed_data</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">datashape</span><span class="p">),</span> <span class="n">non_constant_regressors</span></div>


<div class="viewcode-block" id="rpve"><a class="viewcode-back" href="../../../../mia_processes.bricks.reports.html#mia_processes.bricks.reports.processes.rpve">[docs]</a><span class="k">def</span> <span class="nf">rpve</span><span class="p">(</span><span class="n">pvms</span><span class="p">,</span> <span class="n">seg</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    * | Computes the :abbr:`rPVe (residual partial voluming error)`</span>
<span class="sd">      | of each tissue class.</span>

<span class="sd">    .. math ::</span>
<span class="sd">        \\text{rPVE}^k = \\frac{1}{N} \\left[ \\sum\\limits_{p^k_i \</span>
<span class="sd">        \\in [0.5, P_{98}]} p^k_i + \\sum\\limits_{p^k_i \</span>
<span class="sd">        \\in [P_{2}, 0.5)} 1 - p^k_i \\right]</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">pvfs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">lid</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">FSL_FAST_LABELS</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
        <span class="k">if</span> <span class="n">lid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">pvmap</span> <span class="o">=</span> <span class="n">pvms</span><span class="p">[</span><span class="n">lid</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">pvmap</span><span class="p">[</span><span class="n">pvmap</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">pvmap</span><span class="p">[</span><span class="n">pvmap</span> <span class="o">&gt;=</span> <span class="mf">1.0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">totalvol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">pvmap</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="n">upth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">pvmap</span><span class="p">[</span><span class="n">pvmap</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">],</span> <span class="mi">98</span><span class="p">)</span>
        <span class="n">loth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">pvmap</span><span class="p">[</span><span class="n">pvmap</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">pvmap</span><span class="p">[</span><span class="n">pvmap</span> <span class="o">&lt;</span> <span class="n">loth</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">pvmap</span><span class="p">[</span><span class="n">pvmap</span> <span class="o">&gt;</span> <span class="n">upth</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">pvfs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">pvmap</span><span class="p">[</span><span class="n">pvmap</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">+</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">pvmap</span><span class="p">[</span><span class="n">pvmap</span> <span class="o">&lt;=</span> <span class="mf">0.5</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="p">)</span> <span class="o">/</span> <span class="n">totalvol</span>
    <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">pvfs</span><span class="o">.</span><span class="n">items</span><span class="p">())}</span></div>


<div class="viewcode-block" id="snr"><a class="viewcode-back" href="../../../../mia_processes.bricks.reports.html#mia_processes.bricks.reports.processes.snr">[docs]</a><span class="k">def</span> <span class="nf">snr</span><span class="p">(</span><span class="n">mu_fg</span><span class="p">,</span> <span class="n">sigma_fg</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the :abbr:`SNR (Signal-to-Noise Ratio)`.</span>

<span class="sd">    The estimation may be provided with only one foreground region in</span>
<span class="sd">    which the noise is computed as follows:</span>

<span class="sd">    .. math::</span>
<span class="sd">        \text{SNR} = \frac{\mu_F}{\sigma_F\sqrt{n/(n-1)}}</span>

<span class="sd">    where:</span>
<span class="sd">     - :math:`\mu_F` is the mean intensity of the foreground</span>
<span class="sd">     - :math:`\sigma_F` is the standard deviation of the same region</span>

<span class="sd">    :param float mu_fg: mean of foreground.</span>
<span class="sd">    :param float sigma_fg: standard deviation of foreground.</span>
<span class="sd">    :param int n: number of voxels in foreground mask.</span>
<span class="sd">    :return: the computed SNR</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">mu_fg</span> <span class="o">/</span> <span class="p">(</span><span class="n">sigma_fg</span> <span class="o">*</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">n</span> <span class="o">/</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))))</span></div>


<div class="viewcode-block" id="snr_dietrich"><a class="viewcode-back" href="../../../../mia_processes.bricks.reports.html#mia_processes.bricks.reports.processes.snr_dietrich">[docs]</a><span class="k">def</span> <span class="nf">snr_dietrich</span><span class="p">(</span><span class="n">mu_fg</span><span class="p">,</span> <span class="n">mad_air</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">sigma_air</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the :abbr:`SNR (Signal-to-Noise Ratio)`.</span>

<span class="sd">    This must be an air mask around the head, and it should not contain</span>
<span class="sd">    artifacts. The computation is done following the eq. A.12 of</span>
<span class="sd">    [Dietrich2007]_, which includes a correction factor in the estimation</span>
<span class="sd">    of the standard deviation of air and its Rayleigh distribution:</span>

<span class="sd">    .. math::</span>
<span class="sd">        \text{SNR} =</span>
<span class="sd">        \frac{\mu_F}{\sqrt{\frac{2}{4-\pi}}\,\sigma_\text{air}}.</span>

<span class="sd">    :param float mu_fg: mean of foreground.</span>
<span class="sd">    :param float sigma_air: standard deviation of the air surrounding</span>
<span class="sd">                            the head (&quot;hat&quot; mask).</span>

<span class="sd">    :return: the computed SNR for the foreground segmentation</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">mad_air</span> <span class="o">&gt;</span> <span class="mf">1.0</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">DIETRICH_FACTOR</span> <span class="o">*</span> <span class="n">mu_fg</span> <span class="o">/</span> <span class="n">mad_air</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span>
        <span class="nb">float</span><span class="p">(</span><span class="n">DIETRICH_FACTOR</span> <span class="o">*</span> <span class="n">mu_fg</span> <span class="o">/</span> <span class="n">sigma_air</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sigma_air</span> <span class="o">&gt;</span> <span class="mf">1e-3</span>
        <span class="k">else</span> <span class="o">-</span><span class="mf">1.0</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="summary_stats"><a class="viewcode-back" href="../../../../mia_processes.bricks.reports.html#mia_processes.bricks.reports.processes.summary_stats">[docs]</a><span class="k">def</span> <span class="nf">summary_stats</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">pvms</span><span class="p">,</span> <span class="n">airmask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">erode</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Estimates the mean, the standard deviation, the 95\%</span>
<span class="sd">    and the 5\% percentiles of each tissue distribution.</span>

<span class="sd">    .. warning ::</span>
<span class="sd">        Sometimes (with datasets that have been partially processed), the air</span>
<span class="sd">        mask will be empty. In those cases, the background stats will be zero</span>
<span class="sd">        for the mean, median, percentiles and kurtosis, the sum of voxels in</span>
<span class="sd">        the other remaining labels for ``n``, and finally the MAD and the</span>
<span class="sd">        :math:`\sigma` will be calculated as:</span>

<span class="sd">        .. math ::</span>
<span class="sd">            \sigma_\text{BG} = \sqrt{\sum \sigma_\text{i}^2}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">statsmodels.robust.scale</span> <span class="kn">import</span> <span class="n">mad</span>

    <span class="c1"># Check type of input masks</span>
    <span class="n">dims</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pvms</span><span class="p">))</span><span class="o">.</span><span class="n">ndim</span>
    <span class="k">if</span> <span class="n">dims</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
        <span class="c1"># If pvms is from FSL FAST, create the bg mask</span>
        <span class="n">stats_pvms</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">img</span><span class="p">)]</span> <span class="o">+</span> <span class="n">pvms</span>
    <span class="k">elif</span> <span class="n">dims</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">stats_pvms</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">pvms</span><span class="p">)</span> <span class="o">-</span> <span class="n">pvms</span><span class="p">,</span> <span class="n">pvms</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
            <span class="s2">&quot;Incorrect image dimensions (</span><span class="si">{0:d}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pvms</span><span class="p">)</span><span class="o">.</span><span class="n">ndim</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">airmask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">stats_pvms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">airmask</span>

    <span class="n">labels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">FSL_FAST_LABELS</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">stats_pvms</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">([</span><span class="s2">&quot;bg&quot;</span><span class="p">,</span> <span class="s2">&quot;fg&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">))))</span>

    <span class="n">output</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">lid</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">:</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
        <span class="n">mask</span><span class="p">[</span><span class="n">stats_pvms</span><span class="p">[</span><span class="n">lid</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.85</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">erode</span><span class="p">:</span>
            <span class="n">struc</span> <span class="o">=</span> <span class="n">nd</span><span class="o">.</span><span class="n">generate_binary_structure</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">nd</span><span class="o">.</span><span class="n">binary_erosion</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">structure</span><span class="o">=</span><span class="n">struc</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>

        <span class="n">nvox</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">nvox</span> <span class="o">&lt;</span> <span class="mf">1e3</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s1">&#39;calculating summary stats of label &quot;</span><span class="si">%s</span><span class="s1">&quot; in a very small &#39;</span>
                <span class="s2">&quot;mask (</span><span class="si">%d</span><span class="s2"> voxels)&quot;</span><span class="p">,</span>
                <span class="n">k</span><span class="p">,</span>
                <span class="nb">int</span><span class="p">(</span><span class="n">nvox</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="s2">&quot;bg&quot;</span><span class="p">:</span>
                <span class="n">output</span><span class="p">[</span><span class="s2">&quot;bg&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;mean&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                    <span class="s2">&quot;median&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                    <span class="s2">&quot;p95&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                    <span class="s2">&quot;p05&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                    <span class="s2">&quot;k&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                    <span class="s2">&quot;stdv&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                    <span class="s2">&quot;mad&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                    <span class="s2">&quot;n&quot;</span><span class="p">:</span> <span class="n">nvox</span><span class="p">,</span>
                <span class="p">}</span>
                <span class="k">continue</span>

        <span class="n">output</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;mean&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">img</span><span class="p">[</span><span class="n">mask</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()),</span>
            <span class="s2">&quot;stdv&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">img</span><span class="p">[</span><span class="n">mask</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()),</span>
            <span class="s2">&quot;median&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">img</span><span class="p">[</span><span class="n">mask</span> <span class="o">==</span> <span class="mi">1</span><span class="p">])),</span>
            <span class="s2">&quot;mad&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">mad</span><span class="p">(</span><span class="n">img</span><span class="p">[</span><span class="n">mask</span> <span class="o">==</span> <span class="mi">1</span><span class="p">])),</span>
            <span class="s2">&quot;p95&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">img</span><span class="p">[</span><span class="n">mask</span> <span class="o">==</span> <span class="mi">1</span><span class="p">],</span> <span class="mi">95</span><span class="p">)),</span>
            <span class="s2">&quot;p05&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">img</span><span class="p">[</span><span class="n">mask</span> <span class="o">==</span> <span class="mi">1</span><span class="p">],</span> <span class="mi">5</span><span class="p">)),</span>
            <span class="s2">&quot;k&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">kurtosis</span><span class="p">(</span><span class="n">img</span><span class="p">[</span><span class="n">mask</span> <span class="o">==</span> <span class="mi">1</span><span class="p">])),</span>
            <span class="s2">&quot;n&quot;</span><span class="p">:</span> <span class="n">nvox</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">return</span> <span class="n">output</span></div>


<div class="viewcode-block" id="volume_fraction"><a class="viewcode-back" href="../../../../mia_processes.bricks.reports.html#mia_processes.bricks.reports.processes.volume_fraction">[docs]</a><span class="k">def</span> <span class="nf">volume_fraction</span><span class="p">(</span><span class="n">pvms</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes the :abbr:`ICV (intracranial volume)` fractions corresponding to</span>
<span class="sd">    the (partial volume maps).</span>

<span class="sd">    .. math ::</span>
<span class="sd">        \text{ICV}^k =</span>
<span class="sd">        \frac{\sum_i p^k_i}{\sum\limits_{x \in X_\text{brain}} 1}</span>

<span class="sd">    :param list pvms: list of :code:`numpy.ndarray` of partial volume maps.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tissue_vfs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">lid</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">FSL_FAST_LABELS</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
        <span class="k">if</span> <span class="n">lid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">tissue_vfs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">pvms</span><span class="p">[</span><span class="n">lid</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">total</span> <span class="o">+=</span> <span class="n">tissue_vfs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">tissue_vfs</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="n">tissue_vfs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">/=</span> <span class="n">total</span>
    <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">tissue_vfs</span><span class="o">.</span><span class="n">items</span><span class="p">())}</span></div>


<div class="viewcode-block" id="wm2max"><a class="viewcode-back" href="../../../../mia_processes.bricks.reports.html#mia_processes.bricks.reports.processes.wm2max">[docs]</a><span class="k">def</span> <span class="nf">wm2max</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">mu_wm</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the :abbr:`WM2MAX (white-matter-to-max ratio)`,</span>
<span class="sd">    defined as the maximum intensity found in the volume w.r.t. the</span>
<span class="sd">    mean value of the white matter tissue. Values close to 1.0 are</span>
<span class="sd">    better:</span>

<span class="sd">    .. math ::</span>
<span class="sd">        \text{WM2MAX} = \frac{\mu_\text{WM}}{P_{99.95}(X)}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">mu_wm</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="mf">99.95</span><span class="p">))</span></div>


<span class="k">def</span> <span class="nf">_AR_est_YW</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">rxx</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Retrieve AR coefficients while dropping the sig_sq return value&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">AR_est_YW</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">rxx</span><span class="o">=</span><span class="n">rxx</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">_flatten_dict</span><span class="p">(</span><span class="n">indict</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Reduce a dictionary of dictionaries to a dictionary</span>

<span class="sd">    Does not exceed two levels in depth.</span>

<span class="sd">    :param indict: a dictionary</span>
<span class="sd">    :returns: the flattened dictionary</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">out_qc</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">indict</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">out_qc</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">subk</span><span class="p">,</span> <span class="n">subval</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">subval</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="n">out_qc</span><span class="p">[</span><span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">k</span><span class="p">,</span> <span class="n">subk</span><span class="p">])]</span> <span class="o">=</span> <span class="n">subval</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">ssubk</span><span class="p">,</span> <span class="n">ssubval</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">subval</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                        <span class="n">out_qc</span><span class="p">[</span><span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">k</span><span class="p">,</span> <span class="n">subk</span><span class="p">,</span> <span class="n">ssubk</span><span class="p">])]</span> <span class="o">=</span> <span class="n">ssubval</span>
    <span class="k">return</span> <span class="n">out_qc</span>


<span class="k">def</span> <span class="nf">_prepare_mask</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">erode</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;blabla</span>


<span class="sd">    :param mask: blabla</span>
<span class="sd">    :param label: blabla</span>
<span class="sd">    :param erode: blabla</span>
<span class="sd">    :returns: blabla</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fgmask</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">issubdtype</span><span class="p">(</span><span class="n">fgmask</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)):</span>
            <span class="n">label</span> <span class="o">=</span> <span class="n">FSL_FAST_LABELS</span><span class="p">[</span><span class="n">label</span><span class="p">]</span>

        <span class="n">fgmask</span><span class="p">[</span><span class="n">fgmask</span> <span class="o">!=</span> <span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">fgmask</span><span class="p">[</span><span class="n">fgmask</span> <span class="o">==</span> <span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fgmask</span><span class="p">[</span><span class="n">fgmask</span> <span class="o">&gt;</span> <span class="mf">0.95</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">fgmask</span><span class="p">[</span><span class="n">fgmask</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="n">erode</span><span class="p">:</span>
        <span class="c1"># Create a structural element to be used in an opening operation.</span>
        <span class="n">struc</span> <span class="o">=</span> <span class="n">nd</span><span class="o">.</span><span class="n">generate_binary_structure</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="c1"># Perform an opening operation on the background data.</span>
        <span class="n">fgmask</span> <span class="o">=</span> <span class="n">nd</span><span class="o">.</span><span class="n">binary_opening</span><span class="p">(</span><span class="n">fgmask</span><span class="p">,</span> <span class="n">structure</span><span class="o">=</span><span class="n">struc</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">fgmask</span>


<span class="k">def</span> <span class="nf">_robust_zscore</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Blabla</span>

<span class="sd">    :return: blabla</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">data</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span>
        <span class="n">data</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">)</span><span class="o">.</span><span class="n">T</span>
</pre></div>

      </div>
      <div class="bottomnav" role="navigation" aria-label="bottom navigation">
      
        <p>
        <a class="uplink" href="../../../../index.html">Contents</a>
        </p>

      </div>

    <div class="footer" role="contentinfo">
        &#169; Copyright 2019, populse.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 4.5.0.
    </div>
  </body>
</html>