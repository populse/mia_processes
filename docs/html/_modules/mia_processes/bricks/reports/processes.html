
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>mia_processes.bricks.reports.processes &#8212; mia_processes 2.2.1-dev+2d129ae documentation</title>
    <link rel="stylesheet" href="../../../../_static/haiku.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
    <script src="../../../../_static/jquery.js"></script>
    <script src="../../../../_static/underscore.js"></script>
    <script src="../../../../_static/doctools.js"></script>
    <script src="../../../../_static/language_data.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
  </head><body>
      <div class="header" role="banner"><h1 class="heading"><a href="../../../../index.html">
          <span>mia_processes 2.2.1-dev+2d129ae documentation</span></a></h1>
        <h2 class="heading"><span>mia_processes.bricks.reports.processes</span></h2>
      </div>
      <div class="topnav" role="navigation" aria-label="top navigation">
      
        <p>
        <a class="uplink" href="../../../../index.html">Contents</a>
        </p>

      </div>
      <div class="content" role="main">
        
        
  <h1>Source code for mia_processes.bricks.reports.processes</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;The report preprocess library of the mia_processes package.</span>

<span class="sd">The purpose of this module is to provide bricks and functions to</span>
<span class="sd">compute necessary values for reporting.</span>

<span class="sd">:Contains:</span>
<span class="sd">    :Class:</span>
<span class="sd">        - AnatIQMs</span>
<span class="sd">        - BoldIQMs</span>
<span class="sd">        - ComputeDVARS</span>
<span class="sd">        - CarpetParcellation</span>
<span class="sd">        - FramewiseDisplacement</span>
<span class="sd">        - Mean_stdDev_calc</span>
<span class="sd">        - Result_collector</span>
<span class="sd">        - Spikes</span>

<span class="sd">    :Function:</span>
<span class="sd">        - art_qi1</span>
<span class="sd">        - art_qi2</span>
<span class="sd">        - cjv</span>
<span class="sd">        - cnr</span>
<span class="sd">        - efc</span>
<span class="sd">        - fber</span>
<span class="sd">        - fuzzy_jaccard</span>
<span class="sd">        - find_peaks</span>
<span class="sd">        - find_spikes</span>
<span class="sd">        - gsr</span>
<span class="sd">        - image_binary_dilation</span>
<span class="sd">        - normalize_mc_params</span>
<span class="sd">        - rpve</span>
<span class="sd">        - snr</span>
<span class="sd">        - snr_dietrich</span>
<span class="sd">        - summary_stats</span>
<span class="sd">        - volume_fraction</span>
<span class="sd">        - wm2max</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c1">##########################################################################</span>
<span class="c1"># mia_processes - Copyright (C) IRMaGe/CEA, 2018</span>
<span class="c1"># Distributed under the terms of the CeCILL license, as published by</span>
<span class="c1"># the CEA-CNRS-INRIA. Refer to the LICENSE file or to</span>
<span class="c1"># http://www.cecill.info/licences/Licence_CeCILL_V2.1-en.html</span>
<span class="c1"># for details.</span>
<span class="c1">##########################################################################</span>

<span class="c1"># nibabel import</span>
<span class="kn">import</span> <span class="nn">nibabel</span> <span class="k">as</span> <span class="nn">nb</span>

<span class="c1"># nipype import</span>
<span class="kn">from</span> <span class="nn">nipype.interfaces.base</span> <span class="kn">import</span> <span class="p">(</span><span class="n">OutputMultiPath</span><span class="p">,</span> <span class="n">InputMultiPath</span><span class="p">,</span> <span class="n">File</span><span class="p">,</span>
                                    <span class="n">traits</span><span class="p">,</span> <span class="n">TraitListObject</span><span class="p">,</span> <span class="n">Undefined</span><span class="p">,</span>
                                    <span class="n">DictStrStr</span><span class="p">,</span> <span class="n">Str</span><span class="p">)</span>

<span class="c1"># populse_mia import</span>
<span class="kn">from</span> <span class="nn">populse_mia.user_interface.pipeline_manager.process_mia</span> <span class="kn">import</span> <span class="n">ProcessMIA</span>
<span class="kn">from</span> <span class="nn">mia_processes.utils</span> <span class="kn">import</span> <span class="n">checkFileExt</span>

<span class="c1"># mia_processes import</span>
<span class="kn">from</span> <span class="nn">mia_processes.utils</span> <span class="kn">import</span> <span class="n">get_dbFieldValue</span>

<span class="c1"># soma-base imports</span>
<span class="kn">from</span> <span class="nn">soma.qt_gui.qt_backend.Qt</span> <span class="kn">import</span> <span class="n">QMessageBox</span>

<span class="c1"># Other import</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">pi</span><span class="p">,</span> <span class="n">sqrt</span>
<span class="kn">from</span> <span class="nn">nilearn.signal</span> <span class="kn">import</span> <span class="n">clean</span>
<span class="kn">from</span> <span class="nn">nipy.algorithms.registration</span> <span class="kn">import</span> <span class="n">to_matrix44</span><span class="p">,</span> <span class="n">aff2euler</span>
<span class="kn">from</span> <span class="nn">nitime.algorithms</span> <span class="kn">import</span> <span class="n">AR_est_YW</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">numpy.polynomial</span> <span class="kn">import</span> <span class="n">Legendre</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">scipy.ndimage</span> <span class="k">as</span> <span class="nn">nd</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">kurtosis</span>  <span class="c1"># pylint: disable=E0611</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">from</span> <span class="nn">skimage.transform</span> <span class="kn">import</span> <span class="n">resize</span>

<span class="n">DIETRICH_FACTOR</span> <span class="o">=</span> <span class="mf">0.6551364</span>  <span class="c1"># 1.0 / sqrt(2 / (4 - pi))</span>
<span class="n">FSL_FAST_LABELS</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;csf&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;gm&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;wm&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&quot;bg&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
<span class="n">RAS_AXIS_ORDER</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">}</span>
<span class="n">EXT</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;NIFTI_GZ&#39;</span><span class="p">:</span> <span class="s1">&#39;nii.gz&#39;</span><span class="p">,</span>
       <span class="s1">&#39;NIFTI&#39;</span><span class="p">:</span> <span class="s1">&#39;nii&#39;</span>
       <span class="p">}</span>


<div class="viewcode-block" id="AnatIQMs"><a class="viewcode-back" href="../../../../mia_processes.bricks.reports.html#mia_processes.bricks.reports.processes.AnatIQMs">[docs]</a><span class="k">class</span> <span class="nc">AnatIQMs</span><span class="p">(</span><span class="n">ProcessMIA</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        * Computes the anatomical IQMs.</span>

<span class="sd">        Please, see the complete documentation for the `AnatIQMs&#39; brick</span>
<span class="sd">        in the populse.mia_processes website</span>
<span class="sd">        https://populse.github.io/mia_processes/html/documentation/bricks/preprocess/other/AnatIQMs.html</span>

<span class="sd">        adapted from:</span>
<span class="sd">        https://github.com/nipreps/mriqc/blob/e021008da0a2ef1c48e882baf932139a673349f9/mriqc/workflows/anatomical.py#L332</span>

<span class="sd">        &quot;&quot;&quot;</span>

<div class="viewcode-block" id="AnatIQMs.__init__"><a class="viewcode-back" href="../../../../mia_processes.bricks.reports.html#mia_processes.bricks.reports.processes.AnatIQMs.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the attributes initialisation / instantiation.</span>

<span class="sd">        The input and output plugs are defined here. The special</span>
<span class="sd">        &#39;self.requirement&#39; attribute (optional) is used to define the</span>
<span class="sd">        third-party products necessary for the running of the brick.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Initialisation of the objects needed for the launch of the brick</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">AnatIQMs</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1"># Third party softwares required for the execution of the brick</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requirement</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Inputs description</span>
        <span class="n">in_ras_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;RAS input image (a pathlike object or string &#39;</span>
                       <span class="s1">&#39;representing a file).&#39;</span><span class="p">)</span>
        <span class="n">airmask_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Air mask image (a pathlike object or string &#39;</span>
                        <span class="s1">&#39;representing a file).&#39;</span><span class="p">)</span>
        <span class="n">artmask_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Artifact mask image (a pathlike object or string &#39;</span>
                        <span class="s1">&#39;representing a file).&#39;</span><span class="p">)</span>
        <span class="n">headmask_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Head mask image (a pathlike object or string &#39;</span>
                         <span class="s1">&#39;representing a file).&#39;</span><span class="p">)</span>
        <span class="n">rotmask_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Rotation mask image (a pathlike object or string &#39;</span>
                        <span class="s1">&#39;representing a file).&#39;</span><span class="p">)</span>
        <span class="n">hatmask_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Hat mask image (a pathlike object or string &#39;</span>
                        <span class="s1">&#39;representing a file).&#39;</span><span class="p">)</span>
        <span class="n">segmentation_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Segmentation mask image (a pathlike object or &#39;</span>
                             <span class="s1">&#39;string representing a file).&#39;</span><span class="p">)</span>
        <span class="n">in_inu_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Input INU image (a pathlike object or string &#39;</span>
                       <span class="s1">&#39;representing a file).&#39;</span><span class="p">)</span>
        <span class="n">in_noinu_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Input no-INU image (a pathlike object or string &#39;</span>
                         <span class="s1">&#39;representing a file).&#39;</span><span class="p">)</span>
        <span class="n">pvms_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;PVMS image (a pathlike object or string &#39;</span>
                     <span class="s1">&#39;representing a file).&#39;</span><span class="p">)</span>
        <span class="n">mni_tpms_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;MNI TPMS file (a pathlike &#39;</span>
                         <span class="s1">&#39;object or string representing a file).&#39;</span><span class="p">)</span>
        <span class="n">in_fwhm_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;FWHM (a float).&#39;</span><span class="p">)</span>

        <span class="c1"># Outputs description</span>
        <span class="n">out_file_desc</span> <span class="o">=</span> <span class="s1">&#39;a json file containing IQMs&#39;</span>

        <span class="c1"># Inputs traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;in_ras&quot;</span><span class="p">,</span>
                       <span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">optional</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">desc</span><span class="o">=</span><span class="n">in_ras_desc</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;airmask&quot;</span><span class="p">,</span>
                       <span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">desc</span><span class="o">=</span><span class="n">airmask_desc</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;artmask&quot;</span><span class="p">,</span>
                       <span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">desc</span><span class="o">=</span><span class="n">artmask_desc</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;headmask&quot;</span><span class="p">,</span>
                       <span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">desc</span><span class="o">=</span><span class="n">headmask_desc</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;rotmask&quot;</span><span class="p">,</span>
                       <span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">desc</span><span class="o">=</span><span class="n">rotmask_desc</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;hatmask&quot;</span><span class="p">,</span>
                       <span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">desc</span><span class="o">=</span><span class="n">hatmask_desc</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;segmentation&quot;</span><span class="p">,</span>
                       <span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">desc</span><span class="o">=</span><span class="n">segmentation_desc</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;in_inu&quot;</span><span class="p">,</span>
                       <span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">desc</span><span class="o">=</span><span class="n">in_inu_desc</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;in_noinu&quot;</span><span class="p">,</span>
                       <span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">desc</span><span class="o">=</span><span class="n">in_noinu_desc</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;pvms&quot;</span><span class="p">,</span>
                       <span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">File</span><span class="p">(),</span>
                                   <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                   <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">desc</span><span class="o">=</span><span class="n">pvms_desc</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;mni_tpms&quot;</span><span class="p">,</span>
                       <span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">File</span><span class="p">(),</span>
                                   <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                   <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">desc</span><span class="o">=</span><span class="n">mni_tpms_desc</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;in_fwhm&quot;</span><span class="p">,</span>
                       <span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">desc</span><span class="o">=</span><span class="n">in_fwhm_desc</span><span class="p">))</span>

        <span class="c1"># Outputs traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;out_file&quot;</span><span class="p">,</span>
                       <span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">desc</span><span class="o">=</span><span class="n">out_file_desc</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">init_default_traits</span><span class="p">()</span></div>

<div class="viewcode-block" id="AnatIQMs.list_outputs"><a class="viewcode-back" href="../../../../mia_processes.bricks.reports.html#mia_processes.bricks.reports.processes.AnatIQMs.list_outputs">[docs]</a>    <span class="k">def</span> <span class="nf">list_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_plugged</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the initialisation step of the brick.</span>

<span class="sd">        The main objective of this method is to produce the outputs of the</span>
<span class="sd">        bricks (self.outputs) and the associated tags (self.inheritance_dic),</span>
<span class="sd">        if defined here. To work properly this method must return</span>
<span class="sd">        self.make_initResult() object.</span>

<span class="sd">        :param is_plugged: the state, linked or not, of the plugs.</span>
<span class="sd">        :returns: a dictionary with requirement, outputs and inheritance_dict.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Using the inheritance to ProcessMIA class, list_outputs method</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">AnatIQMs</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">list_outputs</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_ras</span><span class="p">:</span>

            <span class="n">valid_ext</span><span class="p">,</span> <span class="n">in_ext</span><span class="p">,</span> <span class="n">fileName</span> <span class="o">=</span> <span class="n">checkFileExt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_ras</span><span class="p">,</span> <span class="n">EXT</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_ext</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">The input image format is not recognized ...!&#39;</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="n">report_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span>
                                       <span class="p">(</span><span class="n">fileName</span> <span class="o">+</span>
                                        <span class="s1">&#39;_anat_qc.json&#39;</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">fileName</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;out_file&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">report_file</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;- There was no output file deducted during &#39;</span>
                      <span class="s1">&#39;initialisation. Please check the input parameters...!&#39;</span><span class="p">)</span>

            <span class="c1"># tags inheritance (optional)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">inheritance_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span>
                    <span class="s1">&#39;out_file&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_ras</span>

        <span class="c1"># Return the requirement, outputs and inheritance_dict</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_initResult</span><span class="p">()</span></div>

<div class="viewcode-block" id="AnatIQMs.run_process_mia"><a class="viewcode-back" href="../../../../mia_processes.bricks.reports.html#mia_processes.bricks.reports.processes.AnatIQMs.run_process_mia">[docs]</a>    <span class="k">def</span> <span class="nf">run_process_mia</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the process launch step of the brick.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">AnatIQMs</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">run_process_mia</span><span class="p">()</span>

        <span class="n">results_dict</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">imdata</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_ras</span><span class="p">)</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">()</span>

        <span class="c1"># Try to load files</span>
        <span class="n">has_in_noinu</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_noinu</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">imnii</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_noinu</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="n">nb</span><span class="o">.</span><span class="n">filebasedimages</span><span class="o">.</span><span class="n">ImageFileError</span><span class="p">,</span>
                    <span class="ne">FileNotFoundError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">has_in_noinu</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Error with in_noinu file: &quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Load image corrected for INU</span>
                <span class="n">inudata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">imnii</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">())</span>
                <span class="n">inudata</span><span class="p">[</span><span class="n">inudata</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">has_in_noinu</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">has_segmentation</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">segmentation</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Load binary segmentation from FSL FAST</span>
                <span class="n">segnii</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">segmentation</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="n">nb</span><span class="o">.</span><span class="n">filebasedimages</span><span class="o">.</span><span class="n">ImageFileError</span><span class="p">,</span>
                    <span class="ne">FileNotFoundError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">has_segmentation</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Error with segmentation file: &quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">segdata</span> <span class="o">=</span> <span class="n">segnii</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">has_segmentation</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">has_airmask</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">airmask</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Load binary segmentation from FSL FAST</span>
                <span class="n">airnii</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">airmask</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="n">nb</span><span class="o">.</span><span class="n">filebasedimages</span><span class="o">.</span><span class="n">ImageFileError</span><span class="p">,</span>
                    <span class="ne">FileNotFoundError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">has_airmask</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Error with airmask file: &quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">airdata</span> <span class="o">=</span> <span class="n">airnii</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">has_airmask</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">has_artmask</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">artmask</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Load binary segmentation from FSL FAST</span>
                <span class="n">artnii</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">artmask</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="n">nb</span><span class="o">.</span><span class="n">filebasedimages</span><span class="o">.</span><span class="n">ImageFileError</span><span class="p">,</span>
                    <span class="ne">FileNotFoundError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">has_artmask</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Error with artmask file: &quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">artdata</span> <span class="o">=</span> <span class="n">artnii</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">has_artmask</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">has_headmask</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">headmask</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Load binary segmentation from FSL FAST</span>
                <span class="n">headnii</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">headmask</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="n">nb</span><span class="o">.</span><span class="n">filebasedimages</span><span class="o">.</span><span class="n">ImageFileError</span><span class="p">,</span>
                    <span class="ne">FileNotFoundError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">has_headmask</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Error with headmask file: &quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">headdata</span> <span class="o">=</span> <span class="n">headnii</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">has_headmask</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">has_rotmask</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rotmask</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Load binary segmentation from FSL FAST</span>
                <span class="n">rotnii</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rotmask</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="n">nb</span><span class="o">.</span><span class="n">filebasedimages</span><span class="o">.</span><span class="n">ImageFileError</span><span class="p">,</span>
                    <span class="ne">FileNotFoundError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">has_rotmask</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Error with rotmask file: &quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">rotdata</span> <span class="o">=</span> <span class="n">rotnii</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">has_rotmask</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">has_pvms</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rotmask</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Load Partial Volume Maps (pvms) from FSL FAST</span>
                <span class="n">pvmniis</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pvms</span><span class="p">:</span>
                    <span class="n">pvmniis</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nb</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fname</span><span class="p">))</span>
            <span class="k">except</span> <span class="p">(</span><span class="n">nb</span><span class="o">.</span><span class="n">filebasedimages</span><span class="o">.</span><span class="n">ImageFileError</span><span class="p">,</span>
                    <span class="ne">FileNotFoundError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">has_pvms</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Error with pvms files: &quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Load Partial Volume Maps (pvms) from FSL FAST</span>
                <span class="n">pvmdata</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">pvmnii</span> <span class="ow">in</span> <span class="n">pvmniis</span><span class="p">:</span>
                    <span class="n">pvmdata</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pvmnii</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float32&quot;</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">pvmdata</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">1e-4</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Detected less than 10 voxels &quot;</span>
                                           <span class="s2">&quot;belonging to one tissue prob. &quot;</span>
                                           <span class="s2">&quot;map. MRIQC failed to process this &quot;</span>
                                           <span class="s2">&quot;dataset.&quot;</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">has_pvms</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">has_mni_tpms</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mni_tpms</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">mni_tpmsniis</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mni_tpms</span><span class="p">:</span>
                    <span class="n">mni_tpmsniis</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nb</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fname</span><span class="p">))</span>
            <span class="k">except</span> <span class="p">(</span><span class="n">nb</span><span class="o">.</span><span class="n">filebasedimages</span><span class="o">.</span><span class="n">ImageFileError</span><span class="p">,</span>
                    <span class="ne">FileNotFoundError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">has_mni_tpms</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Error with mni_tpms files: &quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
                <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">has_mni_tpms</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">has_stats</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">has_in_noinu</span> <span class="ow">and</span> <span class="n">has_pvms</span> <span class="ow">and</span> <span class="n">has_airmask</span><span class="p">:</span>
            <span class="n">erode</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">imnii</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">get_zooms</span><span class="p">()[:</span><span class="mi">3</span><span class="p">],</span>
                                    <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1.9</span><span class="p">)</span>

            <span class="c1"># Summary stats</span>
            <span class="n">stats</span> <span class="o">=</span> <span class="n">summary_stats</span><span class="p">(</span><span class="n">inudata</span><span class="p">,</span> <span class="n">pvmdata</span><span class="p">,</span> <span class="n">airdata</span><span class="p">,</span> <span class="n">erode</span><span class="o">=</span><span class="n">erode</span><span class="p">)</span>
            <span class="n">has_stats</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">results_dict</span><span class="p">[</span><span class="s2">&quot;summary&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stats</span>

            <span class="c1"># SNR</span>
            <span class="n">snrvals</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">results_dict</span><span class="p">[</span><span class="s2">&quot;snr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">tlabel</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;csf&quot;</span><span class="p">,</span> <span class="s2">&quot;wm&quot;</span><span class="p">,</span> <span class="s2">&quot;gm&quot;</span><span class="p">]:</span>
                <span class="n">snrvals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">snr</span><span class="p">(</span>
                        <span class="n">stats</span><span class="p">[</span><span class="n">tlabel</span><span class="p">][</span><span class="s2">&quot;median&quot;</span><span class="p">],</span>
                        <span class="n">stats</span><span class="p">[</span><span class="n">tlabel</span><span class="p">][</span><span class="s2">&quot;stdv&quot;</span><span class="p">],</span>
                        <span class="nb">int</span><span class="p">(</span><span class="n">stats</span><span class="p">[</span><span class="n">tlabel</span><span class="p">][</span><span class="s2">&quot;n&quot;</span><span class="p">]),</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="n">results_dict</span><span class="p">[</span><span class="s2">&quot;snr&quot;</span><span class="p">][</span><span class="n">tlabel</span><span class="p">]</span> <span class="o">=</span> <span class="n">snrvals</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">results_dict</span><span class="p">[</span><span class="s2">&quot;snr&quot;</span><span class="p">][</span><span class="s2">&quot;total&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">snrvals</span><span class="p">))</span>

            <span class="n">snrvals</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">results_dict</span><span class="p">[</span><span class="s2">&quot;snrd&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">tlabel</span><span class="p">:</span> <span class="n">snr_dietrich</span><span class="p">(</span><span class="n">stats</span><span class="p">[</span><span class="n">tlabel</span><span class="p">][</span><span class="s2">&quot;median&quot;</span><span class="p">],</span>
                                     <span class="n">mad_air</span><span class="o">=</span><span class="n">stats</span><span class="p">[</span><span class="s2">&quot;bg&quot;</span><span class="p">][</span><span class="s2">&quot;mad&quot;</span><span class="p">],</span>
                                     <span class="n">sigma_air</span><span class="o">=</span><span class="n">stats</span><span class="p">[</span><span class="s2">&quot;bg&quot;</span><span class="p">][</span><span class="s2">&quot;stdv&quot;</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">tlabel</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;csf&quot;</span><span class="p">,</span> <span class="s2">&quot;wm&quot;</span><span class="p">,</span> <span class="s2">&quot;gm&quot;</span><span class="p">]</span>
            <span class="p">}</span>
            <span class="n">results_dict</span><span class="p">[</span><span class="s2">&quot;snrd&quot;</span><span class="p">][</span><span class="s2">&quot;total&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">val</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">results_dict</span><span class="p">[</span><span class="s2">&quot;snrd&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">())])</span>
            <span class="p">)</span>

            <span class="c1"># CNR</span>
            <span class="n">results_dict</span><span class="p">[</span><span class="s2">&quot;cnr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cnr</span><span class="p">(</span>
                <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;wm&quot;</span><span class="p">][</span><span class="s2">&quot;median&quot;</span><span class="p">],</span>
                <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;gm&quot;</span><span class="p">][</span><span class="s2">&quot;median&quot;</span><span class="p">],</span>
                <span class="n">sqrt</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">stats</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;stdv&quot;</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;bg&quot;</span><span class="p">,</span> <span class="s2">&quot;gm&quot;</span><span class="p">,</span> <span class="s2">&quot;wm&quot;</span><span class="p">])),</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">has_in_noinu</span> <span class="ow">and</span> <span class="n">has_headmask</span> <span class="ow">and</span> <span class="n">has_rotmask</span><span class="p">:</span>
            <span class="c1"># FBER</span>
            <span class="n">results_dict</span><span class="p">[</span><span class="s2">&quot;fber&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fber</span><span class="p">(</span><span class="n">inudata</span><span class="p">,</span> <span class="n">headdata</span><span class="p">,</span> <span class="n">rotdata</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">has_in_noinu</span> <span class="ow">and</span> <span class="n">has_rotmask</span><span class="p">:</span>
            <span class="c1"># EFC</span>
            <span class="n">results_dict</span><span class="p">[</span><span class="s2">&quot;efc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">efc</span><span class="p">(</span><span class="n">inudata</span><span class="p">,</span> <span class="n">rotdata</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">has_stats</span> <span class="ow">and</span> <span class="n">has_in_noinu</span><span class="p">:</span>
            <span class="c1"># M2WM</span>
            <span class="n">results_dict</span><span class="p">[</span><span class="s2">&quot;wm2max&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">wm2max</span><span class="p">(</span><span class="n">inudata</span><span class="p">,</span> <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;wm&quot;</span><span class="p">][</span><span class="s2">&quot;median&quot;</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">has_airmask</span> <span class="ow">and</span> <span class="n">has_artmask</span><span class="p">:</span>
            <span class="c1"># Artifacts</span>
            <span class="n">results_dict</span><span class="p">[</span><span class="s2">&quot;qi_1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">art_qi1</span><span class="p">(</span><span class="n">airdata</span><span class="p">,</span> <span class="n">artdata</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hatmask</span> <span class="o">!=</span> <span class="n">Undefined</span><span class="p">:</span>
            <span class="c1"># Artifacts QI2</span>
            <span class="n">results_dict</span><span class="p">[</span><span class="s2">&quot;qi_2&quot;</span><span class="p">],</span> <span class="n">results_dict</span><span class="p">[</span><span class="s2">&quot;histogram_qi2&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">art_qi2</span><span class="p">(</span><span class="n">imdata</span><span class="p">,</span>
                                <span class="n">nb</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hatmask</span><span class="p">)</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">())</span>

        <span class="k">if</span> <span class="n">has_stats</span><span class="p">:</span>
            <span class="c1"># CJV</span>
            <span class="n">results_dict</span><span class="p">[</span><span class="s2">&quot;cjv&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cjv</span><span class="p">(</span>
                <span class="c1"># mu_wm, mu_gm, sigma_wm, sigma_gm</span>
                <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;wm&quot;</span><span class="p">][</span><span class="s2">&quot;median&quot;</span><span class="p">],</span>
                <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;gm&quot;</span><span class="p">][</span><span class="s2">&quot;median&quot;</span><span class="p">],</span>
                <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;wm&quot;</span><span class="p">][</span><span class="s2">&quot;mad&quot;</span><span class="p">],</span>
                <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;gm&quot;</span><span class="p">][</span><span class="s2">&quot;mad&quot;</span><span class="p">],</span>
            <span class="p">)</span>

        <span class="c1"># FWHM</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_fwhm</span> <span class="ow">and</span> <span class="n">has_in_noinu</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_fwhm</span><span class="p">)</span>
                <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
                <span class="n">str_fwhm</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[-+]?\d*\.*\d+&quot;</span><span class="p">,</span> <span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">fwhm</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">str_fwhm</span><span class="p">:</span>
                    <span class="n">fwhm</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">item</span><span class="p">))</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">FileNotFoundError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Error with fwhm file: &quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fwhm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fwhm</span><span class="p">[:</span><span class="mi">3</span><span class="p">])</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                    <span class="n">imnii</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">get_zooms</span><span class="p">()[:</span><span class="mi">3</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="n">results_dict</span><span class="p">[</span><span class="s2">&quot;fwhm&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">fwhm</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                    <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">fwhm</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                    <span class="s2">&quot;z&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">fwhm</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
                    <span class="s2">&quot;avg&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">fwhm</span><span class="p">)),</span>
                <span class="p">}</span>

        <span class="k">if</span> <span class="n">has_pvms</span><span class="p">:</span>
            <span class="c1"># ICVs</span>
            <span class="n">results_dict</span><span class="p">[</span><span class="s2">&quot;icvs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">volume_fraction</span><span class="p">(</span><span class="n">pvmdata</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">has_pvms</span> <span class="ow">and</span> <span class="n">has_segmentation</span><span class="p">:</span>
            <span class="c1"># RPVE</span>
            <span class="n">results_dict</span><span class="p">[</span><span class="s2">&quot;rpve&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rpve</span><span class="p">(</span><span class="n">pvmdata</span><span class="p">,</span> <span class="n">segdata</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">has_in_noinu</span><span class="p">:</span>
            <span class="c1"># Image specs</span>
            <span class="n">results_dict</span><span class="p">[</span><span class="s2">&quot;size&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">inudata</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">inudata</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                <span class="s2">&quot;z&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">inudata</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
            <span class="p">}</span>
            <span class="n">results_dict</span><span class="p">[</span><span class="s2">&quot;spacing&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">i</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">],</span>
                                            <span class="n">imnii</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">get_zooms</span><span class="p">()[:</span><span class="mi">3</span><span class="p">])</span>
            <span class="p">}</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">results_dict</span><span class="p">[</span><span class="s2">&quot;size&quot;</span><span class="p">][</span><span class="s2">&quot;t&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">inudata</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="k">pass</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">results_dict</span><span class="p">[</span><span class="s2">&quot;spacing&quot;</span><span class="p">][</span><span class="s2">&quot;tr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">imnii</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">get_zooms</span><span class="p">()[</span><span class="mi">3</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="k">if</span> <span class="n">has_segmentation</span><span class="p">:</span>
            <span class="c1"># Bias</span>
            <span class="n">bias</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_inu</span><span class="p">)</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">()[</span><span class="n">segdata</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">results_dict</span><span class="p">[</span><span class="s2">&quot;inu&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;range&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">bias</span><span class="p">,</span> <span class="mf">95.0</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">bias</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">))</span>
                <span class="p">),</span>
                <span class="s2">&quot;med&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">bias</span><span class="p">)),</span>
            <span class="p">}</span>  <span class="c1"># pylint: disable=E1101</span>

        <span class="k">if</span> <span class="n">has_mni_tpms</span> <span class="ow">and</span> <span class="n">has_pvms</span><span class="p">:</span>
            <span class="n">mni_tpms</span> <span class="o">=</span> <span class="p">[</span><span class="n">tpm</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">()</span> <span class="k">for</span> <span class="n">tpm</span> <span class="ow">in</span> <span class="n">mni_tpmsniis</span><span class="p">]</span>
            <span class="n">in_tpms</span> <span class="o">=</span> <span class="p">[</span><span class="n">pvm</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">()</span> <span class="k">for</span> <span class="n">pvm</span> <span class="ow">in</span> <span class="n">pvmniis</span><span class="p">]</span>
            <span class="n">overlap</span> <span class="o">=</span> <span class="n">fuzzy_jaccard</span><span class="p">(</span><span class="n">in_tpms</span><span class="p">,</span> <span class="n">mni_tpms</span><span class="p">)</span>
            <span class="n">results_dict</span><span class="p">[</span><span class="s2">&quot;tpm_overlap&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;csf&quot;</span><span class="p">:</span> <span class="n">overlap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="s2">&quot;gm&quot;</span><span class="p">:</span> <span class="n">overlap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="s2">&quot;wm&quot;</span><span class="p">:</span> <span class="n">overlap</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
            <span class="p">}</span>

        <span class="c1"># Flatten the dictionary</span>
        <span class="n">flat_results_dict</span> <span class="o">=</span> <span class="n">_flatten_dict</span><span class="p">(</span><span class="n">results_dict</span><span class="p">)</span>

        <span class="c1"># Save results as json</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_ras</span><span class="p">)</span>
        <span class="n">file_name_no_ext</span><span class="p">,</span> <span class="n">file_extension</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">file_extension</span> <span class="o">==</span> <span class="s1">&#39;.gz&#39;</span><span class="p">:</span>
            <span class="p">(</span><span class="n">file_name_no_ext_2</span><span class="p">,</span>
             <span class="n">file_extension_2</span><span class="p">)</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file_name_no_ext</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">file_extension_2</span> <span class="o">==</span> <span class="s1">&#39;.nii&#39;</span><span class="p">:</span>
                <span class="n">file_name_no_ext</span> <span class="o">=</span> <span class="n">file_name_no_ext_2</span>

        <span class="n">report_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span>
                                   <span class="p">(</span><span class="n">file_name_no_ext</span> <span class="o">+</span>
                                    <span class="s1">&#39;_anat_qc.json&#39;</span><span class="p">))</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">report_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">flat_results_dict</span><span class="p">,</span> <span class="n">fp</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="BoldIQMs"><a class="viewcode-back" href="../../../../mia_processes.bricks.reports.html#mia_processes.bricks.reports.processes.BoldIQMs">[docs]</a><span class="k">class</span> <span class="nc">BoldIQMs</span><span class="p">(</span><span class="n">ProcessMIA</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        * Computes the functional IQMs.</span>

<span class="sd">        Please, see the complete documentation for the `BoldIQMs&#39; brick </span>
<span class="sd">        in the populse.mia_processes website</span>
<span class="sd">        https://populse.github.io/mia_processes/html/documentation/bricks/preprocess/other/BoldIQMs.html</span>

<span class="sd">        adapted from:</span>
<span class="sd">        https://github.com/nipreps/mriqc/blob/e021008da0a2ef1c48e882baf932139a673349f9/mriqc/workflows/functional.py#L243</span>

<span class="sd">        &quot;&quot;&quot;</span>

<div class="viewcode-block" id="BoldIQMs.__init__"><a class="viewcode-back" href="../../../../mia_processes.bricks.reports.html#mia_processes.bricks.reports.processes.BoldIQMs.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the attributes initialisation / instantiation.</span>

<span class="sd">        The input and output plugs are defined here. The special</span>
<span class="sd">        &#39;self.requirement&#39; attribute (optional) is used to define the</span>
<span class="sd">        third-party products necessary for the running of the brick.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Initialisation of the objects needed for the launch of the brick</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">BoldIQMs</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1"># Third party softwares required for the execution of the brick</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requirement</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Inputs description</span>
        <span class="n">in_epi_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;EPI input image (a pathlike object or string &#39;</span>
                       <span class="s1">&#39;representing a file).&#39;</span><span class="p">)</span>
        <span class="n">in_hmc_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Motion corrected input image (a pathlike object or&#39;</span>
                       <span class="s1">&#39;string representing a file).&#39;</span><span class="p">)</span>
        <span class="n">in_tsnr_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;tSNR input volume (a pathlike object or string &#39;</span>
                        <span class="s1">&#39;representing a file).&#39;</span><span class="p">)</span>
        <span class="n">in_mask_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Input mask image (a pathlike object or string &#39;</span>
                        <span class="s1">&#39;representing a file).&#39;</span><span class="p">)</span>
        <span class="n">in_fd_thresh_desc</span> <span class="o">=</span> <span class="s1">&#39;Motion threshold for FD computation (a float)&#39;</span>
        <span class="n">in_outliers_file_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;outliers file (a pathlike object or string &#39;</span>
                                 <span class="s1">&#39;representing a file).&#39;</span><span class="p">)</span>
        <span class="n">in_QI_file_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Quality index file (a pathlike object or string &#39;</span>
                           <span class="s1">&#39;representing a file).&#39;</span><span class="p">)</span>
        <span class="n">in_fwhm_file_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;FWHM file (a pathlike object or string &#39;</span>
                             <span class="s1">&#39;representing a file).&#39;</span><span class="p">)</span>
        <span class="n">in_dvars_file_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;DVARS file (a pathlike object or string &#39;</span>
                              <span class="s1">&#39;representing a file).&#39;</span><span class="p">)</span>
        <span class="n">in_fd_file_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;FD file (a pathlike object or string &#39;</span>
                           <span class="s1">&#39;representing a file).&#39;</span><span class="p">)</span>
        <span class="n">in_spikes_file_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Spikes file (a pathlike object or string &#39;</span>
                               <span class="s1">&#39;representing a file).&#39;</span><span class="p">)</span>
        <span class="n">in_gcor_desc</span> <span class="o">=</span> <span class="s1">&#39;Global correlation value (a float)&#39;</span>
        <span class="n">in_dummy_TRs_desc</span> <span class="o">=</span> <span class="s1">&#39;Number of dummy scans (an int)&#39;</span>

        <span class="c1"># Outputs description</span>
        <span class="n">out_file_desc</span> <span class="o">=</span> <span class="s1">&#39;a json file containing IQMs&#39;</span>

        <span class="c1"># Inputs traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;in_epi&quot;</span><span class="p">,</span>
                       <span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">optional</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">desc</span><span class="o">=</span><span class="n">in_epi_desc</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;in_hmc&quot;</span><span class="p">,</span>
                       <span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">desc</span><span class="o">=</span><span class="n">in_hmc_desc</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;in_tsnr&quot;</span><span class="p">,</span>
                       <span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">desc</span><span class="o">=</span><span class="n">in_tsnr_desc</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;in_mask&quot;</span><span class="p">,</span>
                       <span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">desc</span><span class="o">=</span><span class="n">in_mask_desc</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;in_outliers_file&quot;</span><span class="p">,</span>
                       <span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">desc</span><span class="o">=</span><span class="n">in_outliers_file_desc</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;in_QI_file&quot;</span><span class="p">,</span>
                       <span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">desc</span><span class="o">=</span><span class="n">in_QI_file_desc</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;in_fwhm_file&quot;</span><span class="p">,</span>
                       <span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">desc</span><span class="o">=</span><span class="n">in_fwhm_file_desc</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;in_dvars_file&quot;</span><span class="p">,</span>
                       <span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">desc</span><span class="o">=</span><span class="n">in_dvars_file_desc</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;in_fd_file&quot;</span><span class="p">,</span>
                       <span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">desc</span><span class="o">=</span><span class="n">in_fd_file_desc</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;in_fd_thresh&quot;</span><span class="p">,</span>
                       <span class="n">traits</span><span class="o">.</span><span class="n">Float</span><span class="p">(</span><span class="mf">0.2</span><span class="p">,</span>
                                    <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                    <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                    <span class="n">desc</span><span class="o">=</span><span class="n">in_fd_thresh_desc</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;in_spikes_file&quot;</span><span class="p">,</span>
                       <span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">desc</span><span class="o">=</span><span class="n">in_spikes_file_desc</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;in_gcor&quot;</span><span class="p">,</span>
                       <span class="n">traits</span><span class="o">.</span><span class="n">Float</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                    <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                    <span class="n">desc</span><span class="o">=</span><span class="n">in_gcor_desc</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;in_dummy_TRs&quot;</span><span class="p">,</span>
                       <span class="n">traits</span><span class="o">.</span><span class="n">Int</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                  <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                  <span class="n">desc</span><span class="o">=</span><span class="n">in_dummy_TRs_desc</span><span class="p">))</span>

        <span class="c1"># Outputs traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;out_file&quot;</span><span class="p">,</span>
                       <span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">desc</span><span class="o">=</span><span class="n">out_file_desc</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">init_default_traits</span><span class="p">()</span></div>

<div class="viewcode-block" id="BoldIQMs.list_outputs"><a class="viewcode-back" href="../../../../mia_processes.bricks.reports.html#mia_processes.bricks.reports.processes.BoldIQMs.list_outputs">[docs]</a>    <span class="k">def</span> <span class="nf">list_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_plugged</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the initialisation step of the brick.</span>

<span class="sd">        The main objective of this method is to produce the outputs of the</span>
<span class="sd">        bricks (self.outputs) and the associated tags (self.inheritance_dic),</span>
<span class="sd">        if defined here. To work properly this method must return</span>
<span class="sd">        self.make_initResult() object.</span>

<span class="sd">        :param is_plugged: the state, linked or not, of the plugs.</span>
<span class="sd">        :returns: a dictionary with requirement, outputs and inheritance_dict.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Using the inheritance to ProcessMIA class, list_outputs method</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">BoldIQMs</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">list_outputs</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_epi</span><span class="p">:</span>
            <span class="n">valid_ext</span><span class="p">,</span> <span class="n">in_ext</span><span class="p">,</span> <span class="n">fileName</span> <span class="o">=</span> <span class="n">checkFileExt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_epi</span><span class="p">,</span> <span class="n">EXT</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_ext</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">The input image format is not recognized ...!&#39;</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="n">report_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span>
                                       <span class="p">(</span><span class="n">fileName</span> <span class="o">+</span>
                                        <span class="s1">&#39;_bold_qc.json&#39;</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">fileName</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;out_file&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">report_file</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;- There was no output file deducted during &#39;</span>
                      <span class="s1">&#39;initialisation. Please check the input parameters...!&#39;</span><span class="p">)</span>

            <span class="c1"># tags inheritance (optional)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">inheritance_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span>
                    <span class="s1">&#39;out_file&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_epi</span>

        <span class="c1"># Return the requirement, outputs and inheritance_dict</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_initResult</span><span class="p">()</span></div>

<div class="viewcode-block" id="BoldIQMs.run_process_mia"><a class="viewcode-back" href="../../../../mia_processes.bricks.reports.html#mia_processes.bricks.reports.processes.BoldIQMs.run_process_mia">[docs]</a>    <span class="k">def</span> <span class="nf">run_process_mia</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the process launch step of the brick.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">BoldIQMs</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">run_process_mia</span><span class="p">()</span>

        <span class="c1"># Get the mean EPI data and get it ready</span>
        <span class="n">epinii</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_epi</span><span class="p">)</span>
        <span class="n">epidata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">epinii</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">())</span>
        <span class="n">epidata</span> <span class="o">=</span> <span class="n">epidata</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">epidata</span><span class="p">[</span><span class="n">epidata</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Get EPI data (with mc done) and get it ready</span>
        <span class="n">has_in_hmc</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_hmc</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">hmcnii</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_hmc</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="n">nb</span><span class="o">.</span><span class="n">filebasedimages</span><span class="o">.</span><span class="n">ImageFileError</span><span class="p">,</span>
                    <span class="ne">FileNotFoundError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">has_in_hmc</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Error with in_hmc file: &quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">hmcdata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">hmcnii</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">())</span>
                <span class="n">hmcdata</span> <span class="o">=</span> <span class="n">hmcdata</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
                <span class="n">hmcdata</span><span class="p">[</span><span class="n">hmcdata</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">has_in_hmc</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Get EPI data (with mc done) and get it ready</span>
        <span class="n">has_in_mask</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_mask</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">msknii</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_mask</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="n">nb</span><span class="o">.</span><span class="n">filebasedimages</span><span class="o">.</span><span class="n">ImageFileError</span><span class="p">,</span>
                    <span class="ne">FileNotFoundError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">has_in_mask</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Error with in_mask file: &quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mskdata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">msknii</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">())</span>
                <span class="n">mskdata</span><span class="p">[</span><span class="n">mskdata</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">mskdata</span><span class="p">[</span><span class="n">mskdata</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">mskdata</span> <span class="o">=</span> <span class="n">mskdata</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">has_in_mask</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Get tsnr data and get it ready</span>
        <span class="n">has_in_tsnr</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_tsnr</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">tsnr_nii</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_tsnr</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="n">nb</span><span class="o">.</span><span class="n">filebasedimages</span><span class="o">.</span><span class="n">ImageFileError</span><span class="p">,</span>
                    <span class="ne">FileNotFoundError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">has_in_tsnr</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Error with in_mask file: &quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># nibabel: get_data() is deprecated in favour of get_fdata().</span>
                <span class="c1"># We only keep here get_data() to achieve reproducibility</span>
                <span class="c1"># with native mriqc results (which use get_data() in V22.06)</span>
                <span class="n">tsnr_data</span> <span class="o">=</span> <span class="n">tsnr_nii</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">has_in_tsnr</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">results_dict</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="n">has_in_mask</span><span class="p">:</span>
            <span class="c1"># Summary stats</span>
            <span class="n">stats</span> <span class="o">=</span> <span class="n">summary_stats</span><span class="p">(</span><span class="n">epidata</span><span class="p">,</span> <span class="n">mskdata</span><span class="p">,</span> <span class="n">erode</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">results_dict</span><span class="p">[</span><span class="s2">&quot;summary&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stats</span>

            <span class="c1"># SNR</span>
            <span class="n">results_dict</span><span class="p">[</span><span class="s2">&quot;snr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">snr</span><span class="p">(</span>
                <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;fg&quot;</span><span class="p">][</span><span class="s2">&quot;median&quot;</span><span class="p">],</span> <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;fg&quot;</span><span class="p">][</span><span class="s2">&quot;stdv&quot;</span><span class="p">],</span> <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;fg&quot;</span><span class="p">][</span><span class="s2">&quot;n&quot;</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="c1"># FBER</span>
            <span class="n">results_dict</span><span class="p">[</span><span class="s2">&quot;fber&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fber</span><span class="p">(</span><span class="n">epidata</span><span class="p">,</span> <span class="n">mskdata</span><span class="p">)</span>

        <span class="c1"># EFC</span>
        <span class="n">results_dict</span><span class="p">[</span><span class="s2">&quot;efc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">efc</span><span class="p">(</span><span class="n">epidata</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">has_in_mask</span><span class="p">:</span>
            <span class="n">results_dict</span><span class="p">[</span><span class="s2">&quot;gsr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">epidir</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">axis</span> <span class="ow">in</span> <span class="n">epidir</span><span class="p">:</span>
                <span class="n">results_dict</span><span class="p">[</span><span class="s2">&quot;gsr&quot;</span><span class="p">][</span><span class="n">axis</span><span class="p">]</span> <span class="o">=</span> <span class="n">gsr</span><span class="p">(</span><span class="n">epidata</span><span class="p">,</span> <span class="n">mskdata</span><span class="p">,</span>
                                                <span class="n">direction</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span>

        <span class="c1"># aor</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_outliers_file</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">outliers</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">in_outliers_file</span><span class="p">,</span> <span class="n">skiprows</span><span class="o">=</span><span class="mi">0</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">FileNotFoundError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Error with aor file: &quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">results_dict</span><span class="p">[</span><span class="s2">&quot;vec_outliers&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">outliers</span><span class="p">)</span>
                <span class="n">results_dict</span><span class="p">[</span><span class="s2">&quot;aor&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">outliers</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

        <span class="c1"># aqi</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_QI_file</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_QI_file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fin</span><span class="p">:</span>
                    <span class="n">lines</span> <span class="o">=</span> <span class="n">fin</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">FileNotFoundError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Error with aqi file: &quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">results_dict</span><span class="p">[</span><span class="s2">&quot;aqi&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;++&quot;</span><span class="p">)])</span>

        <span class="c1"># DVARS</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_dvars_file</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">dvars</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">in_dvars_file</span><span class="p">,</span> <span class="n">skiprows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">usecols</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">FileNotFoundError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Error with dvars file: &quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">results_dict</span><span class="p">[</span><span class="s2">&quot;vec_dvars&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">dvars</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span>
                <span class="n">dvars_avg</span> <span class="o">=</span> <span class="n">dvars</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">dvars_col</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;std&quot;</span><span class="p">,</span> <span class="s2">&quot;nstd&quot;</span><span class="p">,</span> <span class="s2">&quot;vstd&quot;</span><span class="p">]</span>
                <span class="n">results_dict</span><span class="p">[</span><span class="s2">&quot;dvars&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="n">key</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">dvars_col</span><span class="p">,</span> <span class="n">dvars_avg</span><span class="p">)</span>
                <span class="p">}</span>

        <span class="c1"># tSNR</span>
        <span class="k">if</span> <span class="n">has_in_tsnr</span><span class="p">:</span>
            <span class="n">results_dict</span><span class="p">[</span><span class="s2">&quot;tsnr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">tsnr_data</span><span class="p">[</span><span class="n">mskdata</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]))</span>

        <span class="c1"># FD</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_fd_file</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">fd_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_fd_file</span><span class="p">,</span> <span class="n">skiprows</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">FileNotFoundError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Error with fd file: &quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">results_dict</span><span class="p">[</span><span class="s2">&quot;vec_fd&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">fd_data</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_fd_thresh</span><span class="p">:</span>
                    <span class="n">num_fd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">((</span><span class="n">fd_data</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_fd_thresh</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
                    <span class="n">results_dict</span><span class="p">[</span><span class="s2">&quot;fd&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">&quot;mean&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">fd_data</span><span class="o">.</span><span class="n">mean</span><span class="p">()),</span>
                        <span class="s2">&quot;num&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">num_fd</span><span class="p">),</span>
                        <span class="s2">&quot;perc&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">num_fd</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">/</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fd_data</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)),</span>
                    <span class="p">}</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">results_dict</span><span class="p">[</span><span class="s2">&quot;fd&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">&quot;mean&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">fd_data</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
                    <span class="p">}</span>

        <span class="c1"># FWHM</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_fwhm_file</span> <span class="ow">and</span> <span class="n">has_in_hmc</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_fwhm_file</span><span class="p">)</span>
                <span class="n">lines</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
                <span class="n">str_fwhm</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[-+]?\d*\.*\d+&quot;</span><span class="p">,</span> <span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">fwhm</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">str_fwhm</span><span class="p">:</span>
                    <span class="n">fwhm</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">item</span><span class="p">))</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">FileNotFoundError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Error with fwhm file: &quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fwhm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fwhm</span><span class="p">[:</span><span class="mi">3</span><span class="p">])</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                    <span class="n">hmcnii</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">get_zooms</span><span class="p">()[:</span><span class="mi">3</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="n">results_dict</span><span class="p">[</span><span class="s2">&quot;fwhm&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">fwhm</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                    <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">fwhm</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                    <span class="s2">&quot;z&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">fwhm</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
                    <span class="s2">&quot;avg&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">fwhm</span><span class="p">)),</span>
                <span class="p">}</span>

        <span class="k">if</span> <span class="n">has_in_hmc</span><span class="p">:</span>
            <span class="c1"># Image specs</span>
            <span class="n">results_dict</span><span class="p">[</span><span class="s2">&quot;size&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">hmcdata</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                <span class="s2">&quot;y&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">hmcdata</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
                <span class="s2">&quot;z&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">hmcdata</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span>
            <span class="p">}</span>
            <span class="n">results_dict</span><span class="p">[</span><span class="s2">&quot;spacing&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">i</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">([</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">],</span> <span class="n">hmcnii</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">get_zooms</span><span class="p">()[:</span><span class="mi">3</span><span class="p">])</span>
            <span class="p">}</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">results_dict</span><span class="p">[</span><span class="s2">&quot;size&quot;</span><span class="p">][</span><span class="s2">&quot;t&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">hmcdata</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="k">pass</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">results_dict</span><span class="p">[</span><span class="s2">&quot;spacing&quot;</span><span class="p">][</span><span class="s2">&quot;tr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">hmcnii</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">get_zooms</span><span class="p">()[</span><span class="mi">3</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="c1"># GCOR</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">gcor</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_gcor</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
             <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">gcor value error&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">results_dict</span><span class="p">[</span><span class="s2">&quot;gcor&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gcor</span>

        <span class="c1"># Dummy TRs</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">dummy_trs</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_dummy_TRs</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
             <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">dummy_trs value error&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">results_dict</span><span class="p">[</span><span class="s2">&quot;dummy_trs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dummy_trs</span>

        <span class="c1"># Spikes</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_spikes_file</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">spikes_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_spikes_file</span><span class="p">,</span> <span class="n">skiprows</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">FileNotFoundError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Error with fd file: &quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">spikes_data</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])):</span>
                    <span class="n">spike_name</span> <span class="o">=</span> <span class="s2">&quot;vec_spikes_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                    <span class="n">results_dict</span><span class="p">[</span><span class="n">spike_name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">spikes_data</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:])</span>

        <span class="c1"># Flatten the dictionary</span>
        <span class="n">flat_results_dict</span> <span class="o">=</span> <span class="n">_flatten_dict</span><span class="p">(</span><span class="n">results_dict</span><span class="p">)</span>

        <span class="c1"># Save results as json</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_epi</span><span class="p">)</span>
        <span class="n">file_name_no_ext</span><span class="p">,</span> <span class="n">file_extension</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">file_extension</span> <span class="o">==</span> <span class="s1">&#39;.gz&#39;</span><span class="p">:</span>
            <span class="p">(</span><span class="n">file_name_no_ext_2</span><span class="p">,</span>
             <span class="n">file_extension_2</span><span class="p">)</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file_name_no_ext</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">file_extension_2</span> <span class="o">==</span> <span class="s1">&#39;.nii&#39;</span><span class="p">:</span>
                <span class="n">file_name_no_ext</span> <span class="o">=</span> <span class="n">file_name_no_ext_2</span>

        <span class="n">report_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span>
                                   <span class="p">(</span><span class="n">file_name_no_ext</span> <span class="o">+</span>
                                    <span class="s1">&#39;_bold_qc.json&#39;</span><span class="p">))</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">report_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">flat_results_dict</span><span class="p">,</span> <span class="n">fp</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="CarpetParcellation"><a class="viewcode-back" href="../../../../mia_processes.bricks.reports.html#mia_processes.bricks.reports.processes.CarpetParcellation">[docs]</a><span class="k">class</span> <span class="nc">CarpetParcellation</span><span class="p">(</span><span class="n">ProcessMIA</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    * | Dilate brainmask, substract from itself then generate</span>
<span class="sd">      | the union of obtained crown mask and epi parcellation.</span>

<span class="sd">    Please, see the complete documentation for the `CarpetParcellation&#39; brick </span>
<span class="sd">    in the populse.mia_processes website</span>
<span class="sd">    &lt;https://populse.github.io/mia_processes/html/documentation/bricks/reports/CarpetParcellation.html&gt;`_</span>

<span class="sd">    adapted from:</span>
<span class="sd">    https://github.com/nipreps/niworkflows/blob/45ab13e1bf6fdbf5e29c90cef44055b0b9cf391b/niworkflows/interfaces/morphology.py#L46</span>
<span class="sd">    https://github.com/nipreps/niworkflows/blob/45ab13e1bf6fdbf5e29c90cef44055b0b9cf391b/niworkflows/interfaces/morphology.py#L79</span>
<span class="sd">    https://github.com/nipreps/mriqc/blob/e021008da0a2ef1c48e882baf932139a673349f9/mriqc/workflows/functional.py#L1022</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="CarpetParcellation.__init__"><a class="viewcode-back" href="../../../../mia_processes.bricks.reports.html#mia_processes.bricks.reports.processes.CarpetParcellation.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the attributes initialisation/instantiation.</span>

<span class="sd">        The input and output plugs are defined here. The special</span>
<span class="sd">        &#39;self.requirement&#39; attribute (optional) is used to define the</span>
<span class="sd">        third-party products necessary for the running of the brick.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Initialisation of the objects needed for the launch of the brick</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CarpetParcellation</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1"># Third party softwares required for the execution of the brick</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requirement</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Inputs description</span>
        <span class="n">segmentation_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;EPI segmentation (a pathlike object or string &#39;</span>
                             <span class="s1">&#39;representing a file).&#39;</span><span class="p">)</span>
        <span class="n">brainmask_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Brain mask (a pathlike object or string &#39;</span>
                          <span class="s1">&#39;representing a file).&#39;</span><span class="p">)</span>

        <span class="n">out_prefix_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Specify the string to be prepended to the &#39;</span>
                           <span class="s1">&#39;segmentation filename of the output file (a string).&#39;</span><span class="p">)</span>

        <span class="c1"># Outputs description</span>
        <span class="n">out_file_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;The output file (a pathlike object or a &#39;</span>
                         <span class="s1">&#39;string representing a file).&#39;</span><span class="p">)</span>

        <span class="c1"># Inputs traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;segmentation&quot;</span><span class="p">,</span>
                       <span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">optional</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">desc</span><span class="o">=</span><span class="n">segmentation_desc</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;brainmask&quot;</span><span class="p">,</span>
                       <span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">optional</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">desc</span><span class="o">=</span><span class="n">brainmask_desc</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;out_prefix&quot;</span><span class="p">,</span>
                       <span class="n">traits</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="s1">&#39;cseg_&#39;</span><span class="p">,</span>
                                     <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                     <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                     <span class="n">desc</span><span class="o">=</span><span class="n">out_prefix_desc</span><span class="p">))</span>

        <span class="c1"># Outputs traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;out_file&quot;</span><span class="p">,</span>
                       <span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">desc</span><span class="o">=</span><span class="n">out_file_desc</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">init_default_traits</span><span class="p">()</span></div>

<div class="viewcode-block" id="CarpetParcellation.list_outputs"><a class="viewcode-back" href="../../../../mia_processes.bricks.reports.html#mia_processes.bricks.reports.processes.CarpetParcellation.list_outputs">[docs]</a>    <span class="k">def</span> <span class="nf">list_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_plugged</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the initialisation step of the brick.</span>

<span class="sd">        The main objective of this method is to produce the outputs of the</span>
<span class="sd">        bricks (self.outputs) and the associated tags (self.inheritance_dic),</span>
<span class="sd">        if defined here. In order not to include an output in the database,</span>
<span class="sd">        this output must be a value of the optional key &#39;notInDb&#39; of the</span>
<span class="sd">        self.outputs dictionary. To work properly this method must return</span>
<span class="sd">        self.make_initResult() object.</span>

<span class="sd">        :param is_plugged: the state, linked or not, of the plugs.</span>
<span class="sd">        :returns: a dictionary with requirement, outputs and inheritance_dict.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Using the inheritance to ProcessMIA class, list_outputs method</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CarpetParcellation</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">list_outputs</span><span class="p">()</span>

        <span class="c1"># Outputs definition and tags inheritance (optional)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">segmentation</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">brainmask</span><span class="p">:</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_prefix</span> <span class="o">==</span> <span class="n">Undefined</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">out_prefix</span> <span class="o">=</span> <span class="s1">&#39;cseg_&#39;</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;The out_prefix parameter is undefined. Automatically &#39;</span>
                      <span class="s1">&#39;set to &quot;cseg&quot; ...&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">:</span>
                <span class="n">valid_ext</span><span class="p">,</span> <span class="n">in_ext</span><span class="p">,</span> <span class="n">fileName</span> <span class="o">=</span> <span class="n">checkFileExt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">segmentation</span><span class="p">,</span> <span class="n">EXT</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_ext</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">The input image format is not recognized ...!&#39;</span><span class="p">)</span>
                    <span class="k">return</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;out_file&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">out_prefix</span> <span class="o">+</span> <span class="n">fileName</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span> <span class="n">in_ext</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No output_directory was found...!</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">inheritance_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span>
                <span class="s1">&#39;out_file&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">segmentation</span>

        <span class="c1"># Return the requirement, outputs and inheritance_dict</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_initResult</span><span class="p">()</span></div>

<div class="viewcode-block" id="CarpetParcellation.run_process_mia"><a class="viewcode-back" href="../../../../mia_processes.bricks.reports.html#mia_processes.bricks.reports.processes.CarpetParcellation.run_process_mia">[docs]</a>    <span class="k">def</span> <span class="nf">run_process_mia</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the process launch step of the brick.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CarpetParcellation</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">run_process_mia</span><span class="p">()</span>

        <span class="c1"># Binary dilation</span>
        <span class="n">brainmask_img</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">brainmask</span><span class="p">)</span>
        <span class="n">brainmaskdata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">bool_</span><span class="p">(</span><span class="n">brainmask_img</span><span class="o">.</span><span class="n">dataobj</span><span class="p">)</span>

        <span class="c1"># Obtain dilated brainmask</span>
        <span class="n">dilated</span> <span class="o">=</span> <span class="n">image_binary_dilation</span><span class="p">(</span>
            <span class="n">brainmaskdata</span><span class="p">,</span>
            <span class="n">radius</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Binary substraction</span>
        <span class="n">brainmaskdata</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">bool_</span><span class="p">(</span><span class="n">dilated</span><span class="p">)]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Carpet parcellation</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">segmentation</span><span class="p">)</span>

        <span class="n">lut</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">256</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;uint8&quot;</span><span class="p">)</span>
        <span class="n">lut</span><span class="p">[</span><span class="mi">100</span><span class="p">:</span><span class="mi">201</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># Ctx GM</span>
        <span class="n">lut</span><span class="p">[</span><span class="mi">30</span><span class="p">:</span><span class="mi">99</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>  <span class="c1"># dGM</span>
        <span class="n">lut</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span>  <span class="c1"># WM+CSF</span>
        <span class="n">lut</span><span class="p">[</span><span class="mi">255</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span>  <span class="c1"># Cerebellum</span>
        <span class="c1"># Apply lookup table</span>
        <span class="n">seg</span> <span class="o">=</span> <span class="n">lut</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">asanyarray</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">dataobj</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;uint16&quot;</span><span class="p">)]</span>
        <span class="n">seg</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">asanyarray</span><span class="p">(</span><span class="n">brainmaskdata</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span>

        <span class="c1"># Out file name</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">segmentation</span><span class="p">)</span>

        <span class="n">file_out</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span>
                                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">out_prefix</span> <span class="o">+</span>
                                 <span class="n">file_name</span><span class="p">))</span>

        <span class="n">outimg</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="n">seg</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;uint8&quot;</span><span class="p">),</span> <span class="n">img</span><span class="o">.</span><span class="n">affine</span><span class="p">,</span> <span class="n">img</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>
        <span class="n">outimg</span><span class="o">.</span><span class="n">set_data_dtype</span><span class="p">(</span><span class="s2">&quot;uint8&quot;</span><span class="p">)</span>
        <span class="n">outimg</span><span class="o">.</span><span class="n">to_filename</span><span class="p">(</span><span class="n">file_out</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="ComputeDVARS"><a class="viewcode-back" href="../../../../mia_processes.bricks.reports.html#mia_processes.bricks.reports.processes.ComputeDVARS">[docs]</a><span class="k">class</span> <span class="nc">ComputeDVARS</span><span class="p">(</span><span class="n">ProcessMIA</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    * Computes the DVARS.</span>

<span class="sd">    Please, see the complete documentation for the `ComputeDVARS&#39; brick </span>
<span class="sd">    in the populse.mia_processes website</span>
<span class="sd">    &lt;https://populse.github.io/mia_processes/html/documentation/bricks/reports/ComputeDVARS.html&gt;`_</span>

<span class="sd">    adapted from:</span>
<span class="sd">    https://github.com/nipy/nipype/blob/f662acfce8def4717e0c3414618f3a5de5913b31/nipype/algorithms/confounds.py#L100</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="ComputeDVARS.__init__"><a class="viewcode-back" href="../../../../mia_processes.bricks.reports.html#mia_processes.bricks.reports.processes.ComputeDVARS.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the attributes initialisation/instantiation.</span>

<span class="sd">        The input and output plugs are defined here. The special</span>
<span class="sd">        &#39;self.requirement&#39; attribute (optional) is used to define the</span>
<span class="sd">        third-party products necessary for the running of the brick.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Initialisation of the objects needed for the launch of the brick</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ComputeDVARS</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1"># Third party softwares required for the execution of the brick</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requirement</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Inputs description</span>
        <span class="n">in_file_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Bold image after HMC (a pathlike object or string &#39;</span>
                        <span class="s1">&#39;representing a file).&#39;</span><span class="p">)</span>
        <span class="n">in_mask_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Brain mask (a pathlike object or string &#39;</span>
                        <span class="s1">&#39;representing a file).&#39;</span><span class="p">)</span>
        <span class="n">remove_zero_variance_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Remove voxels with zero variance&#39;</span>
                                     <span class="s1">&#39;(a bool).&#39;</span><span class="p">)</span>
        <span class="n">intensity_normalization_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Divide value in each voxel at each&#39;</span>
                                        <span class="s1">&#39;timepoint by the median calculated&#39;</span>
                                        <span class="s1">&#39;across all voxels and timepoints&#39;</span>
                                        <span class="s1">&#39;within the mask (if specified) and&#39;</span>
                                        <span class="s1">&#39;then multiply by the value specified&#39;</span>
                                        <span class="s1">&#39;by this parameter.&#39;</span>
                                        <span class="s1">&#39;By using the default (1000)&#39;</span>
                                        <span class="s1">&#39;output DVARS will be expressed in &#39;</span>
                                        <span class="s1">&#39;x10 % BOLD units compatible&#39;</span>
                                        <span class="s1">&#39;with Power et al.2012.&#39;</span>
                                        <span class="s1">&#39;Set this to 0 to disable intensity&#39;</span>
                                        <span class="s1">&#39;normalization altogether. (a float)&#39;</span><span class="p">)</span>
        <span class="n">variance_tol_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Maximum variance to consider &quot;close to&quot; zero&#39;</span>
                             <span class="s1">&#39;for the purposes of removal&#39;</span><span class="p">)</span>
        <span class="n">out_prefix_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Specify the string to be prepended to the &#39;</span>
                           <span class="s1">&#39;filename of the output file (a string).&#39;</span><span class="p">)</span>

        <span class="c1"># Outputs description</span>
        <span class="n">out_file_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;The output file (a pathlike object or a &#39;</span>
                         <span class="s1">&#39;string representing a file).&#39;</span><span class="p">)</span>

        <span class="c1"># Inputs traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;in_file&quot;</span><span class="p">,</span>
                       <span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">optional</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">desc</span><span class="o">=</span><span class="n">in_file_desc</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;in_mask&quot;</span><span class="p">,</span>
                       <span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">optional</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">desc</span><span class="o">=</span><span class="n">in_mask_desc</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;remove_zero_variance&quot;</span><span class="p">,</span>
                       <span class="n">traits</span><span class="o">.</span><span class="n">Bool</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                   <span class="n">desc</span><span class="o">=</span><span class="n">remove_zero_variance_desc</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;intensity_normalization&quot;</span><span class="p">,</span>
                       <span class="n">traits</span><span class="o">.</span><span class="n">Float</span><span class="p">(</span><span class="mf">1000.0</span><span class="p">,</span>
                                    <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                    <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                    <span class="n">desc</span><span class="o">=</span><span class="n">intensity_normalization_desc</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;variance_tol&quot;</span><span class="p">,</span>
                       <span class="n">traits</span><span class="o">.</span><span class="n">Float</span><span class="p">(</span><span class="mf">0.0000001000</span><span class="p">,</span>
                                    <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                    <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                    <span class="n">desc</span><span class="o">=</span><span class="n">variance_tol_desc</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;out_prefix&quot;</span><span class="p">,</span>
                       <span class="n">traits</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="s1">&#39;dvars_&#39;</span><span class="p">,</span>
                                     <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                     <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                     <span class="n">desc</span><span class="o">=</span><span class="n">out_prefix_desc</span><span class="p">))</span>

        <span class="c1"># Outputs traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;out_file&quot;</span><span class="p">,</span>
                       <span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">desc</span><span class="o">=</span><span class="n">out_file_desc</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">init_default_traits</span><span class="p">()</span></div>

<div class="viewcode-block" id="ComputeDVARS.list_outputs"><a class="viewcode-back" href="../../../../mia_processes.bricks.reports.html#mia_processes.bricks.reports.processes.ComputeDVARS.list_outputs">[docs]</a>    <span class="k">def</span> <span class="nf">list_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_plugged</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the initialisation step of the brick.</span>

<span class="sd">        The main objective of this method is to produce the outputs of the</span>
<span class="sd">        bricks (self.outputs) and the associated tags (self.inheritance_dic),</span>
<span class="sd">        if defined here. In order not to include an output in the database,</span>
<span class="sd">        this output must be a value of the optional key &#39;notInDb&#39; of the</span>
<span class="sd">        self.outputs dictionary. To work properly this method must return</span>
<span class="sd">        self.make_initResult() object.</span>

<span class="sd">        :param is_plugged: the state, linked or not, of the plugs.</span>
<span class="sd">        :returns: a dictionary with requirement, outputs and inheritance_dict.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Using the inheritance to ProcessMIA class, list_outputs method</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ComputeDVARS</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">list_outputs</span><span class="p">()</span>

        <span class="c1"># Outputs definition and tags inheritance (optional)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_file</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_mask</span><span class="p">:</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_prefix</span> <span class="o">==</span> <span class="n">Undefined</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">out_prefix</span> <span class="o">=</span> <span class="s1">&#39;dvars_&#39;</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;The out_prefix parameter is undefined. Automatically &#39;</span>
                      <span class="s1">&#39;set to &quot;dvars&quot; ...&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">:</span>
                <span class="n">valid_ext</span><span class="p">,</span> <span class="n">in_ext</span><span class="p">,</span> <span class="n">fileName</span> <span class="o">=</span> <span class="n">checkFileExt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_file</span><span class="p">,</span> <span class="n">EXT</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_ext</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">The input image format is not recognized ...!&#39;</span><span class="p">)</span>
                    <span class="k">return</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;out_file&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">out_prefix</span> <span class="o">+</span> <span class="n">fileName</span> <span class="o">+</span> <span class="s1">&#39;.out&#39;</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No output_directory was found...!</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">inheritance_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span>
                <span class="s1">&#39;out_file&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_file</span>

        <span class="c1"># Return the requirement, outputs and inheritance_dict</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_initResult</span><span class="p">()</span></div>

<div class="viewcode-block" id="ComputeDVARS.run_process_mia"><a class="viewcode-back" href="../../../../mia_processes.bricks.reports.html#mia_processes.bricks.reports.processes.ComputeDVARS.run_process_mia">[docs]</a>    <span class="k">def</span> <span class="nf">run_process_mia</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the process launch step of the brick.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ComputeDVARS</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">run_process_mia</span><span class="p">()</span>

        <span class="c1"># Out file name</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_file</span><span class="p">)</span>
        <span class="n">file_name_no_ext</span><span class="p">,</span> <span class="n">file_extension</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">file_extension</span> <span class="o">==</span> <span class="s1">&#39;.gz&#39;</span><span class="p">:</span>
            <span class="p">(</span><span class="n">file_name_no_ext_2</span><span class="p">,</span>
             <span class="n">file_extension_2</span><span class="p">)</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file_name_no_ext</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">file_extension_2</span> <span class="o">==</span> <span class="s1">&#39;.nii&#39;</span><span class="p">:</span>
                <span class="n">file_name_no_ext</span> <span class="o">=</span> <span class="n">file_name_no_ext_2</span>

        <span class="n">file_out</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span>
                                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">out_prefix</span> <span class="o">+</span>
                                 <span class="n">file_name_no_ext</span> <span class="o">+</span>
                                 <span class="s1">&#39;.out&#39;</span><span class="p">))</span>

        <span class="c1"># Load data</span>
        <span class="n">func</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">(</span><span class="n">nb</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_file</span><span class="p">)</span><span class="o">.</span><span class="n">dataobj</span><span class="p">)</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">bool_</span><span class="p">(</span><span class="n">nb</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_mask</span><span class="p">)</span><span class="o">.</span><span class="n">dataobj</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Input fMRI dataset should be 4-dimensional&quot;</span><span class="p">)</span>

        <span class="n">mfunc</span> <span class="o">=</span> <span class="n">func</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">intensity_normalization</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">mfunc</span> <span class="o">=</span> <span class="p">(</span><span class="n">mfunc</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">mfunc</span><span class="p">))</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">intensity_normalization</span>

        <span class="c1"># Robust standard deviation (we are using &quot;lower&quot; interpolation</span>
        <span class="c1"># because this is what FSL is doing</span>
        <span class="n">func_sd</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">mfunc</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s2">&quot;lower&quot;</span><span class="p">)</span>
            <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">mfunc</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="s2">&quot;lower&quot;</span><span class="p">)</span>
        <span class="p">)</span> <span class="o">/</span> <span class="mf">1.349</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">remove_zero_variance</span><span class="p">:</span>
            <span class="n">zero_variance_voxels</span> <span class="o">=</span> <span class="n">func_sd</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">variance_tol</span>
            <span class="n">mfunc</span> <span class="o">=</span> <span class="n">mfunc</span><span class="p">[</span><span class="n">zero_variance_voxels</span><span class="p">,</span> <span class="p">:]</span>
            <span class="n">func_sd</span> <span class="o">=</span> <span class="n">func_sd</span><span class="p">[</span><span class="n">zero_variance_voxels</span><span class="p">]</span>

        <span class="c1"># Compute (non-robust) estimate of lag-1 autocorrelation</span>
        <span class="n">ar1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">apply_along_axis</span><span class="p">(</span>
            <span class="n">_AR_est_YW</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
            <span class="n">regress_poly</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">mfunc</span><span class="p">,</span> <span class="n">remove_mean</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> <span class="mi">1</span>
        <span class="p">)[:,</span> <span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Compute (predicted) standard deviation of temporal difference time series</span>
        <span class="n">diff_sdhat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">ar1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()))</span> <span class="o">*</span> <span class="n">func_sd</span>
        <span class="n">diff_sd_mean</span> <span class="o">=</span> <span class="n">diff_sdhat</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

        <span class="c1"># Compute temporal difference time series</span>
        <span class="n">func_diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">mfunc</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># DVARS (no standardization)</span>
        <span class="n">dvars_nstd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">func_diff</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>

        <span class="c1"># standardization</span>
        <span class="n">dvars_stdz</span> <span class="o">=</span> <span class="n">dvars_nstd</span> <span class="o">/</span> <span class="n">diff_sd_mean</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># voxelwise standardization</span>
            <span class="n">diff_vx_stdz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span>
                <span class="n">func_diff</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">diff_sdhat</span><span class="p">]</span> <span class="o">*</span> <span class="n">func_diff</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
            <span class="p">)</span>
            <span class="n">dvars_vx_stdz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">diff_vx_stdz</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Error calculating vx-wise std DVARS...!&#39;</span><span class="p">)</span>
            <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span>
                <span class="n">file_out</span><span class="p">,</span>
                <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">dvars_stdz</span><span class="p">,</span> <span class="n">dvars_nstd</span><span class="p">))</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
                <span class="n">fmt</span><span class="o">=</span><span class="sa">b</span><span class="s2">&quot;</span><span class="si">%0.8f</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">delimiter</span><span class="o">=</span><span class="sa">b</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">header</span><span class="o">=</span><span class="s2">&quot;std DVARS</span><span class="se">\t</span><span class="s2">non-std DVARS&quot;</span><span class="p">,</span>
                <span class="n">comments</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span>
                <span class="n">file_out</span><span class="p">,</span>
                <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">dvars_stdz</span><span class="p">,</span> <span class="n">dvars_nstd</span><span class="p">,</span> <span class="n">dvars_vx_stdz</span><span class="p">))</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
                <span class="n">fmt</span><span class="o">=</span><span class="sa">b</span><span class="s2">&quot;</span><span class="si">%0.8f</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">delimiter</span><span class="o">=</span><span class="sa">b</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">header</span><span class="o">=</span><span class="s2">&quot;std DVARS</span><span class="se">\t</span><span class="s2">non-std DVARS</span><span class="se">\t</span><span class="s2">vx-wise std DVARS&quot;</span><span class="p">,</span>
                <span class="n">comments</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
            <span class="p">)</span></div></div>


<div class="viewcode-block" id="FramewiseDisplacement"><a class="viewcode-back" href="../../../../mia_processes.bricks.reports.html#mia_processes.bricks.reports.processes.FramewiseDisplacement">[docs]</a><span class="k">class</span> <span class="nc">FramewiseDisplacement</span><span class="p">(</span><span class="n">ProcessMIA</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    * Calculate the FD (framewise displacement) as in [Power2012].</span>

<span class="sd">    This implementation reproduces the calculation in fsl_motion_outliers</span>

<span class="sd">    [Power2012] Power et al., Spurious but systematic correlations</span>
<span class="sd">    in functional connectivity MRI networks arise from subject</span>
<span class="sd">    motion, NeuroImage 59(3), 2012. doi:`10.1016/j.neuroimage.2011.10.018</span>
<span class="sd">    &lt;https://doi.org/10.1016/j.neuroimage.2011.10.018&gt;`.</span>

<span class="sd">    Please, see the complete documentation for the `FramewiseDisplacement&#39;</span>
<span class="sd">    brick in the populse.mia_processes website</span>
<span class="sd">    &lt;https://populse.github.io/mia_processes/html/documentation/bricks/reports/FramewiseDisplacement.html&gt;`_</span>

<span class="sd">    adapted from:</span>
<span class="sd">    https://github.com/nipy/nipype/blob/f662acfce8def4717e0c3414618f3a5de5913b31/nipype/algorithms/confounds.py#L298</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="FramewiseDisplacement.__init__"><a class="viewcode-back" href="../../../../mia_processes.bricks.reports.html#mia_processes.bricks.reports.processes.FramewiseDisplacement.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the attributes initialisation/instantiation.</span>

<span class="sd">        The input and output plugs are defined here. The special</span>
<span class="sd">        &#39;self.requirement&#39; attribute (optional) is used to define the</span>
<span class="sd">        third-party products necessary for the running of the brick.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Initialisation of the objects needed for the launch of the brick</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">FramewiseDisplacement</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1"># Third party softwares required for the execution of the brick</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requirement</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Inputs description</span>
        <span class="n">in_file_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Motion parameters file (a pathlike object or string &#39;</span>
                        <span class="s1">&#39;representing a file).&#39;</span><span class="p">)</span>
        <span class="n">parameter_source_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Source of movement parameters&#39;</span>
                                 <span class="s1">&#39;(a string which is FSL &#39;</span>
                                 <span class="s1">&#39;or AFNI or SPM or FSFAST or NIPY&#39;</span><span class="p">)</span>
        <span class="n">radius_desc</span> <span class="o">=</span> <span class="s1">&#39;Radius in mm to calculate angular FDs (a float).&#39;</span>
        <span class="n">normalize_desc</span> <span class="o">=</span> <span class="s1">&#39;Calculate FD in mm/s (a bool).&#39;</span>
        <span class="n">out_prefix_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Specify the string to be prepended to the &#39;</span>
                           <span class="s1">&#39;filename of the output file (a string).&#39;</span><span class="p">)</span>

        <span class="c1"># Outputs description</span>
        <span class="n">out_file_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;The output file (a pathlike object or a &#39;</span>
                         <span class="s1">&#39;string representing a file).&#39;</span><span class="p">)</span>

        <span class="c1"># Inputs traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;in_file&quot;</span><span class="p">,</span>
                       <span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">optional</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">desc</span><span class="o">=</span><span class="n">in_file_desc</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;parameter_source&quot;</span><span class="p">,</span>
                       <span class="n">traits</span><span class="o">.</span><span class="n">Enum</span><span class="p">(</span><span class="s1">&#39;FSL&#39;</span><span class="p">,</span>
                                   <span class="s1">&#39;AFNI&#39;</span><span class="p">,</span>
                                   <span class="s1">&#39;SPM&#39;</span><span class="p">,</span>
                                   <span class="s1">&#39;FSFAST&#39;</span><span class="p">,</span>
                                   <span class="s1">&#39;NIPY&#39;</span><span class="p">,</span>
                                   <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                   <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">desc</span><span class="o">=</span><span class="n">parameter_source_desc</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;radius&quot;</span><span class="p">,</span>
                       <span class="n">traits</span><span class="o">.</span><span class="n">Float</span><span class="p">(</span><span class="mf">50.0</span><span class="p">,</span>
                                    <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                    <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                    <span class="n">desc</span><span class="o">=</span><span class="n">radius_desc</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;normalize&quot;</span><span class="p">,</span>
                       <span class="n">traits</span><span class="o">.</span><span class="n">Bool</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span>
                                   <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                   <span class="n">desc</span><span class="o">=</span><span class="n">normalize_desc</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;out_prefix&quot;</span><span class="p">,</span>
                       <span class="n">traits</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="s1">&#39;fd_&#39;</span><span class="p">,</span>
                                     <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                     <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                     <span class="n">desc</span><span class="o">=</span><span class="n">out_prefix_desc</span><span class="p">))</span>

        <span class="c1"># Outputs traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;out_file&quot;</span><span class="p">,</span>
                       <span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">desc</span><span class="o">=</span><span class="n">out_file_desc</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">init_default_traits</span><span class="p">()</span></div>

<div class="viewcode-block" id="FramewiseDisplacement.list_outputs"><a class="viewcode-back" href="../../../../mia_processes.bricks.reports.html#mia_processes.bricks.reports.processes.FramewiseDisplacement.list_outputs">[docs]</a>    <span class="k">def</span> <span class="nf">list_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_plugged</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the initialisation step of the brick.</span>

<span class="sd">        The main objective of this method is to produce the outputs of the</span>
<span class="sd">        bricks (self.outputs) and the associated tags (self.inheritance_dic),</span>
<span class="sd">        if defined here. In order not to include an output in the database,</span>
<span class="sd">        this output must be a value of the optional key &#39;notInDb&#39; of the</span>
<span class="sd">        self.outputs dictionary. To work properly this method must return</span>
<span class="sd">        self.make_initResult() object.</span>

<span class="sd">        :param is_plugged: the state, linked or not, of the plugs.</span>
<span class="sd">        :returns: a dictionary with requirement, outputs and inheritance_dict.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Using the inheritance to ProcessMIA class, list_outputs method</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">FramewiseDisplacement</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">list_outputs</span><span class="p">()</span>

        <span class="c1"># Outputs definition and tags inheritance (optional)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_file</span><span class="p">:</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_prefix</span> <span class="o">==</span> <span class="n">Undefined</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">out_prefix</span> <span class="o">=</span> <span class="s1">&#39;fd_&#39;</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;The out_prefix parameter is undefined. Automatically &#39;</span>
                      <span class="s1">&#39;set to &quot;fd&quot; ...&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">:</span>
                <span class="n">valid_ext</span><span class="p">,</span> <span class="n">in_ext</span><span class="p">,</span> <span class="n">fileName</span> <span class="o">=</span> <span class="n">checkFileExt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_file</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;TXT&#39;</span><span class="p">:</span> <span class="s1">&#39;txt&#39;</span><span class="p">})</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_ext</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">The input image format is not recognized ...!&#39;</span><span class="p">)</span>
                    <span class="k">return</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;out_file&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">out_prefix</span> <span class="o">+</span> <span class="n">fileName</span> <span class="o">+</span> <span class="s1">&#39;.out&#39;</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No output_directory was found...!</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">inheritance_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span>
                <span class="s1">&#39;out_file&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_file</span>

        <span class="c1"># Return the requirement, outputs and inheritance_dict</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_initResult</span><span class="p">()</span></div>

<div class="viewcode-block" id="FramewiseDisplacement.run_process_mia"><a class="viewcode-back" href="../../../../mia_processes.bricks.reports.html#mia_processes.bricks.reports.processes.FramewiseDisplacement.run_process_mia">[docs]</a>    <span class="k">def</span> <span class="nf">run_process_mia</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the process launch step of the brick.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">FramewiseDisplacement</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">run_process_mia</span><span class="p">()</span>

        <span class="n">mpars</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_file</span><span class="p">)</span>  <span class="c1"># mpars is N_t x 6</span>
        <span class="n">mpars</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">apply_along_axis</span><span class="p">(</span>
            <span class="n">func1d</span><span class="o">=</span><span class="n">normalize_mc_params</span><span class="p">,</span>
            <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">arr</span><span class="o">=</span><span class="n">mpars</span><span class="p">,</span>
            <span class="n">source</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parameter_source</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="n">mpars</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:</span><span class="mi">6</span><span class="p">]</span> <span class="o">-</span> <span class="n">mpars</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="p">:</span><span class="mi">6</span><span class="p">]</span>
        <span class="n">diff</span><span class="p">[:,</span> <span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">radius</span>
        <span class="n">fd_res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Image save</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_file</span><span class="p">)</span>
        <span class="n">file_name_no_ext</span><span class="p">,</span> <span class="n">file_extension</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">file_extension</span> <span class="o">==</span> <span class="s1">&#39;.gz&#39;</span><span class="p">:</span>
            <span class="p">(</span><span class="n">file_name_no_ext_2</span><span class="p">,</span>
             <span class="n">file_extension_2</span><span class="p">)</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file_name_no_ext</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">file_extension_2</span> <span class="o">==</span> <span class="s1">&#39;.nii&#39;</span><span class="p">:</span>
                <span class="n">file_name_no_ext</span> <span class="o">=</span> <span class="n">file_name_no_ext_2</span>

        <span class="n">file_out</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span>
                                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">out_prefix</span> <span class="o">+</span>
                                 <span class="n">file_name_no_ext</span> <span class="o">+</span>
                                 <span class="s1">&#39;.out&#39;</span><span class="p">))</span>

        <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span>
            <span class="n">file_out</span><span class="p">,</span> <span class="n">fd_res</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="s2">&quot;FramewiseDisplacement&quot;</span><span class="p">,</span> <span class="n">comments</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
        <span class="p">)</span></div></div>


<div class="viewcode-block" id="Mean_stdDev_calc"><a class="viewcode-back" href="../../../../mia_processes.bricks.reports.html#mia_processes.bricks.reports.processes.Mean_stdDev_calc">[docs]</a><span class="k">class</span> <span class="nc">Mean_stdDev_calc</span><span class="p">(</span><span class="n">ProcessMIA</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    * Makes the mean and standard deviation of the parametric_maps.</span>

<span class="sd">    - The parametric_maps are first convolved with the ROIs corresponding</span>
<span class="sd">      to doublet_list.</span>
<span class="sd">    - ROIs are defined from doublet_list parameter as</span>
<span class="sd">      doublet_list[0][0] + doublet_list[0][1] + &#39;.nii&#39;,</span>
<span class="sd">      doublet_list[1][0] + doublet_list[1][1] + &#39;.nii&#39;,</span>
<span class="sd">      etc.</span>
<span class="sd">    - To work correctly, the database entry for the parametric_maps items must</span>
<span class="sd">      have the &quot;PatientName&quot; tag filled in</span>
<span class="sd">    - To work correctly, the output_directory &quot;/roi_&quot;PatientName&quot;/convROI_BOLD&quot;</span>
<span class="sd">      must exist and contain a previous convolution results (normally using</span>
<span class="sd">      the ConvROI brick)</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Mean_stdDev_calc.__init__"><a class="viewcode-back" href="../../../../mia_processes.bricks.reports.html#mia_processes.bricks.reports.processes.Mean_stdDev_calc.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the attributes initialisation/instantiation.</span>

<span class="sd">        The input and output plugs are defined here. The special</span>
<span class="sd">        &#39;self.requirement&#39; attribute (optional) is used to define the</span>
<span class="sd">        third-party products necessary for the running of the brick.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Initialisation of the objects needed for the launch of the brick</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Mean_stdDev_calc</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1"># Inputs description</span>
        <span class="n">parametric_maps_desc</span> <span class="o">=</span> <span class="s2">&quot;A list of files (existing, uncompressed file)&quot;</span>
        <span class="n">doublet_list_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;A list of lists containing doublets of strings &#39;</span>
                             <span class="s1">&#39;(e.g. [[&quot;ROI_OCC&quot;, &quot;_L&quot;], [&quot;ROI_OCC&quot;, &quot;_R&quot;], &#39;</span>
                             <span class="s1">&#39;[&quot;ROI_PAR&quot;, &quot;_l&quot;], ...]&#39;</span><span class="p">)</span>

        <span class="c1"># Outputs description</span>
        <span class="n">mean_out_files_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;A list of .txt files with the calculated &quot;</span>
                               <span class="s2">&quot;average for each ROI determined after &quot;</span>
                               <span class="s2">&quot;convolution&quot;</span><span class="p">)</span>
        <span class="n">std_out_files_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;A list of .txt files with the standard &quot;</span>
                              <span class="s2">&quot;deviation for each ROI determined &quot;</span>
                              <span class="s2">&quot;after convolution&quot;</span><span class="p">)</span>

        <span class="c1"># Inputs traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;parametric_maps&quot;</span><span class="p">,</span>
                       <span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">traits</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">exists</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
                                   <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                   <span class="n">desc</span><span class="o">=</span><span class="n">parametric_maps_desc</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;doublet_list&quot;</span><span class="p">,</span>
                       <span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                   <span class="n">desc</span><span class="o">=</span><span class="n">doublet_list_desc</span><span class="p">))</span>

        <span class="c1"># Output traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;mean_out_files&quot;</span><span class="p">,</span>
                       <span class="n">OutputMultiPath</span><span class="p">(</span><span class="n">File</span><span class="p">(),</span>
                                       <span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                       <span class="n">desc</span><span class="o">=</span><span class="n">mean_out_files_desc</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;std_out_files&quot;</span><span class="p">,</span>
                       <span class="n">OutputMultiPath</span><span class="p">(</span><span class="n">File</span><span class="p">(),</span>
                                       <span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                       <span class="n">desc</span><span class="o">=</span><span class="n">std_out_files_desc</span><span class="p">))</span>

        <span class="c1"># Special parameter used as a messenger for the run_process_mia method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;dict4runtime&quot;</span><span class="p">,</span>
                       <span class="n">traits</span><span class="o">.</span><span class="n">Dict</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                   <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">userlevel</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">init_default_traits</span><span class="p">()</span></div>

<div class="viewcode-block" id="Mean_stdDev_calc.list_outputs"><a class="viewcode-back" href="../../../../mia_processes.bricks.reports.html#mia_processes.bricks.reports.processes.Mean_stdDev_calc.list_outputs">[docs]</a>    <span class="k">def</span> <span class="nf">list_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_plugged</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the initialisation step of the brick.</span>

<span class="sd">        The main objective of this method is to produce the outputs of the</span>
<span class="sd">        bricks (self.outputs) and the associated tags (self.inheritance_dic),</span>
<span class="sd">        if defined here. In order not to include an output in the database,</span>
<span class="sd">        this output must be a value of the optional key &#39;notInDb&#39; of the</span>
<span class="sd">        self.outputs dictionary. To work properly this method must return</span>
<span class="sd">        self.make_initResult() object.</span>

<span class="sd">        :param is_plugged: the state, linked or not, of the plugs.</span>
<span class="sd">        :returns: a dictionary with requirement, outputs and inheritance_dict.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Using the inheritance to ProcessMIA class, list_outputs method</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Mean_stdDev_calc</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">list_outputs</span><span class="p">()</span>

        <span class="c1"># Outputs definition and tags inheritance (optional)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">doublet_list</span> <span class="o">!=</span> <span class="p">[]</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">parametric_maps</span> <span class="o">!=</span> <span class="p">[]:</span>
            <span class="c1"># FIXME: We retrieve the name of the patient from the first element</span>
            <span class="c1">#        of parametric_maps. This is only fine if all the elements</span>
            <span class="c1">#        of parametric_maps correspond to the same patient.</span>
            <span class="n">patient_name</span> <span class="o">=</span> <span class="n">get_dbFieldValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">parametric_maps</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                            <span class="s1">&#39;PatientName&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">patient_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Mean_stdDev_cal brick:</span><span class="se">\n</span><span class="s1">The PatientName tag is not &#39;</span>
                      <span class="s1">&#39;filled in the database for the </span><span class="si">{}</span><span class="s1"> file ...</span><span class="se">\n</span><span class="s1"> The &#39;</span>
                      <span class="s1">&#39;initialization is &#39;</span>
                      <span class="s1">&#39;aborted...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parametric_maps</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_initResult</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">dict4runtime</span><span class="p">[</span><span class="s1">&#39;patient_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">patient_name</span>
            <span class="n">roi_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span>
                                   <span class="s1">&#39;roi_&#39;</span> <span class="o">+</span> <span class="n">patient_name</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">roi_dir</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Mean_stdDev_cal brick:</span><span class="se">\n</span><span class="s2">No </span><span class="si">{}</span><span class="s2"> folder detected ...</span><span class="se">\n</span><span class="s2">The &quot;</span>
                    <span class="s2">&quot;initialization is aborted ...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">roi_dir</span><span class="p">))</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_initResult</span><span class="p">()</span>

            <span class="n">conv_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">roi_dir</span><span class="p">,</span> <span class="s1">&#39;convROI_BOLD&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">conv_dir</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Mean_stdDev_cal brick:</span><span class="se">\n</span><span class="s2">No </span><span class="si">{}</span><span class="s2"> folder detected ...</span><span class="se">\n</span><span class="s2">The &quot;</span>
                    <span class="s2">&quot;initialization is aborted ...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">conv_dir</span><span class="p">))</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_initResult</span><span class="p">()</span>

            <span class="n">analysis_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">roi_dir</span><span class="p">,</span> <span class="s1">&#39;ROI_analysis&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">analysis_dir</span><span class="p">):</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">analysis_dir</span><span class="p">)</span>

            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">analysis_dir</span><span class="p">)</span>
            <span class="n">mean_out_files</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">std_out_files</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">parametric_map</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parametric_maps</span><span class="p">:</span>

                <span class="k">for</span> <span class="n">roi</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">doublet_list</span><span class="p">:</span>
                    <span class="c1"># spmT_BOLD or beta_BOLD</span>
                    <span class="n">map_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">parametric_map</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_BOLD&#39;</span>
                    <span class="n">mean_out_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                        <span class="n">analysis_dir</span><span class="p">,</span>
                        <span class="n">roi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">roi</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_mean&#39;</span> <span class="o">+</span> <span class="n">map_name</span> <span class="o">+</span> <span class="s1">&#39;.txt&#39;</span><span class="p">))</span>
                    <span class="n">std_out_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                        <span class="n">analysis_dir</span><span class="p">,</span>
                        <span class="n">roi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">roi</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_std&#39;</span> <span class="o">+</span> <span class="n">map_name</span> <span class="o">+</span> <span class="s1">&#39;.txt&#39;</span><span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;mean_out_files&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mean_out_files</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;std_out_files&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">std_out_files</span>

        <span class="c1"># Return the requirement, outputs and inheritance_dict</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_initResult</span><span class="p">()</span></div>

<div class="viewcode-block" id="Mean_stdDev_calc.run_process_mia"><a class="viewcode-back" href="../../../../mia_processes.bricks.reports.html#mia_processes.bricks.reports.processes.Mean_stdDev_calc.run_process_mia">[docs]</a>    <span class="k">def</span> <span class="nf">run_process_mia</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the process launch step of the brick.&quot;&quot;&quot;</span>
        <span class="c1"># No need the next line (we don&#39;t use self.process and SPM)</span>
        <span class="c1"># super(Mean_stdDev_calc, self).run_process_mia()</span>

        <span class="n">roi_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span>
                               <span class="s1">&#39;roi_&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dict4runtime</span><span class="p">[</span><span class="s1">&#39;patient_name&#39;</span><span class="p">])</span>
        <span class="n">conv_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">roi_dir</span><span class="p">,</span> <span class="s1">&#39;convROI_BOLD&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">conv_dir</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Mean_stdDev_cal brick:</span><span class="se">\n</span><span class="s2">No </span><span class="si">{}</span><span class="s2"> folder detected ...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                                                      <span class="n">conv_dir</span><span class="p">))</span>
            <span class="c1">#return</span>

        <span class="n">analysis_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">roi_dir</span><span class="p">,</span> <span class="s1">&#39;ROI_analysis&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">analysis_dir</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Mean_stdDev_cal brick:</span><span class="se">\n</span><span class="s2">No </span><span class="si">{}</span><span class="s2"> folder detected ...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                                                  <span class="n">analysis_dir</span><span class="p">))</span>
            <span class="c1">#return</span>

        <span class="k">for</span> <span class="n">parametric_map</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parametric_maps</span><span class="p">:</span>
            <span class="c1"># Resampling, if necessary, the parametric_map to the size of the</span>
            <span class="c1"># ROIs, using the first ROI in doublet_list. The</span>
            <span class="c1"># roi_1[0]roi_1[1]&#39;.nii&#39; file must exist in roi_dir.</span>
            <span class="c1"># I think it would make more sense to take</span>
            <span class="c1"># conv_dir&#39;/conv&#39;roi_1[0]roi_1[1]&#39;.nii, as the size of</span>
            <span class="c1"># conv_dir&#39;/conv&#39;roi_1[0]roi_1[1]&#39;.nii and</span>
            <span class="c1"># roi_dir&#39;/&#39;roi_1[0]roi_1[1]&#39;.nii&#39; should be the same given the</span>
            <span class="c1"># pipeline used for the CVR</span>
            <span class="n">roi_1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">doublet_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">roi_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">roi_dir</span><span class="p">,</span> <span class="n">roi_1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">roi_1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.nii&#39;</span><span class="p">)</span>
            <span class="n">roi_img</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">roi_file</span><span class="p">)</span>
            <span class="n">roi_data</span> <span class="o">=</span> <span class="n">roi_img</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">()</span>
            <span class="n">roi_size</span> <span class="o">=</span> <span class="n">roi_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>

            <span class="c1"># Reading parametric map</span>
            <span class="n">map_img</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">parametric_map</span><span class="p">)</span>
            <span class="n">map_data</span> <span class="o">=</span> <span class="n">map_img</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">()</span>

            <span class="c1"># Setting the NaN to 0 in parametric map</span>
            <span class="n">map_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">map_data</span><span class="p">)</span>

            <span class="c1"># Give name with spmT_BOLD or beta_BOLD</span>
            <span class="n">map_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">parametric_map</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_BOLD&#39;</span>

            <span class="c1"># Making sure that the ROI and parametric images</span>
            <span class="c1"># are at the same size</span>
            <span class="k">if</span> <span class="n">roi_size</span> <span class="o">!=</span> <span class="n">map_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">3</span><span class="p">]:</span>
                <span class="n">map_data_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">map_data</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="o">-</span><span class="n">map_data</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
                <span class="n">map_data</span> <span class="o">=</span> <span class="n">resize</span><span class="p">(</span>
                    <span class="n">map_data</span> <span class="o">/</span> <span class="n">map_data_max</span><span class="p">,</span> <span class="n">roi_size</span><span class="p">)</span> <span class="o">*</span> <span class="n">map_data_max</span>

            <span class="k">for</span> <span class="n">roi</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">doublet_list</span><span class="p">:</span>
                <span class="c1"># Reading ROI file</span>
                <span class="n">roi_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">conv_dir</span><span class="p">,</span>
                                        <span class="s1">&#39;conv&#39;</span> <span class="o">+</span> <span class="n">roi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">roi</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;.nii&#39;</span><span class="p">)</span>

                <span class="c1"># it seems that it is necessary to leave a little time so that</span>
                <span class="c1"># the data calculated previously are well recorded on the disc!</span>
                <span class="c1"># In order not to be stuck indefinitely, the maximum waiting</span>
                <span class="c1"># time is set to 15s.</span>
                <span class="n">wait_time</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>

                    <span class="k">if</span> <span class="n">wait_time</span> <span class="o">&gt;</span> <span class="mi">15</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Mean_stdDev_calc:</span><span class="se">\n</span><span class="s1">The </span><span class="si">{}</span><span class="s1"> file has not been &#39;</span>
                              <span class="s1">&#39;found ...</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">roi_file</span><span class="p">))</span>
                        <span class="n">roi_img</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="k">break</span>

                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">roi_img</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">roi_file</span><span class="p">)</span>
                        <span class="k">break</span>

                    <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Mean_stdDev_calc:</span><span class="se">\n</span><span class="si">{}</span><span class="s1"> does not exist yet ... &#39;</span>
                              <span class="s1">&#39;waiting 1s ...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">roi_file</span><span class="p">))</span>
                        <span class="kn">import</span> <span class="nn">time</span>
                        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                        <span class="n">wait_time</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">continue</span>

                <span class="n">roi_data</span> <span class="o">=</span> <span class="n">roi_img</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">()</span>

                <span class="c1"># Setting the NaN to 0 in ROI images</span>
                <span class="n">roi_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">roi_data</span><span class="p">)</span>

                <span class="c1"># Convolution of the parametric map with the ROI images</span>
                <span class="n">roi_thresh</span> <span class="o">=</span> <span class="p">(</span><span class="n">roi_data</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">map_data</span> <span class="o">*</span> <span class="n">roi_thresh</span>

                <span class="c1"># Calculating mean and standard deviation</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="n">result</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Mean_stdDev_cal brick:</span><span class="se">\n</span><span class="s2">Warning: No result found &quot;</span>
                          <span class="s2">&quot;after convolution of the </span><span class="si">{0}</span><span class="s2"> ROI and the </span><span class="si">{1}</span><span class="s2"> &quot;</span>
                          <span class="s2">&quot;data&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">roi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">roi</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">parametric_map</span><span class="p">))</span>
                    <span class="n">mean_result</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">std_result</span> <span class="o">=</span> <span class="mi">0</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">mean_result</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="n">result</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
                    <span class="n">std_result</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="n">result</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>

                <span class="c1"># Writing the value in the corresponding file:</span>
                <span class="c1"># analysis_dir&#39;/&#39;roi[0]roi[1]&#39;_mean&#39;map_name&#39;.txt&#39;)</span>
                <span class="n">mean_out_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="n">analysis_dir</span><span class="p">,</span>
                    <span class="n">roi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">roi</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_mean&#39;</span> <span class="o">+</span> <span class="n">map_name</span> <span class="o">+</span> <span class="s1">&#39;.txt&#39;</span><span class="p">)</span>

                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">mean_out_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%.3f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">mean_result</span><span class="p">)</span>

                <span class="c1"># Writing the value in the corresponding file:</span>
                <span class="c1"># analysis_dir&#39;/&#39;roi[0]roi[1]&#39;_std&#39;map_name&#39;.txt&#39;)</span>
                <span class="n">std_out_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="n">analysis_dir</span><span class="p">,</span>
                    <span class="n">roi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">roi</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_std&#39;</span> <span class="o">+</span> <span class="n">map_name</span> <span class="o">+</span> <span class="s1">&#39;.txt&#39;</span><span class="p">)</span>

                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">std_out_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%.3f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">std_result</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="Result_collector"><a class="viewcode-back" href="../../../../mia_processes.bricks.reports.html#mia_processes.bricks.reports.processes.Result_collector">[docs]</a><span class="k">class</span> <span class="nc">Result_collector</span><span class="p">(</span><span class="n">ProcessMIA</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    * Save a file with the data collection for a patient.</span>

<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="Result_collector.__init__"><a class="viewcode-back" href="../../../../mia_processes.bricks.reports.html#mia_processes.bricks.reports.processes.Result_collector.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the attributes initialisation/instantiation.</span>

<span class="sd">        The input and output plugs are defined here. The special</span>
<span class="sd">        &#39;self.requirement&#39; attribute (optional) is used to define the</span>
<span class="sd">        third-party products necessary for the running of the brick.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Initialisation of the objects needed for the launch of the brick</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Result_collector</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1"># Inputs description</span>
        <span class="n">parametric_maps_desc</span> <span class="o">=</span> <span class="s2">&quot;A list of files (existing, uncompressed file)&quot;</span>
        <span class="n">data_desc</span> <span class="o">=</span> <span class="s2">&quot;Defines the data type (a string, e.g. BOLD)&quot;</span>
        <span class="n">calculs_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Defines the type of calculation (a list of strings, &#39;</span>
                        <span class="s1">&#39;e.g. [&quot;mean&quot;, &quot;std&quot;, &quot;IL_mean&quot;, &quot;IL_std&quot;]&#39;</span><span class="p">)</span>
        <span class="n">mean_in_files_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;A list of .txt files containing the average &quot;</span>
                              <span class="s2">&quot;value of a parameter for a given territory or &quot;</span>
                              <span class="s2">&quot;region of interest (a list of files)&quot;</span><span class="p">)</span>
        <span class="n">std_in_files_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;A list of .txt files containing the standard &quot;</span>
                             <span class="s2">&quot;deviation for a parameter in a given territory &quot;</span>
                             <span class="s2">&quot;or region of interest (a list of files)&quot;</span><span class="p">)</span>
        <span class="n">doublet_list_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;A list of lists containing doublets of strings &#39;</span>
                             <span class="s1">&#39;(e.g. [[&quot;ROI_OCC&quot;, &quot;_L&quot;], [&quot;ROI_OCC&quot;, &quot;_R&quot;], &#39;</span>
                             <span class="s1">&#39;[&quot;ROI_PAR&quot;, &quot;_l&quot;], ...]&#39;</span><span class="p">)</span>
        <span class="n">patient_info_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;A dictionary whose keys/values correspond to &quot;</span>
                             <span class="s2">&quot;information about the patient &quot;</span>
                             <span class="s2">&quot;(e.g. {&quot;</span>
                             <span class="s2">&quot;&#39;PatientName&#39;: &#39;ablair&#39;,&#39;Pathology&#39;: &#39;ACMD&#39;, &quot;</span>
                             <span class="s2">&quot;&#39;Age&#39;: 64, &#39;Sex&#39;: &#39;M&#39;, &#39;MR&#39;: &#39;3T&#39;, &quot;</span>
                             <span class="s2">&quot;&#39;Gas&#39;: &#39;BACTAL&#39;, &#39;GasAdmin&#39;: &#39;MASK&#39;}&quot;</span><span class="p">)</span>

        <span class="c1"># Outputs description</span>
        <span class="n">out_files_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;A list of .xml files containing a summary of the &quot;</span>
                         <span class="s2">&quot;requested results&quot;</span><span class="p">)</span>

        <span class="c1"># Inputs traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;parametric_maps&quot;</span><span class="p">,</span>
                       <span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">traits</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">exists</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
                                   <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                   <span class="n">desc</span><span class="o">=</span><span class="n">parametric_maps_desc</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,</span>
                       <span class="n">traits</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="s2">&quot;BOLD&quot;</span><span class="p">,</span>
                                     <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                     <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                     <span class="n">desc</span><span class="o">=</span><span class="n">data_desc</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;calculs&quot;</span><span class="p">,</span>
                       <span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">traits</span><span class="o">.</span><span class="n">String</span><span class="p">(),</span>
                                   <span class="n">value</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">,</span> <span class="s2">&quot;std&quot;</span><span class="p">,</span> <span class="s2">&quot;IL_mean&quot;</span><span class="p">,</span> <span class="s2">&quot;IL_std&quot;</span><span class="p">],</span>
                                   <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                   <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">desc</span><span class="o">=</span><span class="n">calculs_desc</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;mean_in_files&quot;</span><span class="p">,</span>
                       <span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">traits</span><span class="o">.</span><span class="n">File</span><span class="p">(),</span>
                                   <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                   <span class="n">desc</span><span class="o">=</span><span class="n">mean_in_files_desc</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;std_in_files&quot;</span><span class="p">,</span>
                       <span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">traits</span><span class="o">.</span><span class="n">File</span><span class="p">(),</span>
                                   <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                   <span class="n">desc</span><span class="o">=</span><span class="n">std_in_files_desc</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;doublet_list&quot;</span><span class="p">,</span>
                       <span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                   <span class="n">desc</span><span class="o">=</span><span class="n">doublet_list_desc</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;patient_info&quot;</span><span class="p">,</span>
                       <span class="c1">#traits.Dict(patient_info_dict,</span>
                       <span class="n">traits</span><span class="o">.</span><span class="n">Dict</span><span class="p">(</span>
                                   <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                   <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">desc</span><span class="o">=</span><span class="n">patient_info_desc</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">patient_info</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">PatientName</span><span class="o">=</span><span class="n">Undefined</span><span class="p">,</span>
                                 <span class="n">Pathology</span><span class="o">=</span><span class="n">Undefined</span><span class="p">,</span>
                                 <span class="n">Age</span><span class="o">=</span><span class="n">Undefined</span><span class="p">,</span>
                                 <span class="n">Sex</span><span class="o">=</span><span class="n">Undefined</span><span class="p">,</span>
                                 <span class="n">MR</span><span class="o">=</span><span class="n">Undefined</span><span class="p">,</span>
                                 <span class="n">Gas</span><span class="o">=</span><span class="n">Undefined</span><span class="p">,</span>
                                 <span class="n">GasAdmin</span><span class="o">=</span><span class="n">Undefined</span><span class="p">)</span>

        <span class="c1"># Outputs traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;out_files&quot;</span><span class="p">,</span>
                       <span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">traits</span><span class="o">.</span><span class="n">File</span><span class="p">(),</span>
                                   <span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">desc</span><span class="o">=</span><span class="n">out_files_desc</span><span class="p">))</span>

        <span class="c1"># Special parameter used as a messenger for the run_process_mia method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;dict4runtime&quot;</span><span class="p">,</span>
                       <span class="n">traits</span><span class="o">.</span><span class="n">Dict</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                   <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">userlevel</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">init_default_traits</span><span class="p">()</span></div>

<div class="viewcode-block" id="Result_collector.list_outputs"><a class="viewcode-back" href="../../../../mia_processes.bricks.reports.html#mia_processes.bricks.reports.processes.Result_collector.list_outputs">[docs]</a>    <span class="k">def</span> <span class="nf">list_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_plugged</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the initialisation step of the brick.</span>

<span class="sd">        The main objective of this method is to produce the outputs of the</span>
<span class="sd">        bricks (self.outputs) and the associated tags (self.inheritance_dic),</span>
<span class="sd">        if defined here. In order not to include an output in the database,</span>
<span class="sd">        this output must be a value of the optional key &#39;notInDb&#39; of the</span>
<span class="sd">        self.outputs dictionary. To work properly this method must return</span>
<span class="sd">        self.make_initResult() object.</span>

<span class="sd">        :param is_plugged: the state, linked or not, of the plugs.</span>
<span class="sd">        :returns: a dictionary with requirement, outputs and inheritance_dict.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Using the inheritance to ProcessMIA class, list_outputs method</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Result_collector</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">list_outputs</span><span class="p">()</span>

        <span class="c1"># Outputs definition and tags inheritance (optional)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculs</span> <span class="o">!=</span> <span class="n">Undefined</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">parametric_maps</span> <span class="o">!=</span> <span class="n">Undefined</span><span class="p">:</span>
            <span class="c1"># FIXME 1: We retrieve the name of the patient from the first</span>
            <span class="c1">#          element of parametric_maps. This is only fine if all the</span>
            <span class="c1">#          elements of parametric_maps correspond to the same</span>
            <span class="c1">#          patient.</span>
            <span class="c1"># FIXME 2: The data should be anonymised and we should use</span>
            <span class="c1">#          PatientRef instead of PatientName !</span>
            <span class="n">patient_name</span> <span class="o">=</span> <span class="n">get_dbFieldValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">parametric_maps</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                            <span class="s1">&#39;PatientName&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">patient_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Result_collector brick:</span><span class="se">\n</span><span class="s1">The PatientName tag is not &#39;</span>
                      <span class="s1">&#39;filled in the database for the </span><span class="si">{}</span><span class="s1"> file ...</span><span class="se">\n</span><span class="s1"> The &#39;</span>
                      <span class="s1">&#39;initialization is &#39;</span>
                      <span class="s1">&#39;aborted...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parametric_maps</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_initResult</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">dict4runtime</span><span class="p">[</span><span class="s1">&#39;patient_name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">patient_name</span>
            <span class="n">roi_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span>
                                   <span class="s1">&#39;roi_&#39;</span> <span class="o">+</span> <span class="n">patient_name</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">roi_dir</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Result_collector brick:</span><span class="se">\n</span><span class="s2">No </span><span class="si">{}</span><span class="s2"> folder detected ...&quot;</span>
                      <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">The initialization is aborted ...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">roi_dir</span><span class="p">))</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_initResult</span><span class="p">()</span>

            <span class="n">analysis_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">roi_dir</span><span class="p">,</span> <span class="s1">&#39;ROI_analysis&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">analysis_dir</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Mean_stdDev_cal brick:</span><span class="se">\n</span><span class="s2">No </span><span class="si">{}</span><span class="s2"> folder detected ...&quot;</span>
                      <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">The initialization is &quot;</span>
                      <span class="s2">&quot;aborted ...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">analysis_dir</span><span class="p">))</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_initResult</span><span class="p">()</span>

            <span class="n">out_files</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">parametric_map</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parametric_maps</span><span class="p">:</span>

                <span class="k">for</span> <span class="n">calcul</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculs</span><span class="p">:</span>
                    <span class="n">out_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">analysis_dir</span><span class="p">,</span>
                                     <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">_</span><span class="si">{1}</span><span class="s2">_</span><span class="si">{2}</span><span class="s2">.xls&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                         <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                                         <span class="n">calcul</span><span class="p">,</span>
                                         <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span>
                                             <span class="n">parametric_map</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">9</span><span class="p">])))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;out_files&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">out_files</span>

            <span class="c1"># FIXME: the data should be anonymised and we should use PatientRef</span>
            <span class="c1">#        instead of PatientName !</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">patient_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PatientName&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span>
                                 <span class="bp">self</span><span class="o">.</span><span class="n">patient_info</span><span class="p">[</span><span class="s1">&#39;PatientName&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">Undefined</span><span class="p">):</span>
                <span class="n">patient_ref</span> <span class="o">=</span> <span class="n">get_dbFieldValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span>
                                               <span class="bp">self</span><span class="o">.</span><span class="n">parametric_maps</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                               <span class="s1">&#39;PatientRef&#39;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">patient_ref</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">patient_info</span><span class="p">[</span><span class="s1">&#39;PatientName&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">patient_name</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">patient_info</span><span class="p">[</span><span class="s1">&#39;PatientName&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">patient_ref</span>

            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">patient_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Pathology&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span>
                                   <span class="bp">self</span><span class="o">.</span><span class="n">patient_info</span><span class="p">[</span><span class="s1">&#39;Pathology&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">Undefined</span><span class="p">):</span>
                <span class="n">pathology</span> <span class="o">=</span> <span class="n">get_dbFieldValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span>
                                             <span class="bp">self</span><span class="o">.</span><span class="n">parametric_maps</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                             <span class="s1">&#39;Pathology&#39;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">pathology</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">patient_info</span><span class="p">[</span><span class="s1">&#39;Pathology&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Undefined&#39;</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">patient_info</span><span class="p">[</span><span class="s1">&#39;Pathology&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pathology</span>

            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">patient_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Age&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span>
                                         <span class="bp">self</span><span class="o">.</span><span class="n">patient_info</span><span class="p">[</span><span class="s1">&#39;Age&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">Undefined</span><span class="p">):</span>
                <span class="n">age</span> <span class="o">=</span> <span class="n">get_dbFieldValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="n">parametric_maps</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                       <span class="s1">&#39;Age&#39;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">age</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">patient_info</span><span class="p">[</span><span class="s1">&#39;Age&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Undefined&#39;</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">patient_info</span><span class="p">[</span><span class="s1">&#39;Age&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">age</span>

            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">patient_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Sex&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span>
                                         <span class="bp">self</span><span class="o">.</span><span class="n">patient_info</span><span class="p">[</span><span class="s1">&#39;Sex&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">Undefined</span><span class="p">):</span>
                <span class="n">sex</span> <span class="o">=</span> <span class="n">get_dbFieldValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="n">parametric_maps</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                       <span class="s1">&#39;Sex&#39;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">sex</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">patient_info</span><span class="p">[</span><span class="s1">&#39;Sex&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Undefined&#39;</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">patient_info</span><span class="p">[</span><span class="s1">&#39;Sex&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sex</span>

            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">patient_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;MR&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">patient_info</span><span class="p">[</span><span class="s1">&#39;MR&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">Undefined</span><span class="p">):</span>
                <span class="n">mr</span> <span class="o">=</span> <span class="n">get_dbFieldValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span>
                                      <span class="bp">self</span><span class="o">.</span><span class="n">parametric_maps</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                      <span class="s1">&#39;MR&#39;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">mr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">patient_info</span><span class="p">[</span><span class="s1">&#39;MR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Undefined&#39;</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">patient_info</span><span class="p">[</span><span class="s1">&#39;MR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mr</span>

            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">patient_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Gas&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span>
                                         <span class="bp">self</span><span class="o">.</span><span class="n">patient_info</span><span class="p">[</span><span class="s1">&#39;Gas&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">Undefined</span><span class="p">):</span>
                <span class="n">gas</span> <span class="o">=</span> <span class="n">get_dbFieldValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="n">parametric_maps</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                       <span class="s1">&#39;Gas&#39;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">gas</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">patient_info</span><span class="p">[</span><span class="s1">&#39;Gas&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Undefined&#39;</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">patient_info</span><span class="p">[</span><span class="s1">&#39;Gas&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gas</span>

            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">patient_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;GasAdmin&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">patient_info</span><span class="p">[</span><span class="s1">&#39;GasAdmin&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">Undefined</span><span class="p">):</span>
                <span class="n">gas_admin</span> <span class="o">=</span> <span class="n">get_dbFieldValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span>
                                             <span class="bp">self</span><span class="o">.</span><span class="n">parametric_maps</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                             <span class="s1">&#39;GasAdmin&#39;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">gas_admin</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">patient_info</span><span class="p">[</span><span class="s1">&#39;GasAdmin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Undefined&#39;</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">patient_info</span><span class="p">[</span><span class="s1">&#39;GasAdmin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gas_admin</span>

        <span class="c1"># Return the requirement, outputs and inheritance_dict</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_initResult</span><span class="p">()</span></div>

<div class="viewcode-block" id="Result_collector.run_process_mia"><a class="viewcode-back" href="../../../../mia_processes.bricks.reports.html#mia_processes.bricks.reports.processes.Result_collector.run_process_mia">[docs]</a>    <span class="k">def</span> <span class="nf">run_process_mia</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the process launch step of the brick.&quot;&quot;&quot;</span>
        <span class="c1"># No need the next line (we don&#39;t use self.process and SPM)</span>
        <span class="c1">#super(Mean_stdDev_calc, self).run_process_mia()</span>

        <span class="c1"># Getting the list of all positions (doublet_list without hemisphere)</span>
        <span class="n">roi_list</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list of all ROIs</span>

        <span class="k">for</span> <span class="n">roi</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">doublet_list</span><span class="p">:</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">roi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">pos</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">roi_list</span><span class="p">:</span>
                <span class="n">roi_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>

        <span class="n">roi_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span>
                               <span class="s1">&#39;roi_&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dict4runtime</span><span class="p">[</span><span class="s1">&#39;patient_name&#39;</span><span class="p">])</span>
        <span class="n">analysis_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">roi_dir</span><span class="p">,</span> <span class="s1">&#39;ROI_analysis&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">analysis_dir</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No &#39;ROI_analysis&#39; folder in the working directory </span><span class="si">{0}</span><span class="s2">.&quot;</span><span class="o">.</span>
                  <span class="nb">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parametric_maps</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
            <span class="k">return</span> <span class="p">{}</span>  <span class="c1"># FIXME: Test what exactly happens in this case</span>

        <span class="k">for</span> <span class="n">parametric_map</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parametric_maps</span><span class="p">:</span>
            <span class="n">map_name_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">parametric_map</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">9</span><span class="p">]</span>
            <span class="n">map_name</span> <span class="o">=</span> <span class="n">map_name_file</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">calcul</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">calculs</span><span class="p">:</span>
                <span class="n">out_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">analysis_dir</span><span class="p">,</span>
                                        <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">_</span><span class="si">{1}</span><span class="s2">_</span><span class="si">{2}</span><span class="s2">.xls&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                                                                 <span class="n">calcul</span><span class="p">,</span>
                                                                 <span class="n">map_name_file</span><span class="p">))</span>

                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">out_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="se">\t</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;subjects&#39;</span><span class="p">))</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="se">\t</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;patho&#39;</span><span class="p">))</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="se">\t</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;age&#39;</span><span class="p">))</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="se">\t</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;sex&#39;</span><span class="p">))</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="se">\t</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;MR&#39;</span><span class="p">))</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="se">\t</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;Gaz&#39;</span><span class="p">))</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="se">\t</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s1">&#39;Admin&#39;</span><span class="p">))</span>

                    <span class="k">if</span> <span class="n">calcul</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;IL_mean&#39;</span><span class="p">,</span> <span class="s1">&#39;IL_std&#39;</span><span class="p">]:</span>

                        <span class="k">for</span> <span class="n">roi</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">doublet_list</span><span class="p">:</span>
                            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">_</span><span class="si">{1}</span><span class="se">\t</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">map_name</span><span class="p">,</span>
                                                       <span class="n">roi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">roi</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="n">roi_list</span><span class="p">:</span>
                            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">_</span><span class="si">{1}</span><span class="se">\t</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">map_name</span><span class="p">,</span> <span class="n">pos</span><span class="p">))</span>

                    <span class="c1"># FIXME: We should iterate on each patient here ?</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{0}</span><span class="se">\t</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">patient_info</span><span class="p">[</span><span class="s2">&quot;PatientName&quot;</span><span class="p">]))</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="se">\t</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">patient_info</span><span class="p">[</span><span class="s2">&quot;Pathology&quot;</span><span class="p">]))</span>
                    <span class="c1">#f.write(&quot;%3.1f\t&quot; % self.patient_info[&quot;Age&quot;])</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="se">\t</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">patient_info</span><span class="p">[</span><span class="s2">&quot;Age&quot;</span><span class="p">]))</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="se">\t</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">patient_info</span><span class="p">[</span><span class="s2">&quot;Sex&quot;</span><span class="p">]))</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="se">\t</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">patient_info</span><span class="p">[</span><span class="s2">&quot;MR&quot;</span><span class="p">]))</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="se">\t</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">patient_info</span><span class="p">[</span><span class="s2">&quot;Gas&quot;</span><span class="p">]))</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="se">\t</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">patient_info</span><span class="p">[</span><span class="s2">&quot;GasAdmin&quot;</span><span class="p">]))</span>

                    <span class="k">if</span> <span class="n">calcul</span> <span class="o">==</span> <span class="s1">&#39;mean&#39;</span><span class="p">:</span>

                        <span class="k">for</span> <span class="n">roi</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">doublet_list</span><span class="p">:</span>
                            <span class="n">roi_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                                <span class="n">analysis_dir</span><span class="p">,</span>
                                <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">_mean</span><span class="si">{1}</span><span class="s2">_</span><span class="si">{2}</span><span class="s2">.txt&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">roi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">roi</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                                             <span class="n">map_name</span><span class="p">,</span>
                                                             <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">))</span>
                            <span class="k">try</span><span class="p">:</span>

                                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">roi_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f_read</span><span class="p">:</span>
                                    <span class="n">final_res</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">f_read</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>

                                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="se">\t</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">final_res</span><span class="p">))</span>

                            <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Result_collector brick:</span><span class="se">\n</span><span class="s1"> </span><span class="si">{}</span><span class="s1"> not &#39;</span>
                                      <span class="s1">&#39;found ...</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">roi_file</span><span class="p">))</span>
                                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Undefined</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>

                    <span class="k">elif</span> <span class="n">calcul</span> <span class="o">==</span> <span class="s1">&#39;IL_mean&#39;</span><span class="p">:</span>
                        <span class="n">roi_checked</span> <span class="o">=</span> <span class="p">[]</span>

                        <span class="k">for</span> <span class="n">roi</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">doublet_list</span><span class="p">:</span>

                            <span class="k">if</span> <span class="n">roi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">roi_checked</span><span class="p">:</span>
                                <span class="k">continue</span>

                            <span class="n">roi_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                                <span class="n">analysis_dir</span><span class="p">,</span>
                                <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">_mean</span><span class="si">{1}</span><span class="s2">_</span><span class="si">{2}</span><span class="s2">.txt&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">roi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">roi</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                                             <span class="n">map_name</span><span class="p">,</span>
                                                             <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">))</span>
                            <span class="k">try</span><span class="p">:</span>

                                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">roi_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f_read</span><span class="p">:</span>
                                    <span class="n">roi_value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">f_read</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>

                            <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Result_collector brick:</span><span class="se">\n</span><span class="s1"> </span><span class="si">{}</span><span class="s1"> not &#39;</span>
                                      <span class="s1">&#39;found ...</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">roi_file</span><span class="p">))</span>
                                <span class="n">roi_value</span> <span class="o">=</span> <span class="kc">None</span>

                            <span class="c1"># Searching the ROI that has the same first element</span>
                            <span class="n">roi_2</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">doublet_list</span>
                                     <span class="k">if</span> <span class="n">roi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span>
                                     <span class="n">roi</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="mi">0</span><span class="p">]</span>
                            <span class="n">roi_file_2</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                                <span class="n">analysis_dir</span><span class="p">,</span>
                                <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">_mean</span><span class="si">{1}</span><span class="s2">_</span><span class="si">{2}</span><span class="s2">.&quot;</span>
                                <span class="s2">&quot;txt&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                    <span class="n">roi_2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">roi_2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                    <span class="n">map_name</span><span class="p">,</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">))</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">roi_file_2</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f_read</span><span class="p">:</span>
                                    <span class="n">roi_value_2</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">f_read</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>

                            <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Result_collector brick:</span><span class="se">\n</span><span class="s1"> </span><span class="si">{}</span><span class="s1"> not &#39;</span>
                                      <span class="s1">&#39;found ...</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">roi_file_2</span><span class="p">))</span>
                                <span class="n">roi_value_2</span> <span class="o">=</span> <span class="kc">None</span>

                            <span class="c1"># IL = (Left - Right) / ((Left + Right)</span>
                            <span class="k">if</span> <span class="n">roi</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;_L&#39;</span><span class="p">:</span>
                                <span class="n">sub_1</span> <span class="o">=</span> <span class="n">roi_value</span>
                                <span class="n">sub_2</span> <span class="o">=</span> <span class="n">roi_value_2</span>

                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">sub_1</span> <span class="o">=</span> <span class="n">roi_value_2</span>
                                <span class="n">sub_2</span> <span class="o">=</span> <span class="n">roi_value</span>

                            <span class="k">if</span> <span class="n">sub_1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">sub_2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="n">final_res</span> <span class="o">=</span> <span class="p">(</span><span class="n">sub_1</span> <span class="o">-</span> <span class="n">sub_2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">sub_1</span> <span class="o">+</span> <span class="n">sub_2</span><span class="p">)</span>
                                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="se">\t</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">final_res</span><span class="p">))</span>

                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Undefined</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>

                            <span class="n">roi_checked</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">roi</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

                    <span class="k">elif</span> <span class="n">calcul</span> <span class="o">==</span> <span class="s2">&quot;std&quot;</span><span class="p">:</span>

                        <span class="k">for</span> <span class="n">roi</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">doublet_list</span><span class="p">:</span>
                            <span class="n">roi_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                                <span class="n">analysis_dir</span><span class="p">,</span>
                                <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">_std</span><span class="si">{1}</span><span class="s2">_</span><span class="si">{2}</span><span class="s2">.txt&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">roi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">roi</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                                            <span class="n">map_name</span><span class="p">,</span>
                                                            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">))</span>

                            <span class="k">try</span><span class="p">:</span>

                                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">roi_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f_read</span><span class="p">:</span>
                                    <span class="n">final_res</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">f_read</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>

                                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="se">\t</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">final_res</span><span class="p">))</span>

                            <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Result_collector brick:</span><span class="se">\n</span><span class="s1"> </span><span class="si">{}</span><span class="s1"> not &#39;</span>
                                      <span class="s1">&#39;found ...</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">roi_file</span><span class="p">))</span>
                                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Undefined</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>

                    <span class="k">elif</span> <span class="n">calcul</span> <span class="o">==</span> <span class="s1">&#39;IL_std&#39;</span><span class="p">:</span>
                        <span class="n">roi_checked</span> <span class="o">=</span> <span class="p">[]</span>

                        <span class="k">for</span> <span class="n">roi</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">doublet_list</span><span class="p">:</span>

                            <span class="k">if</span> <span class="n">roi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">roi_checked</span><span class="p">:</span>
                                <span class="k">continue</span>

                            <span class="n">roi_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                                <span class="n">analysis_dir</span><span class="p">,</span>
                                <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">_std</span><span class="si">{1}</span><span class="s2">_</span><span class="si">{2}</span><span class="s2">.txt&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">roi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">roi</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                                            <span class="n">map_name</span><span class="p">,</span>
                                                            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">))</span>

                            <span class="k">try</span><span class="p">:</span>

                                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">roi_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f_read</span><span class="p">:</span>
                                    <span class="n">roi_value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">f_read</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>

                            <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Result_collector brick:</span><span class="se">\n</span><span class="s1"> </span><span class="si">{}</span><span class="s1"> not &#39;</span>
                                      <span class="s1">&#39;found ...</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">roi_file</span><span class="p">))</span>
                                <span class="n">roi_value</span> <span class="o">=</span> <span class="kc">None</span>

                            <span class="c1"># Searching the roi that has the same first element</span>
                            <span class="n">roi_2</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">doublet_list</span> <span class="k">if</span>
                                     <span class="n">roi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span>
                                     <span class="n">roi</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="mi">0</span><span class="p">]</span>

                            <span class="n">roi_file_2</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                                <span class="n">analysis_dir</span><span class="p">,</span>
                                <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">_std</span><span class="si">{1}</span><span class="s2">_</span><span class="si">{2}</span><span class="s2">.txt&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                    <span class="n">roi_2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">roi_2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                    <span class="n">map_name</span><span class="p">,</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">))</span>

                            <span class="k">try</span><span class="p">:</span>
                                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">roi_file_2</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f_read</span><span class="p">:</span>
                                    <span class="n">roi_value_2</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">f_read</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>

                            <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Result_collector brick:</span><span class="se">\n</span><span class="s1"> </span><span class="si">{}</span><span class="s1"> not &#39;</span>
                                      <span class="s1">&#39;found ...</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">roi_file_2</span><span class="p">))</span>
                                <span class="n">roi_value_2</span> <span class="o">=</span> <span class="kc">None</span>

                            <span class="c1"># IL = (Left - Right) / ((Left + Right)</span>
                            <span class="k">if</span> <span class="n">roi</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;_L&#39;</span><span class="p">:</span>
                                <span class="n">sub_1</span> <span class="o">=</span> <span class="n">roi_value</span>
                                <span class="n">sub_2</span> <span class="o">=</span> <span class="n">roi_value_2</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">sub_1</span> <span class="o">=</span> <span class="n">roi_value_2</span>
                                <span class="n">sub_2</span> <span class="o">=</span> <span class="n">roi_value</span>

                            <span class="k">if</span> <span class="n">sub_1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">sub_2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="n">final_res</span> <span class="o">=</span> <span class="p">(</span><span class="n">sub_1</span> <span class="o">-</span> <span class="n">sub_2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">sub_1</span> <span class="o">+</span> <span class="n">sub_2</span><span class="p">)</span>
                                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="se">\t</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">final_res</span><span class="p">))</span>

                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Undefined</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>

                            <span class="n">roi_checked</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">roi</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span></div></div>


<div class="viewcode-block" id="Spikes"><a class="viewcode-back" href="../../../../mia_processes.bricks.reports.html#mia_processes.bricks.reports.processes.Spikes">[docs]</a><span class="k">class</span> <span class="nc">Spikes</span><span class="p">(</span><span class="n">ProcessMIA</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    * Computes the number of spikes.</span>

<span class="sd">    Please, see the complete documentation for the `Spikes&#39; brick in the populse.mia_processes website</span>
<span class="sd">    &lt;https://populse.github.io/mia_processes/html/documentation/bricks/reports/Spikes.html&gt;`_</span>

<span class="sd">    adapted from:</span>
<span class="sd">    https://github.com/nipreps/mriqc/blob/e021008da0a2ef1c48e882baf932139a673349f9/mriqc/workflows/functional.py#L939</span>
<span class="sd">    https://github.com/nipreps/mriqc/blob/e021008da0a2ef1c48e882baf932139a673349f9/mriqc/interfaces/functional.py#L223</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Spikes.__init__"><a class="viewcode-back" href="../../../../mia_processes.bricks.reports.html#mia_processes.bricks.reports.processes.Spikes.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the attributes initialisation/instantiation.</span>

<span class="sd">        The input and output plugs are defined here. The special</span>
<span class="sd">        &#39;self.requirement&#39; attribute (optional) is used to define the</span>
<span class="sd">        third-party products necessary for the running of the brick.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Initialisation of the objects needed for the launch of the brick</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Spikes</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1"># Third party softwares required for the execution of the brick</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requirement</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Inputs description</span>
        <span class="n">in_file_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;A bold file (a pathlike object or string &#39;</span>
                        <span class="s1">&#39;representing a file).&#39;</span><span class="p">)</span>
        <span class="n">no_zscore_desc</span> <span class="o">=</span> <span class="s1">&#39;Do not zscore (a boolean)&#39;</span>
        <span class="n">detrend_desc</span> <span class="o">=</span> <span class="s1">&#39;Do detrend (a boolean).&#39;</span>
        <span class="n">out_prefix_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Specify the string to be prepended to the &#39;</span>
                           <span class="s1">&#39;filenames of the output image file &#39;</span>
                           <span class="s1">&#39;(a string).&#39;</span><span class="p">)</span>
        <span class="n">spike_thresh_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;z-score to call one timepoint of one axial&quot;</span>
                             <span class="s2">&quot; slice a spike (a float)&quot;</span><span class="p">)</span>
        <span class="n">skip_frames_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;number of frames to skip in the beginning &quot;</span>
                            <span class="s2">&quot;of the time series (an int)&quot;</span><span class="p">)</span>

        <span class="c1"># Outputs description</span>
        <span class="n">out_file_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;The output file (a pathlike object or a &#39;</span>
                         <span class="s1">&#39;string representing a file).&#39;</span><span class="p">)</span>

        <span class="c1"># Inputs traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;in_file&quot;</span><span class="p">,</span>
                       <span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">optional</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">desc</span><span class="o">=</span><span class="n">in_file_desc</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;no_zscore&quot;</span><span class="p">,</span>
                       <span class="n">traits</span><span class="o">.</span><span class="n">Bool</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                   <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">desc</span><span class="o">=</span><span class="n">no_zscore_desc</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;detrend&quot;</span><span class="p">,</span>
                       <span class="n">traits</span><span class="o">.</span><span class="n">Bool</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span>
                                   <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                   <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">desc</span><span class="o">=</span><span class="n">detrend_desc</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;spike_thresh&quot;</span><span class="p">,</span>
                       <span class="n">traits</span><span class="o">.</span><span class="n">Float</span><span class="p">(</span><span class="mf">6.0</span><span class="p">,</span>
                                    <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                    <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                    <span class="n">desc</span><span class="o">=</span><span class="n">spike_thresh_desc</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;skip_frames&quot;</span><span class="p">,</span>
                       <span class="n">traits</span><span class="o">.</span><span class="n">Int</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span>
                                  <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                  <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                  <span class="n">desc</span><span class="o">=</span><span class="n">skip_frames_desc</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;out_prefix&quot;</span><span class="p">,</span>
                       <span class="n">traits</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="s1">&#39;spikes_&#39;</span><span class="p">,</span>
                                     <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                     <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                     <span class="n">desc</span><span class="o">=</span><span class="n">out_prefix_desc</span><span class="p">))</span>

        <span class="c1"># Outputs traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;out_file&quot;</span><span class="p">,</span>
                       <span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">desc</span><span class="o">=</span><span class="n">out_file_desc</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">init_default_traits</span><span class="p">()</span></div>

<div class="viewcode-block" id="Spikes.list_outputs"><a class="viewcode-back" href="../../../../mia_processes.bricks.reports.html#mia_processes.bricks.reports.processes.Spikes.list_outputs">[docs]</a>    <span class="k">def</span> <span class="nf">list_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_plugged</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the initialisation step of the brick.</span>

<span class="sd">        The main objective of this method is to produce the outputs of the</span>
<span class="sd">        bricks (self.outputs) and the associated tags (self.inheritance_dic),</span>
<span class="sd">        if defined here. In order not to include an output in the database,</span>
<span class="sd">        this output must be a value of the optional key &#39;notInDb&#39; of the</span>
<span class="sd">        self.outputs dictionary. To work properly this method must return</span>
<span class="sd">        self.make_initResult() object.</span>

<span class="sd">        :param is_plugged: the state, linked or not, of the plugs.</span>
<span class="sd">        :returns: a dictionary with requirement, outputs and inheritance_dict.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Using the inheritance to ProcessMIA class, list_outputs method</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Spikes</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">list_outputs</span><span class="p">()</span>

        <span class="c1"># Outputs definition and tags inheritance (optional)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_file</span><span class="p">:</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_prefix</span> <span class="o">==</span> <span class="n">Undefined</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">out_prefix</span> <span class="o">=</span> <span class="s1">&#39;spikes_&#39;</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;The out_prefix parameter is undefined. Automatically &#39;</span>
                      <span class="s1">&#39;set to &quot;spikes&quot; ...&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">:</span>
                <span class="n">valid_ext</span><span class="p">,</span> <span class="n">in_ext</span><span class="p">,</span> <span class="n">fileName</span> <span class="o">=</span> <span class="n">checkFileExt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_file</span><span class="p">,</span> <span class="n">EXT</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_ext</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">The input image format is not recognized ...!&#39;</span><span class="p">)</span>
                    <span class="k">return</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;out_file&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">out_prefix</span> <span class="o">+</span> <span class="n">fileName</span> <span class="o">+</span> <span class="s1">&#39;.out&#39;</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No output_directory was found...!</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">inheritance_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span>
                <span class="s1">&#39;out_file&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_file</span>

        <span class="c1"># Return the requirement, outputs and inheritance_dict</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_initResult</span><span class="p">()</span></div>

<div class="viewcode-block" id="Spikes.run_process_mia"><a class="viewcode-back" href="../../../../mia_processes.bricks.reports.html#mia_processes.bricks.reports.processes.Spikes.run_process_mia">[docs]</a>    <span class="k">def</span> <span class="nf">run_process_mia</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the process launch step of the brick.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Spikes</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">run_process_mia</span><span class="p">()</span>

        <span class="n">func_nii</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_file</span><span class="p">)</span>
        <span class="n">func_data</span> <span class="o">=</span> <span class="n">func_nii</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">()</span>
        <span class="n">func_shape</span> <span class="o">=</span> <span class="n">func_data</span><span class="o">.</span><span class="n">shape</span>

        <span class="n">orientation</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">aff2axcodes</span><span class="p">(</span><span class="n">func_nii</span><span class="o">.</span><span class="n">affine</span><span class="p">)</span>

        <span class="n">new_mask_3d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">func_nii</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">3</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">orientation</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;L&quot;</span><span class="p">,</span> <span class="s2">&quot;R&quot;</span><span class="p">]:</span>
            <span class="n">new_mask_3d</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">new_mask_3d</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new_mask_3d</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">new_mask_3d</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">3</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">ntsteps</span> <span class="o">=</span> <span class="n">func_shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">tr</span> <span class="o">=</span> <span class="n">func_nii</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">get_zooms</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">nskip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">skip_frames</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">detrend</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">func_data</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">ntsteps</span><span class="p">)</span>
            <span class="n">clean_data</span> <span class="o">=</span> <span class="n">clean</span><span class="p">(</span><span class="n">data</span><span class="p">[:,</span> <span class="n">nskip</span><span class="p">:]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">t_r</span><span class="o">=</span><span class="n">tr</span><span class="p">,</span> <span class="n">standardize</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
            <span class="n">new_shape</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">func_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">func_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">func_shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                <span class="n">clean_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="n">func_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">func_shape</span><span class="p">)</span>
            <span class="n">func_data</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">nskip</span><span class="p">:]</span> <span class="o">=</span> <span class="n">clean_data</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">new_shape</span><span class="p">)</span>

        <span class="n">mask_data</span> <span class="o">=</span> <span class="n">new_mask_3d</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
        <span class="n">mask_data</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">:</span><span class="n">nskip</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">mask_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">mask_data</span><span class="p">]</span> <span class="o">*</span> <span class="n">ntsteps</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">mask_data</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">skip_frames</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">brain</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">func_data</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="p">(</span><span class="n">mask_data</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">no_zscore</span><span class="p">:</span>
            <span class="n">ts_z</span> <span class="o">=</span> <span class="n">find_peaks</span><span class="p">(</span><span class="n">brain</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">ts_z</span> <span class="o">=</span> <span class="n">find_spikes</span><span class="p">(</span><span class="n">brain</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">spike_thresh</span><span class="p">)</span>

        <span class="c1"># File save</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_file</span><span class="p">)</span>
        <span class="n">file_name_no_ext</span><span class="p">,</span> <span class="n">file_extension</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">file_extension</span> <span class="o">==</span> <span class="s1">&#39;.gz&#39;</span><span class="p">:</span>
            <span class="p">(</span><span class="n">file_name_no_ext_2</span><span class="p">,</span>
             <span class="n">file_extension_2</span><span class="p">)</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file_name_no_ext</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">file_extension_2</span> <span class="o">==</span> <span class="s1">&#39;.nii&#39;</span><span class="p">:</span>
                <span class="n">file_name_no_ext</span> <span class="o">=</span> <span class="n">file_name_no_ext_2</span>

        <span class="n">file_out</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span>
                                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">out_prefix</span> <span class="o">+</span>
                                 <span class="n">file_name_no_ext</span> <span class="o">+</span>
                                 <span class="s1">&#39;.out&#39;</span><span class="p">))</span>

        <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">file_out</span><span class="p">,</span> <span class="n">ts_z</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="art_qi1"><a class="viewcode-back" href="../../../../mia_processes.bricks.reports.html#mia_processes.bricks.reports.processes.art_qi1">[docs]</a><span class="k">def</span> <span class="nf">art_qi1</span><span class="p">(</span><span class="n">airmask</span><span class="p">,</span> <span class="n">artmask</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Detect artifacts in the image using the method described in [Mortamet2009].</span>
<span class="sd">    Caculates :math:`\text{QI}_1`, as the proportion of voxels with intensity</span>
<span class="sd">    corrupted by artifacts normalized by the number of voxels in the</span>
<span class="sd">    background:</span>
<span class="sd">    .. math ::</span>
<span class="sd">        \text{QI}_1 = \frac{1}{N} \sum\limits_{x\in X_\text{art}} 1</span>
<span class="sd">    Lower values are better.</span>
<span class="sd">    :param numpy.ndarray airmask: input air mask, without artifacts</span>
<span class="sd">    :param numpy.ndarray artmask: input artifacts mask</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">airmask</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="o">-</span><span class="mf">1.0</span>

    <span class="c1"># Count the number of voxels that remain after the opening operation.</span>
    <span class="c1"># These are artifacts.</span>
    <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">artmask</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="p">(</span><span class="n">airmask</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">+</span> <span class="n">artmask</span><span class="o">.</span><span class="n">sum</span><span class="p">()))</span></div>


<div class="viewcode-block" id="art_qi2"><a class="viewcode-back" href="../../../../mia_processes.bricks.reports.html#mia_processes.bricks.reports.processes.art_qi2">[docs]</a><span class="k">def</span> <span class="nf">art_qi2</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">airmask</span><span class="p">,</span> <span class="n">min_voxels</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="mf">1e3</span><span class="p">),</span> <span class="n">max_voxels</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="mf">3e5</span><span class="p">)):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates :math:`\text{QI}_2`, based on the goodness-of-fit of a centered</span>
<span class="sd">    :math:`\chi^2` distribution onto the intensity distribution of</span>
<span class="sd">    non-artifactual background (within the &quot;hat&quot; mask):</span>
<span class="sd">    .. math ::</span>
<span class="sd">        \chi^2_n = \frac{2}{(\sigma \sqrt{2})^{2n} \, (n - 1)!}x^{2n - 1}\, e^{-\frac{x}{2}}</span>
<span class="sd">    where :math:`n` is the number of coil elements.</span>
<span class="sd">    :param numpy.ndarray img: input data</span>
<span class="sd">    :param numpy.ndarray airmask: input air mask without artifacts</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">chi2</span>
    <span class="kn">from</span> <span class="nn">sklearn.neighbors</span> <span class="kn">import</span> <span class="n">KernelDensity</span>

    <span class="c1"># S. Ogawa was born</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">1191935</span><span class="p">)</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">img</span><span class="p">[</span><span class="n">airmask</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">data</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">min_voxels</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">0.0</span>

    <span class="n">modelx</span> <span class="o">=</span> <span class="n">data</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">max_voxels</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">max_voxels</span><span class="p">)</span>

    <span class="n">x_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">99</span><span class="p">),</span> <span class="mi">1000</span><span class="p">)</span>

    <span class="c1"># Estimate data pdf with KDE on a random subsample</span>
    <span class="n">kde_skl</span> <span class="o">=</span> <span class="n">KernelDensity</span><span class="p">(</span>
        <span class="n">bandwidth</span><span class="o">=</span><span class="mf">0.05</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">98</span><span class="p">),</span> <span class="n">kernel</span><span class="o">=</span><span class="s2">&quot;gaussian&quot;</span>
    <span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">modelx</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">])</span>
    <span class="n">kde</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">kde_skl</span><span class="o">.</span><span class="n">score_samples</span><span class="p">(</span><span class="n">x_grid</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]))</span>

    <span class="c1"># Find cutoff</span>
    <span class="n">kdethi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">kde</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">kde</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">*</span> <span class="mf">0.5</span><span class="p">)</span>

    <span class="c1"># Fit X^2</span>
    <span class="n">param</span> <span class="o">=</span> <span class="n">chi2</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">modelx</span><span class="p">[</span><span class="n">modelx</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">95</span><span class="p">)],</span> <span class="mi">32</span><span class="p">)</span>
    <span class="n">chi_pdf</span> <span class="o">=</span> <span class="n">chi2</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">x_grid</span><span class="p">,</span> <span class="o">*</span><span class="n">param</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">loc</span><span class="o">=</span><span class="n">param</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">scale</span><span class="o">=</span><span class="n">param</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

    <span class="c1"># Compute goodness-of-fit (gof)</span>
    <span class="n">gof</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">kde</span><span class="p">[</span><span class="o">-</span><span class="n">kdethi</span><span class="p">:]</span> <span class="o">-</span> <span class="n">chi_pdf</span><span class="p">[</span><span class="o">-</span><span class="n">kdethi</span><span class="p">:])</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>

    <span class="n">hist_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;x_grid&#39;</span><span class="p">:</span> <span class="n">x_grid</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="s1">&#39;ref_pdf&#39;</span><span class="p">:</span> <span class="n">kde</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
                 <span class="s1">&#39;fit_pdf&#39;</span><span class="p">:</span> <span class="n">chi_pdf</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
                 <span class="s1">&#39;ref_data&#39;</span><span class="p">:</span> <span class="n">modelx</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="s1">&#39;cutoff_idx&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">kdethi</span><span class="p">)}</span>
    <span class="k">return</span> <span class="n">gof</span><span class="p">,</span> <span class="n">hist_dict</span></div>


<div class="viewcode-block" id="cjv"><a class="viewcode-back" href="../../../../mia_processes.bricks.reports.html#mia_processes.bricks.reports.processes.cjv">[docs]</a><span class="k">def</span> <span class="nf">cjv</span><span class="p">(</span><span class="n">mu_wm</span><span class="p">,</span> <span class="n">mu_gm</span><span class="p">,</span> <span class="n">sigma_wm</span><span class="p">,</span> <span class="n">sigma_gm</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the :abbr:`CJV (coefficient of joint variation)`, a measure</span>
<span class="sd">    related to :abbr:`SNR (Signal-to-Noise Ratio)` and</span>
<span class="sd">    :abbr:`CNR (Contrast-to-Noise Ratio)` that is presented as a proxy for</span>
<span class="sd">    the :abbr:`INU (intensity non-uniformity)` artifact [Ganzetti2016]_.</span>
<span class="sd">    Lower is better.</span>
<span class="sd">    .. math::</span>
<span class="sd">        \text{CJV} = \frac{\sigma_\text{WM} + \sigma_\text{GM}}{|\mu_\text{WM} - \mu_\text{GM}|}.</span>
<span class="sd">    :param float mu_wm: mean of signal within white-matter mask.</span>
<span class="sd">    :param float mu_gm: mean of signal within gray-matter mask.</span>
<span class="sd">    :param float sigma_wm: standard deviation of signal within white-matter mask.</span>
<span class="sd">    :param float sigma_gm: standard deviation of signal within gray-matter mask.</span>
<span class="sd">    :return: the computed CJV</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">float</span><span class="p">((</span><span class="n">sigma_wm</span> <span class="o">+</span> <span class="n">sigma_gm</span><span class="p">)</span> <span class="o">/</span> <span class="nb">abs</span><span class="p">(</span><span class="n">mu_wm</span> <span class="o">-</span> <span class="n">mu_gm</span><span class="p">))</span></div>


<div class="viewcode-block" id="cnr"><a class="viewcode-back" href="../../../../mia_processes.bricks.reports.html#mia_processes.bricks.reports.processes.cnr">[docs]</a><span class="k">def</span> <span class="nf">cnr</span><span class="p">(</span><span class="n">mu_wm</span><span class="p">,</span> <span class="n">mu_gm</span><span class="p">,</span> <span class="n">sigma_air</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the :abbr:`CNR (Contrast-to-Noise Ratio)` [Magnota2006]_.</span>
<span class="sd">    Higher values are better.</span>
<span class="sd">    .. math::</span>
<span class="sd">        \text{CNR} = \frac{|\mu_\text{GM} - \mu_\text{WM} |}{\sqrt{\sigma_B^2 +</span>
<span class="sd">        \sigma_\text{WM}^2 + \sigma_\text{GM}^2}},</span>
<span class="sd">    where :math:`\sigma_B` is the standard deviation of the noise distribution within</span>
<span class="sd">    the air (background) mask.</span>
<span class="sd">    :param float mu_wm: mean of signal within white-matter mask.</span>
<span class="sd">    :param float mu_gm: mean of signal within gray-matter mask.</span>
<span class="sd">    :param float sigma_air: standard deviation of the air surrounding the head (&quot;hat&quot; mask).</span>
<span class="sd">    :return: the computed CNR</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">mu_wm</span> <span class="o">-</span> <span class="n">mu_gm</span><span class="p">)</span> <span class="o">/</span> <span class="n">sigma_air</span><span class="p">)</span></div>


<div class="viewcode-block" id="efc"><a class="viewcode-back" href="../../../../mia_processes.bricks.reports.html#mia_processes.bricks.reports.processes.efc">[docs]</a><span class="k">def</span> <span class="nf">efc</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">framemask</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the :abbr:`EFC (Entropy Focus Criterion)` [Atkinson1997]_.</span>
<span class="sd">    Uses the Shannon entropy of voxel intensities as an indication of ghosting</span>
<span class="sd">    and blurring induced by head motion. A range of low values is better,</span>
<span class="sd">    with EFC = 0 for all the energy concentrated in one pixel.</span>
<span class="sd">    .. math::</span>
<span class="sd">        \text{E} = - \sum_{j=1}^N \frac{x_j}{x_\text{max}}</span>
<span class="sd">        \ln \left[\frac{x_j}{x_\text{max}}\right]</span>
<span class="sd">    with :math:`x_\text{max} = \sqrt{\sum_{j=1}^N x^2_j}`.</span>
<span class="sd">    The original equation is normalized by the maximum entropy, so that the</span>
<span class="sd">    :abbr:`EFC (Entropy Focus Criterion)` can be compared across images with</span>
<span class="sd">    different dimensions:</span>
<span class="sd">    .. math::</span>
<span class="sd">        \text{EFC} = \left( \frac{N}{\sqrt{N}} \, \log{\sqrt{N}^{-1}} \right) \text{E}</span>
<span class="sd">    :param numpy.ndarray img: input data</span>
<span class="sd">    :param numpy.ndarray framemask: a mask of empty voxels inserted after a rotation of</span>
<span class="sd">      data</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">framemask</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">framemask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>

    <span class="n">n_vox</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">framemask</span><span class="p">)</span>
    <span class="c1"># Calculate the maximum value of the EFC (which occurs any time all</span>
    <span class="c1"># voxels have the same value)</span>
    <span class="n">efc_max</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">*</span> <span class="n">n_vox</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">n_vox</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">n_vox</span><span class="p">))</span>

    <span class="c1"># Calculate the total image energy</span>
    <span class="n">b_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">img</span><span class="p">[</span><span class="n">framemask</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>

    <span class="c1"># Calculate EFC (add 1e-16 to the image data to keep log happy)</span>
    <span class="k">return</span> <span class="nb">float</span><span class="p">(</span>
        <span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">efc_max</span><span class="p">)</span>
        <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
            <span class="p">(</span><span class="n">img</span><span class="p">[</span><span class="n">framemask</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">b_max</span><span class="p">)</span>
            <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">((</span><span class="n">img</span><span class="p">[</span><span class="n">framemask</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mf">1e-16</span><span class="p">)</span> <span class="o">/</span> <span class="n">b_max</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="fber"><a class="viewcode-back" href="../../../../mia_processes.bricks.reports.html#mia_processes.bricks.reports.processes.fber">[docs]</a><span class="k">def</span> <span class="nf">fber</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">headmask</span><span class="p">,</span> <span class="n">rotmask</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the :abbr:`FBER (Foreground-Background Energy Ratio)` [Shehzad2015]_,</span>
<span class="sd">    defined as the mean energy of image values within the head relative</span>
<span class="sd">    to outside the head. Higher values are better.</span>
<span class="sd">    .. math::</span>
<span class="sd">        \text{FBER} = \frac{E[|F|^2]}{E[|B|^2]}</span>
<span class="sd">    :param numpy.ndarray img: input data</span>
<span class="sd">    :param numpy.ndarray headmask: a mask of the head (including skull, skin, etc.)</span>
<span class="sd">    :param numpy.ndarray rotmask: a mask of empty voxels inserted after a rotation of</span>
<span class="sd">      data</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">fg_mu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">img</span><span class="p">[</span><span class="n">headmask</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

    <span class="n">airmask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">headmask</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
    <span class="n">airmask</span><span class="p">[</span><span class="n">headmask</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">rotmask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">airmask</span><span class="p">[</span><span class="n">rotmask</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">bg_mu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">img</span><span class="p">[</span><span class="n">airmask</span> <span class="o">==</span> <span class="mi">1</span><span class="p">])</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">bg_mu</span> <span class="o">&lt;</span> <span class="mf">1.0e-3</span><span class="p">:</span>
        <span class="k">return</span> <span class="o">-</span><span class="mf">1.0</span>
    <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">fg_mu</span> <span class="o">/</span> <span class="n">bg_mu</span><span class="p">)</span></div>


<div class="viewcode-block" id="find_peaks"><a class="viewcode-back" href="../../../../mia_processes.bricks.reports.html#mia_processes.bricks.reports.processes.find_peaks">[docs]</a><span class="k">def</span> <span class="nf">find_peaks</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="n">t_z</span> <span class="o">=</span> <span class="p">[</span><span class="n">data</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">i</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">])]</span>
    <span class="k">return</span> <span class="n">t_z</span></div>


<div class="viewcode-block" id="find_spikes"><a class="viewcode-back" href="../../../../mia_processes.bricks.reports.html#mia_processes.bricks.reports.processes.find_spikes">[docs]</a><span class="k">def</span> <span class="nf">find_spikes</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">spike_thresh</span><span class="p">):</span>
    <span class="n">data</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">slice_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">t_z</span> <span class="o">=</span> <span class="n">_robust_zscore</span><span class="p">(</span><span class="n">slice_mean</span><span class="p">)</span>
    <span class="n">spikes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">t_z</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">spike_thresh</span>
    <span class="n">spike_inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">spikes</span><span class="o">.</span><span class="n">nonzero</span><span class="p">())</span>
    <span class="c1"># mask out the spikes and recompute z-scores using variance uncontaminated with spikes.</span>
    <span class="c1"># This will catch smaller spikes that may have been swamped by big</span>
    <span class="c1"># ones.</span>
    <span class="n">data</span><span class="o">.</span><span class="n">mask</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">spike_inds</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">spike_inds</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">slice_mean2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">t_z</span> <span class="o">=</span> <span class="n">_robust_zscore</span><span class="p">(</span><span class="n">slice_mean2</span><span class="p">)</span>

    <span class="n">spikes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">spikes</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">t_z</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">spike_thresh</span><span class="p">)</span>
    <span class="n">spike_inds</span> <span class="o">=</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">spikes</span><span class="o">.</span><span class="n">nonzero</span><span class="p">())]</span>
    <span class="k">return</span> <span class="n">spike_inds</span><span class="p">,</span> <span class="n">t_z</span></div>


<div class="viewcode-block" id="fuzzy_jaccard"><a class="viewcode-back" href="../../../../mia_processes.bricks.reports.html#mia_processes.bricks.reports.processes.fuzzy_jaccard">[docs]</a><span class="k">def</span> <span class="nf">fuzzy_jaccard</span><span class="p">(</span><span class="n">in_tpms</span><span class="p">,</span> <span class="n">in_mni_tpms</span><span class="p">):</span>
    <span class="n">overlaps</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">tpm</span><span class="p">,</span> <span class="n">mni_tpm</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">in_tpms</span><span class="p">,</span> <span class="n">in_mni_tpms</span><span class="p">):</span>
        <span class="n">tpm</span> <span class="o">=</span> <span class="n">tpm</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">mni_tpm</span> <span class="o">=</span> <span class="n">mni_tpm</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">num</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">tpm</span><span class="p">,</span> <span class="n">mni_tpm</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">den</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">tpm</span><span class="p">,</span> <span class="n">mni_tpm</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">overlaps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">num</span> <span class="o">/</span> <span class="n">den</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">overlaps</span></div>


<div class="viewcode-block" id="gsr"><a class="viewcode-back" href="../../../../mia_processes.bricks.reports.html#mia_processes.bricks.reports.processes.gsr">[docs]</a><span class="k">def</span> <span class="nf">gsr</span><span class="p">(</span><span class="n">epi_data</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="n">ref_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">out_file</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute the :abbr:`GSR (ghost to signal ratio)` [Giannelli2010]_.</span>
<span class="sd">    The procedure is as follows:</span>
<span class="sd">      #. Create a Nyquist ghost mask by circle-shifting the original mask by :math:`N/2`.</span>
<span class="sd">      #. Rotate by :math:`N/2`</span>
<span class="sd">      #. Remove the intersection with the original mask</span>
<span class="sd">      #. Generate a non-ghost background</span>
<span class="sd">      #. Calculate the :abbr:`GSR (ghost to signal ratio)`</span>
<span class="sd">    .. warning ::</span>
<span class="sd">      This should be used with EPI images for which the phase</span>
<span class="sd">      encoding direction is known.</span>
<span class="sd">    :param str epi_file: path to epi file</span>
<span class="sd">    :param str mask_file: path to brain mask</span>
<span class="sd">    :param str direction: the direction of phase encoding (x, y, all)</span>
<span class="sd">    :return: the computed gsr</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">direction</span> <span class="o">=</span> <span class="n">direction</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">direction</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;all&quot;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
            <span class="s2">&quot;Unknown direction </span><span class="si">{}</span><span class="s2">, should be one of x, -x, y, -y, all&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">direction</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">direction</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">newdir</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">]:</span>
            <span class="n">ofile</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">out_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">fname</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">ofile</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ext</span> <span class="o">==</span> <span class="s2">&quot;.gz&quot;</span><span class="p">:</span>
                    <span class="n">fname</span><span class="p">,</span> <span class="n">ext2</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
                    <span class="n">ext</span> <span class="o">=</span> <span class="n">ext2</span> <span class="o">+</span> <span class="n">ext</span>
                <span class="n">ofile</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">_</span><span class="si">{1}{2}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">newdir</span><span class="p">,</span> <span class="n">ext</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">+=</span> <span class="p">[</span><span class="n">gsr</span><span class="p">(</span><span class="n">epi_data</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">newdir</span><span class="p">,</span> <span class="n">ref_file</span><span class="o">=</span><span class="n">ref_file</span><span class="p">,</span>
                           <span class="n">out_file</span><span class="o">=</span><span class="n">ofile</span><span class="p">)]</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="c1"># Roll data of mask through the appropriate axis</span>
    <span class="n">axis</span> <span class="o">=</span> <span class="n">RAS_AXIS_ORDER</span><span class="p">[</span><span class="n">direction</span><span class="p">]</span>
    <span class="n">n2_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">mask</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span>

    <span class="c1"># Step 3: remove from n2_mask pixels inside the brain</span>
    <span class="n">n2_mask</span> <span class="o">=</span> <span class="n">n2_mask</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">mask</span><span class="p">)</span>

    <span class="c1"># Step 4: non-ghost background region is labeled as 2</span>
    <span class="n">n2_mask</span> <span class="o">=</span> <span class="n">n2_mask</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">n2_mask</span> <span class="o">-</span> <span class="n">mask</span><span class="p">)</span>

    <span class="c1"># Step 5: signal is the entire foreground image</span>
    <span class="n">ghost</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">epi_data</span><span class="p">[</span><span class="n">n2_mask</span> <span class="o">==</span> <span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">epi_data</span><span class="p">[</span><span class="n">n2_mask</span> <span class="o">==</span> <span class="mi">2</span><span class="p">])</span>
    <span class="n">signal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">epi_data</span><span class="p">[</span><span class="n">n2_mask</span> <span class="o">==</span> <span class="mi">0</span><span class="p">])</span>
    <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">ghost</span> <span class="o">/</span> <span class="n">signal</span><span class="p">)</span></div>


<div class="viewcode-block" id="image_binary_dilation"><a class="viewcode-back" href="../../../../mia_processes.bricks.reports.html#mia_processes.bricks.reports.processes.image_binary_dilation">[docs]</a><span class="k">def</span> <span class="nf">image_binary_dilation</span><span class="p">(</span><span class="n">in_mask</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Dilate the input binary mask.</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    in_mask: :obj:`numpy.ndarray`</span>
<span class="sd">        A 3D binary array.</span>
<span class="sd">    radius: :obj:`int`, optional</span>
<span class="sd">        The radius of the ball-shaped footprint for dilation of the mask.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">ndimage</span> <span class="k">as</span> <span class="n">ndi</span>
    <span class="kn">from</span> <span class="nn">skimage.morphology</span> <span class="kn">import</span> <span class="n">ball</span>

    <span class="k">return</span> <span class="n">ndi</span><span class="o">.</span><span class="n">binary_dilation</span><span class="p">(</span><span class="n">in_mask</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">),</span> <span class="n">ball</span><span class="p">(</span><span class="n">radius</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span></div>


<div class="viewcode-block" id="normalize_mc_params"><a class="viewcode-back" href="../../../../mia_processes.bricks.reports.html#mia_processes.bricks.reports.processes.normalize_mc_params">[docs]</a><span class="k">def</span> <span class="nf">normalize_mc_params</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">source</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Normalize a single row of motion parameters to the SPM format.</span>
<span class="sd">    SPM saves motion parameters as:</span>
<span class="sd">        x   Right-Left          (mm)</span>
<span class="sd">        y   Anterior-Posterior  (mm)</span>
<span class="sd">        z   Superior-Inferior   (mm)</span>
<span class="sd">        rx  Pitch               (rad)</span>
<span class="sd">        ry  Roll                (rad)</span>
<span class="sd">        rz  Yaw                 (rad)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">source</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;FSL&quot;</span><span class="p">:</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">params</span><span class="p">[[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]]</span>
    <span class="k">elif</span> <span class="n">source</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;AFNI&quot;</span><span class="p">,</span> <span class="s2">&quot;FSFAST&quot;</span><span class="p">):</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">([</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">6</span><span class="p">)]</span>
        <span class="n">params</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">180.0</span>
    <span class="k">elif</span> <span class="n">source</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;NIPY&quot;</span><span class="p">:</span>
        <span class="n">matrix</span> <span class="o">=</span> <span class="n">to_matrix44</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
        <span class="n">params</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">matrix</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
        <span class="n">params</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">aff2euler</span><span class="p">(</span><span class="n">matrix</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">params</span></div>


<div class="viewcode-block" id="regress_poly"><a class="viewcode-back" href="../../../../mia_processes.bricks.reports.html#mia_processes.bricks.reports.processes.regress_poly">[docs]</a><span class="k">def</span> <span class="nf">regress_poly</span><span class="p">(</span><span class="n">degree</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">remove_mean</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">failure_mode</span><span class="o">=</span><span class="s2">&quot;error&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns data with degree polynomial regressed out.</span>
<span class="sd">    :param bool remove_mean: whether or not demean data (i.e. degree 0),</span>
<span class="sd">    :param int axis: numpy array axes along which regression is performed</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">datashape</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">timepoints</span> <span class="o">=</span> <span class="n">datashape</span><span class="p">[</span><span class="n">axis</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">datashape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">failure_mode</span> <span class="o">!=</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">data</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>

    <span class="c1"># Rearrange all voxel-wise time-series in rows</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">timepoints</span><span class="p">))</span>

    <span class="c1"># Generate design matrix</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">timepoints</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>  <span class="c1"># quick way to calc degree 0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">degree</span><span class="p">):</span>
        <span class="n">polynomial_func</span> <span class="o">=</span> <span class="n">Legendre</span><span class="o">.</span><span class="n">basis</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">value_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">timepoints</span><span class="p">)</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">X</span><span class="p">,</span> <span class="n">polynomial_func</span><span class="p">(</span><span class="n">value_array</span><span class="p">)[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]))</span>

    <span class="n">non_constant_regressors</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>

    <span class="c1"># Calculate coefficients</span>
    <span class="n">betas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">pinv</span><span class="p">(</span><span class="n">X</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

    <span class="c1"># Estimation</span>
    <span class="k">if</span> <span class="n">remove_mean</span><span class="p">:</span>
        <span class="n">datahat</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">betas</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># disregard the first layer of X, which is degree 0</span>
        <span class="n">datahat</span> <span class="o">=</span> <span class="n">X</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">betas</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="o">...</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
    <span class="n">regressed_data</span> <span class="o">=</span> <span class="n">data</span> <span class="o">-</span> <span class="n">datahat</span>

    <span class="c1"># Back to original shape</span>
    <span class="k">return</span> <span class="n">regressed_data</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">datashape</span><span class="p">),</span> <span class="n">non_constant_regressors</span></div>


<div class="viewcode-block" id="rpve"><a class="viewcode-back" href="../../../../mia_processes.bricks.reports.html#mia_processes.bricks.reports.processes.rpve">[docs]</a><span class="k">def</span> <span class="nf">rpve</span><span class="p">(</span><span class="n">pvms</span><span class="p">,</span> <span class="n">seg</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    * | Computes the :abbr:`rPVe (residual partial voluming error)`</span>
<span class="sd">      | of each tissue class.</span>

<span class="sd">    .. math ::</span>
<span class="sd">        \\text{rPVE}^k = \\frac{1}{N} \\left[ \\sum\\limits_{p^k_i \</span>
<span class="sd">\\in [0.5, P_{98}]} p^k_i + \\sum\\limits_{p^k_i \\in [P_{2}, 0.5)} 1 - p^k_i \\right]</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">pvfs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">lid</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">FSL_FAST_LABELS</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
        <span class="k">if</span> <span class="n">lid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">pvmap</span> <span class="o">=</span> <span class="n">pvms</span><span class="p">[</span><span class="n">lid</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">pvmap</span><span class="p">[</span><span class="n">pvmap</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">pvmap</span><span class="p">[</span><span class="n">pvmap</span> <span class="o">&gt;=</span> <span class="mf">1.0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">totalvol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">pvmap</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="n">upth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">pvmap</span><span class="p">[</span><span class="n">pvmap</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">],</span> <span class="mi">98</span><span class="p">)</span>
        <span class="n">loth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">pvmap</span><span class="p">[</span><span class="n">pvmap</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">pvmap</span><span class="p">[</span><span class="n">pvmap</span> <span class="o">&lt;</span> <span class="n">loth</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">pvmap</span><span class="p">[</span><span class="n">pvmap</span> <span class="o">&gt;</span> <span class="n">upth</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">pvfs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">pvmap</span><span class="p">[</span><span class="n">pvmap</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">+</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">pvmap</span><span class="p">[</span><span class="n">pvmap</span> <span class="o">&lt;=</span> <span class="mf">0.5</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="p">)</span> <span class="o">/</span> <span class="n">totalvol</span>
    <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">pvfs</span><span class="o">.</span><span class="n">items</span><span class="p">())}</span></div>


<div class="viewcode-block" id="snr"><a class="viewcode-back" href="../../../../mia_processes.bricks.reports.html#mia_processes.bricks.reports.processes.snr">[docs]</a><span class="k">def</span> <span class="nf">snr</span><span class="p">(</span><span class="n">mu_fg</span><span class="p">,</span> <span class="n">sigma_fg</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the :abbr:`SNR (Signal-to-Noise Ratio)`.</span>
<span class="sd">    The estimation may be provided with only one foreground region in</span>
<span class="sd">    which the noise is computed as follows:</span>
<span class="sd">    .. math::</span>
<span class="sd">        \text{SNR} = \frac{\mu_F}{\sigma_F\sqrt{n/(n-1)}},</span>
<span class="sd">    where :math:`\mu_F` is the mean intensity of the foreground and</span>
<span class="sd">    :math:`\sigma_F` is the standard deviation of the same region.</span>
<span class="sd">    :param float mu_fg: mean of foreground.</span>
<span class="sd">    :param float sigma_fg: standard deviation of foreground.</span>
<span class="sd">    :param int n: number of voxels in foreground mask.</span>
<span class="sd">    :return: the computed SNR</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">mu_fg</span> <span class="o">/</span> <span class="p">(</span><span class="n">sigma_fg</span> <span class="o">*</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">n</span> <span class="o">/</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))))</span></div>


<div class="viewcode-block" id="snr_dietrich"><a class="viewcode-back" href="../../../../mia_processes.bricks.reports.html#mia_processes.bricks.reports.processes.snr_dietrich">[docs]</a><span class="k">def</span> <span class="nf">snr_dietrich</span><span class="p">(</span><span class="n">mu_fg</span><span class="p">,</span> <span class="n">mad_air</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">sigma_air</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the :abbr:`SNR (Signal-to-Noise Ratio)`.</span>

<span class="sd">    This must be an air mask around the head, and it should not contain artifacts.</span>
<span class="sd">    The computation is done following the eq. A.12 of [Dietrich2007]_, which</span>
<span class="sd">    includes a correction factor in the estimation of the standard deviation of</span>
<span class="sd">    air and its Rayleigh distribution:</span>

<span class="sd">    .. math::</span>

<span class="sd">        \text{SNR} = \frac{\mu_F}{\sqrt{\frac{2}{4-\pi}}\,\sigma_\text{air}}.</span>


<span class="sd">    :param float mu_fg: mean of foreground.</span>
<span class="sd">    :param float sigma_air: standard deviation of the air surrounding the head (&quot;hat&quot; mask).</span>

<span class="sd">    :return: the computed SNR for the foreground segmentation</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">mad_air</span> <span class="o">&gt;</span> <span class="mf">1.0</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">DIETRICH_FACTOR</span> <span class="o">*</span> <span class="n">mu_fg</span> <span class="o">/</span> <span class="n">mad_air</span><span class="p">)</span>

    <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">DIETRICH_FACTOR</span> <span class="o">*</span> <span class="n">mu_fg</span> <span class="o">/</span> <span class="n">sigma_air</span><span class="p">)</span> <span class="k">if</span> <span class="n">sigma_air</span> <span class="o">&gt;</span> <span class="mf">1e-3</span> <span class="k">else</span> <span class="o">-</span><span class="mf">1.0</span></div>


<div class="viewcode-block" id="summary_stats"><a class="viewcode-back" href="../../../../mia_processes.bricks.reports.html#mia_processes.bricks.reports.processes.summary_stats">[docs]</a><span class="k">def</span> <span class="nf">summary_stats</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">pvms</span><span class="p">,</span> <span class="n">airmask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">erode</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Estimates the mean, the standard deviation, the 95\%</span>
<span class="sd">    and the 5\% percentiles of each tissue distribution.</span>
<span class="sd">    .. warning ::</span>
<span class="sd">        Sometimes (with datasets that have been partially processed), the air</span>
<span class="sd">        mask will be empty. In those cases, the background stats will be zero</span>
<span class="sd">        for the mean, median, percentiles and kurtosis, the sum of voxels in</span>
<span class="sd">        the other remaining labels for ``n``, and finally the MAD and the</span>
<span class="sd">        :math:`\sigma` will be calculated as:</span>
<span class="sd">        .. math ::</span>
<span class="sd">            \sigma_\text{BG} = \sqrt{\sum \sigma_\text{i}^2}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">statsmodels.robust.scale</span> <span class="kn">import</span> <span class="n">mad</span>

    <span class="c1"># Check type of input masks</span>
    <span class="n">dims</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pvms</span><span class="p">))</span><span class="o">.</span><span class="n">ndim</span>
    <span class="k">if</span> <span class="n">dims</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
        <span class="c1"># If pvms is from FSL FAST, create the bg mask</span>
        <span class="n">stats_pvms</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">img</span><span class="p">)]</span> <span class="o">+</span> <span class="n">pvms</span>
    <span class="k">elif</span> <span class="n">dims</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">stats_pvms</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">pvms</span><span class="p">)</span> <span class="o">-</span> <span class="n">pvms</span><span class="p">,</span> <span class="n">pvms</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
            <span class="s2">&quot;Incorrect image dimensions (</span><span class="si">{0:d}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pvms</span><span class="p">)</span><span class="o">.</span><span class="n">ndim</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">airmask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">stats_pvms</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">airmask</span>

    <span class="n">labels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">FSL_FAST_LABELS</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">stats_pvms</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">([</span><span class="s2">&quot;bg&quot;</span><span class="p">,</span> <span class="s2">&quot;fg&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">))))</span>

    <span class="n">output</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">lid</span> <span class="ow">in</span> <span class="n">labels</span><span class="p">:</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
        <span class="n">mask</span><span class="p">[</span><span class="n">stats_pvms</span><span class="p">[</span><span class="n">lid</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.85</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">erode</span><span class="p">:</span>
            <span class="n">struc</span> <span class="o">=</span> <span class="n">nd</span><span class="o">.</span><span class="n">generate_binary_structure</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">nd</span><span class="o">.</span><span class="n">binary_erosion</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">structure</span><span class="o">=</span><span class="n">struc</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>

        <span class="n">nvox</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">nvox</span> <span class="o">&lt;</span> <span class="mf">1e3</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s1">&#39;calculating summary stats of label &quot;</span><span class="si">%s</span><span class="s1">&quot; in a very small &#39;</span>
                <span class="s2">&quot;mask (</span><span class="si">%d</span><span class="s2"> voxels)&quot;</span><span class="p">,</span>
                <span class="n">k</span><span class="p">,</span>
                <span class="nb">int</span><span class="p">(</span><span class="n">nvox</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="s2">&quot;bg&quot;</span><span class="p">:</span>
                <span class="n">output</span><span class="p">[</span><span class="s2">&quot;bg&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;mean&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                    <span class="s2">&quot;median&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                    <span class="s2">&quot;p95&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                    <span class="s2">&quot;p05&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                    <span class="s2">&quot;k&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                    <span class="s2">&quot;stdv&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                    <span class="s2">&quot;mad&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                    <span class="s2">&quot;n&quot;</span><span class="p">:</span> <span class="n">nvox</span><span class="p">,</span>
                <span class="p">}</span>
                <span class="k">continue</span>
    
        <span class="n">output</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;mean&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">img</span><span class="p">[</span><span class="n">mask</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()),</span>
            <span class="s2">&quot;stdv&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">img</span><span class="p">[</span><span class="n">mask</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()),</span>
            <span class="s2">&quot;median&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">img</span><span class="p">[</span><span class="n">mask</span> <span class="o">==</span> <span class="mi">1</span><span class="p">])),</span>
            <span class="s2">&quot;mad&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">mad</span><span class="p">(</span><span class="n">img</span><span class="p">[</span><span class="n">mask</span> <span class="o">==</span> <span class="mi">1</span><span class="p">])),</span>
            <span class="s2">&quot;p95&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">img</span><span class="p">[</span><span class="n">mask</span> <span class="o">==</span> <span class="mi">1</span><span class="p">],</span> <span class="mi">95</span><span class="p">)),</span>
            <span class="s2">&quot;p05&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">img</span><span class="p">[</span><span class="n">mask</span> <span class="o">==</span> <span class="mi">1</span><span class="p">],</span> <span class="mi">5</span><span class="p">)),</span>
            <span class="s2">&quot;k&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">kurtosis</span><span class="p">(</span><span class="n">img</span><span class="p">[</span><span class="n">mask</span> <span class="o">==</span> <span class="mi">1</span><span class="p">])),</span>
            <span class="s2">&quot;n&quot;</span><span class="p">:</span> <span class="n">nvox</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">return</span> <span class="n">output</span></div>


<div class="viewcode-block" id="volume_fraction"><a class="viewcode-back" href="../../../../mia_processes.bricks.reports.html#mia_processes.bricks.reports.processes.volume_fraction">[docs]</a><span class="k">def</span> <span class="nf">volume_fraction</span><span class="p">(</span><span class="n">pvms</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes the :abbr:`ICV (intracranial volume)` fractions</span>
<span class="sd">    corresponding to the (partial volume maps).</span>
<span class="sd">    .. math ::</span>
<span class="sd">        \text{ICV}^k = \frac{\sum_i p^k_i}{\sum\limits_{x \in X_\text{brain}} 1}</span>
<span class="sd">    :param list pvms: list of :code:`numpy.ndarray` of partial volume maps.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">tissue_vfs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">lid</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">FSL_FAST_LABELS</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
        <span class="k">if</span> <span class="n">lid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">tissue_vfs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">pvms</span><span class="p">[</span><span class="n">lid</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">total</span> <span class="o">+=</span> <span class="n">tissue_vfs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">tissue_vfs</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="n">tissue_vfs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">/=</span> <span class="n">total</span>
    <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">tissue_vfs</span><span class="o">.</span><span class="n">items</span><span class="p">())}</span></div>


<div class="viewcode-block" id="wm2max"><a class="viewcode-back" href="../../../../mia_processes.bricks.reports.html#mia_processes.bricks.reports.processes.wm2max">[docs]</a><span class="k">def</span> <span class="nf">wm2max</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">mu_wm</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the :abbr:`WM2MAX (white-matter-to-max ratio)`,</span>
<span class="sd">    defined as the maximum intensity found in the volume w.r.t. the</span>
<span class="sd">    mean value of the white matter tissue. Values close to 1.0 are</span>
<span class="sd">    better:</span>
<span class="sd">    .. math ::</span>
<span class="sd">        \text{WM2MAX} = \frac{\mu_\text{WM}}{P_{99.95}(X)}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">mu_wm</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="mf">99.95</span><span class="p">))</span></div>


<span class="k">def</span> <span class="nf">_flatten_dict</span><span class="p">(</span><span class="n">indict</span><span class="p">):</span>
    <span class="n">out_qc</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">indict</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">out_qc</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">subk</span><span class="p">,</span> <span class="n">subval</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">subval</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                    <span class="n">out_qc</span><span class="p">[</span><span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">k</span><span class="p">,</span> <span class="n">subk</span><span class="p">])]</span> <span class="o">=</span> <span class="n">subval</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">ssubk</span><span class="p">,</span> <span class="n">ssubval</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">subval</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                        <span class="n">out_qc</span><span class="p">[</span><span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">k</span><span class="p">,</span> <span class="n">subk</span><span class="p">,</span> <span class="n">ssubk</span><span class="p">])]</span> <span class="o">=</span> <span class="n">ssubval</span>
    <span class="k">return</span> <span class="n">out_qc</span>


<span class="k">def</span> <span class="nf">_prepare_mask</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">erode</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">fgmask</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">issubdtype</span><span class="p">(</span><span class="n">fgmask</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">)):</span>
            <span class="n">label</span> <span class="o">=</span> <span class="n">FSL_FAST_LABELS</span><span class="p">[</span><span class="n">label</span><span class="p">]</span>

        <span class="n">fgmask</span><span class="p">[</span><span class="n">fgmask</span> <span class="o">!=</span> <span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">fgmask</span><span class="p">[</span><span class="n">fgmask</span> <span class="o">==</span> <span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fgmask</span><span class="p">[</span><span class="n">fgmask</span> <span class="o">&gt;</span> <span class="mf">0.95</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">fgmask</span><span class="p">[</span><span class="n">fgmask</span> <span class="o">&lt;</span> <span class="mf">1.0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="n">erode</span><span class="p">:</span>
        <span class="c1"># Create a structural element to be used in an opening operation.</span>
        <span class="n">struc</span> <span class="o">=</span> <span class="n">nd</span><span class="o">.</span><span class="n">generate_binary_structure</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="c1"># Perform an opening operation on the background data.</span>
        <span class="n">fgmask</span> <span class="o">=</span> <span class="n">nd</span><span class="o">.</span><span class="n">binary_opening</span><span class="p">(</span><span class="n">fgmask</span><span class="p">,</span> <span class="n">structure</span><span class="o">=</span><span class="n">struc</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">fgmask</span>


<span class="k">def</span> <span class="nf">_robust_zscore</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">data</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_2d</span><span class="p">(</span>
        <span class="n">data</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">)</span><span class="o">.</span><span class="n">T</span>


<span class="k">def</span> <span class="nf">_AR_est_YW</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">rxx</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Retrieve AR coefficients while dropping the sig_sq return value&quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">nitime.algorithms</span> <span class="kn">import</span> <span class="n">AR_est_YW</span>

    <span class="k">return</span> <span class="n">AR_est_YW</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">rxx</span><span class="o">=</span><span class="n">rxx</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>

      </div>
      <div class="bottomnav" role="navigation" aria-label="bottom navigation">
      
        <p>
        <a class="uplink" href="../../../../index.html">Contents</a>
        </p>

      </div>

    <div class="footer" role="contentinfo">
        &#169; Copyright 2019, populse.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 3.2.1.
    </div>
  </body>
</html>