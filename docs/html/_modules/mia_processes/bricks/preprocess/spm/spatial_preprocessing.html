
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>mia_processes.bricks.preprocess.spm.spatial_preprocessing &#8212; mia_processes 2.2.1-dev+56496d0 documentation</title>
    <link rel="stylesheet" href="../../../../../_static/haiku.css" type="text/css" />
    <link rel="stylesheet" href="../../../../../_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="../../../../../" src="../../../../../_static/documentation_options.js"></script>
    <script src="../../../../../_static/jquery.js"></script>
    <script src="../../../../../_static/underscore.js"></script>
    <script src="../../../../../_static/doctools.js"></script>
    <script src="../../../../../_static/language_data.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../search.html" /> 
  </head><body>
      <div class="header" role="banner"><h1 class="heading"><a href="../../../../../index.html">
          <span>mia_processes 2.2.1-dev+56496d0 documentation</span></a></h1>
        <h2 class="heading"><span>mia_processes.bricks.preprocess.spm.spatial_preprocessing</span></h2>
      </div>
      <div class="topnav" role="navigation" aria-label="top navigation">
      
        <p>
        <a class="uplink" href="../../../../../index.html">Contents</a>
        </p>

      </div>
      <div class="content" role="main">
        
        
  <h1>Source code for mia_processes.bricks.preprocess.spm.spatial_preprocessing</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>

<span class="sd">&quot;&quot;&quot;The spm preprocess library of the mia_processes package.</span>

<span class="sd">The purpose of this module is to customise the main spm preprocessing bricks</span>
<span class="sd">provided by nipype and to correct some things that do not work directly in</span>
<span class="sd">populse_mia.</span>

<span class="sd">:Contains:</span>
<span class="sd">    :Class:</span>
<span class="sd">        - Coregister</span>
<span class="sd">        - GM_WM_Normalize</span>
<span class="sd">        - NewSegment</span>
<span class="sd">        - Normalize12</span>
<span class="sd">        - Realign</span>
<span class="sd">        - SliceTiming</span>
<span class="sd">        - Smooth</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="c1">##########################################################################</span>
<span class="c1"># mia_processes - Copyright (C) IRMaGe/CEA, 2018</span>
<span class="c1"># Distributed under the terms of the CeCILL license, as published by</span>
<span class="c1"># the CEA-CNRS-INRIA. Refer to the LICENSE file or to</span>
<span class="c1"># http://www.cecill.info/licences/Licence_CeCILL_V2.1-en.html</span>
<span class="c1"># for details.</span>
<span class="c1">##########################################################################</span>

<span class="c1"># Other imports</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="kn">import</span> <span class="nn">nibabel</span> <span class="k">as</span> <span class="nn">nib</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="c1"># nipype imports</span>
<span class="kn">from</span> <span class="nn">nipype.interfaces.base</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">File</span><span class="p">,</span>
    <span class="n">InputMultiPath</span><span class="p">,</span>
    <span class="n">OutputMultiPath</span><span class="p">,</span>
    <span class="n">TraitListObject</span><span class="p">,</span>
    <span class="n">traits</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">nipype.interfaces.spm.base</span> <span class="kn">import</span> <span class="n">ImageFileSPM</span>

<span class="c1"># populse_mia imports</span>
<span class="kn">from</span> <span class="nn">populse_mia.data_manager.project</span> <span class="kn">import</span> <span class="n">COLLECTION_CURRENT</span>
<span class="kn">from</span> <span class="nn">populse_mia.software_properties</span> <span class="kn">import</span> <span class="n">Config</span>
<span class="kn">from</span> <span class="nn">populse_mia.user_interface.pipeline_manager.process_mia</span> <span class="kn">import</span> <span class="n">ProcessMIA</span>

<span class="c1"># soma-base import</span>
<span class="kn">from</span> <span class="nn">soma.qt_gui.qt_backend.Qt</span> <span class="kn">import</span> <span class="n">QMessageBox</span>
<span class="kn">from</span> <span class="nn">traits.api</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Bool</span><span class="p">,</span>
    <span class="n">Either</span><span class="p">,</span>
    <span class="n">Enum</span><span class="p">,</span>
    <span class="n">Float</span><span class="p">,</span>
    <span class="n">Int</span><span class="p">,</span>
    <span class="n">List</span><span class="p">,</span>
    <span class="n">Range</span><span class="p">,</span>
    <span class="n">String</span><span class="p">,</span>
    <span class="n">Tuple</span><span class="p">,</span>
    <span class="n">Undefined</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># mia_processes import</span>
<span class="kn">from</span> <span class="nn">mia_processes.utils</span> <span class="kn">import</span> <span class="n">get_dbFieldValue</span><span class="p">,</span> <span class="n">set_dbFieldValue</span>


<div class="viewcode-block" id="Coregister"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.spm.html#mia_processes.bricks.preprocess.spm.spatial_preprocessing.Coregister">[docs]</a><span class="k">class</span> <span class="nc">Coregister</span><span class="p">(</span><span class="n">ProcessMIA</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    *Align together scans of different modalities*</span>

<span class="sd">    Please, see the complete documention for the</span>
<span class="sd">    `Coregister brick in the populse.mia_processes web site</span>
<span class="sd">    &lt;https://populse.github.io/mia_processes/html/documentation/bricks/preprocess/spm/Coregister.html&gt;`_</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Coregister.__init__"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.spm.html#mia_processes.bricks.preprocess.spm.spatial_preprocessing.Coregister.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the attributes initialisation/instantiation.</span>

<span class="sd">        The input and output plugs are defined here. The special</span>
<span class="sd">        &#39;self.requirement&#39; attribute (optional) is used to define the</span>
<span class="sd">        third-party products necessary for the running of the brick.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Initialisation of the objects needed for the launch of the brick</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Coregister</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1"># Third party softwares required for the execution of the brick</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requirement</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;spm&quot;</span><span class="p">,</span> <span class="s2">&quot;nipype&quot;</span><span class="p">]</span>

        <span class="c1"># Inputs description</span>
        <span class="n">target_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;The reference file to register to. An existing,&quot;</span>
            <span class="s2">&quot; uncompressed file (valid extensions:&quot;</span>
            <span class="s2">&quot; [.img, .nii, .hdr]).&quot;</span>
        <span class="p">)</span>
        <span class="n">source_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;File to register to target image. A list of items which&quot;</span>
            <span class="s2">&quot; are an existing, uncompressed file (valid extensions:&quot;</span>
            <span class="s2">&quot; [.img, .nii, .hdr]).&quot;</span>
        <span class="p">)</span>
        <span class="n">apply_to_files_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Files to apply transformation to (a list of&quot;</span>
            <span class="s2">&quot; items which are an existing file name, (valid&quot;</span>
            <span class="s2">&quot; extensions: [.img, .nii, .hdr]).&quot;</span>
        <span class="p">)</span>
        <span class="n">jobtype_desc</span> <span class="o">=</span> <span class="s2">&quot;One of &#39;estwrite&#39; or &#39;estimate&#39; or &#39;write&#39;.&quot;</span>
        <span class="n">cost_function_desc</span> <span class="o">=</span> <span class="s2">&quot;One of &#39;mi&#39; or &#39;nmi&#39; or &#39;ecc&#39; or &#39;ncc&#39;.&quot;</span>
        <span class="n">separation_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Sampling separation in mm (a list of items which&quot;</span> <span class="s2">&quot; are a float).&quot;</span>
        <span class="p">)</span>
        <span class="n">tolerance_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;The acceptable tolerance for each of 12 params (a&quot;</span>
            <span class="s2">&quot; list of items which are a float).&quot;</span>
        <span class="p">)</span>
        <span class="n">fwhm_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Gaussian smoothing kernel width (mm) applied to the&quot;</span>
            <span class="s2">&quot; 256*256 joint histogram (a list of 2 items which are&quot;</span>
            <span class="s2">&quot; a float).&quot;</span>
        <span class="p">)</span>
        <span class="n">write_interp_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;0 &lt;= a long integer &lt;= 7. The method by which the&quot;</span>
            <span class="s2">&quot; images are sampled when being written in a&quot;</span>
            <span class="s2">&quot; different space.&quot;</span>
        <span class="p">)</span>
        <span class="n">write_wrap_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;A list of from 3 to 3 items which are an integer&quot;</span>
            <span class="s2">&quot; (int or long).&quot;</span>
        <span class="p">)</span>
        <span class="n">write_mask_desc</span> <span class="o">=</span> <span class="s2">&quot;Mask output image (a boolean)&quot;</span>
        <span class="n">out_prefix_desc</span> <span class="o">=</span> <span class="s2">&quot;Coregisterd output prefix (a string).&quot;</span>

        <span class="c1"># Outputs description</span>
        <span class="n">coregistered_source_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Coregistered source files, corresponding &quot;</span>
            <span class="s2">&quot;to &#39;source&#39; images, (a pathlike object &quot;</span>
            <span class="s2">&quot;or string representing a file, or a list &quot;</span>
            <span class="s2">&quot;of pathlike objects or strings &quot;</span>
            <span class="s2">&quot;representing a file).&quot;</span>
        <span class="p">)</span>
        <span class="n">coregistered_files_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Coregistered other files, corresponding&quot;</span>
            <span class="s2">&quot; to &#39;apply_to_files&#39;, (a pathlike object &quot;</span>
            <span class="s2">&quot;or string representing a file, or a list &quot;</span>
            <span class="s2">&quot;of pathlike objects or strings &quot;</span>
            <span class="s2">&quot;representing a file).&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Inputs traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;target&quot;</span><span class="p">,</span>
            <span class="n">ImageFileSPM</span><span class="p">(</span>
                <span class="n">copyfile</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">target_desc</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;source&quot;</span><span class="p">,</span>
            <span class="n">InputMultiPath</span><span class="p">(</span>
                <span class="n">Either</span><span class="p">(</span><span class="n">ImageFileSPM</span><span class="p">(),</span> <span class="n">Undefined</span><span class="p">),</span>
                <span class="n">copyfile</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">source_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;apply_to_files&quot;</span><span class="p">,</span>
            <span class="n">InputMultiPath</span><span class="p">(</span>
                <span class="n">Either</span><span class="p">(</span><span class="n">ImageFileSPM</span><span class="p">(),</span> <span class="n">Undefined</span><span class="p">),</span>
                <span class="n">copyfile</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">apply_to_files_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;jobtype&quot;</span><span class="p">,</span>
            <span class="n">Enum</span><span class="p">(</span>
                <span class="s2">&quot;estimate&quot;</span><span class="p">,</span>
                <span class="s2">&quot;estwrite&quot;</span><span class="p">,</span>
                <span class="s2">&quot;write&quot;</span><span class="p">,</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">jobtype_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;cost_function&quot;</span><span class="p">,</span>
            <span class="n">Enum</span><span class="p">(</span>
                <span class="s2">&quot;nmi&quot;</span><span class="p">,</span>
                <span class="s2">&quot;mi&quot;</span><span class="p">,</span>
                <span class="s2">&quot;ecc&quot;</span><span class="p">,</span>
                <span class="s2">&quot;ncc&quot;</span><span class="p">,</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">cost_function_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;separation&quot;</span><span class="p">,</span>
            <span class="n">List</span><span class="p">(</span>
                <span class="n">value</span><span class="o">=</span><span class="p">[</span><span class="mf">4.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">],</span>
                <span class="n">trait</span><span class="o">=</span><span class="n">Range</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="kc">None</span><span class="p">),</span>
                <span class="n">minlen</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">maxlen</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">separation_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;tolerance&quot;</span><span class="p">,</span>
            <span class="n">List</span><span class="p">(</span>
                <span class="n">value</span><span class="o">=</span><span class="p">[</span>
                    <span class="mf">0.02</span><span class="p">,</span>
                    <span class="mf">0.02</span><span class="p">,</span>
                    <span class="mf">0.02</span><span class="p">,</span>
                    <span class="mf">0.001</span><span class="p">,</span>
                    <span class="mf">0.001</span><span class="p">,</span>
                    <span class="mf">0.001</span><span class="p">,</span>
                    <span class="mf">0.01</span><span class="p">,</span>
                    <span class="mf">0.01</span><span class="p">,</span>
                    <span class="mf">0.01</span><span class="p">,</span>
                    <span class="mf">0.001</span><span class="p">,</span>
                    <span class="mf">0.001</span><span class="p">,</span>
                    <span class="mf">0.001</span><span class="p">,</span>
                <span class="p">],</span>
                <span class="n">trait</span><span class="o">=</span><span class="n">Range</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="kc">None</span><span class="p">),</span>
                <span class="n">minlen</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
                <span class="n">maxlen</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">tolerance_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;fwhm&quot;</span><span class="p">,</span>
            <span class="n">List</span><span class="p">(</span>
                <span class="n">value</span><span class="o">=</span><span class="p">[</span><span class="mf">7.0</span><span class="p">,</span> <span class="mf">7.0</span><span class="p">],</span>
                <span class="n">trait</span><span class="o">=</span><span class="n">Range</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="kc">None</span><span class="p">),</span>
                <span class="n">minlen</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                <span class="n">maxlen</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">fwhm_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;write_interp&quot;</span><span class="p">,</span>
            <span class="n">Range</span><span class="p">(</span>
                <span class="n">value</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
                <span class="n">low</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">high</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">write_interp_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;write_wrap&quot;</span><span class="p">,</span>
            <span class="n">List</span><span class="p">(</span>
                <span class="n">value</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                <span class="n">trait</span><span class="o">=</span><span class="n">Range</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
                <span class="n">minlen</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                <span class="n">maxlen</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">write_wrap_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;write_mask&quot;</span><span class="p">,</span>
            <span class="n">Bool</span><span class="p">(</span>
                <span class="n">default_value</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">write_mask_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;out_prefix&quot;</span><span class="p">,</span>
            <span class="n">String</span><span class="p">(</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">out_prefix_desc</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># Output traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;coregistered_source&quot;</span><span class="p">,</span>
            <span class="n">OutputMultiPath</span><span class="p">(</span>
                <span class="n">ImageFileSPM</span><span class="p">(),</span> <span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">coregistered_source_desc</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;coregistered_files&quot;</span><span class="p">,</span>
            <span class="n">OutputMultiPath</span><span class="p">(</span>
                <span class="n">ImageFileSPM</span><span class="p">(),</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">coregistered_files_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">init_default_traits</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_process</span><span class="p">(</span><span class="s2">&quot;nipype.interfaces.spm.Coregister&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Coregister.list_outputs"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.spm.html#mia_processes.bricks.preprocess.spm.spatial_preprocessing.Coregister.list_outputs">[docs]</a>    <span class="k">def</span> <span class="nf">list_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_plugged</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the initialisation step of the brick.</span>

<span class="sd">        The main objective of this method is to produce the outputs of the</span>
<span class="sd">        bricks (self.outputs) and the associated tags (self.inheritance_dic),</span>
<span class="sd">        if defined here. In order not to include an output in the database,</span>
<span class="sd">        this output must be a value of the optional key &#39;notInDb&#39; of the</span>
<span class="sd">        self.outputs dictionary. To work properly this method must return</span>
<span class="sd">        self.make_initResult() object.</span>

<span class="sd">        :param is_plugged: the state, linked or not, of the plugs.</span>
<span class="sd">        :returns: a dictionary with requirement, outputs and inheritance_dict.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Using the inheritance to ProcessMIA class, list_outputs method</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Coregister</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">list_outputs</span><span class="p">()</span>

        <span class="c1"># Outputs definition and tags inheritance (optional)</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">target</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span> <span class="o">!=</span> <span class="n">Undefined</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">!=</span> <span class="p">[</span><span class="n">Undefined</span><span class="p">]</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobtype</span>
        <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">jobtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobtype</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_to_files</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_to_files</span> <span class="o">!=</span> <span class="p">[</span><span class="n">Undefined</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">apply_to_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_to_files</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_prefix</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">out_prefix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_prefix</span>

            <span class="c1"># The management of self.process.output_directory could be</span>
            <span class="c1"># delegated to the</span>
            <span class="c1"># populse_mia.user_interface.pipeline_manager.process_mia</span>
            <span class="c1"># module. We can&#39;t do it at the moment because the</span>
            <span class="c1"># sync_process_output_traits() of the</span>
            <span class="c1"># capsul/process/nipype_process module raises an exception</span>
            <span class="c1"># in nipype if the mandatory parameters are not yet defined!</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">output_directory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No output_directory was found...!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span>
                <span class="s2">&quot;coregistered_source&quot;</span>
            <span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">_coregistered_source</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span>
                <span class="s2">&quot;coregistered_files&quot;</span>
            <span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">_coregistered_files</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">:</span>
            <span class="n">out_coregsource</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">out_coregfiles</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;coregistered_source&quot;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                        <span class="n">val</span> <span class="o">=</span> <span class="p">[</span><span class="n">val</span><span class="p">]</span>

                    <span class="k">for</span> <span class="n">in_val</span><span class="p">,</span> <span class="n">out_val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
                        <span class="n">pathOval</span><span class="p">,</span> <span class="n">fileOval</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">out_val</span><span class="p">)</span>
                        <span class="n">_</span><span class="p">,</span> <span class="n">fileIval</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">in_val</span><span class="p">)</span>

                        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobtype</span> <span class="o">==</span> <span class="s2">&quot;estimate&quot;</span><span class="p">:</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_prefix</span><span class="p">:</span>
                                <span class="c1"># fmt: off</span>
                                <span class="n">fileOvalNoPref</span> <span class="o">=</span> <span class="n">fileOval</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span>
                                                          <span class="bp">self</span><span class="o">.</span><span class="n">out_prefix</span><span class="p">):]</span>
                                <span class="c1"># fmt: on</span>

                            <span class="k">else</span><span class="p">:</span>
                                <span class="c1"># fmt: off</span>
                                <span class="n">fileOvalNoPref</span> <span class="o">=</span> <span class="n">fileOval</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="s2">&quot;r&quot;</span><span class="p">):]</span>
                                <span class="c1"># fmt: on</span>

                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">fileOvalNoPref</span> <span class="o">=</span> <span class="n">fileOval</span>

                        <span class="k">if</span> <span class="n">fileOvalNoPref</span> <span class="o">==</span> <span class="n">fileIval</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">inheritance_dict</span><span class="p">[</span><span class="n">out_val</span><span class="p">]</span> <span class="o">=</span> <span class="n">in_val</span>

                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobtype</span> <span class="o">==</span> <span class="s2">&quot;estwrite&quot;</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">inheritance_dict</span><span class="p">[</span>
                                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pathOval</span><span class="p">,</span> <span class="n">fileOvalNoPref</span><span class="p">)</span>
                                <span class="p">]</span> <span class="o">=</span> <span class="n">in_val</span>
                                <span class="n">out_coregsource</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out_val</span><span class="p">)</span>
                                <span class="n">out_coregsource</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pathOval</span><span class="p">,</span> <span class="n">fileOvalNoPref</span><span class="p">)</span>
                                <span class="p">)</span>

                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;coregistered_files&quot;</span> <span class="ow">and</span> <span class="n">val</span> <span class="o">!=</span> <span class="n">Undefined</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                        <span class="n">val</span> <span class="o">=</span> <span class="p">[</span><span class="n">val</span><span class="p">]</span>

                    <span class="k">for</span> <span class="n">in_val</span><span class="p">,</span> <span class="n">out_val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">apply_to_files</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
                        <span class="n">pathOval</span><span class="p">,</span> <span class="n">fileOval</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">out_val</span><span class="p">)</span>
                        <span class="n">_</span><span class="p">,</span> <span class="n">fileIval</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">in_val</span><span class="p">)</span>

                        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobtype</span> <span class="o">==</span> <span class="s2">&quot;estimate&quot;</span><span class="p">:</span>
                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_prefix</span><span class="p">:</span>
                                <span class="c1"># fmt: off</span>
                                <span class="n">fileOvalNoPref</span> <span class="o">=</span> <span class="n">fileOval</span><span class="p">[</span>
                                    <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">out_prefix</span><span class="p">):]</span>
                                <span class="c1"># fmt: on</span>

                            <span class="k">else</span><span class="p">:</span>
                                <span class="c1"># fmt: off</span>
                                <span class="n">fileOvalNoPref</span> <span class="o">=</span> <span class="n">fileOval</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="s2">&quot;r&quot;</span><span class="p">):]</span>
                                <span class="c1"># fmt: on</span>

                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">fileOvalNoPref</span> <span class="o">=</span> <span class="n">fileOval</span>

                        <span class="k">if</span> <span class="n">fileOvalNoPref</span> <span class="o">==</span> <span class="n">fileIval</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">inheritance_dict</span><span class="p">[</span><span class="n">out_val</span><span class="p">]</span> <span class="o">=</span> <span class="n">in_val</span>

                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobtype</span> <span class="o">==</span> <span class="s2">&quot;estwrite&quot;</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">inheritance_dict</span><span class="p">[</span>
                                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pathOval</span><span class="p">,</span> <span class="n">fileOvalNoPref</span><span class="p">)</span>
                                <span class="p">]</span> <span class="o">=</span> <span class="n">in_val</span>
                                <span class="n">out_coregfiles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out_val</span><span class="p">)</span>
                                <span class="n">out_coregfiles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pathOval</span><span class="p">,</span> <span class="n">fileOvalNoPref</span><span class="p">)</span>
                                <span class="p">)</span>

            <span class="k">if</span> <span class="n">out_coregsource</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;coregistered_source&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">out_coregsource</span>

            <span class="k">if</span> <span class="n">out_coregfiles</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;coregistered_files&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">out_coregfiles</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">out_coregfiles</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">out_coregfiles</span> <span class="o">=</span> <span class="p">[</span><span class="n">out_coregfiles</span><span class="p">]</span>

                <span class="c1"># FIXME: In the latest version of mia, indexing of the</span>
                <span class="c1">#        database with particular tags defined in the</span>
                <span class="c1">#        processes is done only at the end of the</span>
                <span class="c1">#        initialisation of the whole pipeline. So we</span>
                <span class="c1">#        cannot use the value of these tags in other</span>
                <span class="c1">#        processes of the pipeline at the time of</span>
                <span class="c1">#        initialisation (see populse_mia #290). Until</span>
                <span class="c1">#        better we use a quick and dirty hack with the</span>
                <span class="c1">#        set_dbFieldValue() function !</span>
                <span class="k">for</span> <span class="n">in_val</span><span class="p">,</span> <span class="n">out_val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">apply_to_files</span><span class="p">,</span> <span class="n">out_coregfiles</span>
                <span class="p">):</span>
                    <span class="n">tag_to_add</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                    <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;RepetitionTime&quot;</span>
                    <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;field_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;float&quot;</span>
                    <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="s2">&quot;The period of time &quot;</span>
                        <span class="s2">&quot;in msec between the &quot;</span>
                        <span class="s2">&quot;beginning of a pulse &quot;</span>
                        <span class="s2">&quot;sequence and the &quot;</span>
                        <span class="s2">&quot;beginning of the &quot;</span>
                        <span class="s2">&quot;succeeding pulse &quot;</span>
                        <span class="s2">&quot;sequence&quot;</span>
                    <span class="p">)</span>
                    <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;visibility&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;origin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;user&quot;</span>
                    <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;unit&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;ms&quot;</span>
                    <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;default_value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_dbFieldValue</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="n">in_val</span><span class="p">,</span> <span class="s2">&quot;RepetitionTime&quot;</span>
                    <span class="p">)</span>

                    <span class="k">if</span> <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">set_dbFieldValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="n">out_val</span><span class="p">,</span> <span class="n">tag_to_add</span><span class="p">)</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span>
                            <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Coregister:</span><span class="se">\n</span><span class="s2"> the &#39;RepetitionTime&#39; tag could &quot;</span>
                            <span class="s2">&quot;not be added to the database for the &#39;</span><span class="si">{}</span><span class="s2">&#39; &quot;</span>
                            <span class="s2">&quot;parameter. This can lead to a subsequent issue &quot;</span>
                            <span class="s2">&quot;during initialization!!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">out_val</span><span class="p">)</span>
                        <span class="p">)</span>

                    <span class="n">tag_to_add</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                    <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="s2">&quot;Dataset dimensions &quot;</span> <span class="s2">&quot;(Count, X,Y,Z,T...)&quot;</span>
                    <span class="p">)</span>
                    <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;field_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;int&quot;</span>
                    <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="s2">&quot;data array dimensions&quot;</span> <span class="s2">&quot; (from Nifti header)&quot;</span>
                    <span class="p">)</span>
                    <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;visibility&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;origin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;user&quot;</span>
                    <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;unit&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;default_value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_dbFieldValue</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span>
                        <span class="n">in_val</span><span class="p">,</span>
                        <span class="p">(</span><span class="s2">&quot;Dataset dimensions &quot;</span> <span class="s2">&quot;(Count, X,Y,Z,T...)&quot;</span><span class="p">),</span>
                    <span class="p">)</span>

                    <span class="k">if</span> <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">set_dbFieldValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="n">out_val</span><span class="p">,</span> <span class="n">tag_to_add</span><span class="p">)</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span>
                            <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Coregister:</span><span class="se">\n</span><span class="s2">The &#39;Dataset dimensions (Count, &quot;</span>
                            <span class="s2">&quot;X,Y,Z,T...)&#39; tag could not be added to the &quot;</span>
                            <span class="s2">&quot;database for the &#39;</span><span class="si">{}</span><span class="s2">&#39; parameter. This can lead to&quot;</span>
                            <span class="s2">&quot; a subsequent issue during &quot;</span>
                            <span class="s2">&quot;initialization!!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">out_val</span><span class="p">)</span>
                        <span class="p">)</span>

                    <span class="n">tag_to_add</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                    <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;PatientName&quot;</span>
                    <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;field_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;string&quot;</span>
                    <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                    <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;visibility&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;origin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;user&quot;</span>
                    <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;unit&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;default_value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_dbFieldValue</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="n">in_val</span><span class="p">,</span> <span class="s2">&quot;PatientName&quot;</span>
                    <span class="p">)</span>

                    <span class="k">if</span> <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">set_dbFieldValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="n">out_val</span><span class="p">,</span> <span class="n">tag_to_add</span><span class="p">)</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span>
                            <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Coregister:</span><span class="se">\n</span><span class="s2">The &#39;PatientName&#39; tag could not &quot;</span>
                            <span class="s2">&quot;be added to the database for the &#39;</span><span class="si">{}</span><span class="s2">&#39; &quot;</span>
                            <span class="s2">&quot;parameter. This can lead to a subsequent &quot;</span>
                            <span class="s2">&quot;issue during &quot;</span>
                            <span class="s2">&quot;initialization!!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">out_val</span><span class="p">)</span>
                        <span class="p">)</span>

                    <span class="n">age</span> <span class="o">=</span> <span class="n">get_dbFieldValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="n">in_val</span><span class="p">,</span> <span class="s2">&quot;Age&quot;</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">age</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">tag_to_add</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Age&quot;</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;field_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;int&quot;</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;visibility&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;origin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;user&quot;</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;unit&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;default_value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">age</span>
                        <span class="n">set_dbFieldValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="n">out_val</span><span class="p">,</span> <span class="n">tag_to_add</span><span class="p">)</span>

                    <span class="n">pathology</span> <span class="o">=</span> <span class="n">get_dbFieldValue</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="n">in_val</span><span class="p">,</span> <span class="s2">&quot;Pathology&quot;</span>
                    <span class="p">)</span>

                    <span class="k">if</span> <span class="n">pathology</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">tag_to_add</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Pathology&quot;</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;field_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;string&quot;</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;visibility&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;origin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;user&quot;</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;unit&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;default_value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pathology</span>
                        <span class="n">set_dbFieldValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="n">out_val</span><span class="p">,</span> <span class="n">tag_to_add</span><span class="p">)</span>

        <span class="c1"># Return the requirement, outputs and inheritance_dict</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_initResult</span><span class="p">()</span></div>

<div class="viewcode-block" id="Coregister.run_process_mia"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.spm.html#mia_processes.bricks.preprocess.spm.spatial_preprocessing.Coregister.run_process_mia">[docs]</a>    <span class="k">def</span> <span class="nf">run_process_mia</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the process launch step of the brick.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Coregister</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">run_process_mia</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">jobtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobtype</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_to_files</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_to_files</span> <span class="o">!=</span> <span class="p">[</span><span class="n">Undefined</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">apply_to_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_to_files</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_prefix</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">out_prefix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_prefix</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">cost_function</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cost_function</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">separation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">separation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">tolerance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tolerance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">fwhm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fwhm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">write_interp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_interp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">write_wrap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_wrap</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">write_mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_mask</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">configuration_dict</span><span class="o">=</span><span class="p">{})</span></div></div>


<div class="viewcode-block" id="GM_WM_Normalize"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.spm.html#mia_processes.bricks.preprocess.spm.spatial_preprocessing.GM_WM_Normalize">[docs]</a><span class="k">class</span> <span class="nc">GM_WM_Normalize</span><span class="p">(</span><span class="n">ProcessMIA</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    *Normalisation of the grey and/or white matter map(s)*</span>

<span class="sd">    Please, see the complete documention for the</span>
<span class="sd">    `GM_WM_Normalize brick in the populse.mia_processes web site</span>
<span class="sd">    &lt;https://populse.github.io/mia_processes/html/documentation/bricks/preprocess/spm/GM_WM_Normalize.html&gt;`_</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="GM_WM_Normalize.__init__"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.spm.html#mia_processes.bricks.preprocess.spm.spatial_preprocessing.GM_WM_Normalize.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the attributes initialisation / instantiation.</span>

<span class="sd">        The input and output plugs are defined here. The special</span>
<span class="sd">        &#39;self.requirement&#39; attribute (optional) is used to define the</span>
<span class="sd">        third-party products necessary for the running of the brick.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Initialisation of the objects needed for the launch of the brick</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">GM_WM_Normalize</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1"># Third party softwares required for the execution of the brick</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requirement</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;spm&quot;</span><span class="p">,</span> <span class="s2">&quot;nipype&quot;</span><span class="p">]</span>

        <span class="c1"># Inputs description</span>
        <span class="n">deformation_file_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;File y_*.nii containing 3 deformation fields &quot;</span>
            <span class="s2">&quot;for the deformation in x, y and z dimension &quot;</span>
            <span class="s2">&quot;(an uncompressed file; valid extensions in &quot;</span>
            <span class="s2">&quot;[.img, .nii, .hdr]).&quot;</span>
        <span class="p">)</span>
        <span class="n">apply_to_files_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Files to apply transformation to. A list of &quot;</span>
            <span class="s2">&quot;items which are an existing, uncompressed file &quot;</span>
            <span class="s2">&quot;(valid extensions: [.img, .nii, .hdr]).&quot;</span>
        <span class="p">)</span>

        <span class="n">in_filter_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s1">&#39;One of &quot;GM&quot; (gray matter) or &quot;WM&quot; (white matter) or &#39;</span>
            <span class="s1">&#39;&quot;GM &amp; WM&quot; (uses GM and WM; 2 files) or &quot;GM + WM&quot; &#39;</span>
            <span class="s2">&quot;(makes GM + WM, then uses the result; 1 file).&quot;</span>
        <span class="p">)</span>

        <span class="n">write_bounding_box_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;The bounding box (in mm) of the volume &quot;</span>
            <span class="s2">&quot;which is to be written (a list of 2 items, &quot;</span>
            <span class="s2">&quot;which are a list of items, which are a &quot;</span>
            <span class="s2">&quot;float.&quot;</span>
        <span class="p">)</span>
        <span class="n">write_voxel_sizes_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;The voxel sizes (x, y &amp; z, in mm) of the &quot;</span>
            <span class="s2">&quot;written normalised images (a list of 3 &quot;</span>
            <span class="s2">&quot;items, which are a float).&quot;</span>
        <span class="p">)</span>
        <span class="n">write_interp_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Degree of b-spline used for interpolation &quot;</span>
            <span class="s2">&quot;(0 &lt;= a long integer &lt;= 7; 1 is OK for PET, &quot;</span>
            <span class="s2">&quot;realigned fMRI, or segmentations).&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Outputs description</span>
        <span class="n">normalized_files_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Normalised files (a pathlike object or &quot;</span>
            <span class="s2">&quot;string representing a file, or a list of &quot;</span>
            <span class="s2">&quot;pathlike objects or strings representing a &quot;</span>
            <span class="s2">&quot;file).&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Inputs traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;deformation_file&quot;</span><span class="p">,</span>
            <span class="n">ImageFileSPM</span><span class="p">(</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">deformation_file_desc</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;apply_to_files&quot;</span><span class="p">,</span>
            <span class="n">InputMultiPath</span><span class="p">(</span>
                <span class="n">traits</span><span class="o">.</span><span class="n">Either</span><span class="p">(</span>
                    <span class="n">ImageFileSPM</span><span class="p">(),</span> <span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">ImageFileSPM</span><span class="p">()),</span> <span class="n">Undefined</span>
                <span class="p">),</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">apply_to_files_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;in_filter&quot;</span><span class="p">,</span>
            <span class="n">Enum</span><span class="p">(</span>
                <span class="s2">&quot;GM&quot;</span><span class="p">,</span>
                <span class="s2">&quot;WM&quot;</span><span class="p">,</span>
                <span class="s2">&quot;GM &amp; WM&quot;</span><span class="p">,</span>
                <span class="s2">&quot;GM + WM&quot;</span><span class="p">,</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">in_filter_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;write_bounding_box&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">(</span>
                <span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">traits</span><span class="o">.</span><span class="n">Float</span><span class="p">()),</span>
                <span class="n">value</span><span class="o">=</span><span class="p">[[</span><span class="o">-</span><span class="mi">78</span><span class="p">,</span> <span class="o">-</span><span class="mi">112</span><span class="p">,</span> <span class="o">-</span><span class="mi">50</span><span class="p">],</span> <span class="p">[</span><span class="mi">78</span><span class="p">,</span> <span class="mi">76</span><span class="p">,</span> <span class="mi">85</span><span class="p">]],</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">write_bounding_box_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;write_voxel_sizes&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">(</span>
                <span class="n">traits</span><span class="o">.</span><span class="n">Float</span><span class="p">(),</span>
                <span class="n">value</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">write_voxel_sizes_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;write_interp&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">Range</span><span class="p">(</span>
                <span class="n">value</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">low</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">high</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">write_interp_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;files&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">(</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">userlevel</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;internal parameter&quot;</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># Outputs traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;normalized_files&quot;</span><span class="p">,</span>
            <span class="n">OutputMultiPath</span><span class="p">(</span>
                <span class="n">File</span><span class="p">(),</span> <span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">normalized_files_desc</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">init_default_traits</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_process</span><span class="p">(</span><span class="s2">&quot;nipype.interfaces.spm.Normalize12&quot;</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_namesFilter</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Filtering of apply_to_files input parameter for GM, WM, etc.</span>

<span class="sd">        :returns: from the apply_to_files input parameter, returns the selected</span>
<span class="sd">                  mask(s).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">files</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">runFlag</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">file_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_to_files</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">list</span><span class="p">,</span> <span class="n">TraitListObject</span><span class="p">]:</span>
                    <span class="n">file_name</span> <span class="o">=</span> <span class="n">file_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_filter</span> <span class="o">==</span> <span class="s2">&quot;GM&quot;</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
                <span class="p">)[:</span><span class="mi">2</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;c1&quot;</span><span class="p">]:</span>
                    <span class="n">files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>

                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_filter</span> <span class="o">==</span> <span class="s2">&quot;WM&quot;</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
                <span class="p">)[:</span><span class="mi">2</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;c2&quot;</span><span class="p">]:</span>
                    <span class="n">files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>

                <span class="k">elif</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">in_filter</span> <span class="o">==</span> <span class="s2">&quot;GM &amp; WM&quot;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_filter</span> <span class="o">==</span> <span class="s2">&quot;GM + WM&quot;</span>
                <span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">file_name</span><span class="p">))[:</span><span class="mi">2</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span>
                    <span class="s2">&quot;c1&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;c2&quot;</span><span class="p">,</span>
                <span class="p">]:</span>
                    <span class="n">files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Warning: No GM or WM were detected ... Please, check &quot;</span>
                    <span class="s2">&quot;the input data and/or the in_filter parameter!&quot;</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="p">[]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">files</span> <span class="o">=</span> <span class="n">files</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_filter</span> <span class="o">==</span> <span class="s2">&quot;GM + WM&quot;</span><span class="p">:</span>
                <span class="n">j</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">files</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="k">while</span> <span class="n">files</span><span class="p">:</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="n">files</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                    <span class="n">i_path</span><span class="p">,</span> <span class="n">i_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">i_file</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;c1&quot;</span><span class="p">,</span> <span class="s2">&quot;c2&quot;</span><span class="p">]:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">ind</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">k</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">files</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span>
                                <span class="s2">&quot;c2&quot;</span> <span class="o">+</span> <span class="n">i_file</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
                            <span class="p">)</span>

                        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                            <span class="k">pass</span>

                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">files</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">ind</span><span class="p">))</span>
                            <span class="n">j</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">i_path</span><span class="p">,</span> <span class="s2">&quot;c1c2&quot;</span> <span class="o">+</span> <span class="n">i_file</span><span class="p">[</span><span class="mi">2</span><span class="p">:]))</span>

                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">ind</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">k</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">files</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span>
                                <span class="s2">&quot;c1&quot;</span> <span class="o">+</span> <span class="n">i_file</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
                            <span class="p">)</span>

                        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                            <span class="k">pass</span>

                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">files</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">ind</span><span class="p">))</span>
                            <span class="n">j</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">i_path</span><span class="p">,</span> <span class="s2">&quot;c1c2&quot;</span> <span class="o">+</span> <span class="n">i_file</span><span class="p">[</span><span class="mi">2</span><span class="p">:]))</span>

                <span class="n">files</span> <span class="o">=</span> <span class="n">j</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Warning: no c1+c2 doublet was detected ... &quot;</span>
                        <span class="s2">&quot;Please, check the input data and/or the in_filter &quot;</span>
                        <span class="s2">&quot;parameter!&quot;</span>
                    <span class="p">)</span>
                    <span class="k">return</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">runFlag</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_filter</span> <span class="o">==</span> <span class="s2">&quot;GM + WM&quot;</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="mi">0</span><span class="p">::</span><span class="mi">2</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]):</span>
                    <span class="n">img1</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                    <span class="n">img2</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>

                    <span class="k">if</span> <span class="p">(</span><span class="n">img1</span><span class="o">.</span><span class="n">affine</span> <span class="o">!=</span> <span class="n">img2</span><span class="o">.</span><span class="n">affine</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                        <span class="nb">print</span><span class="p">(</span>
                            <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Warning! The affine arrays for </span><span class="si">{0}</span><span class="s2"> and </span><span class="si">{1}</span><span class="s2"> &quot;</span>
                            <span class="s2">&quot;are not the same. This can produce an erroneous &quot;</span>
                            <span class="s2">&quot;result!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span>
                        <span class="p">)</span>

                    <span class="n">img1_data</span> <span class="o">=</span> <span class="n">img1</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">()</span>
                    <span class="n">img2_data</span> <span class="o">=</span> <span class="n">img2</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">()</span>

                    <span class="k">if</span> <span class="n">img1_data</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">img2_data</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span>
                            <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Warning! The shapes for </span><span class="si">{0}</span><span class="s2"> and </span><span class="si">{1}</span><span class="s2"> are not &quot;</span>
                            <span class="s2">&quot;the same. This can produce an erroneous &quot;</span>
                            <span class="s2">&quot;result!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span>
                        <span class="p">)</span>

                    <span class="n">c1c2_img_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">img1_data</span><span class="p">,</span> <span class="n">img2_data</span><span class="p">)</span>
                    <span class="n">c1c2_img</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">Nifti1Image</span><span class="p">(</span>
                        <span class="n">c1c2_img_data</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">img1</span><span class="o">.</span><span class="n">header</span><span class="p">,</span> <span class="n">affine</span><span class="o">=</span><span class="n">img1</span><span class="o">.</span><span class="n">affine</span>
                    <span class="p">)</span>
                    <span class="n">c1c2_img</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;descrip&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                        <span class="sa">b</span><span class="s2">&quot;Tissue class 1 + &quot;</span> <span class="sa">b</span><span class="s2">&quot;Tissue class 2&quot;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;|S80&quot;</span>
                    <span class="p">)</span>
                    <span class="n">temp_dir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">()</span>
                    <span class="n">c1c2_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                        <span class="n">temp_dir</span><span class="p">,</span> <span class="s2">&quot;c1c2&quot;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">i</span><span class="p">)[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">:]</span>
                    <span class="p">)</span>
                    <span class="n">nib</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">c1c2_img</span><span class="p">,</span> <span class="n">c1c2_file</span><span class="p">)</span>
                    <span class="n">files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c1c2_file</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">files</span>

        <span class="k">return</span> <span class="n">files</span>

<div class="viewcode-block" id="GM_WM_Normalize.list_outputs"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.spm.html#mia_processes.bricks.preprocess.spm.spatial_preprocessing.GM_WM_Normalize.list_outputs">[docs]</a>    <span class="k">def</span> <span class="nf">list_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_plugged</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the initialisation step of the brick.</span>

<span class="sd">        The main objective of this method is to produce the outputs of the</span>
<span class="sd">        bricks (self.outputs) and the associated tags (self.inheritance_dic),</span>
<span class="sd">        if defined here. In order not to include an output in the database,</span>
<span class="sd">        this output must be a value of the optional key &#39;notInDb&#39; of the</span>
<span class="sd">        self.outputs dictionary. To work properly this method must return</span>
<span class="sd">        self.make_initResult() object.</span>

<span class="sd">        :param is_plugged: the state, linked or not, of the plugs.</span>
<span class="sd">        :returns: a dictionary with requirement, outputs and inheritance_dict.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Using the inheritance to ProcessMIA class, list_outputs method</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">GM_WM_Normalize</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">list_outputs</span><span class="p">()</span>

        <span class="c1"># Outputs definition and tags inheritance (optional)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runFlag</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">jobtype</span> <span class="o">=</span> <span class="s2">&quot;write&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">apply_to_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_namesFilter</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">apply_to_files</span> <span class="o">!=</span> <span class="n">Undefined</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">deformation_file</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">deformation_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">deformation_file</span>

            <span class="c1"># The management of self.process.output_directory could be</span>
            <span class="c1"># delegated to the</span>
            <span class="c1"># populse_mia.user_interface.pipeline_manager.process_mia</span>
            <span class="c1"># module. We can&#39;t do it at the moment because the</span>
            <span class="c1"># sync_process_output_traits() of the</span>
            <span class="c1"># capsul/process/nipype_process module raises an exception</span>
            <span class="c1"># in nipype if the mandatory parameters are not yet defined!</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">output_directory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No output_directory was found...!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;normalized_files&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">_normalized_files</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;normalized_files&quot;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_filter</span> <span class="o">==</span> <span class="s2">&quot;GM + WM&quot;</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">inheritance_dict</span><span class="p">[</span><span class="n">val</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_to_files</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="c1"># FIXME: In the latest version of mia, indexing of the</span>
                        <span class="c1">#        database with particular tags defined in the</span>
                        <span class="c1">#        processes is done only at the end of the</span>
                        <span class="c1">#        initialisation of the whole pipeline. So we</span>
                        <span class="c1">#        cannot use the value of these tags in other</span>
                        <span class="c1">#        processes of the pipeline at the time of</span>
                        <span class="c1">#        initialisation (see populse_mia #290). Until</span>
                        <span class="c1">#        better we use a quick and dirty hack with the</span>
                        <span class="c1">#        set_dbFieldValue() function !</span>
                        <span class="n">tag_to_add</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;PatientName&quot;</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;field_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;string&quot;</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;visibility&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;origin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;user&quot;</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;unit&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;default_value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_dbFieldValue</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">apply_to_files</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                            <span class="s2">&quot;PatientName&quot;</span><span class="p">,</span>
                        <span class="p">)</span>

                        <span class="k">if</span> <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">set_dbFieldValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">tag_to_add</span><span class="p">)</span>

                        <span class="k">else</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span>
                                <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">GM_WM_Normalize brick:</span><span class="se">\n</span><span class="s2">The &#39;PatientName&#39;&quot;</span>
                                <span class="s2">&quot; tag could not be added to the &quot;</span>
                                <span class="s2">&quot;database for the &#39;</span><span class="si">{}</span><span class="s2">&#39; parameter. This &quot;</span>
                                <span class="s2">&quot;can lead to a subsequent issue during &quot;</span>
                                <span class="s2">&quot;initialization!!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                            <span class="p">)</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                            <span class="n">val</span> <span class="o">=</span> <span class="p">[</span><span class="n">val</span><span class="p">]</span>

                        <span class="k">for</span> <span class="n">in_val</span><span class="p">,</span> <span class="n">out_val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">apply_to_files</span><span class="p">,</span> <span class="n">val</span>
                        <span class="p">):</span>
                            <span class="n">_</span><span class="p">,</span> <span class="n">fileOval</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">out_val</span><span class="p">)</span>
                            <span class="n">_</span><span class="p">,</span> <span class="n">fileIval</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">in_val</span><span class="p">)</span>
                            <span class="n">fileOvalNoPref</span> <span class="o">=</span> <span class="n">fileOval</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

                            <span class="k">if</span> <span class="n">fileOvalNoPref</span> <span class="o">==</span> <span class="n">fileIval</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">inheritance_dict</span><span class="p">[</span><span class="n">out_val</span><span class="p">]</span> <span class="o">=</span> <span class="n">in_val</span>
                                <span class="c1"># FIXME: In the latest version of mia, indexing</span>
                                <span class="c1">#        of the database with particular tags</span>
                                <span class="c1">#        defined in the processes is done only</span>
                                <span class="c1">#        at the end of the initialisation of</span>
                                <span class="c1">#        the whole pipeline. So we cannot use</span>
                                <span class="c1">#        the value of these tags in other</span>
                                <span class="c1">#        processes of the pipeline at the time</span>
                                <span class="c1">#        of initialisation (see populse_mia</span>
                                <span class="c1">#        #290). Until better we use a quick and</span>
                                <span class="c1">#        dirty hack with the set_dbFieldValue()</span>
                                <span class="c1">#        function !</span>
                                <span class="n">tag_to_add</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                                <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;PatientName&quot;</span>
                                <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;field_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;string&quot;</span>
                                <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                                <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;visibility&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                                <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;origin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;user&quot;</span>
                                <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;unit&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                                <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;default_value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                                <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_dbFieldValue</span><span class="p">(</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="n">in_val</span><span class="p">,</span> <span class="s2">&quot;PatientName&quot;</span>
                                <span class="p">)</span>

                                <span class="k">if</span> <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                    <span class="n">set_dbFieldValue</span><span class="p">(</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="n">out_val</span><span class="p">,</span> <span class="n">tag_to_add</span>
                                    <span class="p">)</span>

                                <span class="k">else</span><span class="p">:</span>
                                    <span class="nb">print</span><span class="p">(</span>
                                        <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">GM_WM_Normalize brick:</span><span class="se">\n</span><span class="s2">The &quot;</span>
                                        <span class="s2">&quot;&#39;PatientName&#39; tag could not be added &quot;</span>
                                        <span class="s2">&quot;to the database for the &#39;</span><span class="si">{}</span><span class="s2">&#39; &quot;</span>
                                        <span class="s2">&quot;parameter. This can lead to a &quot;</span>
                                        <span class="s2">&quot;subsequent issue during &quot;</span>
                                        <span class="s2">&quot;initialization!!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">out_val</span><span class="p">)</span>
                                    <span class="p">)</span>

        <span class="c1"># Return the requirement, outputs and inheritance_dict</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_initResult</span><span class="p">()</span></div>

<div class="viewcode-block" id="GM_WM_Normalize.run_process_mia"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.spm.html#mia_processes.bricks.preprocess.spm.spatial_preprocessing.GM_WM_Normalize.run_process_mia">[docs]</a>    <span class="k">def</span> <span class="nf">run_process_mia</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the process launch step of the brick.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runFlag</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">jobtype</span> <span class="o">=</span> <span class="s2">&quot;write&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">apply_to_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_namesFilter</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">deformation_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">deformation_file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">write_bounding_box</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_bounding_box</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">write_voxel_sizes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_voxel_sizes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">write_interp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_interp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">trait</span><span class="p">(</span><span class="s2">&quot;image_to_align&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">optional</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># because the sync_process_output_traits() of the</span>
        <span class="c1"># capsul/process/nipype_process module raises an exception in nipype</span>
        <span class="c1"># if the mandatory parameters are not yet defined, the next line</span>
        <span class="c1"># can&#39;t be write before!</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">GM_WM_Normalize</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">run_process_mia</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">configuration_dict</span><span class="o">=</span><span class="p">{})</span></div></div>


<div class="viewcode-block" id="NewSegment"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.spm.html#mia_processes.bricks.preprocess.spm.spatial_preprocessing.NewSegment">[docs]</a><span class="k">class</span> <span class="nc">NewSegment</span><span class="p">(</span><span class="n">ProcessMIA</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    *Segmentation: Segments, bias corrects and spatially normalises*</span>

<span class="sd">    Please, see the complete documention for the</span>
<span class="sd">    `NewSegment brick in the populse.mia_processes web site</span>
<span class="sd">    &lt;https://populse.github.io/mia_processes/html/documentation/bricks/preprocess/spm/NewSegment.html&gt;`_</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="NewSegment.__init__"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.spm.html#mia_processes.bricks.preprocess.spm.spatial_preprocessing.NewSegment.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the attributes initialisation/instantiation.</span>

<span class="sd">        The input and output plugs are defined here. The special</span>
<span class="sd">        &#39;self.requirement&#39; attribute (optional) is used to define the</span>
<span class="sd">        third-party products necessary for the running of the brick.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># initialisation of the objects needed for the launch of the brick</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">NewSegment</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1"># Third party softwares required for the execution of the brick</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requirement</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;spm&quot;</span><span class="p">,</span> <span class="s2">&quot;nipype&quot;</span><span class="p">]</span>

        <span class="c1"># Inputs description</span>

        <span class="n">channel_files_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Path of the scans for processing, valid &quot;</span>
            <span class="s2">&quot;extensions: [.img, .nii, .hdr]. A list with one &quot;</span>
            <span class="s2">&quot;string element corresponding to an existing &quot;</span>
            <span class="s2">&quot;path file.&quot;</span>
        <span class="p">)</span>
        <span class="n">channel_info_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;A tuple with the following values: bias &quot;</span>
            <span class="s2">&quot;reguralisation -a float between 0 and 10-, bias &quot;</span>
            <span class="s2">&quot;FWHM -a float between 20 and infinity-, which &quot;</span>
            <span class="s2">&quot;maps to save -a tuple of two boolean values &quot;</span>
            <span class="s2">&quot;(estimated bias field, bias corrected image)-.&quot;</span>
        <span class="p">)</span>
        <span class="n">tissues_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;A list of tuples with the following values for each &quot;</span>
            <span class="s2">&quot;tissue types (grey matter, white matter, etc.): &quot;</span>
            <span class="s2">&quot;(tissue probability map (4D), 1-based index to frame),&quot;</span>
            <span class="s2">&quot; number of gaussians, (which maps to save: Native,&quot;</span>
            <span class="s2">&quot;DARTEL), (which maps to save: Unmodulated, Modulated),&quot;</span>
            <span class="s2">&quot; ...&quot;</span>
        <span class="p">)</span>
        <span class="n">warping_regularization_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Define of the roughness of the &quot;</span>
            <span class="s2">&quot;deformations for registration using &quot;</span>
            <span class="s2">&quot;1 or 5 elements: a float or a list of &quot;</span>
            <span class="s2">&quot;floats, the latter is required &quot;</span>
            <span class="s2">&quot;by SPM12.&quot;</span>
        <span class="p">)</span>
        <span class="n">affine_regularization_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Standard space for affine registration: &quot;</span>
            <span class="s2">&quot;mni, eastern, subj or none.&quot;</span>
        <span class="p">)</span>

        <span class="n">sampling_distance_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Approximate distance between sampled points &quot;</span>
            <span class="s2">&quot;when estimating the model parameters: &quot;</span>
            <span class="s2">&quot;a float.&quot;</span>
        <span class="p">)</span>

        <span class="n">write_deformation_fields</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Which deformation fields, that can be used&quot;</span>
            <span class="s2">&quot; by the deformation utility, to save: a &quot;</span>
            <span class="s2">&quot;list of 2 booleans for Inverse, Forward.&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Outputs description</span>
        <span class="n">bias_corrected_images_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Bias corrected images (a pathlike &quot;</span>
            <span class="s2">&quot;object or string representing a file, &quot;</span>
            <span class="s2">&quot;or a list of pathlike objects or &quot;</span>
            <span class="s2">&quot;strings representing a file).&quot;</span>
        <span class="p">)</span>
        <span class="n">bias_field_images_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Estimated bias field (a pathlike object or&quot;</span>
            <span class="s2">&quot;string representing a file, or a list of &quot;</span>
            <span class="s2">&quot;pathlike objects or strings representing a &quot;</span>
            <span class="s2">&quot;file).&quot;</span>
        <span class="p">)</span>
        <span class="n">native_class_images_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Native space probability maps (a list of &quot;</span>
            <span class="s2">&quot;items which are a list of items which are &quot;</span>
            <span class="s2">&quot;a pathlike object or string representing &quot;</span>
            <span class="s2">&quot;a file).&quot;</span>
        <span class="p">)</span>
        <span class="n">dartel_input_images_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Imported class images into a form that &quot;</span>
            <span class="s2">&quot;can be used with the Dartel toolbox (a &quot;</span>
            <span class="s2">&quot;list of items which are a list of items &quot;</span>
            <span class="s2">&quot;which are a pathlike object or string &quot;</span>
            <span class="s2">&quot;representing a file).&quot;</span>
        <span class="p">)</span>
        <span class="n">modulated_class_images_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Modulated and normalised class images &quot;</span>
            <span class="s2">&quot;(a list of items which are a list of &quot;</span>
            <span class="s2">&quot;items which are a pathlike object or &quot;</span>
            <span class="s2">&quot;string representing a file).&quot;</span>
        <span class="p">)</span>
        <span class="n">normalized_class_images_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Normalised class images, without &quot;</span>
            <span class="s2">&quot;modulation (a list of items which are &quot;</span>
            <span class="s2">&quot;a list of items which are a pathlike &quot;</span>
            <span class="s2">&quot;object or string representing a file&quot;</span>
        <span class="p">)</span>
        <span class="n">inverse_deformation_field_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Inverse deformation field (a &quot;</span>
            <span class="s2">&quot;pathlike object or string &quot;</span>
            <span class="s2">&quot;representing a file, or a list of &quot;</span>
            <span class="s2">&quot;pathlike objects or strings &quot;</span>
            <span class="s2">&quot;representing a file).&quot;</span>
        <span class="p">)</span>
        <span class="n">forward_deformation_field_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Forward deformation field (a &quot;</span>
            <span class="s2">&quot;pathlike object or string &quot;</span>
            <span class="s2">&quot;representing a file).&quot;</span>
        <span class="p">)</span>
        <span class="n">transformation_mat_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Normalisation transformation (a pathlike &quot;</span>
            <span class="s2">&quot;object or string representing a file).&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Tissues parameter definition</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">Config</span><span class="p">()</span>
        <span class="n">tissues_list</span> <span class="o">=</span> <span class="n">Undefined</span>

        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">get_resources_path</span><span class="p">():</span>
            <span class="n">tpm_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">config</span><span class="o">.</span><span class="n">get_resources_path</span><span class="p">(),</span> <span class="s2">&quot;spm12&quot;</span><span class="p">,</span> <span class="s2">&quot;tpm&quot;</span><span class="p">,</span> <span class="s2">&quot;TPM.nii&quot;</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">Path</span><span class="p">(</span><span class="n">tpm_path</span><span class="p">)</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">NewSegment brick:</span><span class="se">\n</span><span class="s2">  - The </span><span class="si">{}</span><span class="s2"> file &quot;</span>
                    <span class="s2">&quot;seems to not exists ...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tpm_path</span><span class="p">)</span>
                <span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">tissues_list</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">((</span><span class="n">tpm_path</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span> <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">)),</span>
                    <span class="p">((</span><span class="n">tpm_path</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span> <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">)),</span>
                    <span class="p">((</span><span class="n">tpm_path</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span> <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">)),</span>
                    <span class="p">((</span><span class="n">tpm_path</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="mi">3</span><span class="p">,</span> <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span> <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">)),</span>
                    <span class="p">((</span><span class="n">tpm_path</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="mi">4</span><span class="p">,</span> <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span> <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">)),</span>
                    <span class="p">((</span><span class="n">tpm_path</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span> <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">)),</span>
                <span class="p">]</span>

        <span class="c1"># Inputs traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;channel_files&quot;</span><span class="p">,</span>
            <span class="n">InputMultiPath</span><span class="p">(</span>
                <span class="n">ImageFileSPM</span><span class="p">(),</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">channel_files_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;channel_info&quot;</span><span class="p">,</span>
            <span class="n">Tuple</span><span class="p">(</span>
                <span class="n">Range</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="mf">0.0001</span><span class="p">,</span> <span class="n">low</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="mf">10.0</span><span class="p">),</span>
                <span class="n">Range</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="mf">60.0</span><span class="p">,</span> <span class="n">low</span><span class="o">=</span><span class="mf">20.0</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="kc">None</span><span class="p">),</span>
                <span class="n">Tuple</span><span class="p">(</span><span class="n">Bool</span><span class="p">(</span><span class="kc">False</span><span class="p">),</span> <span class="n">Bool</span><span class="p">(</span><span class="kc">True</span><span class="p">)),</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">channel_info_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;tissues&quot;</span><span class="p">,</span>
            <span class="n">Either</span><span class="p">(</span>
                <span class="n">List</span><span class="p">(</span>
                    <span class="n">Tuple</span><span class="p">(</span>
                        <span class="n">Tuple</span><span class="p">(</span><span class="n">ImageFileSPM</span><span class="p">(</span><span class="n">exists</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">Int</span><span class="p">()),</span>
                        <span class="n">Int</span><span class="p">(),</span>
                        <span class="n">Tuple</span><span class="p">(</span><span class="n">Bool</span><span class="p">,</span> <span class="n">Bool</span><span class="p">),</span>
                        <span class="n">Tuple</span><span class="p">(</span><span class="n">Bool</span><span class="p">,</span> <span class="n">Bool</span><span class="p">),</span>
                    <span class="p">)</span>
                <span class="p">),</span>
                <span class="n">Undefined</span><span class="p">,</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">tissues_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tissues</span> <span class="o">=</span> <span class="n">tissues_list</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;warping_regularization&quot;</span><span class="p">,</span>
            <span class="n">Either</span><span class="p">(</span>
                <span class="n">List</span><span class="p">(</span><span class="n">Float</span><span class="p">(),</span> <span class="n">minlen</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">maxlen</span><span class="o">=</span><span class="mi">5</span><span class="p">),</span>
                <span class="n">Float</span><span class="p">(),</span>
                <span class="n">default</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">],</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">warping_regularization_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;affine_regularization&quot;</span><span class="p">,</span>
            <span class="n">Enum</span><span class="p">(</span>
                <span class="s2">&quot;mni&quot;</span><span class="p">,</span>
                <span class="s2">&quot;eastern&quot;</span><span class="p">,</span>
                <span class="s2">&quot;subj&quot;</span><span class="p">,</span>
                <span class="s2">&quot;none&quot;</span><span class="p">,</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">affine_regularization_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;sampling_distance&quot;</span><span class="p">,</span>
            <span class="n">Float</span><span class="p">(</span>
                <span class="mf">3.0</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">sampling_distance_desc</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;write_deformation_fields&quot;</span><span class="p">,</span>
            <span class="n">List</span><span class="p">(</span>
                <span class="n">Bool</span><span class="p">(),</span>
                <span class="n">minlen</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                <span class="n">maxlen</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                <span class="n">value</span><span class="o">=</span><span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">],</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">write_deformation_fields</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># Output traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;bias_corrected_images&quot;</span><span class="p">,</span>
            <span class="n">OutputMultiPath</span><span class="p">(</span>
                <span class="n">File</span><span class="p">(),</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">bias_corrected_images_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;bias_field_images&quot;</span><span class="p">,</span>
            <span class="n">OutputMultiPath</span><span class="p">(</span>
                <span class="n">File</span><span class="p">(),</span> <span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">bias_field_images_desc</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;native_class_images&quot;</span><span class="p">,</span>
            <span class="n">OutputMultiPath</span><span class="p">(</span>
                <span class="n">List</span><span class="p">(</span><span class="n">File</span><span class="p">()),</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">native_class_images_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;dartel_input_images&quot;</span><span class="p">,</span>
            <span class="n">OutputMultiPath</span><span class="p">(</span>
                <span class="n">List</span><span class="p">(</span><span class="n">File</span><span class="p">()),</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">dartel_input_images_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;modulated_class_images&quot;</span><span class="p">,</span>
            <span class="n">OutputMultiPath</span><span class="p">(</span>
                <span class="n">List</span><span class="p">(</span><span class="n">File</span><span class="p">()),</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">modulated_class_images_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;normalized_class_images&quot;</span><span class="p">,</span>
            <span class="n">OutputMultiPath</span><span class="p">(</span>
                <span class="n">List</span><span class="p">(</span><span class="n">File</span><span class="p">()),</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">normalized_class_images_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;inverse_deformation_field&quot;</span><span class="p">,</span>
            <span class="n">OutputMultiPath</span><span class="p">(</span>
                <span class="n">File</span><span class="p">(),</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">inverse_deformation_field_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;forward_deformation_field&quot;</span><span class="p">,</span>
            <span class="n">OutputMultiPath</span><span class="p">(</span>
                <span class="n">ImageFileSPM</span><span class="p">(),</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">forward_deformation_field_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;transformation_mat&quot;</span><span class="p">,</span>
            <span class="n">OutputMultiPath</span><span class="p">(</span>
                <span class="n">File</span><span class="p">(),</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">transformation_mat_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">init_default_traits</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_process</span><span class="p">(</span><span class="s2">&quot;nipype.interfaces.spm.NewSegment&quot;</span><span class="p">)</span>

        <span class="sd">&quot;&quot;&quot; To be removed for V2</span>
<span class="sd">        # process instantiation</span>
<span class="sd">        self.process = NewSegmentMia() # workaround to try to decrease the</span>
<span class="sd">                                       # instantiation time of the NewSegment</span>
<span class="sd">                                       # class</span>
<span class="sd">        #self.process = spm.NewSegment()</span>
<span class="sd">        &quot;&quot;&quot;</span></div>

<div class="viewcode-block" id="NewSegment.list_outputs"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.spm.html#mia_processes.bricks.preprocess.spm.spatial_preprocessing.NewSegment.list_outputs">[docs]</a>    <span class="k">def</span> <span class="nf">list_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_plugged</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the initialisation step of the brick.</span>

<span class="sd">        The main objective of this method is to produce the outputs of the</span>
<span class="sd">        bricks (self.outputs) and the associated tags (self.inheritance_dic),</span>
<span class="sd">        if defined here. In order not to include an output in the database,</span>
<span class="sd">        this output must be a value of the optional key &#39;notInDb&#39; of the</span>
<span class="sd">        self.outputs dictionary. To work properly this method must return</span>
<span class="sd">        self.make_initResult() object.</span>

<span class="sd">        :param is_plugged: the state, linked or not, of the plugs.</span>
<span class="sd">        :returns: a dictionary with requirement, outputs and inheritance_dict.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Using the inheritance to ProcessMIA class, list_outputs method</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">NewSegment</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">list_outputs</span><span class="p">()</span>

        <span class="c1"># Outputs definition and tags inheritance (optional)</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">channel_files</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">channel_info</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_deformation_fields</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">tissues</span>
        <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">channel_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">channel_files</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">channel_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">channel_info</span>
            <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">write_deformation_fields</span>
            <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_deformation_fields</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">tissues</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tissues</span>

            <span class="c1"># The management of self.process.output_directory could be</span>
            <span class="c1"># delegated to the</span>
            <span class="c1"># populse_mia.user_interface.pipeline_manager.process_mia</span>
            <span class="c1"># module. We can&#39;t do it at the moment because the</span>
            <span class="c1"># sync_process_output_traits() of the</span>
            <span class="c1"># capsul/process/nipype_process module raises an exception</span>
            <span class="c1"># in nipype if the mandatory parameters are not yet defined!</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">output_directory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No output_directory was found...!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">(</span>
                <span class="s2">&quot;bias_corrected_images&quot;</span><span class="p">,</span>
                <span class="s2">&quot;bias_field_images&quot;</span><span class="p">,</span>
                <span class="s2">&quot;native_class_images&quot;</span><span class="p">,</span>
                <span class="s2">&quot;dartel_input_images&quot;</span><span class="p">,</span>
                <span class="s2">&quot;modulated_class_images&quot;</span><span class="p">,</span>
                <span class="s2">&quot;normalized_class_images&quot;</span><span class="p">,</span>
                <span class="s2">&quot;inverse_deformation_field&quot;</span><span class="p">,</span>
                <span class="s2">&quot;forward_deformation_field&quot;</span><span class="p">,</span>
                <span class="s2">&quot;transformation_mat&quot;</span><span class="p">,</span>
            <span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">k</span><span class="p">)</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        When there is only one image at the input, the tags inheritance is</span>
<span class="sd">        directly managed in PipelineManagerTab.add_plug_value_to_database().</span>
<span class="sd">        However the inheritance of 2 output parameters is defined below, as</span>
<span class="sd">        an example</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;native_class_images&quot;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                        <span class="n">inp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">channel_files</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                        <span class="n">out</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">val</span><span class="p">]</span>

                        <span class="k">for</span> <span class="n">in_val</span><span class="p">,</span> <span class="n">out_val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="n">out</span><span class="p">):</span>
                            <span class="n">_</span><span class="p">,</span> <span class="n">fileOval</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">out_val</span><span class="p">)</span>
                            <span class="n">_</span><span class="p">,</span> <span class="n">fileIval</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">in_val</span><span class="p">)</span>
                            <span class="n">fileOvalNoPref</span> <span class="o">=</span> <span class="n">fileOval</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>

                            <span class="k">if</span> <span class="n">fileOvalNoPref</span> <span class="o">==</span> <span class="n">fileIval</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">inheritance_dict</span><span class="p">[</span><span class="n">out_val</span><span class="p">]</span> <span class="o">=</span> <span class="n">in_val</span>
                                <span class="c1"># FIXME: In the latest version of mia, indexing</span>
                                <span class="c1">#        of the database with particular tags</span>
                                <span class="c1">#        defined in the processes is done only</span>
                                <span class="c1">#        at the end of the initialisation of</span>
                                <span class="c1">#        the whole pipeline. So we cannot use</span>
                                <span class="c1">#        the value of these tags in other</span>
                                <span class="c1">#        processes of the pipeline at the time</span>
                                <span class="c1">#        of initialisation (see populse_mia</span>
                                <span class="c1">#        #290). Until better we use a quick</span>
                                <span class="c1">#        and dirty hack with the</span>
                                <span class="c1">#        set_dbFieldValue() function !</span>
                                <span class="n">tag_to_add</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                                <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;PatientName&quot;</span>
                                <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;field_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;string&quot;</span>
                                <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                                <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;visibility&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                                <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;origin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;user&quot;</span>
                                <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;unit&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                                <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;default_value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                                <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_dbFieldValue</span><span class="p">(</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="n">in_val</span><span class="p">,</span> <span class="s2">&quot;PatientName&quot;</span>
                                <span class="p">)</span>

                                <span class="k">if</span> <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                    <span class="n">set_dbFieldValue</span><span class="p">(</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="n">out_val</span><span class="p">,</span> <span class="n">tag_to_add</span>
                                    <span class="p">)</span>

                                <span class="k">else</span><span class="p">:</span>
                                    <span class="nb">print</span><span class="p">(</span>
                                        <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">NewSegment brick:</span><span class="se">\n</span><span class="s2">The &quot;</span>
                                        <span class="s2">&quot;&#39;PatientName&#39; tag could not be added &quot;</span>
                                        <span class="s2">&quot;to the database for the &#39;</span><span class="si">{}</span><span class="s2">&#39; &quot;</span>
                                        <span class="s2">&quot;parameter. This can lead to a &quot;</span>
                                        <span class="s2">&quot;subsequent issue during &quot;</span>
                                        <span class="s2">&quot;initialization!!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">out_val</span><span class="p">)</span>
                                    <span class="p">)</span>

                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;forward_deformation_field&quot;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">val</span> <span class="o">!=</span> <span class="n">Undefined</span><span class="p">:</span>
                        <span class="n">val</span> <span class="o">=</span> <span class="p">[</span><span class="n">val</span><span class="p">]</span>

                        <span class="k">for</span> <span class="n">in_val</span><span class="p">,</span> <span class="n">out_val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">channel_files</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
                            <span class="n">_</span><span class="p">,</span> <span class="n">fileOval</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">out_val</span><span class="p">)</span>
                            <span class="n">_</span><span class="p">,</span> <span class="n">fileIval</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">in_val</span><span class="p">)</span>
                            <span class="n">fileOvalNoPref</span> <span class="o">=</span> <span class="n">fileOval</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>

                            <span class="k">if</span> <span class="n">fileOvalNoPref</span> <span class="o">==</span> <span class="n">fileIval</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">inheritance_dict</span><span class="p">[</span><span class="n">out_val</span><span class="p">]</span> <span class="o">=</span> <span class="n">in_val</span>

        <span class="c1"># Return the requirement, outputs and inheritance_dict</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_initResult</span><span class="p">()</span></div>

<div class="viewcode-block" id="NewSegment.run_process_mia"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.spm.html#mia_processes.bricks.preprocess.spm.spatial_preprocessing.NewSegment.run_process_mia">[docs]</a>    <span class="k">def</span> <span class="nf">run_process_mia</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the process launch step of the brick.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">NewSegment</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">run_process_mia</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">channel_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">channel_files</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">channel_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">channel_info</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">tissues</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tissues</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">warping_regularization</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">warping_regularization</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">affine_regularization</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">affine_regularization</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">sampling_distance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sampling_distance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">write_deformation_fields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_deformation_fields</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">configuration_dict</span><span class="o">=</span><span class="p">{})</span></div></div>


<div class="viewcode-block" id="Normalize12"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.spm.html#mia_processes.bricks.preprocess.spm.spatial_preprocessing.Normalize12">[docs]</a><span class="k">class</span> <span class="nc">Normalize12</span><span class="p">(</span><span class="n">ProcessMIA</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    *Computes the warp that best aligns the template (atlas) to the image*</span>

<span class="sd">    Please, see the complete documention for the</span>
<span class="sd">    `Normalize12 brick in the populse.mia_processes web site</span>
<span class="sd">    &lt;https://populse.github.io/mia_processes/html/documentation/bricks/preprocess/spm/Normalize12.html&gt;`_</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Normalize12.__init__"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.spm.html#mia_processes.bricks.preprocess.spm.spatial_preprocessing.Normalize12.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the attributes initialisation/instantiation.</span>

<span class="sd">        The input and output plugs are defined here. The special</span>
<span class="sd">        &#39;self.requirement&#39; attribute (optional) is used to define the</span>
<span class="sd">        third-party products necessary for the running of the brick.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Initialisation of the objects needed for the launch of the brick</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Normalize12</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1"># Third party softwares required for the execution of the brick</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requirement</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;spm&quot;</span><span class="p">,</span> <span class="s2">&quot;nipype&quot;</span><span class="p">]</span>

        <span class="c1"># Inputs description</span>
        <span class="n">image_to_align_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;The image that the atlas data is warped into &quot;</span>
            <span class="s2">&quot;alignment with (an existing file; valid &quot;</span>
            <span class="s2">&quot;extensions in [.img, .nii, .hdr]). Mutually &quot;</span>
            <span class="s2">&quot;exclusive with the deformation_file parameter.&quot;</span>
        <span class="p">)</span>
        <span class="n">deformation_file_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;File y_*.nii containing 3 deformation fields &quot;</span>
            <span class="s2">&quot;for the deformation in x, y and z dimension &quot;</span>
            <span class="s2">&quot;(an uncompressed file; valid extensions in &quot;</span>
            <span class="s2">&quot;[.img, .nii, .hdr]). Mutually exclusive with &quot;</span>
            <span class="s2">&quot;the image_to_align and tpm parameters.&quot;</span>
        <span class="p">)</span>
        <span class="n">apply_to_files_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Files to apply transformation to. A list of &quot;</span>
            <span class="s2">&quot;items which are an existing, uncompressed file &quot;</span>
            <span class="s2">&quot;(valid extensions: [.img, .nii, .hdr]).&quot;</span>
        <span class="p">)</span>
        <span class="n">jobtype_desc</span> <span class="o">=</span> <span class="s1">&#39;One of &quot;estwrite&quot; or &quot;estimate&quot; or &quot;write&quot;.&#39;</span>
        <span class="n">bias_regularization_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;(For low-intensity non-uniformity artifacts&quot;</span>
            <span class="s2">&quot;, use a high bias regularization (a float &quot;</span>
            <span class="s2">&quot; between 0 and 10).&quot;</span>
        <span class="p">)</span>
        <span class="n">bias_fwhm_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Full Width at Half Maximum of Gaussian smoothness &quot;</span>
            <span class="s2">&quot;of bias (a value in [30, 40, 50, 60, 70, 80, 90, &quot;</span>
            <span class="s2">&quot;100, 110, 120, 130, 140, 150, Inf).&quot;</span>
        <span class="p">)</span>
        <span class="n">tpm_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;The template in form of tissue probability atlas (a &quot;</span>
            <span class="s2">&quot;pathlike object or string representing an existing file). &quot;</span>
            <span class="s2">&quot;Mutually exclusive with the deformation_file parameter.&quot;</span>
        <span class="p">)</span>
        <span class="n">affine_regularization_type_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Standard space for affine &quot;</span>
            <span class="s2">&quot;registration (mni or size or &quot;</span>
            <span class="s2">&quot;none).&quot;</span>
        <span class="p">)</span>
        <span class="n">warping_regularization_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;The measure of the roughness of the &quot;</span>
            <span class="s2">&quot;deformations for registration. Involve &quot;</span>
            <span class="s2">&quot;the sum of 5 elements (list of &quot;</span>
            <span class="s2">&quot;floats).&quot;</span>
        <span class="p">)</span>
        <span class="n">smoothness_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Value to smooth the data before normalisation (a &quot;</span>
            <span class="s2">&quot;float; in mm). 0 is a good value for MRI.&quot;</span>
        <span class="p">)</span>
        <span class="n">sampling_distance_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Approximate distance between sampled points &quot;</span>
            <span class="s2">&quot;when estimating the model parameters (a &quot;</span>
            <span class="s2">&quot;float).&quot;</span>
        <span class="p">)</span>
        <span class="n">write_bounding_box_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;The bounding box (in mm) of the volume &quot;</span>
            <span class="s2">&quot;which is to be written (a list of 2 items, &quot;</span>
            <span class="s2">&quot;which are a list of items, which are a &quot;</span>
            <span class="s2">&quot;float.&quot;</span>
        <span class="p">)</span>
        <span class="n">write_voxel_sizes_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;The voxel sizes (x, y &amp; z, in mm) of the &quot;</span>
            <span class="s2">&quot;written normalised images (a list of 3 &quot;</span>
            <span class="s2">&quot;items, which are a float).&quot;</span>
        <span class="p">)</span>
        <span class="n">write_interp_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Degree of b-spline used for interpolation &quot;</span>
            <span class="s2">&quot;(0 &lt;= a long integer &lt;= 7; 1 is OK for PET, &quot;</span>
            <span class="s2">&quot;realigned fMRI, or segmentations).&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Outputs description</span>
        <span class="n">deformation_field_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;File y_*.nii containing 3 deformation &quot;</span>
            <span class="s2">&quot;fields for the deformation in x, y and z &quot;</span>
            <span class="s2">&quot;dimension (a pathlike object or string &quot;</span>
            <span class="s2">&quot;representing a file, or a list of pathlike &quot;</span>
            <span class="s2">&quot;objects or strings representing a file)&quot;</span>
        <span class="p">)</span>
        <span class="c1">#        normalized_image_desc = (</span>
        <span class="c1">#            &quot;Normalised file that needed to be aligned (a &quot;</span>
        <span class="c1">#            &quot;pathlike object or string representing a &quot;</span>
        <span class="c1">#            &quot;file, or a list of pathlike objects or &quot;</span>
        <span class="c1">#            &quot;strings representing a file).&quot;</span>
        <span class="c1">#        )</span>
        <span class="n">normalized_files_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Normalised other files (a pathlike object or &quot;</span>
            <span class="s2">&quot;string representing a file, or a list of &quot;</span>
            <span class="s2">&quot;pathlike objects or strings representing a &quot;</span>
            <span class="s2">&quot;file).&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Tpm parameter definition</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">Config</span><span class="p">()</span>
        <span class="n">tpm_path</span> <span class="o">=</span> <span class="n">Undefined</span>

        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">get_resources_path</span><span class="p">():</span>
            <span class="n">tpm_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">config</span><span class="o">.</span><span class="n">get_resources_path</span><span class="p">(),</span> <span class="s2">&quot;spm12&quot;</span><span class="p">,</span> <span class="s2">&quot;tpm&quot;</span><span class="p">,</span> <span class="s2">&quot;TPM.nii&quot;</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">Path</span><span class="p">(</span><span class="n">tpm_path</span><span class="p">)</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Normalize12 brick:</span><span class="se">\n</span><span class="s2">  - The </span><span class="si">{}</span><span class="s2"> file &quot;</span>
                    <span class="s2">&quot;seems to not exists ...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tpm_path</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="n">tpm_path</span> <span class="o">=</span> <span class="n">Undefined</span>

        <span class="c1"># Inputs traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;image_to_align&quot;</span><span class="p">,</span>
            <span class="n">ImageFileSPM</span><span class="p">(</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">image_to_align_desc</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;deformation_file&quot;</span><span class="p">,</span>
            <span class="n">ImageFileSPM</span><span class="p">(</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">deformation_file_desc</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;apply_to_files&quot;</span><span class="p">,</span>
            <span class="n">InputMultiPath</span><span class="p">(</span>
                <span class="n">Either</span><span class="p">(</span><span class="n">ImageFileSPM</span><span class="p">(),</span> <span class="n">List</span><span class="p">(</span><span class="n">ImageFileSPM</span><span class="p">()),</span> <span class="n">Undefined</span><span class="p">),</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">apply_to_files_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;jobtype&quot;</span><span class="p">,</span>
            <span class="n">Enum</span><span class="p">(</span>
                <span class="s2">&quot;write&quot;</span><span class="p">,</span>
                <span class="c1">#                &quot;estimate&quot;,</span>
                <span class="s2">&quot;est&quot;</span><span class="p">,</span>
                <span class="s2">&quot;estwrite&quot;</span><span class="p">,</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">jobtype_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;bias_regularization&quot;</span><span class="p">,</span>
            <span class="n">Enum</span><span class="p">(</span>
                <span class="mi">0</span><span class="p">,</span>
                <span class="mf">0.00001</span><span class="p">,</span>
                <span class="mf">0.0001</span><span class="p">,</span>
                <span class="mf">0.001</span><span class="p">,</span>
                <span class="mf">0.01</span><span class="p">,</span>
                <span class="mf">0.1</span><span class="p">,</span>
                <span class="mi">1</span><span class="p">,</span>
                <span class="mi">10</span><span class="p">,</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">bias_regularization_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;bias_fwhm&quot;</span><span class="p">,</span>
            <span class="n">Enum</span><span class="p">(</span>
                <span class="mi">60</span><span class="p">,</span>
                <span class="mi">30</span><span class="p">,</span>
                <span class="mi">40</span><span class="p">,</span>
                <span class="mi">50</span><span class="p">,</span>
                <span class="mi">70</span><span class="p">,</span>
                <span class="mi">80</span><span class="p">,</span>
                <span class="mi">90</span><span class="p">,</span>
                <span class="mi">100</span><span class="p">,</span>
                <span class="mi">110</span><span class="p">,</span>
                <span class="mi">120</span><span class="p">,</span>
                <span class="mi">130</span><span class="p">,</span>
                <span class="mi">140</span><span class="p">,</span>
                <span class="mi">150</span><span class="p">,</span>
                <span class="s2">&quot;Inf&quot;</span><span class="p">,</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">bias_fwhm_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;tpm&quot;</span><span class="p">,</span>
            <span class="n">File</span><span class="p">(</span>
                <span class="n">exists</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">value</span><span class="o">=</span><span class="n">tpm_path</span><span class="p">,</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">tpm_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;affine_regularization_type&quot;</span><span class="p">,</span>
            <span class="n">Enum</span><span class="p">(</span>
                <span class="s2">&quot;mni&quot;</span><span class="p">,</span>
                <span class="s2">&quot;size&quot;</span><span class="p">,</span>
                <span class="s2">&quot;none&quot;</span><span class="p">,</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">affine_regularization_type_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;warping_regularization&quot;</span><span class="p">,</span>
            <span class="n">List</span><span class="p">(</span>
                <span class="n">value</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">],</span>
                <span class="n">trait</span><span class="o">=</span><span class="n">Float</span><span class="p">(),</span>
                <span class="n">minlen</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                <span class="n">maxlen</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">warping_regularization_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;smoothness&quot;</span><span class="p">,</span>
            <span class="n">Float</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">smoothness_desc</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;sampling_distance&quot;</span><span class="p">,</span>
            <span class="n">Float</span><span class="p">(</span>
                <span class="mf">3.0</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">sampling_distance_desc</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;write_bounding_box&quot;</span><span class="p">,</span>
            <span class="n">List</span><span class="p">(</span>
                <span class="n">List</span><span class="p">(</span><span class="n">Float</span><span class="p">()),</span>
                <span class="n">value</span><span class="o">=</span><span class="p">[[</span><span class="o">-</span><span class="mi">78</span><span class="p">,</span> <span class="o">-</span><span class="mi">112</span><span class="p">,</span> <span class="o">-</span><span class="mi">50</span><span class="p">],</span> <span class="p">[</span><span class="mi">78</span><span class="p">,</span> <span class="mi">76</span><span class="p">,</span> <span class="mi">85</span><span class="p">]],</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">write_bounding_box_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;write_voxel_sizes&quot;</span><span class="p">,</span>
            <span class="n">List</span><span class="p">(</span>
                <span class="n">Float</span><span class="p">(),</span>
                <span class="n">value</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">write_voxel_sizes_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;write_interp&quot;</span><span class="p">,</span>
            <span class="n">Range</span><span class="p">(</span>
                <span class="n">value</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">low</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">high</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">write_interp_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># Outputs traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;deformation_field&quot;</span><span class="p">,</span>
            <span class="n">OutputMultiPath</span><span class="p">(</span>
                <span class="n">File</span><span class="p">(),</span> <span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">deformation_field_desc</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="c1">#        self.add_trait(</span>
        <span class="c1">#            &quot;normalized_image&quot;,</span>
        <span class="c1">#            OutputMultiPath(</span>
        <span class="c1">#                File(), output=True,</span>
        <span class="c1">#                optional=True, desc=normalized_image_desc</span>
        <span class="c1">#            ),</span>
        <span class="c1">#        )</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;normalized_files&quot;</span><span class="p">,</span>
            <span class="n">OutputMultiPath</span><span class="p">(</span>
                <span class="n">File</span><span class="p">(),</span> <span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">normalized_files_desc</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">init_default_traits</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_process</span><span class="p">(</span><span class="s2">&quot;nipype.interfaces.spm.Normalize12&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Normalize12.list_outputs"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.spm.html#mia_processes.bricks.preprocess.spm.spatial_preprocessing.Normalize12.list_outputs">[docs]</a>    <span class="k">def</span> <span class="nf">list_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_plugged</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the initialisation step of the brick.</span>

<span class="sd">        The main objective of this method is to produce the outputs of the</span>
<span class="sd">        bricks (self.outputs) and the associated tags (self.inheritance_dic),</span>
<span class="sd">        if defined here. In order not to include an output in the database,</span>
<span class="sd">        this output must be a value of the optional key &#39;notInDb&#39; of the</span>
<span class="sd">        self.outputs dictionary. To work properly this method must return</span>
<span class="sd">        self.make_initResult() object.</span>

<span class="sd">        :param is_plugged: the state, linked or not, of the plugs.</span>
<span class="sd">        :returns: a dictionary with requirement, outputs and inheritance_dict.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Using the inheritance to ProcessMIA class, list_outputs method</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Normalize12</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">list_outputs</span><span class="p">()</span>

        <span class="c1"># Outputs definition</span>
        <span class="n">_flag</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">apply_to_files</span><span class="p">)</span>
            <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">apply_to_files</span> <span class="o">!=</span> <span class="n">Undefined</span><span class="p">)</span>
            <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deformation_file</span><span class="p">)</span>
            <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jobtype</span> <span class="o">==</span> <span class="s2">&quot;write&quot;</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">jobtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobtype</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">apply_to_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_to_files</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">deformation_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">deformation_file</span>
            <span class="n">_flag</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_to_align</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">image_to_align</span> <span class="o">=</span> <span class="n">Undefined</span>
                <span class="c1"># self.process.image_to_align = self.image_to_align</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tpm</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tpm</span> <span class="o">=</span> <span class="n">Undefined</span>

        <span class="k">elif</span> <span class="p">(</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image_to_align</span><span class="p">)</span>
            <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image_to_align</span> <span class="o">!=</span> <span class="n">Undefined</span><span class="p">)</span>
            <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tpm</span><span class="p">)</span>
            <span class="c1"># and (self.jobtype == &quot;estimate&quot;)</span>
            <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jobtype</span> <span class="o">==</span> <span class="s2">&quot;est&quot;</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">image_to_align</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_to_align</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">tpm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tpm</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">jobtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobtype</span>
            <span class="n">_flag</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_to_files</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">apply_to_files</span> <span class="o">!=</span> <span class="n">Undefined</span><span class="p">):</span>
                <span class="c1">#    self.apply_to_files = [Undefined]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">apply_to_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_to_files</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">deformation_file</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">deformation_file</span> <span class="o">=</span> <span class="n">Undefined</span>

        <span class="k">elif</span> <span class="p">(</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image_to_align</span><span class="p">)</span>
            <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image_to_align</span> <span class="o">!=</span> <span class="n">Undefined</span><span class="p">)</span>
            <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tpm</span><span class="p">)</span>
            <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jobtype</span> <span class="o">==</span> <span class="s2">&quot;estwrite&quot;</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">image_to_align</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_to_align</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">tpm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tpm</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">jobtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobtype</span>
            <span class="n">_flag</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">apply_to_files</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">apply_to_files</span> <span class="o">!=</span> <span class="n">Undefined</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">apply_to_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_to_files</span>
                <span class="c1"># self.apply_to_files = Undefined</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">deformation_file</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">deformation_file</span> <span class="o">=</span> <span class="n">Undefined</span>

        <span class="k">if</span> <span class="n">_flag</span><span class="p">:</span>
            <span class="c1"># The management of self.process.output_directory could be</span>
            <span class="c1"># delegated to the</span>
            <span class="c1"># populse_mia.user_interface.pipeline_manager.process_mia</span>
            <span class="c1"># module. We can&#39;t do it at the moment because the</span>
            <span class="c1"># sync_process_output_traits() of the</span>
            <span class="c1"># capsul/process/nipype_process module raises an exception</span>
            <span class="c1"># in nipype if the mandatory parameters are not yet defined!</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">output_directory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No output_directory was found...!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">(</span>
                <span class="s2">&quot;deformation_field&quot;</span><span class="p">,</span>
                <span class="c1"># &quot;normalized_image&quot;,</span>
                <span class="s2">&quot;normalized_files&quot;</span><span class="p">,</span>
            <span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">k</span><span class="p">)</span>

        <span class="c1"># Tags inheritance (optional)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;normalized_files&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="n">Undefined</span><span class="p">):</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                        <span class="n">val</span> <span class="o">=</span> <span class="p">[</span><span class="n">val</span><span class="p">]</span>

                    <span class="k">for</span> <span class="n">in_val</span><span class="p">,</span> <span class="n">out_val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">apply_to_files</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
                        <span class="c1"># FIXME: In the latest version of mia, indexing of the</span>
                        <span class="c1">#        database with particular tags defined in the</span>
                        <span class="c1">#        processes is done only at the end of the</span>
                        <span class="c1">#        initialisation of the whole pipeline. So we</span>
                        <span class="c1">#        cannot use the value of these tags in other</span>
                        <span class="c1">#        processes of the pipeline at the time of</span>
                        <span class="c1">#        initialisation (see populse_mia #290). Until</span>
                        <span class="c1">#        better we use a quick and dirty hack with the</span>
                        <span class="c1">#        set_dbFieldValue() function !</span>
                        <span class="n">tag_to_add</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;RepetitionTime&quot;</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;field_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;float&quot;</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="s2">&quot;The period of time &quot;</span>
                            <span class="s2">&quot;in msec between the &quot;</span>
                            <span class="s2">&quot;beginning of a pulse &quot;</span>
                            <span class="s2">&quot;sequence and the &quot;</span>
                            <span class="s2">&quot;beginning of the &quot;</span>
                            <span class="s2">&quot;succeeding pulse &quot;</span>
                            <span class="s2">&quot;sequence&quot;</span>
                        <span class="p">)</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;visibility&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;origin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;user&quot;</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;unit&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;ms&quot;</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;default_value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_dbFieldValue</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="n">in_val</span><span class="p">,</span> <span class="s2">&quot;RepetitionTime&quot;</span>
                        <span class="p">)</span>

                        <span class="k">if</span> <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">set_dbFieldValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="n">out_val</span><span class="p">,</span> <span class="n">tag_to_add</span><span class="p">)</span>

                        <span class="k">else</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span>
                                <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Normalize12:</span><span class="se">\n</span><span class="s2">The &#39;RepetitionTime&#39; tag &quot;</span>
                                <span class="s2">&quot;could not be added to the database for the &quot;</span>
                                <span class="s2">&quot;&#39;</span><span class="si">{}</span><span class="s2">&#39; parameter. This can lead to a &quot;</span>
                                <span class="s2">&quot;subsequent issue during &quot;</span>
                                <span class="s2">&quot;initialization!!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">out_val</span><span class="p">)</span>
                            <span class="p">)</span>

                        <span class="n">tag_to_add</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="s2">&quot;Dataset dimensions &quot;</span> <span class="s2">&quot;(Count, X,Y,Z,T...)&quot;</span>
                        <span class="p">)</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;field_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;int&quot;</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="s2">&quot;data array dimensions&quot;</span> <span class="s2">&quot; (from Nifti header)&quot;</span>
                        <span class="p">)</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;visibility&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;origin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;user&quot;</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;unit&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;default_value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_dbFieldValue</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span>
                            <span class="n">in_val</span><span class="p">,</span>
                            <span class="p">(</span><span class="s2">&quot;Dataset dimensions &quot;</span> <span class="s2">&quot;(Count, X,Y,Z,T...)&quot;</span><span class="p">),</span>
                        <span class="p">)</span>

                        <span class="k">if</span> <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">set_dbFieldValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="n">out_val</span><span class="p">,</span> <span class="n">tag_to_add</span><span class="p">)</span>

                        <span class="k">else</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span>
                                <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Normalize12:</span><span class="se">\n</span><span class="s2">The &#39;Dataset dimensions &quot;</span>
                                <span class="s2">&quot;(Count, X,Y,Z,T...)&#39; tag could not be added &quot;</span>
                                <span class="s2">&quot;to the database for the &#39;</span><span class="si">{}</span><span class="s2">&#39; parameter. &quot;</span>
                                <span class="s2">&quot;This can lead to a subsequent issue during &quot;</span>
                                <span class="s2">&quot;initialization!!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">out_val</span><span class="p">)</span>
                            <span class="p">)</span>

                        <span class="n">tag_to_add</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;PatientName&quot;</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;field_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;string&quot;</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;visibility&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;origin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;user&quot;</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;unit&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;default_value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_dbFieldValue</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="n">in_val</span><span class="p">,</span> <span class="s2">&quot;PatientName&quot;</span>
                        <span class="p">)</span>

                        <span class="k">if</span> <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">set_dbFieldValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="n">out_val</span><span class="p">,</span> <span class="n">tag_to_add</span><span class="p">)</span>

                        <span class="k">else</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span>
                                <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Normalize12:</span><span class="se">\n</span><span class="s2">The &#39;PatientName&#39; tag could &quot;</span>
                                <span class="s2">&quot;not be added to the database for the &#39;</span><span class="si">{}</span><span class="s2">&#39; &quot;</span>
                                <span class="s2">&quot;parameter. This can lead to a subsequent &quot;</span>
                                <span class="s2">&quot;issue during &quot;</span>
                                <span class="s2">&quot;initialization!!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">out_val</span><span class="p">)</span>
                            <span class="p">)</span>

                        <span class="n">age</span> <span class="o">=</span> <span class="n">get_dbFieldValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="n">in_val</span><span class="p">,</span> <span class="s2">&quot;Age&quot;</span><span class="p">)</span>

                        <span class="k">if</span> <span class="n">age</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">tag_to_add</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Age&quot;</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;field_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;int&quot;</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;visibility&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;origin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;user&quot;</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;unit&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;default_value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">age</span>
                            <span class="n">set_dbFieldValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="n">out_val</span><span class="p">,</span> <span class="n">tag_to_add</span><span class="p">)</span>

                        <span class="n">pathology</span> <span class="o">=</span> <span class="n">get_dbFieldValue</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="n">in_val</span><span class="p">,</span> <span class="s2">&quot;Pathology&quot;</span>
                        <span class="p">)</span>

                        <span class="k">if</span> <span class="n">pathology</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">tag_to_add</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Pathology&quot;</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;field_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;string&quot;</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;visibility&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;origin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;user&quot;</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;unit&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;default_value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pathology</span>
                            <span class="n">set_dbFieldValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="n">out_val</span><span class="p">,</span> <span class="n">tag_to_add</span><span class="p">)</span>

                        <span class="n">pathOval</span><span class="p">,</span> <span class="n">fileOval</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">out_val</span><span class="p">)</span>
                        <span class="n">_</span><span class="p">,</span> <span class="n">fileIval</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">in_val</span><span class="p">)</span>
                        <span class="n">fileOvalNoPref</span> <span class="o">=</span> <span class="n">fileOval</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

                        <span class="k">if</span> <span class="n">fileOvalNoPref</span> <span class="o">==</span> <span class="n">fileIval</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">inheritance_dict</span><span class="p">[</span><span class="n">out_val</span><span class="p">]</span> <span class="o">=</span> <span class="n">in_val</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;deformation_field&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="n">Undefined</span><span class="p">):</span>
                    <span class="n">pathOval</span><span class="p">,</span> <span class="n">fileOval</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                    <span class="n">_</span><span class="p">,</span> <span class="n">fileIval</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image_to_align</span><span class="p">)</span>
                    <span class="n">fileOvalNoPref</span> <span class="o">=</span> <span class="n">fileOval</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>

                    <span class="k">if</span> <span class="n">fileOvalNoPref</span> <span class="o">==</span> <span class="n">fileIval</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">inheritance_dict</span><span class="p">[</span><span class="n">val</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_to_align</span>

                <span class="c1"># if (key == &quot;normalized_image&quot;) and (val != Undefined):</span>
                <span class="c1">#     if not isinstance(val, list):</span>
                <span class="c1">#         val = [val]</span>
                <span class="c1">#</span>
                <span class="c1">#     for in_val, out_val in zip(self.image_to_align, val):</span>
                <span class="c1">#         pathOval, fileOval = os.path.split(out_val)</span>
                <span class="c1">#         _, fileIval = os.path.split(in_val)</span>
                <span class="c1">#         # FIXME: I don&#39;t know exactly what is expected ...</span>
                <span class="c1">#                  Need investigation ...</span>
                <span class="c1">#         # fileOvalNoPref = fileOval[1:]  ???</span>
                <span class="c1">#         # if fileOvalNoPref == fileIval:  ???</span>
                <span class="c1">#         #    self.inheritance_dict[out_val] = in_val ???</span>

        <span class="c1"># Return the requirement, outputs and inheritance_dict</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_initResult</span><span class="p">()</span></div>

<div class="viewcode-block" id="Normalize12.run_process_mia"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.spm.html#mia_processes.bricks.preprocess.spm.spatial_preprocessing.Normalize12.run_process_mia">[docs]</a>    <span class="k">def</span> <span class="nf">run_process_mia</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the process launch step of the brick.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">trait</span><span class="p">(</span><span class="s2">&quot;image_to_align&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">optional</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">image_to_align</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_to_align</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">jobtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobtype</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">trait</span><span class="p">(</span><span class="s2">&quot;deformation_file&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">optional</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">deformation_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">deformation_file</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_to_files</span> <span class="o">==</span> <span class="p">[</span><span class="n">Undefined</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">apply_to_files</span> <span class="o">=</span> <span class="n">Undefined</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">apply_to_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_to_files</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">bias_regularization</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias_regularization</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">bias_fwhm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias_fwhm</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobtype</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;est&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">tpm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tpm</span>

        <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">affine_regularization_type</span>
        <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">affine_regularization_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">warping_regularization</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">warping_regularization</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">smoothness</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">smoothness</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">sampling_distance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sampling_distance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">write_bounding_box</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_bounding_box</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">write_voxel_sizes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_voxel_sizes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">write_interp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_interp</span>

        <span class="c1"># because the sync_process_output_traits() of the</span>
        <span class="c1"># capsul/process/nipype_process  module raises an exception in nipype</span>
        <span class="c1"># if the mandatory parameters are not yet defined, the next line</span>
        <span class="c1"># can&#39;t be write before!</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Normalize12</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">run_process_mia</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">configuration_dict</span><span class="o">=</span><span class="p">{})</span></div></div>


<div class="viewcode-block" id="Realign"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.spm.html#mia_processes.bricks.preprocess.spm.spatial_preprocessing.Realign">[docs]</a><span class="k">class</span> <span class="nc">Realign</span><span class="p">(</span><span class="n">ProcessMIA</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    *Realigns a time-series of images acquired from the same subject*</span>

<span class="sd">    Please, see the complete documentation for the</span>
<span class="sd">    `Realign brick in the populse.mia_processes web site</span>
<span class="sd">    &lt;https://populse.github.io/mia_processes/html/documentation/bricks/preprocess/spm/Realign.html&gt;`_</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Realign.__init__"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.spm.html#mia_processes.bricks.preprocess.spm.spatial_preprocessing.Realign.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the attributes initialisation/instantiation.</span>

<span class="sd">        The input and output plugs are defined here. The special</span>
<span class="sd">        &#39;self.requirement&#39; attribute (optional) is used to define the</span>
<span class="sd">        third-party products necessary for the running of the brick.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Initialisation of the objects needed for the launch of the brick</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Realign</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1"># Third party softwares required for the execution of the brick</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requirement</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;spm&quot;</span><span class="p">,</span> <span class="s2">&quot;nipype&quot;</span><span class="p">]</span>

        <span class="c1"># Inputs description</span>
        <span class="n">in_files_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;The images to realign (a list of pathlike objects or &quot;</span>
            <span class="s2">&quot;strings representing a file or of list of items &quot;</span>
            <span class="s2">&quot;which are a pathlike object or strings representing &quot;</span>
            <span class="s2">&quot;a file or a _Undefined).&quot;</span>
        <span class="p">)</span>
        <span class="n">jobtype_desc</span> <span class="o">=</span> <span class="s1">&#39;One of &quot;estwrite&quot; or &quot;estimate&quot; or &quot;write&quot;.&#39;</span>
        <span class="n">quality_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Quality versus speed trade-off (0.0 &lt;= a floating&quot;</span>
            <span class="s2">&quot;point number &lt;= 1.0).&quot;</span>
        <span class="p">)</span>
        <span class="n">separation_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Sampling separation (in mm) in the reference image&quot;</span>
            <span class="s2">&quot;(a floating point number &gt;= 0.0).&quot;</span>
        <span class="p">)</span>
        <span class="n">fwhm_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;The gaussian smoothing kernel width (mm, a floating point&quot;</span>
            <span class="s2">&quot; number &gt;= 0.0) applied to the images before estimating&quot;</span>
            <span class="s2">&quot; the realignment parameters.&quot;</span>
        <span class="p">)</span>
        <span class="n">register_to_mean_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Indicate whether realignment is done to the&quot;</span>
            <span class="s2">&quot; mean image (True) or to the first image&quot;</span>
            <span class="s2">&quot; (False).&quot;</span>
        <span class="p">)</span>
        <span class="n">interp_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Degree of b-spline (1 &lt;= a long integer &lt;= 7) used for&quot;</span>
            <span class="s2">&quot; interpolation.&quot;</span>
        <span class="p">)</span>
        <span class="n">wrap_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Check if interpolation should wrap in [x,y,z] (a list of&quot;</span>
            <span class="s2">&quot; 3 items which are integer int or long).&quot;</span>
        <span class="p">)</span>
        <span class="n">weight_img_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;File name of the weighting image, to weight each&quot;</span>
            <span class="s2">&quot; voxel of the reference image.&quot;</span>
        <span class="p">)</span>
        <span class="n">write_which_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Determines which images to reslice (a list of&quot;</span>
            <span class="s1">&#39; items which are a value of class &quot;int&quot;).&#39;</span>
        <span class="p">)</span>
        <span class="n">write_interp_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;0 &lt;= a long integer &lt;= 7. The method by which the&quot;</span>
            <span class="s2">&quot; images are sampled when being written in a&quot;</span>
            <span class="s2">&quot; different space.&quot;</span>
        <span class="p">)</span>
        <span class="n">write_wrap_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;A list of from 3 to 3 items which are an integer&quot;</span>
            <span class="s2">&quot; (int or long).&quot;</span>
        <span class="p">)</span>
        <span class="n">write_mask_desc</span> <span class="o">=</span> <span class="s2">&quot;Mask output image (a boolean)&quot;</span>
        <span class="n">out_prefix_desc</span> <span class="o">=</span> <span class="s2">&quot;Realigned output prefix (a string).&quot;</span>

        <span class="c1"># Outputs description</span>
        <span class="n">realigned_files_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;If write_which is [2, 0], [1, 0] or [2, 1] and&quot;</span>
            <span class="s2">&quot; jobtype is write or estwrite, these will be &quot;</span>
            <span class="s2">&quot;the resliced files (a pathlike object or &quot;</span>
            <span class="s2">&quot;string representing a file or a list of &quot;</span>
            <span class="s2">&quot;items which are a pathlike object or string &quot;</span>
            <span class="s2">&quot;representing a file or a list of list of &quot;</span>
            <span class="s2">&quot;items which are a pathlike object or string &quot;</span>
            <span class="s2">&quot;representing a file).&quot;</span>
        <span class="p">)</span>
        <span class="n">modified_in_files_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;If the jobtype parameter is estimate or &quot;</span>
            <span class="s2">&quot;estwrite, these will be copies of the &quot;</span>
            <span class="s2">&quot;in_files with a rewritten header (a &quot;</span>
            <span class="s2">&quot;pathlike object or string representing a &quot;</span>
            <span class="s2">&quot;file or a list of items which are a &quot;</span>
            <span class="s2">&quot;pathlike object or string representing a &quot;</span>
            <span class="s2">&quot;file or a list of list of items which are a &quot;</span>
            <span class="s2">&quot;pathlike object or string representing a &quot;</span>
            <span class="s2">&quot;file).&quot;</span>
        <span class="p">)</span>
        <span class="n">mean_image_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;If write_which is [2, 1] or [0, 1] and jobtype is &quot;</span>
            <span class="s2">&quot;write or estwrite, this will be the mean image &quot;</span>
            <span class="s2">&quot;file from the realignment (a pathlike object or &quot;</span>
            <span class="s2">&quot;string representing a file).&quot;</span>
        <span class="p">)</span>
        <span class="n">realignment_parameters_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;If the jobtype parameter is estimate &quot;</span>
            <span class="s2">&quot;or estwrite, this will be the &quot;</span>
            <span class="s2">&quot;estimated translation and rotation &quot;</span>
            <span class="s2">&quot;parameters (a pathlike object or &quot;</span>
            <span class="s2">&quot;string representing a file, or a list &quot;</span>
            <span class="s2">&quot;of pathlike objects or strings &quot;</span>
            <span class="s2">&quot;representing a file).&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Inputs traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;in_files&quot;</span><span class="p">,</span>
            <span class="n">InputMultiPath</span><span class="p">(</span>
                <span class="n">Either</span><span class="p">(</span><span class="n">ImageFileSPM</span><span class="p">(),</span> <span class="n">List</span><span class="p">(</span><span class="n">ImageFileSPM</span><span class="p">()),</span> <span class="n">Undefined</span><span class="p">),</span>
                <span class="n">copyfile</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">in_files_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;jobtype&quot;</span><span class="p">,</span>
            <span class="n">Enum</span><span class="p">(</span>
                <span class="s2">&quot;estwrite&quot;</span><span class="p">,</span>
                <span class="s2">&quot;estimate&quot;</span><span class="p">,</span>
                <span class="s2">&quot;write&quot;</span><span class="p">,</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">jobtype_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;quality&quot;</span><span class="p">,</span>
            <span class="n">Range</span><span class="p">(</span>
                <span class="n">value</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span>
                <span class="n">low</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                <span class="n">high</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">quality_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;separation&quot;</span><span class="p">,</span>
            <span class="n">Range</span><span class="p">(</span>
                <span class="n">value</span><span class="o">=</span><span class="mf">4.0</span><span class="p">,</span>
                <span class="n">low</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                <span class="n">high</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">separation_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;fwhm&quot;</span><span class="p">,</span>
            <span class="n">Range</span><span class="p">(</span>
                <span class="n">value</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span>
                <span class="n">low</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                <span class="n">high</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">fwhm_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;register_to_mean&quot;</span><span class="p">,</span>
            <span class="n">Bool</span><span class="p">(</span>
                <span class="kc">True</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">register_to_mean_desc</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;interp&quot;</span><span class="p">,</span>
            <span class="n">Range</span><span class="p">(</span>
                <span class="n">value</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                <span class="n">low</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">high</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">interp_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;wrap&quot;</span><span class="p">,</span>
            <span class="n">List</span><span class="p">(</span>
                <span class="n">value</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                <span class="n">trait</span><span class="o">=</span><span class="n">Range</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
                <span class="n">minlen</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                <span class="n">maxlen</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">wrap_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;weight_img&quot;</span><span class="p">,</span>
            <span class="n">File</span><span class="p">(</span>
                <span class="n">value</span><span class="o">=</span><span class="n">Undefined</span><span class="p">,</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">weight_img_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;write_which&quot;</span><span class="p">,</span>
            <span class="n">Enum</span><span class="p">(</span>
                <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">write_which_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;write_interp&quot;</span><span class="p">,</span>
            <span class="n">Range</span><span class="p">(</span>
                <span class="n">value</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
                <span class="n">low</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">high</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">write_interp_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;write_wrap&quot;</span><span class="p">,</span>
            <span class="n">List</span><span class="p">(</span>
                <span class="n">value</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                <span class="n">trait</span><span class="o">=</span><span class="n">Range</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
                <span class="n">minlen</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                <span class="n">maxlen</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">write_wrap_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;write_mask&quot;</span><span class="p">,</span>
            <span class="n">Bool</span><span class="p">(</span>
                <span class="n">default_value</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">write_mask_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;out_prefix&quot;</span><span class="p">,</span>
            <span class="n">String</span><span class="p">(</span>
                <span class="n">value</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">out_prefix_desc</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># Output traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;realigned_files&quot;</span><span class="p">,</span>
            <span class="n">OutputMultiPath</span><span class="p">(</span>
                <span class="n">Either</span><span class="p">(</span><span class="n">List</span><span class="p">(</span><span class="n">File</span><span class="p">()),</span> <span class="n">File</span><span class="p">()),</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">realigned_files_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;modified_in_files&quot;</span><span class="p">,</span>
            <span class="n">OutputMultiPath</span><span class="p">(</span>
                <span class="n">Either</span><span class="p">(</span><span class="n">List</span><span class="p">(</span><span class="n">File</span><span class="p">()),</span> <span class="n">File</span><span class="p">()),</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">modified_in_files_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;mean_image&quot;</span><span class="p">,</span>
            <span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">mean_image_desc</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;realignment_parameters&quot;</span><span class="p">,</span>
            <span class="n">OutputMultiPath</span><span class="p">(</span>
                <span class="n">File</span><span class="p">(),</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">realignment_parameters_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">init_default_traits</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_process</span><span class="p">(</span><span class="s2">&quot;nipype.interfaces.spm.Realign&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Realign.list_outputs"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.spm.html#mia_processes.bricks.preprocess.spm.spatial_preprocessing.Realign.list_outputs">[docs]</a>    <span class="k">def</span> <span class="nf">list_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_plugged</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the initialisation step of the brick.</span>

<span class="sd">        The main objective of this method is to produce the outputs of the</span>
<span class="sd">        bricks (self.outputs) and the associated tags (self.inheritance_dic),</span>
<span class="sd">        if defined here. In order not to include an output in the database,</span>
<span class="sd">        this output must be a value of the optional key &#39;notInDb&#39; of the</span>
<span class="sd">        self.outputs dictionary. To work properly this method must return</span>
<span class="sd">        self.make_initResult() object.</span>

<span class="sd">        :param is_plugged: the state, linked or not, of the plugs.</span>
<span class="sd">        :returns: a dictionary with requirement, outputs and inheritance_dict.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Using the inheritance to ProcessMIA class, list_outputs method</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Realign</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">list_outputs</span><span class="p">()</span>

        <span class="c1"># Outputs definition and tags inheritance (optional)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_files</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_files</span> <span class="o">!=</span> <span class="p">[</span><span class="n">Undefined</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">in_val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_files</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">in_val</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Realign brick: Currently only 4D in_files &quot;</span>
                        <span class="s2">&quot;are accepted !...</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_initResult</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">in_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_files</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_prefix</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">out_prefix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_prefix</span>

            <span class="c1"># The management of self.process.output_directory could be</span>
            <span class="c1"># delegated to the</span>
            <span class="c1"># populse_mia.user_interface.pipeline_manager.process_mia</span>
            <span class="c1"># module. We can&#39;t do it at the moment because the</span>
            <span class="c1"># sync_process_output_traits() of the</span>
            <span class="c1"># capsul/process/nipype_process module raises an exception</span>
            <span class="c1"># in nipype if the mandatory parameters are not yet defined!</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">output_directory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No output_directory was found...!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobtype</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">jobtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobtype</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_which</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">write_which</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_which</span>

            <span class="c1"># We define here the outputs because at the initialisation time</span>
            <span class="c1"># nipype can&#39;t do it (see #28)</span>
            <span class="c1"># TODO: We currently manage only self.in_files as 4D (it remains to</span>
            <span class="c1">#       manage the case when the data are a sequence of 3D</span>
            <span class="c1"># realigned_files:</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jobtype</span> <span class="o">==</span> <span class="s2">&quot;estimate&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_which</span> <span class="o">==</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="s2">&quot;write&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobtype</span>
            <span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;realigned_files&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Undefined</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;realigned_files&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="k">for</span> <span class="n">in_val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_files</span><span class="p">:</span>
                    <span class="n">_</span><span class="p">,</span> <span class="n">fileIval</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">in_val</span><span class="p">)</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_prefix</span><span class="p">:</span>
                        <span class="n">out_val</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_prefix</span> <span class="o">+</span> <span class="n">fileIval</span>
                        <span class="p">)</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">out_val</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span> <span class="o">+</span> <span class="n">fileIval</span>
                        <span class="p">)</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;realigned_files&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out_val</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">inheritance_dict</span><span class="p">[</span><span class="n">out_val</span><span class="p">]</span> <span class="o">=</span> <span class="n">in_val</span>
                    <span class="c1"># FIXME: In the latest version of mia, indexing of the</span>
                    <span class="c1">#        database with particular tags defined in the</span>
                    <span class="c1">#        processes is done only at the end of the</span>
                    <span class="c1">#        initialisation of the whole pipeline. So we</span>
                    <span class="c1">#        cannot use the value of these tags in other</span>
                    <span class="c1">#        processes of the pipeline at the time of</span>
                    <span class="c1">#        initialisation (see populse_mia #290). Until</span>
                    <span class="c1">#        better we use a quick and dirty hack with the</span>
                    <span class="c1">#        set_dbFieldValue() function !</span>

                    <span class="c1"># Add RepetitionTime tag:</span>
                    <span class="n">tag_to_add</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                    <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;RepetitionTime&quot;</span>
                    <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;field_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;float&quot;</span>
                    <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="s2">&quot;The period of time in msec between the &quot;</span>
                        <span class="s2">&quot;beginning of a pulse sequence and the &quot;</span>
                        <span class="s2">&quot;beginning of the succeeding pulse sequence&quot;</span>
                    <span class="p">)</span>
                    <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;visibility&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;origin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;user&quot;</span>
                    <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;unit&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;ms&quot;</span>
                    <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;default_value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_dbFieldValue</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="n">in_val</span><span class="p">,</span> <span class="s2">&quot;RepetitionTime&quot;</span>
                    <span class="p">)</span>

                    <span class="k">if</span> <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">set_dbFieldValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="n">out_val</span><span class="p">,</span> <span class="n">tag_to_add</span><span class="p">)</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span>
                            <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Realign brick:</span><span class="se">\n</span><span class="s2">The &#39;RepetitionTime&#39; tag &quot;</span>
                            <span class="s2">&quot;could not be added to the database for &quot;</span>
                            <span class="s2">&quot;the &#39;</span><span class="si">{}</span><span class="s2">&#39; parameter. This can lead to a &quot;</span>
                            <span class="s2">&quot;subsequent issue during &quot;</span>
                            <span class="s2">&quot;initialisation!!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">out_val</span><span class="p">)</span>
                        <span class="p">)</span>

                    <span class="c1"># Add Dataset dimensions (Count, X,Y,Z,T...) tag:</span>
                    <span class="n">tag_to_add</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                    <span class="n">tag_to_add</span><span class="p">[</span>
                        <span class="s2">&quot;name&quot;</span>
                    <span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Dataset dimensions (Count, X,Y,Z,T...)&quot;</span>
                    <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;field_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;int&quot;</span>
                    <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="s2">&quot;data array dimensions&quot;</span> <span class="s2">&quot; (from Nifti header)&quot;</span>
                    <span class="p">)</span>
                    <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;visibility&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;origin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;user&quot;</span>
                    <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;unit&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;default_value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_dbFieldValue</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span>
                        <span class="n">in_val</span><span class="p">,</span>
                        <span class="p">(</span><span class="s2">&quot;Dataset dimensions &quot;</span> <span class="s2">&quot;(Count, X,Y,Z,T...)&quot;</span><span class="p">),</span>
                    <span class="p">)</span>

                    <span class="k">if</span> <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">set_dbFieldValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="n">out_val</span><span class="p">,</span> <span class="n">tag_to_add</span><span class="p">)</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span>
                            <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Realign brick:</span><span class="se">\n</span><span class="s2">The &#39;Dataset dimensions &quot;</span>
                            <span class="s2">&quot;(Count, X,Y,Z,T...)&#39; tag could not be &quot;</span>
                            <span class="s2">&quot;added to the database for the &#39;</span><span class="si">{}</span><span class="s2">&#39; &quot;</span>
                            <span class="s2">&quot;parameter. This can lead to a &quot;</span>
                            <span class="s2">&quot;subsequent issue during &quot;</span>
                            <span class="s2">&quot;initialization!!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">out_val</span><span class="p">)</span>
                        <span class="p">)</span>

                    <span class="c1"># Add PatientName tag:</span>
                    <span class="n">tag_to_add</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                    <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;PatientName&quot;</span>
                    <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;field_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;string&quot;</span>
                    <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                    <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;visibility&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;origin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;user&quot;</span>
                    <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;unit&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;default_value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_dbFieldValue</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="n">in_val</span><span class="p">,</span> <span class="s2">&quot;PatientName&quot;</span>
                    <span class="p">)</span>

                    <span class="k">if</span> <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">set_dbFieldValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="n">out_val</span><span class="p">,</span> <span class="n">tag_to_add</span><span class="p">)</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span>
                            <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Realign brick:</span><span class="se">\n</span><span class="s2">The &#39;PatientName&#39; tag could &quot;</span>
                            <span class="s2">&quot;not be added to the database for the &#39;</span><span class="si">{}</span><span class="s2">&#39; &quot;</span>
                            <span class="s2">&quot;parameter. This can lead to a subsequent issue &quot;</span>
                            <span class="s2">&quot;during initialization!!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">out_val</span><span class="p">)</span>
                        <span class="p">)</span>

                    <span class="c1"># Add Age tag:</span>
                    <span class="n">age</span> <span class="o">=</span> <span class="n">get_dbFieldValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="n">in_val</span><span class="p">,</span> <span class="s2">&quot;Age&quot;</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">age</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">tag_to_add</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Age&quot;</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;field_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;int&quot;</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;visibility&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;origin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;user&quot;</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;unit&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;default_value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">age</span>
                        <span class="n">set_dbFieldValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="n">out_val</span><span class="p">,</span> <span class="n">tag_to_add</span><span class="p">)</span>

                    <span class="c1"># Add Pathology tag:</span>
                    <span class="n">pathology</span> <span class="o">=</span> <span class="n">get_dbFieldValue</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="n">in_val</span><span class="p">,</span> <span class="s2">&quot;Pathology&quot;</span>
                    <span class="p">)</span>

                    <span class="k">if</span> <span class="n">pathology</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">tag_to_add</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Pathology&quot;</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;field_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;string&quot;</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;visibility&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;origin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;user&quot;</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;unit&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;default_value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pathology</span>
                        <span class="n">set_dbFieldValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="n">out_val</span><span class="p">,</span> <span class="n">tag_to_add</span><span class="p">)</span>

            <span class="c1"># modified_in_files</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobtype</span> <span class="o">==</span> <span class="s2">&quot;write&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;modified_in_files&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Undefined</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;modified_in_files&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="k">for</span> <span class="n">in_val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_files</span><span class="p">:</span>
                    <span class="n">_</span><span class="p">,</span> <span class="n">fileIval</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">in_val</span><span class="p">)</span>
                    <span class="n">out_val</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span> <span class="n">fileIval</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;modified_in_files&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out_val</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">inheritance_dict</span><span class="p">[</span><span class="n">out_val</span><span class="p">]</span> <span class="o">=</span> <span class="n">in_val</span>

            <span class="c1"># mean_image</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jobtype</span> <span class="o">==</span> <span class="s2">&quot;estimate&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_which</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="s2">&quot;write&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobtype</span>
            <span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;mean_image&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Undefined</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">first_val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_files</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">_</span><span class="p">,</span> <span class="n">fileIval</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">first_val</span><span class="p">)</span>
                <span class="n">out_val</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span> <span class="s2">&quot;mean&quot;</span> <span class="o">+</span> <span class="n">fileIval</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;mean_image&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">out_val</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">inheritance_dict</span><span class="p">[</span><span class="n">out_val</span><span class="p">]</span> <span class="o">=</span> <span class="n">in_val</span>

            <span class="c1"># realignment_parameters</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobtype</span> <span class="o">==</span> <span class="s2">&quot;write&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;realignment_parameters&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Undefined</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;realignment_parameters&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="k">for</span> <span class="n">in_val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_files</span><span class="p">:</span>
                    <span class="n">_</span><span class="p">,</span> <span class="n">fileIval</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">in_val</span><span class="p">)</span>
                    <span class="n">fileIval</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">fileIval</span><span class="p">)</span>
                    <span class="n">out_val</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span> <span class="s2">&quot;rp_&quot;</span> <span class="o">+</span> <span class="n">fileIval</span> <span class="o">+</span> <span class="s2">&quot;.txt&quot;</span>
                    <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;realignment_parameters&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out_val</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">inheritance_dict</span><span class="p">[</span><span class="n">out_val</span><span class="p">]</span> <span class="o">=</span> <span class="n">in_val</span>

        <span class="c1"># Return the requirement, outputs and inheritance_dict</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_initResult</span><span class="p">()</span></div>

<div class="viewcode-block" id="Realign.run_process_mia"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.spm.html#mia_processes.bricks.preprocess.spm.spatial_preprocessing.Realign.run_process_mia">[docs]</a>    <span class="k">def</span> <span class="nf">run_process_mia</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the process launch step of the brick.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Realign</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">run_process_mia</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">in_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_files</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_prefix</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">out_prefix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_prefix</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">jobtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobtype</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">quality</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">quality</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">separation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">separation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">fwhm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fwhm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">register_to_mean</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register_to_mean</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">interp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">wrap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wrap</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">weight_img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight_img</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">write_which</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_which</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">write_interp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_interp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">write_wrap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_wrap</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">write_mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_mask</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">configuration_dict</span><span class="o">=</span><span class="p">{})</span></div></div>


<div class="viewcode-block" id="SliceTiming"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.spm.html#mia_processes.bricks.preprocess.spm.spatial_preprocessing.SliceTiming">[docs]</a><span class="k">class</span> <span class="nc">SliceTiming</span><span class="p">(</span><span class="n">ProcessMIA</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    *Temporal correction to get back every slice at the same acquisition time*</span>

<span class="sd">    Please, see the complete documentation for the</span>
<span class="sd">    `SliceTiming brick in the populse.mia_processes web site</span>
<span class="sd">    &lt;https://populse.github.io/mia_processes/html/documentation/bricks/preprocess/spm/SliceTiming.html&gt;`</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="SliceTiming.__init__"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.spm.html#mia_processes.bricks.preprocess.spm.spatial_preprocessing.SliceTiming.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the attributes initialisation / instantiation.</span>

<span class="sd">        The input and output plugs are defined here. The special</span>
<span class="sd">        &#39;self.requirement&#39; attribute (optional) is used to define the</span>
<span class="sd">        third-party products necessary for the running of the brick.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Initialisation of the objects needed for the launch of the brick</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SliceTiming</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1"># Third party softwares required for the execution of the brick</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requirement</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;spm&quot;</span><span class="p">,</span> <span class="s2">&quot;nipype&quot;</span><span class="p">]</span>

        <span class="c1"># Inputs description</span>
        <span class="n">desc_in_file</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;The images to be brought back to the reference slice &quot;</span>
            <span class="s2">&quot;time (a list of pathlike objects or string &quot;</span>
            <span class="s2">&quot;representing a file or of list of items which are a &quot;</span>
            <span class="s2">&quot;pathlike object or strings representing a file or a &quot;</span>
            <span class="s2">&quot;_Undefined or None)&quot;</span>
        <span class="p">)</span>
        <span class="n">desc_acquisition</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s1">&#39;Type of image acquisition (one of &quot;sequential &#39;</span>
            <span class="s1">&#39;ascending&quot;, &quot;sequential descending&quot;, &quot;interleaved &#39;</span>
            <span class="s1">&#39;(middle-top)&quot;, &quot;interleaved (bottom-up)&quot;, &#39;</span>
            <span class="s1">&#39;&quot;interleaved (top-down)&quot;). From the acquisition &#39;</span>
            <span class="s2">&quot;parameter the slice_order parameter can be &quot;</span>
            <span class="s2">&quot;calculated automatically&quot;</span>
        <span class="p">)</span>
        <span class="n">desc_num_slices</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Number of slices in the in_file (an integer). &quot;</span>
            <span class="s2">&quot;Can be automatically retrieved from the database&quot;</span>
        <span class="p">)</span>
        <span class="n">desc_TR</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Repetition time in the in_file (a float, in seconds). &quot;</span>
            <span class="s2">&quot;Can be automatically retrieved from the database&quot;</span>
        <span class="p">)</span>
        <span class="n">desc_TA</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Time of volume acquisition (a float, in seconds). Can be &quot;</span>
            <span class="s2">&quot;automatically calculated as TR-(TR/num_slices)&quot;</span>
        <span class="p">)</span>
        <span class="n">desc_slice_order</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Order of how were recorded the slices during the &quot;</span>
            <span class="s2">&quot;volumes aquisition (a list of items which are &quot;</span>
            <span class="s2">&quot;an integer or a float or a _Undefined or None. &quot;</span>
            <span class="s2">&quot;Can be automatically calculated according to the &quot;</span>
            <span class="s1">&#39;acquisition&quot; parameter)&#39;</span>
        <span class="p">)</span>
        <span class="n">desc_ref_slice</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;The chosen reference slice, will serve as the &quot;</span>
            <span class="s2">&quot;reference for the other slices during the &quot;</span>
            <span class="s2">&quot;correction (an integer or a float or an _Undefined &quot;</span>
            <span class="s2">&quot;or None). A default value is calculated according &quot;</span>
            <span class="s1">&#39;to the &quot;acquisition&quot; parameter&#39;</span>
        <span class="p">)</span>
        <span class="n">desc_out_prefix</span> <span class="o">=</span> <span class="s2">&quot;SliceTiming routine output prefix (a string)&quot;</span>

        <span class="c1"># Outputs description</span>
        <span class="n">desc_timed_files</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;The image after the SliceTiming correction (a &quot;</span>
            <span class="s2">&quot;pathlike object or string representing a file)&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Input traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;in_files&quot;</span><span class="p">,</span>
            <span class="n">InputMultiPath</span><span class="p">(</span>
                <span class="n">Either</span><span class="p">(</span><span class="n">ImageFileSPM</span><span class="p">(),</span> <span class="n">List</span><span class="p">(</span><span class="n">ImageFileSPM</span><span class="p">()),</span> <span class="n">Undefined</span><span class="p">),</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">desc_in_file</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;acquisition&quot;</span><span class="p">,</span>
            <span class="n">Enum</span><span class="p">(</span>
                <span class="s2">&quot;sequential ascending&quot;</span><span class="p">,</span>
                <span class="s2">&quot;sequential descending&quot;</span><span class="p">,</span>
                <span class="s2">&quot;interleaved (middle-top)&quot;</span><span class="p">,</span>
                <span class="s2">&quot;interleaved (bottom-up)&quot;</span><span class="p">,</span>
                <span class="s2">&quot;interleaved (top-down)&quot;</span><span class="p">,</span>
                <span class="n">value</span><span class="o">=</span><span class="s2">&quot;sequential ascending&quot;</span><span class="p">,</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">desc_acquisition</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;num_slices&quot;</span><span class="p">,</span>
            <span class="n">Either</span><span class="p">(</span>
                <span class="n">Int</span><span class="p">(),</span>
                <span class="n">Undefined</span><span class="p">,</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">desc_num_slices</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_slices</span> <span class="o">=</span> <span class="n">Undefined</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;TR&quot;</span><span class="p">,</span>
            <span class="n">Either</span><span class="p">(</span>
                <span class="n">Float</span><span class="p">(),</span> <span class="n">Undefined</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">desc_TR</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">TR</span> <span class="o">=</span> <span class="n">Undefined</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;TA&quot;</span><span class="p">,</span>
            <span class="n">Either</span><span class="p">(</span>
                <span class="n">Float</span><span class="p">(),</span> <span class="n">Undefined</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">desc_TA</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">TA</span> <span class="o">=</span> <span class="n">Undefined</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;slice_order&quot;</span><span class="p">,</span>
            <span class="n">Either</span><span class="p">(</span>
                <span class="n">List</span><span class="p">(</span><span class="n">Either</span><span class="p">(</span><span class="n">Int</span><span class="p">(),</span> <span class="n">Float</span><span class="p">())),</span>
                <span class="n">Undefined</span><span class="p">,</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">desc_slice_order</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slice_order</span> <span class="o">=</span> <span class="n">Undefined</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;ref_slice&quot;</span><span class="p">,</span>
            <span class="n">Either</span><span class="p">(</span>
                <span class="n">Int</span><span class="p">(),</span>
                <span class="n">Float</span><span class="p">(),</span>
                <span class="n">Undefined</span><span class="p">,</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">desc_ref_slice</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ref_slice</span> <span class="o">=</span> <span class="n">Undefined</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;out_prefix&quot;</span><span class="p">,</span>
            <span class="n">String</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">desc_out_prefix</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># Output traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;timed_files&quot;</span><span class="p">,</span>
            <span class="n">OutputMultiPath</span><span class="p">(</span><span class="n">File</span><span class="p">(),</span> <span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">desc_timed_files</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">init_default_traits</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_process</span><span class="p">(</span><span class="s2">&quot;nipype.interfaces.spm.SliceTiming&quot;</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_get_database_value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;sets default values for certain parameters.</span>

<span class="sd">        If the following parameters are undefined, this method attempts to give</span>
<span class="sd">        them a value from the database or by making a calculation from other</span>
<span class="sd">        known parameters:</span>
<span class="sd">        - num_slices (from database)</span>
<span class="sd">        - TR (from database)</span>
<span class="sd">        - TA (from TR-(TR/num_slices))</span>
<span class="sd">        - slice_order (from the &quot;acquisition&quot; parameter value)</span>
<span class="sd">        - ref_slice (from the &quot;acquisition&quot; parameter value)</span>

<span class="sd">        :returns: True if no problem is detected, otherwise False</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># FIXME: If several data are entered in in_files parameter, we use the</span>
        <span class="c1"># first element to determine, from the database, few calculation</span>
        <span class="c1"># parameters. These calculation parameters must be identical for all</span>
        <span class="c1"># data in in_files. Currently there is no verification to see if it&#39;s</span>
        <span class="c1"># true (e.g. do all data have the same slice number?, etc.).</span>
        <span class="n">result</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">complete_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_files</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">file_position</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">complete_path</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">getName</span><span class="p">())</span>
            <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">getName</span><span class="p">())</span>
            <span class="o">+</span> <span class="mi">1</span>
        <span class="p">)</span>
        <span class="n">database_filename</span> <span class="o">=</span> <span class="n">complete_path</span><span class="p">[</span><span class="n">file_position</span><span class="p">:]</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="s2">&quot;Dataset dimensions (Count, X,Y,Z,T...)&quot;</span>
            <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get_fields_names</span><span class="p">(</span><span class="n">COLLECTION_CURRENT</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="n">temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span>
                <span class="n">COLLECTION_CURRENT</span><span class="p">,</span>
                <span class="n">database_filename</span><span class="p">,</span>
                <span class="p">(</span><span class="s2">&quot;Dataset dimensions &quot;</span> <span class="s2">&quot;(Count, X,Y,Z,T...)&quot;</span><span class="p">),</span>
            <span class="p">)[</span><span class="mi">3</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_slices</span> <span class="o">==</span> <span class="n">Undefined</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">temp</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">num_slices</span> <span class="o">=</span> <span class="n">temp</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="n">QMessageBox</span><span class="p">()</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">setIcon</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Warning</span><span class="p">)</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="s2">&quot;Mia_processes - &quot;</span> <span class="s2">&quot;SliceTiming Error!&quot;</span><span class="p">)</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span>
                    <span class="s2">&quot;Warning: the value of the num_slices parameter &quot;</span>
                    <span class="s2">&quot;was not found in the database. &quot;</span>
                    <span class="s2">&quot;Please check the data.&quot;</span>
                <span class="p">)</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">setStandardButtons</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Close</span><span class="p">)</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">buttonClicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">exec</span><span class="p">()</span>
                <span class="n">result</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">temp</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_slices</span> <span class="o">!=</span> <span class="n">temp</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="n">QMessageBox</span><span class="p">()</span>
                    <span class="n">msg</span><span class="o">.</span><span class="n">setIcon</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Warning</span><span class="p">)</span>
                    <span class="n">msg</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="s2">&quot;Mia_processes - &quot;</span> <span class="s2">&quot;SliceTiming Error!&quot;</span><span class="p">)</span>
                    <span class="n">msg</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span>
                        <span class="s2">&quot;Warning: The value for the num_slices &quot;</span>
                        <span class="s2">&quot;parameter does not match the value in the &quot;</span>
                        <span class="s2">&quot;database. Please check the data.&quot;</span>
                    <span class="p">)</span>
                    <span class="n">msg</span><span class="o">.</span><span class="n">setStandardButtons</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Close</span><span class="p">)</span>
                    <span class="n">msg</span><span class="o">.</span><span class="n">buttonClicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
                    <span class="n">msg</span><span class="o">.</span><span class="n">exec</span><span class="p">()</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">temp</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="s2">&quot;RepetitionTime&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get_fields_names</span><span class="p">(</span>
            <span class="n">COLLECTION_CURRENT</span>
        <span class="p">):</span>
            <span class="n">temp</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span>
                    <span class="n">COLLECTION_CURRENT</span><span class="p">,</span> <span class="n">database_filename</span><span class="p">,</span> <span class="s2">&quot;RepetitionTime&quot;</span>
                <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="o">/</span> <span class="mi">1000</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">TR</span> <span class="o">==</span> <span class="n">Undefined</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">temp</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">TR</span> <span class="o">=</span> <span class="n">temp</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="n">QMessageBox</span><span class="p">()</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">setIcon</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Warning</span><span class="p">)</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="s2">&quot;Mia_processes - &quot;</span> <span class="s2">&quot;SliceTiming Error!&quot;</span><span class="p">)</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span>
                    <span class="s2">&quot;Warning: the value of the TR parameter &quot;</span>
                    <span class="s2">&quot;was not found in the database. &quot;</span>
                    <span class="s2">&quot;Please check the data.&quot;</span>
                <span class="p">)</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">setStandardButtons</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Close</span><span class="p">)</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">buttonClicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">exec</span><span class="p">()</span>
                <span class="n">result</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">temp</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">TR</span> <span class="o">!=</span> <span class="n">temp</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="n">QMessageBox</span><span class="p">()</span>
                    <span class="n">msg</span><span class="o">.</span><span class="n">setIcon</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Warning</span><span class="p">)</span>
                    <span class="n">msg</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="s2">&quot;Mia_processes - &quot;</span> <span class="s2">&quot;SliceTiming Error!&quot;</span><span class="p">)</span>
                    <span class="n">msg</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span>
                        <span class="s2">&quot;Warning: The value for the TR &quot;</span>
                        <span class="s2">&quot;parameter does not match the value in the &quot;</span>
                        <span class="s2">&quot;database. Please check the data.&quot;</span>
                    <span class="p">)</span>
                    <span class="n">msg</span><span class="o">.</span><span class="n">setStandardButtons</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Close</span><span class="p">)</span>
                    <span class="n">msg</span><span class="o">.</span><span class="n">buttonClicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
                    <span class="n">msg</span><span class="o">.</span><span class="n">exec</span><span class="p">()</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># FIXME: in SPM, TA can be egal to 0 (If slice_order and</span>
        <span class="c1"># ref_slice are entered in milliseconds, TA will not be used and</span>
        <span class="c1"># can be set to 0). Here we consider that slice_order and</span>
        <span class="c1"># ref_slice paramters are only indices !</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">TA</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">TR</span> <span class="o">!=</span> <span class="n">Undefined</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_slices</span> <span class="o">!=</span> <span class="n">Undefined</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">TA</span> <span class="o">!=</span> <span class="n">Undefined</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">TA</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TR</span> <span class="o">-</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TR</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_slices</span><span class="p">):</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="n">QMessageBox</span><span class="p">()</span>
                        <span class="n">msg</span><span class="o">.</span><span class="n">setIcon</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Warning</span><span class="p">)</span>
                        <span class="n">msg</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span>
                            <span class="s2">&quot;Mia_processes - &quot;</span> <span class="s2">&quot;SliceTiming Error!&quot;</span>
                        <span class="p">)</span>
                        <span class="n">msg</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span>
                            <span class="s2">&quot;Warning: the value of the TA parameter &quot;</span>
                            <span class="s2">&quot;doesn&#39;t exactly match the other &quot;</span>
                            <span class="s2">&quot;parameters. Please check the data.&quot;</span>
                        <span class="p">)</span>
                        <span class="n">msg</span><span class="o">.</span><span class="n">setStandardButtons</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Close</span><span class="p">)</span>
                        <span class="n">msg</span><span class="o">.</span><span class="n">buttonClicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
                        <span class="n">msg</span><span class="o">.</span><span class="n">exec</span><span class="p">()</span>
                        <span class="n">result</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">TA</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TR</span> <span class="o">-</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TR</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_slices</span><span class="p">)</span>

            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">TA</span> <span class="o">==</span> <span class="n">Undefined</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="n">QMessageBox</span><span class="p">()</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">setIcon</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Warning</span><span class="p">)</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="s2">&quot;Mia_processes - &quot;</span> <span class="s2">&quot;SliceTiming Error!&quot;</span><span class="p">)</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span>
                    <span class="s2">&quot;The value of TR or num_slices parameters was not &quot;</span>
                    <span class="s2">&quot;found in the database, then the TA parameter &quot;</span>
                    <span class="s2">&quot;could not be calculated automatically. Please &quot;</span>
                    <span class="s2">&quot;check the data.&quot;</span>
                <span class="p">)</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">setStandardButtons</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Close</span><span class="p">)</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">buttonClicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">exec</span><span class="p">()</span>
                <span class="n">result</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">slice_order</span> <span class="o">!=</span> <span class="n">Undefined</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slice_order</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_slices</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="n">QMessageBox</span><span class="p">()</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">setIcon</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Warning</span><span class="p">)</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="s2">&quot;Mia_processes - SliceTiming Error!&quot;</span><span class="p">)</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span>
                    <span class="s2">&quot;Warning: the slice_order parameter doesn&#39;t &quot;</span>
                    <span class="s2">&quot;match the num_slices parameter. Please check the &quot;</span>
                    <span class="s2">&quot;data.&quot;</span>
                <span class="p">)</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">setStandardButtons</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Close</span><span class="p">)</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">buttonClicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">exec</span><span class="p">()</span>
                <span class="n">result</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_slices</span> <span class="o">!=</span> <span class="n">Undefined</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">acquisition</span> <span class="o">==</span> <span class="s2">&quot;sequential ascending&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">slice_order</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_slices</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">acquisition</span> <span class="o">==</span> <span class="s2">&quot;sequential descending&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">slice_order</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_slices</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">acquisition</span> <span class="o">==</span> <span class="s2">&quot;interleaved (middle-top)&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">slice_order</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">zip_longest</span><span class="p">)(</span>
                    <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_slices</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)),</span>
                    <span class="nb">list</span><span class="p">(</span>
                        <span class="nb">range</span><span class="p">(</span>
                            <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_slices</span><span class="p">),</span>
                            <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_slices</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>
                            <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="p">),</span>
                <span class="p">):</span>
                    <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_slices</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">slice_order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">slice_order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">slice_order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">slice_order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>

                <span class="k">if</span> <span class="kc">None</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">slice_order</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">slice_order</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">acquisition</span> <span class="o">==</span> <span class="s2">&quot;interleaved (bottom-up)&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">slice_order</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
                    <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_slices</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                <span class="p">)</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_slices</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">acquisition</span> <span class="o">==</span> <span class="s2">&quot;interleaved (top-down)&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">slice_order</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_slices</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">))</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span>
                    <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_slices</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">)</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">TA</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">TR</span> <span class="o">!=</span> <span class="n">Undefined</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">slice_order</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TR</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_slices</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">slice_order</span>
                <span class="p">]</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">QMessageBox</span><span class="p">()</span>
            <span class="n">msg</span><span class="o">.</span><span class="n">setIcon</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Warning</span><span class="p">)</span>
            <span class="n">msg</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="s2">&quot;Mia_processes - SliceTiming Error!&quot;</span><span class="p">)</span>
            <span class="n">msg</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span>
                <span class="s2">&quot;Warning: As the num_slices parameter was not found in &quot;</span>
                <span class="s2">&quot;the database, it was not possible to determine the &quot;</span>
                <span class="s2">&quot;slice_order parameter automatically. Please check the &quot;</span>
                <span class="s2">&quot;data.&quot;</span>
            <span class="p">)</span>
            <span class="n">msg</span><span class="o">.</span><span class="n">setStandardButtons</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Close</span><span class="p">)</span>
            <span class="n">msg</span><span class="o">.</span><span class="n">buttonClicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
            <span class="n">msg</span><span class="o">.</span><span class="n">exec</span><span class="p">()</span>
            <span class="n">result</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_slice</span> <span class="o">==</span> <span class="n">Undefined</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">acquisition</span> <span class="o">==</span> <span class="s2">&quot;sequential ascending&quot;</span>
                <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">acquisition</span> <span class="o">==</span> <span class="s2">&quot;sequential descending&quot;</span>
            <span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_slices</span> <span class="o">!=</span> <span class="n">Undefined</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ref_slice</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_slices</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="n">QMessageBox</span><span class="p">()</span>
                    <span class="n">msg</span><span class="o">.</span><span class="n">setIcon</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Warning</span><span class="p">)</span>
                    <span class="n">msg</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="s2">&quot;Mia_processes - SliceTiming &quot;</span> <span class="s2">&quot;Error!&quot;</span><span class="p">)</span>
                    <span class="n">msg</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span>
                        <span class="s2">&quot;Warning: It was not possible to determine the &quot;</span>
                        <span class="s2">&quot;ref_slice parameter automatically. Please &quot;</span>
                        <span class="s2">&quot;check the data.&quot;</span>
                    <span class="p">)</span>
                    <span class="n">msg</span><span class="o">.</span><span class="n">setStandardButtons</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Close</span><span class="p">)</span>
                    <span class="n">msg</span><span class="o">.</span><span class="n">buttonClicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
                    <span class="n">msg</span><span class="o">.</span><span class="n">exec</span><span class="p">()</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ref_slice</span> <span class="o">=</span> <span class="mi">1</span>

            <span class="k">if</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">TA</span> <span class="o">==</span> <span class="mi">0</span>
                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">TR</span> <span class="o">!=</span> <span class="n">Undefined</span>
                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_slices</span> <span class="o">!=</span> <span class="n">Undefined</span>
            <span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ref_slice</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ref_slice</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">TR</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_slices</span> <span class="o">*</span> <span class="mi">1000</span>
                <span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span>

<div class="viewcode-block" id="SliceTiming.list_outputs"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.spm.html#mia_processes.bricks.preprocess.spm.spatial_preprocessing.SliceTiming.list_outputs">[docs]</a>    <span class="k">def</span> <span class="nf">list_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_plugged</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the initialisation step of the brick.</span>

<span class="sd">        The main objective of this method is to produce the outputs of the</span>
<span class="sd">        bricks (self.outputs) and the associated tags (self.inheritance_dic),</span>
<span class="sd">        if defined here. In order not to include an output in the database,</span>
<span class="sd">        this output must be a value of the optional key &#39;notInDb&#39; of the</span>
<span class="sd">        self.outputs dictionary. To work properly this method must return</span>
<span class="sd">        self.make_initResult() object.</span>

<span class="sd">        :param is_plugged: the state, linked or not, of the plugs.</span>
<span class="sd">        :returns: a dictionary with requirement, outputs and inheritance_dict.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Using the inheritance to ProcessMIA class, list_outputs method</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SliceTiming</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">list_outputs</span><span class="p">()</span>

        <span class="c1"># Outputs definition and tags inheritance (optional)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_files</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_files</span> <span class="o">!=</span> <span class="p">[</span><span class="n">Undefined</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">in_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_files</span>
            <span class="c1"># Definition of the necessary inputs for the spm fonction</span>
            <span class="c1"># acquired from the databse</span>
            <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_database_value</span><span class="p">()</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">res</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_initResult</span><span class="p">()</span>

            <span class="k">if</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">num_slices</span> <span class="o">!=</span> <span class="n">Undefined</span>
                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">TR</span> <span class="o">!=</span> <span class="n">Undefined</span>
                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">TA</span> <span class="o">!=</span> <span class="n">Undefined</span>
                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">slice_order</span> <span class="o">!=</span> <span class="n">Undefined</span>
                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_slice</span> <span class="o">!=</span> <span class="n">Undefined</span>
            <span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_prefix</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">out_prefix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_prefix</span>
                <span class="c1"># The management of self.process.output_directory could be</span>
                <span class="c1"># delegated to the</span>
                <span class="c1"># populse_mia.user_interface.pipeline_manager.process_mia</span>
                <span class="c1"># module. We can&#39;t do it at the moment because the</span>
                <span class="c1"># sync_process_output_traits() of the</span>
                <span class="c1"># capsul/process/nipype_process module raises an exception</span>
                <span class="c1"># in nipype if the mandatory parameters are not yet defined!</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">output_directory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No output_directory was found...!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;timed_files&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">_timecorrected_files</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;timed_files&quot;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                        <span class="n">val</span> <span class="o">=</span> <span class="p">[</span><span class="n">val</span><span class="p">]</span>

                    <span class="k">for</span> <span class="n">in_val</span><span class="p">,</span> <span class="n">out_val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_files</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
                        <span class="n">_</span><span class="p">,</span> <span class="n">fileOval</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">out_val</span><span class="p">)</span>
                        <span class="n">_</span><span class="p">,</span> <span class="n">fileIval</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">in_val</span><span class="p">)</span>

                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_prefix</span><span class="p">:</span>
                            <span class="c1"># fmt: off</span>
                            <span class="n">fileOvalNoPref</span> <span class="o">=</span> <span class="n">fileOval</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">out_prefix</span><span class="p">):]</span>
                            <span class="c1"># fmt: on</span>

                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># fmt: off</span>
                            <span class="n">fileOvalNoPref</span> <span class="o">=</span> <span class="n">fileOval</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="s2">&quot;s&quot;</span><span class="p">):]</span>
                            <span class="c1"># fmt: on</span>

                        <span class="k">if</span> <span class="n">fileOvalNoPref</span> <span class="o">==</span> <span class="n">fileIval</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">inheritance_dict</span><span class="p">[</span><span class="n">out_val</span><span class="p">]</span> <span class="o">=</span> <span class="n">in_val</span>

        <span class="c1"># Return the requirement, outputs and inheritance_dict</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_initResult</span><span class="p">()</span></div>

<div class="viewcode-block" id="SliceTiming.run_process_mia"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.spm.html#mia_processes.bricks.preprocess.spm.spatial_preprocessing.SliceTiming.run_process_mia">[docs]</a>    <span class="k">def</span> <span class="nf">run_process_mia</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the process launch step of the brick.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SliceTiming</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">run_process_mia</span><span class="p">()</span>

        <span class="c1"># in_files parameter are normally already in absolute path format.</span>
        <span class="c1"># So, the 3 next lines can be see as &quot;in case of&quot;...</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">element</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_files</span><span class="p">):</span>
            <span class="n">full_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">in_files</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">full_path</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">in_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_files</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">num_slices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_slices</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">time_repetition</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TR</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">time_acquisition</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TA</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">slice_order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slice_order</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">ref_slice</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_slice</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_prefix</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">out_prefix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_prefix</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">configuration_dict</span><span class="o">=</span><span class="p">{})</span></div></div>


<div class="viewcode-block" id="Smooth"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.spm.html#mia_processes.bricks.preprocess.spm.spatial_preprocessing.Smooth">[docs]</a><span class="k">class</span> <span class="nc">Smooth</span><span class="p">(</span><span class="n">ProcessMIA</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    *3D Gaussian smoothing of image volumes*</span>

<span class="sd">    Please, see the complete documention for the</span>
<span class="sd">    `Smooth brick in the populse.mia_processes web site</span>
<span class="sd">    &lt;https://populse.github.io/mia_processes/html/documentation/bricks/preprocess/spm/Smooth.html&gt;`_</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Smooth.__init__"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.spm.html#mia_processes.bricks.preprocess.spm.spatial_preprocessing.Smooth.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the attributes initialisation/instantiation.</span>

<span class="sd">        The input and output plugs are defined here. The special</span>
<span class="sd">        &#39;self.requirement&#39; attribute (optional) is used to define the</span>
<span class="sd">        third-party products necessary for the running of the brick.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Initialisation of the objects needed for the launch of the brick</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Smooth</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1"># Third party softwares required for the execution of the brick</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requirement</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;spm&quot;</span><span class="p">,</span> <span class="s2">&quot;nipype&quot;</span><span class="p">]</span>

        <span class="c1"># Inputs description</span>
        <span class="n">in_files_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;List of files to smooth. A list of items which are &quot;</span>
            <span class="s2">&quot;an existing, uncompressed file &quot;</span>
            <span class="s2">&quot;(valid extensions: [.img, .nii, .hdr]).&quot;</span>
        <span class="p">)</span>
        <span class="n">fwhm_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Full-width at half maximum (FWHM) of the Gaussian &quot;</span>
            <span class="s2">&quot;smoothing kernel in mm (a float or a list of 3 items &quot;</span>
            <span class="s2">&quot;which are a float).&quot;</span>
        <span class="p">)</span>
        <span class="n">data_type_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Data type of the output images &quot;</span> <span class="s2">&quot;(an integer [int or long]).&quot;</span>
        <span class="p">)</span>
        <span class="n">implicit_masking_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;A mask implied by a particular voxel value &quot;</span> <span class="s2">&quot;(a boolean).&quot;</span>
        <span class="p">)</span>
        <span class="n">out_prefix_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Specify the string to be prepended to the &quot;</span>
            <span class="s2">&quot;filenames of the smoothed image file(s) &quot;</span>
            <span class="s2">&quot;(a string).&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Outputs description</span>
        <span class="n">smoothed_files_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;The smoothed files (a pathlike object or &quot;</span>
            <span class="s2">&quot;string representing a file, or a list of &quot;</span>
            <span class="s2">&quot;pathlike objects or strings representing a &quot;</span>
            <span class="s2">&quot;file).&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Input traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;in_files&quot;</span><span class="p">,</span>
            <span class="n">InputMultiPath</span><span class="p">(</span>
                <span class="n">Either</span><span class="p">(</span><span class="n">ImageFileSPM</span><span class="p">(),</span> <span class="n">Undefined</span><span class="p">),</span>
                <span class="n">copyfile</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">in_files_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;fwhm&quot;</span><span class="p">,</span>
            <span class="n">Either</span><span class="p">(</span>
                <span class="n">Float</span><span class="p">(),</span>
                <span class="n">List</span><span class="p">(</span><span class="n">Float</span><span class="p">(),</span> <span class="n">minlen</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">maxlen</span><span class="o">=</span><span class="mi">3</span><span class="p">),</span>
                <span class="n">default</span><span class="o">=</span><span class="p">[</span><span class="mf">6.0</span><span class="p">,</span> <span class="mf">6.0</span><span class="p">,</span> <span class="mf">6.0</span><span class="p">],</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">fwhm_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;data_type&quot;</span><span class="p">,</span> <span class="n">Int</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">data_type_desc</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;implicit_masking&quot;</span><span class="p">,</span>
            <span class="n">Bool</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">implicit_masking_desc</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;out_prefix&quot;</span><span class="p">,</span>
            <span class="n">String</span><span class="p">(</span><span class="s2">&quot;s&quot;</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">out_prefix_desc</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># Output traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;smoothed_files&quot;</span><span class="p">,</span>
            <span class="n">OutputMultiPath</span><span class="p">(</span><span class="n">File</span><span class="p">(),</span> <span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">smoothed_files_desc</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">init_default_traits</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_process</span><span class="p">(</span><span class="s2">&quot;nipype.interfaces.spm.Smooth&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Smooth.list_outputs"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.spm.html#mia_processes.bricks.preprocess.spm.spatial_preprocessing.Smooth.list_outputs">[docs]</a>    <span class="k">def</span> <span class="nf">list_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_plugged</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the initialisation step of the brick.</span>

<span class="sd">        The main objective of this method is to produce the outputs of the</span>
<span class="sd">        bricks (self.outputs) and the associated tags (self.inheritance_dic),</span>
<span class="sd">        if defined here. In order not to include an output in the database,</span>
<span class="sd">        this output must be a value of the optional key &#39;notInDb&#39; of the</span>
<span class="sd">        self.outputs dictionary. To work properly this method must return</span>
<span class="sd">        self.make_initResult() object.</span>

<span class="sd">        :param is_plugged: the state, linked or not, of the plugs.</span>
<span class="sd">        :returns: a dictionary with requirement, outputs and inheritance_dict.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Using the inheritance to ProcessMIA class, list_outputs method</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Smooth</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">list_outputs</span><span class="p">()</span>

        <span class="c1"># Outputs definition and tags inheritance (optional)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_files</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_files</span> <span class="o">!=</span> <span class="p">[</span><span class="n">Undefined</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">in_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_files</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_prefix</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">out_prefix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_prefix</span>

            <span class="c1"># The management of self.process.output_directory could be</span>
            <span class="c1"># delegated to the</span>
            <span class="c1"># populse_mia.user_interface.pipeline_manager.process_mia</span>
            <span class="c1"># module. We can&#39;t do it at the moment because the</span>
            <span class="c1"># sync_process_output_traits() of the</span>
            <span class="c1"># capsul/process/nipype_process module raises an exception</span>
            <span class="c1"># in nipype if the mandatory parameters are not yet defined!</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">output_directory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No output_directory was found...!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;smoothed_files&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">_smoothed_files</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;smoothed_files&quot;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                        <span class="n">val</span> <span class="o">=</span> <span class="p">[</span><span class="n">val</span><span class="p">]</span>

                    <span class="k">for</span> <span class="n">in_val</span><span class="p">,</span> <span class="n">out_val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_files</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
                        <span class="c1"># FIXME: In the latest version of mia, indexing of the</span>
                        <span class="c1">#        database with particular tags defined in the</span>
                        <span class="c1">#        processes is done only at the end of the</span>
                        <span class="c1">#        initialisation of the whole pipeline. So we</span>
                        <span class="c1">#        cannot use the value of these tags in other</span>
                        <span class="c1">#        processes of the pipeline at the time of</span>
                        <span class="c1">#        initialisation (see populse_mia #290). Until</span>
                        <span class="c1">#        better we use a quick and dirty hack with the</span>
                        <span class="c1">#        set_dbFieldValue() function !</span>
                        <span class="n">tag_to_add</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;RepetitionTime&quot;</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;field_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;float&quot;</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="s2">&quot;The period of time &quot;</span>
                            <span class="s2">&quot;in msec between the &quot;</span>
                            <span class="s2">&quot;beginning of a pulse &quot;</span>
                            <span class="s2">&quot;sequence and the &quot;</span>
                            <span class="s2">&quot;beginning of the &quot;</span>
                            <span class="s2">&quot;succeeding pulse &quot;</span>
                            <span class="s2">&quot;sequence&quot;</span>
                        <span class="p">)</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;visibility&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;origin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;user&quot;</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;unit&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;ms&quot;</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;default_value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_dbFieldValue</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="n">in_val</span><span class="p">,</span> <span class="s2">&quot;RepetitionTime&quot;</span>
                        <span class="p">)</span>

                        <span class="k">if</span> <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">set_dbFieldValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="n">out_val</span><span class="p">,</span> <span class="n">tag_to_add</span><span class="p">)</span>

                        <span class="k">else</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span>
                                <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Smooth:</span><span class="se">\n</span><span class="s2">The &#39;RepetitionTime&#39; tag could &quot;</span>
                                <span class="s2">&quot;not be added to the database for the &#39;</span><span class="si">{}</span><span class="s2">&#39; &quot;</span>
                                <span class="s2">&quot;parameter. This can lead to a subsequent &quot;</span>
                                <span class="s2">&quot;issue during &quot;</span>
                                <span class="s2">&quot;initialization!!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">out_val</span><span class="p">)</span>
                            <span class="p">)</span>

                        <span class="n">tag_to_add</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="s2">&quot;Dataset dimensions &quot;</span> <span class="s2">&quot;(Count, X,Y,Z,T...)&quot;</span>
                        <span class="p">)</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;field_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;int&quot;</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="s2">&quot;data array dimensions&quot;</span> <span class="s2">&quot; (from Nifti header)&quot;</span>
                        <span class="p">)</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;visibility&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;origin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;user&quot;</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;unit&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;default_value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_dbFieldValue</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span>
                            <span class="n">in_val</span><span class="p">,</span>
                            <span class="p">(</span><span class="s2">&quot;Dataset dimensions &quot;</span> <span class="s2">&quot;(Count, X,Y,Z,T...)&quot;</span><span class="p">),</span>
                        <span class="p">)</span>

                        <span class="k">if</span> <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">set_dbFieldValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="n">out_val</span><span class="p">,</span> <span class="n">tag_to_add</span><span class="p">)</span>

                        <span class="k">else</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span>
                                <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Smooth:</span><span class="se">\n</span><span class="s2">The &#39;Dataset dimensions (Count, &quot;</span>
                                <span class="s2">&quot;X,Y,Z,T...)&#39; tag could not be added to the &quot;</span>
                                <span class="s2">&quot;database for the &#39;</span><span class="si">{}</span><span class="s2">&#39; parameter. This can &quot;</span>
                                <span class="s2">&quot;lead to a subsequent issue during &quot;</span>
                                <span class="s2">&quot;initialization!!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">out_val</span><span class="p">)</span>
                            <span class="p">)</span>

                        <span class="n">tag_to_add</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;PatientName&quot;</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;field_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;string&quot;</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;visibility&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;origin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;user&quot;</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;unit&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;default_value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_dbFieldValue</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="n">in_val</span><span class="p">,</span> <span class="s2">&quot;PatientName&quot;</span>
                        <span class="p">)</span>

                        <span class="k">if</span> <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">set_dbFieldValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="n">out_val</span><span class="p">,</span> <span class="n">tag_to_add</span><span class="p">)</span>

                        <span class="k">else</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span>
                                <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Smooth:</span><span class="se">\n</span><span class="s2">The &#39;PatientName&#39; tag could not &quot;</span>
                                <span class="s2">&quot;be added to the database for the &#39;</span><span class="si">{}</span><span class="s2">&#39; &quot;</span>
                                <span class="s2">&quot;parameter. This can lead to a subsequent &quot;</span>
                                <span class="s2">&quot;issue during &quot;</span>
                                <span class="s2">&quot;initialization!!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">out_val</span><span class="p">)</span>
                            <span class="p">)</span>

                        <span class="n">age</span> <span class="o">=</span> <span class="n">get_dbFieldValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="n">in_val</span><span class="p">,</span> <span class="s2">&quot;Age&quot;</span><span class="p">)</span>

                        <span class="k">if</span> <span class="n">age</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">tag_to_add</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Age&quot;</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;field_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;int&quot;</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;visibility&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;origin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;user&quot;</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;unit&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;default_value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">age</span>
                            <span class="n">set_dbFieldValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="n">out_val</span><span class="p">,</span> <span class="n">tag_to_add</span><span class="p">)</span>

                        <span class="n">pathology</span> <span class="o">=</span> <span class="n">get_dbFieldValue</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="n">in_val</span><span class="p">,</span> <span class="s2">&quot;Pathology&quot;</span>
                        <span class="p">)</span>

                        <span class="k">if</span> <span class="n">pathology</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">tag_to_add</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Pathology&quot;</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;field_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;string&quot;</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;visibility&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;origin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;user&quot;</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;unit&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;default_value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pathology</span>
                            <span class="n">set_dbFieldValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="n">out_val</span><span class="p">,</span> <span class="n">tag_to_add</span><span class="p">)</span>

                        <span class="n">_</span><span class="p">,</span> <span class="n">fileOval</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">out_val</span><span class="p">)</span>
                        <span class="n">_</span><span class="p">,</span> <span class="n">fileIval</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">in_val</span><span class="p">)</span>

                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_prefix</span><span class="p">:</span>
                            <span class="c1"># fmt: off</span>
                            <span class="n">fileOvalNoPref</span> <span class="o">=</span> <span class="n">fileOval</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">out_prefix</span><span class="p">):]</span>
                            <span class="c1"># fmt: on</span>

                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># fmt: off</span>
                            <span class="n">fileOvalNoPref</span> <span class="o">=</span> <span class="n">fileOval</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="s2">&quot;s&quot;</span><span class="p">):]</span>
                            <span class="c1"># fmt : on</span>

                        <span class="k">if</span> <span class="n">fileOvalNoPref</span> <span class="o">==</span> <span class="n">fileIval</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">inheritance_dict</span><span class="p">[</span><span class="n">out_val</span><span class="p">]</span> <span class="o">=</span> <span class="n">in_val</span>

        <span class="c1"># Return the requirement, outputs and inheritance_dict</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_initResult</span><span class="p">()</span></div>

<div class="viewcode-block" id="Smooth.run_process_mia"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.spm.html#mia_processes.bricks.preprocess.spm.spatial_preprocessing.Smooth.run_process_mia">[docs]</a>    <span class="k">def</span> <span class="nf">run_process_mia</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the process launch step of the brick.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Smooth</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">run_process_mia</span><span class="p">()</span>

        <span class="c1"># in_files parameter are normally already in absolute path format.</span>
        <span class="c1"># So, the 3 next lines can be see as &quot;in case of&quot;...</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">element</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_files</span><span class="p">):</span>
            <span class="n">full_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">in_files</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">full_path</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">in_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_files</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">fwhm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fwhm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">data_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">implicit_masking</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">implicit_masking</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_prefix</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">out_prefix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_prefix</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">configuration_dict</span><span class="o">=</span><span class="p">{})</span></div></div>
</pre></div>

      </div>
      <div class="bottomnav" role="navigation" aria-label="bottom navigation">
      
        <p>
        <a class="uplink" href="../../../../../index.html">Contents</a>
        </p>

      </div>

    <div class="footer" role="contentinfo">
        &#169; Copyright 2019, populse.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 3.2.1.
    </div>
  </body>
</html>