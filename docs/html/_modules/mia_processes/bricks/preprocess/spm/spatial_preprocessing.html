
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>mia_processes.bricks.preprocess.spm.spatial_preprocessing &#8212; mia_processes 2.2.1-dev+336a1e0 documentation</title>
    <link rel="stylesheet" href="../../../../../_static/haiku.css" type="text/css" />
    <link rel="stylesheet" href="../../../../../_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="../../../../../" src="../../../../../_static/documentation_options.js"></script>
    <script src="../../../../../_static/jquery.js"></script>
    <script src="../../../../../_static/underscore.js"></script>
    <script src="../../../../../_static/doctools.js"></script>
    <script src="../../../../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../search.html" />
  </head><body>
      <div class="header" role="banner"><h1 class="heading"><a href="../../../../../index.html">
          <span>mia_processes 2.2.1-dev+336a1e0 documentation</span></a></h1>
        <h2 class="heading"><span>mia_processes.bricks.preprocess.spm.spatial_preprocessing</span></h2>
      </div>
      <div class="topnav" role="navigation" aria-label="top navigation">

        <p>
        <a class="uplink" href="../../../../../index.html">Contents</a>
        </p>

      </div>
      <div class="content" role="main">


  <h1>Source code for mia_processes.bricks.preprocess.spm.spatial_preprocessing</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*- #</span>

<span class="sd">&quot;&quot;&quot;The spm preprocess library of the mia_processes package.</span>

<span class="sd">The purpose of this module is to customise the main spm preprocessing bricks</span>
<span class="sd">provided by nipype and to correct some things that do not work directly in</span>
<span class="sd">populse_mia.</span>

<span class="sd">:Contains:</span>
<span class="sd">    :Class:</span>
<span class="sd">        - Coregister</span>
<span class="sd">        - GM_WM_Normalize</span>
<span class="sd">        - NewSegment</span>
<span class="sd">        - Normalize12</span>
<span class="sd">        - Realign</span>
<span class="sd">        - SliceTiming</span>
<span class="sd">        - Smooth</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="c1">##########################################################################</span>
<span class="c1"># mia_processes - Copyright (C) IRMaGe/CEA, 2018</span>
<span class="c1"># Distributed under the terms of the CeCILL license, as published by</span>
<span class="c1"># the CEA-CNRS-INRIA. Refer to the LICENSE file or to</span>
<span class="c1"># http://www.cecill.info/licences/Licence_CeCILL_V2.1-en.html</span>
<span class="c1"># for details.</span>
<span class="c1">##########################################################################</span>

<span class="c1"># capsul import</span>
<span class="kn">from</span> <span class="nn">capsul.api</span> <span class="kn">import</span> <span class="n">capsul_engine</span>

<span class="c1"># mia_processes import</span>
<span class="kn">from</span> <span class="nn">mia_processes.utils</span> <span class="kn">import</span> <span class="n">get_dbFieldValue</span><span class="p">,</span> <span class="n">set_dbFieldValue</span>

<span class="c1"># nipype imports</span>
<span class="kn">from</span> <span class="nn">nipype.interfaces</span> <span class="kn">import</span> <span class="n">spm</span>
<span class="kn">from</span> <span class="nn">nipype.interfaces.base</span> <span class="kn">import</span> <span class="p">(</span><span class="n">File</span><span class="p">,</span> <span class="n">InputMultiPath</span><span class="p">,</span> <span class="n">InputMultiObject</span><span class="p">,</span>
                                    <span class="n">OutputMultiPath</span><span class="p">,</span> <span class="n">traits</span><span class="p">,</span> <span class="n">TraitListObject</span><span class="p">,</span>
                                    <span class="n">traits_extension</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">nipype.interfaces.spm.base</span> <span class="kn">import</span> <span class="n">ImageFileSPM</span>

<span class="c1"># populse_mia imports</span>
<span class="kn">from</span> <span class="nn">populse_mia.data_manager.project</span> <span class="kn">import</span> <span class="n">COLLECTION_CURRENT</span>
<span class="kn">from</span> <span class="nn">populse_mia.software_properties</span> <span class="kn">import</span> <span class="n">Config</span>
<span class="kn">from</span> <span class="nn">populse_mia.user_interface.pipeline_manager.process_mia</span> <span class="kn">import</span> <span class="n">ProcessMIA</span>

<span class="c1"># soma-base import</span>
<span class="kn">from</span> <span class="nn">soma.controller.trait_utils</span> <span class="kn">import</span> <span class="n">relax_exists_constraint</span>
<span class="kn">from</span> <span class="nn">soma.qt_gui.qt_backend.Qt</span> <span class="kn">import</span> <span class="n">QMessageBox</span>

<span class="c1"># Other imports</span>
<span class="kn">import</span> <span class="nn">itertools</span><span class="o">,</span> <span class="nn">math</span><span class="o">,</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">nibabel</span> <span class="k">as</span> <span class="nn">nib</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">traits.api</span> <span class="kn">import</span> <span class="p">(</span><span class="n">Bool</span><span class="p">,</span> <span class="n">Either</span><span class="p">,</span> <span class="n">Enum</span><span class="p">,</span> <span class="n">Float</span><span class="p">,</span> <span class="n">Int</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Range</span><span class="p">,</span> <span class="n">String</span><span class="p">,</span>
                        <span class="n">Tuple</span><span class="p">,</span> <span class="n">Undefined</span><span class="p">)</span>


<div class="viewcode-block" id="Coregister"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.spm.html#mia_processes.bricks.preprocess.spm.spatial_preprocessing.Coregister">[docs]</a><span class="k">class</span> <span class="nc">Coregister</span><span class="p">(</span><span class="n">ProcessMIA</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    *Align together scans of different modalities*</span>

<span class="sd">    Please, see the complete documention for the `Coregister brick in the populse.mia_processes web site</span>
<span class="sd">    &lt;https://populse.github.io/mia_processes/html/documentation/bricks/preprocess/spm/Coregister.html&gt;`_</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Coregister.__init__"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.spm.html#mia_processes.bricks.preprocess.spm.spatial_preprocessing.Coregister.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the attributes initialisation/instantiation.</span>
<span class="sd">        </span>
<span class="sd">        The input and output plugs are defined here. The special</span>
<span class="sd">        &#39;self.requirement&#39; attribute (optional) is used to define the</span>
<span class="sd">        third-party products necessary for the running of the brick.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Initialisation of the objects needed for the launch of the brick</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Coregister</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1"># Third party softwares required for the execution of the brick</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requirement</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;spm&#39;</span><span class="p">,</span> <span class="s1">&#39;nipype&#39;</span><span class="p">]</span>

        <span class="c1"># Inputs description</span>
        <span class="n">target_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;The reference file to register to. An existing,&#39;</span>
                       <span class="s1">&#39; uncompressed file (valid extensions:&#39;</span>
                       <span class="s1">&#39; [.img, .nii, .hdr]).&#39;</span><span class="p">)</span>
        <span class="n">source_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;File to register to target image. A list of items which&#39;</span>
                       <span class="s1">&#39; are an existing, uncompressed file (valid extensions:&#39;</span>
                       <span class="s1">&#39; [.img, .nii, .hdr]).&#39;</span><span class="p">)</span>
        <span class="n">apply_to_files_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Files to apply transformation to (a list of&#39;</span>
                               <span class="s1">&#39; items which are an existing file name, (valid&#39;</span>
                               <span class="s1">&#39; extensions: [.img, .nii, .hdr]).&#39;</span><span class="p">)</span>
        <span class="n">jobtype_desc</span> <span class="o">=</span> <span class="s2">&quot;One of &#39;estwrite&#39; or &#39;estimate&#39; or &#39;write&#39;.&quot;</span>
        <span class="n">cost_function_desc</span> <span class="o">=</span> <span class="s2">&quot;One of &#39;mi&#39; or &#39;nmi&#39; or &#39;ecc&#39; or &#39;ncc&#39;.&quot;</span>
        <span class="n">separation_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Sampling separation in mm (a list of items which&#39;</span>
                           <span class="s1">&#39; are a float).&#39;</span><span class="p">)</span>
        <span class="n">tolerance_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;The acceptable tolerance for each of 12 params (a&#39;</span>
                          <span class="s1">&#39; list of items which are a float).&#39;</span><span class="p">)</span>
        <span class="n">fwhm_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Gaussian smoothing kernel width (mm) applied to the&#39;</span>
                     <span class="s1">&#39; 256*256 joint histogram (a list of 2 items which are&#39;</span>
                     <span class="s1">&#39; a float).&#39;</span><span class="p">)</span>
        <span class="n">write_interp_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;0 &lt;= a long integer &lt;= 7. The method by which the&#39;</span>
                             <span class="s1">&#39; images are sampled when being written in a&#39;</span>
                             <span class="s1">&#39; different space.&#39;</span><span class="p">)</span>
        <span class="n">write_wrap_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;A list of from 3 to 3 items which are an integer&#39;</span>
                           <span class="s1">&#39; (int or long).&#39;</span><span class="p">)</span>
        <span class="n">write_mask_desc</span> <span class="o">=</span> <span class="s1">&#39;Mask output image (a boolean)&#39;</span>
        <span class="n">out_prefix_desc</span> <span class="o">=</span> <span class="s1">&#39;Coregisterd output prefix (a string).&#39;</span>

        <span class="c1"># Outputs description</span>
        <span class="n">coregistered_source_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Coregistered source files, corresponding &quot;</span>
                                    <span class="s2">&quot;to &#39;source&#39; images, (a pathlike object &quot;</span>
                                    <span class="s2">&quot;or string representing a file, or a list &quot;</span>
                                    <span class="s2">&quot;of pathlike objects or strings &quot;</span>
                                    <span class="s2">&quot;representing a file).&quot;</span><span class="p">)</span>
        <span class="n">coregistered_files_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Coregistered other files, corresponding&quot;</span>
                                   <span class="s2">&quot; to &#39;apply_to_files&#39;, (a pathlike object &quot;</span>
                                    <span class="s2">&quot;or string representing a file, or a list &quot;</span>
                                    <span class="s2">&quot;of pathlike objects or strings &quot;</span>
                                    <span class="s2">&quot;representing a file).&quot;</span><span class="p">)</span>

        <span class="c1"># Inputs traits </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;target&quot;</span><span class="p">,</span>
                       <span class="n">ImageFileSPM</span><span class="p">(</span><span class="n">copyfile</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                    <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                    <span class="n">optional</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                    <span class="n">desc</span><span class="o">=</span><span class="n">target_desc</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;source&quot;</span><span class="p">,</span>
                       <span class="n">InputMultiPath</span><span class="p">(</span><span class="n">Either</span><span class="p">(</span><span class="n">ImageFileSPM</span><span class="p">(),</span>
                                             <span class="n">Undefined</span><span class="p">),</span>
                                      <span class="n">copyfile</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                      <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                      <span class="n">optional</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                      <span class="n">desc</span><span class="o">=</span><span class="n">source_desc</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;apply_to_files&quot;</span><span class="p">,</span>
                       <span class="n">InputMultiPath</span><span class="p">(</span><span class="n">Either</span><span class="p">(</span><span class="n">ImageFileSPM</span><span class="p">(),</span>
                                             <span class="n">Undefined</span><span class="p">),</span>
                                      <span class="n">copyfile</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                      <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                      <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                      <span class="n">desc</span><span class="o">=</span><span class="n">apply_to_files_desc</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;jobtype&quot;</span><span class="p">,</span>
                       <span class="n">Enum</span><span class="p">(</span><span class="s1">&#39;estimate&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;estwrite&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;write&#39;</span><span class="p">,</span>
                            <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">desc</span><span class="o">=</span><span class="n">jobtype_desc</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;cost_function&quot;</span><span class="p">,</span>
                       <span class="n">Enum</span><span class="p">(</span><span class="s1">&#39;nmi&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;mi&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;ecc&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;ncc&#39;</span><span class="p">,</span>
                            <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">desc</span><span class="o">=</span><span class="n">cost_function_desc</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;separation&quot;</span><span class="p">,</span>
                       <span class="n">List</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="p">[</span><span class="mf">4.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">],</span>
                            <span class="n">trait</span><span class="o">=</span><span class="n">Range</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="kc">None</span><span class="p">),</span>
                            <span class="n">minlen</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                            <span class="n">maxlen</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>
                            <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">desc</span><span class="o">=</span><span class="n">separation_desc</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;tolerance&quot;</span><span class="p">,</span>
                       <span class="n">List</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="p">[</span><span class="o">.</span><span class="mi">02</span><span class="p">,</span> <span class="o">.</span><span class="mi">02</span><span class="p">,</span> <span class="o">.</span><span class="mi">02</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">,</span>
                                   <span class="o">.</span><span class="mi">01</span><span class="p">,</span> <span class="o">.</span><span class="mi">01</span><span class="p">,</span> <span class="o">.</span><span class="mi">01</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">],</span>
                            <span class="n">trait</span><span class="o">=</span><span class="n">Range</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="kc">None</span><span class="p">),</span>
                            <span class="n">minlen</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
                            <span class="n">maxlen</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
                            <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">desc</span><span class="o">=</span><span class="n">tolerance_desc</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;fwhm&quot;</span><span class="p">,</span>
                       <span class="n">List</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="p">[</span><span class="mf">7.0</span><span class="p">,</span> <span class="mf">7.0</span><span class="p">],</span>
                            <span class="n">trait</span><span class="o">=</span><span class="n">Range</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="kc">None</span><span class="p">),</span>
                            <span class="n">minlen</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                            <span class="n">maxlen</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                            <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">desc</span><span class="o">=</span><span class="n">fwhm_desc</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;write_interp&quot;</span><span class="p">,</span>
                       <span class="n">Range</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
                             <span class="n">low</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                             <span class="n">high</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span>
                             <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                             <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                             <span class="n">desc</span><span class="o">=</span><span class="n">write_interp_desc</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;write_wrap&quot;</span><span class="p">,</span>
                       <span class="n">List</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                            <span class="n">trait</span><span class="o">=</span><span class="n">Range</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
                            <span class="n">minlen</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                            <span class="n">maxlen</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                            <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">desc</span><span class="o">=</span><span class="n">write_wrap_desc</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;write_mask&quot;</span><span class="p">,</span>
                       <span class="n">Bool</span><span class="p">(</span><span class="n">default_value</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">desc</span><span class="o">=</span><span class="n">write_mask_desc</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;out_prefix&quot;</span><span class="p">,</span>
                       <span class="n">String</span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">,</span>
                              <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                              <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                              <span class="n">desc</span><span class="o">=</span><span class="n">out_prefix_desc</span><span class="p">))</span>

        <span class="c1"># Output traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;coregistered_source&quot;</span><span class="p">,</span>
                       <span class="n">OutputMultiPath</span><span class="p">(</span><span class="n">ImageFileSPM</span><span class="p">(),</span>
                                       <span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                       <span class="n">desc</span><span class="o">=</span><span class="n">coregistered_source_desc</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;coregistered_files&quot;</span><span class="p">,</span>
                       <span class="n">OutputMultiPath</span><span class="p">(</span><span class="n">ImageFileSPM</span><span class="p">(),</span>
                                       <span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                       <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                       <span class="n">desc</span><span class="o">=</span><span class="n">coregistered_files_desc</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">init_default_traits</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_process</span><span class="p">(</span><span class="s1">&#39;nipype.interfaces.spm.Coregister&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Coregister.list_outputs"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.spm.html#mia_processes.bricks.preprocess.spm.spatial_preprocessing.Coregister.list_outputs">[docs]</a>    <span class="k">def</span> <span class="nf">list_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_plugged</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the initialisation step of the brick.</span>

<span class="sd">        The main objective of this method is to produce the outputs of the</span>
<span class="sd">        bricks (self.outputs) and the associated tags (self.inheritance_dic),</span>
<span class="sd">        if defined here. In order not to include an output in the database,</span>
<span class="sd">        this output must be a value of the optional key &#39;notInDb&#39; of the</span>
<span class="sd">        self.outputs dictionary. To work properly this method must return </span>
<span class="sd">        self.make_initResult() object.</span>

<span class="sd">        :param is_plugged: the state, linked or not, of the plugs.</span>
<span class="sd">        :returns: a dictionary with requirement, outputs and inheritance_dict.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Using the inheritance to ProcessMIA class, list_outputs method</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Coregister</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">list_outputs</span><span class="p">()</span>

        <span class="c1"># Outputs definition and tags inheritance (optional)</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span> <span class="o">!=</span> <span class="n">Undefined</span> <span class="ow">and</span>
              <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">!=</span> <span class="p">[</span><span class="n">Undefined</span><span class="p">]</span> <span class="ow">and</span>
              <span class="bp">self</span><span class="o">.</span><span class="n">jobtype</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">jobtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobtype</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_to_files</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_to_files</span> <span class="o">!=</span> <span class="p">[</span><span class="n">Undefined</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">apply_to_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_to_files</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_prefix</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">out_prefix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_prefix</span>

            <span class="c1"># The management of self.process.output_directory could be delegated</span>
            <span class="c1"># to the populse_mia.user_interface.pipeline_manager.process_mia</span>
            <span class="c1"># module. We can&#39;t do it at the moment because the</span>
            <span class="c1"># sync_process_output_traits() of the capsul/process/nipype_process</span>
            <span class="c1"># module raises an exception in nipype if the mandatory parameters</span>
            <span class="c1"># are not yet defined!</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">output_directory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No output_directory was found...!</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span>
                <span class="s1">&#39;coregistered_source&#39;</span>
                        <span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">_coregistered_source</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span>
                <span class="s1">&#39;coregistered_files&#39;</span>
                        <span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">_coregistered_files</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">:</span>
            <span class="n">out_coregsource</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">out_coregfiles</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;coregistered_source&quot;</span><span class="p">:</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                        <span class="n">val</span> <span class="o">=</span> <span class="p">[</span><span class="n">val</span><span class="p">]</span>

                    <span class="k">for</span> <span class="n">in_val</span><span class="p">,</span> <span class="n">out_val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
                        <span class="n">pathOval</span><span class="p">,</span> <span class="n">fileOval</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">out_val</span><span class="p">)</span>
                        <span class="n">_</span><span class="p">,</span> <span class="n">fileIval</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">in_val</span><span class="p">)</span>

                        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobtype</span> <span class="o">==</span> <span class="s2">&quot;estimate&quot;</span><span class="p">:</span>

                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_prefix</span><span class="p">:</span>
                                <span class="n">fileOvalNoPref</span> <span class="o">=</span> <span class="n">fileOval</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">out_prefix</span><span class="p">):]</span>

                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">fileOvalNoPref</span> <span class="o">=</span> <span class="n">fileOval</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">):]</span>

                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">fileOvalNoPref</span> <span class="o">=</span> <span class="n">fileOval</span>

                        <span class="k">if</span> <span class="n">fileOvalNoPref</span> <span class="o">==</span> <span class="n">fileIval</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">inheritance_dict</span><span class="p">[</span><span class="n">out_val</span><span class="p">]</span> <span class="o">=</span> <span class="n">in_val</span>

                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobtype</span> <span class="o">==</span> <span class="s2">&quot;estwrite&quot;</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">inheritance_dict</span><span class="p">[</span>
                                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pathOval</span><span class="p">,</span>
                                                 <span class="n">fileOvalNoPref</span><span class="p">)]</span> <span class="o">=</span> <span class="n">in_val</span>
                                <span class="n">out_coregsource</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out_val</span><span class="p">)</span>
                                <span class="n">out_coregsource</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pathOval</span><span class="p">,</span>
                                                             <span class="n">fileOvalNoPref</span><span class="p">))</span>

                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;coregistered_files&quot;</span> <span class="ow">and</span> <span class="n">val</span> <span class="o">!=</span> <span class="n">Undefined</span><span class="p">:</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                        <span class="n">val</span> <span class="o">=</span> <span class="p">[</span><span class="n">val</span><span class="p">]</span>

                    <span class="k">for</span> <span class="n">in_val</span><span class="p">,</span> <span class="n">out_val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">apply_to_files</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
                        <span class="n">pathOval</span><span class="p">,</span> <span class="n">fileOval</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">out_val</span><span class="p">)</span>
                        <span class="n">_</span><span class="p">,</span> <span class="n">fileIval</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">in_val</span><span class="p">)</span>

                        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobtype</span> <span class="o">==</span> <span class="s2">&quot;estimate&quot;</span><span class="p">:</span>

                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_prefix</span><span class="p">:</span>
                                <span class="n">fileOvalNoPref</span> <span class="o">=</span> <span class="n">fileOval</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">out_prefix</span><span class="p">):]</span>

                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">fileOvalNoPref</span> <span class="o">=</span> <span class="n">fileOval</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">):]</span>

                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">fileOvalNoPref</span> <span class="o">=</span> <span class="n">fileOval</span>

                        <span class="k">if</span> <span class="n">fileOvalNoPref</span> <span class="o">==</span> <span class="n">fileIval</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">inheritance_dict</span><span class="p">[</span><span class="n">out_val</span><span class="p">]</span> <span class="o">=</span> <span class="n">in_val</span>

                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobtype</span> <span class="o">==</span> <span class="s2">&quot;estwrite&quot;</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">inheritance_dict</span><span class="p">[</span>
                                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pathOval</span><span class="p">,</span>
                                                 <span class="n">fileOvalNoPref</span><span class="p">)]</span> <span class="o">=</span> <span class="n">in_val</span>
                                <span class="n">out_coregfiles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out_val</span><span class="p">)</span>
                                <span class="n">out_coregfiles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                                               <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pathOval</span><span class="p">,</span>
                                                            <span class="n">fileOvalNoPref</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">out_coregsource</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;coregistered_source&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">out_coregsource</span>

            <span class="k">if</span> <span class="n">out_coregfiles</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;coregistered_files&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">out_coregfiles</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">out_coregfiles</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">out_coregfiles</span> <span class="o">=</span> <span class="p">[</span><span class="n">out_coregfiles</span><span class="p">]</span>

                <span class="c1"># FIXME: In the latest version of mia, indexing of the database with</span>
                <span class="c1">#        particular tags defined in the processes is done only at</span>
                <span class="c1">#        the end of the initialisation of the whole pipeline. So we</span>
                <span class="c1">#        cannot use the value of these tags in other processes of</span>
                <span class="c1">#        the pipeline at the time of initialisation</span>
                <span class="c1">#        (see populse_mia #290). Until better we use a quick and</span>
                <span class="c1">#        dirty hack with the set_dbFieldValue() method !</span>
                <span class="k">for</span> <span class="n">in_val</span><span class="p">,</span> <span class="n">out_val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">apply_to_files</span><span class="p">,</span> <span class="n">out_coregfiles</span><span class="p">):</span>
                    <span class="n">tag_to_add</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                    <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;RepetitionTime&#39;</span>
                    <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;field_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;float&quot;</span>
                    <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;The period of time &quot;</span>
                                                 <span class="s2">&quot;in msec between the &quot;</span>
                                                 <span class="s2">&quot;beginning of a pulse &quot;</span>
                                                 <span class="s2">&quot;sequence and the &quot;</span>
                                                 <span class="s2">&quot;beginning of the &quot;</span>
                                                 <span class="s2">&quot;succeeding pulse &quot;</span>
                                                 <span class="s2">&quot;sequence&quot;</span><span class="p">)</span>
                    <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;visibility&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;origin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;user&quot;</span>
                    <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;unit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;ms&quot;</span>
                    <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;default_value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_dbFieldValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span>
                                                           <span class="n">in_val</span><span class="p">,</span>
                                                           <span class="s1">&#39;RepetitionTime&#39;</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">set_dbFieldValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="n">out_val</span><span class="p">,</span> <span class="n">tag_to_add</span><span class="p">)</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Coregister:</span><span class="se">\n</span><span class="s2"> the &#39;RepetitionTime&#39; tag could &quot;</span>
                              <span class="s2">&quot;not be added to the database for the &#39;</span><span class="si">{}</span><span class="s2">&#39; &quot;</span>
                              <span class="s2">&quot;parameter. This can lead to a subsequent issue &quot;</span>
                              <span class="s2">&quot;during initialization!!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">out_val</span><span class="p">))</span>

                    <span class="n">tag_to_add</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                    <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Dataset dimensions &quot;</span>
                                          <span class="s2">&quot;(Count, X,Y,Z,T...)&quot;</span><span class="p">)</span>
                    <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;field_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;int&quot;</span>
                    <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;data array dimensions&quot;</span>
                                                 <span class="s2">&quot; (from Nifti header)&quot;</span><span class="p">)</span>
                    <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;visibility&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;origin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;user&quot;</span>
                    <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;unit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;default_value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_dbFieldValue</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span>
                        <span class="n">in_val</span><span class="p">,</span>
                        <span class="p">(</span><span class="s2">&quot;Dataset dimensions &quot;</span>
                         <span class="s2">&quot;(Count, X,Y,Z,T...)&quot;</span><span class="p">))</span>

                    <span class="k">if</span> <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">set_dbFieldValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span>
                                         <span class="n">out_val</span><span class="p">,</span>
                                         <span class="n">tag_to_add</span><span class="p">)</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Coregister:</span><span class="se">\n</span><span class="s2">The &#39;Dataset dimensions (Count, &quot;</span>
                              <span class="s2">&quot;X,Y,Z,T...)&#39; tag could not be added to the &quot;</span>
                              <span class="s2">&quot;database for the &#39;</span><span class="si">{}</span><span class="s2">&#39; parameter. This can lead to&quot;</span>
                              <span class="s2">&quot; a subsequent issue during &quot;</span>
                              <span class="s2">&quot;initialization!!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">out_val</span><span class="p">))</span>

                    <span class="n">tag_to_add</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                    <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;PatientName&quot;</span>
                    <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;field_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;string&quot;</span>
                    <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                    <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;visibility&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;origin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;user&quot;</span>
                    <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;unit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;default_value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_dbFieldValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span>
                                                           <span class="n">in_val</span><span class="p">,</span>
                                                           <span class="s2">&quot;PatientName&quot;</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">set_dbFieldValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span>
                                         <span class="n">out_val</span><span class="p">,</span>
                                         <span class="n">tag_to_add</span><span class="p">)</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span>
                            <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Coregister:</span><span class="se">\n</span><span class="s2">The &#39;PatientName&#39; tag could not &quot;</span>
                            <span class="s2">&quot;be added to the database for the &#39;</span><span class="si">{}</span><span class="s2">&#39; &quot;</span>
                            <span class="s2">&quot;parameter. This can lead to a subsequent &quot;</span>
                            <span class="s2">&quot;issue during &quot;</span>
                            <span class="s2">&quot;initialization!!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">out_val</span><span class="p">))</span>

                    <span class="n">age</span> <span class="o">=</span> <span class="n">get_dbFieldValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="n">in_val</span><span class="p">,</span> <span class="s1">&#39;Age&#39;</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">age</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">tag_to_add</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Age&quot;</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;field_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;int&quot;</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;visibility&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;origin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;user&quot;</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;unit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;default_value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">age</span>
                        <span class="n">set_dbFieldValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="n">out_val</span><span class="p">,</span> <span class="n">tag_to_add</span><span class="p">)</span>

                    <span class="n">pathology</span> <span class="o">=</span> <span class="n">get_dbFieldValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="n">in_val</span><span class="p">,</span>
                                                 <span class="s1">&#39;Pathology&#39;</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">pathology</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">tag_to_add</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Pathology&quot;</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;field_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;string&quot;</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;visibility&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;origin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;user&quot;</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;unit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;default_value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pathology</span>
                        <span class="n">set_dbFieldValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="n">out_val</span><span class="p">,</span> <span class="n">tag_to_add</span><span class="p">)</span>

        <span class="c1"># Return the requirement, outputs and inheritance_dict</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_initResult</span><span class="p">()</span></div>

<div class="viewcode-block" id="Coregister.run_process_mia"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.spm.html#mia_processes.bricks.preprocess.spm.spatial_preprocessing.Coregister.run_process_mia">[docs]</a>    <span class="k">def</span> <span class="nf">run_process_mia</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the process launch step of the brick.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Coregister</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">run_process_mia</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">jobtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobtype</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_to_files</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_to_files</span> <span class="o">!=</span> <span class="p">[</span><span class="n">Undefined</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">apply_to_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_to_files</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_prefix</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">out_prefix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_prefix</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">cost_function</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cost_function</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">separation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">separation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">tolerance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tolerance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">fwhm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fwhm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">write_interp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_interp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">write_wrap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_wrap</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">write_mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_mask</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">configuration_dict</span><span class="o">=</span><span class="p">{})</span></div></div>


<div class="viewcode-block" id="GM_WM_Normalize"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.spm.html#mia_processes.bricks.preprocess.spm.spatial_preprocessing.GM_WM_Normalize">[docs]</a><span class="k">class</span> <span class="nc">GM_WM_Normalize</span><span class="p">(</span><span class="n">ProcessMIA</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    *Normalisation of the grey and/or white matter map(s)*</span>

<span class="sd">    Please, see the complete documention for the `GM_WM_Normalize brick in the populse.mia_processes web site</span>
<span class="sd">    &lt;https://populse.github.io/mia_processes/html/documentation/bricks/preprocess/spm/GM_WM_Normalize.html&gt;`_</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="GM_WM_Normalize.__init__"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.spm.html#mia_processes.bricks.preprocess.spm.spatial_preprocessing.GM_WM_Normalize.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the attributes initialisation / instantiation.</span>
<span class="sd">        </span>
<span class="sd">        The input and output plugs are defined here. The special</span>
<span class="sd">        &#39;self.requirement&#39; attribute (optional) is used to define the</span>
<span class="sd">        third-party products necessary for the running of the brick.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Initialisation of the objects needed for the launch of the brick</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">GM_WM_Normalize</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1"># Third party softwares required for the execution of the brick</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requirement</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;spm&#39;</span><span class="p">,</span> <span class="s1">&#39;nipype&#39;</span><span class="p">]</span>

        <span class="c1"># Inputs description</span>
        <span class="n">deformation_file_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;File y_*.nii containing 3 deformation fields &#39;</span>
                                 <span class="s1">&#39;for the deformation in x, y and z dimension &#39;</span>
                                 <span class="s1">&#39;(an uncompressed file; valid extensions in &#39;</span>
                                 <span class="s1">&#39;[.img, .nii, .hdr]).&#39;</span><span class="p">)</span>
        <span class="n">apply_to_files_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Files to apply transformation to. A list of &#39;</span>
                               <span class="s1">&#39;items which are an existing, uncompressed file &#39;</span>
                               <span class="s1">&#39;(valid extensions: [.img, .nii, .hdr]).&#39;</span><span class="p">)</span>

        <span class="n">in_filter_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;One of &quot;GM&quot; (gray matter) or &quot;WM&quot; (white matter) or &#39;</span>
                          <span class="s1">&#39;&quot;GM &amp; WM&quot; (uses GM and WM; 2 files) or &quot;GM + WM&quot; &#39;</span>
                          <span class="s1">&#39;(makes GM + WM, then uses the result; 1 file).&#39;</span><span class="p">)</span>

        <span class="n">write_bounding_box_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;The bounding box (in mm) of the volume &#39;</span>
                                  <span class="s1">&#39;which is to be written (a list of 2 items, &#39;</span>
                                  <span class="s1">&#39;which are a list of items, which are a &#39;</span>
                                  <span class="s1">&#39;float.&#39;</span><span class="p">)</span>
        <span class="n">write_voxel_sizes_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;The voxel sizes (x, y &amp; z, in mm) of the &#39;</span>
                                  <span class="s1">&#39;written normalised images (a list of 3 &#39;</span>
                                  <span class="s1">&#39;items, which are a float).&#39;</span><span class="p">)</span>
        <span class="n">write_interp_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Degree of b-spline used for interpolation &#39;</span>
                             <span class="s1">&#39;(0 &lt;= a long integer &lt;= 7; 1 is OK for PET, &#39;</span>
                             <span class="s1">&#39;realigned fMRI, or segmentations).&#39;</span><span class="p">)</span>

        <span class="c1"># Outputs description</span>
        <span class="n">normalized_files_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Normalised files (a pathlike object or &#39;</span>
                                 <span class="s1">&#39;string representing a file, or a list of &#39;</span>
                                 <span class="s1">&#39;pathlike objects or strings representing a &#39;</span>
                                 <span class="s1">&#39;file).&#39;</span><span class="p">)</span>

        <span class="c1"># Inputs traits </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;deformation_file&quot;</span><span class="p">,</span>
                       <span class="n">ImageFileSPM</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                    <span class="n">optional</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                    <span class="n">desc</span><span class="o">=</span><span class="n">deformation_file_desc</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;apply_to_files&quot;</span><span class="p">,</span>
                       <span class="n">InputMultiPath</span><span class="p">(</span><span class="n">traits</span><span class="o">.</span><span class="n">Either</span><span class="p">(</span><span class="n">ImageFileSPM</span><span class="p">(),</span>
                                                    <span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">ImageFileSPM</span><span class="p">()),</span>
                                                    <span class="n">Undefined</span><span class="p">),</span>
                                      <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                      <span class="n">optional</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                      <span class="n">desc</span><span class="o">=</span><span class="n">apply_to_files_desc</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;in_filter&quot;</span><span class="p">,</span>
                       <span class="n">Enum</span><span class="p">(</span><span class="s1">&#39;GM&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;WM&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;GM &amp; WM&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;GM + WM&#39;</span><span class="p">,</span>
                            <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">desc</span><span class="o">=</span><span class="n">in_filter_desc</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;write_bounding_box&quot;</span><span class="p">,</span>
                       <span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">traits</span><span class="o">.</span><span class="n">Float</span><span class="p">()),</span>
                                   <span class="n">value</span><span class="o">=</span><span class="p">[[</span><span class="o">-</span><span class="mi">78</span><span class="p">,</span> <span class="o">-</span><span class="mi">112</span><span class="p">,</span> <span class="o">-</span><span class="mi">50</span><span class="p">],</span> <span class="p">[</span><span class="mi">78</span><span class="p">,</span> <span class="mi">76</span><span class="p">,</span> <span class="mi">85</span><span class="p">]],</span>
                                   <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                   <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">desc</span><span class="o">=</span><span class="n">write_bounding_box_desc</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;write_voxel_sizes&quot;</span><span class="p">,</span>
                       <span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">traits</span><span class="o">.</span><span class="n">Float</span><span class="p">(),</span>
                                   <span class="n">value</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                                   <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                   <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">desc</span><span class="o">=</span><span class="n">write_voxel_sizes_desc</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;write_interp&quot;</span><span class="p">,</span>
                       <span class="n">traits</span><span class="o">.</span><span class="n">Range</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                    <span class="n">low</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                    <span class="n">high</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span>
                                    <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                    <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                    <span class="n">desc</span><span class="o">=</span><span class="n">write_interp_desc</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;files&quot;</span><span class="p">,</span>
                       <span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                   <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">userlevel</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                   <span class="n">desc</span><span class="o">=</span><span class="s1">&#39;internal parameter&#39;</span><span class="p">))</span>

        <span class="c1"># Outputs traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;normalized_files&quot;</span><span class="p">,</span>
                       <span class="n">OutputMultiPath</span><span class="p">(</span><span class="n">File</span><span class="p">(),</span>
                                       <span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                       <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                       <span class="n">desc</span><span class="o">=</span><span class="n">normalized_files_desc</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">init_default_traits</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_process</span><span class="p">(</span><span class="s1">&#39;nipype.interfaces.spm.Normalize12&#39;</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_namesFilter</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Filtering of apply_to_files input parameter for GM, WM, etc.</span>

<span class="sd">        :returns: from the apply_to_files input parameter, returns the selected </span>
<span class="sd">                  mask(s).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">files</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">runFlag</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>

            <span class="k">for</span> <span class="n">file_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_to_files</span><span class="p">:</span>

                <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="nb">list</span><span class="p">,</span> <span class="n">TraitListObject</span><span class="p">]:</span>
                    <span class="n">file_name</span> <span class="o">=</span> <span class="n">file_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_filter</span> <span class="o">==</span> <span class="s1">&#39;GM&#39;</span> <span class="ow">and</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span>
                                                     <span class="n">file_name</span><span class="p">))[:</span><span class="mi">2</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;c1&#39;</span><span class="p">]):</span>
                    <span class="n">files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>

                <span class="k">elif</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_filter</span> <span class="o">==</span> <span class="s1">&#39;WM&#39;</span> <span class="ow">and</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span>
                                                     <span class="n">file_name</span><span class="p">))[:</span><span class="mi">2</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;c2&#39;</span><span class="p">]):</span>
                    <span class="n">files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>

                <span class="k">elif</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">in_filter</span> <span class="o">==</span> <span class="s1">&#39;GM &amp; WM&#39;</span> <span class="ow">or</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">in_filter</span> <span class="o">==</span> <span class="s1">&#39;GM + WM&#39;</span><span class="p">)</span> <span class="ow">and</span>
                            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span>
                                               <span class="n">file_name</span><span class="p">))[:</span><span class="mi">2</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;c1&#39;</span><span class="p">,</span> <span class="s1">&#39;c2&#39;</span><span class="p">]):</span>
                    <span class="n">files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Warning: No GM or WM were detected ... Please, check &#39;</span>
                      <span class="s1">&#39;the input data and/or the in_filter parameter!&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">[]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">files</span> <span class="o">=</span> <span class="n">files</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_filter</span> <span class="o">==</span> <span class="s1">&#39;GM + WM&#39;</span><span class="p">:</span>
                <span class="n">j</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">files</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="k">while</span> <span class="n">files</span><span class="p">:</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="n">files</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                    <span class="n">i_path</span><span class="p">,</span> <span class="n">i_file</span> <span class="o">=</span>  <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">i_file</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;c1&#39;</span><span class="p">,</span> <span class="s1">&#39;c2&#39;</span><span class="p">]:</span>

                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">ind</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">k</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">files</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span>
                                                              <span class="s1">&#39;c2&#39;</span> <span class="o">+</span> <span class="n">i_file</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span>

                        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                            <span class="k">pass</span>

                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">files</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">ind</span><span class="p">))</span>
                            <span class="n">j</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">i_path</span><span class="p">,</span> <span class="s1">&#39;c1c2&#39;</span> <span class="o">+</span> <span class="n">i_file</span><span class="p">[</span><span class="mi">2</span><span class="p">:]))</span>

                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">ind</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">k</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">files</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span>
                                                              <span class="s1">&#39;c1&#39;</span> <span class="o">+</span> <span class="n">i_file</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span>

                        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                            <span class="k">pass</span>

                        <span class="k">else</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">files</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">ind</span><span class="p">))</span>
                            <span class="n">j</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">i_path</span><span class="p">,</span> <span class="s1">&#39;c1c2&#39;</span> <span class="o">+</span> <span class="n">i_file</span><span class="p">[</span><span class="mi">2</span><span class="p">:]))</span>

                <span class="n">files</span> <span class="o">=</span> <span class="n">j</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Warning: no c1+c2 doublet was detected ... &#39;</span>
                          <span class="s1">&#39;Please, check the input data and/or the in_filter &#39;</span>
                          <span class="s1">&#39;parameter!&#39;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="p">[]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">runFlag</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_filter</span> <span class="o">==</span> <span class="s1">&#39;GM + WM&#39;</span><span class="p">:</span>

                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="mi">0</span><span class="p">::</span><span class="mi">2</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]):</span>
                    <span class="n">img1</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                    <span class="n">img2</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>

                    <span class="k">if</span> <span class="p">(</span><span class="n">img1</span><span class="o">.</span><span class="n">affine</span> <span class="o">!=</span> <span class="n">img2</span><span class="o">.</span><span class="n">affine</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Warning! The affine arrays for </span><span class="si">{0}</span><span class="s1"> and </span><span class="si">{1}</span><span class="s1"> &#39;</span>
                              <span class="s1">&#39;are not the same. This can produce an erroneous &#39;</span>
                              <span class="s1">&#39;result!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">))</span>

                    <span class="n">img1_data</span> <span class="o">=</span> <span class="n">img1</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">()</span>
                    <span class="n">img2_data</span> <span class="o">=</span> <span class="n">img2</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">()</span>

                    <span class="k">if</span> <span class="n">img1_data</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="n">img2_data</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Warning! The shapes for </span><span class="si">{0}</span><span class="s1"> and </span><span class="si">{1}</span><span class="s1"> are not &#39;</span>
                              <span class="s1">&#39;the same. This can produce an erroneous &#39;</span>
                              <span class="s1">&#39;result!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">))</span>

                    <span class="n">c1c2_img_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">img1_data</span><span class="p">,</span> <span class="n">img2_data</span><span class="p">)</span>
                    <span class="n">c1c2_img</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">Nifti1Image</span><span class="p">(</span><span class="n">c1c2_img_data</span><span class="p">,</span>
                                               <span class="n">header</span><span class="o">=</span><span class="n">img1</span><span class="o">.</span><span class="n">header</span><span class="p">,</span>
                                               <span class="n">affine</span><span class="o">=</span><span class="n">img1</span><span class="o">.</span><span class="n">affine</span><span class="p">)</span>
                    <span class="n">c1c2_img</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s1">&#39;descrip&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="sa">b</span><span class="s1">&#39;Tissue class 1 + &#39;</span>
                                                          <span class="sa">b</span><span class="s1">&#39;Tissue class 2&#39;</span><span class="p">,</span>
                                                          <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;|S80&#39;</span><span class="p">)</span>
                    <span class="n">temp_dir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">()</span>
                    <span class="n">c1c2_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">,</span>
                                             <span class="s1">&#39;c1c2&#39;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">i</span><span class="p">)[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">:])</span>
                    <span class="n">nib</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">c1c2_img</span><span class="p">,</span> <span class="n">c1c2_file</span><span class="p">)</span>
                    <span class="n">files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c1c2_file</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">files</span>

        <span class="k">return</span> <span class="n">files</span>

<div class="viewcode-block" id="GM_WM_Normalize.list_outputs"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.spm.html#mia_processes.bricks.preprocess.spm.spatial_preprocessing.GM_WM_Normalize.list_outputs">[docs]</a>    <span class="k">def</span> <span class="nf">list_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_plugged</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the initialisation step of the brick.</span>

<span class="sd">        The main objective of this method is to produce the outputs of the</span>
<span class="sd">        bricks (self.outputs) and the associated tags (self.inheritance_dic),</span>
<span class="sd">        if defined here. In order not to include an output in the database,</span>
<span class="sd">        this output must be a value of the optional key &#39;notInDb&#39; of the</span>
<span class="sd">        self.outputs dictionary. To work properly this method must return </span>
<span class="sd">        self.make_initResult() object.</span>

<span class="sd">        :param is_plugged: the state, linked or not, of the plugs.</span>
<span class="sd">        :returns: a dictionary with requirement, outputs and inheritance_dict.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Using the inheritance to ProcessMIA class, list_outputs method</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">GM_WM_Normalize</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">list_outputs</span><span class="p">()</span>

        <span class="c1"># Outputs definition and tags inheritance (optional)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runFlag</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">jobtype</span> <span class="o">=</span> <span class="s1">&#39;write&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">apply_to_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_namesFilter</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">apply_to_files</span> <span class="o">!=</span> <span class="n">Undefined</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">deformation_file</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">deformation_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">deformation_file</span>

            <span class="c1"># The management of self.process.output_directory could be delegated</span>
            <span class="c1"># to the populse_mia.user_interface.pipeline_manager.process_mia</span>
            <span class="c1"># module. We can&#39;t do it at the moment because the</span>
            <span class="c1"># sync_process_output_traits() of the capsul/process/nipype_process</span>
            <span class="c1"># module raises an exception in nipype if the mandatory parameters</span>
            <span class="c1"># are not yet defined!</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">output_directory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No output_directory was found...!</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;normalized_files&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">_normalized_files</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">:</span>

            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;normalized_files&quot;</span><span class="p">):</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_filter</span> <span class="o">==</span> <span class="s1">&#39;GM + WM&#39;</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">inheritance_dict</span><span class="p">[</span><span class="n">val</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_to_files</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="c1"># FIXME: In the latest version of mia, indexing of the database with</span>
                        <span class="c1">#        particular tags defined in the processes is done only at</span>
                        <span class="c1">#        the end of the initialisation of the whole pipeline. So we</span>
                        <span class="c1">#        cannot use the value of these tags in other processes of</span>
                        <span class="c1">#        the pipeline at the time of initialisation</span>
                        <span class="c1">#        (see populse_mia #290). Until better we use a quick and</span>
                        <span class="c1">#        dirty hack with the set_dbFieldValue() method !</span>
                        <span class="n">tag_to_add</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;PatientName&quot;</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;field_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;string&quot;</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;visibility&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;origin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;user&quot;</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;unit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;default_value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_dbFieldValue</span><span class="p">(</span>
                                                      <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span>
                                                      <span class="bp">self</span><span class="o">.</span><span class="n">apply_to_files</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                                                      <span class="s2">&quot;PatientName&quot;</span><span class="p">)</span>

                        <span class="k">if</span> <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">set_dbFieldValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span>
                                             <span class="n">val</span><span class="p">,</span>
                                             <span class="n">tag_to_add</span><span class="p">)</span>

                        <span class="k">else</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span>
                                <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">GM_WM_Normalize brick:</span><span class="se">\n</span><span class="s2">The &#39;PatientName&#39;&quot;</span>
                                <span class="s2">&quot; tag could not be added to the &quot;</span>
                                <span class="s2">&quot;database for the &#39;</span><span class="si">{}</span><span class="s2">&#39; parameter. This &quot;</span>
                                <span class="s2">&quot;can lead to a subsequent issue during &quot;</span>
                                <span class="s2">&quot;initialization!!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>

                    <span class="k">else</span><span class="p">:</span>

                        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                            <span class="n">val</span> <span class="o">=</span> <span class="p">[</span><span class="n">val</span><span class="p">]</span>

                        <span class="k">for</span> <span class="p">(</span><span class="n">in_val</span><span class="p">,</span>
                              <span class="n">out_val</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">apply_to_files</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
                            <span class="n">_</span><span class="p">,</span> <span class="n">fileOval</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">out_val</span><span class="p">)</span>
                            <span class="n">_</span><span class="p">,</span> <span class="n">fileIval</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">in_val</span><span class="p">)</span>
                            <span class="n">fileOvalNoPref</span> <span class="o">=</span> <span class="n">fileOval</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

                            <span class="k">if</span> <span class="n">fileOvalNoPref</span> <span class="o">==</span> <span class="n">fileIval</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">inheritance_dict</span><span class="p">[</span><span class="n">out_val</span><span class="p">]</span> <span class="o">=</span> <span class="n">in_val</span>
                                <span class="c1"># FIXME: In the latest version of mia, indexing of the database with</span>
                                <span class="c1">#        particular tags defined in the processes is done only at</span>
                                <span class="c1">#        the end of the initialisation of the whole pipeline. So we</span>
                                <span class="c1">#        cannot use the value of these tags in other processes of</span>
                                <span class="c1">#        the pipeline at the time of initialisation</span>
                                <span class="c1">#        (see populse_mia #290). Until better we use a quick and</span>
                                <span class="c1">#        dirty hack with the set_dbFieldValue() method !</span>
                                <span class="n">tag_to_add</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                                <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;PatientName&quot;</span>
                                <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;field_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;string&quot;</span>
                                <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                                <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;visibility&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                                <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;origin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;user&quot;</span>
                                <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;unit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                                <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;default_value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                                <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_dbFieldValue</span><span class="p">(</span>
                                                                  <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span>
                                                                  <span class="n">in_val</span><span class="p">,</span>
                                                                  <span class="s2">&quot;PatientName&quot;</span><span class="p">)</span>

                                <span class="k">if</span> <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                    <span class="n">set_dbFieldValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span>
                                                     <span class="n">out_val</span><span class="p">,</span>
                                                     <span class="n">tag_to_add</span><span class="p">)</span>

                                <span class="k">else</span><span class="p">:</span>
                                    <span class="nb">print</span><span class="p">(</span>
                                        <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">GM_WM_Normalize brick:</span><span class="se">\n</span><span class="s2">The &quot;</span>
                                        <span class="s2">&quot;&#39;PatientName&#39; tag could not be added &quot;</span>
                                        <span class="s2">&quot;to the database for the &#39;</span><span class="si">{}</span><span class="s2">&#39; &quot;</span>
                                        <span class="s2">&quot;parameter. This can lead to a &quot;</span>
                                        <span class="s2">&quot;subsequent issue during &quot;</span>
                                        <span class="s2">&quot;initialization!!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">out_val</span><span class="p">))</span>

        <span class="c1"># Return the requirement, outputs and inheritance_dict</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_initResult</span><span class="p">()</span></div>

<div class="viewcode-block" id="GM_WM_Normalize.run_process_mia"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.spm.html#mia_processes.bricks.preprocess.spm.spatial_preprocessing.GM_WM_Normalize.run_process_mia">[docs]</a>    <span class="k">def</span> <span class="nf">run_process_mia</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the process launch step of the brick.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runFlag</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">jobtype</span> <span class="o">=</span> <span class="s1">&#39;write&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">apply_to_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_namesFilter</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">deformation_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">deformation_file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">write_bounding_box</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_bounding_box</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">write_voxel_sizes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_voxel_sizes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">write_interp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_interp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">trait</span><span class="p">(</span><span class="s1">&#39;image_to_align&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">optional</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># because the sync_process_output_traits() of the capsul/process/nipype_process</span>
        <span class="c1"># module raises an exception in nipype if the mandatory parameters</span>
        <span class="c1"># are not yet defined, the next line can&#39;t be write before!</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">GM_WM_Normalize</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">run_process_mia</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">configuration_dict</span><span class="o">=</span><span class="p">{})</span></div></div>


<div class="viewcode-block" id="NewSegment"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.spm.html#mia_processes.bricks.preprocess.spm.spatial_preprocessing.NewSegment">[docs]</a><span class="k">class</span> <span class="nc">NewSegment</span><span class="p">(</span><span class="n">ProcessMIA</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    *Segmentation: Segments, bias corrects and spatially normalises - all in the same model*</span>

<span class="sd">    Please, see the complete documention for the `NewSegment brick in the populse.mia_processes web site</span>
<span class="sd">    &lt;https://populse.github.io/mia_processes/html/documentation/bricks/preprocess/spm/NewSegment.html&gt;`_</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="NewSegment.__init__"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.spm.html#mia_processes.bricks.preprocess.spm.spatial_preprocessing.NewSegment.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the attributes initialisation/instantiation.</span>
<span class="sd">        </span>
<span class="sd">        The input and output plugs are defined here. The special</span>
<span class="sd">        &#39;self.requirement&#39; attribute (optional) is used to define the</span>
<span class="sd">        third-party products necessary for the running of the brick.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># initialisation of the objects needed for the launch of the brick</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">NewSegment</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1"># Third party softwares required for the execution of the brick</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requirement</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;spm&#39;</span><span class="p">,</span> <span class="s1">&#39;nipype&#39;</span><span class="p">]</span>

        <span class="c1"># Inputs description</span>

        <span class="n">channel_files_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Path of the scans for processing, valid &#39;</span>
                              <span class="s1">&#39;extensions: [.img, .nii, .hdr]. A list with one &#39;</span>
                              <span class="s1">&#39;string element corresponding to an existing &#39;</span>
                              <span class="s1">&#39;path file.&#39;</span><span class="p">)</span>
        <span class="n">channel_info_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;A tuple with the following values: bias &#39;</span>
                             <span class="s1">&#39;reguralisation -a float between 0 and 10-, bias &#39;</span>
                             <span class="s1">&#39;FWHM -a float between 20 and infinity-, which &#39;</span>
                             <span class="s1">&#39;maps to save -a tuple of two boolean values &#39;</span>
                             <span class="s1">&#39;(estimated bias field, bias corrected image)-.&#39;</span><span class="p">)</span>
        <span class="n">tissues_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;A list of tuples with the following values for each &#39;</span>
                        <span class="s1">&#39;tissue types (grey matter, white matter, etc.): &#39;</span>
                        <span class="s1">&#39;(tissue probability map (4D), 1-based index to frame),&#39;</span>
                        <span class="s1">&#39; number of gaussians, (which maps to save: Native,&#39;</span>
                        <span class="s1">&#39;DARTEL), (which maps to save: Unmodulated, Modulated),&#39;</span>
                        <span class="s1">&#39; ...&#39;</span><span class="p">)</span>
        <span class="n">warping_regularization_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Define of the roughness of the &#39;</span>
                                       <span class="s1">&#39;deformations for registration using &#39;</span>
                                       <span class="s1">&#39;1 or 5 elements: a float or a list of &#39;</span>
                                       <span class="s1">&#39;floats, the latter is required &#39;</span>
                                       <span class="s1">&#39;by SPM12.&#39;</span><span class="p">)</span>
        <span class="n">affine_regularization_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Standard space for affine registration: &#39;</span>
                                      <span class="s1">&#39;mni, eastern, subj or none.&#39;</span><span class="p">)</span>

        <span class="n">sampling_distance_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Approximate distance between sampled points &#39;</span>
                                 <span class="s1">&#39;when estimating the model parameters: &#39;</span>
                                 <span class="s1">&#39;a float.&#39;</span><span class="p">)</span>

        <span class="n">write_deformation_fields</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Which deformation fields, that can be used&#39;</span>
                                    <span class="s1">&#39; by the deformation utility, to save: a &#39;</span>
                                    <span class="s1">&#39;list of 2 booleans for Inverse, Forward.&#39;</span><span class="p">)</span>

        <span class="c1"># Outputs description</span>
        <span class="n">bias_corrected_images_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Bias corrected images (a pathlike &#39;</span>
                                      <span class="s1">&#39;object or string representing a file, &#39;</span>
                                      <span class="s1">&#39;or a list of pathlike objects or &#39;</span>
                                      <span class="s1">&#39;strings representing a file).&#39;</span><span class="p">)</span>
        <span class="n">bias_field_images_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Estimated bias field (a pathlike object or&#39;</span>
                                  <span class="s1">&#39;string representing a file, or a list of &#39;</span>
                                  <span class="s1">&#39;pathlike objects or strings representing a &#39;</span>
                                  <span class="s1">&#39;file).&#39;</span><span class="p">)</span>
        <span class="n">native_class_images_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Native space probability maps (a list of &#39;</span>
                                    <span class="s1">&#39;items which are a list of items which are &#39;</span>
                                    <span class="s1">&#39;a pathlike object or string representing &#39;</span>
                                    <span class="s1">&#39;a file).&#39;</span><span class="p">)</span>
        <span class="n">dartel_input_images_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;“Imported” class images into a form that &#39;</span>
                                    <span class="s1">&#39;can be used with the Dartel toolbox (a &#39;</span>
                                    <span class="s1">&#39;list of items which are a list of items &#39;</span>
                                    <span class="s1">&#39;which are a pathlike object or string &#39;</span>
                                    <span class="s1">&#39;representing a file).&#39;</span><span class="p">)</span>
        <span class="n">modulated_class_images_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Modulated and normalised class images &#39;</span>
                                       <span class="s1">&#39;(a list of items which are a list of &#39;</span>
                                       <span class="s1">&#39;items which are a pathlike object or &#39;</span>
                                       <span class="s1">&#39;string representing a file).&#39;</span><span class="p">)</span>
        <span class="n">normalized_class_images_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Normalised class images, without &#39;</span>
                                        <span class="s1">&#39;modulation (a list of items which are &#39;</span>
                                        <span class="s1">&#39;a list of items which are a pathlike &#39;</span>
                                        <span class="s1">&#39;object or string representing a file&#39;</span><span class="p">)</span>
        <span class="n">inverse_deformation_field_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Inverse deformation field (a &#39;</span>
                                          <span class="s1">&#39;pathlike object or string &#39;</span>
                                          <span class="s1">&#39;representing a file, or a list of &#39;</span>
                                          <span class="s1">&#39;pathlike objects or strings &#39;</span>
                                          <span class="s1">&#39;representing a file).&#39;</span><span class="p">)</span>
        <span class="n">forward_deformation_field_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Forward deformation field (a &#39;</span>
                                          <span class="s1">&#39;pathlike object or string &#39;</span>
                                          <span class="s1">&#39;representing a file).&#39;</span><span class="p">)</span>
        <span class="n">transformation_mat_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Normalisation transformation (a pathlike &#39;</span>
                                   <span class="s1">&#39;object or string representing a file).&#39;</span><span class="p">)</span>

        <span class="c1"># Tissues parameter definition</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">Config</span><span class="p">()</span>
        <span class="n">tissues_list</span> <span class="o">=</span> <span class="n">Undefined</span>

        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">get_resources_path</span><span class="p">():</span>
            <span class="n">tpm_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">get_resources_path</span><span class="p">(),</span> <span class="s1">&#39;spm12&#39;</span><span class="p">,</span>
                                    <span class="s1">&#39;tpm&#39;</span><span class="p">,</span> <span class="s1">&#39;TPM.nii&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">Path</span><span class="p">(</span><span class="n">tpm_path</span><span class="p">)</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">NewSegment brick:</span><span class="se">\n</span><span class="s1">  - The </span><span class="si">{}</span><span class="s1"> file &#39;</span>
                      <span class="s1">&#39;seems to not exists ...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tpm_path</span><span class="p">))</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">tissues_list</span> <span class="o">=</span> <span class="p">[((</span><span class="n">tpm_path</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
                                 <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">)),</span>
                                <span class="p">((</span><span class="n">tpm_path</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
                                 <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">)),</span>
                                <span class="p">((</span><span class="n">tpm_path</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
                                 <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">)),</span>
                                <span class="p">((</span><span class="n">tpm_path</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="mi">3</span><span class="p">,</span> <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
                                 <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">)),</span>
                                <span class="p">((</span><span class="n">tpm_path</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="mi">4</span><span class="p">,</span> <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
                                 <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">)),</span>
                                <span class="p">((</span><span class="n">tpm_path</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
                                 <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">))]</span>

        <span class="c1"># Inputs traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;channel_files&quot;</span><span class="p">,</span>
                       <span class="n">InputMultiPath</span><span class="p">(</span><span class="n">ImageFileSPM</span><span class="p">(),</span>
                                      <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                      <span class="n">optional</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                      <span class="n">desc</span><span class="o">=</span><span class="n">channel_files_desc</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;channel_info&quot;</span><span class="p">,</span>
                       <span class="n">Tuple</span><span class="p">(</span><span class="n">Range</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="mf">0.0001</span><span class="p">,</span>
                                   <span class="n">low</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span>
                                   <span class="n">high</span><span class="o">=</span><span class="mf">10.</span><span class="p">),</span>
                             <span class="n">Range</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="mf">60.</span><span class="p">,</span>
                                   <span class="n">low</span><span class="o">=</span><span class="mf">20.</span><span class="p">,</span>
                                   <span class="n">high</span><span class="o">=</span><span class="kc">None</span><span class="p">),</span>
                             <span class="n">Tuple</span><span class="p">(</span><span class="n">Bool</span><span class="p">(</span><span class="kc">False</span><span class="p">),</span>
                                   <span class="n">Bool</span><span class="p">(</span><span class="kc">True</span><span class="p">)),</span>
                             <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                             <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                             <span class="n">desc</span><span class="o">=</span><span class="n">channel_info_desc</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;tissues&quot;</span><span class="p">,</span>
                       <span class="n">Either</span><span class="p">(</span>
                           <span class="n">List</span><span class="p">(</span>
                               <span class="n">Tuple</span><span class="p">(</span>
                                   <span class="n">Tuple</span><span class="p">(</span><span class="n">ImageFileSPM</span><span class="p">(</span><span class="n">exists</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
                                         <span class="n">Int</span><span class="p">()),</span>
                                   <span class="n">Int</span><span class="p">(),</span>
                                   <span class="n">Tuple</span><span class="p">(</span><span class="n">Bool</span><span class="p">,</span> <span class="n">Bool</span><span class="p">),</span>
                                   <span class="n">Tuple</span><span class="p">(</span><span class="n">Bool</span><span class="p">,</span> <span class="n">Bool</span><span class="p">))),</span>
                           <span class="n">Undefined</span><span class="p">,</span>
                           <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                           <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                           <span class="n">desc</span><span class="o">=</span><span class="n">tissues_desc</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tissues</span> <span class="o">=</span> <span class="n">tissues_list</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;warping_regularization&quot;</span><span class="p">,</span>
                       <span class="n">Either</span><span class="p">(</span><span class="n">List</span><span class="p">(</span><span class="n">Float</span><span class="p">(),</span>
                                   <span class="n">minlen</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                                   <span class="n">maxlen</span><span class="o">=</span><span class="mi">5</span><span class="p">),</span>
                              <span class="n">Float</span><span class="p">(),</span>
                              <span class="n">default</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">],</span>
                              <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                              <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                              <span class="n">desc</span><span class="o">=</span><span class="n">warping_regularization_desc</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;affine_regularization&quot;</span><span class="p">,</span>
                       <span class="n">Enum</span><span class="p">(</span><span class="s1">&#39;mni&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;eastern&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;subj&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;none&#39;</span><span class="p">,</span>
                            <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">desc</span><span class="o">=</span><span class="n">affine_regularization_desc</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;sampling_distance&quot;</span><span class="p">,</span>
                       <span class="n">Float</span><span class="p">(</span><span class="mf">3.0</span><span class="p">,</span>
                             <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                             <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                             <span class="n">desc</span><span class="o">=</span><span class="n">sampling_distance_desc</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;write_deformation_fields&quot;</span><span class="p">,</span>
                       <span class="n">List</span><span class="p">(</span><span class="n">Bool</span><span class="p">(),</span>
                            <span class="n">minlen</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                            <span class="n">maxlen</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                            <span class="n">value</span><span class="o">=</span><span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">],</span>
                            <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">desc</span><span class="o">=</span><span class="n">write_deformation_fields</span><span class="p">))</span>

        <span class="c1"># Output traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;bias_corrected_images&quot;</span><span class="p">,</span>
                       <span class="n">OutputMultiPath</span><span class="p">(</span><span class="n">File</span><span class="p">(),</span>
                                       <span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                       <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                       <span class="n">desc</span><span class="o">=</span><span class="n">bias_corrected_images_desc</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;bias_field_images&quot;</span><span class="p">,</span>
                       <span class="n">OutputMultiPath</span><span class="p">(</span><span class="n">File</span><span class="p">(),</span>
                                       <span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                       <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                       <span class="n">desc</span><span class="o">=</span><span class="n">bias_field_images_desc</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;native_class_images&quot;</span><span class="p">,</span>
                       <span class="n">OutputMultiPath</span><span class="p">(</span><span class="n">List</span><span class="p">(</span><span class="n">File</span><span class="p">()),</span>
                            <span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">desc</span><span class="o">=</span><span class="n">native_class_images_desc</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;dartel_input_images&quot;</span><span class="p">,</span>
                       <span class="n">OutputMultiPath</span><span class="p">(</span><span class="n">List</span><span class="p">(</span><span class="n">File</span><span class="p">()),</span>
                            <span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">desc</span><span class="o">=</span><span class="n">dartel_input_images_desc</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;modulated_class_images&quot;</span><span class="p">,</span>
                       <span class="n">OutputMultiPath</span><span class="p">(</span><span class="n">List</span><span class="p">(</span><span class="n">File</span><span class="p">()),</span>
                            <span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">desc</span><span class="o">=</span><span class="n">modulated_class_images_desc</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;normalized_class_images&quot;</span><span class="p">,</span>
                       <span class="n">OutputMultiPath</span><span class="p">(</span><span class="n">List</span><span class="p">(</span><span class="n">File</span><span class="p">()),</span>
                            <span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">desc</span><span class="o">=</span><span class="n">normalized_class_images_desc</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;inverse_deformation_field&quot;</span><span class="p">,</span>
                       <span class="n">OutputMultiPath</span><span class="p">(</span><span class="n">File</span><span class="p">(),</span>
                                       <span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                       <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                       <span class="n">desc</span><span class="o">=</span><span class="n">inverse_deformation_field_desc</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;forward_deformation_field&quot;</span><span class="p">,</span>
                       <span class="n">OutputMultiPath</span><span class="p">(</span><span class="n">ImageFileSPM</span><span class="p">(),</span>
                                       <span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                       <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                       <span class="n">desc</span><span class="o">=</span><span class="n">forward_deformation_field_desc</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;transformation_mat&quot;</span><span class="p">,</span>
                       <span class="n">OutputMultiPath</span><span class="p">(</span><span class="n">File</span><span class="p">(),</span>
                                       <span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                       <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                       <span class="n">desc</span><span class="o">=</span><span class="n">transformation_mat_desc</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">init_default_traits</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_process</span><span class="p">(</span><span class="s1">&#39;nipype.interfaces.spm.NewSegment&#39;</span><span class="p">)</span>

        <span class="sd">&quot;&quot;&quot; To be removed for V2</span>
<span class="sd">        # process instantiation</span>
<span class="sd">        self.process = NewSegmentMia() # workaround to try to decrease the</span>
<span class="sd">                                       # instantiation time of the NewSegment</span>
<span class="sd">                                       # class</span>
<span class="sd">        #self.process = spm.NewSegment()</span>
<span class="sd">        &quot;&quot;&quot;</span></div>

<div class="viewcode-block" id="NewSegment.list_outputs"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.spm.html#mia_processes.bricks.preprocess.spm.spatial_preprocessing.NewSegment.list_outputs">[docs]</a>    <span class="k">def</span> <span class="nf">list_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_plugged</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the initialisation step of the brick.</span>

<span class="sd">        The main objective of this method is to produce the outputs of the</span>
<span class="sd">        bricks (self.outputs) and the associated tags (self.inheritance_dic),</span>
<span class="sd">        if defined here. In order not to include an output in the database,</span>
<span class="sd">        this output must be a value of the optional key &#39;notInDb&#39; of the</span>
<span class="sd">        self.outputs dictionary. To work properly this method must return </span>
<span class="sd">        self.make_initResult() object.</span>

<span class="sd">        :param is_plugged: the state, linked or not, of the plugs.</span>
<span class="sd">        :returns: a dictionary with requirement, outputs and inheritance_dict.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Using the inheritance to ProcessMIA class, list_outputs method</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">NewSegment</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">list_outputs</span><span class="p">()</span>

        <span class="c1"># Outputs definition and tags inheritance (optional)</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">channel_files</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">channel_info</span> <span class="ow">and</span>
                       <span class="bp">self</span><span class="o">.</span><span class="n">write_deformation_fields</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">tissues</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">channel_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">channel_files</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">channel_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">channel_info</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span>
                  <span class="n">write_deformation_fields</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_deformation_fields</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">tissues</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tissues</span>

            <span class="c1"># The management of self.process.output_directory could be delegated</span>
            <span class="c1"># to the populse_mia.user_interface.pipeline_manager.process_mia</span>
            <span class="c1"># module. We can&#39;t do it at the moment because the</span>
            <span class="c1"># sync_process_output_traits() of the capsul/process/nipype_process</span>
            <span class="c1"># module raises an exception in nipype if the mandatory parameters</span>
            <span class="c1"># are not yet defined!</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">output_directory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No output_directory was found...!</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;bias_corrected_images&#39;</span><span class="p">,</span> <span class="s1">&#39;bias_field_images&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;native_class_images&#39;</span><span class="p">,</span> <span class="s1">&#39;dartel_input_images&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;modulated_class_images&#39;</span><span class="p">,</span> <span class="s1">&#39;normalized_class_images&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;inverse_deformation_field&#39;</span><span class="p">,</span> <span class="s1">&#39;forward_deformation_field&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;transformation_mat&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">k</span><span class="p">)</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        When there is only one image at the input, the tags inheritance is</span>
<span class="sd">        directly managed in PipelineManagerTab.add_plug_value_to_database().</span>
<span class="sd">        However the inheritance of 2 output parameters is defined below, as</span>
<span class="sd">        an example</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">:</span>

            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;native_class_images&quot;</span><span class="p">:</span>

                    <span class="k">if</span> <span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                        <span class="n">inp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">channel_files</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                        <span class="n">out</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">val</span><span class="p">]</span>

                        <span class="k">for</span> <span class="n">in_val</span><span class="p">,</span> <span class="n">out_val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">inp</span><span class="p">,</span> <span class="n">out</span><span class="p">):</span>
                            <span class="n">_</span><span class="p">,</span> <span class="n">fileOval</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">out_val</span><span class="p">)</span>
                            <span class="n">_</span><span class="p">,</span> <span class="n">fileIval</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">in_val</span><span class="p">)</span>
                            <span class="n">fileOvalNoPref</span> <span class="o">=</span> <span class="n">fileOval</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>

                            <span class="k">if</span> <span class="n">fileOvalNoPref</span> <span class="o">==</span> <span class="n">fileIval</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">inheritance_dict</span><span class="p">[</span><span class="n">out_val</span><span class="p">]</span> <span class="o">=</span> <span class="n">in_val</span>
                                <span class="c1"># FIXME: In the latest version of mia, indexing of the database with</span>
                                <span class="c1">#        particular tags defined in the processes is done only at</span>
                                <span class="c1">#        the end of the initialisation of the whole pipeline. So we</span>
                                <span class="c1">#        cannot use the value of these tags in other processes of</span>
                                <span class="c1">#        the pipeline at the time of initialisation</span>
                                <span class="c1">#        (see populse_mia #290). Until better we use a quick and</span>
                                <span class="c1">#        dirty hack with the set_dbFieldValue() method !</span>
                                <span class="n">tag_to_add</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                                <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;PatientName&quot;</span>
                                <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;field_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;string&quot;</span>
                                <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                                <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;visibility&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                                <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;origin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;user&quot;</span>
                                <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;unit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                                <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;default_value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                                <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_dbFieldValue</span><span class="p">(</span>
                                                                  <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span>
                                                                  <span class="n">in_val</span><span class="p">,</span>
                                                                  <span class="s2">&quot;PatientName&quot;</span><span class="p">)</span>

                                <span class="k">if</span> <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                    <span class="n">set_dbFieldValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span>
                                                     <span class="n">out_val</span><span class="p">,</span>
                                                     <span class="n">tag_to_add</span><span class="p">)</span>

                                <span class="k">else</span><span class="p">:</span>
                                    <span class="nb">print</span><span class="p">(</span>
                                        <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">NewSegment brick:</span><span class="se">\n</span><span class="s2">The &#39;PatientName&#39;&quot;</span>
                                        <span class="s2">&quot; tag could not be added to the &quot;</span>
                                        <span class="s2">&quot;database for the &#39;</span><span class="si">{}</span><span class="s2">&#39; parameter. This &quot;</span>
                                        <span class="s2">&quot;can lead to a subsequent issue during &quot;</span>
                                        <span class="s2">&quot;initialization!!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">out_val</span><span class="p">))</span>

                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;forward_deformation_field&quot;</span><span class="p">:</span>

                    <span class="k">if</span> <span class="n">val</span> <span class="o">!=</span> <span class="n">Undefined</span><span class="p">:</span>
                        <span class="n">val</span> <span class="o">=</span> <span class="p">[</span><span class="n">val</span><span class="p">]</span>

                        <span class="k">for</span> <span class="n">in_val</span><span class="p">,</span> <span class="n">out_val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">channel_files</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
                            <span class="n">_</span><span class="p">,</span> <span class="n">fileOval</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">out_val</span><span class="p">)</span>
                            <span class="n">_</span><span class="p">,</span> <span class="n">fileIval</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">in_val</span><span class="p">)</span>
                            <span class="n">fileOvalNoPref</span> <span class="o">=</span> <span class="n">fileOval</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>

                            <span class="k">if</span> <span class="n">fileOvalNoPref</span> <span class="o">==</span> <span class="n">fileIval</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">inheritance_dict</span><span class="p">[</span><span class="n">out_val</span><span class="p">]</span> <span class="o">=</span> <span class="n">in_val</span>

        <span class="c1"># Return the requirement, outputs and inheritance_dict</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_initResult</span><span class="p">()</span></div>

<div class="viewcode-block" id="NewSegment.run_process_mia"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.spm.html#mia_processes.bricks.preprocess.spm.spatial_preprocessing.NewSegment.run_process_mia">[docs]</a>    <span class="k">def</span> <span class="nf">run_process_mia</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the process launch step of the brick.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">NewSegment</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">run_process_mia</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">channel_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">channel_files</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">channel_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">channel_info</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">tissues</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tissues</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">warping_regularization</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">warping_regularization</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">affine_regularization</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">affine_regularization</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">sampling_distance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sampling_distance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">write_deformation_fields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_deformation_fields</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">configuration_dict</span><span class="o">=</span><span class="p">{})</span></div></div>


<div class="viewcode-block" id="Normalize12"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.spm.html#mia_processes.bricks.preprocess.spm.spatial_preprocessing.Normalize12">[docs]</a><span class="k">class</span> <span class="nc">Normalize12</span><span class="p">(</span><span class="n">ProcessMIA</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;    </span>
<span class="sd">    *Computes the warp that best aligns the template (atlas) to the individual’s image*</span>

<span class="sd">    Please, see the complete documention for the `Normalize12 brick in the populse.mia_processes web site</span>
<span class="sd">    &lt;https://populse.github.io/mia_processes/html/documentation/bricks/preprocess/spm/Normalize12.html&gt;`_</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Normalize12.__init__"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.spm.html#mia_processes.bricks.preprocess.spm.spatial_preprocessing.Normalize12.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the attributes initialisation/instantiation.</span>
<span class="sd">        </span>
<span class="sd">        The input and output plugs are defined here. The special</span>
<span class="sd">        &#39;self.requirement&#39; attribute (optional) is used to define the</span>
<span class="sd">        third-party products necessary for the running of the brick.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Initialisation of the objects needed for the launch of the brick</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Normalize12</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1"># Third party softwares required for the execution of the brick</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requirement</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;spm&#39;</span><span class="p">,</span> <span class="s1">&#39;nipype&#39;</span><span class="p">]</span>

        <span class="c1"># Inputs description</span>
        <span class="n">image_to_align_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;The image that the atlas data is warped into &#39;</span>
                               <span class="s1">&#39;alignment with (an existing file; valid &#39;</span>
                               <span class="s1">&#39;extensions in [.img, .nii, .hdr]). Mutually &#39;</span>
                               <span class="s1">&#39;exclusive with the deformation_file parameter.&#39;</span><span class="p">)</span>
        <span class="n">deformation_file_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;File y_*.nii containing 3 deformation fields &#39;</span>
                                 <span class="s1">&#39;for the deformation in x, y and z dimension &#39;</span>
                                 <span class="s1">&#39;(an uncompressed file; valid extensions in &#39;</span>
                                 <span class="s1">&#39;[.img, .nii, .hdr]). Mutually exclusive with &#39;</span>
                                 <span class="s1">&#39;the image_to_align and tpm parameters.&#39;</span><span class="p">)</span>
        <span class="n">apply_to_files_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Files to apply transformation to. A list of &#39;</span>
                               <span class="s1">&#39;items which are an existing, uncompressed file &#39;</span>
                               <span class="s1">&#39;(valid extensions: [.img, .nii, .hdr]).&#39;</span><span class="p">)</span>
        <span class="n">jobtype_desc</span> <span class="o">=</span> <span class="s1">&#39;One of &quot;estwrite&quot; or &quot;estimate&quot; or &quot;write&quot;.&#39;</span>
        <span class="n">bias_regularization_desc</span> <span class="o">=</span><span class="p">(</span><span class="s1">&#39;(For low-intensity non-uniformity artifacts&#39;</span>
                                   <span class="s1">&#39;, use a high bias regularization (a float &#39;</span>
                                   <span class="s1">&#39; between 0 and 10).&#39;</span><span class="p">)</span>
        <span class="n">bias_fwhm_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Full Width at Half Maximum of Gaussian smoothness &#39;</span>
                          <span class="s1">&#39;of bias (a value in [30, 40, 50, 60, 70, 80, 90, &#39;</span>
                          <span class="s1">&#39;100, 110, 120, 130, 140, 150, ‘Inf’).&#39;</span><span class="p">)</span>
        <span class="n">tpm_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;The template in form of tissue probability atlas (a &#39;</span>
                    <span class="s1">&#39;pathlike object or string representing an existing file). &#39;</span>
                    <span class="s1">&#39;Mutually exclusive with the deformation_file parameter.&#39;</span><span class="p">)</span>
        <span class="n">affine_regularization_type_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Standard space for affine &quot;</span>
                                           <span class="s2">&quot;registration (‘mni’ or ‘size’ or &quot;</span>
                                           <span class="s2">&quot;‘none’).&quot;</span><span class="p">)</span>
        <span class="n">warping_regularization_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;The measure of the roughness of the &#39;</span>
                                       <span class="s1">&#39;deformations for registration. Involve &#39;</span>
                                       <span class="s1">&#39;the sum of 5 elements (list of &#39;</span>
                                       <span class="s1">&#39;floats).&#39;</span><span class="p">)</span>
        <span class="n">smoothness_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Value to smooth the data before normalisation (a &#39;</span>
                           <span class="s1">&#39;float; in mm). 0 is a good value for MRI.&#39;</span><span class="p">)</span>
        <span class="n">sampling_distance_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Approximate distance between sampled points &#39;</span>
                                  <span class="s1">&#39;when estimating the model parameters (a &#39;</span>
                                  <span class="s1">&#39;float).&#39;</span><span class="p">)</span>
        <span class="n">write_bounding_box_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;The bounding box (in mm) of the volume &#39;</span>
                                  <span class="s1">&#39;which is to be written (a list of 2 items, &#39;</span>
                                  <span class="s1">&#39;which are a list of items, which are a &#39;</span>
                                  <span class="s1">&#39;float.&#39;</span><span class="p">)</span>
        <span class="n">write_voxel_sizes_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;The voxel sizes (x, y &amp; z, in mm) of the &#39;</span>
                                  <span class="s1">&#39;written normalised images (a list of 3 &#39;</span>
                                  <span class="s1">&#39;items, which are a float).&#39;</span><span class="p">)</span>
        <span class="n">write_interp_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Degree of b-spline used for interpolation &#39;</span>
                             <span class="s1">&#39;(0 &lt;= a long integer &lt;= 7; 1 is OK for PET, &#39;</span>
                             <span class="s1">&#39;realigned fMRI, or segmentations).&#39;</span><span class="p">)</span>

        <span class="c1"># Outputs description</span>
        <span class="n">deformation_field_desc</span>  <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;File y_*.nii containing 3 deformation &#39;</span>
                                   <span class="s1">&#39;fields for the deformation in x, y and z &#39;</span>
                                   <span class="s1">&#39;dimension (a pathlike object or string &#39;</span>
                                   <span class="s1">&#39;representing a file, or a list of pathlike &#39;</span>
                                   <span class="s1">&#39;objects or strings representing a file)&#39;</span><span class="p">)</span>
        <span class="n">normalized_image_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Normalised file that needed to be aligned (a &#39;</span>
                                 <span class="s1">&#39;pathlike object or string representing a &#39;</span>
                                 <span class="s1">&#39;file, or a list of pathlike objects or &#39;</span>
                                 <span class="s1">&#39;strings representing a file).&#39;</span><span class="p">)</span>
        <span class="n">normalized_files_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Normalised other files (a pathlike object or &#39;</span>
                                 <span class="s1">&#39;string representing a file, or a list of &#39;</span>
                                 <span class="s1">&#39;pathlike objects or strings representing a &#39;</span>
                                 <span class="s1">&#39;file).&#39;</span><span class="p">)</span>

        <span class="c1"># Tpm parameter definition</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">Config</span><span class="p">()</span>
        <span class="n">tpm_path</span> <span class="o">=</span> <span class="n">Undefined</span>

        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">get_resources_path</span><span class="p">():</span>
            <span class="n">tpm_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">get_resources_path</span><span class="p">(),</span> <span class="s1">&#39;spm12&#39;</span><span class="p">,</span>
                                    <span class="s1">&#39;tpm&#39;</span><span class="p">,</span> <span class="s1">&#39;TPM.nii&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">Path</span><span class="p">(</span><span class="n">tpm_path</span><span class="p">)</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Normalize12 brick:</span><span class="se">\n</span><span class="s1">  - The </span><span class="si">{}</span><span class="s1"> file &#39;</span>
                      <span class="s1">&#39;seems to not exists ...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tpm_path</span><span class="p">))</span>
                <span class="n">tpm_path</span> <span class="o">=</span> <span class="n">Undefined</span>

        <span class="c1"># Inputs traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;image_to_align&quot;</span><span class="p">,</span>
                       <span class="n">ImageFileSPM</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                    <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                    <span class="n">desc</span><span class="o">=</span><span class="n">image_to_align_desc</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;deformation_file&quot;</span><span class="p">,</span>
                       <span class="n">ImageFileSPM</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                    <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                    <span class="n">desc</span><span class="o">=</span><span class="n">deformation_file_desc</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;apply_to_files&quot;</span><span class="p">,</span>
                       <span class="n">InputMultiPath</span><span class="p">(</span><span class="n">Either</span><span class="p">(</span><span class="n">ImageFileSPM</span><span class="p">(),</span>
                                             <span class="n">List</span><span class="p">(</span><span class="n">ImageFileSPM</span><span class="p">()),</span>
                                             <span class="n">Undefined</span><span class="p">),</span>
                                      <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                      <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                      <span class="n">desc</span><span class="o">=</span><span class="n">apply_to_files_desc</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;jobtype&quot;</span><span class="p">,</span>
                       <span class="n">Enum</span><span class="p">(</span><span class="s2">&quot;write&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;est&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;estwrite&quot;</span><span class="p">,</span>
                            <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">desc</span><span class="o">=</span><span class="n">jobtype_desc</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;bias_regularization&quot;</span><span class="p">,</span>
                       <span class="n">Enum</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.00001</span><span class="p">,</span> <span class="mf">0.0001</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">,</span>
                            <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span>
                            <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">desc</span><span class="o">=</span><span class="n">bias_regularization_desc</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;bias_fwhm&quot;</span><span class="p">,</span>
                       <span class="n">Enum</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">70</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span>
                            <span class="mi">110</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">130</span><span class="p">,</span> <span class="mi">140</span><span class="p">,</span><span class="mi">150</span><span class="p">,</span> <span class="s2">&quot;Inf&quot;</span><span class="p">,</span>
                            <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">desc</span><span class="o">=</span><span class="n">bias_fwhm_desc</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;tpm&quot;</span><span class="p">,</span>
                       <span class="n">File</span><span class="p">(</span><span class="n">exists</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">value</span><span class="o">=</span><span class="n">tpm_path</span><span class="p">,</span>
                            <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">desc</span><span class="o">=</span><span class="n">tpm_desc</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;affine_regularization_type&quot;</span><span class="p">,</span>
                       <span class="n">Enum</span><span class="p">(</span><span class="s2">&quot;mni&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;size&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;none&quot;</span><span class="p">,</span>
                            <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">desc</span><span class="o">=</span><span class="n">affine_regularization_type_desc</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;warping_regularization&quot;</span><span class="p">,</span>
                       <span class="n">List</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">],</span>
                            <span class="n">trait</span><span class="o">=</span><span class="n">Float</span><span class="p">(),</span>
                            <span class="n">minlen</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                            <span class="n">maxlen</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                            <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">desc</span><span class="o">=</span><span class="n">warping_regularization_desc</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;smoothness&quot;</span><span class="p">,</span>
                       <span class="n">Float</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span>
                             <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                             <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                             <span class="n">desc</span><span class="o">=</span><span class="n">smoothness_desc</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;sampling_distance&quot;</span><span class="p">,</span>
                       <span class="n">Float</span><span class="p">(</span><span class="mf">3.</span><span class="p">,</span>
                             <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                             <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                             <span class="n">desc</span><span class="o">=</span><span class="n">sampling_distance_desc</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;write_bounding_box&quot;</span><span class="p">,</span>
                       <span class="n">List</span><span class="p">(</span><span class="n">List</span><span class="p">(</span><span class="n">Float</span><span class="p">()),</span>
                            <span class="n">value</span><span class="o">=</span><span class="p">[[</span><span class="o">-</span><span class="mi">78</span><span class="p">,</span> <span class="o">-</span><span class="mi">112</span><span class="p">,</span> <span class="o">-</span><span class="mi">50</span><span class="p">],</span> <span class="p">[</span><span class="mi">78</span><span class="p">,</span> <span class="mi">76</span><span class="p">,</span> <span class="mi">85</span><span class="p">]],</span>
                            <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">desc</span><span class="o">=</span><span class="n">write_bounding_box_desc</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;write_voxel_sizes&quot;</span><span class="p">,</span>
                       <span class="n">List</span><span class="p">(</span><span class="n">Float</span><span class="p">(),</span>
                            <span class="n">value</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                            <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">desc</span><span class="o">=</span><span class="n">write_voxel_sizes_desc</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;write_interp&quot;</span><span class="p">,</span>
                       <span class="n">Range</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                             <span class="n">low</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                             <span class="n">high</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span>
                             <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                             <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                             <span class="n">desc</span><span class="o">=</span><span class="n">write_interp_desc</span><span class="p">))</span>

        <span class="c1"># Outputs traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;deformation_field&quot;</span><span class="p">,</span>
                       <span class="n">OutputMultiPath</span><span class="p">(</span><span class="n">File</span><span class="p">(),</span>
                                       <span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                       <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                       <span class="n">desc</span><span class="o">=</span><span class="n">deformation_field_desc</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;normalized_files&quot;</span><span class="p">,</span>
                       <span class="n">OutputMultiPath</span><span class="p">(</span><span class="n">File</span><span class="p">(),</span>
                                       <span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                       <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                       <span class="n">desc</span><span class="o">=</span><span class="n">normalized_files_desc</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">init_default_traits</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_process</span><span class="p">(</span><span class="s1">&#39;nipype.interfaces.spm.Normalize12&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Normalize12.list_outputs"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.spm.html#mia_processes.bricks.preprocess.spm.spatial_preprocessing.Normalize12.list_outputs">[docs]</a>    <span class="k">def</span> <span class="nf">list_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_plugged</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the initialisation step of the brick.</span>

<span class="sd">        The main objective of this method is to produce the outputs of the</span>
<span class="sd">        bricks (self.outputs) and the associated tags (self.inheritance_dic),</span>
<span class="sd">        if defined here. In order not to include an output in the database,</span>
<span class="sd">        this output must be a value of the optional key &#39;notInDb&#39; of the</span>
<span class="sd">        self.outputs dictionary. To work properly this method must return </span>
<span class="sd">        self.make_initResult() object.</span>

<span class="sd">        :param is_plugged: the state, linked or not, of the plugs.</span>
<span class="sd">        :returns: a dictionary with requirement, outputs and inheritance_dict.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Using the inheritance to ProcessMIA class, list_outputs method</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Normalize12</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">list_outputs</span><span class="p">()</span>

        <span class="c1"># Outputs definition</span>
        <span class="n">_flag</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">apply_to_files</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">apply_to_files</span> <span class="o">!=</span> <span class="p">[</span><span class="n">Undefined</span><span class="p">])</span> <span class="ow">and</span>
                         <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">deformation_file</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jobtype</span> <span class="o">==</span> <span class="s1">&#39;write&#39;</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">jobtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobtype</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">apply_to_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_to_files</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">deformation_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">deformation_file</span>
            <span class="n">_flag</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_to_align</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">image_to_align</span> <span class="o">=</span> <span class="n">Undefined</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tpm</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tpm</span> <span class="o">=</span> <span class="n">Undefined</span>

        <span class="k">elif</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">image_to_align</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image_to_align</span> <span class="o">!=</span> <span class="n">Undefined</span><span class="p">)</span> <span class="ow">and</span>
                                        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tpm</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jobtype</span> <span class="o">==</span> <span class="s1">&#39;est&#39;</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">image_to_align</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_to_align</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">tpm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tpm</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">jobtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobtype</span>
            <span class="n">_flag</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_to_files</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">apply_to_files</span> <span class="o">!=</span> <span class="p">[</span><span class="n">Undefined</span><span class="p">]):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">apply_to_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">Undefined</span><span class="p">]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">deformation_file</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">deformation_file</span> <span class="o">=</span> <span class="n">Undefined</span>

        <span class="k">elif</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">image_to_align</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image_to_align</span> <span class="o">!=</span> <span class="n">Undefined</span><span class="p">)</span> <span class="ow">and</span>
                                   <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tpm</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jobtype</span> <span class="o">==</span> <span class="s1">&#39;estwrite&#39;</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">image_to_align</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_to_align</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">tpm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tpm</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">jobtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobtype</span>
            <span class="n">_flag</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">apply_to_files</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">apply_to_files</span> <span class="o">!=</span> <span class="p">[</span><span class="n">Undefined</span><span class="p">]):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">apply_to_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_to_files</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">deformation_file</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">deformation_file</span> <span class="o">=</span> <span class="n">Undefined</span>

        <span class="k">if</span> <span class="n">_flag</span><span class="p">:</span>

            <span class="c1"># The management of self.process.output_directory could be delegated</span>
            <span class="c1"># to the populse_mia.user_interface.pipeline_manager.process_mia</span>
            <span class="c1"># module. We can&#39;t do it at the moment because the</span>
            <span class="c1"># sync_process_output_traits() of the capsul/process/nipype_process</span>
            <span class="c1"># module raises an exception in nipype if the mandatory parameters</span>
            <span class="c1"># are not yet defined!</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">output_directory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No output_directory was found...!</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;deformation_field&#39;</span><span class="p">,</span> <span class="s1">&#39;normalized_files&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">k</span><span class="p">)</span>

        <span class="c1">#Tags inheritance (optional)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">:</span>

            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;normalized_files&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="n">Undefined</span><span class="p">):</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                        <span class="n">val</span> <span class="o">=</span> <span class="p">[</span><span class="n">val</span><span class="p">]</span>

                    <span class="k">for</span> <span class="n">in_val</span><span class="p">,</span> <span class="n">out_val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">apply_to_files</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
                        <span class="c1"># FIXME: In the latest version of mia, indexing of the database with</span>
                        <span class="c1">#        particular tags defined in the processes is done only at</span>
                        <span class="c1">#        the end of the initialisation of the whole pipeline. So we</span>
                        <span class="c1">#        cannot use the value of these tags in other processes of</span>
                        <span class="c1">#        the pipeline at the time of initialisation</span>
                        <span class="c1">#        (see populse_mia #290). Until better we use a quick and</span>
                        <span class="c1">#        dirty hack with the set_dbFieldValue() method !</span>
                        <span class="n">tag_to_add</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;RepetitionTime&#39;</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;field_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;float&quot;</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;The period of time &quot;</span>
                                                     <span class="s2">&quot;in msec between the &quot;</span>
                                                     <span class="s2">&quot;beginning of a pulse &quot;</span>
                                                     <span class="s2">&quot;sequence and the &quot;</span>
                                                     <span class="s2">&quot;beginning of the &quot;</span>
                                                     <span class="s2">&quot;succeeding pulse &quot;</span>
                                                     <span class="s2">&quot;sequence&quot;</span><span class="p">)</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;visibility&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;origin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;user&quot;</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;unit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;ms&quot;</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;default_value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_dbFieldValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span>
                                                               <span class="n">in_val</span><span class="p">,</span>
                                                               <span class="s1">&#39;RepetitionTime&#39;</span><span class="p">)</span>

                        <span class="k">if</span> <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">set_dbFieldValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span>
                                             <span class="n">out_val</span><span class="p">,</span>
                                             <span class="n">tag_to_add</span><span class="p">)</span>

                        <span class="k">else</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Normalize12:</span><span class="se">\n</span><span class="s2">The &#39;RepetitionTime&#39; tag &quot;</span>
                                  <span class="s2">&quot;could not be added to the database for the &quot;</span>
                                  <span class="s2">&quot;&#39;</span><span class="si">{}</span><span class="s2">&#39; parameter. This can lead to a &quot;</span>
                                  <span class="s2">&quot;subsequent issue during &quot;</span>
                                  <span class="s2">&quot;initialization!!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">out_val</span><span class="p">))</span>

                        <span class="n">tag_to_add</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Dataset dimensions &quot;</span>
                                              <span class="s2">&quot;(Count, X,Y,Z,T...)&quot;</span><span class="p">)</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;field_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;int&quot;</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;data array dimensions&quot;</span>
                                                     <span class="s2">&quot; (from Nifti header)&quot;</span><span class="p">)</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;visibility&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;origin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;user&quot;</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;unit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;default_value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_dbFieldValue</span><span class="p">(</span>
                                                        <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span>
                                                        <span class="n">in_val</span><span class="p">,</span>
                                                        <span class="p">(</span><span class="s2">&quot;Dataset dimensions &quot;</span>
                                                         <span class="s2">&quot;(Count, X,Y,Z,T...)&quot;</span><span class="p">))</span>

                        <span class="k">if</span> <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">set_dbFieldValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span>
                                             <span class="n">out_val</span><span class="p">,</span>
                                             <span class="n">tag_to_add</span><span class="p">)</span>

                        <span class="k">else</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Normalize12:</span><span class="se">\n</span><span class="s2">The &#39;Dataset dimensions &quot;</span>
                                  <span class="s2">&quot;(Count, X,Y,Z,T...)&#39; tag could not be added &quot;</span>
                                  <span class="s2">&quot;to the database for the &#39;</span><span class="si">{}</span><span class="s2">&#39; parameter. &quot;</span>
                                  <span class="s2">&quot;This can lead to a subsequent issue during &quot;</span>
                                  <span class="s2">&quot;initialization!!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">out_val</span><span class="p">))</span>

                        <span class="n">tag_to_add</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;PatientName&quot;</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;field_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;string&quot;</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;visibility&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;origin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;user&quot;</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;unit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;default_value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_dbFieldValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span>
                                                               <span class="n">in_val</span><span class="p">,</span>
                                                               <span class="s2">&quot;PatientName&quot;</span><span class="p">)</span>

                        <span class="k">if</span> <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">set_dbFieldValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span>
                                             <span class="n">out_val</span><span class="p">,</span>
                                             <span class="n">tag_to_add</span><span class="p">)</span>

                        <span class="k">else</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Normalize12:</span><span class="se">\n</span><span class="s2">The &#39;PatientName&#39; tag could not &quot;</span>
                                  <span class="s2">&quot;be added to the database for the &#39;</span><span class="si">{}</span><span class="s2">&#39; &quot;</span>
                                  <span class="s2">&quot;parameter. This can lead to a subsequent &quot;</span>
                                  <span class="s2">&quot;issue during &quot;</span>
                                  <span class="s2">&quot;initialization!!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">out_val</span><span class="p">))</span>

                        <span class="n">age</span> <span class="o">=</span> <span class="n">get_dbFieldValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="n">in_val</span><span class="p">,</span> <span class="s1">&#39;Age&#39;</span><span class="p">)</span>

                        <span class="k">if</span> <span class="n">age</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">tag_to_add</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Age&quot;</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;field_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;int&quot;</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;visibility&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;origin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;user&quot;</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;unit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;default_value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">age</span>
                            <span class="n">set_dbFieldValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="n">out_val</span><span class="p">,</span>
                                             <span class="n">tag_to_add</span><span class="p">)</span>

                        <span class="n">pathology</span> <span class="o">=</span> <span class="n">get_dbFieldValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="n">in_val</span><span class="p">,</span>
                                                     <span class="s1">&#39;Pathology&#39;</span><span class="p">)</span>

                        <span class="k">if</span> <span class="n">pathology</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">tag_to_add</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Pathology&quot;</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;field_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;string&quot;</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;visibility&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;origin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;user&quot;</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;unit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;default_value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pathology</span>
                            <span class="n">set_dbFieldValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="n">out_val</span><span class="p">,</span>
                                             <span class="n">tag_to_add</span><span class="p">)</span>

                        <span class="n">pathOval</span><span class="p">,</span> <span class="n">fileOval</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">out_val</span><span class="p">)</span>
                        <span class="n">_</span><span class="p">,</span> <span class="n">fileIval</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">in_val</span><span class="p">)</span>
                        <span class="n">fileOvalNoPref</span> <span class="o">=</span> <span class="n">fileOval</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

                        <span class="k">if</span> <span class="n">fileOvalNoPref</span> <span class="o">==</span> <span class="n">fileIval</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">inheritance_dict</span><span class="p">[</span><span class="n">out_val</span><span class="p">]</span> <span class="o">=</span> <span class="n">in_val</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;deformation_field&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="n">Undefined</span><span class="p">):</span>
                    <span class="n">pathOval</span><span class="p">,</span> <span class="n">fileOval</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                    <span class="n">_</span><span class="p">,</span> <span class="n">fileIval</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image_to_align</span><span class="p">)</span>
                    <span class="n">fileOvalNoPref</span> <span class="o">=</span> <span class="n">fileOval</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>

                    <span class="k">if</span> <span class="n">fileOvalNoPref</span> <span class="o">==</span> <span class="n">fileIval</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">inheritance_dict</span><span class="p">[</span><span class="n">val</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_to_align</span>

        <span class="c1"># Return the requirement, outputs and inheritance_dict</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_initResult</span><span class="p">()</span></div>

<div class="viewcode-block" id="Normalize12.run_process_mia"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.spm.html#mia_processes.bricks.preprocess.spm.spatial_preprocessing.Normalize12.run_process_mia">[docs]</a>    <span class="k">def</span> <span class="nf">run_process_mia</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the process launch step of the brick.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">trait</span><span class="p">(</span><span class="s1">&#39;image_to_align&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">optional</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">image_to_align</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_to_align</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">jobtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobtype</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">trait</span><span class="p">(</span><span class="s1">&#39;deformation_file&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">optional</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">deformation_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">deformation_file</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_to_files</span> <span class="o">==</span> <span class="p">[</span><span class="n">Undefined</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">apply_to_files</span> <span class="o">=</span> <span class="n">Undefined</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">apply_to_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_to_files</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">bias_regularization</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias_regularization</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">bias_fwhm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias_fwhm</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobtype</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;est&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">tpm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tpm</span>

        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span>
                   <span class="n">affine_regularization_type</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">affine_regularization_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">warping_regularization</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">warping_regularization</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">smoothness</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">smoothness</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">sampling_distance</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sampling_distance</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">write_bounding_box</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_bounding_box</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">write_voxel_sizes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_voxel_sizes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">write_interp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_interp</span>

        <span class="c1"># because the sync_process_output_traits() of the capsul/process/nipype_process</span>
        <span class="c1"># module raises an exception in nipype if the mandatory parameters</span>
        <span class="c1"># are not yet defined, the next line can&#39;t be write before!</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Normalize12</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">run_process_mia</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">configuration_dict</span><span class="o">=</span><span class="p">{})</span></div></div>


<div class="viewcode-block" id="Realign"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.spm.html#mia_processes.bricks.preprocess.spm.spatial_preprocessing.Realign">[docs]</a><span class="k">class</span> <span class="nc">Realign</span><span class="p">(</span><span class="n">ProcessMIA</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    *Realigns a time-series of images acquired from the same subject*</span>

<span class="sd">    Please, see the complete documention for the `Realign brick in the populse.mia_processes web site</span>
<span class="sd">    &lt;https://populse.github.io/mia_processes/html/documentation/bricks/preprocess/spm/Realign.html&gt;`_</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Realign.__init__"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.spm.html#mia_processes.bricks.preprocess.spm.spatial_preprocessing.Realign.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the attributes initialisation/instantiation.</span>
<span class="sd">        </span>
<span class="sd">        The input and output plugs are defined here. The special</span>
<span class="sd">        &#39;self.requirement&#39; attribute (optional) is used to define the</span>
<span class="sd">        third-party products necessary for the running of the brick.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Initialisation of the objects needed for the launch of the brick</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Realign</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1"># Third party softwares required for the execution of the brick</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requirement</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;spm&#39;</span><span class="p">,</span> <span class="s1">&#39;nipype&#39;</span><span class="p">]</span>

        <span class="c1"># Inputs description</span>
        <span class="n">in_files_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;The images to realign (a list of pathlike objects or &#39;</span>
                         <span class="s1">&#39;strings representing a file or of list of items &#39;</span>
                         <span class="s1">&#39;which are a pathlike object or strings representing &#39;</span>
                         <span class="s1">&#39;a file or a _Undefined).&#39;</span><span class="p">)</span>
        <span class="n">jobtype_desc</span> <span class="o">=</span> <span class="s1">&#39;One of &quot;estwrite&quot; or &quot;estimate&quot; or &quot;write&quot;.&#39;</span>
        <span class="n">quality_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Quality versus speed trade-off (0.0 &lt;= a floating&#39;</span>
                        <span class="s1">&#39;point number &lt;= 1.0).&#39;</span><span class="p">)</span>
        <span class="n">separation_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Sampling separation (in mm) in the reference image&#39;</span>
                           <span class="s1">&#39;(a floating point number &gt;= 0.0).&#39;</span><span class="p">)</span>
        <span class="n">fwhm_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;The gaussian smoothing kernel width (mm, a floating point&#39;</span>
                     <span class="s1">&#39; number &gt;= 0.0) applied to the images before estimating&#39;</span>
                    <span class="s1">&#39; the realignment parameters.&#39;</span><span class="p">)</span>
        <span class="n">register_to_mean_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Indicate whether realignment is done to the&#39;</span>
                                 <span class="s1">&#39; mean image (True) or to the first image&#39;</span>
                                 <span class="s1">&#39; (False).&#39;</span><span class="p">)</span>
        <span class="n">interp_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Degree of b-spline (1 &lt;= a long integer &lt;= 7) used for&#39;</span>
                       <span class="s1">&#39; interpolation.&#39;</span><span class="p">)</span>
        <span class="n">wrap_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Check if interpolation should wrap in [x,y,z] (a list of&#39;</span>
                     <span class="s1">&#39; 3 items which are integer int or long).&#39;</span><span class="p">)</span>
        <span class="n">weight_img_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;File name of the weighting image, to weight each&#39;</span>
                           <span class="s1">&#39; voxel of the reference image.&#39;</span><span class="p">)</span>
        <span class="n">write_which_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Determines which images to reslice (a list of&#39;</span>
                            <span class="s1">&#39; items which are a value of class &quot;int&quot;).&#39;</span><span class="p">)</span>
        <span class="n">write_interp_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;0 &lt;= a long integer &lt;= 7. The method by which the&#39;</span>
                             <span class="s1">&#39; images are sampled when being written in a&#39;</span>
                             <span class="s1">&#39; different space.&#39;</span><span class="p">)</span>
        <span class="n">write_wrap_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;A list of from 3 to 3 items which are an integer&#39;</span>
                           <span class="s1">&#39; (int or long).&#39;</span><span class="p">)</span>
        <span class="n">write_mask_desc</span> <span class="o">=</span> <span class="s1">&#39;Mask output image (a boolean)&#39;</span>
        <span class="n">out_prefix_desc</span> <span class="o">=</span> <span class="s1">&#39;Realigned output prefix (a string).&#39;</span>

        <span class="c1"># Outputs description</span>
        <span class="n">realigned_files_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;If write_which is [2, 0], [1, 0] or [2, 1] and&#39;</span>
                                <span class="s1">&#39; jobtype is write or estwrite, these will be &#39;</span>
                                <span class="s1">&#39;the resliced files (a pathlike object or &#39;</span>
                                <span class="s1">&#39;string representing a file or a list of &#39;</span>
                                <span class="s1">&#39;items which are a pathlike object or string &#39;</span>
                                <span class="s1">&#39;representing a file or a list of list of &#39;</span>
                                <span class="s1">&#39;items which are a pathlike object or string &#39;</span>
                                <span class="s1">&#39;representing a file).&#39;</span><span class="p">)</span>
        <span class="n">modified_in_files_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;If the jobtype parameter is estimate or &#39;</span>
                                  <span class="s1">&#39;estwrite, these will be copies of the &#39;</span>
                                  <span class="s1">&#39;in_files with a rewritten header (a &#39;</span>
                                  <span class="s1">&#39;pathlike object or string representing a &#39;</span>
                                  <span class="s1">&#39;file or a list of items which are a &#39;</span>
                                  <span class="s1">&#39;pathlike object or string representing a &#39;</span>
                                  <span class="s1">&#39;file or a list of list of items which are a &#39;</span>
                                  <span class="s1">&#39;pathlike object or string representing a &#39;</span>
                                  <span class="s1">&#39;file).&#39;</span><span class="p">)</span>
        <span class="n">mean_image_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;If write_which is [2, 1] or [0, 1] and jobtype is &#39;</span>
                           <span class="s1">&#39;write or estwrite, this will be the mean image &#39;</span>
                           <span class="s1">&#39;file from the realignment (a pathlike object or &#39;</span>
                           <span class="s1">&#39;string representing a file).&#39;</span><span class="p">)</span>
        <span class="n">realignment_parameters_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;If the jobtype parameter is estimate &#39;</span>
                                       <span class="s1">&#39;or estwrite, this will be the &#39;</span>
                                       <span class="s1">&#39;estimated translation and rotation &#39;</span>
                                       <span class="s1">&#39;parameters (a pathlike object or &#39;</span>
                                       <span class="s1">&#39;string representing a file, or a list &#39;</span>
                                       <span class="s1">&#39;of pathlike objects or strings &#39;</span>
                                       <span class="s1">&#39;representing a file).&#39;</span><span class="p">)</span>

        <span class="c1"># Inputs traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s1">&#39;in_files&#39;</span><span class="p">,</span>
                       <span class="n">InputMultiPath</span><span class="p">(</span><span class="n">Either</span><span class="p">(</span><span class="n">ImageFileSPM</span><span class="p">(),</span>
                                             <span class="n">List</span><span class="p">(</span><span class="n">ImageFileSPM</span><span class="p">()),</span>
                                             <span class="n">Undefined</span><span class="p">),</span>
                                      <span class="n">copyfile</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                      <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                      <span class="n">optional</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                      <span class="n">desc</span><span class="o">=</span><span class="n">in_files_desc</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;jobtype&quot;</span><span class="p">,</span>
                       <span class="n">Enum</span><span class="p">(</span><span class="s1">&#39;estwrite&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;estimate&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;write&#39;</span><span class="p">,</span>
                            <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">desc</span><span class="o">=</span><span class="n">jobtype_desc</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;quality&quot;</span><span class="p">,</span>
                       <span class="n">Range</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span>
                             <span class="n">low</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                             <span class="n">high</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                             <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                             <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                             <span class="n">desc</span><span class="o">=</span><span class="n">quality_desc</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;separation&quot;</span><span class="p">,</span>
                       <span class="n">Range</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="mf">4.0</span><span class="p">,</span>
                             <span class="n">low</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                             <span class="n">high</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                             <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                             <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                             <span class="n">desc</span><span class="o">=</span><span class="n">separation_desc</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;fwhm&quot;</span><span class="p">,</span>
                       <span class="n">Range</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span>
                             <span class="n">low</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                             <span class="n">high</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                             <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                             <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                             <span class="n">desc</span><span class="o">=</span><span class="n">fwhm_desc</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;register_to_mean&quot;</span><span class="p">,</span>
                       <span class="n">Bool</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">desc</span><span class="o">=</span><span class="n">register_to_mean_desc</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;interp&quot;</span><span class="p">,</span>
                       <span class="n">Range</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                             <span class="n">low</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                             <span class="n">high</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span>
                             <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                             <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                             <span class="n">desc</span><span class="o">=</span><span class="n">interp_desc</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;wrap&quot;</span><span class="p">,</span>
                       <span class="n">List</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                            <span class="n">trait</span><span class="o">=</span><span class="n">Range</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
                            <span class="n">minlen</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                            <span class="n">maxlen</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                            <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">desc</span><span class="o">=</span><span class="n">wrap_desc</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;weight_img&quot;</span><span class="p">,</span>
                       <span class="n">File</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">Undefined</span><span class="p">,</span>
                            <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">desc</span><span class="o">=</span><span class="n">weight_img_desc</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s1">&#39;write_which&#39;</span><span class="p">,</span>
                       <span class="n">Enum</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                            <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                            <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                            <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                            <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">desc</span><span class="o">=</span><span class="n">write_which_desc</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;write_interp&quot;</span><span class="p">,</span>
                       <span class="n">Range</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
                             <span class="n">low</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                             <span class="n">high</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span>
                             <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                             <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                             <span class="n">desc</span><span class="o">=</span><span class="n">write_interp_desc</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;write_wrap&quot;</span><span class="p">,</span>
                       <span class="n">List</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                            <span class="n">trait</span><span class="o">=</span><span class="n">Range</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
                            <span class="n">minlen</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                            <span class="n">maxlen</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                            <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">desc</span><span class="o">=</span><span class="n">write_wrap_desc</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;write_mask&quot;</span><span class="p">,</span>
                       <span class="n">Bool</span><span class="p">(</span><span class="n">default_value</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">desc</span><span class="o">=</span><span class="n">write_mask_desc</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;out_prefix&quot;</span><span class="p">,</span>
                       <span class="n">String</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span>
                              <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                              <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                              <span class="n">desc</span><span class="o">=</span><span class="n">out_prefix_desc</span><span class="p">))</span>

        <span class="c1"># Output traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;realigned_files&quot;</span><span class="p">,</span>
                       <span class="n">OutputMultiPath</span><span class="p">(</span><span class="n">Either</span><span class="p">(</span><span class="n">List</span><span class="p">(</span><span class="n">File</span><span class="p">()),</span>
                                              <span class="n">File</span><span class="p">()),</span>
                                       <span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                       <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                       <span class="n">desc</span><span class="o">=</span><span class="n">realigned_files_desc</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;modified_in_files&quot;</span><span class="p">,</span>
                       <span class="n">OutputMultiPath</span><span class="p">(</span><span class="n">Either</span><span class="p">(</span><span class="n">List</span><span class="p">(</span><span class="n">File</span><span class="p">()),</span>
                                              <span class="n">File</span><span class="p">()),</span>
                                       <span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                       <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                       <span class="n">desc</span><span class="o">=</span><span class="n">modified_in_files_desc</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;mean_image&quot;</span><span class="p">,</span>
                       <span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">desc</span><span class="o">=</span><span class="n">mean_image_desc</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;realignment_parameters&quot;</span><span class="p">,</span>
                       <span class="n">OutputMultiPath</span><span class="p">(</span><span class="n">File</span><span class="p">(),</span>
                                       <span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                       <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                       <span class="n">desc</span><span class="o">=</span><span class="n">realignment_parameters_desc</span><span class="p">))</span>


        <span class="bp">self</span><span class="o">.</span><span class="n">init_default_traits</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_process</span><span class="p">(</span><span class="s1">&#39;nipype.interfaces.spm.Realign&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Realign.list_outputs"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.spm.html#mia_processes.bricks.preprocess.spm.spatial_preprocessing.Realign.list_outputs">[docs]</a>    <span class="k">def</span> <span class="nf">list_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_plugged</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the initialisation step of the brick.</span>

<span class="sd">        The main objective of this method is to produce the outputs of the</span>
<span class="sd">        bricks (self.outputs) and the associated tags (self.inheritance_dic),</span>
<span class="sd">        if defined here. In order not to include an output in the database,</span>
<span class="sd">        this output must be a value of the optional key &#39;notInDb&#39; of the</span>
<span class="sd">        self.outputs dictionary. To work properly this method must return </span>
<span class="sd">        self.make_initResult() object.</span>

<span class="sd">        :param is_plugged: the state, linked or not, of the plugs.</span>
<span class="sd">        :returns: a dictionary with requirement, outputs and inheritance_dict.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Using the inheritance to ProcessMIA class, list_outputs method</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Realign</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">list_outputs</span><span class="p">()</span>

        <span class="c1"># Outputs definition and tags inheritance (optional)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_files</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_files</span> <span class="o">!=</span> <span class="p">[</span><span class="n">Undefined</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">in_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_files</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_prefix</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">out_prefix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_prefix</span>

            <span class="c1"># The management of self.process.output_directory could be delegated</span>
            <span class="c1"># to the populse_mia.user_interface.pipeline_manager.process_mia</span>
            <span class="c1"># module. We can&#39;t do it at the moment because the</span>
            <span class="c1"># sync_process_output_traits() of the capsul/process/nipype_process</span>
            <span class="c1"># module raises an exception in nipype if the mandatory parameters</span>
            <span class="c1"># are not yet defined!</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">output_directory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No output_directory was found...!</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobtype</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">jobtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobtype</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_which</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">write_which</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_which</span>

            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;realigned_files&#39;</span><span class="p">,</span> <span class="s1">&#39;modified_in_files&#39;</span><span class="p">,</span>
                      <span class="s1">&#39;mean_image&#39;</span><span class="p">,</span> <span class="s1">&#39;realignment_parameters&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">k</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">:</span>

            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;realigned_files&#39;</span><span class="p">:</span>

                    <span class="k">if</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">jobtype</span> <span class="o">==</span> <span class="s1">&#39;estimate&#39;</span><span class="p">)</span> <span class="ow">or</span>
                     <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">write_which</span> <span class="o">==</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="ow">and</span>
                     <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jobtype</span> <span class="o">==</span> <span class="s1">&#39;write&#39;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobtype</span> <span class="o">==</span> <span class="s1">&#39;estwrite&#39;</span><span class="p">))):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;realigned_files&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Undefined</span>

                    <span class="k">else</span><span class="p">:</span>

                        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                            <span class="n">val</span> <span class="o">=</span> <span class="p">[</span><span class="n">val</span><span class="p">]</span>

                        <span class="k">for</span> <span class="n">in_val</span><span class="p">,</span> <span class="n">out_val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_files</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
                            <span class="c1"># FIXME: In the latest version of mia, indexing of the database with</span>
                            <span class="c1">#        particular tags defined in the processes is done only at</span>
                            <span class="c1">#        the end of the initialisation of the whole pipeline. So we</span>
                            <span class="c1">#        cannot use the value of these tags in other processes of</span>
                            <span class="c1">#        the pipeline at the time of initialisation</span>
                            <span class="c1">#        (see populse_mia #290). Until better we use a quick and</span>
                            <span class="c1">#        dirty hack with the set_dbFieldValue() method !</span>
                            <span class="n">tag_to_add</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;RepetitionTime&#39;</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;field_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;float&quot;</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;The period of time &quot;</span>
                                                         <span class="s2">&quot;in msec between the &quot;</span>
                                                         <span class="s2">&quot;beginning of a pulse &quot;</span>
                                                         <span class="s2">&quot;sequence and the &quot;</span>
                                                         <span class="s2">&quot;beginning of the &quot;</span>
                                                         <span class="s2">&quot;succeeding pulse &quot;</span>
                                                         <span class="s2">&quot;sequence&quot;</span><span class="p">)</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;visibility&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;origin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;user&quot;</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;unit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;ms&quot;</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;default_value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_dbFieldValue</span><span class="p">(</span>
                                                               <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span>
                                                               <span class="n">in_val</span><span class="p">,</span>
                                                               <span class="s1">&#39;RepetitionTime&#39;</span><span class="p">)</span>

                            <span class="k">if</span> <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="n">set_dbFieldValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span>
                                                 <span class="n">out_val</span><span class="p">,</span>
                                                 <span class="n">tag_to_add</span><span class="p">)</span>

                            <span class="k">else</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Realign:</span><span class="se">\n</span><span class="s2">The &#39;RepetitionTime&#39; tag &quot;</span>
                                      <span class="s2">&quot;could not be added to the database for &quot;</span>
                                      <span class="s2">&quot;the &#39;</span><span class="si">{}</span><span class="s2">&#39; parameter. This can lead to a &quot;</span>
                                      <span class="s2">&quot;subsequent issue during &quot;</span>
                                      <span class="s2">&quot;initialization!!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">out_val</span><span class="p">))</span>

                            <span class="n">tag_to_add</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Dataset dimensions &quot;</span>
                                                  <span class="s2">&quot;(Count, X,Y,Z,T...)&quot;</span><span class="p">)</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;field_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;int&quot;</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;data array dimensions&quot;</span>
                                                         <span class="s2">&quot; (from Nifti header)&quot;</span><span class="p">)</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;visibility&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;origin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;user&quot;</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;unit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;default_value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_dbFieldValue</span><span class="p">(</span>
                                                        <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span>
                                                        <span class="n">in_val</span><span class="p">,</span>
                                                        <span class="p">(</span><span class="s2">&quot;Dataset dimensions &quot;</span>
                                                         <span class="s2">&quot;(Count, X,Y,Z,T...)&quot;</span><span class="p">))</span>

                            <span class="k">if</span> <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="n">set_dbFieldValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span>
                                                 <span class="n">out_val</span><span class="p">,</span>
                                                 <span class="n">tag_to_add</span><span class="p">)</span>

                            <span class="k">else</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Realign:</span><span class="se">\n</span><span class="s2">The &#39;Dataset dimensions &quot;</span>
                                      <span class="s2">&quot;(Count, X,Y,Z,T...)&#39; tag could not be &quot;</span>
                                      <span class="s2">&quot;added to the database for the &#39;</span><span class="si">{}</span><span class="s2">&#39; &quot;</span>
                                      <span class="s2">&quot;parameter. This can lead to a &quot;</span>
                                      <span class="s2">&quot;subsequent issue during &quot;</span>
                                      <span class="s2">&quot;initialization!!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">out_val</span><span class="p">))</span>

                            <span class="n">tag_to_add</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;PatientName&quot;</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;field_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;string&quot;</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;visibility&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;origin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;user&quot;</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;unit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;default_value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_dbFieldValue</span><span class="p">(</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span>
                                <span class="n">in_val</span><span class="p">,</span>
                                <span class="s2">&quot;PatientName&quot;</span><span class="p">)</span>

                            <span class="k">if</span> <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="n">set_dbFieldValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span>
                                                 <span class="n">out_val</span><span class="p">,</span>
                                                 <span class="n">tag_to_add</span><span class="p">)</span>

                            <span class="k">else</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span>
                                    <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Realign:</span><span class="se">\n</span><span class="s2">The &#39;PatientName&#39; tag could not &quot;</span>
                                    <span class="s2">&quot;be added to the database for the &#39;</span><span class="si">{}</span><span class="s2">&#39; &quot;</span>
                                    <span class="s2">&quot;parameter. This can lead to a subsequent &quot;</span>
                                    <span class="s2">&quot;issue during &quot;</span>
                                    <span class="s2">&quot;initialization!!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">out_val</span><span class="p">))</span>

                            <span class="n">age</span> <span class="o">=</span> <span class="n">get_dbFieldValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="n">in_val</span><span class="p">,</span> <span class="s1">&#39;Age&#39;</span><span class="p">)</span>

                            <span class="k">if</span> <span class="n">age</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="n">tag_to_add</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                                <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Age&quot;</span>
                                <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;field_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;int&quot;</span>
                                <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                                <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;visibility&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                                <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;origin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;user&quot;</span>
                                <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;unit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                                <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;default_value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                                <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">age</span>
                                <span class="n">set_dbFieldValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="n">out_val</span><span class="p">,</span>
                                                 <span class="n">tag_to_add</span><span class="p">)</span>

                            <span class="n">pathology</span> <span class="o">=</span> <span class="n">get_dbFieldValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="n">in_val</span><span class="p">,</span>
                                                         <span class="s1">&#39;Pathology&#39;</span><span class="p">)</span>

                            <span class="k">if</span> <span class="n">pathology</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="n">tag_to_add</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                                <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Pathology&quot;</span>
                                <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;field_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;string&quot;</span>
                                <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                                <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;visibility&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                                <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;origin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;user&quot;</span>
                                <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;unit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                                <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;default_value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                                <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pathology</span>
                                <span class="n">set_dbFieldValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="n">out_val</span><span class="p">,</span>
                                                 <span class="n">tag_to_add</span><span class="p">)</span>

                            <span class="n">_</span><span class="p">,</span> <span class="n">fileOval</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">out_val</span><span class="p">)</span>
                            <span class="n">_</span><span class="p">,</span> <span class="n">fileIval</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">in_val</span><span class="p">)</span>

                            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_prefix</span><span class="p">:</span>
                                <span class="n">fileOvalNoPref</span> <span class="o">=</span> <span class="n">fileOval</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">out_prefix</span><span class="p">):]</span>

                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">fileOvalNoPref</span> <span class="o">=</span> <span class="n">fileOval</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">):]</span>

                            <span class="k">if</span> <span class="n">fileOvalNoPref</span> <span class="o">==</span> <span class="n">fileIval</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">inheritance_dict</span><span class="p">[</span><span class="n">out_val</span><span class="p">]</span> <span class="o">=</span> <span class="n">in_val</span>

                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;modified_in_files&#39;</span><span class="p">:</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobtype</span> <span class="o">==</span> <span class="s1">&#39;write&#39;</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;modified_in_files&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Undefined</span>

                    <span class="k">else</span><span class="p">:</span>

                        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                            <span class="n">val</span> <span class="o">=</span> <span class="p">[</span><span class="n">val</span><span class="p">]</span>

                        <span class="k">for</span> <span class="n">in_val</span><span class="p">,</span> <span class="n">out_val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_files</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
                            <span class="n">_</span><span class="p">,</span> <span class="n">fileOval</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">out_val</span><span class="p">)</span>
                            <span class="n">_</span><span class="p">,</span> <span class="n">fileIval</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">in_val</span><span class="p">)</span>
                            <span class="n">fileOvalNoPref</span> <span class="o">=</span> <span class="n">fileOval</span>

                            <span class="k">if</span> <span class="n">fileOvalNoPref</span> <span class="o">==</span> <span class="n">fileIval</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">inheritance_dict</span><span class="p">[</span><span class="n">out_val</span><span class="p">]</span> <span class="o">=</span> <span class="n">in_val</span>

                <span class="c1"># Only the first data in in_files gives mean_image</span>
                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;mean_image&#39;</span><span class="p">:</span>

                    <span class="k">if</span> <span class="p">(</span>
                      <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jobtype</span> <span class="o">==</span> <span class="s1">&#39;estimate&#39;</span><span class="p">)</span> <span class="ow">or</span>
                    <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">write_which</span> <span class="o">==</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_which</span> <span class="o">==</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
                                             <span class="ow">and</span>
                     <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jobtype</span> <span class="o">==</span> <span class="s1">&#39;write&#39;</span> <span class="ow">or</span>  <span class="bp">self</span><span class="o">.</span><span class="n">jobtype</span> <span class="o">==</span> <span class="s1">&#39;estwrite&#39;</span><span class="p">))</span>
                       <span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;mean_image&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Undefined</span>

                    <span class="k">else</span><span class="p">:</span>

                        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                            <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">val</span><span class="p">]</span>

                        <span class="k">for</span> <span class="n">in_val</span><span class="p">,</span> <span class="n">out_val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_files</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
                            <span class="n">_</span><span class="p">,</span> <span class="n">fileOval</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">out_val</span><span class="p">)</span>
                            <span class="n">_</span><span class="p">,</span> <span class="n">fileIval</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">in_val</span><span class="p">)</span>
                            <span class="n">fileOvalNoPref</span> <span class="o">=</span> <span class="n">fileOval</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="s1">&#39;mean&#39;</span><span class="p">):]</span>

                            <span class="k">if</span> <span class="n">fileOvalNoPref</span> <span class="o">==</span> <span class="n">fileIval</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">inheritance_dict</span><span class="p">[</span><span class="n">out_val</span><span class="p">]</span> <span class="o">=</span> <span class="n">in_val</span>

                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;realignment_parameters&#39;</span><span class="p">:</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobtype</span> <span class="o">==</span> <span class="s1">&#39;write&#39;</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;realignment_parameters&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Undefined</span>

                    <span class="k">else</span><span class="p">:</span>

                        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                            <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">val</span><span class="p">]</span>

                        <span class="k">for</span> <span class="n">in_val</span><span class="p">,</span> <span class="n">out_val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_files</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
                            <span class="n">_</span><span class="p">,</span> <span class="n">fileOval</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">out_val</span><span class="p">)</span>
                            <span class="n">_</span><span class="p">,</span> <span class="n">fileIval</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">in_val</span><span class="p">)</span>
                            <span class="n">fileOvalNoPref</span> <span class="o">=</span> <span class="n">fileOval</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="s1">&#39;rp_&#39;</span><span class="p">):]</span>

                            <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fileOvalNoPref</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span>
                                            <span class="s1">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fileIval</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])):</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">inheritance_dict</span><span class="p">[</span><span class="n">out_val</span><span class="p">]</span> <span class="o">=</span> <span class="n">in_val</span>

        <span class="c1"># Return the requirement, outputs and inheritance_dict</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_initResult</span><span class="p">()</span></div>

<div class="viewcode-block" id="Realign.run_process_mia"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.spm.html#mia_processes.bricks.preprocess.spm.spatial_preprocessing.Realign.run_process_mia">[docs]</a>    <span class="k">def</span> <span class="nf">run_process_mia</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the process launch step of the brick.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Realign</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">run_process_mia</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">in_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_files</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_prefix</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">out_prefix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_prefix</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">jobtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobtype</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">quality</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">quality</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">separation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">separation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">fwhm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fwhm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">register_to_mean</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">register_to_mean</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">interp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">wrap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wrap</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">weight_img</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight_img</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">write_which</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_which</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">write_interp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_interp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">write_wrap</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_wrap</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">write_mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_mask</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">configuration_dict</span><span class="o">=</span><span class="p">{})</span></div></div>


<div class="viewcode-block" id="SliceTiming"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.spm.html#mia_processes.bricks.preprocess.spm.spatial_preprocessing.SliceTiming">[docs]</a><span class="k">class</span> <span class="nc">SliceTiming</span><span class="p">(</span><span class="n">ProcessMIA</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    *Temporal correction to get back every slice at the same acquisition time*</span>

<span class="sd">    Please, see the complete documentation for the `SliceTiming brick in the populse.mia_processes web site</span>
<span class="sd">    &lt;https://populse.github.io/mia_processes/html/documentation/bricks/preprocess/spm/SliceTiming.html&gt;`</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="SliceTiming.__init__"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.spm.html#mia_processes.bricks.preprocess.spm.spatial_preprocessing.SliceTiming.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the attributes initialisation / instantiation.</span>

<span class="sd">        The input and output plugs are defined here. The special</span>
<span class="sd">        &#39;self.requirement&#39; attribute (optional) is used to define the</span>
<span class="sd">        third-party products necessary for the running of the brick.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Initialisation of the objects needed for the launch of the brick</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SliceTiming</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1"># Third party softwares required for the execution of the brick</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requirement</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;spm&#39;</span><span class="p">,</span> <span class="s1">&#39;nipype&#39;</span><span class="p">]</span>

        <span class="c1"># Inputs description</span>
        <span class="n">desc_in_file</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;The images to be brought back to the reference slice &quot;</span>
                        <span class="s2">&quot;time (a list of pathlike objects or string &quot;</span>
                        <span class="s2">&quot;representing a file or of list of items which are a &quot;</span>
                        <span class="s2">&quot;pathlike object or strings representing a file or a &quot;</span>
                        <span class="s2">&quot;_Undefined or None)&quot;</span><span class="p">)</span>
        <span class="n">desc_acquisition</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Type of image acquisition (one of &quot;sequential &#39;</span>
                            <span class="s1">&#39;ascending&quot;, &quot;sequential descending&quot;, &quot;interleaved &#39;</span>
                            <span class="s1">&#39;(middle-top)&quot;, &quot;interleaved (bottom-up)&quot;, &#39;</span>
                            <span class="s1">&#39;&quot;interleaved (top-down)&quot;). From the acquisition &#39;</span>
                            <span class="s1">&#39;parameter the slice_order parameter can be &#39;</span>
                            <span class="s1">&#39;calculated automatically&#39;</span><span class="p">)</span>
        <span class="n">desc_num_slices</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Number of slices in the in_file (an integer). &quot;</span>
                           <span class="s2">&quot;Can be automatically retrieved from the database&quot;</span><span class="p">)</span>
        <span class="n">desc_TR</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Repetition time in the in_file (a float, in seconds). &quot;</span>
                   <span class="s2">&quot;Can be automatically retrieved from the database&quot;</span><span class="p">)</span>
        <span class="n">desc_TA</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Time of volume acquisition (a float, in seconds). Can be &quot;</span>
                   <span class="s2">&quot;automatically calculated as TR-(TR/num_slices)&quot;</span><span class="p">)</span>
        <span class="n">desc_slice_order</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Order of how were recorded the slices during the &#39;</span>
                            <span class="s1">&#39;volumes aquisition (a list of items which are &#39;</span>
                            <span class="s1">&#39;an integer or a float or a _Undefined or None. &#39;</span>
                            <span class="s1">&#39;Can be automatically calculated according to the &#39;</span>
                            <span class="s1">&#39;acquisition&quot; parameter)&#39;</span><span class="p">)</span>
        <span class="n">desc_ref_slice</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;The chosen reference slice, will serve as the &#39;</span>
                          <span class="s1">&#39;reference for the other slices during the &#39;</span>
                          <span class="s1">&#39;correction (an integer or a float or an _Undefined &#39;</span>
                          <span class="s1">&#39;or None). A default value is calculated according &#39;</span>
                          <span class="s1">&#39;to the &quot;acquisition&quot; parameter&#39;</span><span class="p">)</span>
        <span class="n">desc_out_prefix</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;SliceTiming routine output prefix (a string)&quot;</span><span class="p">)</span>

        <span class="c1"># Outputs description</span>
        <span class="n">desc_timed_files</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;The image after the SliceTiming correction (a &quot;</span>
                            <span class="s2">&quot;pathlike object or string representing a file)&quot;</span><span class="p">)</span>

        <span class="c1"># Input traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;in_files&quot;</span><span class="p">,</span>
                       <span class="n">InputMultiPath</span><span class="p">(</span><span class="n">Either</span><span class="p">(</span><span class="n">ImageFileSPM</span><span class="p">(),</span>
                                             <span class="n">List</span><span class="p">(</span><span class="n">ImageFileSPM</span><span class="p">()),</span>
                                             <span class="n">Undefined</span><span class="p">),</span>
                                      <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                      <span class="n">optional</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                      <span class="n">desc</span><span class="o">=</span><span class="n">desc_in_file</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;acquisition&quot;</span><span class="p">,</span>
                       <span class="n">Enum</span><span class="p">(</span><span class="s2">&quot;sequential ascending&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;sequential descending&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;interleaved (middle-top)&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;interleaved (bottom-up)&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;interleaved (top-down)&quot;</span><span class="p">,</span>
                            <span class="n">value</span><span class="o">=</span><span class="s2">&quot;sequential ascending&quot;</span><span class="p">,</span>
                            <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">desc</span><span class="o">=</span><span class="n">desc_acquisition</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;num_slices&quot;</span><span class="p">,</span>
                       <span class="n">Either</span><span class="p">(</span><span class="n">Int</span><span class="p">(),</span>
                              <span class="n">Undefined</span><span class="p">,</span>
                              <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                              <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                              <span class="n">desc</span><span class="o">=</span><span class="n">desc_num_slices</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_slices</span> <span class="o">=</span> <span class="n">Undefined</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;TR&quot;</span><span class="p">,</span>
                       <span class="n">Either</span><span class="p">(</span><span class="n">Float</span><span class="p">(),</span>
                              <span class="n">Undefined</span><span class="p">,</span>
                              <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                              <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                              <span class="n">desc</span><span class="o">=</span><span class="n">desc_TR</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">TR</span> <span class="o">=</span> <span class="n">Undefined</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;TA&quot;</span><span class="p">,</span>
                       <span class="n">Either</span><span class="p">(</span><span class="n">Float</span><span class="p">(),</span>
                              <span class="n">Undefined</span><span class="p">,</span>
                              <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                              <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                              <span class="n">desc</span><span class="o">=</span><span class="n">desc_TA</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">TA</span> <span class="o">=</span> <span class="n">Undefined</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;slice_order&quot;</span><span class="p">,</span>
                       <span class="n">Either</span><span class="p">(</span><span class="n">List</span><span class="p">(</span><span class="n">Either</span><span class="p">(</span><span class="n">Int</span><span class="p">(),</span>
                                          <span class="n">Float</span><span class="p">())),</span>
                              <span class="n">Undefined</span><span class="p">,</span>
                              <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                              <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                              <span class="n">desc</span><span class="o">=</span><span class="n">desc_slice_order</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">slice_order</span> <span class="o">=</span> <span class="n">Undefined</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;ref_slice&quot;</span><span class="p">,</span>
                       <span class="n">Either</span><span class="p">(</span><span class="n">Int</span><span class="p">(),</span>
                              <span class="n">Float</span><span class="p">(),</span>
                              <span class="n">Undefined</span><span class="p">,</span>
                              <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                              <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                              <span class="n">desc</span><span class="o">=</span><span class="n">desc_ref_slice</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ref_slice</span> <span class="o">=</span> <span class="n">Undefined</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;out_prefix&quot;</span><span class="p">,</span>
                       <span class="n">String</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span>
                              <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                              <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                              <span class="n">desc</span><span class="o">=</span><span class="n">desc_out_prefix</span><span class="p">))</span>

        <span class="c1"># Output traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;timed_files&quot;</span><span class="p">,</span>
                       <span class="n">OutputMultiPath</span><span class="p">(</span><span class="n">File</span><span class="p">(),</span>
                                       <span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                       <span class="n">desc</span><span class="o">=</span><span class="n">desc_timed_files</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">init_default_traits</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_process</span><span class="p">(</span><span class="s1">&#39;nipype.interfaces.spm.SliceTiming&#39;</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_get_database_value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;sets default values for certain parameters.</span>

<span class="sd">        If the following parameters are undefined, this method attempts to give</span>
<span class="sd">        them a value from the database or by making a calculation from other</span>
<span class="sd">        known parameters:</span>
<span class="sd">        - num_slices (from database)</span>
<span class="sd">        - TR (from database)</span>
<span class="sd">        - TA (from TR-(TR/num_slices))</span>
<span class="sd">        - slice_order (from the &quot;acquisition&quot; parameter value)</span>
<span class="sd">        - ref_slice (from the &quot;acquisition&quot; parameter value)</span>

<span class="sd">        :returns: True if no problem is detected, otherwise False</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># FIXME: If several data are entered in in_files parameter, we use the</span>
        <span class="c1"># first element to determine, from the database, few calculation</span>
        <span class="c1"># parameters. These calculation parameters must be identical for all</span>
        <span class="c1"># data in in_files. Currently there is no verification to see if it&#39;s</span>
        <span class="c1"># true (e.g. do all data have the same slice number?, etc.).</span>
        <span class="n">result</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">complete_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_files</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">file_position</span> <span class="o">=</span> <span class="p">(</span><span class="n">complete_path</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">getName</span><span class="p">())</span>
                            <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">getName</span><span class="p">())</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">database_filename</span> <span class="o">=</span> <span class="n">complete_path</span><span class="p">[</span><span class="n">file_position</span><span class="p">:]</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;Dataset dimensions (Count, X,Y,Z,T...)&#39;</span> <span class="ow">in</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get_fields_names</span><span class="p">(</span><span class="n">COLLECTION_CURRENT</span><span class="p">)):</span>
            <span class="n">temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="n">COLLECTION_CURRENT</span><span class="p">,</span>
                                                  <span class="n">database_filename</span><span class="p">,</span>
                                                  <span class="p">(</span><span class="s1">&#39;Dataset dimensions &#39;</span>
                                                   <span class="s1">&#39;(Count, X,Y,Z,T...)&#39;</span><span class="p">))[</span><span class="mi">3</span><span class="p">]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_slices</span> <span class="o">==</span> <span class="n">Undefined</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">temp</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">num_slices</span> <span class="o">=</span> <span class="n">temp</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="n">QMessageBox</span><span class="p">()</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">setIcon</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Warning</span><span class="p">)</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="s2">&quot;Mia_processes - &quot;</span>
                                   <span class="s2">&quot;SliceTiming Error!&quot;</span><span class="p">)</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="s2">&quot;Warning: the value of the num_slices parameter &quot;</span>
                            <span class="s2">&quot;was not found in the database. &quot;</span>
                            <span class="s2">&quot;Please check the data.&quot;</span><span class="p">)</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">setStandardButtons</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Close</span><span class="p">)</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">buttonClicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">exec</span><span class="p">()</span>
                <span class="n">result</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">temp</span><span class="p">:</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_slices</span> <span class="o">!=</span> <span class="n">temp</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="n">QMessageBox</span><span class="p">()</span>
                    <span class="n">msg</span><span class="o">.</span><span class="n">setIcon</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Warning</span><span class="p">)</span>
                    <span class="n">msg</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="s2">&quot;Mia_processes - &quot;</span>
                                       <span class="s2">&quot;SliceTiming Error!&quot;</span><span class="p">)</span>
                    <span class="n">msg</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="s2">&quot;Warning: The value for the num_slices &quot;</span>
                                <span class="s2">&quot;parameter does not match the value in the &quot;</span>
                                <span class="s2">&quot;database. Please check the data.&quot;</span><span class="p">)</span>
                    <span class="n">msg</span><span class="o">.</span><span class="n">setStandardButtons</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Close</span><span class="p">)</span>
                    <span class="n">msg</span><span class="o">.</span><span class="n">buttonClicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
                    <span class="n">msg</span><span class="o">.</span><span class="n">exec</span><span class="p">()</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">temp</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;RepetitionTime&#39;</span> <span class="ow">in</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get_fields_names</span><span class="p">(</span><span class="n">COLLECTION_CURRENT</span><span class="p">)):</span>
            <span class="n">temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="n">COLLECTION_CURRENT</span><span class="p">,</span>
                                                  <span class="n">database_filename</span><span class="p">,</span>
                                                  <span class="s1">&#39;RepetitionTime&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">1000</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">TR</span> <span class="o">==</span> <span class="n">Undefined</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">temp</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">TR</span> <span class="o">=</span> <span class="n">temp</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="n">QMessageBox</span><span class="p">()</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">setIcon</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Warning</span><span class="p">)</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="s2">&quot;Mia_processes - &quot;</span>
                                   <span class="s2">&quot;SliceTiming Error!&quot;</span><span class="p">)</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="s2">&quot;Warning: the value of the TR parameter &quot;</span>
                            <span class="s2">&quot;was not found in the database. &quot;</span>
                            <span class="s2">&quot;Please check the data.&quot;</span><span class="p">)</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">setStandardButtons</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Close</span><span class="p">)</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">buttonClicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">exec</span><span class="p">()</span>
                <span class="n">result</span> <span class="o">=</span>  <span class="kc">False</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">temp</span><span class="p">:</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">TR</span> <span class="o">!=</span> <span class="n">temp</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="n">QMessageBox</span><span class="p">()</span>
                    <span class="n">msg</span><span class="o">.</span><span class="n">setIcon</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Warning</span><span class="p">)</span>
                    <span class="n">msg</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="s2">&quot;Mia_processes - &quot;</span>
                                       <span class="s2">&quot;SliceTiming Error!&quot;</span><span class="p">)</span>
                    <span class="n">msg</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="s2">&quot;Warning: The value for the TR &quot;</span>
                                <span class="s2">&quot;parameter does not match the value in the &quot;</span>
                                <span class="s2">&quot;database. Please check the data.&quot;</span><span class="p">)</span>
                    <span class="n">msg</span><span class="o">.</span><span class="n">setStandardButtons</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Close</span><span class="p">)</span>
                    <span class="n">msg</span><span class="o">.</span><span class="n">buttonClicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
                    <span class="n">msg</span><span class="o">.</span><span class="n">exec</span><span class="p">()</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># FIXME: in SPM, TA can be egal to 0 (If slice_order and</span>
        <span class="c1"># ref_slice are entered in milliseconds, TA will not be used and</span>
        <span class="c1"># can be set to 0). Here we consider that slice_order and</span>
        <span class="c1"># ref_slice paramters are only indices !</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">TA</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">TR</span> <span class="o">!=</span> <span class="n">Undefined</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_slices</span> <span class="o">!=</span> <span class="n">Undefined</span><span class="p">:</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">TA</span> <span class="o">!=</span> <span class="n">Undefined</span><span class="p">:</span>

                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">TA</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TR</span> <span class="o">-</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TR</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_slices</span><span class="p">):</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="n">QMessageBox</span><span class="p">()</span>
                        <span class="n">msg</span><span class="o">.</span><span class="n">setIcon</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Warning</span><span class="p">)</span>
                        <span class="n">msg</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="s2">&quot;Mia_processes - &quot;</span>
                                           <span class="s2">&quot;SliceTiming Error!&quot;</span><span class="p">)</span>
                        <span class="n">msg</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="s2">&quot;Warning: the value of the TA parameter &quot;</span>
                                    <span class="s2">&quot;doesn&#39;t exactly match the other &quot;</span>
                                    <span class="s2">&quot;parameters. Please check the data.&quot;</span><span class="p">)</span>
                        <span class="n">msg</span><span class="o">.</span><span class="n">setStandardButtons</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Close</span><span class="p">)</span>
                        <span class="n">msg</span><span class="o">.</span><span class="n">buttonClicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
                        <span class="n">msg</span><span class="o">.</span><span class="n">exec</span><span class="p">()</span>
                        <span class="n">result</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">TA</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TR</span> <span class="o">-</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TR</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_slices</span><span class="p">)</span>

            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">TA</span> <span class="o">==</span> <span class="n">Undefined</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="n">QMessageBox</span><span class="p">()</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">setIcon</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Warning</span><span class="p">)</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="s2">&quot;Mia_processes - &quot;</span>
                                   <span class="s2">&quot;SliceTiming Error!&quot;</span><span class="p">)</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="s2">&quot;The value of TR or num_slices parameters was not &quot;</span>
                            <span class="s2">&quot;found in the database, then the TA parameter &quot;</span>
                            <span class="s2">&quot;could not be calculated automatically. Please &quot;</span>
                            <span class="s2">&quot;check the data.&quot;</span><span class="p">)</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">setStandardButtons</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Close</span><span class="p">)</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">buttonClicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">exec</span><span class="p">()</span>
                <span class="n">result</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">slice_order</span> <span class="o">!=</span> <span class="n">Undefined</span><span class="p">:</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slice_order</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_slices</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="n">QMessageBox</span><span class="p">()</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">setIcon</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Warning</span><span class="p">)</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="s2">&quot;Mia_processes - SliceTiming Error!&quot;</span><span class="p">)</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="s2">&quot;Warning: the slice_order parameter doesn&#39;t &quot;</span>
                            <span class="s2">&quot;match the num_slices parameter. Please check the &quot;</span>
                            <span class="s2">&quot;data.&quot;</span><span class="p">)</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">setStandardButtons</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Close</span><span class="p">)</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">buttonClicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">exec</span><span class="p">()</span>
                <span class="n">result</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_slices</span> <span class="o">!=</span> <span class="n">Undefined</span><span class="p">:</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">acquisition</span> <span class="o">==</span> <span class="s2">&quot;sequential ascending&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">slice_order</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_slices</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">acquisition</span> <span class="o">==</span> <span class="s2">&quot;sequential descending&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">slice_order</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_slices</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">acquisition</span> <span class="o">==</span> <span class="s2">&quot;interleaved (middle-top)&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">slice_order</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="k">for</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span> <span class="ow">in</span> <span class="p">(</span><span class="n">itertools</span><span class="o">.</span>
                           <span class="n">zip_longest</span><span class="p">)(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_slices</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span>
                                                   <span class="mi">0</span><span class="p">,</span>
                                                   <span class="o">-</span><span class="mi">1</span><span class="p">)),</span>
                                        <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_slices</span><span class="p">),</span>
                                                   <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_slices</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span>
                                                   <span class="o">-</span><span class="mi">1</span><span class="p">))):</span>

                    <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_slices</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">slice_order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">slice_order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">slice_order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">slice_order</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>

                <span class="k">if</span> <span class="kc">None</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">slice_order</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">slice_order</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">acquisition</span> <span class="o">==</span> <span class="s2">&quot;interleaved (bottom-up)&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">slice_order</span> <span class="o">=</span> <span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_slices</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
                                    <span class="o">+</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_slices</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)))</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">acquisition</span> <span class="o">==</span> <span class="s2">&quot;interleaved (top-down)&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">slice_order</span> <span class="o">=</span> <span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_slices</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">))</span>
                                    <span class="o">+</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_slices</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">)))</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">TA</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">TR</span> <span class="o">!=</span> <span class="n">Undefined</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">slice_order</span> <span class="o">=</span> <span class="p">[(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TR</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">num_slices</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span>
                                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">slice_order</span><span class="p">]</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">QMessageBox</span><span class="p">()</span>
            <span class="n">msg</span><span class="o">.</span><span class="n">setIcon</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Warning</span><span class="p">)</span>
            <span class="n">msg</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="s2">&quot;Mia_processes - SliceTiming Error!&quot;</span><span class="p">)</span>
            <span class="n">msg</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="s2">&quot;Warning: As the num_slices parameter was not found in &quot;</span>
                        <span class="s2">&quot;the database, it was not possible to determine the &quot;</span>
                        <span class="s2">&quot;slice_order parameter automatically. Please check the &quot;</span>
                        <span class="s2">&quot;data.&quot;</span><span class="p">)</span>
            <span class="n">msg</span><span class="o">.</span><span class="n">setStandardButtons</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Close</span><span class="p">)</span>
            <span class="n">msg</span><span class="o">.</span><span class="n">buttonClicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
            <span class="n">msg</span><span class="o">.</span><span class="n">exec</span><span class="p">()</span>
            <span class="n">result</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_slice</span> <span class="o">==</span> <span class="n">Undefined</span><span class="p">:</span>

            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">acquisition</span> <span class="o">==</span> <span class="s2">&quot;sequential ascending&quot;</span> <span class="ow">or</span>
                                   <span class="bp">self</span><span class="o">.</span><span class="n">acquisition</span> <span class="o">==</span> <span class="s2">&quot;sequential descending&quot;</span><span class="p">):</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_slices</span> <span class="o">!=</span> <span class="n">Undefined</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ref_slice</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_slices</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="n">QMessageBox</span><span class="p">()</span>
                    <span class="n">msg</span><span class="o">.</span><span class="n">setIcon</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Warning</span><span class="p">)</span>
                    <span class="n">msg</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="s2">&quot;Mia_processes - SliceTiming &quot;</span>
                                       <span class="s2">&quot;Error!&quot;</span><span class="p">)</span>
                    <span class="n">msg</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="s2">&quot;Warning: It was not possible to determine the &quot;</span>
                                <span class="s2">&quot;ref_slice parameter automatically. Please &quot;</span>
                                <span class="s2">&quot;check the data.&quot;</span><span class="p">)</span>
                    <span class="n">msg</span><span class="o">.</span><span class="n">setStandardButtons</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Close</span><span class="p">)</span>
                    <span class="n">msg</span><span class="o">.</span><span class="n">buttonClicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
                    <span class="n">msg</span><span class="o">.</span><span class="n">exec</span><span class="p">()</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ref_slice</span> <span class="o">=</span> <span class="mi">1</span>

            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TA</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">TR</span> <span class="o">!=</span> <span class="n">Undefined</span> <span class="ow">and</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">num_slices</span> <span class="o">!=</span> <span class="n">Undefined</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ref_slice</span> <span class="o">=</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">ref_slice</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span>
                                                 <span class="bp">self</span><span class="o">.</span><span class="n">TR</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">num_slices</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span>

<div class="viewcode-block" id="SliceTiming.list_outputs"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.spm.html#mia_processes.bricks.preprocess.spm.spatial_preprocessing.SliceTiming.list_outputs">[docs]</a>    <span class="k">def</span> <span class="nf">list_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_plugged</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the initialisation step of the brick.</span>

<span class="sd">        The main objective of this method is to produce the outputs of the</span>
<span class="sd">        bricks (self.outputs) and the associated tags (self.inheritance_dic),</span>
<span class="sd">        if defined here. In order not to include an output in the database,</span>
<span class="sd">        this output must be a value of the optional key &#39;notInDb&#39; of the</span>
<span class="sd">        self.outputs dictionary. To work properly this method must return</span>
<span class="sd">        self.make_initResult() object.</span>

<span class="sd">        :param is_plugged: the state, linked or not, of the plugs.</span>
<span class="sd">        :returns: a dictionary with requirement, outputs and inheritance_dict.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Using the inheritance to ProcessMIA class, list_outputs method</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SliceTiming</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">list_outputs</span><span class="p">()</span>

        <span class="c1"># Outputs definition and tags inheritance (optional)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_files</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_files</span> <span class="o">!=</span> <span class="p">[</span><span class="n">Undefined</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">in_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_files</span>
            <span class="c1"># Definition of the necessary inputs for the spm fonction</span>
            <span class="c1"># acquired from the databse</span>
            <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_database_value</span><span class="p">()</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">res</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_initResult</span><span class="p">()</span>

            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_slices</span> <span class="o">!=</span> <span class="n">Undefined</span> <span class="ow">and</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">TR</span> <span class="o">!=</span> <span class="n">Undefined</span> <span class="ow">and</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">TA</span> <span class="o">!=</span> <span class="n">Undefined</span> <span class="ow">and</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">slice_order</span> <span class="o">!=</span> <span class="n">Undefined</span> <span class="ow">and</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">ref_slice</span> <span class="o">!=</span> <span class="n">Undefined</span><span class="p">):</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_prefix</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">out_prefix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_prefix</span>

                <span class="c1"># The management of self.process.output_directory could be delegated</span>
                <span class="c1"># to the populse_mia.user_interface.pipeline_manager.process_mia</span>
                <span class="c1"># module. We can&#39;t do it at the moment because the</span>
                <span class="c1"># sync_process_output_traits() of the capsul/process/nipype_process</span>
                <span class="c1"># module raises an exception in nipype if the mandatory parameters</span>
                <span class="c1"># are not yet defined!</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">output_directory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No output_directory was found...!</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;timed_files&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">_timecorrected_files</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">:</span>

            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;timed_files&quot;</span><span class="p">:</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                        <span class="n">val</span> <span class="o">=</span> <span class="p">[</span><span class="n">val</span><span class="p">]</span>

                    <span class="k">for</span> <span class="n">in_val</span><span class="p">,</span> <span class="n">out_val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_files</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
                        <span class="n">_</span><span class="p">,</span> <span class="n">fileOval</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">out_val</span><span class="p">)</span>
                        <span class="n">_</span><span class="p">,</span> <span class="n">fileIval</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">in_val</span><span class="p">)</span>

                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_prefix</span><span class="p">:</span>
                            <span class="n">fileOvalNoPref</span> <span class="o">=</span> <span class="n">fileOval</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">out_prefix</span><span class="p">):]</span>

                        <span class="k">else</span><span class="p">:</span>
                           <span class="n">fileOvalNoPref</span> <span class="o">=</span> <span class="n">fileOval</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="s1">&#39;s&#39;</span><span class="p">):]</span>

                        <span class="k">if</span> <span class="n">fileOvalNoPref</span> <span class="o">==</span> <span class="n">fileIval</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">inheritance_dict</span><span class="p">[</span><span class="n">out_val</span><span class="p">]</span> <span class="o">=</span> <span class="n">in_val</span>

        <span class="c1"># Return the requirement, outputs and inheritance_dict</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_initResult</span><span class="p">()</span></div>

<div class="viewcode-block" id="SliceTiming.run_process_mia"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.spm.html#mia_processes.bricks.preprocess.spm.spatial_preprocessing.SliceTiming.run_process_mia">[docs]</a>    <span class="k">def</span> <span class="nf">run_process_mia</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the process launch step of the brick.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SliceTiming</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">run_process_mia</span><span class="p">()</span>

        <span class="c1"># in_files parameter are normally already in absolute path format.</span>
        <span class="c1"># So, the 3 next lines can be see as &quot;in case of&quot;...</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">element</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_files</span><span class="p">):</span>
            <span class="n">full_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">in_files</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">full_path</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">in_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_files</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">num_slices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_slices</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">time_repetition</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TR</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">time_acquisition</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">TA</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">slice_order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slice_order</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">ref_slice</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_slice</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_prefix</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">out_prefix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_prefix</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">configuration_dict</span><span class="o">=</span><span class="p">{})</span></div></div>


<div class="viewcode-block" id="Smooth"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.spm.html#mia_processes.bricks.preprocess.spm.spatial_preprocessing.Smooth">[docs]</a><span class="k">class</span> <span class="nc">Smooth</span><span class="p">(</span><span class="n">ProcessMIA</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    *3D Gaussian smoothing of image volumes*</span>

<span class="sd">    Please, see the complete documention for the `Smooth brick in the populse.mia_processes web site</span>
<span class="sd">    &lt;https://populse.github.io/mia_processes/html/documentation/bricks/preprocess/spm/Smooth.html&gt;`_</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Smooth.__init__"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.spm.html#mia_processes.bricks.preprocess.spm.spatial_preprocessing.Smooth.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the attributes initialisation/instantiation.</span>
<span class="sd">        </span>
<span class="sd">        The input and output plugs are defined here. The special</span>
<span class="sd">        &#39;self.requirement&#39; attribute (optional) is used to define the</span>
<span class="sd">        third-party products necessary for the running of the brick.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Initialisation of the objects needed for the launch of the brick</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Smooth</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1"># Third party softwares required for the execution of the brick</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requirement</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;spm&#39;</span><span class="p">,</span> <span class="s1">&#39;nipype&#39;</span><span class="p">]</span>

        <span class="c1"># Inputs description</span>
        <span class="n">in_files_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;List of files to smooth. A list of items which are &#39;</span>
                         <span class="s1">&#39;an existing, uncompressed file &#39;</span>
                         <span class="s1">&#39;(valid extensions: [.img, .nii, .hdr]).&#39;</span><span class="p">)</span>
        <span class="n">fwhm_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Full-width at half maximum (FWHM) of the Gaussian &#39;</span>
                     <span class="s1">&#39;smoothing kernel in mm (a float or a list of 3 items &#39;</span>
                     <span class="s1">&#39;which are a float).&#39;</span><span class="p">)</span>
        <span class="n">data_type_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Data type of the output images &#39;</span>
                          <span class="s1">&#39;(an integer [int or long]).&#39;</span><span class="p">)</span>
        <span class="n">implicit_masking_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;A mask implied by a particular voxel value &#39;</span>
                                 <span class="s1">&#39;(a boolean).&#39;</span><span class="p">)</span>
        <span class="n">out_prefix_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Specify the string to be prepended to the &#39;</span>
                           <span class="s1">&#39;filenames of the smoothed image file(s) &#39;</span>
                           <span class="s1">&#39;(a string).&#39;</span><span class="p">)</span>

        <span class="c1"># Outputs description</span>
        <span class="n">smoothed_files_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;The smoothed files (a pathlike object or &#39;</span>
                               <span class="s1">&#39;string representing a file, or a list of &#39;</span>
                               <span class="s1">&#39;pathlike objects or strings representing a &#39;</span>
                               <span class="s1">&#39;file).&#39;</span><span class="p">)</span>

        <span class="c1"># Input traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;in_files&quot;</span><span class="p">,</span>
                       <span class="n">InputMultiPath</span><span class="p">(</span><span class="n">Either</span><span class="p">(</span><span class="n">ImageFileSPM</span><span class="p">(),</span>
                                             <span class="n">Undefined</span><span class="p">),</span>
                                      <span class="n">copyfile</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                      <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                      <span class="n">optional</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                      <span class="n">desc</span><span class="o">=</span><span class="n">in_files_desc</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;fwhm&quot;</span><span class="p">,</span>
                       <span class="n">Either</span><span class="p">(</span><span class="n">Float</span><span class="p">(),</span>
                              <span class="n">List</span><span class="p">(</span><span class="n">Float</span><span class="p">(),</span>
                                   <span class="n">minlen</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">maxlen</span><span class="o">=</span><span class="mi">3</span><span class="p">),</span>
                              <span class="n">default</span><span class="o">=</span><span class="p">[</span><span class="mf">6.0</span><span class="p">,</span><span class="mf">6.0</span><span class="p">,</span><span class="mf">6.0</span><span class="p">],</span>
                              <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                              <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                              <span class="n">desc</span><span class="o">=</span><span class="n">fwhm_desc</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;data_type&quot;</span><span class="p">,</span>
                       <span class="n">Int</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                           <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                           <span class="n">desc</span><span class="o">=</span><span class="n">data_type_desc</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;implicit_masking&quot;</span><span class="p">,</span>
                       <span class="n">Bool</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">desc</span><span class="o">=</span><span class="n">implicit_masking_desc</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;out_prefix&quot;</span><span class="p">,</span>
                       <span class="n">String</span><span class="p">(</span><span class="s1">&#39;s&#39;</span><span class="p">,</span>
                              <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                              <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                              <span class="n">desc</span><span class="o">=</span><span class="n">out_prefix_desc</span><span class="p">))</span>

        <span class="c1"># Output traits </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;smoothed_files&quot;</span><span class="p">,</span>
                       <span class="n">OutputMultiPath</span><span class="p">(</span><span class="n">File</span><span class="p">(),</span>
                                       <span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                       <span class="n">desc</span><span class="o">=</span><span class="n">smoothed_files_desc</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">init_default_traits</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_process</span><span class="p">(</span><span class="s1">&#39;nipype.interfaces.spm.Smooth&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Smooth.list_outputs"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.spm.html#mia_processes.bricks.preprocess.spm.spatial_preprocessing.Smooth.list_outputs">[docs]</a>    <span class="k">def</span> <span class="nf">list_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_plugged</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the initialisation step of the brick.</span>

<span class="sd">        The main objective of this method is to produce the outputs of the</span>
<span class="sd">        bricks (self.outputs) and the associated tags (self.inheritance_dic),</span>
<span class="sd">        if defined here. In order not to include an output in the database,</span>
<span class="sd">        this output must be a value of the optional key &#39;notInDb&#39; of the</span>
<span class="sd">        self.outputs dictionary. To work properly this method must return </span>
<span class="sd">        self.make_initResult() object.</span>

<span class="sd">        :param is_plugged: the state, linked or not, of the plugs.</span>
<span class="sd">        :returns: a dictionary with requirement, outputs and inheritance_dict.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Using the inheritance to ProcessMIA class, list_outputs method</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Smooth</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">list_outputs</span><span class="p">()</span>

        <span class="c1"># Outputs definition and tags inheritance (optional)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_files</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_files</span> <span class="o">!=</span> <span class="p">[</span><span class="n">Undefined</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">in_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_files</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_prefix</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">out_prefix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_prefix</span>

            <span class="c1"># The management of self.process.output_directory could be delegated</span>
            <span class="c1"># to the populse_mia.user_interface.pipeline_manager.process_mia</span>
            <span class="c1"># module. We can&#39;t do it at the moment because the</span>
            <span class="c1"># sync_process_output_traits() of the capsul/process/nipype_process</span>
            <span class="c1"># module raises an exception in nipype if the mandatory parameters</span>
            <span class="c1"># are not yet defined!</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">output_directory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No output_directory was found...!</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;smoothed_files&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">_smoothed_files</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">:</span>

            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;smoothed_files&quot;</span><span class="p">:</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                        <span class="n">val</span> <span class="o">=</span> <span class="p">[</span><span class="n">val</span><span class="p">]</span>

                    <span class="k">for</span> <span class="n">in_val</span><span class="p">,</span> <span class="n">out_val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_files</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
                        <span class="c1"># FIXME: In the latest version of mia, indexing of the database with</span>
                        <span class="c1">#        particular tags defined in the processes is done only at</span>
                        <span class="c1">#        the end of the initialisation of the whole pipeline. So we</span>
                        <span class="c1">#        cannot use the value of these tags in other processes of</span>
                        <span class="c1">#        the pipeline at the time of initialisation</span>
                        <span class="c1">#        (see populse_mia #290). Until better we use a quick and</span>
                        <span class="c1">#        dirty hack with the set_dbFieldValue() method !</span>
                        <span class="n">tag_to_add</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;RepetitionTime&#39;</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;field_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;float&quot;</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;The period of time &quot;</span>
                                                     <span class="s2">&quot;in msec between the &quot;</span>
                                                     <span class="s2">&quot;beginning of a pulse &quot;</span>
                                                     <span class="s2">&quot;sequence and the &quot;</span>
                                                     <span class="s2">&quot;beginning of the &quot;</span>
                                                     <span class="s2">&quot;succeeding pulse &quot;</span>
                                                     <span class="s2">&quot;sequence&quot;</span><span class="p">)</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;visibility&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;origin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;user&quot;</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;unit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;ms&quot;</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;default_value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_dbFieldValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span>
                                                               <span class="n">in_val</span><span class="p">,</span>
                                                               <span class="s1">&#39;RepetitionTime&#39;</span><span class="p">)</span>

                        <span class="k">if</span> <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">set_dbFieldValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span>
                                             <span class="n">out_val</span><span class="p">,</span>
                                             <span class="n">tag_to_add</span><span class="p">)</span>

                        <span class="k">else</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Smooth:</span><span class="se">\n</span><span class="s2">The &#39;RepetitionTime&#39; tag could &quot;</span>
                                  <span class="s2">&quot;not be added to the database for the &#39;</span><span class="si">{}</span><span class="s2">&#39; &quot;</span>
                                  <span class="s2">&quot;parameter. This can lead to a subsequent &quot;</span>
                                  <span class="s2">&quot;issue during &quot;</span>
                                  <span class="s2">&quot;initialization!!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">out_val</span><span class="p">))</span>

                        <span class="n">tag_to_add</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;Dataset dimensions &quot;</span>
                                              <span class="s2">&quot;(Count, X,Y,Z,T...)&quot;</span><span class="p">)</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;field_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;int&quot;</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;data array dimensions&quot;</span>
                                                     <span class="s2">&quot; (from Nifti header)&quot;</span><span class="p">)</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;visibility&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;origin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;user&quot;</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;unit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;default_value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_dbFieldValue</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span>
                            <span class="n">in_val</span><span class="p">,</span>
                            <span class="p">(</span><span class="s2">&quot;Dataset dimensions &quot;</span>
                             <span class="s2">&quot;(Count, X,Y,Z,T...)&quot;</span><span class="p">))</span>

                        <span class="k">if</span> <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">set_dbFieldValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span>
                                             <span class="n">out_val</span><span class="p">,</span>
                                             <span class="n">tag_to_add</span><span class="p">)</span>

                        <span class="k">else</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Smooth:</span><span class="se">\n</span><span class="s2">The &#39;Dataset dimensions (Count, &quot;</span>
                                  <span class="s2">&quot;X,Y,Z,T...)&#39; tag could not be added to the &quot;</span>
                                  <span class="s2">&quot;database for the &#39;</span><span class="si">{}</span><span class="s2">&#39; parameter. This can &quot;</span>
                                  <span class="s2">&quot;lead to a subsequent issue during &quot;</span>
                                  <span class="s2">&quot;initialization!!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">out_val</span><span class="p">))</span>

                        <span class="n">tag_to_add</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;PatientName&quot;</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;field_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;string&quot;</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;visibility&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;origin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;user&quot;</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;unit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;default_value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_dbFieldValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span>
                                                               <span class="n">in_val</span><span class="p">,</span>
                                                               <span class="s2">&quot;PatientName&quot;</span><span class="p">)</span>

                        <span class="k">if</span> <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">set_dbFieldValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span>
                                             <span class="n">out_val</span><span class="p">,</span>
                                             <span class="n">tag_to_add</span><span class="p">)</span>

                        <span class="k">else</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Smooth:</span><span class="se">\n</span><span class="s2">The &#39;PatientName&#39; tag could not &quot;</span>
                                  <span class="s2">&quot;be added to the database for the &#39;</span><span class="si">{}</span><span class="s2">&#39; &quot;</span>
                                  <span class="s2">&quot;parameter. This can lead to a subsequent &quot;</span>
                                  <span class="s2">&quot;issue during &quot;</span>
                                  <span class="s2">&quot;initialization!!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">out_val</span><span class="p">))</span>

                        <span class="n">age</span> <span class="o">=</span> <span class="n">get_dbFieldValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="n">in_val</span><span class="p">,</span> <span class="s1">&#39;Age&#39;</span><span class="p">)</span>

                        <span class="k">if</span> <span class="n">age</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">tag_to_add</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Age&quot;</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;field_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;int&quot;</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;visibility&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;origin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;user&quot;</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;unit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;default_value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">age</span>
                            <span class="n">set_dbFieldValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="n">out_val</span><span class="p">,</span> <span class="n">tag_to_add</span><span class="p">)</span>

                        <span class="n">pathology</span> <span class="o">=</span> <span class="n">get_dbFieldValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="n">in_val</span><span class="p">,</span>
                                                     <span class="s1">&#39;Pathology&#39;</span><span class="p">)</span>

                        <span class="k">if</span> <span class="n">pathology</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">tag_to_add</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Pathology&quot;</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;field_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;string&quot;</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;visibility&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;origin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;user&quot;</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;unit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;default_value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pathology</span>
                            <span class="n">set_dbFieldValue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="n">out_val</span><span class="p">,</span> <span class="n">tag_to_add</span><span class="p">)</span>

                        <span class="n">_</span><span class="p">,</span> <span class="n">fileOval</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">out_val</span><span class="p">)</span>
                        <span class="n">_</span><span class="p">,</span> <span class="n">fileIval</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">in_val</span><span class="p">)</span>

                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_prefix</span><span class="p">:</span>
                            <span class="n">fileOvalNoPref</span> <span class="o">=</span> <span class="n">fileOval</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">out_prefix</span><span class="p">):]</span>

                        <span class="k">else</span><span class="p">:</span>
                           <span class="n">fileOvalNoPref</span> <span class="o">=</span> <span class="n">fileOval</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="s1">&#39;s&#39;</span><span class="p">):]</span>

                        <span class="k">if</span> <span class="n">fileOvalNoPref</span> <span class="o">==</span> <span class="n">fileIval</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">inheritance_dict</span><span class="p">[</span><span class="n">out_val</span><span class="p">]</span> <span class="o">=</span> <span class="n">in_val</span>

        <span class="c1"># Return the requirement, outputs and inheritance_dict</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_initResult</span><span class="p">()</span></div>

<div class="viewcode-block" id="Smooth.run_process_mia"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.spm.html#mia_processes.bricks.preprocess.spm.spatial_preprocessing.Smooth.run_process_mia">[docs]</a>    <span class="k">def</span> <span class="nf">run_process_mia</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the process launch step of the brick.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Smooth</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">run_process_mia</span><span class="p">()</span>

        <span class="c1"># in_files parameter are normally already in absolute path format.</span>
        <span class="c1"># So, the 3 next lines can be see as &quot;in case of&quot;...</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">element</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_files</span><span class="p">):</span>
            <span class="n">full_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">in_files</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">full_path</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">in_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_files</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">fwhm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fwhm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">data_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">implicit_masking</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">implicit_masking</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_prefix</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">out_prefix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_prefix</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">configuration_dict</span><span class="o">=</span><span class="p">{})</span></div></div>
</pre></div>

      </div>
      <div class="bottomnav" role="navigation" aria-label="bottom navigation">

        <p>
        <a class="uplink" href="../../../../../index.html">Contents</a>
        </p>

      </div>

    <div class="footer" role="contentinfo">
        &#169; Copyright 2019, populse.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 3.2.1.
    </div>
  </body>
</html>
