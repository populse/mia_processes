
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>mia_processes.bricks.preprocess.others.processing &#8212; mia_processes 2.2.1-dev+5e8bbf7 documentation</title>
    <link rel="stylesheet" href="../../../../../_static/haiku.css" type="text/css" />
    <link rel="stylesheet" href="../../../../../_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="../../../../../" src="../../../../../_static/documentation_options.js"></script>
    <script src="../../../../../_static/jquery.js"></script>
    <script src="../../../../../_static/underscore.js"></script>
    <script src="../../../../../_static/doctools.js"></script>
    <script src="../../../../../_static/language_data.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../search.html" /> 
  </head><body>
      <div class="header" role="banner"><h1 class="heading"><a href="../../../../../index.html">
          <span>mia_processes 2.2.1-dev+5e8bbf7 documentation</span></a></h1>
        <h2 class="heading"><span>mia_processes.bricks.preprocess.others.processing</span></h2>
      </div>
      <div class="topnav" role="navigation" aria-label="top navigation">
      
        <p>
        <a class="uplink" href="../../../../../index.html">Contents</a>
        </p>

      </div>
      <div class="content" role="main">
        
        
  <h1>Source code for mia_processes.bricks.preprocess.others.processing</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;The other preprocess library of the mia_processes package.</span>

<span class="sd">The purpose of this module is to provide bricks generally necessary for the</span>
<span class="sd">pre-processing steps, which are not found in nipype.</span>

<span class="sd">:Contains:</span>
<span class="sd">    :Class:</span>
<span class="sd">        - ApplyBiasCorrection</span>
<span class="sd">        - ArtifactMask</span>
<span class="sd">        - Binarize</span>
<span class="sd">        - ConformImage</span>
<span class="sd">        - ConvROI</span>
<span class="sd">        - Enhance</span>
<span class="sd">        - EstimateSNR</span>
<span class="sd">        - GradientThreshold</span>
<span class="sd">        - Harmonize</span>
<span class="sd">        - IntensityClip</span>
<span class="sd">        - Mask</span>
<span class="sd">        - NonSteadyStateDetector</span>
<span class="sd">        - Resample1</span>
<span class="sd">        - Resample2</span>
<span class="sd">        - RotationMask</span>
<span class="sd">        - Sanitize</span>
<span class="sd">        - TemplateFromTemplateFlow</span>
<span class="sd">        - Threshold</span>
<span class="sd">        - TSNR</span>

<span class="sd">    :Function:</span>
<span class="sd">        - artifact_mask</span>
<span class="sd">        - is_outlier</span>
<span class="sd">        - threshold</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c1">##########################################################################</span>
<span class="c1"># mia_processes - Copyright (C) IRMaGe/CEA, 2018</span>
<span class="c1"># Distributed under the terms of the CeCILL license, as published by</span>
<span class="c1"># the CEA-CNRS-INRIA. Refer to the LICENSE file or to</span>
<span class="c1"># http://www.cecill.info/licences/Licence_CeCILL_V2.1-en.html</span>
<span class="c1"># for details.</span>
<span class="c1">##########################################################################</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">tempfile</span>

<span class="c1"># nibabel import</span>
<span class="kn">import</span> <span class="nn">nibabel</span> <span class="k">as</span> <span class="nn">nib</span>
<span class="kn">import</span> <span class="nn">nibabel.processing</span> <span class="k">as</span> <span class="nn">nibp</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="c1"># nipype import</span>
<span class="kn">from</span> <span class="nn">nipype.interfaces.base</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">File</span><span class="p">,</span>
    <span class="n">InputMultiPath</span><span class="p">,</span>
    <span class="n">OutputMultiPath</span><span class="p">,</span>
    <span class="n">TraitListObject</span><span class="p">,</span>
    <span class="n">Undefined</span><span class="p">,</span>
    <span class="n">traits</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">nipype.interfaces.spm.base</span> <span class="kn">import</span> <span class="n">ImageFileSPM</span>

<span class="c1"># populse_mia import</span>
<span class="kn">from</span> <span class="nn">populse_mia.user_interface.pipeline_manager.process_mia</span> <span class="kn">import</span> <span class="n">ProcessMIA</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">ndimage</span> <span class="k">as</span> <span class="n">sim</span>
<span class="kn">from</span> <span class="nn">skimage.morphology</span> <span class="kn">import</span> <span class="n">ball</span>
<span class="kn">from</span> <span class="nn">skimage.transform</span> <span class="kn">import</span> <span class="n">resize</span>

<span class="c1"># soma-base imports</span>
<span class="kn">from</span> <span class="nn">soma.qt_gui.qt_backend.Qt</span> <span class="kn">import</span> <span class="n">QMessageBox</span>
<span class="kn">from</span> <span class="nn">statsmodels.robust.scale</span> <span class="kn">import</span> <span class="n">mad</span>

<span class="c1"># import templateflow to get anatomical templates</span>
<span class="kn">from</span> <span class="nn">templateflow.api</span> <span class="kn">import</span> <span class="n">get</span> <span class="k">as</span> <span class="n">get_template</span>

<span class="c1"># mia_processes import</span>
<span class="kn">from</span> <span class="nn">mia_processes.utils</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">checkFileExt</span><span class="p">,</span>
    <span class="n">get_dbFieldValue</span><span class="p">,</span>
    <span class="n">set_dbFieldValue</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># Other import</span>
<span class="c1"># from distutils.dir_util import copy_tree</span>


<span class="c1"># from populse_mia.software_properties import Config</span>


<span class="n">EXT</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;NIFTI_GZ&quot;</span><span class="p">:</span> <span class="s2">&quot;nii.gz&quot;</span><span class="p">,</span> <span class="s2">&quot;NIFTI&quot;</span><span class="p">:</span> <span class="s2">&quot;nii&quot;</span><span class="p">}</span>


<div class="viewcode-block" id="ApplyBiasCorrection"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.others.html#mia_processes.bricks.preprocess.others.processing.ApplyBiasCorrection">[docs]</a><span class="k">class</span> <span class="nc">ApplyBiasCorrection</span><span class="p">(</span><span class="n">ProcessMIA</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    *Apply bias field correction to an input file using the bias image.*</span>

<span class="sd">    Please, see the complete documentation for the &#39;ApplyBiasCorrection&#39; brick</span>
<span class="sd">    in the populse.mia_processes website</span>
<span class="sd">    https://populse.github.io/mia_processes/html/documentation/bricks/preprocess/other/ApplyMask.html</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="ApplyBiasCorrection.__init__"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.others.html#mia_processes.bricks.preprocess.others.processing.ApplyBiasCorrection.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the attributes initialisation / instantiation.</span>

<span class="sd">        The input and output plugs are defined here. The special</span>
<span class="sd">        &#39;self.requirement&#39; attribute (optional) is used to define the</span>
<span class="sd">        third-party products necessary for the running of the brick.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Initialisation of the objects needed for the launch of the brick</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ApplyBiasCorrection</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1"># Third party softwares required for the execution of the brick</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requirement</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Inputs description</span>
        <span class="n">in_file_desc</span> <span class="o">=</span> <span class="s2">&quot;A file&quot;</span>
        <span class="n">bias_image_desc</span> <span class="o">=</span> <span class="s2">&quot;Bias image&quot;</span>

        <span class="c1"># Outputs description</span>
        <span class="n">out_file_desc</span> <span class="o">=</span> <span class="s2">&quot;Out file&quot;</span>

        <span class="c1"># Inputs traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;in_file&quot;</span><span class="p">,</span> <span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">in_file_desc</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;bias_image&quot;</span><span class="p">,</span>
            <span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">bias_image_desc</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># Outputs traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;out_file&quot;</span><span class="p">,</span> <span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">out_file_desc</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">init_default_traits</span><span class="p">()</span></div>

<div class="viewcode-block" id="ApplyBiasCorrection.list_outputs"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.others.html#mia_processes.bricks.preprocess.others.processing.ApplyBiasCorrection.list_outputs">[docs]</a>    <span class="k">def</span> <span class="nf">list_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_plugged</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the initialisation step of the brick.</span>

<span class="sd">        The main objective of this method is to produce the outputs of the</span>
<span class="sd">        bricks (self.outputs) and the associated tags (self.inheritance_dic),</span>
<span class="sd">        if defined here. To work properly this method must return</span>
<span class="sd">        self.make_initResult() object.</span>

<span class="sd">        :param is_plugged: the state, linked or not, of the plugs.</span>
<span class="sd">        :returns: a dictionary with requirement, outputs and inheritance_dict.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Using the inheritance to ProcessMIA class, list_outputs method</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ApplyBiasCorrection</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">list_outputs</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_file</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">:</span>
                <span class="n">valid_ext</span><span class="p">,</span> <span class="n">in_ext</span><span class="p">,</span> <span class="n">fileName</span> <span class="o">=</span> <span class="n">checkFileExt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_file</span><span class="p">,</span> <span class="n">EXT</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_ext</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">ApplyBiasCorrection brick: The input image &quot;</span>
                        <span class="s2">&quot;format is not recognized...!&quot;</span>
                    <span class="p">)</span>
                    <span class="k">return</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;out_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span> <span class="n">fileName</span> <span class="o">+</span> <span class="s2">&quot;_inu.&quot;</span> <span class="o">+</span> <span class="n">in_ext</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s2">&quot;ApplyBiasCorrection brick: No output_directory was &quot;</span>
                    <span class="s2">&quot;found...!</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="k">return</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inheritance_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;out_file&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_file</span>

        <span class="c1"># Return the requirement, outputs and inheritance_dict</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_initResult</span><span class="p">()</span></div>

<div class="viewcode-block" id="ApplyBiasCorrection.run_process_mia"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.others.html#mia_processes.bricks.preprocess.others.processing.ApplyBiasCorrection.run_process_mia">[docs]</a>    <span class="k">def</span> <span class="nf">run_process_mia</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the process launch step of the brick.&quot;&quot;&quot;</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">ApplyBiasCorrection</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">run_process_mia</span><span class="p">()</span>

        <span class="n">in_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_file</span>
        <span class="n">out_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_file</span>
        <span class="n">bias_image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias_image</span>

        <span class="n">img</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">in_file</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span>
            <span class="n">img</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">()</span> <span class="o">*</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">bias_image</span><span class="p">)</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">(),</span>
            <span class="n">a_min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">a_max</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">out_img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span>
            <span class="n">data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">get_data_dtype</span><span class="p">()),</span>
            <span class="n">img</span><span class="o">.</span><span class="n">affine</span><span class="p">,</span>
            <span class="n">img</span><span class="o">.</span><span class="n">header</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">out_img</span><span class="o">.</span><span class="n">to_filename</span><span class="p">(</span><span class="n">out_file</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="ArtifactMask"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.others.html#mia_processes.bricks.preprocess.others.processing.ArtifactMask">[docs]</a><span class="k">class</span> <span class="nc">ArtifactMask</span><span class="p">(</span><span class="n">ProcessMIA</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    * Computes the artifact mask using the method described in [Mortamet2009].*</span>

<span class="sd">    Please, see the complete documentation for the `ArtifactMask&#39; brick</span>
<span class="sd">    in the populse.mia_processes website</span>
<span class="sd">    https://populse.github.io/mia_processes/html/documentation/bricks/preprocess/other/ArtifactMask.html</span>

<span class="sd">    adapted from</span>
<span class="sd">    https://github.com/nipreps/mriqc/blob/e021008da0a2ef1c48e882baf932139a673349f9/mriqc/interfaces/anatomical.py#L301</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="ArtifactMask.__init__"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.others.html#mia_processes.bricks.preprocess.others.processing.ArtifactMask.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the attributes initialisation / instantiation.</span>

<span class="sd">        The input and output plugs are defined here. The special</span>
<span class="sd">        &#39;self.requirement&#39; attribute (optional) is used to define the</span>
<span class="sd">        third-party products necessary for the running of the brick.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Initialisation of the objects needed for the launch of the brick</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ArtifactMask</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1"># Third party softwares required for the execution of the brick</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requirement</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Inputs description</span>
        <span class="n">in_file_desc</span> <span class="o">=</span> <span class="s2">&quot;An existing path file.&quot;</span>
        <span class="n">head_mask_desc</span> <span class="o">=</span> <span class="s2">&quot;An existing path file.&quot;</span>
        <span class="n">rot_mask_desc</span> <span class="o">=</span> <span class="s2">&quot;An existing path file.&quot;</span>
        <span class="n">nasion_post_mask_desc</span> <span class="o">=</span> <span class="s2">&quot;An existing path file.&quot;</span>
        <span class="n">suffix_desc</span> <span class="o">=</span> <span class="s2">&quot;Suffix of the output image (a string).&quot;</span>

        <span class="c1"># Outputs description</span>
        <span class="n">out_hat_mask_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Path of the outputted air mask &quot;</span>
            <span class="s2">&quot;(a pathlike object or string&quot;</span>
            <span class="s2">&quot;representing a file).&quot;</span>
        <span class="p">)</span>
        <span class="n">out_art_mask_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Path of the outputted artifact mask &quot;</span>
            <span class="s2">&quot;(a pathlike object or string&quot;</span>
            <span class="s2">&quot;representing a file).&quot;</span>
        <span class="p">)</span>
        <span class="n">out_air_mask_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Path of the outputted air mask &quot;</span>
            <span class="s2">&quot;(a pathlike object or string&quot;</span>
            <span class="s2">&quot;representing a file).&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Inputs traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;in_file&quot;</span><span class="p">,</span> <span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">in_file_desc</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;head_mask&quot;</span><span class="p">,</span>
            <span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">head_mask_desc</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;nasion_post_mask&quot;</span><span class="p">,</span>
            <span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">nasion_post_mask_desc</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;rot_mask&quot;</span><span class="p">,</span>
            <span class="n">File</span><span class="p">(</span>
                <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">rot_mask_desc</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;suffix&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">String</span><span class="p">(</span>
                <span class="s2">&quot;_mask&quot;</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">suffix_desc</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># Outputs traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;out_hat_mask&quot;</span><span class="p">,</span> <span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">out_hat_mask_desc</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;out_art_mask&quot;</span><span class="p">,</span> <span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">out_art_mask_desc</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;out_air_mask&quot;</span><span class="p">,</span> <span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">out_air_mask_desc</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">init_default_traits</span><span class="p">()</span></div>

<div class="viewcode-block" id="ArtifactMask.list_outputs"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.others.html#mia_processes.bricks.preprocess.others.processing.ArtifactMask.list_outputs">[docs]</a>    <span class="k">def</span> <span class="nf">list_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_plugged</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the initialisation step of the brick.</span>

<span class="sd">        The main objective of this method is to produce the outputs of the</span>
<span class="sd">        bricks (self.outputs) and the associated tags (self.inheritance_dic),</span>
<span class="sd">        if defined here. To work properly this method must return</span>
<span class="sd">        self.make_initResult() object.</span>

<span class="sd">        :param is_plugged: the state, linked or not, of the plugs.</span>
<span class="sd">        :returns: a dictionary with requirement, outputs and inheritance_dict.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Using the inheritance to ProcessMIA class, list_outputs method</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ArtifactMask</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">list_outputs</span><span class="p">()</span>

        <span class="c1"># Outputs definition</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_file</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span><span class="p">)</span>
                <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">isspace</span><span class="p">())</span>
                <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span> <span class="ow">in</span> <span class="p">[</span><span class="n">Undefined</span><span class="p">,</span> <span class="s2">&quot;&lt;undefined&gt;&quot;</span><span class="p">]</span>
            <span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span>

            <span class="n">file_hat</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="n">file_art</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="n">file_air</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

            <span class="n">valid_ext</span><span class="p">,</span> <span class="n">in_ext</span><span class="p">,</span> <span class="n">fileName</span> <span class="o">=</span> <span class="n">checkFileExt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_file</span><span class="p">,</span> <span class="n">EXT</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_ext</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">ArtifactMask brick: The input image format is not &quot;</span>
                    <span class="s2">&quot;recognized...!&quot;</span>
                <span class="p">)</span>
                <span class="k">return</span>

            <span class="n">file_hat</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span>
                <span class="p">(</span><span class="s2">&quot;hat_&quot;</span> <span class="o">+</span> <span class="n">fileName</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">in_ext</span><span class="p">),</span>
            <span class="p">)</span>

            <span class="n">file_art</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span>
                <span class="p">(</span><span class="s2">&quot;art_&quot;</span> <span class="o">+</span> <span class="n">fileName</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">in_ext</span><span class="p">),</span>
            <span class="p">)</span>

            <span class="n">file_air</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span>
                <span class="p">(</span><span class="s2">&quot;air_&quot;</span> <span class="o">+</span> <span class="n">fileName</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">in_ext</span><span class="p">),</span>
            <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;out_hat_mask&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">file_hat</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;out_art_mask&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">file_art</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;out_air_mask&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">file_air</span>

            <span class="c1"># tags inheritance (optional)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">inheritance_dict</span><span class="p">[</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;out_hat_mask&quot;</span><span class="p">]</span>
                <span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_file</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">inheritance_dict</span><span class="p">[</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;out_art_mask&quot;</span><span class="p">]</span>
                <span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_file</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">inheritance_dict</span><span class="p">[</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;out_air_mask&quot;</span><span class="p">]</span>
                <span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_file</span>

        <span class="c1"># Return the requirement, outputs and inheritance_dict</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_initResult</span><span class="p">()</span></div>

<div class="viewcode-block" id="ArtifactMask.run_process_mia"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.others.html#mia_processes.bricks.preprocess.others.processing.ArtifactMask.run_process_mia">[docs]</a>    <span class="k">def</span> <span class="nf">run_process_mia</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the process launch step of the brick.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ArtifactMask</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">run_process_mia</span><span class="p">()</span>

        <span class="n">file_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_file</span>
        <span class="n">head_mask_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">head_mask</span>
        <span class="n">rot_mask_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rot_mask</span>
        <span class="n">nasion_post_mask_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nasion_post_mask</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">imnii</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
            <span class="n">hmnii</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">head_mask_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">rot_mask_name</span><span class="p">:</span>
                <span class="n">rmnii</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">rot_mask_name</span><span class="p">)</span>
            <span class="n">npmnii</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">nasion_post_mask_name</span><span class="p">)</span>

        <span class="k">except</span> <span class="p">(</span>
            <span class="n">nib</span><span class="o">.</span><span class="n">filebasedimages</span><span class="o">.</span><span class="n">ImageFileError</span><span class="p">,</span>
            <span class="ne">FileNotFoundError</span><span class="p">,</span>
            <span class="ne">TypeError</span><span class="p">,</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">ArtifactMask brick: Error with files to mask, during &quot;</span>
                <span class="s2">&quot;initialisation: &quot;</span><span class="p">,</span>
                <span class="n">e</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">imnii</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">hmnii</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">rmnii</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">npmnii</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="p">(</span><span class="n">imnii</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>
            <span class="ow">and</span> <span class="p">(</span><span class="n">hmnii</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>
            <span class="ow">and</span> <span class="p">(</span><span class="n">rmnii</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>
            <span class="ow">and</span> <span class="p">(</span><span class="n">npmnii</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="n">imdata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">imnii</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>

            <span class="c1"># Remove negative values</span>
            <span class="n">imdata</span><span class="p">[</span><span class="n">imdata</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="n">hmdata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asanyarray</span><span class="p">(</span><span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">head_mask_name</span><span class="p">)</span><span class="o">.</span><span class="n">dataobj</span><span class="p">)</span>
            <span class="n">npdata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asanyarray</span><span class="p">(</span><span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">nasion_post_mask_name</span><span class="p">)</span><span class="o">.</span><span class="n">dataobj</span><span class="p">)</span>

            <span class="c1"># Invert head mask</span>
            <span class="n">airdata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">hmdata</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
            <span class="n">airdata</span><span class="p">[</span><span class="n">hmdata</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="c1"># Calculate distance to border</span>
            <span class="n">dist</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">morphology</span><span class="o">.</span><span class="n">distance_transform_edt</span><span class="p">(</span><span class="n">airdata</span><span class="p">)</span>

            <span class="c1"># Apply nasion-to-posterior mask</span>
            <span class="n">airdata</span><span class="p">[</span><span class="n">npdata</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">dist</span><span class="p">[</span><span class="n">npdata</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">dist</span> <span class="o">/=</span> <span class="n">dist</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

            <span class="c1"># Apply rotation mask (if supplied)</span>
            <span class="k">if</span> <span class="n">rot_mask_name</span> <span class="o">!=</span> <span class="n">Undefined</span><span class="p">:</span>
                <span class="n">rotmskdata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asanyarray</span><span class="p">(</span><span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">rot_mask_name</span><span class="p">)</span><span class="o">.</span><span class="n">dataobj</span><span class="p">)</span>
                <span class="n">airdata</span><span class="p">[</span><span class="n">rotmskdata</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="c1"># Run the artifact detection</span>
            <span class="n">qi1_img</span> <span class="o">=</span> <span class="n">artifact_mask</span><span class="p">(</span><span class="n">imdata</span><span class="p">,</span> <span class="n">airdata</span><span class="p">,</span> <span class="n">dist</span><span class="p">)</span>
            <span class="n">hdr</span> <span class="o">=</span> <span class="n">imnii</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">hdr</span><span class="o">.</span><span class="n">set_data_dtype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>

            <span class="c1"># Image save</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
            <span class="n">file_name_no_ext</span><span class="p">,</span> <span class="n">file_extension</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">file_extension</span> <span class="o">==</span> <span class="s2">&quot;.gz&quot;</span><span class="p">:</span>
                <span class="p">(</span><span class="n">file_name_no_ext_2</span><span class="p">,</span> <span class="n">file_extension_2</span><span class="p">)</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span>
                    <span class="n">file_name_no_ext</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">file_extension_2</span> <span class="o">==</span> <span class="s2">&quot;.nii&quot;</span><span class="p">:</span>
                    <span class="n">file_name_no_ext</span> <span class="o">=</span> <span class="n">file_name_no_ext_2</span>
                    <span class="n">file_extension</span> <span class="o">=</span> <span class="s2">&quot;.nii.gz&quot;</span>

            <span class="n">art_file_out</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span>
                <span class="p">(</span>
                    <span class="s2">&quot;art_&quot;</span>
                    <span class="o">+</span> <span class="n">file_name_no_ext</span>
                    <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="o">+</span> <span class="n">file_extension</span>
                <span class="p">),</span>
            <span class="p">)</span>
            <span class="n">nib</span><span class="o">.</span><span class="n">Nifti1Image</span><span class="p">(</span><span class="n">qi1_img</span><span class="p">,</span> <span class="n">imnii</span><span class="o">.</span><span class="n">affine</span><span class="p">,</span> <span class="n">hdr</span><span class="p">)</span><span class="o">.</span><span class="n">to_filename</span><span class="p">(</span>
                <span class="n">art_file_out</span>
            <span class="p">)</span>

            <span class="n">hat_file_out</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span>
                <span class="p">(</span>
                    <span class="s2">&quot;hat_&quot;</span>
                    <span class="o">+</span> <span class="n">file_name_no_ext</span>
                    <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="o">+</span> <span class="n">file_extension</span>
                <span class="p">),</span>
            <span class="p">)</span>
            <span class="n">nib</span><span class="o">.</span><span class="n">Nifti1Image</span><span class="p">(</span><span class="n">airdata</span><span class="p">,</span> <span class="n">imnii</span><span class="o">.</span><span class="n">affine</span><span class="p">,</span> <span class="n">hdr</span><span class="p">)</span><span class="o">.</span><span class="n">to_filename</span><span class="p">(</span>
                <span class="n">hat_file_out</span>
            <span class="p">)</span>

            <span class="n">air_file_out</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span>
                <span class="p">(</span>
                    <span class="s2">&quot;air_&quot;</span>
                    <span class="o">+</span> <span class="n">file_name_no_ext</span>
                    <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="o">+</span> <span class="n">file_extension</span>
                <span class="p">),</span>
            <span class="p">)</span>
            <span class="n">airdata</span><span class="p">[</span><span class="n">qi1_img</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">nib</span><span class="o">.</span><span class="n">Nifti1Image</span><span class="p">(</span><span class="n">airdata</span><span class="p">,</span> <span class="n">imnii</span><span class="o">.</span><span class="n">affine</span><span class="p">,</span> <span class="n">hdr</span><span class="p">)</span><span class="o">.</span><span class="n">to_filename</span><span class="p">(</span>
                <span class="n">air_file_out</span>
            <span class="p">)</span></div></div>


<div class="viewcode-block" id="Binarize"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.others.html#mia_processes.bricks.preprocess.others.processing.Binarize">[docs]</a><span class="k">class</span> <span class="nc">Binarize</span><span class="p">(</span><span class="n">ProcessMIA</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    *Image binarization.*</span>

<span class="sd">    Please, see the complete documentation for the `Binarize` brick</span>
<span class="sd">    in the populse.mia_processes website</span>
<span class="sd">    https://populse.github.io/mia_processes/html/documentation/bricks/preprocess/other/Binarize.html</span>

<span class="sd">    adapted from:</span>
<span class="sd">    https://github.com/nipreps/niworkflows/blob/45ab13e1bf6fdbf5e29c90cef44055b0b9cf391b/niworkflows/interfaces/nibabel.py#L92</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Binarize.__init__"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.others.html#mia_processes.bricks.preprocess.others.processing.Binarize.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the attributes initialisation / instantiation.</span>

<span class="sd">        The input and output plugs are defined here. The special</span>
<span class="sd">        &#39;self.requirement&#39; attribute (optional) is used to define the</span>
<span class="sd">        third-party products necessary for the running of the brick.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Initialisation of the objects needed for the launch of the brick</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Binarize</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1"># Third party softwares required for the execution of the brick</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requirement</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Inputs description</span>
        <span class="n">in_files_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;A list of items with string elements corresponding &quot;</span>
            <span class="s2">&quot;to existing path files.&quot;</span>
        <span class="p">)</span>
        <span class="n">thresh_low_desc</span> <span class="o">=</span> <span class="s2">&quot;Lower threshold for binarization (float).&quot;</span>
        <span class="n">prefix_desc</span> <span class="o">=</span> <span class="s2">&quot;Prefix of the output images (a string).&quot;</span>
        <span class="n">suffix_desc</span> <span class="o">=</span> <span class="s2">&quot;Suffix of the output images (a string).&quot;</span>

        <span class="c1"># Outputs description</span>
        <span class="n">out_files_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Path of the scan after application of the&quot;</span>
            <span class="s2">&quot;binarization (a pathlike object or string&quot;</span>
            <span class="s2">&quot;representing a file, or a list of pathlike&quot;</span>
            <span class="s2">&quot;objects or strings representing a file).&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Inputs traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;in_files&quot;</span><span class="p">,</span>
            <span class="n">InputMultiPath</span><span class="p">(</span>
                <span class="n">traits</span><span class="o">.</span><span class="n">Either</span><span class="p">(</span><span class="n">File</span><span class="p">(),</span> <span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">File</span><span class="p">())),</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">in_files_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;prefix&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">prefix_desc</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;suffix&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">String</span><span class="p">(</span>
                <span class="s2">&quot;_bin&quot;</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">suffix_desc</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;thresh_low&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">Float</span><span class="p">(</span>
                <span class="n">default</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">thresh_low_desc</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># Outputs traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;out_files&quot;</span><span class="p">,</span>
            <span class="n">OutputMultiPath</span><span class="p">(</span><span class="n">File</span><span class="p">(),</span> <span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">out_files_desc</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">init_default_traits</span><span class="p">()</span></div>

<div class="viewcode-block" id="Binarize.list_outputs"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.others.html#mia_processes.bricks.preprocess.others.processing.Binarize.list_outputs">[docs]</a>    <span class="k">def</span> <span class="nf">list_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_plugged</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the initialisation step of the brick.</span>

<span class="sd">        The main objective of this method is to produce the outputs of the</span>
<span class="sd">        bricks (self.outputs) and the associated tags (self.inheritance_dic),</span>
<span class="sd">        if defined here. To work properly this method must return</span>
<span class="sd">        self.make_initResult() object.</span>

<span class="sd">        :param is_plugged: the state, linked or not, of the plugs.</span>
<span class="sd">        :returns: a dictionary with requirement, outputs and inheritance_dict.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Using the inheritance to ProcessMIA class, list_outputs method</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Binarize</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">list_outputs</span><span class="p">()</span>

        <span class="c1"># Outputs definition</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_files</span><span class="p">:</span>
            <span class="n">files_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_files</span>

            <span class="k">if</span> <span class="p">(</span>
                <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span><span class="p">)</span>
                <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">isspace</span><span class="p">())</span>
                <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span> <span class="ow">in</span> <span class="p">[</span><span class="n">Undefined</span><span class="p">,</span> <span class="s2">&quot;&lt;undefined&gt;&quot;</span><span class="p">]</span>
            <span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span>

            <span class="k">if</span> <span class="p">(</span>
                <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="p">)</span>
                <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="o">.</span><span class="n">isspace</span><span class="p">())</span>
                <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span> <span class="ow">in</span> <span class="p">[</span><span class="n">Undefined</span><span class="p">,</span> <span class="s2">&quot;&lt;undefined&gt;&quot;</span><span class="p">])</span>
            <span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span>

            <span class="n">files</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">flag</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># If False, suf/pref check will not be performed later</span>

            <span class="k">for</span> <span class="n">file_name1</span> <span class="ow">in</span> <span class="n">files_name</span><span class="p">:</span>
                <span class="n">valid_ext</span><span class="p">,</span> <span class="n">in_ext</span><span class="p">,</span> <span class="n">fileName</span> <span class="o">=</span> <span class="n">checkFileExt</span><span class="p">(</span><span class="n">file_name1</span><span class="p">,</span> <span class="n">EXT</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_ext</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Binarize brick: The input image format is not &quot;</span>
                        <span class="s2">&quot;recognized...!&quot;</span>
                    <span class="p">)</span>
                    <span class="k">return</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span> <span class="o">==</span> <span class="s2">&quot; &quot;</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span> <span class="o">==</span> <span class="s2">&quot; &quot;</span> <span class="ow">and</span> <span class="n">flag</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="n">QMessageBox</span><span class="p">()</span>
                    <span class="n">msg</span><span class="o">.</span><span class="n">setIcon</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Warning</span><span class="p">)</span>
                    <span class="n">msg</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span>
                        <span class="s2">&quot;mia_processes - &quot;</span> <span class="s2">&quot;Binarize brick Warning!&quot;</span>
                    <span class="p">)</span>
                    <span class="n">msg</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span>
                        <span class="s2">&quot;Suffix and prefix input parameters are not &quot;</span>
                        <span class="s2">&quot;defined or consist only of one or more white &quot;</span>
                        <span class="s2">&quot;spaces.</span><span class="se">\n</span><span class="s2">The </span><span class="si">{0}</span><span class="s2"> input parameter will be &quot;</span>
                        <span class="s2">&quot;overwritten ...</span><span class="se">\n</span><span class="s2"> Yes or &quot;</span>
                        <span class="s2">&quot;Abort?&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file_name1</span><span class="p">)</span>
                    <span class="p">)</span>
                    <span class="n">msg</span><span class="o">.</span><span class="n">setStandardButtons</span><span class="p">(</span>
                        <span class="n">QMessageBox</span><span class="o">.</span><span class="n">Yes</span>
                        <span class="o">|</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">YesToAll</span>
                        <span class="o">|</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">Abort</span>
                    <span class="p">)</span>
                    <span class="n">retval</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">exec_</span><span class="p">()</span>

                    <span class="k">if</span> <span class="n">retval</span> <span class="o">!=</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">Abort</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span>
                            <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Binarize brick warning: the out_files output &quot;</span>
                            <span class="s2">&quot;parameter is the same as the in_files input &quot;</span>
                            <span class="s2">&quot;parameter (suffix and prefix are not defined):&quot;</span>
                            <span class="s2">&quot;</span><span class="se">\n</span><span class="si">{0}</span><span class="s2"> will be overwrited ...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file_name1</span><span class="p">)</span>
                        <span class="p">)</span>

                        <span class="k">if</span> <span class="n">retval</span> <span class="o">==</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">YesToAll</span><span class="p">:</span>
                            <span class="n">flag</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="nb">print</span><span class="p">(</span>
                                <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Binarize brick: YesToAll selected ; end of &quot;</span>
                                <span class="s2">&quot;overwrite checks on input images ...&quot;</span>
                            <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">files_name</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="nb">print</span><span class="p">(</span>
                            <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Binarize brick: Initialization Aborted. Please &quot;</span>
                            <span class="s2">&quot;check your input parameters ...&quot;</span>
                        <span class="p">)</span>
                        <span class="k">return</span>

                <span class="n">files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span>
                        <span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                            <span class="o">+</span> <span class="n">fileName</span>
                            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                            <span class="o">+</span> <span class="s2">&quot;.&quot;</span>
                            <span class="o">+</span> <span class="n">in_ext</span>
                        <span class="p">),</span>
                    <span class="p">)</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="n">files</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;out_files&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">files</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s2">&quot;- Binarize brick: There was no output file deducted &quot;</span>
                    <span class="s2">&quot;during initialization. Please check the &quot;</span>
                    <span class="s2">&quot;input parameters...!&quot;</span>
                <span class="p">)</span>

        <span class="c1"># tags inheritance (optional)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;out_files&quot;</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">in_val</span><span class="p">,</span> <span class="n">out_val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">files_name</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
                        <span class="n">_</span><span class="p">,</span> <span class="n">fileOval</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">out_val</span><span class="p">)</span>
                        <span class="n">fileOval_no_ext</span><span class="p">,</span> <span class="n">file_extension</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span>
                            <span class="n">fileOval</span>
                        <span class="p">)</span>

                        <span class="k">if</span> <span class="n">file_extension</span> <span class="o">==</span> <span class="s2">&quot;.gz&quot;</span><span class="p">:</span>
                            <span class="p">(</span>
                                <span class="n">fileOval_no_ext_2</span><span class="p">,</span>
                                <span class="n">file_extension_2</span><span class="p">,</span>
                            <span class="p">)</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">fileOval_no_ext</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">file_extension_2</span> <span class="o">==</span> <span class="s2">&quot;.nii&quot;</span><span class="p">:</span>
                                <span class="n">fileOval_no_ext</span> <span class="o">=</span> <span class="n">fileOval_no_ext_2</span>

                        <span class="n">_</span><span class="p">,</span> <span class="n">fileIval</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">in_val</span><span class="p">)</span>
                        <span class="n">fileIval_no_ext</span><span class="p">,</span> <span class="n">file_extension</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span>
                            <span class="n">fileIval</span>
                        <span class="p">)</span>

                        <span class="k">if</span> <span class="n">file_extension</span> <span class="o">==</span> <span class="s2">&quot;.gz&quot;</span><span class="p">:</span>
                            <span class="p">(</span>
                                <span class="n">fileIval_no_ext_2</span><span class="p">,</span>
                                <span class="n">file_extension_2</span><span class="p">,</span>
                            <span class="p">)</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">fileIval_no_ext</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">file_extension_2</span> <span class="o">==</span> <span class="s2">&quot;.nii&quot;</span><span class="p">:</span>
                                <span class="n">fileIval_no_ext</span> <span class="o">=</span> <span class="n">fileIval_no_ext_2</span>

                        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span>
                            <span class="n">fileOval_no_ext</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="p">)</span>
                        <span class="p">):</span>
                            <span class="c1"># fmt: off</span>
                            <span class="n">fileOval_no_ext</span> <span class="o">=</span> <span class="n">fileOval_no_ext</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span>
                                                              <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="p">):]</span>
                            <span class="c1"># fmt: on</span>

                        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">suffix</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span>
                            <span class="n">fileOval_no_ext</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">suffix</span><span class="p">)</span>
                        <span class="p">):</span>
                            <span class="n">fileOval_no_ext</span> <span class="o">=</span> <span class="n">fileOval_no_ext</span><span class="p">[</span>
                                <span class="p">:</span> <span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">suffix</span><span class="p">)</span>
                            <span class="p">]</span>

                        <span class="k">if</span> <span class="n">fileOval_no_ext</span> <span class="o">==</span> <span class="n">fileIval_no_ext</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">inheritance_dict</span><span class="p">[</span><span class="n">out_val</span><span class="p">]</span> <span class="o">=</span> <span class="n">in_val</span>

        <span class="c1"># Return the requirement, outputs and inheritance_dict</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_initResult</span><span class="p">()</span></div>

<div class="viewcode-block" id="Binarize.run_process_mia"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.others.html#mia_processes.bricks.preprocess.others.processing.Binarize.run_process_mia">[docs]</a>    <span class="k">def</span> <span class="nf">run_process_mia</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the process launch step of the brick.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Binarize</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">run_process_mia</span><span class="p">()</span>

        <span class="n">files_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_files</span>

        <span class="k">for</span> <span class="n">file_name</span> <span class="ow">in</span> <span class="n">files_name</span><span class="p">:</span>
            <span class="c1"># Image processing</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">img</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>

            <span class="k">except</span> <span class="p">(</span>
                <span class="n">nib</span><span class="o">.</span><span class="n">filebasedimages</span><span class="o">.</span><span class="n">ImageFileError</span><span class="p">,</span>
                <span class="ne">FileNotFoundError</span><span class="p">,</span>
                <span class="ne">TypeError</span><span class="p">,</span>
            <span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Binarize brick: Error with files to binarize, during &quot;</span>
                    <span class="s2">&quot;the run: &quot;</span><span class="p">,</span>
                    <span class="n">e</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">img</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="n">img</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">()</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="n">data</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">thresh_low</span>
                <span class="n">data</span><span class="p">[</span><span class="o">~</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">img</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">set_data_dtype</span><span class="p">(</span><span class="s2">&quot;uint8&quot;</span><span class="p">)</span>
                <span class="n">maskimg</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span>
                    <span class="n">mask</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;uint8&quot;</span><span class="p">),</span> <span class="n">img</span><span class="o">.</span><span class="n">affine</span><span class="p">,</span> <span class="n">img</span><span class="o">.</span><span class="n">header</span>
                <span class="p">)</span>

                <span class="c1"># Image save</span>
                <span class="n">_</span><span class="p">,</span> <span class="n">file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
                <span class="n">file_name_no_ext</span><span class="p">,</span> <span class="n">file_extension</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">file_extension</span> <span class="o">==</span> <span class="s2">&quot;.gz&quot;</span><span class="p">:</span>
                    <span class="p">(</span><span class="n">file_name_no_ext_2</span><span class="p">,</span> <span class="n">file_extension_2</span><span class="p">)</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span>
                        <span class="n">file_name_no_ext</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">file_extension_2</span> <span class="o">==</span> <span class="s2">&quot;.nii&quot;</span><span class="p">:</span>
                        <span class="n">file_name_no_ext</span> <span class="o">=</span> <span class="n">file_name_no_ext_2</span>
                        <span class="n">file_extension</span> <span class="o">=</span> <span class="s2">&quot;.nii.gz&quot;</span>

                <span class="n">file_out</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span>
                    <span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                        <span class="o">+</span> <span class="n">file_name_no_ext</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                        <span class="o">+</span> <span class="n">file_extension</span>
                    <span class="p">),</span>
                <span class="p">)</span>
                <span class="n">nib</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">maskimg</span><span class="p">,</span> <span class="n">file_out</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="ConformImage"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.others.html#mia_processes.bricks.preprocess.others.processing.ConformImage">[docs]</a><span class="k">class</span> <span class="nc">ConformImage</span><span class="p">(</span><span class="n">ProcessMIA</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    * Conform T1w image to standard.</span>

<span class="sd">    Please, see the complete documentation for the `ConformImage&#39; brick</span>
<span class="sd">    in the populse.mia_processes website</span>
<span class="sd">    https://populse.github.io/mia_processes/html/documentation/bricks/preprocess/other/ConformImage.html</span>

<span class="sd">    adapted from:</span>
<span class="sd">    https://github.com/nipreps/mriqc/blob/e021008da0a2ef1c48e882baf932139a673349f9/mriqc/interfaces/common/conform_image.py#L75</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="ConformImage.__init__"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.others.html#mia_processes.bricks.preprocess.others.processing.ConformImage.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the attributes initialisation / instantiation.</span>

<span class="sd">        The input and output plugs are defined here. The special</span>
<span class="sd">        &#39;self.requirement&#39; attribute (optional) is used to define the</span>
<span class="sd">        third-party products necessary for the running of the brick.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Initialisation of the objects needed for the launch of the brick</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ConformImage</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1"># Third party softwares required for the execution of the brick</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requirement</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Inputs description</span>
        <span class="n">in_file_desc</span> <span class="o">=</span> <span class="s2">&quot;An existing path file.&quot;</span>
        <span class="n">prefix_desc</span> <span class="o">=</span> <span class="s2">&quot;Prefix of the output image (a string).&quot;</span>
        <span class="n">suffix_desc</span> <span class="o">=</span> <span class="s2">&quot;Suffix of the output image (a string).&quot;</span>

        <span class="c1"># Outputs description</span>
        <span class="n">out_file_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Path of the conformed scan &quot;</span>
            <span class="s2">&quot;(a pathlike object or string representing a file).&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Inputs traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;in_file&quot;</span><span class="p">,</span> <span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">in_file_desc</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;prefix&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">prefix_desc</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;suffix&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">suffix_desc</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># Outputs traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;out_file&quot;</span><span class="p">,</span> <span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">out_file_desc</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">init_default_traits</span><span class="p">()</span></div>

<div class="viewcode-block" id="ConformImage.list_outputs"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.others.html#mia_processes.bricks.preprocess.others.processing.ConformImage.list_outputs">[docs]</a>    <span class="k">def</span> <span class="nf">list_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_plugged</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the initialisation step of the brick.</span>

<span class="sd">        The main objective of this method is to produce the outputs of the</span>
<span class="sd">        bricks (self.outputs) and the associated tags (self.inheritance_dic),</span>
<span class="sd">        if defined here. To work properly this method must return</span>
<span class="sd">        self.make_initResult() object.</span>

<span class="sd">        :param is_plugged: the state, linked or not, of the plugs.</span>
<span class="sd">        :returns: a dictionary with requirement, outputs and inheritance_dict.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Using the inheritance to ProcessMIA class, list_outputs method</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ConformImage</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">list_outputs</span><span class="p">()</span>

        <span class="c1"># Outputs definition</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_file</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span><span class="p">)</span>
                <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">isspace</span><span class="p">())</span>
                <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span> <span class="ow">in</span> <span class="p">[</span><span class="n">Undefined</span><span class="p">,</span> <span class="s2">&quot;&lt;undefined&gt;&quot;</span><span class="p">]</span>
            <span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span>

            <span class="k">if</span> <span class="p">(</span>
                <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="p">)</span>
                <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="o">.</span><span class="n">isspace</span><span class="p">())</span>
                <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span> <span class="ow">in</span> <span class="p">[</span><span class="n">Undefined</span><span class="p">,</span> <span class="s2">&quot;&lt;undefined&gt;&quot;</span><span class="p">])</span>
            <span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span>

            <span class="n">valid_ext</span><span class="p">,</span> <span class="n">in_ext</span><span class="p">,</span> <span class="n">file_name</span> <span class="o">=</span> <span class="n">checkFileExt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_file</span><span class="p">,</span> <span class="n">EXT</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_ext</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">ConformImage brick: The input image format is not &quot;</span>
                    <span class="s2">&quot;recognized...!&quot;</span>
                <span class="p">)</span>
                <span class="k">return</span>

            <span class="n">path</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_file</span><span class="p">)</span>

            <span class="k">if</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span> <span class="o">==</span> <span class="s2">&quot; &quot;</span>
                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span> <span class="o">==</span> <span class="s2">&quot; &quot;</span>
                <span class="ow">and</span> <span class="n">path</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span>
            <span class="p">):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="n">QMessageBox</span><span class="p">()</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">setIcon</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Warning</span><span class="p">)</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span>
                    <span class="s2">&quot;mia_processes - ConformImage brick Warning!&quot;</span>
                <span class="p">)</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span>
                    <span class="s2">&quot;Suffix and prefix input parameters are not &quot;</span>
                    <span class="s2">&quot;defined or consist only of one or more white &quot;</span>
                    <span class="s2">&quot;spaces.</span><span class="se">\n</span><span class="s2">The </span><span class="si">{0}</span><span class="s2"> input parameter will be &quot;</span>
                    <span class="s2">&quot;overwritten ...</span><span class="se">\n</span><span class="s2"> Yes or &quot;</span>
                    <span class="s2">&quot;Abort?&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">setStandardButtons</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Yes</span> <span class="o">|</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">Abort</span><span class="p">)</span>
                <span class="n">retval</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">exec_</span><span class="p">()</span>

                <span class="k">if</span> <span class="n">retval</span> <span class="o">!=</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">Abort</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">ConformImage brick warning: the out_file output &quot;</span>
                        <span class="s2">&quot;parameter is the same as the in_files input &quot;</span>
                        <span class="s2">&quot;parameter (suffix and prefix are not defined):&quot;</span>
                        <span class="s2">&quot;</span><span class="se">\n</span><span class="si">{0}</span><span class="s2"> will be overwritten ...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Aborted. Please check your input parameters ...&quot;</span><span class="p">)</span>
                    <span class="k">return</span>

            <span class="n">file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span>
                <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="o">+</span> <span class="n">file_name</span>
                    <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="o">+</span> <span class="s2">&quot;.&quot;</span>
                    <span class="o">+</span> <span class="n">in_ext</span>
                <span class="p">),</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">file</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;out_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">file</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s2">&quot;- ConformImage brick: There was no output file deducted &quot;</span>
                    <span class="s2">&quot;during initialization. Please check the input &quot;</span>
                    <span class="s2">&quot;parameters...!&quot;</span>
                <span class="p">)</span>

            <span class="c1"># tags inheritance (optional)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;out_file&quot;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">inheritance_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;out_file&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_file</span>

        <span class="c1"># Return the requirement, outputs and inheritance_dict</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_initResult</span><span class="p">()</span></div>

<div class="viewcode-block" id="ConformImage.run_process_mia"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.others.html#mia_processes.bricks.preprocess.others.processing.ConformImage.run_process_mia">[docs]</a>    <span class="k">def</span> <span class="nf">run_process_mia</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the process launch step of the brick.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ConformImage</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">run_process_mia</span><span class="p">()</span>

        <span class="n">file_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_file</span>

        <span class="c1"># Image processing</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>

        <span class="k">except</span> <span class="p">(</span>
            <span class="n">nib</span><span class="o">.</span><span class="n">filebasedimages</span><span class="o">.</span><span class="n">ImageFileError</span><span class="p">,</span>
            <span class="ne">FileNotFoundError</span><span class="p">,</span>
            <span class="ne">TypeError</span><span class="p">,</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">ConformImage brick: Error with file to conform, during the &quot;</span>
                <span class="s2">&quot;run: &quot;</span><span class="p">,</span>
                <span class="n">e</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">img</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">img</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">out_img</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">squeeze_image</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
            <span class="n">out_img</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">as_closest_canonical</span><span class="p">(</span><span class="n">out_img</span><span class="p">)</span>

            <span class="c1"># Image save</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
            <span class="n">file_name_no_ext</span><span class="p">,</span> <span class="n">file_extension</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">file_extension</span> <span class="o">==</span> <span class="s2">&quot;.gz&quot;</span><span class="p">:</span>
                <span class="p">(</span><span class="n">file_name_no_ext_2</span><span class="p">,</span> <span class="n">file_extension_2</span><span class="p">)</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span>
                    <span class="n">file_name_no_ext</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">file_extension_2</span> <span class="o">==</span> <span class="s2">&quot;.nii&quot;</span><span class="p">:</span>
                    <span class="n">file_name_no_ext</span> <span class="o">=</span> <span class="n">file_name_no_ext_2</span>
                    <span class="n">file_extension</span> <span class="o">=</span> <span class="s2">&quot;.nii.gz&quot;</span>

            <span class="n">file_out</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span>
                <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="o">+</span> <span class="n">file_name_no_ext</span>
                    <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="o">+</span> <span class="n">file_extension</span>
                <span class="p">),</span>
            <span class="p">)</span>
            <span class="n">nib</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">out_img</span><span class="p">,</span> <span class="n">file_out</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="ConvROI"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.others.html#mia_processes.bricks.preprocess.others.processing.ConvROI">[docs]</a><span class="k">class</span> <span class="nc">ConvROI</span><span class="p">(</span><span class="n">ProcessMIA</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    *Image convolution with one image*</span>

<span class="sd">    - Resampling the convolve_with to the size of images_to_convolve.</span>
<span class="sd">    - Then convolve each element of images_to_convolve with resized</span>
<span class="sd">      convolve_with.</span>
<span class="sd">    - The output_directory/PatientName_data/ROI_data/convROI_BOLD directory is</span>
<span class="sd">      created to receive the convolved images. If this directory exists at</span>
<span class="sd">      runtime it is deleted.</span>
<span class="sd">    - To work correctly, the database entry for the convolve_with</span>
<span class="sd">      parameter must have the &quot;PatientName&quot; tag filled in.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="ConvROI.__init__"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.others.html#mia_processes.bricks.preprocess.others.processing.ConvROI.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the attributes initialisation/instantiation.</span>

<span class="sd">        The input and output plugs are defined here. The special</span>
<span class="sd">        &#39;self.requirement&#39; attribute (optional) is used to define the</span>
<span class="sd">        third-party products necessary for the running of the brick.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Initialisation of the objects needed for the launch of the brick</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ConvROI</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1"># Inputs description</span>
        <span class="n">images_to_convolve_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;A list of images to convolve with convolve_with image&quot;</span>
        <span class="p">)</span>
        <span class="n">convolve_with_desc</span> <span class="o">=</span> <span class="s2">&quot;Aa string representing a path to the file&quot;</span>
        <span class="n">prefix_desc</span> <span class="o">=</span> <span class="s2">&quot;The prefix for the out_images (a string)&quot;</span>

        <span class="c1"># Outputs description</span>
        <span class="n">out_images_desc</span> <span class="o">=</span> <span class="s2">&quot;The convoluted images&quot;</span>

        <span class="c1"># Inputs traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;images_to_convolve&quot;</span><span class="p">,</span>
            <span class="n">InputMultiPath</span><span class="p">(</span>
                <span class="n">ImageFileSPM</span><span class="p">(),</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">images_to_convolve_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;convolve_with&quot;</span><span class="p">,</span>
            <span class="n">ImageFileSPM</span><span class="p">(</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">convolve_with_desc</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;prefix&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">String</span><span class="p">(</span>
                <span class="s2">&quot;conv&quot;</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">prefix_desc</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># Outputs traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;out_images&quot;</span><span class="p">,</span>
            <span class="n">OutputMultiPath</span><span class="p">(</span><span class="n">File</span><span class="p">(),</span> <span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">out_images_desc</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># Special parameter used as a messenger for the run_process_mia method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;dict4runtime&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">Dict</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">userlevel</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">init_default_traits</span><span class="p">()</span></div>

<div class="viewcode-block" id="ConvROI.list_outputs"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.others.html#mia_processes.bricks.preprocess.others.processing.ConvROI.list_outputs">[docs]</a>    <span class="k">def</span> <span class="nf">list_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_plugged</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the initialisation step of the brick.</span>

<span class="sd">        The main objective of this method is to produce the outputs of the</span>
<span class="sd">        bricks (self.outputs) and the associated tags (self.inheritance_dic),</span>
<span class="sd">        if defined here. In order not to include an output in the database,</span>
<span class="sd">        this output must be a value of the optional key &#39;notInDb&#39; of the</span>
<span class="sd">        self.outputs dictionary. To work properly this method must return</span>
<span class="sd">        self.make_initResult() object.</span>

<span class="sd">        :param is_plugged: the state, linked or not, of the plugs.</span>
<span class="sd">        :returns: a dictionary with requirement, outputs and inheritance_dict.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Using the inheritance to ProcessMIA class, list_outputs method</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ConvROI</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">list_outputs</span><span class="p">()</span>

        <span class="c1"># Outputs definition and tags inheritance (optional)</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">images_to_convolve</span> <span class="o">!=</span> <span class="n">Undefined</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">convolve_with</span> <span class="o">!=</span> <span class="n">Undefined</span>
        <span class="p">):</span>
            <span class="n">patient_name</span> <span class="o">=</span> <span class="n">get_dbFieldValue</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">convolve_with</span><span class="p">,</span> <span class="s2">&quot;PatientName&quot;</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">patient_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">ConvROI brick:</span><span class="se">\n</span><span class="s1"> The &quot;PatientName&quot; tag is not filled &#39;</span>
                    <span class="s2">&quot;in the database for the </span><span class="si">{}</span><span class="s2"> file ...</span><span class="se">\n</span><span class="s2"> The calculation&quot;</span>
                    <span class="s2">&quot;is aborted...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">convolve_with</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_initResult</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">dict4runtime</span><span class="p">[</span><span class="s2">&quot;patient_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">patient_name</span>
            <span class="n">conv_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span>
                <span class="n">patient_name</span> <span class="o">+</span> <span class="s2">&quot;_data&quot;</span><span class="p">,</span>
                <span class="s2">&quot;ROI_data&quot;</span><span class="p">,</span>
                <span class="s2">&quot;convROI_BOLD&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">list_out</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="o">.</span><span class="n">isspace</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

            <span class="k">for</span> <span class="n">roi_file</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">images_to_convolve</span><span class="p">:</span>
                <span class="n">list_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                        <span class="n">conv_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">roi_file</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;out_images&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">list_out</span>

        <span class="c1"># Return the requirement, outputs and inheritance_dict</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_initResult</span><span class="p">()</span></div>

<div class="viewcode-block" id="ConvROI.run_process_mia"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.others.html#mia_processes.bricks.preprocess.others.processing.ConvROI.run_process_mia">[docs]</a>    <span class="k">def</span> <span class="nf">run_process_mia</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the process launch step of the brick.&quot;&quot;&quot;</span>

        <span class="c1"># No need the next line (we don&#39;t use self.process et SPM)</span>
        <span class="c1"># super(ConvROI, self).run_process_mia()</span>

        <span class="n">pat_name_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dict4runtime</span><span class="p">[</span><span class="s2">&quot;patient_name&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_data&quot;</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">pat_name_dir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">pat_name_dir</span><span class="p">)</span>

        <span class="n">roi_data_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pat_name_dir</span><span class="p">,</span> <span class="s2">&quot;ROI_data&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">roi_data_dir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">roi_data_dir</span><span class="p">)</span>

        <span class="n">conv_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">roi_data_dir</span><span class="p">,</span> <span class="s2">&quot;convROI_BOLD&quot;</span><span class="p">)</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="s2">&quot;None&quot;</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">conv_dir</span><span class="p">):</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mktemp</span><span class="p">(</span><span class="nb">dir</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">roi_data_dir</span><span class="p">))</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">conv_dir</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="s2">&quot;convROI_BOLD&quot;</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">ConvROI brick:</span><span class="se">\n</span><span class="s1">A &quot;</span><span class="si">{}</span><span class="s1">&quot; folder already exists, &#39;</span>
                <span class="s2">&quot;it will be overwritten by this new &quot;</span>
                <span class="s2">&quot;calculation...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">conv_dir</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">conv_dir</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">tmp</span><span class="p">):</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>

        <span class="c1"># Resample the convolve_with to the size of images_to_convolve, then</span>
        <span class="c1"># convolve each images_to_convolve with resized convolve_with.</span>
        <span class="n">mask_thresh</span> <span class="o">=</span> <span class="n">threshold</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">convolve_with</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">roi_file</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">images_to_convolve</span><span class="p">:</span>
            <span class="n">roi_img</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">roi_file</span><span class="p">)</span>
            <span class="n">roi_data</span> <span class="o">=</span> <span class="n">roi_img</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">()</span>
            <span class="n">roi_size</span> <span class="o">=</span> <span class="n">roi_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
            <span class="n">resized_mask</span> <span class="o">=</span> <span class="n">resize</span><span class="p">(</span><span class="n">mask_thresh</span><span class="p">,</span> <span class="n">roi_size</span><span class="p">)</span>
            <span class="n">mult</span> <span class="o">=</span> <span class="p">(</span><span class="n">roi_data</span> <span class="o">*</span> <span class="n">resized_mask</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
            <span class="c1"># TODO: Should we take info from images_to_convolve or from</span>
            <span class="c1">#       convolve_with ?</span>
            <span class="c1">#       Currently we take from images_to_convolve</span>
            <span class="n">mult_img</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">Nifti1Image</span><span class="p">(</span><span class="n">mult</span><span class="p">,</span> <span class="n">roi_img</span><span class="o">.</span><span class="n">affine</span><span class="p">,</span> <span class="n">roi_img</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>

            <span class="c1"># Image save in conv_dir</span>
            <span class="n">out_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">conv_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">roi_file</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">nib</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">mult_img</span><span class="p">,</span> <span class="n">out_file</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> saved&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">out_file</span><span class="p">))</span></div></div>


<div class="viewcode-block" id="Enhance"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.others.html#mia_processes.bricks.preprocess.others.processing.Enhance">[docs]</a><span class="k">class</span> <span class="nc">Enhance</span><span class="p">(</span><span class="n">ProcessMIA</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    *Image enhancing.</span>

<span class="sd">    Please, see the complete documentation for the `Enhance&#39; brick</span>
<span class="sd">    in the populse.mia_processes website</span>
<span class="sd">    https://populse.github.io/mia_processes/html/documentation/bricks/preprocess/other/Enhance.html</span>

<span class="sd">    adapted from:</span>
<span class="sd">    https://github.com/nipreps/mriqc/blob/22.0.6/mriqc/workflows/anatomical.py#L974</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Enhance.__init__"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.others.html#mia_processes.bricks.preprocess.others.processing.Enhance.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the attributes initialisation / instantiation.</span>

<span class="sd">        The input and output plugs are defined here. The special</span>
<span class="sd">        &#39;self.requirement&#39; attribute (optional) is used to define the</span>
<span class="sd">        third-party products necessary for the running of the brick.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Initialisation of the objects needed for the launch of the brick</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Enhance</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1"># Third party softwares required for the execution of the brick</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requirement</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Inputs description</span>
        <span class="n">in_files_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;A list of items with string elements corresponding &quot;</span>
            <span class="s2">&quot;to existing path files.&quot;</span>
        <span class="p">)</span>
        <span class="n">prefix_desc</span> <span class="o">=</span> <span class="s2">&quot;Prefix of the output image (a string).&quot;</span>
        <span class="n">suffix_desc</span> <span class="o">=</span> <span class="s2">&quot;Suffix of the output image (a string).&quot;</span>

        <span class="c1"># Outputs description</span>
        <span class="n">out_files_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Path of the scan after enhancing &quot;</span>
            <span class="s2">&quot;(a pathlike object or string representing a file, or &quot;</span>
            <span class="s2">&quot;a list of pathlike objects or strings representing a &quot;</span>
            <span class="s2">&quot;file).&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Inputs traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;in_files&quot;</span><span class="p">,</span>
            <span class="n">InputMultiPath</span><span class="p">(</span>
                <span class="n">traits</span><span class="o">.</span><span class="n">Either</span><span class="p">(</span><span class="n">File</span><span class="p">(),</span> <span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">File</span><span class="p">())),</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">in_files_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;prefix&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">prefix_desc</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;suffix&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">String</span><span class="p">(</span>
                <span class="s2">&quot;_enh&quot;</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">suffix_desc</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># Outputs traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;out_files&quot;</span><span class="p">,</span>
            <span class="n">OutputMultiPath</span><span class="p">(</span><span class="n">File</span><span class="p">(),</span> <span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">out_files_desc</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">init_default_traits</span><span class="p">()</span></div>

<div class="viewcode-block" id="Enhance.list_outputs"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.others.html#mia_processes.bricks.preprocess.others.processing.Enhance.list_outputs">[docs]</a>    <span class="k">def</span> <span class="nf">list_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_plugged</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the initialisation step of the brick.</span>

<span class="sd">        The main objective of this method is to produce the outputs of the</span>
<span class="sd">        bricks (self.outputs) and the associated tags (self.inheritance_dic),</span>
<span class="sd">        if defined here. To work properly this method must return</span>
<span class="sd">        self.make_initResult() object.</span>

<span class="sd">        :param is_plugged: the state, linked or not, of the plugs.</span>
<span class="sd">        :returns: a dictionary with requirement, outputs and inheritance_dict.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Using the inheritance to ProcessMIA class, list_outputs method</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Enhance</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">list_outputs</span><span class="p">()</span>

        <span class="c1"># Outputs definition</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_files</span><span class="p">:</span>
            <span class="n">files_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_files</span>

            <span class="k">if</span> <span class="p">(</span>
                <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span><span class="p">)</span>
                <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">isspace</span><span class="p">())</span>
                <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span> <span class="ow">in</span> <span class="p">[</span><span class="n">Undefined</span><span class="p">,</span> <span class="s2">&quot;&lt;undefined&gt;&quot;</span><span class="p">]</span>
            <span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span>

            <span class="k">if</span> <span class="p">(</span>
                <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="p">)</span>
                <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="o">.</span><span class="n">isspace</span><span class="p">())</span>
                <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span> <span class="ow">in</span> <span class="p">[</span><span class="n">Undefined</span><span class="p">,</span> <span class="s2">&quot;&lt;undefined&gt;&quot;</span><span class="p">])</span>
            <span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span>

            <span class="n">files</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">flag</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># If False, suf/pref check will not be performed later</span>

            <span class="k">for</span> <span class="n">file_name1</span> <span class="ow">in</span> <span class="n">files_name</span><span class="p">:</span>
                <span class="n">valid_ext</span><span class="p">,</span> <span class="n">in_ext</span><span class="p">,</span> <span class="n">fileName</span> <span class="o">=</span> <span class="n">checkFileExt</span><span class="p">(</span><span class="n">file_name1</span><span class="p">,</span> <span class="n">EXT</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_ext</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Enhance brick: The input image format is not &quot;</span>
                        <span class="s2">&quot;recognized...!&quot;</span>
                    <span class="p">)</span>
                    <span class="k">return</span>
                <span class="n">path</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">file_name1</span><span class="p">)</span>

                <span class="k">if</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span> <span class="o">==</span> <span class="s2">&quot; &quot;</span>
                    <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span> <span class="o">==</span> <span class="s2">&quot; &quot;</span>
                    <span class="ow">and</span> <span class="n">path</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span>
                    <span class="ow">and</span> <span class="n">flag</span> <span class="ow">is</span> <span class="kc">True</span>
                <span class="p">):</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="n">QMessageBox</span><span class="p">()</span>
                    <span class="n">msg</span><span class="o">.</span><span class="n">setIcon</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Warning</span><span class="p">)</span>
                    <span class="n">msg</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span>
                        <span class="s2">&quot;mia_processes - Enhance brick Warning!&quot;</span>
                    <span class="p">)</span>
                    <span class="n">msg</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span>
                        <span class="s2">&quot;Suffix and prefix input parameters are not &quot;</span>
                        <span class="s2">&quot;defined or consist only of one or more white &quot;</span>
                        <span class="s2">&quot;spaces.</span><span class="se">\n</span><span class="s2">The </span><span class="si">{0}</span><span class="s2"> input parameter will be &quot;</span>
                        <span class="s2">&quot;overwritten ...</span><span class="se">\n</span><span class="s2"> Yes or &quot;</span>
                        <span class="s2">&quot;Abort?&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file_name1</span><span class="p">)</span>
                    <span class="p">)</span>
                    <span class="n">msg</span><span class="o">.</span><span class="n">setStandardButtons</span><span class="p">(</span>
                        <span class="n">QMessageBox</span><span class="o">.</span><span class="n">Yes</span>
                        <span class="o">|</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">YesToAll</span>
                        <span class="o">|</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">Abort</span>
                    <span class="p">)</span>
                    <span class="n">retval</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">exec_</span><span class="p">()</span>

                    <span class="k">if</span> <span class="n">retval</span> <span class="o">!=</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">Abort</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span>
                            <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Enhance brick warning: the out_files output &quot;</span>
                            <span class="s2">&quot;parameter is the same as the in_files input &quot;</span>
                            <span class="s2">&quot;parameter (suffix and prefix are not defined):&quot;</span>
                            <span class="s2">&quot;</span><span class="se">\n</span><span class="si">{0}</span><span class="s2"> will be overwrited ...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file_name1</span><span class="p">)</span>
                        <span class="p">)</span>

                        <span class="k">if</span> <span class="n">retval</span> <span class="o">==</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">YesToAll</span><span class="p">:</span>
                            <span class="n">flag</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="nb">print</span><span class="p">(</span>
                                <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Enhance brick brick: YesToAll selected ; &quot;</span>
                                <span class="s2">&quot;end of overwrite checks on input images ...&quot;</span>
                            <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">files_name</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="nb">print</span><span class="p">(</span>
                            <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Enhance brick brick: Aborted ; Please check &quot;</span>
                            <span class="s2">&quot;your input parameters ...&quot;</span>
                        <span class="p">)</span>
                        <span class="k">return</span>

                <span class="n">files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span>
                        <span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                            <span class="o">+</span> <span class="n">fileName</span>
                            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                            <span class="o">+</span> <span class="s2">&quot;.&quot;</span>
                            <span class="o">+</span> <span class="n">in_ext</span>
                        <span class="p">),</span>
                    <span class="p">)</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="n">files_name</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;out_files&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">files</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s2">&quot;- Enhance brick: There was no output file deducted &quot;</span>
                    <span class="s2">&quot;during initialisation. Please check the input &quot;</span>
                    <span class="s2">&quot;parameters...!&quot;</span>
                <span class="p">)</span>

        <span class="c1"># tags inheritance (optional)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;out_files&quot;</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">in_val</span><span class="p">,</span> <span class="n">out_val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">files_name</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
                        <span class="n">_</span><span class="p">,</span> <span class="n">fileOval</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">out_val</span><span class="p">)</span>
                        <span class="n">fileOval_no_ext</span><span class="p">,</span> <span class="n">file_extension</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span>
                            <span class="n">fileOval</span>
                        <span class="p">)</span>
                        <span class="k">if</span> <span class="n">file_extension</span> <span class="o">==</span> <span class="s2">&quot;.gz&quot;</span><span class="p">:</span>
                            <span class="p">(</span>
                                <span class="n">fileOval_no_ext_2</span><span class="p">,</span>
                                <span class="n">file_extension_2</span><span class="p">,</span>
                            <span class="p">)</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">fileOval_no_ext</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">file_extension_2</span> <span class="o">==</span> <span class="s2">&quot;.nii&quot;</span><span class="p">:</span>
                                <span class="n">fileOval_no_ext</span> <span class="o">=</span> <span class="n">fileOval_no_ext_2</span>

                        <span class="n">_</span><span class="p">,</span> <span class="n">fileIval</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">in_val</span><span class="p">)</span>
                        <span class="n">fileIval_no_ext</span><span class="p">,</span> <span class="n">file_extension</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span>
                            <span class="n">fileIval</span>
                        <span class="p">)</span>
                        <span class="k">if</span> <span class="n">file_extension</span> <span class="o">==</span> <span class="s2">&quot;.gz&quot;</span><span class="p">:</span>
                            <span class="p">(</span>
                                <span class="n">fileIval_no_ext_2</span><span class="p">,</span>
                                <span class="n">file_extension_2</span><span class="p">,</span>
                            <span class="p">)</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">fileIval_no_ext</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">file_extension_2</span> <span class="o">==</span> <span class="s2">&quot;.nii&quot;</span><span class="p">:</span>
                                <span class="n">fileIval_no_ext</span> <span class="o">=</span> <span class="n">fileIval_no_ext_2</span>

                        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span>
                            <span class="n">fileOval_no_ext</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="p">)</span>
                        <span class="p">):</span>
                            <span class="c1"># fmt: off</span>
                            <span class="n">fileOval_no_ext</span> <span class="o">=</span> <span class="n">fileOval_no_ext</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span>
                                                              <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="p">):]</span>
                            <span class="c1"># fmt: on</span>
                        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">suffix</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span>
                            <span class="n">fileOval_no_ext</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">suffix</span><span class="p">)</span>
                        <span class="p">):</span>
                            <span class="n">fileOval_no_ext</span> <span class="o">=</span> <span class="n">fileOval_no_ext</span><span class="p">[</span>
                                <span class="p">:</span> <span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">suffix</span><span class="p">)</span>
                            <span class="p">]</span>

                        <span class="k">if</span> <span class="n">fileOval_no_ext</span> <span class="o">==</span> <span class="n">fileIval_no_ext</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">inheritance_dict</span><span class="p">[</span><span class="n">out_val</span><span class="p">]</span> <span class="o">=</span> <span class="n">in_val</span>

        <span class="c1"># Return the requirement, outputs and inheritance_dict</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_initResult</span><span class="p">()</span></div>

<div class="viewcode-block" id="Enhance.run_process_mia"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.others.html#mia_processes.bricks.preprocess.others.processing.Enhance.run_process_mia">[docs]</a>    <span class="k">def</span> <span class="nf">run_process_mia</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the process launch step of the brick.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Enhance</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">run_process_mia</span><span class="p">()</span>

        <span class="n">files_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_files</span>

        <span class="k">for</span> <span class="n">file_name</span> <span class="ow">in</span> <span class="n">files_name</span><span class="p">:</span>
            <span class="c1"># Image processing</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">img</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>

            <span class="k">except</span> <span class="p">(</span>
                <span class="n">nib</span><span class="o">.</span><span class="n">filebasedimages</span><span class="o">.</span><span class="n">ImageFileError</span><span class="p">,</span>
                <span class="ne">FileNotFoundError</span><span class="p">,</span>
                <span class="ne">TypeError</span><span class="p">,</span>
            <span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Enhance brick: Error with file to enhance, during the &quot;</span>
                    <span class="s2">&quot;run: &quot;</span><span class="p">,</span>
                    <span class="n">e</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">img</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="n">img</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
                <span class="n">range_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">data</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">],</span> <span class="mf">99.98</span><span class="p">)</span>
                <span class="n">range_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">data</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">])</span>

                <span class="c1"># Resample signal excess pixels</span>
                <span class="n">excess</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">data</span> <span class="o">&gt;</span> <span class="n">range_max</span><span class="p">)</span>
                <span class="n">data</span><span class="p">[</span><span class="n">excess</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">data</span><span class="p">[</span><span class="n">excess</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span>
                    <span class="n">data</span><span class="p">[</span><span class="n">data</span> <span class="o">&gt;</span> <span class="n">range_min</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">excess</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="p">)</span>

                <span class="n">out_image</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">img</span><span class="o">.</span><span class="n">affine</span><span class="p">,</span> <span class="n">img</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>

                <span class="c1"># Image save</span>
                <span class="n">_</span><span class="p">,</span> <span class="n">file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
                <span class="n">file_name_no_ext</span><span class="p">,</span> <span class="n">file_extension</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">file_extension</span> <span class="o">==</span> <span class="s2">&quot;.gz&quot;</span><span class="p">:</span>
                    <span class="p">(</span><span class="n">file_name_no_ext_2</span><span class="p">,</span> <span class="n">file_extension_2</span><span class="p">)</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span>
                        <span class="n">file_name_no_ext</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">file_extension_2</span> <span class="o">==</span> <span class="s2">&quot;.nii&quot;</span><span class="p">:</span>
                        <span class="n">file_name_no_ext</span> <span class="o">=</span> <span class="n">file_name_no_ext_2</span>
                        <span class="n">file_extension</span> <span class="o">=</span> <span class="s2">&quot;.nii.gz&quot;</span>

                <span class="n">file_out</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span>
                    <span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                        <span class="o">+</span> <span class="n">file_name_no_ext</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                        <span class="o">+</span> <span class="n">file_extension</span>
                    <span class="p">),</span>
                <span class="p">)</span>
                <span class="n">nib</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">out_image</span><span class="p">,</span> <span class="n">file_out</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="EstimateSNR"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.others.html#mia_processes.bricks.preprocess.others.processing.EstimateSNR">[docs]</a><span class="k">class</span> <span class="nc">EstimateSNR</span><span class="p">(</span><span class="n">ProcessMIA</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    *Estimate SNR using a segmentation file.</span>

<span class="sd">    Please, see the complete documentation for the `EstimateSNR&#39; brick</span>
<span class="sd">    in the populse.mia_processes website</span>
<span class="sd">    https://populse.github.io/mia_processes/html/documentation/bricks/preprocess/other/EstimateSNR.html</span>

<span class="sd">    adapted from:</span>
<span class="sd">    https://github.com/nipreps/mriqc/blob/22.0.6/mriqc/workflows/anatomical.py#L970</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="EstimateSNR.__init__"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.others.html#mia_processes.bricks.preprocess.others.processing.EstimateSNR.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the attributes initialisation / instantiation.</span>

<span class="sd">        The input and output plugs are defined here. The special</span>
<span class="sd">        &#39;self.requirement&#39; attribute (optional) is used to define the</span>
<span class="sd">        third-party products necessary for the running of the brick.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Initialisation of the objects needed for the launch of the brick</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">EstimateSNR</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1"># Third party softwares required for the execution of the brick</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requirement</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Inputs description</span>
        <span class="n">in_file_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Input file (a pathlike object or string &quot;</span> <span class="s2">&quot;representing a file).&quot;</span>
        <span class="p">)</span>
        <span class="n">seg_file_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;A segmentation file to calculate SNR (a pathlike &quot;</span>
            <span class="s2">&quot;object or string representing a file).&quot;</span>
        <span class="p">)</span>
        <span class="c1"># Outputs description</span>
        <span class="n">out_snr_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Estimated SNR&quot;</span> <span class="s2">&quot;(a pathlike object or string representing a file&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Inputs traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;in_file&quot;</span><span class="p">,</span> <span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">in_file_desc</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;seg_file&quot;</span><span class="p">,</span> <span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">seg_file_desc</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Outputs traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;out_snr&quot;</span><span class="p">,</span> <span class="n">traits</span><span class="o">.</span><span class="n">Float</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">out_snr_desc</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">init_default_traits</span><span class="p">()</span></div>

<div class="viewcode-block" id="EstimateSNR.list_outputs"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.others.html#mia_processes.bricks.preprocess.others.processing.EstimateSNR.list_outputs">[docs]</a>    <span class="k">def</span> <span class="nf">list_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_plugged</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the initialisation step of the brick.</span>

<span class="sd">        The main objective of this method is to produce the outputs of the</span>
<span class="sd">        bricks (self.outputs) and the associated tags (self.inheritance_dic),</span>
<span class="sd">        if defined here. To work properly this method must return</span>
<span class="sd">        self.make_initResult() object.</span>

<span class="sd">        :param is_plugged: the state, linked or not, of the plugs.</span>
<span class="sd">        :returns: a dictionary with requirement, outputs and inheritance_dict.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Using the inheritance to ProcessMIA class, list_outputs method</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">EstimateSNR</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">list_outputs</span><span class="p">()</span>

        <span class="c1"># Outputs definition</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_file</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">:</span>
                <span class="n">valid_ext</span><span class="p">,</span> <span class="n">in_ext</span><span class="p">,</span> <span class="n">fileName</span> <span class="o">=</span> <span class="n">checkFileExt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_file</span><span class="p">,</span> <span class="n">EXT</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_ext</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">EstimateSNR brick: The input image format is not &quot;</span>
                        <span class="s2">&quot;recognized...!&quot;</span>
                    <span class="p">)</span>
                    <span class="k">return</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;EstimateSNR brick: No output_directory was found...!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span>

        <span class="c1"># Return the requirement, outputs and inheritance_dict</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_initResult</span><span class="p">()</span></div>

<div class="viewcode-block" id="EstimateSNR.run_process_mia"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.others.html#mia_processes.bricks.preprocess.others.processing.EstimateSNR.run_process_mia">[docs]</a>    <span class="k">def</span> <span class="nf">run_process_mia</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the process launch step of the brick.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">EstimateSNR</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">run_process_mia</span><span class="p">()</span>

        <span class="n">file_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_file</span>
        <span class="n">seg_file_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">seg_file</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
            <span class="n">seg_img</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">seg_file_name</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span>
            <span class="n">nib</span><span class="o">.</span><span class="n">filebasedimages</span><span class="o">.</span><span class="n">ImageFileError</span><span class="p">,</span>
            <span class="ne">FileNotFoundError</span><span class="p">,</span>
            <span class="ne">TypeError</span><span class="p">,</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">EstimateSNR brick: Error with files, during the run: &quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">()</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">seg_img</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">()</span> <span class="o">==</span> <span class="mi">2</span>  <span class="c1"># WM label</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">out_snr</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">mask</span><span class="p">])</span>
            <span class="o">/</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span>
        <span class="p">)</span></div></div>


<div class="viewcode-block" id="GradientThreshold"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.others.html#mia_processes.bricks.preprocess.others.processing.GradientThreshold">[docs]</a><span class="k">class</span> <span class="nc">GradientThreshold</span><span class="p">(</span><span class="n">ProcessMIA</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    * Computes a threshold from the histogram of the magnitude gradient image.</span>

<span class="sd">    Please, see the complete documentation for the `GradientThreshold&#39; brick</span>
<span class="sd">    in the populse.mia_processes website</span>
<span class="sd">    https://populse.github.io/mia_processes/html/documentation/bricks/preprocess/other/GradientThreshold.html</span>

<span class="sd">    adapted from:</span>
<span class="sd">    https://github.com/nipreps/mriqc/blob/e021008da0a2ef1c48e882baf932139a673349f9/mriqc/workflows/anatomical.py#L1039</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="GradientThreshold.__init__"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.others.html#mia_processes.bricks.preprocess.others.processing.GradientThreshold.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the attributes initialisation / instantiation.</span>

<span class="sd">        The input and output plugs are defined here. The special</span>
<span class="sd">        &#39;self.requirement&#39; attribute (optional) is used to define the</span>
<span class="sd">        third-party products necessary for the running of the brick.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Initialisation of the objects needed for the launch of the brick</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">GradientThreshold</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1"># Third party softwares required for the execution of the brick</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requirement</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Inputs description</span>
        <span class="n">in_file_desc</span> <span class="o">=</span> <span class="s2">&quot;An existing path file.&quot;</span>
        <span class="n">seg_file_desc</span> <span class="o">=</span> <span class="s2">&quot;An existing path of segmentation file.&quot;</span>
        <span class="n">prefix_desc</span> <span class="o">=</span> <span class="s2">&quot;Prefix of the output image (a string).&quot;</span>
        <span class="n">suffix_desc</span> <span class="o">=</span> <span class="s2">&quot;Suffix of the output image (a string).&quot;</span>

        <span class="c1"># Outputs description</span>
        <span class="n">out_file_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Path of the thresholded scan &quot;</span>
            <span class="s2">&quot;(a pathlike object or string representing a file).&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Inputs traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;in_file&quot;</span><span class="p">,</span> <span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">in_file_desc</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;seg_file&quot;</span><span class="p">,</span> <span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">seg_file_desc</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;prefix&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">prefix_desc</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;suffix&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">String</span><span class="p">(</span>
                <span class="s2">&quot;_grad&quot;</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">suffix_desc</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># Outputs traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;out_file&quot;</span><span class="p">,</span> <span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">out_file_desc</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">init_default_traits</span><span class="p">()</span></div>

<div class="viewcode-block" id="GradientThreshold.list_outputs"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.others.html#mia_processes.bricks.preprocess.others.processing.GradientThreshold.list_outputs">[docs]</a>    <span class="k">def</span> <span class="nf">list_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_plugged</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the initialisation step of the brick.</span>

<span class="sd">        The main objective of this method is to produce the outputs of the</span>
<span class="sd">        bricks (self.outputs) and the associated tags (self.inheritance_dic),</span>
<span class="sd">        if defined here. To work properly this method must return</span>
<span class="sd">        self.make_initResult() object.</span>

<span class="sd">        :param is_plugged: the state, linked or not, of the plugs.</span>
<span class="sd">        :returns: a dictionary with requirement, outputs and inheritance_dict.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Using the inheritance to ProcessMIA class, list_outputs method</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">GradientThreshold</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">list_outputs</span><span class="p">()</span>

        <span class="c1"># Outputs definition</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_file</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span><span class="p">)</span>
                <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">isspace</span><span class="p">())</span>
                <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span> <span class="ow">in</span> <span class="p">[</span><span class="n">Undefined</span><span class="p">,</span> <span class="s2">&quot;&lt;undefined&gt;&quot;</span><span class="p">]</span>
            <span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span>

            <span class="k">if</span> <span class="p">(</span>
                <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="p">)</span>
                <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="o">.</span><span class="n">isspace</span><span class="p">())</span>
                <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span> <span class="ow">in</span> <span class="p">[</span><span class="n">Undefined</span><span class="p">,</span> <span class="s2">&quot;&lt;undefined&gt;&quot;</span><span class="p">])</span>
            <span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span>

            <span class="n">valid_ext</span><span class="p">,</span> <span class="n">in_ext</span><span class="p">,</span> <span class="n">fileName</span> <span class="o">=</span> <span class="n">checkFileExt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_file</span><span class="p">,</span> <span class="n">EXT</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_ext</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">GradientThreshold brick: The input image format is &quot;</span>
                    <span class="s2">&quot;not recognized...!&quot;</span>
                <span class="p">)</span>
                <span class="k">return</span>

            <span class="n">path</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_file</span><span class="p">)</span>

            <span class="k">if</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span> <span class="o">==</span> <span class="s2">&quot; &quot;</span>
                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span> <span class="o">==</span> <span class="s2">&quot; &quot;</span>
                <span class="ow">and</span> <span class="n">path</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span>
            <span class="p">):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="n">QMessageBox</span><span class="p">()</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">setIcon</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Warning</span><span class="p">)</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span>
                    <span class="s2">&quot;mia_processes - &quot;</span> <span class="s2">&quot;GradientThreshold brick Warning!&quot;</span>
                <span class="p">)</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span>
                    <span class="s2">&quot;Suffix and prefix input parameters are not &quot;</span>
                    <span class="s2">&quot;defined or consist only of one or more white &quot;</span>
                    <span class="s2">&quot;spaces.</span><span class="se">\n</span><span class="s2">The </span><span class="si">{0}</span><span class="s2"> input parameter will be &quot;</span>
                    <span class="s2">&quot;overwritten ...</span><span class="se">\n</span><span class="s2"> Yes or &quot;</span>
                    <span class="s2">&quot;Abort?&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">setStandardButtons</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Yes</span> <span class="o">|</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">Abort</span><span class="p">)</span>
                <span class="n">retval</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">exec_</span><span class="p">()</span>

                <span class="k">if</span> <span class="n">retval</span> <span class="o">!=</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">Abort</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">GradientThreshold brick warning: the out_file&quot;</span>
                        <span class="s2">&quot;output parameter is the same as the in_file input &quot;</span>
                        <span class="s2">&quot;parameter (suffix and prefix are not defined):&quot;</span>
                        <span class="s2">&quot;</span><span class="se">\n</span><span class="si">{0}</span><span class="s2"> will be overwritten ...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>
                    <span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">GradientThreshold brick Aborted. Please check &quot;</span>
                        <span class="s2">&quot;your input parameters ...&quot;</span>
                    <span class="p">)</span>
                    <span class="k">return</span>

            <span class="n">file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span>
                <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="o">+</span> <span class="n">fileName</span>
                    <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="o">+</span> <span class="s2">&quot;.&quot;</span>
                    <span class="o">+</span> <span class="n">in_ext</span>
                <span class="p">),</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">file</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;out_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">file</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s2">&quot;- GradientThreshold brick: There was no output file &quot;</span>
                    <span class="s2">&quot;deducted during initialization. Please check the input &quot;</span>
                    <span class="s2">&quot;parameters...!&quot;</span>
                <span class="p">)</span>

            <span class="c1"># tags inheritance (optional)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;out_file&quot;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">inheritance_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;out_file&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_file</span>

        <span class="c1"># Return the requirement, outputs and inheritance_dict</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_initResult</span><span class="p">()</span></div>

<div class="viewcode-block" id="GradientThreshold.run_process_mia"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.others.html#mia_processes.bricks.preprocess.others.processing.GradientThreshold.run_process_mia">[docs]</a>    <span class="k">def</span> <span class="nf">run_process_mia</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the process launch step of the brick.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">GradientThreshold</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">run_process_mia</span><span class="p">()</span>

        <span class="n">file_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_file</span>
        <span class="n">seg_file_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">seg_file</span>

        <span class="c1"># Image processing</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
            <span class="n">seg_img</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">seg_file_name</span><span class="p">)</span>

        <span class="k">except</span> <span class="p">(</span>
            <span class="n">nib</span><span class="o">.</span><span class="n">filebasedimages</span><span class="o">.</span><span class="n">ImageFileError</span><span class="p">,</span>
            <span class="ne">FileNotFoundError</span><span class="p">,</span>
            <span class="ne">TypeError</span><span class="p">,</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">GradientThreshold brick: Error with file to enhance, &quot;</span>
                <span class="s2">&quot;during the run: &quot;</span><span class="p">,</span>
                <span class="n">e</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">img</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">seg_img</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">img</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">seg_img</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="c1"># Image gradient</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
            <span class="n">data_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="mf">99.5</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">*=</span> <span class="mi">100</span> <span class="o">/</span> <span class="n">data_max</span>
            <span class="n">grad</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">gaussian_gradient_magnitude</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">)</span>
            <span class="n">grad_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">grad</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="mf">99.5</span><span class="p">)</span>
            <span class="n">grad</span> <span class="o">*=</span> <span class="mf">100.0</span>
            <span class="n">grad</span> <span class="o">/=</span> <span class="n">grad_max</span>

            <span class="c1"># Gradient threshold</span>
            <span class="n">struc</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">iterate_structure</span><span class="p">(</span>
                <span class="n">sim</span><span class="o">.</span><span class="n">generate_binary_structure</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="mi">2</span>
            <span class="p">)</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">grad</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
            <span class="n">mask</span><span class="p">[</span><span class="n">grad</span> <span class="o">&gt;</span> <span class="mf">15.0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

            <span class="n">seg_data</span> <span class="o">=</span> <span class="n">seg_img</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
            <span class="n">seg_data</span><span class="p">[</span><span class="n">seg_data</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">seg_data</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">binary_dilation</span><span class="p">(</span>
                <span class="n">seg_data</span><span class="p">,</span> <span class="n">struc</span><span class="p">,</span> <span class="n">iterations</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">border_value</span><span class="o">=</span><span class="mi">1</span>
            <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
            <span class="n">mask</span><span class="p">[</span><span class="n">seg_data</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">binary_closing</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">struc</span><span class="p">,</span> <span class="n">iterations</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">uint8</span>
            <span class="p">)</span>

            <span class="n">label_im</span><span class="p">,</span> <span class="n">nb_labels</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
            <span class="n">artmsk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">nb_labels</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">sizes</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">label_im</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">nb_labels</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))</span>
                <span class="n">ordered</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
                    <span class="nb">reversed</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">sizes</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">nb_labels</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))))</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">ordered</span><span class="p">[</span><span class="mi">2</span><span class="p">:]:</span>
                    <span class="n">mask</span><span class="p">[</span><span class="n">label_im</span> <span class="o">==</span> <span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">artmsk</span><span class="p">[</span><span class="n">label_im</span> <span class="o">==</span> <span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

            <span class="n">mask</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">binary_fill_holes</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">struc</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>

            <span class="n">out_image</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">img</span><span class="o">.</span><span class="n">affine</span><span class="p">,</span> <span class="n">img</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>

            <span class="c1"># Image save</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
            <span class="n">file_name_no_ext</span><span class="p">,</span> <span class="n">file_extension</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">file_extension</span> <span class="o">==</span> <span class="s2">&quot;.gz&quot;</span><span class="p">:</span>
                <span class="p">(</span><span class="n">file_name_no_ext_2</span><span class="p">,</span> <span class="n">file_extension_2</span><span class="p">)</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span>
                    <span class="n">file_name_no_ext</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">file_extension_2</span> <span class="o">==</span> <span class="s2">&quot;.nii&quot;</span><span class="p">:</span>
                    <span class="n">file_name_no_ext</span> <span class="o">=</span> <span class="n">file_name_no_ext_2</span>
                    <span class="n">file_extension</span> <span class="o">=</span> <span class="s2">&quot;.nii.gz&quot;</span>

            <span class="n">file_out</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span>
                <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="o">+</span> <span class="n">file_name_no_ext</span>
                    <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="o">+</span> <span class="n">file_extension</span>
                <span class="p">),</span>
            <span class="p">)</span>
            <span class="n">nib</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">out_image</span><span class="p">,</span> <span class="n">file_out</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="Harmonize"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.others.html#mia_processes.bricks.preprocess.others.processing.Harmonize">[docs]</a><span class="k">class</span> <span class="nc">Harmonize</span><span class="p">(</span><span class="n">ProcessMIA</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    * Harmonize.</span>

<span class="sd">    Please, see the complete documentation for the `Harmonize&#39; brick</span>
<span class="sd">    in the populse.mia_processes website</span>
<span class="sd">    https://populse.github.io/mia_processes/html/documentation/bricks/preprocess/other/Harmonize.html</span>

<span class="sd">    adapted from:</span>
<span class="sd">    https://github.com/nipreps/mriqc/blob/e021008da0a2ef1c48e882baf932139a673349f9/mriqc/interfaces/anatomical.py#L405</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Harmonize.__init__"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.others.html#mia_processes.bricks.preprocess.others.processing.Harmonize.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the attributes initialisation / instantiation.</span>

<span class="sd">        The input and output plugs are defined here. The special</span>
<span class="sd">        &#39;self.requirement&#39; attribute (optional) is used to define the</span>
<span class="sd">        third-party products necessary for the running of the brick.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Initialisation of the objects needed for the launch of the brick</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Harmonize</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1"># Third party softwares required for the execution of the brick</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requirement</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Inputs description</span>
        <span class="n">in_file_desc</span> <span class="o">=</span> <span class="s2">&quot;An existing path file.&quot;</span>
        <span class="n">wm_mask_desc</span> <span class="o">=</span> <span class="s2">&quot;An existing path of a WM mask file.&quot;</span>
        <span class="n">erodemask_desc</span> <span class="o">=</span> <span class="s2">&quot;Boolean (a string).&quot;</span>
        <span class="n">suffix_desc</span> <span class="o">=</span> <span class="s2">&quot;Suffix of the output image (a string).&quot;</span>
        <span class="n">prefix_desc</span> <span class="o">=</span> <span class="s2">&quot;Prefix of the output image (a string).&quot;</span>

        <span class="c1"># Outputs description</span>
        <span class="n">out_file_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Path of the harmonized image &quot;</span>
            <span class="s2">&quot;(a pathlike object or string representing a file).&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Inputs traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;in_file&quot;</span><span class="p">,</span> <span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">in_file_desc</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;wm_mask&quot;</span><span class="p">,</span> <span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">wm_mask_desc</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;erodemask&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">Bool</span><span class="p">(</span>
                <span class="kc">True</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">erodemask_desc</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;prefix&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">prefix_desc</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;suffix&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">String</span><span class="p">(</span>
                <span class="s2">&quot;_harmonized&quot;</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">suffix_desc</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># Outputs traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;out_file&quot;</span><span class="p">,</span> <span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">out_file_desc</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">init_default_traits</span><span class="p">()</span></div>

<div class="viewcode-block" id="Harmonize.list_outputs"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.others.html#mia_processes.bricks.preprocess.others.processing.Harmonize.list_outputs">[docs]</a>    <span class="k">def</span> <span class="nf">list_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_plugged</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the initialisation step of the brick.</span>

<span class="sd">        The main objective of this method is to produce the outputs of the</span>
<span class="sd">        bricks (self.outputs) and the associated tags (self.inheritance_dic),</span>
<span class="sd">        if defined here. To work properly this method must return</span>
<span class="sd">        self.make_initResult() object.</span>

<span class="sd">        :param is_plugged: the state, linked or not, of the plugs.</span>
<span class="sd">        :returns: a dictionary with requirement, outputs and inheritance_dict.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Using the inheritance to ProcessMIA class, list_outputs method</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Harmonize</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">list_outputs</span><span class="p">()</span>

        <span class="c1"># Outputs definition</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_file</span><span class="p">:</span>
            <span class="n">valid_ext</span><span class="p">,</span> <span class="n">in_ext</span><span class="p">,</span> <span class="n">fileName</span> <span class="o">=</span> <span class="n">checkFileExt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_file</span><span class="p">,</span> <span class="n">EXT</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_ext</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Harmonize brick: The input image format is &quot;</span>
                    <span class="s2">&quot;not recognized...!&quot;</span>
                <span class="p">)</span>
                <span class="k">return</span>

            <span class="k">if</span> <span class="p">(</span>
                <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span><span class="p">)</span>
                <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">isspace</span><span class="p">())</span>
                <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span> <span class="ow">in</span> <span class="p">[</span><span class="n">Undefined</span><span class="p">,</span> <span class="s2">&quot;&lt;undefined&gt;&quot;</span><span class="p">]</span>
            <span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span>

            <span class="k">if</span> <span class="p">(</span>
                <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="p">)</span>
                <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="o">.</span><span class="n">isspace</span><span class="p">())</span>
                <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span> <span class="ow">in</span> <span class="p">[</span><span class="n">Undefined</span><span class="p">,</span> <span class="s2">&quot;&lt;undefined&gt;&quot;</span><span class="p">])</span>
            <span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span>

            <span class="n">path</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_file</span><span class="p">)</span>

            <span class="k">if</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span> <span class="o">==</span> <span class="s2">&quot; &quot;</span>
                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span> <span class="o">==</span> <span class="s2">&quot; &quot;</span>
                <span class="ow">and</span> <span class="n">path</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span>
            <span class="p">):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="n">QMessageBox</span><span class="p">()</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">setIcon</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Warning</span><span class="p">)</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span>
                    <span class="s2">&quot;mia_processes - &quot;</span> <span class="s2">&quot;Harmonize brick Warning!&quot;</span>
                <span class="p">)</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span>
                    <span class="s2">&quot;Suffix and prefix input parameters are not &quot;</span>
                    <span class="s2">&quot;defined or consist only of one or more white &quot;</span>
                    <span class="s2">&quot;spaces.</span><span class="se">\n</span><span class="s2">The </span><span class="si">{0}</span><span class="s2"> input parameter will be &quot;</span>
                    <span class="s2">&quot;overwritten ...</span><span class="se">\n</span><span class="s2"> Yes or &quot;</span>
                    <span class="s2">&quot;Abort?&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">setStandardButtons</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Yes</span> <span class="o">|</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">Abort</span><span class="p">)</span>
                <span class="n">retval</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">exec_</span><span class="p">()</span>

                <span class="k">if</span> <span class="n">retval</span> <span class="o">!=</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">Abort</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Harmonize brick warning: the out_file output &quot;</span>
                        <span class="s2">&quot;parameter is the same as the in_file input &quot;</span>
                        <span class="s2">&quot;parameter (suffix and prefix are not defined):&quot;</span>
                        <span class="s2">&quot;</span><span class="se">\n</span><span class="si">{0}</span><span class="s2"> will be overwrited ...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>
                    <span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Harmonize brick: Aborted. Please check your &quot;</span>
                        <span class="s2">&quot;input parameters ...&quot;</span>
                    <span class="p">)</span>
                    <span class="k">return</span>

            <span class="n">file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span>
                <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="o">+</span> <span class="n">fileName</span>
                    <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="o">+</span> <span class="s2">&quot;.&quot;</span>
                    <span class="o">+</span> <span class="n">in_ext</span>
                <span class="p">),</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">file</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;out_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">file</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s2">&quot;- Harmonize brick: There was no output file deducted &quot;</span>
                    <span class="s2">&quot;during initialization. Please check the input &quot;</span>
                    <span class="s2">&quot;parameters...!&quot;</span>
                <span class="p">)</span>

            <span class="c1"># tags inheritance (optional)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;out_file&quot;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">inheritance_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;out_file&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_file</span>

        <span class="c1"># Return the requirement, outputs and inheritance_dict</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_initResult</span><span class="p">()</span></div>

<div class="viewcode-block" id="Harmonize.run_process_mia"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.others.html#mia_processes.bricks.preprocess.others.processing.Harmonize.run_process_mia">[docs]</a>    <span class="k">def</span> <span class="nf">run_process_mia</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the process launch step of the brick.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Harmonize</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">run_process_mia</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_file</span><span class="p">)</span>
            <span class="n">wm_img</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wm_mask</span><span class="p">)</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">()</span>
        <span class="k">except</span> <span class="p">(</span>
            <span class="n">nib</span><span class="o">.</span><span class="n">filebasedimages</span><span class="o">.</span><span class="n">ImageFileError</span><span class="p">,</span>
            <span class="ne">FileNotFoundError</span><span class="p">,</span>
            <span class="ne">TypeError</span><span class="p">,</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Harmonize brick: Error with file to enhance, during the &quot;</span>
                <span class="s2">&quot;run: &quot;</span><span class="p">,</span>
                <span class="n">e</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">img</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">wm_img</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">img</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">wm_img</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">wm_img</span><span class="p">[</span><span class="n">wm_img</span> <span class="o">&lt;</span> <span class="mf">0.9</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">wm_img</span><span class="p">[</span><span class="n">wm_img</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">wm_mask</span> <span class="o">=</span> <span class="n">wm_img</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">erodemask</span><span class="p">:</span>
                <span class="c1"># Create a structural element to be used</span>
                <span class="c1"># in an opening operation.</span>
                <span class="n">struc</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">generate_binary_structure</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
                <span class="c1"># Perform an opening operation on the background data.</span>
                <span class="n">wm_mask</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">binary_erosion</span><span class="p">(</span><span class="n">wm_mask</span><span class="p">,</span> <span class="n">structure</span><span class="o">=</span><span class="n">struc</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">uint8</span>
                <span class="p">)</span>

            <span class="n">data</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">()</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1000.0</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">wm_mask</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]))</span>

            <span class="n">out_img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">img</span><span class="o">.</span><span class="n">affine</span><span class="p">,</span> <span class="n">img</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>

            <span class="c1"># Image save</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_file</span><span class="p">)</span>
            <span class="n">file_name_no_ext</span><span class="p">,</span> <span class="n">file_extension</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">file_extension</span> <span class="o">==</span> <span class="s2">&quot;.gz&quot;</span><span class="p">:</span>
                <span class="p">(</span><span class="n">file_name_no_ext_2</span><span class="p">,</span> <span class="n">file_extension_2</span><span class="p">)</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span>
                    <span class="n">file_name_no_ext</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">file_extension_2</span> <span class="o">==</span> <span class="s2">&quot;.nii&quot;</span><span class="p">:</span>
                    <span class="n">file_name_no_ext</span> <span class="o">=</span> <span class="n">file_name_no_ext_2</span>
                    <span class="n">file_extension</span> <span class="o">=</span> <span class="s2">&quot;.nii.gz&quot;</span>

            <span class="n">file_out</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span>
                <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="o">+</span> <span class="n">file_name_no_ext</span>
                    <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="o">+</span> <span class="n">file_extension</span>
                <span class="p">),</span>
            <span class="p">)</span>
            <span class="n">nib</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">out_img</span><span class="p">,</span> <span class="n">file_out</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="IntensityClip"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.others.html#mia_processes.bricks.preprocess.others.processing.IntensityClip">[docs]</a><span class="k">class</span> <span class="nc">IntensityClip</span><span class="p">(</span><span class="n">ProcessMIA</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    * Clip the intensity range as prescribed by the percentiles.</span>

<span class="sd">    Please, see the complete documentation for the `Threshold brick in</span>
<span class="sd">    the populse.mia_processes website</span>
<span class="sd">    https://populse.github.io/mia_processes/html/documentation/bricks/preprocess/other/IntensityClip.html</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="IntensityClip.__init__"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.others.html#mia_processes.bricks.preprocess.others.processing.IntensityClip.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the attributes initialisation / instantiation.</span>

<span class="sd">        The input and output plugs are defined here. The special</span>
<span class="sd">        &#39;self.requirement&#39; attribute (optional) is used to define the</span>
<span class="sd">        third-party products necessary for the running of the brick.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Initialisation of the objects needed for the launch of the brick</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">IntensityClip</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1"># Third party softwares required for the execution of the brick</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requirement</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Inputs description</span>
        <span class="n">in_file_desc</span> <span class="o">=</span> <span class="s2">&quot;3D file which intensity will be clipped&quot;</span>
        <span class="n">p_min_desc</span> <span class="o">=</span> <span class="s2">&quot;Percentile for the lower bound&quot;</span>
        <span class="n">p_max_desc</span> <span class="o">=</span> <span class="s2">&quot;Percentile for the upper bound&quot;</span>
        <span class="n">dtype_desc</span> <span class="o">=</span> <span class="s2">&quot;Output datatype&quot;</span>
        <span class="n">nonnegative_desc</span> <span class="o">=</span> <span class="s2">&quot;Whether input intensities must be positive&quot;</span>
        <span class="n">invert_desc</span> <span class="o">=</span> <span class="s2">&quot;Finalize by inverting contrast&quot;</span>

        <span class="c1"># Outputs description</span>
        <span class="n">out_file_desc</span> <span class="o">=</span> <span class="s2">&quot;File after clipping&quot;</span>

        <span class="c1"># Mandatory inputs traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;in_file&quot;</span><span class="p">,</span> <span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">in_file_desc</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Optional inputs with default value traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;dtype&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">Enum</span><span class="p">(</span>
                <span class="s2">&quot;int16&quot;</span><span class="p">,</span>
                <span class="s2">&quot;float32&quot;</span><span class="p">,</span>
                <span class="s2">&quot;uint8&quot;</span><span class="p">,</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">dtype_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;invert&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">Bool</span><span class="p">(</span>
                <span class="n">default_value</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">invert_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;nonnegative&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">Bool</span><span class="p">(</span>
                <span class="n">default_value</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">nonnegative_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;p_max&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">Float</span><span class="p">(</span>
                <span class="n">default_value</span><span class="o">=</span><span class="mf">99.9</span><span class="p">,</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">p_max_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;p_min&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">Float</span><span class="p">(</span>
                <span class="n">default_value</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">p_min_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># Outputs traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;out_file&quot;</span><span class="p">,</span> <span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">out_file_desc</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">init_default_traits</span><span class="p">()</span></div>

<div class="viewcode-block" id="IntensityClip.list_outputs"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.others.html#mia_processes.bricks.preprocess.others.processing.IntensityClip.list_outputs">[docs]</a>    <span class="k">def</span> <span class="nf">list_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_plugged</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the initialisation step of the brick.</span>

<span class="sd">        The main objective of this method is to produce the outputs of the</span>
<span class="sd">        bricks (self.outputs) and the associated tags (self.inheritance_dic),</span>
<span class="sd">        if defined here. To work properly this method must return</span>
<span class="sd">        self.make_initResult() object.</span>

<span class="sd">        :param is_plugged: the state, linked or not, of the plugs.</span>
<span class="sd">        :returns: a dictionary with requirement, outputs and inheritance_dict.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Using the inheritance to ProcessMIA class, list_outputs method</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">IntensityClip</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">list_outputs</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_file</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;out_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_file</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                        <span class="s2">&quot;.nii&quot;</span><span class="p">,</span> <span class="s2">&quot;_clipped.nii&quot;</span>
                    <span class="p">),</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s2">&quot;IntensityClip brick: No output_directory was &quot;</span>
                    <span class="s2">&quot;found...!</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="k">return</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inheritance_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;out_file&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_file</span>

        <span class="c1"># Return the requirement, outputs and inheritance_dict</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_initResult</span><span class="p">()</span></div>

<div class="viewcode-block" id="IntensityClip.run_process_mia"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.others.html#mia_processes.bricks.preprocess.others.processing.IntensityClip.run_process_mia">[docs]</a>    <span class="k">def</span> <span class="nf">run_process_mia</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the process launch step of the brick.&quot;&quot;&quot;</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">IntensityClip</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">run_process_mia</span><span class="p">()</span>

        <span class="n">in_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_file</span>
        <span class="n">out_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">out_file</span>
        <span class="n">nonnegative</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nonnegative</span>
        <span class="n">p_min</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_min</span>
        <span class="n">p_max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p_max</span>
        <span class="n">invert</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">invert</span>
        <span class="n">dtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span>

        <span class="c1"># Load data</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">squeeze_image</span><span class="p">(</span><span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">in_file</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&lt;</span><span class="si">{</span><span class="n">in_file</span><span class="si">}</span><span class="s2">&gt; is not a 3D file.&quot;</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float32&quot;</span><span class="p">)</span>

        <span class="c1"># Calculate stats on denoised version, to preempt outliers from biasing</span>
        <span class="n">denoised</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">median_filter</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">footprint</span><span class="o">=</span><span class="n">ball</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>

        <span class="n">a_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span>
            <span class="n">denoised</span><span class="p">[</span><span class="n">denoised</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">nonnegative</span> <span class="k">else</span> <span class="n">denoised</span><span class="p">,</span> <span class="n">p_min</span>
        <span class="p">)</span>
        <span class="n">a_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span>
            <span class="n">denoised</span><span class="p">[</span><span class="n">denoised</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">nonnegative</span> <span class="k">else</span> <span class="n">denoised</span><span class="p">,</span> <span class="n">p_max</span>
        <span class="p">)</span>

        <span class="c1"># Clip and cast</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">a_min</span><span class="o">=</span><span class="n">a_min</span><span class="p">,</span> <span class="n">a_max</span><span class="o">=</span><span class="n">a_max</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">-=</span> <span class="n">data</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">/=</span> <span class="n">data</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">invert</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">data</span>

        <span class="k">if</span> <span class="n">dtype</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;uint8&quot;</span><span class="p">,</span> <span class="s2">&quot;int16&quot;</span><span class="p">):</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">255</span> <span class="o">*</span> <span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>

        <span class="n">hdr</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">hdr</span><span class="o">.</span><span class="n">set_data_dtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>
        <span class="n">img</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">img</span><span class="o">.</span><span class="n">affine</span><span class="p">,</span> <span class="n">hdr</span><span class="p">)</span><span class="o">.</span><span class="n">to_filename</span><span class="p">(</span><span class="n">out_file</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="Mask"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.others.html#mia_processes.bricks.preprocess.others.processing.Mask">[docs]</a><span class="k">class</span> <span class="nc">Mask</span><span class="p">(</span><span class="n">ProcessMIA</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    * Mask image.</span>

<span class="sd">    Please, see the complete documentation for the `Mask&#39; brick</span>
<span class="sd">    in the populse.mia_processes website</span>
<span class="sd">    https://populse.github.io/mia_processes/html/documentation/bricks/preprocess/other/Mask.html</span>

<span class="sd">    adapted from:</span>
<span class="sd">    https://github.com/nipreps/niworkflows/blob/45ab13e1bf6fdbf5e29c90cef44055b0b9cf391b/niworkflows/interfaces/norm.py#L474</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Mask.__init__"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.others.html#mia_processes.bricks.preprocess.others.processing.Mask.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the attributes initialisation / instantiation.</span>

<span class="sd">        The input and output plugs are defined here. The special</span>
<span class="sd">        &#39;self.requirement&#39; attribute (optional) is used to define the</span>
<span class="sd">        third-party products necessary for the running of the brick.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Initialisation of the objects needed for the launch of the brick</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Mask</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1"># Third party softwares required for the execution of the brick</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requirement</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Inputs description</span>
        <span class="n">in_file_desc</span> <span class="o">=</span> <span class="s2">&quot;An existing path file.&quot;</span>
        <span class="n">mask_file_desc</span> <span class="o">=</span> <span class="s2">&quot;An existing path file.&quot;</span>
        <span class="n">prefix_desc</span> <span class="o">=</span> <span class="s2">&quot;Prefix of the output image (a string).&quot;</span>
        <span class="n">suffix_desc</span> <span class="o">=</span> <span class="s2">&quot;Suffix of the output image (a string).&quot;</span>

        <span class="c1"># Outputs description</span>
        <span class="n">out_file_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Path of the scan after masking &quot;</span>
            <span class="s2">&quot;(a pathlike object or string representing a file).&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Inputs traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;in_file&quot;</span><span class="p">,</span> <span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">in_file_desc</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;mask_file&quot;</span><span class="p">,</span>
            <span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">mask_file_desc</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;prefix&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">prefix_desc</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;suffix&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">String</span><span class="p">(</span>
                <span class="s2">&quot;_masked&quot;</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">suffix_desc</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># Outputs traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;out_file&quot;</span><span class="p">,</span> <span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">out_file_desc</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">init_default_traits</span><span class="p">()</span></div>

<div class="viewcode-block" id="Mask.list_outputs"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.others.html#mia_processes.bricks.preprocess.others.processing.Mask.list_outputs">[docs]</a>    <span class="k">def</span> <span class="nf">list_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_plugged</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the initialisation step of the brick.</span>

<span class="sd">        The main objective of this method is to produce the outputs of the</span>
<span class="sd">        bricks (self.outputs) and the associated tags (self.inheritance_dic),</span>
<span class="sd">        if defined here. To work properly this method must return</span>
<span class="sd">        self.make_initResult() object.</span>

<span class="sd">        :param is_plugged: the state, linked or not, of the plugs.</span>
<span class="sd">        :returns: a dictionary with requirement, outputs and inheritance_dict.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Using the inheritance to ProcessMIA class, list_outputs method</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Mask</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">list_outputs</span><span class="p">()</span>

        <span class="c1"># Outputs definition</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_file</span><span class="p">:</span>
            <span class="n">valid_ext</span><span class="p">,</span> <span class="n">in_ext</span><span class="p">,</span> <span class="n">fileName</span> <span class="o">=</span> <span class="n">checkFileExt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_file</span><span class="p">,</span> <span class="n">EXT</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_ext</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Mask brick: The input image format is not &quot;</span>
                    <span class="s2">&quot;recognized...!&quot;</span>
                <span class="p">)</span>
                <span class="k">return</span>

            <span class="k">if</span> <span class="p">(</span>
                <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span><span class="p">)</span>
                <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">isspace</span><span class="p">())</span>
                <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span> <span class="ow">in</span> <span class="p">[</span><span class="n">Undefined</span><span class="p">,</span> <span class="s2">&quot;&lt;undefined&gt;&quot;</span><span class="p">]</span>
            <span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span>

            <span class="k">if</span> <span class="p">(</span>
                <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="p">)</span>
                <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="o">.</span><span class="n">isspace</span><span class="p">())</span>
                <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span> <span class="ow">in</span> <span class="p">[</span><span class="n">Undefined</span><span class="p">,</span> <span class="s2">&quot;&lt;undefined&gt;&quot;</span><span class="p">])</span>
            <span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span>

            <span class="n">path</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_file</span><span class="p">)</span>

            <span class="k">if</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span> <span class="o">==</span> <span class="s2">&quot; &quot;</span>
                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span> <span class="o">==</span> <span class="s2">&quot; &quot;</span>
                <span class="ow">and</span> <span class="n">path</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span>
            <span class="p">):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="n">QMessageBox</span><span class="p">()</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">setIcon</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Warning</span><span class="p">)</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="s2">&quot;mia_processes - &quot;</span> <span class="s2">&quot;Mask brick Warning!&quot;</span><span class="p">)</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span>
                    <span class="s2">&quot;Suffix and prefix input parameters are not &quot;</span>
                    <span class="s2">&quot;defined or consist only of one or more white &quot;</span>
                    <span class="s2">&quot;spaces.</span><span class="se">\n</span><span class="s2">The </span><span class="si">{0}</span><span class="s2"> input parameter will be &quot;</span>
                    <span class="s2">&quot;overwritten ...</span><span class="se">\n</span><span class="s2"> Yes or &quot;</span>
                    <span class="s2">&quot;Abort?&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">setStandardButtons</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Yes</span> <span class="o">|</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">Abort</span><span class="p">)</span>
                <span class="n">retval</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">exec_</span><span class="p">()</span>

                <span class="k">if</span> <span class="n">retval</span> <span class="o">!=</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">Abort</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Mask brick warning: the out_file output &quot;</span>
                        <span class="s2">&quot;parameter is the same as the in_files input &quot;</span>
                        <span class="s2">&quot;parameter (suffix and prefix are not defined):&quot;</span>
                        <span class="s2">&quot;</span><span class="se">\n</span><span class="si">{0}</span><span class="s2"> will be overwrited ...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>
                    <span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Mask brick: Aborted. Please check your input &quot;</span>
                        <span class="s2">&quot;parameters ...&quot;</span>
                    <span class="p">)</span>
                    <span class="k">return</span>

            <span class="n">file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span>
                <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="o">+</span> <span class="n">fileName</span>
                    <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="o">+</span> <span class="s2">&quot;.&quot;</span>
                    <span class="o">+</span> <span class="n">in_ext</span>
                <span class="p">),</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">file</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;out_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">file</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s2">&quot;- Mask brick: There was no output file deducted during &quot;</span>
                    <span class="s2">&quot;initialization. Please check the input parameters...!&quot;</span>
                <span class="p">)</span>

        <span class="c1"># tags inheritance (optional)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;out_file&quot;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inheritance_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;out_file&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_file</span>

        <span class="c1"># Return the requirement, outputs and inheritance_dict</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_initResult</span><span class="p">()</span></div>

<div class="viewcode-block" id="Mask.run_process_mia"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.others.html#mia_processes.bricks.preprocess.others.processing.Mask.run_process_mia">[docs]</a>    <span class="k">def</span> <span class="nf">run_process_mia</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the process launch step of the brick.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Mask</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">run_process_mia</span><span class="p">()</span>

        <span class="n">file_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_file</span>
        <span class="n">mask_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask_file</span>

        <span class="c1"># Image processing</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
            <span class="n">mask_img</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">mask_name</span><span class="p">)</span>

        <span class="k">except</span> <span class="p">(</span>
            <span class="n">nib</span><span class="o">.</span><span class="n">filebasedimages</span><span class="o">.</span><span class="n">ImageFileError</span><span class="p">,</span>
            <span class="ne">FileNotFoundError</span><span class="p">,</span>
            <span class="ne">TypeError</span><span class="p">,</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Mask brick: Error with files to mask, during &quot;</span> <span class="s2">&quot;the run: &quot;</span><span class="p">,</span>
                <span class="n">e</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">img</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">img</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">mask_img</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">()</span>
            <span class="n">data</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">asanyarray</span><span class="p">(</span><span class="n">mask_img</span><span class="o">.</span><span class="n">dataobj</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="n">maskimg</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">img</span><span class="o">.</span><span class="n">affine</span><span class="p">,</span> <span class="n">img</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>

            <span class="c1"># Image save</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
            <span class="n">file_name_no_ext</span><span class="p">,</span> <span class="n">file_extension</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">file_extension</span> <span class="o">==</span> <span class="s2">&quot;.gz&quot;</span><span class="p">:</span>
                <span class="p">(</span><span class="n">file_name_no_ext_2</span><span class="p">,</span> <span class="n">file_extension_2</span><span class="p">)</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span>
                    <span class="n">file_name_no_ext</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">file_extension_2</span> <span class="o">==</span> <span class="s2">&quot;.nii&quot;</span><span class="p">:</span>
                    <span class="n">file_name_no_ext</span> <span class="o">=</span> <span class="n">file_name_no_ext_2</span>
                    <span class="n">file_extension</span> <span class="o">=</span> <span class="s2">&quot;.nii.gz&quot;</span>

            <span class="n">file_out</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span>
                <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="o">+</span> <span class="n">file_name_no_ext</span>
                    <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="o">+</span> <span class="n">file_extension</span>
                <span class="p">),</span>
            <span class="p">)</span>
            <span class="n">nib</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">maskimg</span><span class="p">,</span> <span class="n">file_out</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="NonSteadyStateDetector"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.others.html#mia_processes.bricks.preprocess.others.processing.NonSteadyStateDetector">[docs]</a><span class="k">class</span> <span class="nc">NonSteadyStateDetector</span><span class="p">(</span><span class="n">ProcessMIA</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    * Detect non-steady-state at the beginning of a bold 4D image.</span>

<span class="sd">    Please, see the complete documentation for the</span>
<span class="sd">    `NonSteadyStateDetector` brick in the populse.mia_processes website</span>
<span class="sd">    https://populse.github.io/mia_processes/html/documentation/bricks/preprocess/other/NonSteadyStateDetector.html</span>

<span class="sd">    adapted from:</span>
<span class="sd">    https://github.com/nipy/nipype/blob/f662acfce8def4717e0c3414618f3a5de5913b31/nipype/algorithms/confounds.py#L974</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="NonSteadyStateDetector.__init__"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.others.html#mia_processes.bricks.preprocess.others.processing.NonSteadyStateDetector.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the attributes initialisation / instantiation.</span>

<span class="sd">        The input and output plugs are defined here. The special</span>
<span class="sd">        &#39;self.requirement&#39; attribute (optional) is used to define the</span>
<span class="sd">        third-party products necessary for the running of the brick.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Initialisation of the objects needed for the launch of the brick</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">NonSteadyStateDetector</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1"># Third party softwares required for the execution of the brick</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requirement</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Inputs description</span>
        <span class="n">in_file_desc</span> <span class="o">=</span> <span class="s2">&quot;An existing path file.&quot;</span>

        <span class="c1"># Outputs description</span>
        <span class="n">n_volumes_to_discard_desc</span> <span class="o">=</span> <span class="s2">&quot;Number of non steady&quot;</span> <span class="s2">&quot;state volumes&quot;</span>

        <span class="c1"># Inputs traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;in_file&quot;</span><span class="p">,</span> <span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">in_file_desc</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Outputs traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;n_volumes_to_discard&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">Int</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">n_volumes_to_discard_desc</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">init_default_traits</span><span class="p">()</span></div>

<div class="viewcode-block" id="NonSteadyStateDetector.list_outputs"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.others.html#mia_processes.bricks.preprocess.others.processing.NonSteadyStateDetector.list_outputs">[docs]</a>    <span class="k">def</span> <span class="nf">list_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_plugged</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the initialisation step of the brick.</span>

<span class="sd">        The main objective of this method is to produce the outputs of the</span>
<span class="sd">        bricks (self.outputs) and the associated tags (self.inheritance_dic),</span>
<span class="sd">        if defined here. To work properly this method must return</span>
<span class="sd">        self.make_initResult() object.</span>

<span class="sd">        :param is_plugged: the state, linked or not, of the plugs.</span>
<span class="sd">        :returns: a dictionary with requirement, outputs and inheritance_dict.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Using the inheritance to ProcessMIA class, list_outputs method</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">NonSteadyStateDetector</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">list_outputs</span><span class="p">()</span>

        <span class="c1"># Outputs definition</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_file</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;n_volumes_to_discard&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Return the requirement, outputs and inheritance_dict</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_initResult</span><span class="p">()</span></div>

<div class="viewcode-block" id="NonSteadyStateDetector.run_process_mia"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.others.html#mia_processes.bricks.preprocess.others.processing.NonSteadyStateDetector.run_process_mia">[docs]</a>    <span class="k">def</span> <span class="nf">run_process_mia</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the process launch step of the brick.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">NonSteadyStateDetector</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">run_process_mia</span><span class="p">()</span>

        <span class="n">file_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_file</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">in_nii</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span>
            <span class="n">nib</span><span class="o">.</span><span class="n">filebasedimages</span><span class="o">.</span><span class="n">ImageFileError</span><span class="p">,</span>
            <span class="ne">FileNotFoundError</span><span class="p">,</span>
            <span class="ne">TypeError</span><span class="p">,</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">NonSteadyStateDetector brick: Error with file to enhance, &quot;</span>
                <span class="s2">&quot;during the run: &quot;</span><span class="p">,</span>
                <span class="n">e</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">in_nii</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">in_nii</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">global_signal</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">in_nii</span><span class="o">.</span><span class="n">dataobj</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="p">:</span><span class="mi">50</span><span class="p">]</span>
                <span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">n_volumes_to_discard</span> <span class="o">=</span> <span class="n">is_outlier</span><span class="p">(</span><span class="n">global_signal</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="Resample1"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.others.html#mia_processes.bricks.preprocess.others.processing.Resample1">[docs]</a><span class="k">class</span> <span class="nc">Resample1</span><span class="p">(</span><span class="n">ProcessMIA</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    *Resamples an image to the resolution of a reference image*</span>

<span class="sd">    - Uses nibabel.processing.resample_from_to().</span>

<span class="sd">    Please, see the complete documentation for the</span>
<span class="sd">    `Resample1` brick in the populse.mia_processes website</span>
<span class="sd">    https://populse.github.io/mia_processes/html/documentation/bricks/preprocess/other/Resample1.html</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Resample1.__init__"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.others.html#mia_processes.bricks.preprocess.others.processing.Resample1.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the attributes initialisation / instantiation.</span>

<span class="sd">        The input and output plugs are defined here. The special</span>
<span class="sd">        &#39;self.requirement&#39; attribute (optional) is used to define the</span>
<span class="sd">        third-party products necessary for the running of the brick.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Initialisation of the objects needed for the launch of the brick</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Resample1</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1"># Third party softwares required for the execution of the brick</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requirement</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Inputs description</span>
        <span class="n">files_to_resample_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;The 3D images that will be resampled (a &quot;</span>
            <span class="s2">&quot;list of pathlike object or string &quot;</span>
            <span class="s2">&quot;representing a file or a list of items &quot;</span>
            <span class="s2">&quot;which are a pathlike object or string &quot;</span>
            <span class="s2">&quot;representing a file, valid extensions: &quot;</span>
            <span class="s2">&quot;[.img, .nii, .hdr]).&quot;</span>
        <span class="p">)</span>
        <span class="n">reference_image_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;A 3D or 4D image used as reference to &quot;</span>
            <span class="s2">&quot;resample the files_to_resample images (a &quot;</span>
            <span class="s2">&quot;pathlike object or string representing a file &quot;</span>
            <span class="s2">&quot;with extension in [.img, .nii, .hdr]).&quot;</span>
        <span class="p">)</span>
        <span class="n">interp_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;The order of the spline interpolation (an integer &quot;</span>
            <span class="s2">&quot;between 0 and 5; trilinear == 3).&quot;</span>
        <span class="p">)</span>
        <span class="n">prefix_desc</span> <span class="o">=</span> <span class="s2">&quot;The prefix for the out_files image (a string).&quot;</span>
        <span class="n">suffix_to_delete_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;The suffix to delete from the &quot;</span>
            <span class="s2">&quot;files_to_resample, when creating the &quot;</span>
            <span class="s2">&quot;out_files (a string).&quot;</span>
        <span class="p">)</span>
        <span class="n">suffix_desc</span> <span class="o">=</span> <span class="s2">&quot;The suffix for the out_files image (a string).&quot;</span>

        <span class="c1"># Outputs description</span>
        <span class="n">out_files_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;The resulting images after resampling (a pathlike &quot;</span>
            <span class="s2">&quot;object or string representing a file, or a list of &quot;</span>
            <span class="s2">&quot;pathlike objects or strings representing a file).&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Inputs traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;files_to_resample&quot;</span><span class="p">,</span>
            <span class="n">InputMultiPath</span><span class="p">(</span>
                <span class="n">ImageFileSPM</span><span class="p">(),</span> <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">files_to_resample_desc</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;reference_image&quot;</span><span class="p">,</span>
            <span class="n">ImageFileSPM</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">reference_image_desc</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;interp&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">Range</span><span class="p">(</span>
                <span class="n">value</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                <span class="n">low</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">high</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">interp_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;prefix&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">prefix_desc</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;suffix_to_delete&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">String</span><span class="p">(</span>
                <span class="s2">&quot;_002&quot;</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">suffix_to_delete_desc</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;suffix&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">String</span><span class="p">(</span>
                <span class="s2">&quot;_003&quot;</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">suffix_desc</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># Outputs traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;out_files&quot;</span><span class="p">,</span>
            <span class="n">OutputMultiPath</span><span class="p">(</span><span class="n">File</span><span class="p">(),</span> <span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">out_files_desc</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">init_default_traits</span><span class="p">()</span></div>

<div class="viewcode-block" id="Resample1.list_outputs"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.others.html#mia_processes.bricks.preprocess.others.processing.Resample1.list_outputs">[docs]</a>    <span class="k">def</span> <span class="nf">list_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_plugged</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the initialisation step of the brick.</span>

<span class="sd">        The main objective of this method is to produce the outputs of the</span>
<span class="sd">        bricks (self.outputs) and the associated tags (self.inheritance_dic),</span>
<span class="sd">        if defined here. To work properly this method must return</span>
<span class="sd">        self.make_initResult() object.</span>

<span class="sd">        :param is_plugged: the state, linked or not, of the plugs.</span>
<span class="sd">        :returns: a dictionary with requirement, outputs and inheritance_dict.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Using the inheritance to ProcessMIA class, list_outputs method</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Resample1</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">list_outputs</span><span class="p">()</span>

        <span class="c1"># Outputs definition</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reference_image</span> <span class="o">!=</span> <span class="n">Undefined</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">files_to_resample</span> <span class="o">!=</span> <span class="n">Undefined</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">interp</span> <span class="o">!=</span> <span class="n">Undefined</span>
        <span class="p">):</span>
            <span class="n">files</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">files_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">files_to_resample</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">refName</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reference_image</span><span class="p">)</span>

            <span class="k">except</span> <span class="p">(</span>
                <span class="n">nib</span><span class="o">.</span><span class="n">filebasedimages</span><span class="o">.</span><span class="n">ImageFileError</span><span class="p">,</span>
                <span class="ne">FileNotFoundError</span><span class="p">,</span>
                <span class="ne">TypeError</span><span class="p">,</span>
            <span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Resample1 brick: Error with reference_image, during &quot;</span>
                    <span class="s2">&quot;initialisation: &quot;</span><span class="p">,</span>
                    <span class="n">e</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">refName</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="p">(</span>
                <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">suffix_to_delete</span><span class="p">)</span>
                <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">suffix_to_delete</span><span class="o">.</span><span class="n">isspace</span><span class="p">())</span>
                <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">suffix_to_delete</span> <span class="ow">in</span> <span class="p">[</span><span class="n">Undefined</span><span class="p">,</span> <span class="s2">&quot;&lt;undefined&gt;&quot;</span><span class="p">])</span>
            <span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">suffix_to_delete</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span>

            <span class="k">if</span> <span class="p">(</span>
                <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span><span class="p">)</span>
                <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">isspace</span><span class="p">())</span>
                <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">suffix</span> <span class="ow">in</span> <span class="p">[</span><span class="n">Undefined</span><span class="p">,</span> <span class="s2">&quot;&lt;undefined&gt;&quot;</span><span class="p">])</span>
            <span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span>

            <span class="k">if</span> <span class="p">(</span>
                <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="p">)</span>
                <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="o">.</span><span class="n">isspace</span><span class="p">())</span>
                <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span> <span class="ow">in</span> <span class="p">[</span><span class="n">Undefined</span><span class="p">,</span> <span class="s2">&quot;&lt;undefined&gt;&quot;</span><span class="p">])</span>
            <span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span>

            <span class="k">for</span> <span class="n">file_name</span> <span class="ow">in</span> <span class="n">files_name</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">fileName</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>

                <span class="k">except</span> <span class="p">(</span>
                    <span class="n">nib</span><span class="o">.</span><span class="n">filebasedimages</span><span class="o">.</span><span class="n">ImageFileError</span><span class="p">,</span>
                    <span class="ne">FileNotFoundError</span><span class="p">,</span>
                    <span class="ne">TypeError</span><span class="p">,</span>
                <span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Resample1 brick: Error with files_to_resample, &quot;</span>
                        <span class="s2">&quot;during initialisation: &quot;</span><span class="p">,</span>
                        <span class="n">e</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">fileName</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">refName</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">fileName</span><span class="p">):</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fileName</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span>
                        <span class="mi">3</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">refName</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">4</span>
                    <span class="p">):</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="n">QMessageBox</span><span class="p">()</span>
                        <span class="n">msg</span><span class="o">.</span><span class="n">setIcon</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Warning</span><span class="p">)</span>
                        <span class="n">msg</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span>
                            <span class="s2">&quot;mia_processes - Resample1 brick Warning!&quot;</span>
                        <span class="p">)</span>
                        <span class="n">msg</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span>
                            <span class="s2">&quot;Currently, the Resample1 brick only &quot;</span>
                            <span class="s2">&quot;allows to resample 3D images from 3D or &quot;</span>
                            <span class="s2">&quot;4D reference images.</span><span class="se">\n\n</span><span class="s2"> However the &quot;</span>
                            <span class="s2">&quot;&#39;</span><span class="si">{0}</span><span class="s2">&#39; reference image is a </span><span class="si">{1}</span><span class="s2">D and the &quot;</span>
                            <span class="s2">&quot;&#39;</span><span class="si">{2}</span><span class="s2">&#39; image is a </span><span class="si">{3}</span><span class="s2">D ...</span><span class="se">\n\n</span><span class="s2">Please, &quot;</span>
                            <span class="s2">&quot;modify your input and initialise again &quot;</span>
                            <span class="s2">&quot;this brick.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">reference_image</span><span class="p">,</span>
                                <span class="nb">len</span><span class="p">(</span><span class="n">refName</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span>
                                <span class="n">file_name</span><span class="p">,</span>
                                <span class="nb">len</span><span class="p">(</span><span class="n">fileName</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span>
                            <span class="p">)</span>
                        <span class="p">)</span>
                        <span class="n">msg</span><span class="o">.</span><span class="n">setStandardButtons</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Close</span><span class="p">)</span>
                        <span class="n">msg</span><span class="o">.</span><span class="n">buttonClicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
                        <span class="n">msg</span><span class="o">.</span><span class="n">exec</span><span class="p">()</span>
                        <span class="nb">print</span><span class="p">(</span>
                            <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Resample1 brick: Initialisation failed ... &quot;</span>
                            <span class="s2">&quot;Please check the input parameters!&quot;</span>
                        <span class="p">)</span>
                        <span class="n">files_name</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="k">break</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="n">QMessageBox</span><span class="p">()</span>
                    <span class="n">msg</span><span class="o">.</span><span class="n">setIcon</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Warning</span><span class="p">)</span>
                    <span class="n">msg</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span>
                        <span class="s2">&quot;mia_processes - Resample1 brick Warning!&quot;</span>
                    <span class="p">)</span>
                    <span class="n">msg</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span>
                        <span class="s2">&quot;files_to_resample &#39;</span><span class="si">{0}</span><span class="s2">&#39; or/and &quot;</span>
                        <span class="s2">&quot;reference_image &#39;</span><span class="si">{1}</span><span class="s2">&#39; is (are) empty ... Do &quot;</span>
                        <span class="s2">&quot;you want to continue? </span><span class="se">\n\n</span><span class="s2">&quot;</span>
                        <span class="s2">&quot;- To correct the input parameters &quot;</span>
                        <span class="s2">&quot;click &#39;Abort&#39;.</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                        <span class="s2">&quot;- If the Resample1 brick is located in a &quot;</span>
                        <span class="s2">&quot;pipeline, it may be usual that this(these) &quot;</span>
                        <span class="s2">&quot;parameter(s) is(are) empty at the &quot;</span>
                        <span class="s2">&quot;initialisation time. In this case, if the &quot;</span>
                        <span class="s2">&quot;files_to_resample and the reference_image &quot;</span>
                        <span class="s2">&quot;parameters correspond to a 3D image and a 3D &quot;</span>
                        <span class="s2">&quot;or a 4D, respectively, click &#39;Yes&#39;, &quot;</span>
                        <span class="s2">&quot;otherwise click &#39;Abort&#39; and change the input &quot;</span>
                        <span class="s2">&quot;parameters.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reference_image</span><span class="p">)</span>
                    <span class="p">)</span>
                    <span class="n">msg</span><span class="o">.</span><span class="n">setStandardButtons</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Yes</span> <span class="o">|</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">Abort</span><span class="p">)</span>
                    <span class="n">retval</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">exec_</span><span class="p">()</span>

                    <span class="k">if</span> <span class="n">retval</span> <span class="o">==</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">Yes</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span>
                            <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Resample1 brick Warning!: Empty input &quot;</span>
                            <span class="s2">&quot;file(s). No check of the dimensions of the &quot;</span>
                            <span class="s2">&quot;input images is done ... (files_to_resample &quot;</span>
                            <span class="s2">&quot;must be a 3D and reference_image must be a 3D &quot;</span>
                            <span class="s2">&quot;or a 4D) ...&quot;</span>
                        <span class="p">)</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span>
                            <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Resample1 brick: Initialisation failed ... &quot;</span>
                            <span class="s2">&quot;Please check the input parameters!&quot;</span>
                        <span class="p">)</span>
                        <span class="n">files_name</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="k">break</span>

                <span class="n">path</span><span class="p">,</span> <span class="n">file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
                <span class="n">file_name_no_ext</span><span class="p">,</span> <span class="n">file_extension</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>

                <span class="c1"># fmt: off</span>
                <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">suffix_to_delete</span> <span class="o">!=</span> <span class="s2">&quot; &quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span>
                    <span class="n">file_name_no_ext</span><span class="p">[</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">suffix_to_delete</span><span class="p">):]</span>
                    <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">suffix_to_delete</span>
                <span class="p">):</span>
                    <span class="n">file_name_no_ext</span> <span class="o">=</span> <span class="n">file_name_no_ext</span><span class="p">[</span>
                        <span class="p">:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">suffix_to_delete</span><span class="p">)</span>
                    <span class="p">]</span>

                <span class="c1"># fmt: on</span>
                <span class="n">files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span>
                        <span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                            <span class="o">+</span> <span class="n">file_name_no_ext</span>
                            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                            <span class="o">+</span> <span class="n">file_extension</span>
                        <span class="p">),</span>
                    <span class="p">)</span>
                <span class="p">)</span>

            <span class="c1"># May overwrite an input image with an output image</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">suffix</span> <span class="o">==</span> <span class="s2">&quot; &quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span> <span class="o">==</span> <span class="s2">&quot; &quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">files_name</span><span class="p">):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="n">QMessageBox</span><span class="p">()</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">setIcon</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Warning</span><span class="p">)</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="s2">&quot;mia_processes - Resample1 brick Warning!&quot;</span><span class="p">)</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span>
                    <span class="s2">&quot;Suffix and prefix input parameters are not &quot;</span>
                    <span class="s2">&quot;defined or consist only of one or more white &quot;</span>
                    <span class="s2">&quot;spaces.</span><span class="se">\n\n</span><span class="s2">The files_to_resample input parameter &quot;</span>
                    <span class="s2">&quot;(if suffix_to_delete input parameter is not set) &quot;</span>
                    <span class="s2">&quot;or other files (if suffix_to_delete input &quot;</span>
                    <span class="s2">&quot;parameter is set) could be overwritten ... this &quot;</span>
                    <span class="s2">&quot;concerns the following images:</span><span class="se">\n</span><span class="si">{}</span><span class="se">\n\n</span><span class="s2">Do you &quot;</span>
                    <span class="s2">&quot;agree to use these input &quot;</span>
                    <span class="s2">&quot;parameters?&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">files</span><span class="p">))</span>
                <span class="p">)</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">setStandardButtons</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Yes</span> <span class="o">|</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">Abort</span><span class="p">)</span>
                <span class="n">retval</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">exec_</span><span class="p">()</span>

                <span class="k">if</span> <span class="n">retval</span> <span class="o">==</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">Yes</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Resample1 brick warning: suffix and prefix input &quot;</span>
                        <span class="s2">&quot;parameters are not defined, the following files &quot;</span>
                        <span class="s2">&quot;could be overwrite!:</span><span class="se">\n</span><span class="si">{0}</span><span class="s2"> ...</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">files</span><span class="p">))</span>
                    <span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">files_name</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="c1"># Two (at least) input images give the same output image</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">files</span><span class="p">)))</span> <span class="ow">and</span> <span class="p">(</span><span class="n">files_name</span><span class="p">):</span>
                <span class="n">dupes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                <span class="n">seen</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
                        <span class="n">dupes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

                    <span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

                <span class="n">msg</span> <span class="o">=</span> <span class="n">QMessageBox</span><span class="p">()</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">setIcon</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Warning</span><span class="p">)</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="s2">&quot;mia_processes - Resample1 brick Warning!&quot;</span><span class="p">)</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span>
                    <span class="s2">&quot;The suffix, prefix and suffix_to_delete input &quot;</span>
                    <span class="s2">&quot;parameters combination seems to create for at &quot;</span>
                    <span class="s2">&quot;least two different input images the same output &quot;</span>
                    <span class="s2">&quot;image:</span><span class="se">\n</span><span class="si">{}</span><span class="se">\n\n</span><span class="s2">Please change the suffix, prefix &quot;</span>
                    <span class="s2">&quot;and suffix_to_delete input parameters combination &quot;</span>
                    <span class="s2">&quot;and initialise again this brick.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dupes</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">setStandardButtons</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Close</span><span class="p">)</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">buttonClicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">exec</span><span class="p">()</span>
                <span class="n">files_name</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="n">files_name</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;out_files&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">files</span>

        <span class="c1"># Tags inheritance (optional)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;out_files&quot;</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">in_val</span><span class="p">,</span> <span class="n">out_val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">files_name</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
                        <span class="n">_</span><span class="p">,</span> <span class="n">fileOval</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">out_val</span><span class="p">)</span>
                        <span class="n">fileOval_no_ext</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">fileOval</span><span class="p">)</span>

                        <span class="c1"># fmt: off</span>
                        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">suffix</span> <span class="o">!=</span> <span class="s2">&quot; &quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span>
                                <span class="n">fileOval_no_ext</span><span class="p">[</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span>
                                                <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span><span class="p">):]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span>
                        <span class="p">):</span>
                            <span class="n">fileOval_no_ext</span> <span class="o">=</span> <span class="n">fileOval_no_ext</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span><span class="p">)]</span>

                        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span> <span class="o">!=</span> <span class="s2">&quot; &quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span>
                                <span class="n">fileOval_no_ext</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="p">)]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span>
                        <span class="p">):</span>
                            <span class="n">fileOval_no_ext</span> <span class="o">=</span> <span class="n">fileOval_no_ext</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="p">):]</span>
                        <span class="c1"># fmt: on</span>
                        <span class="n">_</span><span class="p">,</span> <span class="n">fileIval</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">in_val</span><span class="p">)</span>
                        <span class="n">fileIval_no_ext</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">fileIval</span><span class="p">)</span>

                        <span class="c1"># fmt: off</span>
                        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">suffix_to_delete</span> <span class="o">!=</span> <span class="s2">&quot; &quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span>
                            <span class="n">fileIval_no_ext</span><span class="p">[</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">suffix_to_delete</span><span class="p">):]</span>
                            <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">suffix_to_delete</span>
                        <span class="p">):</span>
                            <span class="c1"># fmt: on</span>
                            <span class="n">fileOval_no_ext</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="n">fileOval_no_ext</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">suffix_to_delete</span>
                            <span class="p">)</span>

                        <span class="k">if</span> <span class="n">fileOval_no_ext</span> <span class="o">==</span> <span class="n">fileIval_no_ext</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">inheritance_dict</span><span class="p">[</span><span class="n">out_val</span><span class="p">]</span> <span class="o">=</span> <span class="n">in_val</span>
                            <span class="c1"># FIXME: In the latest version of mia, indexing of</span>
                            <span class="c1">#        the database with particular tags defined</span>
                            <span class="c1">#        in the processes is done only at the end</span>
                            <span class="c1">#        of the initialisation of the whole</span>
                            <span class="c1">#        pipeline. So we cannot use the value of</span>
                            <span class="c1">#        these tags in other processes of the</span>
                            <span class="c1">#        pipeline at the time of initialisation</span>
                            <span class="c1">#        (see populse_mia #290). Until better we</span>
                            <span class="c1">#        use a quick and dirty hack with the</span>
                            <span class="c1">#        set_dbFieldValue() function !</span>
                            <span class="n">tag_to_add</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;PatientName&quot;</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;field_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;string&quot;</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;visibility&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;origin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;user&quot;</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;unit&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;default_value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_dbFieldValue</span><span class="p">(</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="n">in_val</span><span class="p">,</span> <span class="s2">&quot;PatientName&quot;</span>
                            <span class="p">)</span>

                            <span class="k">if</span> <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="n">set_dbFieldValue</span><span class="p">(</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="n">out_val</span><span class="p">,</span> <span class="n">tag_to_add</span>
                                <span class="p">)</span>

                            <span class="k">else</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span>
                                    <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Resample1 brick:</span><span class="se">\n</span><span class="s2">The &#39;PatientName&#39; &quot;</span>
                                    <span class="s2">&quot;tag could not be added to the database &quot;</span>
                                    <span class="s2">&quot;for the &#39;</span><span class="si">{}</span><span class="s2">&#39; parameter. This can lead to &quot;</span>
                                    <span class="s2">&quot;a subsequent issue during &quot;</span>
                                    <span class="s2">&quot;initialization!!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">out_val</span><span class="p">)</span>
                                <span class="p">)</span>

        <span class="c1"># Return the requirement, outputs and inheritance_dict</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_initResult</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_check_interp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Checks the order of the splines interpolation.</span>

<span class="sd">        :returns: a message according to the selected order</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># skimage.transform.resize (does not seem to be the best solution for</span>
        <span class="c1"># resampling):</span>
        <span class="c1"># - B-splines of the order 0 and 1 correspond to nearest neighbour and</span>
        <span class="c1">#   linear interpolation, respectively.</span>
        <span class="c1"># - B-splines of a higher order can be defined by a repetitive</span>
        <span class="c1">#   convolution of the zeroth-order spline (the box function) with</span>
        <span class="c1">#   itself.</span>
        <span class="c1">#</span>
        <span class="c1"># nibabel.processing.resample_from_to (seems to be a good solution, but</span>
        <span class="c1"># can give non-zero intensity for the background -&gt; needs</span>
        <span class="c1"># thresolding ?)</span>
        <span class="c1">#</span>
        <span class="c1"># nilearn.image.resample_to_img (seems to be a good solution, no</span>
        <span class="c1"># non-zero intensity for the background observed)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interp</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># skimage and nibabel: Nearest neighbour</span>
            <span class="k">return</span> <span class="s2">&quot;spline interpolation of order 0 (Nearest-neighbour)&quot;</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">interp</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># skimage: It seems that with dimensions=3 and B-spline order=1,</span>
            <span class="c1">#          the interpolation would be equivalent to &quot;trilinear&quot;</span>
            <span class="c1"># return (&quot;Bi-linear (with dimensions=3, Bi-linear is equivalent &quot;</span>
            <span class="c1">#        &quot;to &#39;trilinear&#39;)&quot;)</span>

            <span class="c1"># nibabel: spline interpolation of order 1</span>
            <span class="k">return</span> <span class="s2">&quot;spline interpolation of order 1&quot;</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">interp</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="c1"># skimage:</span>
            <span class="c1"># return &quot;Bi-quadratic&quot;</span>

            <span class="c1"># nibabel: spline interpolation of order 2</span>
            <span class="k">return</span> <span class="s2">&quot;spline interpolation of order 2&quot;</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">interp</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="c1"># skimage</span>
            <span class="c1"># return &quot;Bi-cubic&quot;</span>

            <span class="c1"># nibabel: spline interpolation of order 3: trilinear</span>
            <span class="k">return</span> <span class="s2">&quot;spline interpolation of order 3 (trilinear)&quot;</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">interp</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="c1"># skimage</span>
            <span class="c1"># return &quot;Bi-quartic&quot;</span>

            <span class="c1"># nibabel: spline interpolation of order 4</span>
            <span class="k">return</span> <span class="s2">&quot;spline interpolation of order 4&quot;</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">interp</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
            <span class="c1"># skimage</span>
            <span class="c1"># return &quot;Bi-quintic&quot;</span>

            <span class="c1"># nibabel: spline interpolation of order 5</span>
            <span class="k">return</span> <span class="s2">&quot;spline interpolation of order 5&quot;</span>

<div class="viewcode-block" id="Resample1.run_process_mia"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.others.html#mia_processes.bricks.preprocess.others.processing.Resample1.run_process_mia">[docs]</a>    <span class="k">def</span> <span class="nf">run_process_mia</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the process launch step of the brick.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Resample1</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">run_process_mia</span><span class="p">()</span>
        <span class="n">files_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">files_to_resample</span>
        <span class="n">refName</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reference_image</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Resample1 process from mia_processes: </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_check_interp</span><span class="p">(),</span>
            <span class="s2">&quot; </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">for</span> <span class="n">file_name</span> <span class="ow">in</span> <span class="n">files_name</span><span class="p">:</span>
            <span class="n">fileName</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
            <span class="c1"># mask_data = mask.get_fdata()  # skimage</span>

            <span class="c1"># Currently, resampling is only done for 3D images using 3D</span>
            <span class="c1"># or 4D images for reference. It would be interesting to widen the</span>
            <span class="c1"># possibilities to more cases (at least a 4D using a 3D, and why</span>
            <span class="c1"># not, to larger dimensions?). Currently, we use</span>
            <span class="c1"># nibabel.processing.resample_from_to(), (see</span>
            <span class="c1"># https://mail.python.org/pipermail/neuroimaging/2019-January/001902.html).</span>
            <span class="c1"># It seems this method produces a little noise (can give non-zero</span>
            <span class="c1"># intensity for the background). In addition to the resolution</span>
            <span class="c1"># settings it seems the size of the reference_image are also</span>
            <span class="c1"># transferred to the resampled image but not the orientations and</span>
            <span class="c1"># positions (output space comes from the affine of</span>
            <span class="c1"># files_to_resample).</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fileName</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">refName</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="c1"># nibabel:</span>
                <span class="n">fileFinal</span> <span class="o">=</span> <span class="n">nibp</span><span class="o">.</span><span class="n">resample_from_to</span><span class="p">(</span>
                    <span class="n">fileName</span><span class="p">,</span> <span class="n">refName</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">interp</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fileName</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">refName</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                <span class="c1"># skimage</span>
                <span class="c1"># ref_size = ref_data.shape[:3]</span>
                <span class="c1"># resized_mask_data = resize(mask_data,</span>
                <span class="c1">#                           ref_size,</span>
                <span class="c1">#                           order=self.interp,</span>
                <span class="c1">#                           mode=&#39;reflect&#39;)</span>
                <span class="c1"># TODO: Taking info of mask&#39;s or ref&#39;s header?</span>
                <span class="c1"># mask_final = nib.Nifti1Image(resized_mask_data,</span>
                <span class="c1">#                             ref.affine,</span>
                <span class="c1">#                             ref.header)</span>

                <span class="c1"># nibabel:</span>
                <span class="n">fileFinal</span> <span class="o">=</span> <span class="n">nibp</span><span class="o">.</span><span class="n">resample_from_to</span><span class="p">(</span>
                    <span class="n">fileName</span><span class="p">,</span> <span class="n">refName</span><span class="o">.</span><span class="n">slicer</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">order</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">interp</span>
                <span class="p">)</span>

            <span class="c1"># Image save</span>
            <span class="n">path</span><span class="p">,</span> <span class="n">file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
            <span class="n">file_name_no_ext</span><span class="p">,</span> <span class="n">file_extension</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>

            <span class="c1"># fmt: off</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">suffix_to_delete</span> <span class="o">!=</span> <span class="s2">&quot; &quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span>
                <span class="n">file_name_no_ext</span><span class="p">[</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">suffix_to_delete</span><span class="p">):]</span>
                <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">suffix_to_delete</span>
            <span class="p">):</span>
                <span class="c1"># fmt: on</span>
                <span class="n">file_name_no_ext</span> <span class="o">=</span> <span class="n">file_name_no_ext</span><span class="p">[</span>
                    <span class="p">:</span> <span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">suffix_to_delete</span><span class="p">)</span>
                <span class="p">]</span>

            <span class="n">file_out</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span>
                <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="o">+</span> <span class="n">file_name_no_ext</span>
                    <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="o">+</span> <span class="n">file_extension</span>
                <span class="p">),</span>
            <span class="p">)</span>
            <span class="n">nib</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">fileFinal</span><span class="p">,</span> <span class="n">file_out</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="Resample2"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.others.html#mia_processes.bricks.preprocess.others.processing.Resample2">[docs]</a><span class="k">class</span> <span class="nc">Resample2</span><span class="p">(</span><span class="n">ProcessMIA</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    *Resamples images to the resolution of a reference image*</span>

<span class="sd">    - Uses skimage.transform.resize()</span>
<span class="sd">    - The output_directory/PatientName_data/ROI_data/convROI_BOLD2 directory is</span>
<span class="sd">      created to receive the resampled images. If this directory exists at</span>
<span class="sd">      runtime it is deleted.</span>
<span class="sd">    - To work correctly, the database entry for the reference_image parameter</span>
<span class="sd">      must have the &quot;PatientName&quot; tag filled in.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Resample2.__init__"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.others.html#mia_processes.bricks.preprocess.others.processing.Resample2.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the attributes initialisation/instantiation.</span>

<span class="sd">        The input and output plugs are defined here. The special</span>
<span class="sd">        &#39;self.requirement&#39; attribute (optional) is used to define the</span>
<span class="sd">        third-party products necessary for the running of the brick.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Resample2</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1"># Inputs description</span>
        <span class="n">files_to_resample_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;The images that will be resampled (a &quot;</span>
            <span class="s2">&quot;list of pathlike object or string &quot;</span>
            <span class="s2">&quot;representing a file or a list of items &quot;</span>
            <span class="s2">&quot;which are a pathlike object or string &quot;</span>
            <span class="s2">&quot;representing a file, valid extensions: &quot;</span>
            <span class="s2">&quot;[.img, .nii, .hdr]).&quot;</span>
        <span class="p">)</span>

        <span class="n">reference_image_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;The reference image for resampling (an &quot;</span>
            <span class="s2">&quot;existing, uncompressed file)&quot;</span>
        <span class="p">)</span>

        <span class="n">suffix_desc</span> <span class="o">=</span> <span class="s2">&quot;The suffix for the out_images (a string)&quot;</span>

        <span class="c1"># Outputs description</span>
        <span class="n">out_images_desc</span> <span class="o">=</span> <span class="s2">&quot;The resampled images&quot;</span>

        <span class="c1"># Inputs traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;files_to_resample&quot;</span><span class="p">,</span>
            <span class="n">InputMultiPath</span><span class="p">(</span>
                <span class="n">ImageFileSPM</span><span class="p">(),</span> <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">files_to_resample_desc</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;reference_image&quot;</span><span class="p">,</span>
            <span class="n">ImageFileSPM</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">reference_image_desc</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;suffix&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="s2">&quot;_2&quot;</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">suffix_desc</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># Outputs traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;out_images&quot;</span><span class="p">,</span>
            <span class="n">OutputMultiPath</span><span class="p">(</span><span class="n">File</span><span class="p">(),</span> <span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">out_images_desc</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># Special parameter used as a messenger for the run_process_mia method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;dict4runtime&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">Dict</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">userlevel</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">init_default_traits</span><span class="p">()</span></div>

<div class="viewcode-block" id="Resample2.list_outputs"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.others.html#mia_processes.bricks.preprocess.others.processing.Resample2.list_outputs">[docs]</a>    <span class="k">def</span> <span class="nf">list_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_plugged</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the initialisation step of the brick.</span>

<span class="sd">        The main objective of this method is to produce the outputs of the</span>
<span class="sd">        bricks (self.outputs) and the associated tags (self.inheritance_dic),</span>
<span class="sd">        if defined here. In order not to include an output in the database,</span>
<span class="sd">        this output must be a value of the optional key &#39;notInDb&#39; of the</span>
<span class="sd">        self.outputs dictionary. To work properly this method must return</span>
<span class="sd">        self.make_initResult() object.</span>

<span class="sd">        :param is_plugged: the state, linked or not, of the plugs.</span>
<span class="sd">        :returns: a dictionary with requirement, outputs and inheritance_dict.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Using the inheritance to ProcessMIA class, list_outputs method</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Resample2</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">list_outputs</span><span class="p">()</span>

        <span class="c1"># Outputs definition and tags inheritance (optional)</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">files_to_resample</span> <span class="o">!=</span> <span class="n">Undefined</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">reference_image</span> <span class="o">!=</span> <span class="n">Undefined</span>
        <span class="p">):</span>
            <span class="n">patient_name</span> <span class="o">=</span> <span class="n">get_dbFieldValue</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reference_image</span><span class="p">,</span> <span class="s2">&quot;PatientName&quot;</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">patient_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Resample2 brick:</span><span class="se">\n</span><span class="s2"> The PatientName tag is not filled &quot;</span>
                    <span class="s2">&quot;in the database for the </span><span class="si">{}</span><span class="s2"> file ...</span><span class="se">\n</span><span class="s2"> The calculation&quot;</span>
                    <span class="s2">&quot;is aborted...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reference_image</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_initResult</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">dict4runtime</span><span class="p">[</span><span class="s2">&quot;patient_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">patient_name</span>
            <span class="n">conv_dir2</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span>
                <span class="n">patient_name</span> <span class="o">+</span> <span class="s2">&quot;_data&quot;</span><span class="p">,</span>
                <span class="s2">&quot;ROI_data&quot;</span><span class="p">,</span>
                <span class="s2">&quot;convROI_BOLD2&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">list_out</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">roi_file</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">files_to_resample</span><span class="p">:</span>
                <span class="n">out_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">roi_file</span><span class="p">)</span>
                <span class="n">out_file_no_ext</span><span class="p">,</span> <span class="n">file_extension</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">out_file</span><span class="p">)</span>
                <span class="n">out_file</span> <span class="o">=</span> <span class="n">out_file_no_ext</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span> <span class="o">+</span> <span class="n">file_extension</span>
                <span class="n">out_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">conv_dir2</span><span class="p">,</span> <span class="n">out_file</span><span class="p">)</span>
                <span class="n">list_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">out_file</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;out_images&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">list_out</span>
            <span class="c1"># FIXME: What are we doing about the tags inheritance?</span>

        <span class="c1"># Return the requirement, outputs and inheritance_dict</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_initResult</span><span class="p">()</span></div>

<div class="viewcode-block" id="Resample2.run_process_mia"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.others.html#mia_processes.bricks.preprocess.others.processing.Resample2.run_process_mia">[docs]</a>    <span class="k">def</span> <span class="nf">run_process_mia</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the process launch step of the brick.&quot;&quot;&quot;</span>

        <span class="c1"># No need the next line (we don&#39;t use self.process et SPM)</span>
        <span class="c1"># super(Resample2, self).run_process_mia()</span>

        <span class="n">pat_name_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dict4runtime</span><span class="p">[</span><span class="s2">&quot;patient_name&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_data&quot;</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">pat_name_dir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">pat_name_dir</span><span class="p">)</span>

        <span class="n">roi_data_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pat_name_dir</span><span class="p">,</span> <span class="s2">&quot;ROI_data&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">roi_data_dir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">roi_data_dir</span><span class="p">)</span>

        <span class="n">conv_dir2</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">roi_data_dir</span><span class="p">,</span> <span class="s2">&quot;convROI_BOLD2&quot;</span><span class="p">)</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="s2">&quot;None&quot;</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">conv_dir2</span><span class="p">):</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mktemp</span><span class="p">(</span><span class="nb">dir</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">roi_data_dir</span><span class="p">))</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">conv_dir2</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="s2">&quot;convROI_BOLD2&quot;</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Resample2 brick:</span><span class="se">\n</span><span class="s1">A &quot;</span><span class="si">{}</span><span class="s1">&quot; folder already exists, &#39;</span>
                <span class="s2">&quot;it will be overwritten by this new &quot;</span>
                <span class="s2">&quot;calculation...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">conv_dir2</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">conv_dir2</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">tmp</span><span class="p">):</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>

        <span class="c1"># Setting files_to_resample to the resolution of the reference_image</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reference_image</span><span class="p">)</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">()</span>
        <span class="n">mask_size</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">roi_file</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">files_to_resample</span><span class="p">:</span>
            <span class="n">roi_img</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">roi_file</span><span class="p">)</span>
            <span class="n">roi_data</span> <span class="o">=</span> <span class="n">roi_img</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">()</span>
            <span class="n">resized_roi</span> <span class="o">=</span> <span class="n">resize</span><span class="p">(</span><span class="n">roi_data</span><span class="p">,</span> <span class="n">mask_size</span><span class="p">)</span>
            <span class="c1"># TODO: Should we take info from ROI or from the mask ?</span>
            <span class="c1">#       Currently we take from ROI images</span>
            <span class="n">resized_img</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">Nifti1Image</span><span class="p">(</span>
                <span class="n">resized_roi</span><span class="p">,</span> <span class="n">roi_img</span><span class="o">.</span><span class="n">affine</span><span class="p">,</span> <span class="n">roi_img</span><span class="o">.</span><span class="n">header</span>
            <span class="p">)</span>

            <span class="c1"># Image save</span>
            <span class="n">out_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">roi_file</span><span class="p">)</span>
            <span class="n">out_file_no_ext</span><span class="p">,</span> <span class="n">file_extension</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">out_file</span><span class="p">)</span>
            <span class="n">out_file</span> <span class="o">=</span> <span class="n">out_file_no_ext</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span> <span class="o">+</span> <span class="n">file_extension</span>
            <span class="n">out_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">conv_dir2</span><span class="p">,</span> <span class="n">out_file</span><span class="p">)</span>
            <span class="n">nib</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">resized_img</span><span class="p">,</span> <span class="n">out_file</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Resample2 brick:</span><span class="si">{0}</span><span class="s2"> saved&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">out_file</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span></div></div>


<div class="viewcode-block" id="RotationMask"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.others.html#mia_processes.bricks.preprocess.others.processing.RotationMask">[docs]</a><span class="k">class</span> <span class="nc">RotationMask</span><span class="p">(</span><span class="n">ProcessMIA</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    * Compute the rotation mask image.</span>

<span class="sd">    Please, see the complete documentation for the</span>
<span class="sd">    `RotationMask` brick in the populse.mia_processes website</span>
<span class="sd">    https://populse.github.io/mia_processes/html/documentation/bricks/preprocess/other/RotationMask.html</span>

<span class="sd">    adapted from:</span>
<span class="sd">    https://github.com/nipreps/mriqc/blob/e021008da0a2ef1c48e882baf932139a673349f9/mriqc/interfaces/anatomical.py#L448</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="RotationMask.__init__"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.others.html#mia_processes.bricks.preprocess.others.processing.RotationMask.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the attributes initialisation / instantiation.</span>

<span class="sd">        The input and output plugs are defined here. The special</span>
<span class="sd">        &#39;self.requirement&#39; attribute (optional) is used to define the</span>
<span class="sd">        third-party products necessary for the running of the brick.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Initialisation of the objects needed for the launch of the brick</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">RotationMask</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1"># Third party softwares required for the execution of the brick</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requirement</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Inputs description</span>
        <span class="n">in_file_desc</span> <span class="o">=</span> <span class="s2">&quot;An existing path file.&quot;</span>
        <span class="n">prefix_desc</span> <span class="o">=</span> <span class="s2">&quot;Prefix of the output image (a string).&quot;</span>
        <span class="n">suffix_desc</span> <span class="o">=</span> <span class="s2">&quot;Suffix of the output image (a string).&quot;</span>

        <span class="c1"># Outputs description</span>
        <span class="n">out_file_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Path of the scan after masking &quot;</span>
            <span class="s2">&quot;(a pathlike object or string representing a file).&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Inputs traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;in_file&quot;</span><span class="p">,</span> <span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">in_file_desc</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;suffix&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">String</span><span class="p">(</span>
                <span class="s2">&quot;_rotmasked&quot;</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">suffix_desc</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;prefix&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">prefix_desc</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># Outputs traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;out_file&quot;</span><span class="p">,</span> <span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">out_file_desc</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">init_default_traits</span><span class="p">()</span></div>

<div class="viewcode-block" id="RotationMask.list_outputs"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.others.html#mia_processes.bricks.preprocess.others.processing.RotationMask.list_outputs">[docs]</a>    <span class="k">def</span> <span class="nf">list_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_plugged</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the initialisation step of the brick.</span>

<span class="sd">        The main objective of this method is to produce the outputs of the</span>
<span class="sd">        bricks (self.outputs) and the associated tags (self.inheritance_dic),</span>
<span class="sd">        if defined here. To work properly this method must return</span>
<span class="sd">        self.make_initResult() object.</span>

<span class="sd">        :param is_plugged: the state, linked or not, of the plugs.</span>
<span class="sd">        :returns: a dictionary with requirement, outputs and inheritance_dict.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Using the inheritance to ProcessMIA class, list_outputs method</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">RotationMask</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">list_outputs</span><span class="p">()</span>

        <span class="c1"># Outputs definition</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_file</span><span class="p">:</span>
            <span class="n">valid_ext</span><span class="p">,</span> <span class="n">in_ext</span><span class="p">,</span> <span class="n">fileName</span> <span class="o">=</span> <span class="n">checkFileExt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_file</span><span class="p">,</span> <span class="n">EXT</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_ext</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">RotationMask brick: The input image format is not &quot;</span>
                    <span class="s2">&quot;recognized...!&quot;</span>
                <span class="p">)</span>
                <span class="k">return</span>

            <span class="k">if</span> <span class="p">(</span>
                <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span><span class="p">)</span>
                <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">isspace</span><span class="p">())</span>
                <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span> <span class="ow">in</span> <span class="p">[</span><span class="n">Undefined</span><span class="p">,</span> <span class="s2">&quot;&lt;undefined&gt;&quot;</span><span class="p">]</span>
            <span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span>

            <span class="k">if</span> <span class="p">(</span>
                <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="p">)</span>
                <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="o">.</span><span class="n">isspace</span><span class="p">())</span>
                <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span> <span class="ow">in</span> <span class="p">[</span><span class="n">Undefined</span><span class="p">,</span> <span class="s2">&quot;&lt;undefined&gt;&quot;</span><span class="p">])</span>
            <span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span>

            <span class="n">path</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_file</span><span class="p">)</span>

            <span class="k">if</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span> <span class="o">==</span> <span class="s2">&quot; &quot;</span>
                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span> <span class="o">==</span> <span class="s2">&quot; &quot;</span>
                <span class="ow">and</span> <span class="n">path</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span>
            <span class="p">):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="n">QMessageBox</span><span class="p">()</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">setIcon</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Warning</span><span class="p">)</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span>
                    <span class="s2">&quot;mia_processes - RotationMask brick Warning!&quot;</span>
                <span class="p">)</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span>
                    <span class="s2">&quot;Suffix and prefix input parameters are not &quot;</span>
                    <span class="s2">&quot;defined or consist only of one or more white &quot;</span>
                    <span class="s2">&quot;spaces.</span><span class="se">\n</span><span class="s2">The </span><span class="si">{0}</span><span class="s2"> input parameter will be &quot;</span>
                    <span class="s2">&quot;overwritten ...</span><span class="se">\n</span><span class="s2"> Yes or &quot;</span>
                    <span class="s2">&quot;Abort?&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">setStandardButtons</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Yes</span> <span class="o">|</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">Abort</span><span class="p">)</span>
                <span class="n">retval</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">exec_</span><span class="p">()</span>

                <span class="k">if</span> <span class="n">retval</span> <span class="o">!=</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">Abort</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">RotationMask brick warning: the out_file output &quot;</span>
                        <span class="s2">&quot;parameter is the same as the in_files input &quot;</span>
                        <span class="s2">&quot;parameter (suffix and prefix are not defined):&quot;</span>
                        <span class="s2">&quot;</span><span class="se">\n</span><span class="si">{0}</span><span class="s2"> will be overwrited ...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>
                    <span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">RotationMask brick Aborted. Please check your &quot;</span>
                        <span class="s2">&quot;input parameters ...&quot;</span>
                    <span class="p">)</span>
                    <span class="k">return</span>

            <span class="n">file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span>
                <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="o">+</span> <span class="n">fileName</span>
                    <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="o">+</span> <span class="s2">&quot;.&quot;</span>
                    <span class="o">+</span> <span class="n">in_ext</span>
                <span class="p">),</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">file</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;out_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">file</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s2">&quot;- RotationMask brick: There was no output file deducted &quot;</span>
                    <span class="s2">&quot;during initialization. Please check the input &quot;</span>
                    <span class="s2">&quot;parameters...!&quot;</span>
                <span class="p">)</span>

            <span class="c1"># tags inheritance (optional)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;out_file&quot;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">inheritance_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;out_file&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_file</span>

        <span class="c1"># Return the requirement, outputs and inheritance_dict</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_initResult</span><span class="p">()</span></div>

<div class="viewcode-block" id="RotationMask.run_process_mia"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.others.html#mia_processes.bricks.preprocess.others.processing.RotationMask.run_process_mia">[docs]</a>    <span class="k">def</span> <span class="nf">run_process_mia</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the process launch step of the brick.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">RotationMask</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">run_process_mia</span><span class="p">()</span>

        <span class="n">file_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_file</span>

        <span class="c1"># Image processing</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>

        <span class="k">except</span> <span class="p">(</span>
            <span class="n">nib</span><span class="o">.</span><span class="n">filebasedimages</span><span class="o">.</span><span class="n">ImageFileError</span><span class="p">,</span>
            <span class="ne">FileNotFoundError</span><span class="p">,</span>
            <span class="ne">TypeError</span><span class="p">,</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">RotationMask brick: Error with files to mask, during the &quot;</span>
                <span class="s2">&quot;run: &quot;</span><span class="p">,</span>
                <span class="n">e</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">img</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">img</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">()</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">data</span> <span class="o">&lt;=</span> <span class="mi">0</span>

            <span class="c1"># Pad one pixel to control behavior on borders of binary_opening</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span>
                <span class="n">mask</span><span class="p">,</span> <span class="n">pad_width</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,),</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;constant&quot;</span><span class="p">,</span> <span class="n">constant_values</span><span class="o">=</span><span class="mi">1</span>
            <span class="p">)</span>

            <span class="c1"># Remove noise</span>
            <span class="n">struc</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">generate_binary_structure</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">binary_opening</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">structure</span><span class="o">=</span><span class="n">struc</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>

            <span class="c1"># Remove small objects</span>
            <span class="n">label_im</span><span class="p">,</span> <span class="n">nb_labels</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">nb_labels</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">sizes</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">label_im</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">nb_labels</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))</span>
                <span class="n">ordered</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
                    <span class="nb">reversed</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">sizes</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">nb_labels</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)))))</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">ordered</span><span class="p">[</span><span class="mi">2</span><span class="p">:]:</span>
                    <span class="n">mask</span><span class="p">[</span><span class="n">label_im</span> <span class="o">==</span> <span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="c1"># Un-pad</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

            <span class="c1"># If mask is small, clean-up</span>
            <span class="k">if</span> <span class="n">mask</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&lt;</span> <span class="mi">500</span><span class="p">:</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>

            <span class="n">out_img</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">img</span><span class="o">.</span><span class="n">affine</span><span class="p">,</span> <span class="n">img</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>
            <span class="n">out_img</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">set_data_dtype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>

            <span class="c1"># Image save</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
            <span class="n">file_name_no_ext</span><span class="p">,</span> <span class="n">file_extension</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">file_extension</span> <span class="o">==</span> <span class="s2">&quot;.gz&quot;</span><span class="p">:</span>
                <span class="p">(</span><span class="n">file_name_no_ext_2</span><span class="p">,</span> <span class="n">file_extension_2</span><span class="p">)</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span>
                    <span class="n">file_name_no_ext</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">file_extension_2</span> <span class="o">==</span> <span class="s2">&quot;.nii&quot;</span><span class="p">:</span>
                    <span class="n">file_name_no_ext</span> <span class="o">=</span> <span class="n">file_name_no_ext_2</span>
                    <span class="n">file_extension</span> <span class="o">=</span> <span class="s2">&quot;.nii.gz&quot;</span>

            <span class="n">file_out</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span>
                <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="o">+</span> <span class="n">file_name_no_ext</span>
                    <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="o">+</span> <span class="n">file_extension</span>
                <span class="p">),</span>
            <span class="p">)</span>
            <span class="n">nib</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">out_img</span><span class="p">,</span> <span class="n">file_out</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="Sanitize"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.others.html#mia_processes.bricks.preprocess.others.processing.Sanitize">[docs]</a><span class="k">class</span> <span class="nc">Sanitize</span><span class="p">(</span><span class="n">ProcessMIA</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    * Sanitize input bold image.</span>

<span class="sd">    Please, see the complete documentation for the</span>
<span class="sd">    `Sanitize` brick in the populse.mia_processes website</span>
<span class="sd">    https://populse.github.io/mia_processes/html/documentation/bricks/preprocess/other/Sanitize.html</span>

<span class="sd">    adapted from:</span>
<span class="sd">    https://github.com/nipreps/niworkflows/blob/45ab13e1bf6fdbf5e29c90cef44055b0b9cf391b/niworkflows/interfaces/header.py#L394</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Sanitize.__init__"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.others.html#mia_processes.bricks.preprocess.others.processing.Sanitize.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the attributes initialisation / instantiation.</span>

<span class="sd">        The input and output plugs are defined here. The special</span>
<span class="sd">        &#39;self.requirement&#39; attribute (optional) is used to define the</span>
<span class="sd">        third-party products necessary for the running of the brick.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Initialisation of the objects needed for the launch of the brick</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Sanitize</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1"># Third party softwares required for the execution of the brick</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requirement</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Inputs description</span>
        <span class="n">in_file_desc</span> <span class="o">=</span> <span class="s2">&quot;An existing path file.&quot;</span>
        <span class="n">prefix_desc</span> <span class="o">=</span> <span class="s2">&quot;Prefix of the output image (a string).&quot;</span>
        <span class="n">suffix_desc</span> <span class="o">=</span> <span class="s2">&quot;Suffix of the output image (a string).&quot;</span>
        <span class="n">n_volumes_to_discard_desc</span> <span class="o">=</span> <span class="s2">&quot;number of non steady-state volumes&quot;</span>
        <span class="n">max_32bit_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;cast data to float32 if higher precision is &quot;</span> <span class="s2">&quot;encountered&quot;</span>
        <span class="p">)</span>
        <span class="c1"># Outputs description</span>
        <span class="n">out_file_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Path of the snaitized scan&quot;</span>
            <span class="s2">&quot;(a pathlike object or string representing a file).&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Inputs traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;in_file&quot;</span><span class="p">,</span> <span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">in_file_desc</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;max_32bit&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">Bool</span><span class="p">(</span>
                <span class="kc">False</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">max_32bit_desc</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;n_volumes_to_discard&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">Int</span><span class="p">(</span>
                <span class="mi">0</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">n_volumes_to_discard_desc</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;prefix&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">prefix_desc</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;suffix&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">String</span><span class="p">(</span>
                <span class="s2">&quot;_valid&quot;</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">suffix_desc</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># Outputs traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;out_file&quot;</span><span class="p">,</span> <span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">out_file_desc</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">init_default_traits</span><span class="p">()</span></div>

<div class="viewcode-block" id="Sanitize.list_outputs"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.others.html#mia_processes.bricks.preprocess.others.processing.Sanitize.list_outputs">[docs]</a>    <span class="k">def</span> <span class="nf">list_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_plugged</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the initialisation step of the brick.</span>

<span class="sd">        The main objective of this method is to produce the outputs of the</span>
<span class="sd">        bricks (self.outputs) and the associated tags (self.inheritance_dic),</span>
<span class="sd">        if defined here. To work properly this method must return</span>
<span class="sd">        self.make_initResult() object.</span>

<span class="sd">        :param is_plugged: the state, linked or not, of the plugs.</span>
<span class="sd">        :returns: a dictionary with requirement, outputs and inheritance_dict.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Using the inheritance to ProcessMIA class, list_outputs method</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Sanitize</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">list_outputs</span><span class="p">()</span>

        <span class="c1"># Outputs definition</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_file</span><span class="p">:</span>
            <span class="n">valid_ext</span><span class="p">,</span> <span class="n">in_ext</span><span class="p">,</span> <span class="n">fileName</span> <span class="o">=</span> <span class="n">checkFileExt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_file</span><span class="p">,</span> <span class="n">EXT</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_ext</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Sanitize brick: The input image format is not &quot;</span>
                    <span class="s2">&quot;recognized...!&quot;</span>
                <span class="p">)</span>
                <span class="k">return</span>

            <span class="k">if</span> <span class="p">(</span>
                <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span><span class="p">)</span>
                <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">isspace</span><span class="p">())</span>
                <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span> <span class="ow">in</span> <span class="p">[</span><span class="n">Undefined</span><span class="p">,</span> <span class="s2">&quot;&lt;undefined&gt;&quot;</span><span class="p">]</span>
            <span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span>

            <span class="k">if</span> <span class="p">(</span>
                <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="p">)</span>
                <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="o">.</span><span class="n">isspace</span><span class="p">())</span>
                <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span> <span class="ow">in</span> <span class="p">[</span><span class="n">Undefined</span><span class="p">,</span> <span class="s2">&quot;&lt;undefined&gt;&quot;</span><span class="p">])</span>
            <span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span>

            <span class="n">path</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_file</span><span class="p">)</span>

            <span class="k">if</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span> <span class="o">==</span> <span class="s2">&quot; &quot;</span>
                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span> <span class="o">==</span> <span class="s2">&quot; &quot;</span>
                <span class="ow">and</span> <span class="n">path</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span>
            <span class="p">):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="n">QMessageBox</span><span class="p">()</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">setIcon</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Warning</span><span class="p">)</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span>
                    <span class="s2">&quot;mia_processes - &quot;</span> <span class="s2">&quot;Sanitize brick Warning!&quot;</span>
                <span class="p">)</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span>
                    <span class="s2">&quot;Suffix and prefix input parameters are not &quot;</span>
                    <span class="s2">&quot;defined or consist only of one or more white &quot;</span>
                    <span class="s2">&quot;spaces.</span><span class="se">\n</span><span class="s2">The </span><span class="si">{0}</span><span class="s2"> input parameter will be &quot;</span>
                    <span class="s2">&quot;overwritten ...</span><span class="se">\n</span><span class="s2"> Yes or &quot;</span>
                    <span class="s2">&quot;Abort?&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">setStandardButtons</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Yes</span> <span class="o">|</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">Abort</span><span class="p">)</span>
                <span class="n">retval</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">exec_</span><span class="p">()</span>

                <span class="k">if</span> <span class="n">retval</span> <span class="o">!=</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">Abort</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Sanitize brick warning: the out_file output &quot;</span>
                        <span class="s2">&quot;parameter is the same as the in_files input &quot;</span>
                        <span class="s2">&quot;parameter (suffix and prefix are not defined):&quot;</span>
                        <span class="s2">&quot;</span><span class="se">\n</span><span class="si">{0}</span><span class="s2"> will be overwrited ...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>
                    <span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Sanitize brick: Aborted. Please check your input &quot;</span>
                        <span class="s2">&quot;parameters ...&quot;</span>
                    <span class="p">)</span>
                    <span class="k">return</span>

            <span class="n">file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span>
                <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="o">+</span> <span class="n">fileName</span>
                    <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="o">+</span> <span class="s2">&quot;.&quot;</span>
                    <span class="o">+</span> <span class="n">in_ext</span>
                <span class="p">),</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">file</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;out_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">file</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s2">&quot;- Sanitize brick: There was no output file deducted &quot;</span>
                    <span class="s2">&quot;during initialisation. Please check the input &quot;</span>
                    <span class="s2">&quot;parameters...!&quot;</span>
                <span class="p">)</span>

            <span class="c1"># tags inheritance (optional)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;out_file&quot;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">inheritance_dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;out_file&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_file</span>

        <span class="c1"># Return the requirement, outputs and inheritance_dict</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_initResult</span><span class="p">()</span></div>

<div class="viewcode-block" id="Sanitize.run_process_mia"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.others.html#mia_processes.bricks.preprocess.others.processing.Sanitize.run_process_mia">[docs]</a>    <span class="k">def</span> <span class="nf">run_process_mia</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the process launch step of the brick.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Sanitize</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">run_process_mia</span><span class="p">()</span>

        <span class="n">file_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_file</span>

        <span class="c1"># Image processing</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>

        <span class="k">except</span> <span class="p">(</span>
            <span class="n">nib</span><span class="o">.</span><span class="n">filebasedimages</span><span class="o">.</span><span class="n">ImageFileError</span><span class="p">,</span>
            <span class="ne">FileNotFoundError</span><span class="p">,</span>
            <span class="ne">TypeError</span><span class="p">,</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Sanitize brick: Error with files to mask, during the &quot;</span>
                <span class="s2">&quot;run: &quot;</span><span class="p">,</span>
                <span class="n">e</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">img</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">img</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Retrieve xform codes</span>
            <span class="n">sform_code</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">_structarr</span><span class="p">[</span><span class="s2">&quot;sform_code&quot;</span><span class="p">])</span>
            <span class="n">qform_code</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">_structarr</span><span class="p">[</span><span class="s2">&quot;qform_code&quot;</span><span class="p">])</span>

            <span class="c1"># Check qform is valid</span>
            <span class="n">valid_qform</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">img</span><span class="o">.</span><span class="n">get_qform</span><span class="p">()</span>
                <span class="n">valid_qform</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">pass</span>

            <span class="c1"># Matching affines</span>
            <span class="n">matching_affines</span> <span class="o">=</span> <span class="n">valid_qform</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span>
                <span class="n">img</span><span class="o">.</span><span class="n">get_qform</span><span class="p">(),</span> <span class="n">img</span><span class="o">.</span><span class="n">get_sform</span><span class="p">()</span>
            <span class="p">)</span>

            <span class="n">save_file</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="c1"># Both match, qform valid (implicit with match), codes OK</span>
            <span class="c1"># -&gt; do nothing, empty report</span>
            <span class="k">if</span> <span class="n">matching_affines</span> <span class="ow">and</span> <span class="n">qform_code</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">sform_code</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">save_file</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="c1"># Row 2:</span>
            <span class="k">elif</span> <span class="n">valid_qform</span> <span class="ow">and</span> <span class="n">qform_code</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">img</span><span class="o">.</span><span class="n">set_sform</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">get_qform</span><span class="p">(),</span> <span class="n">qform_code</span><span class="p">)</span>
                <span class="n">save_file</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Sanitize brick: Note on orientation:&quot;</span>
                    <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">The sform has been copied from qform.&quot;</span>
                <span class="p">)</span>

            <span class="c1"># Rows 3-4:</span>
            <span class="c1"># Note: if qform is not valid, matching_affines is False</span>
            <span class="k">elif</span> <span class="n">sform_code</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">matching_affines</span> <span class="ow">or</span> <span class="n">qform_code</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                <span class="n">img</span><span class="o">.</span><span class="n">set_qform</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">get_sform</span><span class="p">(),</span> <span class="n">sform_code</span><span class="p">)</span>
                <span class="n">save_file</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Sanitize brick: Note on orientation:&quot;</span>
                    <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">The qform has been copied from sform.&quot;</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_qform</span> <span class="ow">and</span> <span class="n">qform_code</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Sanitize brick WARNING: Invalid qform &quot;</span>
                        <span class="s2">&quot;information.</span><span class="se">\n</span><span class="s2">The qform matrix found in the file &quot;</span>
                        <span class="s2">&quot;header is invalid. The qform has been copied from &quot;</span>
                        <span class="s2">&quot;sform. Checking the original qform information from &quot;</span>
                        <span class="s2">&quot;the data produced by the scanner is advised.&quot;</span>
                    <span class="p">)</span>

            <span class="c1"># Rows 5-6:</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">affine</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">affine</span>
                <span class="n">img</span><span class="o">.</span><span class="n">set_sform</span><span class="p">(</span><span class="n">affine</span><span class="p">,</span> <span class="n">nib</span><span class="o">.</span><span class="n">nifti1</span><span class="o">.</span><span class="n">xform_codes</span><span class="p">[</span><span class="s2">&quot;scanner&quot;</span><span class="p">])</span>
                <span class="n">img</span><span class="o">.</span><span class="n">set_qform</span><span class="p">(</span><span class="n">affine</span><span class="p">,</span> <span class="n">nib</span><span class="o">.</span><span class="n">nifti1</span><span class="o">.</span><span class="n">xform_codes</span><span class="p">[</span><span class="s2">&quot;scanner&quot;</span><span class="p">])</span>
                <span class="n">save_file</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Sanitize brick WARNING: Missing orientation &quot;</span>
                    <span class="s2">&quot;information.</span><span class="se">\n</span><span class="s2">Orientation information could not be &quot;</span>
                    <span class="s2">&quot;retrieved from the image header. The qform and sform &quot;</span>
                    <span class="s2">&quot;matrices have been set to a default LAS-oriented &quot;</span>
                    <span class="s2">&quot;affine. Analyses of this dataset MAY BE INVALID!&quot;</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">max_32bit</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">get_data_dtype</span><span class="p">())</span><span class="o">.</span><span class="n">itemsize</span> <span class="o">&gt;</span> <span class="mi">4</span>
            <span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_volumes_to_discard</span><span class="p">:</span>
                <span class="c1"># force float32 only if 64 bit dtype is detected</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">max_32bit</span>
                    <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">get_data_dtype</span><span class="p">())</span><span class="o">.</span><span class="n">itemsize</span> <span class="o">&gt;</span> <span class="mi">4</span>
                <span class="p">):</span>
                    <span class="n">in_data</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">in_data</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">dataobj</span>

                <span class="c1"># fmt: off</span>
                <span class="n">img</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">Nifti1Image</span><span class="p">(</span>
                    <span class="n">in_data</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_volumes_to_discard</span><span class="p">:],</span>
                    <span class="n">img</span><span class="o">.</span><span class="n">affine</span><span class="p">,</span>
                    <span class="n">img</span><span class="o">.</span><span class="n">header</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="c1"># fmt: on</span>
                <span class="n">save_file</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">img</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">extensions</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">img</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">extensions</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
                <span class="n">save_file</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="c1"># Store new file</span>
            <span class="k">if</span> <span class="n">save_file</span><span class="p">:</span>
                <span class="c1"># Image save</span>
                <span class="n">_</span><span class="p">,</span> <span class="n">file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
                <span class="n">file_name_no_ext</span><span class="p">,</span> <span class="n">file_extension</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">file_extension</span> <span class="o">==</span> <span class="s2">&quot;.gz&quot;</span><span class="p">:</span>
                    <span class="p">(</span><span class="n">file_name_no_ext_2</span><span class="p">,</span> <span class="n">file_extension_2</span><span class="p">)</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span>
                        <span class="n">file_name_no_ext</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">file_extension_2</span> <span class="o">==</span> <span class="s2">&quot;.nii&quot;</span><span class="p">:</span>
                        <span class="n">file_name_no_ext</span> <span class="o">=</span> <span class="n">file_name_no_ext_2</span>
                        <span class="n">file_extension</span> <span class="o">=</span> <span class="s2">&quot;.nii.gz&quot;</span>

                <span class="n">file_out</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span>
                    <span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                        <span class="o">+</span> <span class="n">file_name_no_ext</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                        <span class="o">+</span> <span class="n">file_extension</span>
                    <span class="p">),</span>
                <span class="p">)</span>
                <span class="n">nib</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">file_out</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="TemplateFromTemplateFlow"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.others.html#mia_processes.bricks.preprocess.others.processing.TemplateFromTemplateFlow">[docs]</a><span class="k">class</span> <span class="nc">TemplateFromTemplateFlow</span><span class="p">(</span><span class="n">ProcessMIA</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    * Get template image from templateflow.</span>

<span class="sd">    Please, see the complete documentation for the</span>
<span class="sd">    `TemplateFromTemplateFlow` brick in the populse.mia_processes website</span>
<span class="sd">    https://populse.github.io/mia_processes/html/documentation/bricks/preprocess/other/TemplateFromTemplateFlow.html</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="TemplateFromTemplateFlow.__init__"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.others.html#mia_processes.bricks.preprocess.others.processing.TemplateFromTemplateFlow.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the attributes initialisation / instantiation.</span>

<span class="sd">        The input and output plugs are defined here. The special</span>
<span class="sd">        &#39;self.requirement&#39; attribute (optional) is used to define the</span>
<span class="sd">        third-party products necessary for the running of the brick.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Initialisation of the objects needed for the launch of the brick</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TemplateFromTemplateFlow</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1"># Third party softwares required for the execution of the brick</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requirement</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Inputs description</span>
        <span class="n">in_template_desc</span> <span class="o">=</span> <span class="s2">&quot;Template Name (a String).&quot;</span>
        <span class="n">resolution_desc</span> <span class="o">=</span> <span class="s2">&quot;Resolution of the template  (Int or None)&quot;</span>
        <span class="n">suffix_desc</span> <span class="o">=</span> <span class="s2">&quot;BIDS suffix (String or None)&quot;</span>
        <span class="n">atlas_desc</span> <span class="o">=</span> <span class="s2">&quot;Name of a particular atlas (String or None)&quot;</span>
        <span class="n">desc_desc</span> <span class="o">=</span> <span class="s2">&quot;Description field (String or None)&quot;</span>
        <span class="n">label_desc</span> <span class="o">=</span> <span class="s2">&quot;Label field (String or None)&quot;</span>

        <span class="c1"># Outputs description</span>
        <span class="n">template_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Path of the template (a pathlike object &quot;</span>
            <span class="s2">&quot;or string representing a file).&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Inputs traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;atlas&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">atlas_desc</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;desc&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">desc_desc</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;in_template&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">String</span><span class="p">(</span>
                <span class="n">default</span><span class="o">=</span><span class="s2">&quot;MNI152NLin2009cAsym&quot;</span><span class="p">,</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">in_template_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;label&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">label_desc</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;resolution&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">Int</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">resolution_desc</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;suffix&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">suffix_desc</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># Outputs traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;template&quot;</span><span class="p">,</span> <span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">template_desc</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">init_default_traits</span><span class="p">()</span></div>

<div class="viewcode-block" id="TemplateFromTemplateFlow.list_outputs"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.others.html#mia_processes.bricks.preprocess.others.processing.TemplateFromTemplateFlow.list_outputs">[docs]</a>    <span class="k">def</span> <span class="nf">list_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_plugged</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the initialisation step of the brick.</span>

<span class="sd">        The main objective of this method is to produce the outputs of the</span>
<span class="sd">        bricks (self.outputs) and the associated tags (self.inheritance_dic),</span>
<span class="sd">        if defined here. To work properly this method must return</span>
<span class="sd">        self.make_initResult() object.</span>

<span class="sd">        :param is_plugged: the state, linked or not, of the plugs.</span>
<span class="sd">        :returns: a dictionary with requirement, outputs and inheritance_dict.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Using the inheritance to ProcessMIA class, list_outputs method</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TemplateFromTemplateFlow</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">list_outputs</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span><span class="p">:</span>
            <span class="n">suffix</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">suffix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">atlas</span><span class="p">:</span>
            <span class="n">atlas</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">atlas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atlas</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">desc</span><span class="p">:</span>
            <span class="n">desc</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">desc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">desc</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">:</span>
            <span class="n">label</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">label</span>

        <span class="n">template_spec</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;resolution&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolution</span><span class="p">,</span>
            <span class="s2">&quot;suffix&quot;</span><span class="p">:</span> <span class="n">suffix</span><span class="p">,</span>
            <span class="s2">&quot;atlas&quot;</span><span class="p">:</span> <span class="n">atlas</span><span class="p">,</span>
            <span class="s2">&quot;desc&quot;</span><span class="p">:</span> <span class="n">desc</span><span class="p">,</span>
            <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="n">label</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="n">tpl_target_path</span> <span class="o">=</span> <span class="n">get_template</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_template</span><span class="p">,</span> <span class="o">**</span><span class="n">template_spec</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">tpl_target_path</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">TemplateFromTemplateFlow brick: Could not find template &quot;</span>
                <span class="s2">&quot;&#39;</span><span class="si">{0}</span><span class="s2">&#39; with specs=</span><span class="si">{1}</span><span class="s2">. Please revise your template &quot;</span>
                <span class="s2">&quot;argument.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_template</span><span class="p">,</span> <span class="n">template_spec</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tpl_target_path</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">TemplateFromTemplateFlow brick: The available template &quot;</span>
                <span class="s2">&quot;modifiers (</span><span class="si">{0}</span><span class="s2">) did not select a unique template (got &quot;</span>
                <span class="s2">&quot;&#39;</span><span class="si">{1}</span><span class="s2">&#39;). Please revise your template &quot;</span>
                <span class="s2">&quot;argument.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_template</span><span class="p">,</span> <span class="n">template_spec</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;template&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">tpl_target_path</span><span class="p">)</span>

        <span class="c1"># Return the requirement, outputs and inheritance_dict</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_initResult</span><span class="p">()</span></div>

<div class="viewcode-block" id="TemplateFromTemplateFlow.run_process_mia"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.others.html#mia_processes.bricks.preprocess.others.processing.TemplateFromTemplateFlow.run_process_mia">[docs]</a>    <span class="k">def</span> <span class="nf">run_process_mia</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the process launch step of the brick.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TemplateFromTemplateFlow</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">run_process_mia</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="Threshold"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.others.html#mia_processes.bricks.preprocess.others.processing.Threshold">[docs]</a><span class="k">class</span> <span class="nc">Threshold</span><span class="p">(</span><span class="n">ProcessMIA</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    * Image thresholding.</span>

<span class="sd">    Please, see the complete documentation for the</span>
<span class="sd">    `Threshold` brick in the populse.mia_processes website</span>
<span class="sd">    https://populse.github.io/mia_processes/html/documentation/bricks/preprocess/other/Threshold.html</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Threshold.__init__"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.others.html#mia_processes.bricks.preprocess.others.processing.Threshold.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the attributes initialisation / instantiation.</span>

<span class="sd">        The input and output plugs are defined here. The special</span>
<span class="sd">        &#39;self.requirement&#39; attribute (optional) is used to define the</span>
<span class="sd">        third-party products necessary for the running of the brick.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Initialisation of the objects needed for the launch of the brick</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Threshold</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1"># Third party softwares required for the execution of the brick</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requirement</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Inputs description</span>
        <span class="n">in_files_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;A list of items with string elements corresponding &quot;</span>
            <span class="s2">&quot;to existing path files.&quot;</span>
        <span class="p">)</span>
        <span class="n">threshold_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Value for the applied threshold (a float between 0 &quot;</span> <span class="s2">&quot;and 1).&quot;</span>
        <span class="p">)</span>
        <span class="n">GM_filtering_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Filtering (based on the keyword c1) to keep only &quot;</span>
            <span class="s2">&quot;grey matter images (a boolean)&quot;</span>
        <span class="p">)</span>
        <span class="n">suffix_desc</span> <span class="o">=</span> <span class="s2">&quot;Suffix of the output image (a string).&quot;</span>
        <span class="n">prefix_desc</span> <span class="o">=</span> <span class="s2">&quot;Prefix of the output image (a string).&quot;</span>

        <span class="c1"># Outputs description</span>
        <span class="n">out_files_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Path of the scan after application of the threshold &quot;</span>
            <span class="s2">&quot;(a pathlike object or string representing a file, or &quot;</span>
            <span class="s2">&quot;a list of pathlike objects or strings representing a &quot;</span>
            <span class="s2">&quot;file).&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Inputs traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;in_files&quot;</span><span class="p">,</span>
            <span class="n">InputMultiPath</span><span class="p">(</span>
                <span class="n">traits</span><span class="o">.</span><span class="n">Either</span><span class="p">(</span><span class="n">File</span><span class="p">(),</span> <span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">File</span><span class="p">())),</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">in_files_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;GM_filtering&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">Bool</span><span class="p">(</span>
                <span class="n">default_value</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">GM_filtering_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;prefix&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">prefix_desc</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;suffix&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">String</span><span class="p">(</span>
                <span class="s2">&quot;_002&quot;</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">suffix_desc</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;threshold&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">Range</span><span class="p">(</span>
                <span class="n">value</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span>
                <span class="n">low</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                <span class="n">high</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">threshold_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># Outputs traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;out_files&quot;</span><span class="p">,</span>
            <span class="n">OutputMultiPath</span><span class="p">(</span><span class="n">File</span><span class="p">(),</span> <span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">out_files_desc</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">init_default_traits</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_namesFilter</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Filtering of in_files input parameter in order to keep only GM.</span>

<span class="sd">        :returns: GM images (containing &quot;c1&quot; in the first 5 characters)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">files</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">file_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_files</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">TraitListObject</span><span class="p">)):</span>
                <span class="n">file_name</span> <span class="o">=</span> <span class="n">file_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="c1"># Take the first 5 characters in the case if the GM was processed</span>
            <span class="c1"># ex. normalisation = wc1, normalisation then smooth = swc1 ...</span>
            <span class="c1"># This is not the cleaner way ... for example in the case of a</span>
            <span class="c1"># file name including `c1` in the first 5 characters for another</span>
            <span class="c1"># reason (`c1` in PatientName, etc.).</span>
            <span class="c1"># FiXME: what can we do to be cleaner?</span>
            <span class="k">if</span> <span class="s2">&quot;c1&quot;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">file_name</span><span class="p">))[:</span><span class="mi">5</span><span class="p">]:</span>
                <span class="n">files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">files</span>

<div class="viewcode-block" id="Threshold.list_outputs"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.others.html#mia_processes.bricks.preprocess.others.processing.Threshold.list_outputs">[docs]</a>    <span class="k">def</span> <span class="nf">list_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_plugged</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the initialisation step of the brick.</span>

<span class="sd">        The main objective of this method is to produce the outputs of the</span>
<span class="sd">        bricks (self.outputs) and the associated tags (self.inheritance_dic),</span>
<span class="sd">        if defined here. To work properly this method must return</span>
<span class="sd">        self.make_initResult() object.</span>

<span class="sd">        :param is_plugged: the state, linked or not, of the plugs.</span>
<span class="sd">        :returns: a dictionary with requirement, outputs and inheritance_dict.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Using the inheritance to ProcessMIA class, list_outputs method</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Threshold</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">list_outputs</span><span class="p">()</span>

        <span class="c1"># Outputs definition</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_files</span> <span class="o">!=</span> <span class="n">Undefined</span> <span class="ow">and</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="o">!=</span> <span class="n">Undefined</span>
        <span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">GM_filtering</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">files_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_namesFilter</span><span class="p">()</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">files_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_files</span>

            <span class="k">if</span> <span class="p">(</span>
                <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span><span class="p">)</span>
                <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">isspace</span><span class="p">())</span>
                <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span> <span class="ow">in</span> <span class="p">[</span><span class="n">Undefined</span><span class="p">,</span> <span class="s2">&quot;&lt;undefined&gt;&quot;</span><span class="p">]</span>
            <span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span>

            <span class="k">if</span> <span class="p">(</span>
                <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="p">)</span>
                <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="o">.</span><span class="n">isspace</span><span class="p">())</span>
                <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span> <span class="ow">in</span> <span class="p">[</span><span class="n">Undefined</span><span class="p">,</span> <span class="s2">&quot;&lt;undefined&gt;&quot;</span><span class="p">])</span>
            <span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span>

            <span class="n">files</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">flag</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># If False, suf/pref check will not be performed later</span>
            <span class="n">retval</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">for</span> <span class="n">file_name1</span> <span class="ow">in</span> <span class="n">files_name</span><span class="p">:</span>
                <span class="n">valid_ext</span><span class="p">,</span> <span class="n">in_ext</span><span class="p">,</span> <span class="n">fileName</span> <span class="o">=</span> <span class="n">checkFileExt</span><span class="p">(</span><span class="n">file_name1</span><span class="p">,</span> <span class="n">EXT</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_ext</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Threshold brick: The input image format is not &quot;</span>
                        <span class="s2">&quot;recognized...!&quot;</span>
                    <span class="p">)</span>
                    <span class="k">return</span>
                <span class="n">path</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">file_name1</span><span class="p">)</span>

                <span class="k">if</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span> <span class="o">==</span> <span class="s2">&quot; &quot;</span>
                    <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span> <span class="o">==</span> <span class="s2">&quot; &quot;</span>
                    <span class="ow">and</span> <span class="n">path</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span>
                    <span class="ow">and</span> <span class="n">flag</span> <span class="ow">is</span> <span class="kc">True</span>
                <span class="p">):</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="n">QMessageBox</span><span class="p">()</span>
                    <span class="n">msg</span><span class="o">.</span><span class="n">setIcon</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Warning</span><span class="p">)</span>
                    <span class="n">msg</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span>
                        <span class="s2">&quot;mia_processes - &quot;</span> <span class="s2">&quot;Threshold brick Warning!&quot;</span>
                    <span class="p">)</span>
                    <span class="n">msg</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span>
                        <span class="s2">&quot;Suffix and prefix input parameters are not &quot;</span>
                        <span class="s2">&quot;defined or consist only of one or more white &quot;</span>
                        <span class="s2">&quot;spaces.</span><span class="se">\n</span><span class="s2">The </span><span class="si">{0}</span><span class="s2"> input parameter will be &quot;</span>
                        <span class="s2">&quot;overwritten ...</span><span class="se">\n</span><span class="s2"> Yes or &quot;</span>
                        <span class="s2">&quot;Abort?&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file_name1</span><span class="p">)</span>
                    <span class="p">)</span>
                    <span class="n">msg</span><span class="o">.</span><span class="n">setStandardButtons</span><span class="p">(</span>
                        <span class="n">QMessageBox</span><span class="o">.</span><span class="n">Yes</span>
                        <span class="o">|</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">YesToAll</span>
                        <span class="o">|</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">Abort</span>
                    <span class="p">)</span>
                    <span class="n">retval</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">exec_</span><span class="p">()</span>

                    <span class="k">if</span> <span class="n">retval</span> <span class="o">!=</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">Abort</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span>
                            <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Threshold brick warning: the out_files output &quot;</span>
                            <span class="s2">&quot;parameter is the same as the in_files input &quot;</span>
                            <span class="s2">&quot;parameter (suffix and prefix are not defined):&quot;</span>
                            <span class="s2">&quot;</span><span class="se">\n</span><span class="si">{0}</span><span class="s2"> will be overwrited ...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file_name1</span><span class="p">)</span>
                        <span class="p">)</span>

                        <span class="k">if</span> <span class="n">retval</span> <span class="o">==</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">YesToAll</span><span class="p">:</span>
                            <span class="n">flag</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="nb">print</span><span class="p">(</span>
                                <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Threshold brick: YesToAll selected: end of &quot;</span>
                                <span class="s2">&quot;overwrite checks on input images ...&quot;</span>
                            <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">files_name</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="nb">print</span><span class="p">(</span>
                            <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Threshold brick Aborted. Please check your &quot;</span>
                            <span class="s2">&quot;input parameters ...&quot;</span>
                        <span class="p">)</span>
                        <span class="k">return</span>

                <span class="n">files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span>
                        <span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                            <span class="o">+</span> <span class="n">fileName</span>
                            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                            <span class="o">+</span> <span class="s2">&quot;.&quot;</span>
                            <span class="o">+</span> <span class="n">in_ext</span>
                        <span class="p">),</span>
                    <span class="p">)</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="n">files</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;out_files&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">files</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s2">&quot;- Threshold brick: There was no output file deducted &quot;</span>
                    <span class="s2">&quot;during initialisation. Please check the input &quot;</span>
                    <span class="s2">&quot;parameters...!&quot;</span>
                <span class="p">)</span>

        <span class="c1"># tags inheritance (optional)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;out_files&quot;</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">in_val</span><span class="p">,</span> <span class="n">out_val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">files_name</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
                        <span class="n">_</span><span class="p">,</span> <span class="n">fileOval</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">out_val</span><span class="p">)</span>
                        <span class="n">fileOval_no_ext</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">fileOval</span><span class="p">)</span>
                        <span class="n">_</span><span class="p">,</span> <span class="n">fileIval</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">in_val</span><span class="p">)</span>
                        <span class="n">fileIval_no_ext</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">fileIval</span><span class="p">)</span>

                        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span>
                            <span class="n">fileOval_no_ext</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="p">)</span>
                        <span class="p">):</span>
                            <span class="c1"># fmt: off</span>
                            <span class="n">fileOval_no_ext</span> <span class="o">=</span> <span class="n">fileOval_no_ext</span><span class="p">[</span>
                                <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="p">):]</span>
                            <span class="c1"># fmt: on</span>

                        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">suffix</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span>
                            <span class="n">fileOval_no_ext</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">suffix</span><span class="p">)</span>
                        <span class="p">):</span>
                            <span class="n">fileOval_no_ext</span> <span class="o">=</span> <span class="n">fileOval_no_ext</span><span class="p">[</span>
                                <span class="p">:</span> <span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">suffix</span><span class="p">)</span>
                            <span class="p">]</span>

                        <span class="k">if</span> <span class="n">fileOval_no_ext</span> <span class="o">==</span> <span class="n">fileIval_no_ext</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">inheritance_dict</span><span class="p">[</span><span class="n">out_val</span><span class="p">]</span> <span class="o">=</span> <span class="n">in_val</span>
                            <span class="c1"># FIXME: In the latest version of mia, indexing of</span>
                            <span class="c1">#        the database with particular tags defined</span>
                            <span class="c1">#        in the processes is done only at the end</span>
                            <span class="c1">#        of the initialisation of the whole</span>
                            <span class="c1">#        pipeline. So we cannot use the value of</span>
                            <span class="c1">#        these tags in other processes of the</span>
                            <span class="c1">#        pipeline at the time of initialisation</span>
                            <span class="c1">#        (see populse_mia #290). Until better we</span>
                            <span class="c1">#        use a quick and dirty hack with the</span>
                            <span class="c1">#        set_dbFieldValue() function !</span>
                            <span class="n">tag_to_add</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;PatientName&quot;</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;field_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;string&quot;</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;visibility&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;origin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;user&quot;</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;unit&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;default_value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_dbFieldValue</span><span class="p">(</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="n">in_val</span><span class="p">,</span> <span class="s2">&quot;PatientName&quot;</span>
                            <span class="p">)</span>

                            <span class="k">if</span> <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="n">set_dbFieldValue</span><span class="p">(</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="n">out_val</span><span class="p">,</span> <span class="n">tag_to_add</span>
                                <span class="p">)</span>

                            <span class="k">else</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span>
                                    <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Threshold brick:</span><span class="se">\n</span><span class="s2">The &#39;PatientName&#39;&quot;</span>
                                    <span class="s2">&quot; tag could not be added to the &quot;</span>
                                    <span class="s2">&quot;database for the &#39;</span><span class="si">{}</span><span class="s2">&#39; parameter. This &quot;</span>
                                    <span class="s2">&quot;can lead to a subsequent issue during &quot;</span>
                                    <span class="s2">&quot;initialization!!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">out_val</span><span class="p">)</span>
                                <span class="p">)</span>

        <span class="c1"># Return the requirement, outputs and inheritance_dict</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_initResult</span><span class="p">()</span></div>

<div class="viewcode-block" id="Threshold.run_process_mia"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.others.html#mia_processes.bricks.preprocess.others.processing.Threshold.run_process_mia">[docs]</a>    <span class="k">def</span> <span class="nf">run_process_mia</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the process launch step of the brick.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Threshold</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">run_process_mia</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">GM_filtering</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">files_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_namesFilter</span><span class="p">()</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">files_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_files</span>

        <span class="k">for</span> <span class="n">file_name</span> <span class="ow">in</span> <span class="n">files_name</span><span class="p">:</span>
            <span class="c1"># Image processing</span>
            <span class="n">img_final</span> <span class="o">=</span> <span class="n">threshold</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="p">)</span>

            <span class="c1"># Image save</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
            <span class="n">file_name_no_ext</span><span class="p">,</span> <span class="n">file_extension</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
            <span class="n">out_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span>
                <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="o">+</span> <span class="n">file_name_no_ext</span>
                    <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="o">+</span> <span class="n">file_extension</span>
                <span class="p">),</span>
            <span class="p">)</span>
            <span class="n">nib</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">img_final</span><span class="p">,</span> <span class="n">out_file</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="TSNR"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.others.html#mia_processes.bricks.preprocess.others.processing.TSNR">[docs]</a><span class="k">class</span> <span class="nc">TSNR</span><span class="p">(</span><span class="n">ProcessMIA</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    * Computes the time-course SNR for a time series.</span>

<span class="sd">    Please, see the complete documentation for the</span>
<span class="sd">    `TSNR&#39; brick in the populse.mia_processes website</span>
<span class="sd">    https://populse.github.io/mia_processes/html/documentation/bricks/preprocess/other/TSNR.html</span>

<span class="sd">    adapted from:</span>
<span class="sd">    https://github.com/nipy/nipype/blob/f662acfce8def4717e0c3414618f3a5de5913b31/nipype/algorithms/confounds.py#L899</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="TSNR.__init__"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.others.html#mia_processes.bricks.preprocess.others.processing.TSNR.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the attributes initialisation / instantiation.</span>

<span class="sd">        The input and output plugs are defined here. The special</span>
<span class="sd">        &#39;self.requirement&#39; attribute (optional) is used to define the</span>
<span class="sd">        third-party products necessary for the running of the brick.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Initialisation of the objects needed for the launch of the brick</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TSNR</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1"># Third party softwares required for the execution of the brick</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requirement</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Inputs description</span>
        <span class="n">in_file_desc</span> <span class="o">=</span> <span class="s2">&quot;An existing path file.&quot;</span>
        <span class="n">prefix_tsnr_desc</span> <span class="o">=</span> <span class="s2">&quot;Prefix of the tsnr image (a string).&quot;</span>
        <span class="n">suffix_tsnr_desc</span> <span class="o">=</span> <span class="s2">&quot;Suffix of the tsnr image (a string).&quot;</span>
        <span class="n">prefix_stddev_desc</span> <span class="o">=</span> <span class="s2">&quot;Prefix of the tsnr image (a string).&quot;</span>
        <span class="n">suffix_stddev_desc</span> <span class="o">=</span> <span class="s2">&quot;Suffix of the tsnr image (a string).&quot;</span>

        <span class="c1"># Outputs description</span>
        <span class="n">out_tsnr_file_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Path of the scan after masking &quot;</span>
            <span class="s2">&quot;(a pathlike object or string representing a file).&quot;</span>
        <span class="p">)</span>

        <span class="n">out_stddev_file_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Path of the scan after masking &quot;</span>
            <span class="s2">&quot;(a pathlike object or string representing a file).&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Inputs traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;in_file&quot;</span><span class="p">,</span> <span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">in_file_desc</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;prefix_tsnr&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">String</span><span class="p">(</span>
                <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">prefix_tsnr_desc</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;suffix_tsnr&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">String</span><span class="p">(</span>
                <span class="s2">&quot;_tsnr&quot;</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">suffix_tsnr_desc</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;prefix_stddev&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">String</span><span class="p">(</span>
                <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">prefix_stddev_desc</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;suffix_stddev&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">String</span><span class="p">(</span>
                <span class="s2">&quot;_stddev&quot;</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">suffix_stddev_desc</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># Outputs traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;out_tsnr_file&quot;</span><span class="p">,</span> <span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">out_tsnr_file_desc</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;out_stddev_file&quot;</span><span class="p">,</span>
            <span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">out_stddev_file_desc</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">init_default_traits</span><span class="p">()</span></div>

<div class="viewcode-block" id="TSNR.list_outputs"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.others.html#mia_processes.bricks.preprocess.others.processing.TSNR.list_outputs">[docs]</a>    <span class="k">def</span> <span class="nf">list_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_plugged</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the initialisation step of the brick.</span>

<span class="sd">        The main objective of this method is to produce the outputs of the</span>
<span class="sd">        bricks (self.outputs) and the associated tags (self.inheritance_dic),</span>
<span class="sd">        if defined here. To work properly this method must return</span>
<span class="sd">        self.make_initResult() object.</span>

<span class="sd">        :param is_plugged: the state, linked or not, of the plugs.</span>
<span class="sd">        :returns: a dictionary with requirement, outputs and inheritance_dict.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Using the inheritance to ProcessMIA class, list_outputs method</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TSNR</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">list_outputs</span><span class="p">()</span>

        <span class="c1"># Outputs definition</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_file</span><span class="p">:</span>
            <span class="n">valid_ext</span><span class="p">,</span> <span class="n">in_ext</span><span class="p">,</span> <span class="n">fileName</span> <span class="o">=</span> <span class="n">checkFileExt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_file</span><span class="p">,</span> <span class="n">EXT</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_ext</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">TSNR brick: The input image format is not &quot;</span>
                    <span class="s2">&quot;recognized...!&quot;</span>
                <span class="p">)</span>
                <span class="k">return</span>

            <span class="k">if</span> <span class="p">(</span>
                <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">suffix_tsnr</span><span class="p">)</span>
                <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">suffix_tsnr</span><span class="o">.</span><span class="n">isspace</span><span class="p">())</span>
                <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">suffix_tsnr</span> <span class="ow">in</span> <span class="p">[</span><span class="n">Undefined</span><span class="p">,</span> <span class="s2">&quot;&lt;undefined&gt;&quot;</span><span class="p">]</span>
            <span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">suffix_tsnr</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span>

            <span class="k">if</span> <span class="p">(</span>
                <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefix_tsnr</span><span class="p">)</span>
                <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix_tsnr</span><span class="o">.</span><span class="n">isspace</span><span class="p">())</span>
                <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix_tsnr</span> <span class="ow">in</span> <span class="p">[</span><span class="n">Undefined</span><span class="p">,</span> <span class="s2">&quot;&lt;undefined&gt;&quot;</span><span class="p">])</span>
            <span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">prefix_tsnr</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span>

            <span class="n">file_tsnr</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

            <span class="n">path</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_file</span><span class="p">)</span>

            <span class="k">if</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">suffix_tsnr</span> <span class="o">==</span> <span class="s2">&quot; &quot;</span>
                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefix_tsnr</span> <span class="o">==</span> <span class="s2">&quot; &quot;</span>
                <span class="ow">and</span> <span class="n">path</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span>
            <span class="p">):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="n">QMessageBox</span><span class="p">()</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">setIcon</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Warning</span><span class="p">)</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="s2">&quot;mia_processes - TSNR brick Warning!&quot;</span><span class="p">)</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span>
                    <span class="s2">&quot;suffix_tsnr and prefix_tsnr input parameters are not &quot;</span>
                    <span class="s2">&quot;defined or consist only of one or more white &quot;</span>
                    <span class="s2">&quot;spaces.</span><span class="se">\n</span><span class="s2">The </span><span class="si">{0}</span><span class="s2"> input parameter will be &quot;</span>
                    <span class="s2">&quot;overwritten ...</span><span class="se">\n</span><span class="s2"> Yes or &quot;</span>
                    <span class="s2">&quot;Abort?&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">setStandardButtons</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Yes</span> <span class="o">|</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">Abort</span><span class="p">)</span>
                <span class="n">retval</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">exec_</span><span class="p">()</span>

                <span class="k">if</span> <span class="n">retval</span> <span class="o">!=</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">Abort</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">TSNR brick warning: the out_tsnr_file output &quot;</span>
                        <span class="s2">&quot;parameter is the same as the in_file input &quot;</span>
                        <span class="s2">&quot;parameter (suffix and prefix are not defined):&quot;</span>
                        <span class="s2">&quot;</span><span class="se">\n</span><span class="si">{0}</span><span class="s2"> will be overwrited ...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>
                    <span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">TSNR brick: Aborted. Please check your input &quot;</span>
                        <span class="s2">&quot;parameters ...&quot;</span>
                    <span class="p">)</span>
                    <span class="k">return</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">file_tsnr</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span>
                    <span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">prefix_tsnr</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                        <span class="o">+</span> <span class="n">fileName</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">suffix_tsnr</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                        <span class="o">+</span> <span class="s2">&quot;.&quot;</span>
                        <span class="o">+</span> <span class="n">in_ext</span>
                    <span class="p">),</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="p">(</span>
                <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">suffix_stddev</span><span class="p">)</span>
                <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">suffix_stddev</span><span class="o">.</span><span class="n">isspace</span><span class="p">())</span>
                <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">suffix_stddev</span> <span class="ow">in</span> <span class="p">[</span><span class="n">Undefined</span><span class="p">,</span> <span class="s2">&quot;&lt;undefined&gt;&quot;</span><span class="p">]</span>
            <span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">suffix_stddev</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span>

            <span class="k">if</span> <span class="p">(</span>
                <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefix_stddev</span><span class="p">)</span>
                <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix_stddev</span><span class="o">.</span><span class="n">isspace</span><span class="p">())</span>
                <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix_stddev</span> <span class="ow">in</span> <span class="p">[</span><span class="n">Undefined</span><span class="p">,</span> <span class="s2">&quot;&lt;undefined&gt;&quot;</span><span class="p">])</span>
            <span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">prefix_stddev</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span>

            <span class="n">file_stddev</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

            <span class="k">if</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">suffix_stddev</span> <span class="o">==</span> <span class="s2">&quot; &quot;</span>
                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefix_stddev</span> <span class="o">==</span> <span class="s2">&quot; &quot;</span>
                <span class="ow">and</span> <span class="n">path</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span>
            <span class="p">):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="n">QMessageBox</span><span class="p">()</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">setIcon</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Warning</span><span class="p">)</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="s2">&quot;mia_processes - TSNR brick Warning!&quot;</span><span class="p">)</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span>
                    <span class="s2">&quot;suffix_stddev and prefix_stddev input parameters are not &quot;</span>
                    <span class="s2">&quot;defined or consist only of one or more white &quot;</span>
                    <span class="s2">&quot;spaces.</span><span class="se">\n</span><span class="s2">The </span><span class="si">{0}</span><span class="s2"> input parameter will be &quot;</span>
                    <span class="s2">&quot;overwritten ...</span><span class="se">\n</span><span class="s2"> Yes or &quot;</span>
                    <span class="s2">&quot;Abort?&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">setStandardButtons</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Yes</span> <span class="o">|</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">Abort</span><span class="p">)</span>
                <span class="n">retval</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">exec_</span><span class="p">()</span>

                <span class="k">if</span> <span class="n">retval</span> <span class="o">!=</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">Abort</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">TSNR brick warning: the out_stddev_file output &quot;</span>
                        <span class="s2">&quot;parameter is the same as the in_files input &quot;</span>
                        <span class="s2">&quot;parameter (suffix and prefix are not defined):&quot;</span>
                        <span class="s2">&quot;</span><span class="se">\n</span><span class="si">{0}</span><span class="s2"> will be overwrited ...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">TSNR brick Aborted. Please check your input &quot;</span>
                        <span class="s2">&quot;parameters ...&quot;</span>
                    <span class="p">)</span>
                    <span class="k">return</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">file_stddev</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span>
                    <span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">prefix_stddev</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                        <span class="o">+</span> <span class="n">fileName</span>
                        <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">suffix_stddev</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                        <span class="o">+</span> <span class="s2">&quot;.&quot;</span>
                        <span class="o">+</span> <span class="n">in_ext</span>
                    <span class="p">),</span>
                <span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;out_tsnr_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">file_tsnr</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;out_stddev_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">file_stddev</span>

            <span class="c1"># tags inheritance (optional)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;out_tsnr_file&quot;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">inheritance_dict</span><span class="p">[</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;out_tsnr_file&quot;</span><span class="p">]</span>
                <span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_file</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;out_stddev_file&quot;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">inheritance_dict</span><span class="p">[</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;out_stddev_file&quot;</span><span class="p">]</span>
                <span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_file</span>

        <span class="c1"># Return the requirement, outputs and inheritance_dict</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_initResult</span><span class="p">()</span></div>

<div class="viewcode-block" id="TSNR.run_process_mia"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.others.html#mia_processes.bricks.preprocess.others.processing.TSNR.run_process_mia">[docs]</a>    <span class="k">def</span> <span class="nf">run_process_mia</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the process launch step of the brick.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TSNR</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">run_process_mia</span><span class="p">()</span>

        <span class="n">file_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_file</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span>
            <span class="n">nib</span><span class="o">.</span><span class="n">filebasedimages</span><span class="o">.</span><span class="n">ImageFileError</span><span class="p">,</span>
            <span class="ne">FileNotFoundError</span><span class="p">,</span>
            <span class="ne">TypeError</span><span class="p">,</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">TSNR brick: Error with files to mask, during the &quot;</span> <span class="s2">&quot;run: &quot;</span><span class="p">,</span>
                <span class="n">e</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">img</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">img</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">header</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
                <span class="n">img</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,)</span>
            <span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="s2">&quot;i&quot;</span><span class="p">:</span>
                <span class="n">header</span><span class="o">.</span><span class="n">set_data_dtype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

            <span class="n">meanimg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">stddevimg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
            <span class="n">tsnr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">meanimg</span><span class="p">)</span>
            <span class="n">stddevimg_nonzero</span> <span class="o">=</span> <span class="n">stddevimg</span> <span class="o">&gt;</span> <span class="mf">1.0e-3</span>
            <span class="n">tsnr</span><span class="p">[</span><span class="n">stddevimg_nonzero</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">meanimg</span><span class="p">[</span><span class="n">stddevimg_nonzero</span><span class="p">]</span> <span class="o">/</span> <span class="n">stddevimg</span><span class="p">[</span><span class="n">stddevimg_nonzero</span><span class="p">]</span>
            <span class="p">)</span>

            <span class="c1"># Image save</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
            <span class="n">file_name_no_ext</span><span class="p">,</span> <span class="n">file_extension</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">file_extension</span> <span class="o">==</span> <span class="s2">&quot;.gz&quot;</span><span class="p">:</span>
                <span class="p">(</span><span class="n">file_name_no_ext_2</span><span class="p">,</span> <span class="n">file_extension_2</span><span class="p">)</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span>
                    <span class="n">file_name_no_ext</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">file_extension_2</span> <span class="o">==</span> <span class="s2">&quot;.nii&quot;</span><span class="p">:</span>
                    <span class="n">file_name_no_ext</span> <span class="o">=</span> <span class="n">file_name_no_ext_2</span>
                    <span class="n">file_extension</span> <span class="o">=</span> <span class="s2">&quot;.nii.gz&quot;</span>

            <span class="n">tsnr_file_out</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span>
                <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">prefix_tsnr</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="o">+</span> <span class="n">file_name_no_ext</span>
                    <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">suffix_tsnr</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="o">+</span> <span class="n">file_extension</span>
                <span class="p">),</span>
            <span class="p">)</span>
            <span class="n">tsnr_img</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">Nifti1Image</span><span class="p">(</span><span class="n">tsnr</span><span class="p">,</span> <span class="n">img</span><span class="o">.</span><span class="n">affine</span><span class="p">,</span> <span class="n">header</span><span class="p">)</span>
            <span class="n">nib</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">tsnr_img</span><span class="p">,</span> <span class="n">tsnr_file_out</span><span class="p">)</span>

            <span class="n">stddev_file_out</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span>
                <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">prefix_stddev</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="o">+</span> <span class="n">file_name_no_ext</span>
                    <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">suffix_stddev</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="o">+</span> <span class="n">file_extension</span>
                <span class="p">),</span>
            <span class="p">)</span>
            <span class="n">stddev_img</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">Nifti1Image</span><span class="p">(</span><span class="n">stddevimg</span><span class="p">,</span> <span class="n">img</span><span class="o">.</span><span class="n">affine</span><span class="p">,</span> <span class="n">header</span><span class="p">)</span>
            <span class="n">nib</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">stddev_img</span><span class="p">,</span> <span class="n">stddev_file_out</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="artifact_mask"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.others.html#mia_processes.bricks.preprocess.others.processing.artifact_mask">[docs]</a><span class="k">def</span> <span class="nf">artifact_mask</span><span class="p">(</span><span class="n">imdata</span><span class="p">,</span> <span class="n">airdata</span><span class="p">,</span> <span class="n">distance</span><span class="p">,</span> <span class="n">zscore</span><span class="o">=</span><span class="mf">10.0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Computes a mask of artifacts found in the air region&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">issubdtype</span><span class="p">(</span><span class="n">airdata</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">integer</span><span class="p">):</span>
        <span class="n">airdata</span><span class="p">[</span><span class="n">airdata</span> <span class="o">&lt;</span> <span class="mf">0.95</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">airdata</span><span class="p">[</span><span class="n">airdata</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="n">bg_img</span> <span class="o">=</span> <span class="n">imdata</span> <span class="o">*</span> <span class="n">airdata</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">bg_img</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">airdata</span><span class="p">)</span>

    <span class="c1"># Find the background threshold (the most frequently occurring value</span>
    <span class="c1"># excluding 0)</span>
    <span class="n">bg_location</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">bg_img</span><span class="p">[</span><span class="n">bg_img</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">bg_spread</span> <span class="o">=</span> <span class="n">mad</span><span class="p">(</span><span class="n">bg_img</span><span class="p">[</span><span class="n">bg_img</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">bg_img</span><span class="p">[</span><span class="n">bg_img</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">-=</span> <span class="n">bg_location</span>
    <span class="c1"># TODO: This is generating a RuntimeWarning: divide by zero with MRIQC anat</span>
    <span class="n">bg_img</span><span class="p">[</span><span class="n">bg_img</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">/=</span> <span class="n">bg_spread</span>

    <span class="c1"># Apply this threshold to the background voxels to identify voxels</span>
    <span class="c1"># contributing artifacts.</span>
    <span class="n">qi1_img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">bg_img</span><span class="p">)</span>
    <span class="n">qi1_img</span><span class="p">[</span><span class="n">bg_img</span> <span class="o">&gt;</span> <span class="n">zscore</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">qi1_img</span><span class="p">[</span><span class="n">distance</span> <span class="o">&lt;</span> <span class="mf">0.10</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># Create a structural element to be used in an opening operation.</span>
    <span class="n">struc</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">generate_binary_structure</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">qi1_img</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">binary_opening</span><span class="p">(</span><span class="n">qi1_img</span><span class="p">,</span> <span class="n">struc</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">uint8</span><span class="p">)</span>
    <span class="n">qi1_img</span><span class="p">[</span><span class="n">airdata</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">return</span> <span class="n">qi1_img</span></div>


<div class="viewcode-block" id="is_outlier"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.others.html#mia_processes.bricks.preprocess.others.processing.is_outlier">[docs]</a><span class="k">def</span> <span class="nf">is_outlier</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">thresh</span><span class="o">=</span><span class="mf">3.5</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a boolean array with True if points are outliers and False</span>
<span class="sd">    otherwise.</span>
<span class="sd">    :param nparray points: an numobservations by numdimensions numpy array</span>
<span class="sd">        of observations</span>
<span class="sd">    :param float thresh: the modified z-score to use as a threshold.</span>
<span class="sd">        Observations with a modified z-score (based on the median absolute</span>
<span class="sd">        deviation) greater than this value will be classified as outliers.</span>
<span class="sd">    :return: A bolean mask, of size numobservations-length array.</span>
<span class="sd">    .. note:: References</span>
<span class="sd">        Boris Iglewicz and David Hoaglin (1993), &quot;Volume 16: How to Detect and</span>
<span class="sd">        Handle Outliers&quot;, The ASQC Basic References in Quality Control:</span>
<span class="sd">        Statistical Techniques, Edward F. Mykytka, Ph.D., Editor.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">points</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">points</span> <span class="o">=</span> <span class="n">points</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
    <span class="n">median</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">points</span> <span class="o">-</span> <span class="n">median</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span>
    <span class="n">med_abs_deviation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span>

    <span class="n">modified_z_score</span> <span class="o">=</span> <span class="mf">0.6745</span> <span class="o">*</span> <span class="n">diff</span> <span class="o">/</span> <span class="n">med_abs_deviation</span>

    <span class="n">timepoints_to_discard</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">modified_z_score</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">modified_z_score</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">thresh</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">timepoints_to_discard</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="n">timepoints_to_discard</span></div>


<div class="viewcode-block" id="threshold"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.others.html#mia_processes.bricks.preprocess.others.processing.threshold">[docs]</a><span class="k">def</span> <span class="nf">threshold</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">thresh</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Basic method for image thresholding</span>

<span class="sd">    :param file_name: Image to be thresholded</span>
<span class="sd">    :param thresh: Threshold value (a float between 0 and 1)</span>
<span class="sd">    :returns: Image after thresholding</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
    <span class="n">img_data</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">()</span>
    <span class="n">_max</span> <span class="o">=</span> <span class="n">img_data</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">img_thresh</span> <span class="o">=</span> <span class="p">(</span><span class="n">img_data</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">_max</span> <span class="o">*</span> <span class="n">thresh</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">img_final</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">Nifti1Image</span><span class="p">(</span><span class="n">img_thresh</span><span class="p">,</span> <span class="n">img</span><span class="o">.</span><span class="n">affine</span><span class="p">,</span> <span class="n">img</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">img_final</span></div>
</pre></div>

      </div>
      <div class="bottomnav" role="navigation" aria-label="bottom navigation">
      
        <p>
        <a class="uplink" href="../../../../../index.html">Contents</a>
        </p>

      </div>

    <div class="footer" role="contentinfo">
        &#169; Copyright 2019, populse.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 3.2.1.
    </div>
  </body>
</html>