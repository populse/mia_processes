<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>mia_processes.bricks.tools.tools &#8212; mia_processes 2.6.1-dev+0eb064ac documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css?v=659b1fac" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/haiku.css?v=d31ea6cb" />
    <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js?v=ab2743f7"></script>
    <script src="../../../../_static/doctools.js?v=888ff710"></script>
    <script src="../../../../_static/sphinx_highlight.js?v=4825356b"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
  </head><body>
      <div class="header" role="banner"><h1 class="heading"><a href="../../../../index.html">
          <span>mia_processes 2.6.1-dev+0eb064ac documentation</span></a></h1>
        <h2 class="heading"><span>mia_processes.bricks.tools.tools</span></h2>
      </div>
      <div class="topnav" role="navigation" aria-label="top navigation">
      
        <p>
        <a class="uplink" href="../../../../index.html">Contents</a>
        </p>

      </div>
      <div class="content" role="main">
        
        
  <h1>Source code for mia_processes.bricks.tools.tools</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>

<span class="sd">&quot;&quot;&quot;The toolbox library of the mia_processes package.</span>

<span class="sd">Basically, this module is dedicated to the low-level processes</span>
<span class="sd">needed to run other higher-level bricks.</span>

<span class="sd">:Contains:</span>
<span class="sd">    :Class:</span>
<span class="sd">        - Concat_to_list</span>
<span class="sd">        - Concat_to_list_of_list</span>
<span class="sd">        - Delete_data</span>
<span class="sd">        - Files_To_List</span>
<span class="sd">        - Filter_Files_List</span>
<span class="sd">        - Find_In_List</span>
<span class="sd">        - Get_Conditions_From_csv</span>
<span class="sd">        - Get_Eprime_Info_GE2REC</span>
<span class="sd">        - Get_Patient_Name</span>
<span class="sd">        - Get_Regressors_From_csv</span>
<span class="sd">        - Import_Data</span>
<span class="sd">        - Input_Filter</span>
<span class="sd">        - List_Duplicate</span>
<span class="sd">        - List_To_File</span>
<span class="sd">        - Make_AIF</span>
<span class="sd">        - Make_A_List</span>
<span class="sd">        - Make_CVR_reg_physio</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="c1">##########################################################################</span>
<span class="c1"># mia_processes - Copyright (C) IRMaGe/CEA, 2018</span>
<span class="c1"># Distributed under the terms of the CeCILL license, as published by</span>
<span class="c1"># the CEA-CNRS-INRIA. Refer to the LICENSE file or to</span>
<span class="c1"># http://www.cecill.info/licences/Licence_CeCILL_V2.1-en.html</span>
<span class="c1"># for details.</span>
<span class="c1">##########################################################################</span>
<span class="c1"># fmt: off</span>
<span class="c1"># fmt: on</span>

<span class="c1"># Other imports</span>
<span class="kn">import</span> <span class="nn">csv</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">from</span> <span class="nn">ast</span> <span class="kn">import</span> <span class="n">literal_eval</span>

<span class="kn">import</span> <span class="nn">nibabel</span> <span class="k">as</span> <span class="nn">nib</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="c1"># nipype import</span>
<span class="kn">from</span> <span class="nn">nipype.interfaces.base</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">File</span><span class="p">,</span>
    <span class="n">InputMultiPath</span><span class="p">,</span>
    <span class="n">OutputMultiPath</span><span class="p">,</span>
    <span class="n">traits</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">nipype.interfaces.spm.base</span> <span class="kn">import</span> <span class="n">ImageFileSPM</span>

<span class="c1"># populse_mia imports</span>
<span class="kn">from</span> <span class="nn">populse_mia.data_manager.data_history_inspect</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">get_data_history_processes</span><span class="p">,</span>
    <span class="n">get_filenames_in_value</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">populse_mia.data_manager.filter</span> <span class="kn">import</span> <span class="n">Filter</span>
<span class="kn">from</span> <span class="nn">populse_mia.data_manager.project</span> <span class="kn">import</span> <span class="n">BRICK_OUTPUTS</span><span class="p">,</span> <span class="n">COLLECTION_CURRENT</span>
<span class="kn">from</span> <span class="nn">populse_mia.software_properties</span> <span class="kn">import</span> <span class="n">Config</span>
<span class="kn">from</span> <span class="nn">populse_mia.user_interface.pipeline_manager.process_mia</span> <span class="kn">import</span> <span class="n">ProcessMIA</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">io</span><span class="p">,</span> <span class="n">signal</span>
<span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="kn">import</span> <span class="n">interp1d</span>
<span class="kn">from</span> <span class="nn">scipy.special</span> <span class="kn">import</span> <span class="n">gammaln</span>
<span class="kn">from</span> <span class="nn">skimage.filters</span> <span class="kn">import</span> <span class="n">threshold_otsu</span>
<span class="kn">from</span> <span class="nn">traits.api</span> <span class="kn">import</span> <span class="n">Either</span><span class="p">,</span> <span class="n">Undefined</span>

<span class="c1"># mia_processes imports</span>
<span class="kn">from</span> <span class="nn">mia_processes.utils</span> <span class="kn">import</span> <span class="n">checkFileExt</span><span class="p">,</span> <span class="n">get_dbFieldValue</span>


<div class="viewcode-block" id="Concat_to_list"><a class="viewcode-back" href="../../../../mia_processes.bricks.tools.html#mia_processes.bricks.tools.tools.Concat_to_list">[docs]</a><span class="k">class</span> <span class="nc">Concat_to_list</span><span class="p">(</span><span class="n">ProcessMIA</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    *Make an output list corresponding to the concatenation of list1 and list2*</span>

<span class="sd">    Ex. [&#39;a&#39;, &#39;b&#39;, &#39;c&#39;] and [&#39;d&#39;, &#39;e&#39;] gives</span>
<span class="sd">        [&#39;a&#39;, &#39;b&#39;, &#39;c&#39;, &#39;d&#39;, &#39;e&#39;]</span>

<span class="sd">    Please, see the complete documentation for the `Concat_to_list brick in the</span>
<span class="sd">    mia_processes website</span>
<span class="sd">    &lt;https://populse.github.io/mia_processes/html/documentation/bricks/tools/Concat_to_list.html&gt;`_</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Concat_to_list.__init__"><a class="viewcode-back" href="../../../../mia_processes.bricks.tools.html#mia_processes.bricks.tools.tools.Concat_to_list.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Dedicated to the attributes initialisation/instantiation.</span>

<span class="sd">        The input and output plugs are defined here. The special</span>
<span class="sd">        &#39;self.requirement&#39; attribute (optional) is used to define the</span>
<span class="sd">        third-party products necessary for the running of the brick.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># initialisation of the objects needed for the launch of the brick</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Concat_to_list</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1"># Inputs description</span>
        <span class="n">list1_desc</span> <span class="o">=</span> <span class="s2">&quot;A list&quot;</span>
        <span class="n">list2_desc</span> <span class="o">=</span> <span class="s2">&quot;A list&quot;</span>

        <span class="c1"># Outputs description</span>
        <span class="n">out_list_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;A list corresponding to the concatenation of list1 and list2&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Inputs traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;list1&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">list1_desc</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">list1</span> <span class="o">=</span> <span class="n">traits</span><span class="o">.</span><span class="n">Undefined</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;list2&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">list2_desc</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">list2</span> <span class="o">=</span> <span class="n">traits</span><span class="o">.</span><span class="n">Undefined</span>

        <span class="c1"># Outputs traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;out_list&quot;</span><span class="p">,</span> <span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">out_list_desc</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">out_list</span> <span class="o">=</span> <span class="n">traits</span><span class="o">.</span><span class="n">Undefined</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">init_default_traits</span><span class="p">()</span></div>

<div class="viewcode-block" id="Concat_to_list.list_outputs"><a class="viewcode-back" href="../../../../mia_processes.bricks.tools.html#mia_processes.bricks.tools.tools.Concat_to_list.list_outputs">[docs]</a>    <span class="k">def</span> <span class="nf">list_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_plugged</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Dedicated to the initialisation step of the brick.</span>

<span class="sd">        The main objective of this method is to produce the outputs of the</span>
<span class="sd">        bricks (self.outputs) and the associated tags (self.inheritance_dic),</span>
<span class="sd">        if defined here. In order not to include an output in the database,</span>
<span class="sd">        this output must be a value of the optional key &#39;notInDb&#39; of the</span>
<span class="sd">        self.outputs dictionary. To work properly this method must return</span>
<span class="sd">        self.make_initResult() object.</span>

<span class="sd">        :param is_plugged: the state, linked or not, of the plugs.</span>
<span class="sd">        :returns: a dictionary with requirement, outputs and inheritance_dict.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Using the inheritance to ProcessMIA class, list_outputs method</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Concat_to_list</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">list_outputs</span><span class="p">()</span>

        <span class="c1"># Outputs definition and tags inheritance (optional)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">list1</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[[],</span> <span class="n">traits</span><span class="o">.</span><span class="n">Undefined</span><span class="p">]</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">list2</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="p">[],</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">Undefined</span><span class="p">,</span>
        <span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;out_list&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">list1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">list2</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;notInDb&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;out_list&quot;</span><span class="p">]</span>

        <span class="c1"># Return the requirement, outputs and inheritance_dict</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_initResult</span><span class="p">()</span></div>

<div class="viewcode-block" id="Concat_to_list.run_process_mia"><a class="viewcode-back" href="../../../../mia_processes.bricks.tools.html#mia_processes.bricks.tools.tools.Concat_to_list.run_process_mia">[docs]</a>    <span class="k">def</span> <span class="nf">run_process_mia</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Dedicated to the process launch step of the brick.&quot;&quot;&quot;</span>
        <span class="k">return</span></div></div>


<div class="viewcode-block" id="Concat_to_list_of_list"><a class="viewcode-back" href="../../../../mia_processes.bricks.tools.html#mia_processes.bricks.tools.tools.Concat_to_list_of_list">[docs]</a><span class="k">class</span> <span class="nc">Concat_to_list_of_list</span><span class="p">(</span><span class="n">ProcessMIA</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    *Iteration of input list1 with each element of input list2*</span>

<span class="sd">    Ex. [&#39;a&#39;, &#39;b&#39;, &#39;c&#39;] and [&#39;1&#39;, &#39;2&#39;] gives</span>
<span class="sd">        [[&#39;a&#39;, &#39;1&#39;], [&#39;a&#39;, &#39;2&#39;],</span>
<span class="sd">         [&#39;b&#39;, &#39;1&#39;], [&#39;b&#39;, &#39;2&#39;],</span>
<span class="sd">         [&#39;c&#39;, &#39;1&#39;], [&#39;c&#39;, &#39;2&#39;]</span>

<span class="sd">    Please, see the complete documentation for the `Concat_to_list_of_list</span>
<span class="sd">    brick in the mia_processes website</span>
<span class="sd">    &lt;https://populse.github.io/mia_processes/html/documentation/bricks/tools/Concat_to_list_of_list.html&gt;`_</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Concat_to_list_of_list.__init__"><a class="viewcode-back" href="../../../../mia_processes.bricks.tools.html#mia_processes.bricks.tools.tools.Concat_to_list_of_list.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Dedicated to the attributes initialisation/instantiation.</span>

<span class="sd">        The input and output plugs are defined here. The special</span>
<span class="sd">        &#39;self.requirement&#39; attribute (optional) is used to define the</span>
<span class="sd">        third-party products necessary for the running of the brick.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># initialisation of the objects needed for the launch of the brick</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Concat_to_list_of_list</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="n">LIST1</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;ACA&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ACM&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ACP&quot;</span><span class="p">,</span>
            <span class="s2">&quot;PICA&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ROI-CING&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ROI-FRON&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ROI-INSULA&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ROI-OCC&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ROI-PAR&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ROI-STR&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ROI-TEMP&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ROI-THA&quot;</span><span class="p">,</span>
            <span class="s2">&quot;SCA&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="n">LIST2</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;L&quot;</span><span class="p">,</span> <span class="s2">&quot;R&quot;</span><span class="p">]</span>

        <span class="c1"># Inputs description</span>
        <span class="n">list1_desc</span> <span class="o">=</span> <span class="s2">&quot;A list of string&quot;</span>
        <span class="n">list2_desc</span> <span class="o">=</span> <span class="s2">&quot;A list of string&quot;</span>

        <span class="c1"># Outputs description</span>
        <span class="n">listOflist_desc</span> <span class="o">=</span> <span class="s2">&quot;A list of list&quot;</span>

        <span class="c1"># Inputs traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;list1&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">LIST1</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">list1_desc</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;list2&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">LIST2</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">list2_desc</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># Outputs traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;listOflist&quot;</span><span class="p">,</span> <span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">listOflist_desc</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">listOflist</span> <span class="o">=</span> <span class="n">traits</span><span class="o">.</span><span class="n">Undefined</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">init_default_traits</span><span class="p">()</span></div>

<div class="viewcode-block" id="Concat_to_list_of_list.list_outputs"><a class="viewcode-back" href="../../../../mia_processes.bricks.tools.html#mia_processes.bricks.tools.tools.Concat_to_list_of_list.list_outputs">[docs]</a>    <span class="k">def</span> <span class="nf">list_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_plugged</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Dedicated to the initialisation step of the brick.</span>

<span class="sd">        The main objective of this method is to produce the outputs of the</span>
<span class="sd">        bricks (self.outputs) and the associated tags (self.inheritance_dic),</span>
<span class="sd">        if defined here. In order not to include an output in the database,</span>
<span class="sd">        this output must be a value of the optional key &#39;notInDb&#39; of the</span>
<span class="sd">        self.outputs dictionary. To work properly this method must return</span>
<span class="sd">        self.make_initResult() object.</span>

<span class="sd">        :param is_plugged: the state, linked or not, of the plugs.</span>
<span class="sd">        :returns: a dictionary with requirement, outputs and inheritance_dict.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Using the inheritance to ProcessMIA class, list_outputs method</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Concat_to_list_of_list</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">list_outputs</span><span class="p">()</span>

        <span class="c1"># Outputs definition and tags inheritance (optional)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">list1</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[[],</span> <span class="n">traits</span><span class="o">.</span><span class="n">Undefined</span><span class="p">]</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">list2</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="p">[],</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">Undefined</span><span class="p">,</span>
        <span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;listOflist&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">list1</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">list2</span>
            <span class="p">]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;notInDb&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;listOflist&quot;</span><span class="p">]</span>

        <span class="c1"># Return the requirement, outputs and inheritance_dict</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_initResult</span><span class="p">()</span></div>

<div class="viewcode-block" id="Concat_to_list_of_list.run_process_mia"><a class="viewcode-back" href="../../../../mia_processes.bricks.tools.html#mia_processes.bricks.tools.tools.Concat_to_list_of_list.run_process_mia">[docs]</a>    <span class="k">def</span> <span class="nf">run_process_mia</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Dedicated to the process launch step of the brick.&quot;&quot;&quot;</span>
        <span class="k">return</span></div></div>


<div class="viewcode-block" id="Delete_data"><a class="viewcode-back" href="../../../../mia_processes.bricks.tools.html#mia_processes.bricks.tools.tools.Delete_data">[docs]</a><span class="k">class</span> <span class="nc">Delete_data</span><span class="p">(</span><span class="n">ProcessMIA</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    *Delete from database data*</span>

<span class="sd">    Please, see the complete documentation for the `Delete_data brick in the</span>
<span class="sd">    mia_processes website</span>
<span class="sd">    &lt;https://populse.github.io/mia_processes/html/documentation/bricks/tools/Delete_data.html&gt;`_</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Delete_data.__init__"><a class="viewcode-back" href="../../../../mia_processes.bricks.tools.html#mia_processes.bricks.tools.tools.Delete_data.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Dedicated to the attributes initialisation / instantiation.</span>

<span class="sd">        The input and output plugs are defined here. The special</span>
<span class="sd">        &#39;self.requirement&#39; attribute (optional) is used to define the</span>
<span class="sd">        third-party products necessary for the running of the brick.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># initialisation of the objects needed for the launch of the brick</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Delete_data</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1"># Third party softwares required for the execution of the brick</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requirement</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># no need of third party software!</span>

        <span class="c1"># Inputs description</span>
        <span class="n">in_file_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Output file from a brick or a pipeline. &quot;</span>
            <span class="s2">&quot;The outputs from the history of this file &quot;</span>
            <span class="s2">&quot;will be removed.&quot;</span>
        <span class="p">)</span>
        <span class="n">to_keep_filters_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;A list of regex. Files that match those &quot;</span>
            <span class="s2">&quot;regex will be kept and the others files &quot;</span>
            <span class="s2">&quot;will be deleted. &quot;</span>
            <span class="s2">&quot;Mutually exclusive with to_remove_filters&quot;</span>
        <span class="p">)</span>
        <span class="n">to_remove_filters_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;A list of regex.  Files that match those &quot;</span>
            <span class="s2">&quot;regex will be deleted and the others files &quot;</span>
            <span class="s2">&quot;will be kept. &quot;</span>
            <span class="s2">&quot;Mutually exclusive with to_keep_filters&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Outputs description</span>
        <span class="n">files_removed_desc</span> <span class="o">=</span> <span class="s2">&quot;List of files removed from database&quot;</span>

        <span class="c1"># Inputs traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;in_file&quot;</span><span class="p">,</span> <span class="n">traits</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">in_file_desc</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">in_file</span> <span class="o">=</span> <span class="n">traits</span><span class="o">.</span><span class="n">Undefined</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;to_keep_filters&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">to_keep_filters_desc</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="c1"># default for mriqc pipeline</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">to_keep_filters</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;(.)*pdf&quot;</span><span class="p">,</span>
            <span class="s2">&quot;(.)*_qc.json&quot;</span><span class="p">,</span>
            <span class="s2">&quot;(.)*desc-carpet(.)*&quot;</span><span class="p">,</span>
        <span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;to_remove_filters&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">to_remove_filters_desc</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="c1"># Outputs traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;files_removed&quot;</span><span class="p">,</span> <span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">files_removed_desc</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">files_removed</span> <span class="o">=</span> <span class="n">traits</span><span class="o">.</span><span class="n">Undefined</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">init_default_traits</span><span class="p">()</span></div>

<div class="viewcode-block" id="Delete_data.list_outputs"><a class="viewcode-back" href="../../../../mia_processes.bricks.tools.html#mia_processes.bricks.tools.tools.Delete_data.list_outputs">[docs]</a>    <span class="k">def</span> <span class="nf">list_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_plugged</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Dedicated to the initialisation step of the brick.</span>
<span class="sd">        The main objective of this method is to produce the outputs of the</span>
<span class="sd">        bricks (self.outputs) and the associated tags (self.inheritance_dic),</span>
<span class="sd">        if defined here. In order not to include an output in the database,</span>
<span class="sd">        this output must be a value of the optional key &#39;notInDb&#39; of the</span>
<span class="sd">        self.outputs dictionary. To work properly this method must return</span>
<span class="sd">        self.make_initResult() object.</span>
<span class="sd">        :param is_plugged: the state, linked or not, of the plugs.</span>
<span class="sd">        :returns: a dictionary with requirement, outputs and inheritance_dict.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">Delete_data</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">list_outputs</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_keep_filters</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_remove_filters</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Delete_data brick: Initialisation failed. to_keep_filters &quot;</span>
                <span class="s2">&quot;and to_remove_filter parameters are mutually exclusive...!&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># Get history of the file</span>
        <span class="c1"># to get all the outputfile of the pipeline/brick</span>
        <span class="n">file_position</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">in_file</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">getName</span><span class="p">())</span>
            <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">getName</span><span class="p">())</span>
            <span class="o">+</span> <span class="mi">1</span>
        <span class="p">)</span>
        <span class="n">file_database_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_file</span><span class="p">[</span><span class="n">file_position</span><span class="p">:]</span>

        <span class="n">procs</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">get_data_history_processes</span><span class="p">(</span><span class="n">file_database_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">)</span>
        <span class="n">outputs_filename</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">procs</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">proc</span> <span class="ow">in</span> <span class="n">procs</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">proc</span><span class="o">.</span><span class="n">used</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">proc</span><span class="o">.</span><span class="n">brick</span><span class="p">[</span><span class="n">BRICK_OUTPUTS</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                        <span class="n">filenames</span> <span class="o">=</span> <span class="n">get_filenames_in_value</span><span class="p">(</span>
                            <span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="n">allow_temp</span><span class="o">=</span><span class="kc">False</span>
                        <span class="p">)</span>
                        <span class="n">outputs_filename</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">filenames</span><span class="p">)</span>

        <span class="n">outputs_filename</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">outputs_filename</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">outputs_filename</span><span class="p">:</span>
            <span class="c1"># remove file to keep using to_keep_filter</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_keep_filters</span><span class="p">:</span>
                <span class="k">for</span> <span class="nb">filter</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_keep_filters</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;&quot;</span> <span class="o">+</span> <span class="nb">filter</span><span class="p">,</span> <span class="n">file</span><span class="p">):</span>
                        <span class="n">outputs_filename</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
            <span class="c1"># get file to remove using to_remove_filter</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_remove_filters</span><span class="p">:</span>
                <span class="k">for</span> <span class="nb">filter</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_remove_filters</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;&quot;</span> <span class="o">+</span> <span class="nb">filter</span><span class="p">,</span> <span class="n">file</span><span class="p">):</span>
                        <span class="n">outputs_filename</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">files_removed</span> <span class="o">=</span> <span class="n">outputs_filename</span>
        <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">outputs_filename</span><span class="p">:</span>
            <span class="c1"># Remove document from database</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">remove_document</span><span class="p">(</span><span class="n">COLLECTION_CURRENT</span><span class="p">,</span> <span class="n">doc</span><span class="p">)</span>
            <span class="n">full_doc_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">folder</span><span class="p">,</span> <span class="n">doc</span><span class="p">)</span>
            <span class="c1"># Remove from project</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">full_doc_path</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">full_doc_path</span><span class="p">)</span>

        <span class="c1"># Return the requirement, outputs and inheritance_dict</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_initResult</span><span class="p">()</span></div>

<div class="viewcode-block" id="Delete_data.run_process_mia"><a class="viewcode-back" href="../../../../mia_processes.bricks.tools.html#mia_processes.bricks.tools.tools.Delete_data.run_process_mia">[docs]</a>    <span class="k">def</span> <span class="nf">run_process_mia</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Dedicated to the process launch step of the brick.&quot;&quot;&quot;</span>
        <span class="k">return</span></div></div>


<div class="viewcode-block" id="Files_To_List"><a class="viewcode-back" href="../../../../mia_processes.bricks.tools.html#mia_processes.bricks.tools.tools.Files_To_List">[docs]</a><span class="k">class</span> <span class="nc">Files_To_List</span><span class="p">(</span><span class="n">ProcessMIA</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    *From 3 file names, generating a list containing all these file names*</span>

<span class="sd">    Please, see the complete documentation for the `Files_To_List brick in</span>
<span class="sd">    the mia_processes website</span>
<span class="sd">    &lt;https://populse.github.io/mia_processes/html/documentation/bricks/tools/Files_To_List.html&gt;`_</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Files_To_List.__init__"><a class="viewcode-back" href="../../../../mia_processes.bricks.tools.html#mia_processes.bricks.tools.tools.Files_To_List.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Dedicated to the attributes initialisation/instantiation.</span>

<span class="sd">        The input and output plugs are defined here. The special</span>
<span class="sd">        &#39;self.requirement&#39; attribute (optional) is used to define the</span>
<span class="sd">        third-party products necessary for the running of the brick.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># initialisation of the objects needed for the launch of the brick</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Files_To_List</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1"># Third party softwares required for the execution of the brick</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requirement</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># no need of third party software!</span>

        <span class="c1"># Inputs description</span>
        <span class="n">file1_desc</span> <span class="o">=</span> <span class="s2">&quot;A string corresponding to an existing path file.&quot;</span>
        <span class="n">file2_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;An optional string corresponding to an existing path file.&quot;</span>
        <span class="p">)</span>
        <span class="n">file3_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;An optional string corresponding to an existing path file.&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Outputs description</span>
        <span class="n">file_list_desc</span> <span class="o">=</span> <span class="s2">&quot;A list of items which are path files.&quot;</span>

        <span class="c1"># Inputs traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;file1&quot;</span><span class="p">,</span> <span class="n">traits</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">file1_desc</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file1</span> <span class="o">=</span> <span class="n">traits</span><span class="o">.</span><span class="n">Undefined</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;file2&quot;</span><span class="p">,</span> <span class="n">traits</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">file2_desc</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file2</span> <span class="o">=</span> <span class="n">traits</span><span class="o">.</span><span class="n">Undefined</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;file3&quot;</span><span class="p">,</span> <span class="n">traits</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">file3_desc</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file3</span> <span class="o">=</span> <span class="n">traits</span><span class="o">.</span><span class="n">Undefined</span>

        <span class="c1"># Outputs traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;file_list&quot;</span><span class="p">,</span> <span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">file_list_desc</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_list</span> <span class="o">=</span> <span class="n">traits</span><span class="o">.</span><span class="n">Undefined</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">init_default_traits</span><span class="p">()</span></div>

<div class="viewcode-block" id="Files_To_List.list_outputs"><a class="viewcode-back" href="../../../../mia_processes.bricks.tools.html#mia_processes.bricks.tools.tools.Files_To_List.list_outputs">[docs]</a>    <span class="k">def</span> <span class="nf">list_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_plugged</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Dedicated to the initialisation step of the brick.</span>

<span class="sd">        The main objective of this method is to produce the outputs of the</span>
<span class="sd">        bricks (self.outputs) and the associated tags (self.inheritance_dic),</span>
<span class="sd">        if defined here. In order not to include an output in the database,</span>
<span class="sd">        this output must be a value of the optional key &#39;notInDb&#39; of the</span>
<span class="sd">        self.outputs dictionary. To work properly this method must return</span>
<span class="sd">        self.make_initResult() object.</span>

<span class="sd">        :param is_plugged: the state, linked or not, of the plugs.</span>
<span class="sd">        :returns: a dictionary with requirement, outputs and inheritance_dict.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Using the inheritance to ProcessMIA class, list_outputs method</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Files_To_List</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">list_outputs</span><span class="p">()</span>

        <span class="c1"># Outputs definition and tags inheritance (optional)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">file1</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;&lt;undefined&gt;&quot;</span><span class="p">,</span> <span class="n">traits</span><span class="o">.</span><span class="n">Undefined</span><span class="p">]:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">file2</span> <span class="ow">in</span> <span class="p">[</span>
                <span class="s2">&quot;&lt;undefined&gt;&quot;</span><span class="p">,</span>
                <span class="n">traits</span><span class="o">.</span><span class="n">Undefined</span><span class="p">,</span>
            <span class="p">]</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">file3</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;&lt;undefined&gt;&quot;</span><span class="p">,</span> <span class="n">traits</span><span class="o">.</span><span class="n">Undefined</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;file_list&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">file1</span><span class="p">]</span>

            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">file3</span> <span class="ow">in</span> <span class="p">[</span>
                <span class="s2">&quot;&lt;undefined&gt;&quot;</span><span class="p">,</span>
                <span class="n">traits</span><span class="o">.</span><span class="n">Undefined</span><span class="p">,</span>
            <span class="p">]</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">file2</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;&lt;undefined&gt;&quot;</span><span class="p">,</span> <span class="n">traits</span><span class="o">.</span><span class="n">Undefined</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;file_list&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">file1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">file2</span><span class="p">]</span>

            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">file2</span> <span class="ow">in</span> <span class="p">[</span>
                <span class="s2">&quot;&lt;undefined&gt;&quot;</span><span class="p">,</span>
                <span class="n">traits</span><span class="o">.</span><span class="n">Undefined</span><span class="p">,</span>
            <span class="p">]</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">file3</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;&lt;undefined&gt;&quot;</span><span class="p">,</span> <span class="n">traits</span><span class="o">.</span><span class="n">Undefined</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;file_list&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">file1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">file3</span><span class="p">]</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;file_list&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">file1</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">file2</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">file3</span><span class="p">,</span>
                <span class="p">]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;notInDb&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;file_list&quot;</span><span class="p">]</span>

        <span class="c1"># Return the requirement, outputs and inheritance_dict</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_initResult</span><span class="p">()</span></div>

<div class="viewcode-block" id="Files_To_List.run_process_mia"><a class="viewcode-back" href="../../../../mia_processes.bricks.tools.html#mia_processes.bricks.tools.tools.Files_To_List.run_process_mia">[docs]</a>    <span class="k">def</span> <span class="nf">run_process_mia</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Dedicated to the process launch step of the brick.&quot;&quot;&quot;</span>
        <span class="k">return</span></div></div>


<div class="viewcode-block" id="Filter_Files_List"><a class="viewcode-back" href="../../../../mia_processes.bricks.tools.html#mia_processes.bricks.tools.tools.Filter_Files_List">[docs]</a><span class="k">class</span> <span class="nc">Filter_Files_List</span><span class="p">(</span><span class="n">ProcessMIA</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    *Selects one or more (slicing) element(s) from a list*</span>

<span class="sd">    Please, see the complete documentation for the `Filter_Files_List brick</span>
<span class="sd">    in the mia_processes website</span>
<span class="sd">    &lt;https://populse.github.io/mia_processes/html/documentation/bricks/tools/Filter_Files_List.html&gt;`_</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Filter_Files_List.__init__"><a class="viewcode-back" href="../../../../mia_processes.bricks.tools.html#mia_processes.bricks.tools.tools.Filter_Files_List.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Dedicated to the attributes initialisation/instantiation.</span>

<span class="sd">        The input and output plugs are defined here. The special</span>
<span class="sd">        &#39;self.requirement&#39; attribute (optional) is used to define the</span>
<span class="sd">        third-party products necessary for the running of the brick.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># initialisation of the objects needed for the launch of the brick</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Filter_Files_List</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1"># Third party softwares required for the execution of the brick</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requirement</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># no need of third party software!</span>

        <span class="c1"># Inputs description</span>
        <span class="n">in_list_desc</span> <span class="o">=</span> <span class="s2">&quot;The list of elements to be filtered.&quot;</span>
        <span class="n">index_filter_desc</span> <span class="o">=</span> <span class="s2">&quot;A list of 0 to 2 indexes for filtering.&quot;</span>

        <span class="c1"># Outputs description</span>
        <span class="n">filtered_list_desc</span> <span class="o">=</span> <span class="s2">&quot;The corresponding filtering result (a list).&quot;</span>

        <span class="c1"># Inputs traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;in_list&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">traits</span><span class="o">.</span><span class="n">File</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">in_list_desc</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">in_list</span> <span class="o">=</span> <span class="n">traits</span><span class="o">.</span><span class="n">Undefined</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;index_filter&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">(</span>
                <span class="n">value</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">trait</span><span class="o">=</span><span class="n">traits</span><span class="o">.</span><span class="n">Range</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="kc">None</span><span class="p">),</span>
                <span class="n">minlen</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">maxlen</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">index_filter_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># Outputs traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;filtered_list&quot;</span><span class="p">,</span> <span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">filtered_list_desc</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="c1"># self.filtered_list = traits.Undefined</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">init_default_traits</span><span class="p">()</span></div>

<div class="viewcode-block" id="Filter_Files_List.list_outputs"><a class="viewcode-back" href="../../../../mia_processes.bricks.tools.html#mia_processes.bricks.tools.tools.Filter_Files_List.list_outputs">[docs]</a>    <span class="k">def</span> <span class="nf">list_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_plugged</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Dedicated to the initialisation step of the brick.</span>

<span class="sd">        The main objective of this method is to produce the outputs of the</span>
<span class="sd">        bricks (self.outputs) and the associated tags (self.inheritance_dic),</span>
<span class="sd">        if defined here. In order not to include an output in the database,</span>
<span class="sd">        this output must be a value of the optional key &#39;notInDb&#39; of the</span>
<span class="sd">        self.outputs dictionary. To work properly this method must return</span>
<span class="sd">        self.make_initResult() object.</span>

<span class="sd">        :param is_plugged: the state, linked or not, of the plugs.</span>
<span class="sd">        :returns: a dictionary with requirement, outputs and inheritance_dict.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Using the inheritance to ProcessMIA class, list_outputs method</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Filter_Files_List</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">list_outputs</span><span class="p">()</span>

        <span class="c1"># Outputs definition and tags inheritance (optional)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_list</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_list</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="s2">&quot;&lt;undefined&gt;&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">Undefined</span><span class="p">,</span>
        <span class="p">]:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_filter</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;filtered_list&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">in_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index_filter</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_filter</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_list</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;filtered_list&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">in_list</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">index_filter</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                    <span class="p">]</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Filter_Files_List brick: Initialisation failed &quot;</span>
                        <span class="s2">&quot;because the index_filter parameter is greater than &quot;</span>
                        <span class="s2">&quot;the length of the in_list parameter ...</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index_filter</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_filter</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_filter</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_filter</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_list</span><span class="p">):</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_filter</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">in_list</span><span class="p">):</span>
                            <span class="c1"># fmt: off</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;filtered_list&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_list</span><span class="p">[</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">index_filter</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">index_filter</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                            <span class="p">]</span>
                            <span class="c1"># fmt: on</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span>
                                <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Filter_Files_List brick: Initialisation &quot;</span>
                                <span class="s2">&quot;failed because the second value of the &quot;</span>
                                <span class="s2">&quot;index_filter parameter is greater than the &quot;</span>
                                <span class="s2">&quot;length of the in_list parameter ...</span><span class="se">\n</span><span class="s2">&quot;</span>
                            <span class="p">)</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span>
                            <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Filter_Files_List brick: Initialisation failed&quot;</span>
                            <span class="s2">&quot; because the first value of the index_filter &quot;</span>
                            <span class="s2">&quot;parameter is greater than the length of the &quot;</span>
                            <span class="s2">&quot;in_list parameter ...</span><span class="se">\n</span><span class="s2">&quot;</span>
                        <span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Filter_Files_List brick: Initialisation failed &quot;</span>
                        <span class="s2">&quot;because the first value of the index_filter parameter&quot;</span>
                        <span class="s2">&quot; is greater than the second ...</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;notInDb&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;filtered_list&quot;</span><span class="p">]</span>

        <span class="c1"># Return the requirement, outputs and inheritance_dict</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_initResult</span><span class="p">()</span></div>

<div class="viewcode-block" id="Filter_Files_List.run_process_mia"><a class="viewcode-back" href="../../../../mia_processes.bricks.tools.html#mia_processes.bricks.tools.tools.Filter_Files_List.run_process_mia">[docs]</a>    <span class="k">def</span> <span class="nf">run_process_mia</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Dedicated to the process launch step of the brick.&quot;&quot;&quot;</span>
        <span class="k">return</span></div></div>


<div class="viewcode-block" id="Find_In_List"><a class="viewcode-back" href="../../../../mia_processes.bricks.tools.html#mia_processes.bricks.tools.tools.Find_In_List">[docs]</a><span class="k">class</span> <span class="nc">Find_In_List</span><span class="p">(</span><span class="n">ProcessMIA</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    *From a list of files, select the 1rst element that contains a pattern*</span>

<span class="sd">    Please, see the complete documentation for the `Find_In_List brick</span>
<span class="sd">    in the mia_processes website</span>
<span class="sd">    &lt;https://populse.github.io/mia_processes/html/documentation/bricks/tools/Find_In_List.html&gt;`_</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Find_In_List.__init__"><a class="viewcode-back" href="../../../../mia_processes.bricks.tools.html#mia_processes.bricks.tools.tools.Find_In_List.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Dedicated to the attributes initialisation/instantiation.</span>

<span class="sd">        The input and output plugs are defined here. The special</span>
<span class="sd">        &#39;self.requirement&#39; attribute (optional) is used to define the</span>
<span class="sd">        third-party products necessary for the running of the brick.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Initialisation of the objects needed for the launch of the brick</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Find_In_List</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1"># Inputs description</span>
        <span class="n">in_list_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;List of files to parse. A list of items which are &quot;</span>
            <span class="s2">&quot;an existing, uncompressed file &quot;</span>
            <span class="s2">&quot;(valid extensions: [.img, .nii, .hdr]).&quot;</span>
        <span class="p">)</span>
        <span class="n">pattern_desc</span> <span class="o">=</span> <span class="s2">&quot;Pattern to look for (a string).&quot;</span>

        <span class="c1"># Outputs description</span>
        <span class="n">out_file_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;The first file found in the in_list parameter with &quot;</span>
            <span class="s2">&quot;the pattern in its name.&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Input traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;in_list&quot;</span><span class="p">,</span>
            <span class="n">InputMultiPath</span><span class="p">(</span>
                <span class="n">traits</span><span class="o">.</span><span class="n">Either</span><span class="p">(</span><span class="n">ImageFileSPM</span><span class="p">(),</span> <span class="n">traits</span><span class="o">.</span><span class="n">Undefined</span><span class="p">),</span>
                <span class="n">copyfile</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">in_list_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;pattern&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">String</span><span class="p">(</span>
                <span class="s2">&quot;0001&quot;</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">pattern_desc</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># Output traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;out_file&quot;</span><span class="p">,</span> <span class="n">ImageFileSPM</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">out_file_desc</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">init_default_traits</span><span class="p">()</span></div>

<div class="viewcode-block" id="Find_In_List.list_outputs"><a class="viewcode-back" href="../../../../mia_processes.bricks.tools.html#mia_processes.bricks.tools.tools.Find_In_List.list_outputs">[docs]</a>    <span class="k">def</span> <span class="nf">list_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_plugged</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Dedicated to the initialisation step of the brick.</span>

<span class="sd">        The main objective of this method is to produce the outputs of the</span>
<span class="sd">        bricks (self.outputs) and the associated tags (self.inheritance_dic),</span>
<span class="sd">        if defined here. In order not to include an output in the database,</span>
<span class="sd">        this output must be a value of the optional key &#39;notInDb&#39; of the</span>
<span class="sd">        self.outputs dictionary. To work properly this method must return</span>
<span class="sd">        self.make_initResult() object.</span>

<span class="sd">        :param is_plugged: the state, linked or not, of the plugs.</span>
<span class="sd">        :returns: a dictionary with requirement, outputs and inheritance_dict.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Using the inheritance to ProcessMIA class, list_outputs method</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Find_In_List</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">list_outputs</span><span class="p">()</span>

        <span class="c1"># Outputs definition and tags inheritance (optional)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_list</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_list</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="s2">&quot;&lt;undefined&gt;&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">Undefined</span><span class="p">,</span>
        <span class="p">]:</span>
            <span class="k">for</span> <span class="n">fil</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_list</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pattern</span> <span class="ow">in</span> <span class="n">fil</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;out_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fil</span>
                    <span class="k">break</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;notInDb&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;out_file&quot;</span><span class="p">]</span>

        <span class="c1"># Return the requirement, outputs and inheritance_dict</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_initResult</span><span class="p">()</span></div>

<div class="viewcode-block" id="Find_In_List.run_process_mia"><a class="viewcode-back" href="../../../../mia_processes.bricks.tools.html#mia_processes.bricks.tools.tools.Find_In_List.run_process_mia">[docs]</a>    <span class="k">def</span> <span class="nf">run_process_mia</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Dedicated to the process launch step of the brick.&quot;&quot;&quot;</span>
        <span class="k">return</span></div></div>


<div class="viewcode-block" id="Get_Conditions_From_csv"><a class="viewcode-back" href="../../../../mia_processes.bricks.tools.html#mia_processes.bricks.tools.tools.Get_Conditions_From_csv">[docs]</a><span class="k">class</span> <span class="nc">Get_Conditions_From_csv</span><span class="p">(</span><span class="n">ProcessMIA</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    *Get conditions information (conditions names, onsets and durations)</span>
<span class="sd">    for Level1Design brick using csv files.*</span>

<span class="sd">    Please, see the complete documentation for</span>
<span class="sd">    the `Get_Conditions_From_csv brick</span>
<span class="sd">    in the mia_processes website</span>
<span class="sd">    &lt;https://populse.github.io/mia_processes/html/documentation/bricks/tools/Get_Conditions_From_csv.html&gt;`_</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Get_Conditions_From_csv.__init__"><a class="viewcode-back" href="../../../../mia_processes.bricks.tools.html#mia_processes.bricks.tools.tools.Get_Conditions_From_csv.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Dedicated to the attributes initialisation/instantiation.</span>

<span class="sd">        The input and output plugs are defined here. The special</span>
<span class="sd">        &#39;self.requirement&#39; attribute (optional) is used to define the</span>
<span class="sd">        third-party products necessary for the running of the brick.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Initialisation of the objects needed for the launch of the brick</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Get_Conditions_From_csv</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1"># Inputs description</span>
        <span class="n">csv_files_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;.csv files contening the onset, one for each session &quot;</span>
            <span class="s2">&quot;(existing .csv files)&quot;</span>
        <span class="p">)</span>
        <span class="n">design_type_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Type of design for each session (List of string among &quot;</span>
            <span class="s2">&quot;bloc or event-related).&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Outputs description</span>
        <span class="n">cond_names_desc</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">cond_onsets_desc</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">cond_durations_desc</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="c1"># Input traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;csv_files&quot;</span><span class="p">,</span>
            <span class="n">InputMultiPath</span><span class="p">(</span>
                <span class="n">traits</span><span class="o">.</span><span class="n">File</span><span class="p">(),</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">csv_files_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;design_type&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">(</span>
                <span class="n">traits</span><span class="o">.</span><span class="n">Enum</span><span class="p">(</span><span class="s2">&quot;bloc&quot;</span><span class="p">,</span> <span class="s2">&quot;event-related&quot;</span><span class="p">),</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">design_type_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># Output traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;cond_names&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">(</span>
                <span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">traits</span><span class="o">.</span><span class="n">String</span><span class="p">()),</span>
                <span class="n">value</span><span class="o">=</span><span class="p">[[]],</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">cond_names_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;cond_onsets&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">(</span>
                <span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">traits</span><span class="o">.</span><span class="n">Float</span><span class="p">())),</span>
                <span class="n">value</span><span class="o">=</span><span class="p">[[[]]],</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">cond_onsets_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;cond_durations&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">(</span>
                <span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">traits</span><span class="o">.</span><span class="n">Float</span><span class="p">())),</span>
                <span class="n">value</span><span class="o">=</span><span class="p">[[[]]],</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">cond_durations_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">init_default_traits</span><span class="p">()</span></div>

<div class="viewcode-block" id="Get_Conditions_From_csv.list_outputs"><a class="viewcode-back" href="../../../../mia_processes.bricks.tools.html#mia_processes.bricks.tools.tools.Get_Conditions_From_csv.list_outputs">[docs]</a>    <span class="k">def</span> <span class="nf">list_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_plugged</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Dedicated to the initialisation step of the brick.</span>

<span class="sd">        The main objective of this method is to produce the outputs of the</span>
<span class="sd">        bricks (self.outputs) and the associated tags (self.inheritance_dic),</span>
<span class="sd">        if defined here. In order not to include an output in the database,</span>
<span class="sd">        this output must be a value of the optional key &#39;notInDb&#39; of the</span>
<span class="sd">        self.outputs dictionary. To work properly this method must return</span>
<span class="sd">        self.make_initResult() object.</span>

<span class="sd">        :param is_plugged: the state, linked or not, of the plugs.</span>
<span class="sd">        :returns: a dictionary with requirement, outputs and inheritance_dict.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Using the inheritance to ProcessMIA class, list_outputs method</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Get_Conditions_From_csv</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">list_outputs</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">csv_files</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">design_type</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Get_Conditions_From_csv brick: Initialization failed... &quot;</span>
                <span class="s2">&quot;Please precise design type for each csv file&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_initResult</span><span class="p">()</span>

        <span class="n">all_cond_names</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">all_cond_onsets</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">all_cond_durations</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">csv_file</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">csv_files</span><span class="p">):</span>
            <span class="n">cond_names</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">cond_onsets</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">cond_durations</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">design</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">design_type</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="c1"># Check extension</span>
            <span class="n">valid_bool</span><span class="p">,</span> <span class="n">in_ext</span><span class="p">,</span> <span class="n">file_name</span> <span class="o">=</span> <span class="n">checkFileExt</span><span class="p">(</span>
                <span class="n">csv_file</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;csv&quot;</span><span class="p">:</span> <span class="s2">&quot;csv&quot;</span><span class="p">}</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_bool</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Get_Conditions_From_csv brick: Initialization &quot;</span>
                    <span class="s2">&quot;failed... One of the file is not a .csv file ...!&quot;</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_initResult</span><span class="p">()</span>

            <span class="c1"># Get infos into csv</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">csv_file</span><span class="p">)</span>
            <span class="n">col_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">design</span> <span class="o">==</span> <span class="s2">&quot;bloc&quot;</span><span class="p">:</span>
                <span class="n">cond_names</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">col_name</span> <span class="ow">in</span> <span class="n">col_names</span><span class="p">:</span>
                    <span class="k">if</span> <span class="s2">&quot;duration&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">col_name</span><span class="p">:</span>
                        <span class="c1"># Check that we have duration for each condition</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">col_name</span> <span class="o">+</span> <span class="s2">&quot; duration&quot;</span><span class="p">]</span>
                            <span class="n">cond_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col_name</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span>
                                <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Get_Conditions_From_csv brick: &quot;</span>
                                <span class="s2">&quot;Initialization failed... &quot;</span>
                                <span class="s2">&quot;For block design, duration should be &quot;</span>
                                <span class="s2">&quot;in the csv file ...!&quot;</span>
                            <span class="p">)</span>
                            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_initResult</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">design</span> <span class="o">==</span> <span class="s2">&quot;event-related&quot;</span><span class="p">:</span>
                <span class="n">cond_names</span> <span class="o">=</span> <span class="n">col_names</span>

            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">cond_names</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">design</span> <span class="o">==</span> <span class="s2">&quot;event-related&quot;</span><span class="p">:</span>
                    <span class="n">cond_onsets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
                    <span class="n">cond_durations</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">elif</span> <span class="n">design</span> <span class="o">==</span> <span class="s2">&quot;bloc&quot;</span><span class="p">:</span>
                    <span class="n">cond_onsets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
                    <span class="n">cond_durations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">name</span> <span class="o">+</span> <span class="s2">&quot; duration&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                    <span class="p">)</span>

            <span class="n">all_cond_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cond_names</span><span class="p">)</span>
            <span class="n">all_cond_onsets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cond_onsets</span><span class="p">)</span>
            <span class="n">all_cond_durations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cond_durations</span><span class="p">)</span>

        <span class="c1"># Outputs definition and tags inheritance (optional)</span>
        <span class="k">if</span> <span class="n">all_cond_names</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;cond_names&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">all_cond_names</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;cond_onsets&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">all_cond_onsets</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;cond_durations&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">all_cond_durations</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;notInDb&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="s2">&quot;cond_names&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cond_onsets&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cond_durations&quot;</span><span class="p">,</span>
            <span class="p">]</span>

        <span class="c1"># Return the requirement, outputs and inheritance_dict</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_initResult</span><span class="p">()</span></div>

<div class="viewcode-block" id="Get_Conditions_From_csv.run_process_mia"><a class="viewcode-back" href="../../../../mia_processes.bricks.tools.html#mia_processes.bricks.tools.tools.Get_Conditions_From_csv.run_process_mia">[docs]</a>    <span class="k">def</span> <span class="nf">run_process_mia</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Dedicated to the process launch step of the brick.&quot;&quot;&quot;</span>
        <span class="c1"># super(Get_Conditions_From_csv, self).run_process_mia()</span>
        <span class="k">return</span></div></div>


<div class="viewcode-block" id="Get_Eprime_Info_GE2REC"><a class="viewcode-back" href="../../../../mia_processes.bricks.tools.html#mia_processes.bricks.tools.tools.Get_Eprime_Info_GE2REC">[docs]</a><span class="k">class</span> <span class="nc">Get_Eprime_Info_GE2REC</span><span class="p">(</span><span class="n">ProcessMIA</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    *Get info from an E-Prime file for GE2REC protocol*</span>

<span class="sd">    Please, see the complete documentation for the `Get_Eprime_Info_GE2REC</span>
<span class="sd">    brick in the mia_processes website</span>
<span class="sd">    &lt;https://populse.github.io/mia_processes/html/documentation/bricks/tools/Get_Eprime_Info_GE2REC.html&gt;`_</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Get_Eprime_Info_GE2REC.__init__"><a class="viewcode-back" href="../../../../mia_processes.bricks.tools.html#mia_processes.bricks.tools.tools.Get_Eprime_Info_GE2REC.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Dedicated to the attributes initialisation/instantiation.</span>

<span class="sd">        The input and output plugs are defined here. The special</span>
<span class="sd">        &#39;self.requirement&#39; attribute (optional) is used to define the</span>
<span class="sd">        third-party products necessary for the running of the brick.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Initialisation of the objects needed for the launch of the brick</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Get_Eprime_Info_GE2REC</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1"># Inputs description</span>
        <span class="n">eprime_file_desc</span> <span class="o">=</span> <span class="s2">&quot;Eprime file&quot;</span>

        <span class="c1"># Outputs description</span>
        <span class="c1"># csv_gene_desc = &quot;Onset gene&quot;</span>
        <span class="c1"># csv_reco_desc = &quot;Onset reco&quot;</span>
        <span class="c1"># csv_recall_desc = &quot;Onset recall&quot;</span>
        <span class="n">csv_encodage_reco_desc</span> <span class="o">=</span> <span class="s2">&quot;CSV file with Encoding performance &quot;</span>
        <span class="n">csv_correct_response_desc</span> <span class="o">=</span> <span class="s2">&quot;CSV file with correct responses&quot;</span>
        <span class="n">sess_regress_level1design_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Informations for sess_regress (level1design brick)&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Input traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;eprime_file&quot;</span><span class="p">,</span>
            <span class="n">File</span><span class="p">(</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">copyfile</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">eprime_file_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># Output traits</span>
        <span class="c1"># self.add_trait(</span>
        <span class="c1">#     &quot;csv_gene&quot;,</span>
        <span class="c1">#     traits.File(output=True, optional=True, desc=csv_gene_desc),</span>
        <span class="c1"># )</span>
        <span class="c1"># self.add_trait(</span>
        <span class="c1">#     &quot;csv_reco&quot;,</span>
        <span class="c1">#     traits.File(output=True, optional=True, desc=csv_reco_desc),</span>
        <span class="c1"># )</span>
        <span class="c1"># self.add_trait(</span>
        <span class="c1">#     &quot;csv_recall&quot;,</span>
        <span class="c1">#     traits.File(output=True, optional=True, desc=csv_recall_desc),</span>
        <span class="c1"># )</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;csv_encodage_reco&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">File</span><span class="p">(</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">csv_encodage_reco_desc</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;csv_correct_response&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">File</span><span class="p">(</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">csv_correct_response_desc</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;sess_regress_level1design&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">(</span>
                <span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">(</span>
                    <span class="n">traits</span><span class="o">.</span><span class="n">Dict</span><span class="p">(</span>
                        <span class="n">traits</span><span class="o">.</span><span class="n">Enum</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;val&quot;</span><span class="p">),</span>
                        <span class="n">traits</span><span class="o">.</span><span class="n">Union</span><span class="p">(</span><span class="n">traits</span><span class="o">.</span><span class="n">Str</span><span class="p">,</span> <span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">traits</span><span class="o">.</span><span class="n">Float</span><span class="p">())),</span>
                    <span class="p">)</span>
                <span class="p">),</span>
                <span class="n">value</span><span class="o">=</span><span class="p">[[]],</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">sess_regress_level1design_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">init_default_traits</span><span class="p">()</span></div>

<div class="viewcode-block" id="Get_Eprime_Info_GE2REC.list_outputs"><a class="viewcode-back" href="../../../../mia_processes.bricks.tools.html#mia_processes.bricks.tools.tools.Get_Eprime_Info_GE2REC.list_outputs">[docs]</a>    <span class="k">def</span> <span class="nf">list_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_plugged</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Dedicated to the initialisation step of the brick.</span>

<span class="sd">        The main objective of this method is to produce the outputs of the</span>
<span class="sd">        bricks (self.outputs) and the associated tags (self.inheritance_dic),</span>
<span class="sd">        if defined here. In order not to include an output in the database,</span>
<span class="sd">        this output must be a value of the optional key &#39;notInDb&#39; of the</span>
<span class="sd">        self.outputs dictionary. To work properly this method must return</span>
<span class="sd">        self.make_initResult() object.</span>

<span class="sd">        :param is_plugged: the state, linked or not, of the plugs.</span>
<span class="sd">        :returns: a dictionary with requirement, outputs and inheritance_dict.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Using the inheritance to ProcessMIA class, list_outputs method</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Get_Eprime_Info_GE2REC</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">list_outputs</span><span class="p">()</span>

        <span class="c1"># Outputs definition and tags inheritance (optional)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">eprime_file</span><span class="p">:</span>
            <span class="n">ifile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eprime_file</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">file_name</span><span class="p">,</span> <span class="n">in_ext</span> <span class="o">=</span> <span class="n">ifile</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">:</span>
                <span class="c1"># self.outputs[&quot;csv_gene&quot;] = os.path.join(</span>
                <span class="c1">#     self.output_directory, file_name + &quot;_onset_gene.csv&quot;</span>
                <span class="c1"># )</span>
                <span class="c1"># self.outputs[&quot;csv_reco&quot;] = os.path.join(</span>
                <span class="c1">#     self.output_directory, file_name + &quot;_onset_reco.csv&quot;</span>
                <span class="c1"># )</span>
                <span class="c1"># self.outputs[&quot;csv_recall&quot;] = os.path.join(</span>
                <span class="c1">#     self.output_directory, file_name + &quot;_onset_recall.csv&quot;</span>
                <span class="c1"># )</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;csv_encodage_reco&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span> <span class="n">file_name</span> <span class="o">+</span> <span class="s2">&quot;_encodage_reco.csv&quot;</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;csv_correct_response&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span>
                    <span class="n">file_name</span> <span class="o">+</span> <span class="s2">&quot;_correct_response.csv&quot;</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="c1"># Obtains all information from EPRIME files</span>
                <span class="c1"># df_gene = pd.read_excel(self.eprime_file, sheet_name=&quot;GENE&quot;)</span>
                <span class="n">df_reco</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eprime_file</span><span class="p">,</span> <span class="n">sheet_name</span><span class="o">=</span><span class="s2">&quot;RECO&quot;</span><span class="p">)</span>
                <span class="c1"># df_recall = pd.read_excel(self.eprime_file,</span>
                <span class="c1"># sheet_name=&quot;RAPPEL&quot;)</span>

                <span class="c1"># # Get onset time in second for generation task (bloc design)</span>
                <span class="c1"># zero = df_gene[&quot;SON.OnsetTime&quot;].dropna().to_list()[0]</span>
                <span class="c1"># onset_gene_eprime = (</span>
                <span class="c1">#     df_gene[df_gene[&quot;CONDITION&quot;] == &quot;task&quot;][&quot;SON.OnsetTime&quot;]</span>
                <span class="c1">#     .dropna()</span>
                <span class="c1">#     .to_list()</span>
                <span class="c1"># )</span>
                <span class="c1"># onset_gene = []</span>
                <span class="c1"># for i, time in enumerate(onset_gene_eprime):</span>
                <span class="c1">#     # block design, take only the first onset of the bloc</span>
                <span class="c1">#     if i in [0, 8, 16, 24, 32]:</span>
                <span class="c1">#         onset_gene.append((time - zero) / 1000)</span>
                <span class="c1"># onset_ctrl_eprime = (</span>
                <span class="c1">#     df_gene[</span>
                <span class="c1">#      df_gene[&quot;CONDITION&quot;] == &quot;control&quot;][&quot;SON.OnsetTime&quot;]</span>
                <span class="c1">#     .dropna()</span>
                <span class="c1">#     .to_list()</span>
                <span class="c1"># )</span>
                <span class="c1"># onset_ctrl = []</span>
                <span class="c1"># for i, time in enumerate(onset_ctrl_eprime):</span>
                <span class="c1">#     if i in [0, 8, 16, 24, 32]:</span>
                <span class="c1">#         onset_ctrl.append((time - zero) / 1000)</span>

                <span class="c1"># data = {</span>
                <span class="c1">#     &quot;GENE&quot;: onset_gene,</span>
                <span class="c1">#     &quot;GENE duration&quot;: [40] * len(onset_gene),</span>
                <span class="c1">#     &quot;CONTROL&quot;: onset_ctrl,</span>
                <span class="c1">#     &quot;CONTROL duration&quot;: [40] * len(onset_ctrl),</span>
                <span class="c1"># }</span>
                <span class="c1"># df_onset_gene = pd.DataFrame(data)</span>
                <span class="c1"># df_onset_gene.to_csv(self.outputs[&quot;csv_gene&quot;], index=False)</span>

                <span class="c1"># # Get onset time in second for reco (event)</span>
                <span class="c1"># zero = df_reco[&quot;image.OnsetTime&quot;].dropna().to_list()[0]</span>
                <span class="c1"># onset_new_eprime = (</span>
                <span class="c1">#     df_reco[df_reco[&quot;CONDITION&quot;] == &quot;NEW&quot;][&quot;image.OnsetTime&quot;]</span>
                <span class="c1">#     .dropna()</span>
                <span class="c1">#     .to_list()</span>
                <span class="c1"># )</span>
                <span class="c1"># onset_new = []</span>
                <span class="c1"># for time in onset_new_eprime:</span>
                <span class="c1">#     onset_new.append((time - zero) / 1000)</span>
                <span class="c1"># onset_ctrl_eprime = (</span>
                <span class="c1">#     df_reco[df_reco[&quot;CONDITION&quot;] == &quot;CONTROL&quot;][</span>
                <span class="c1">#         &quot;image.OnsetTime&quot;</span>
                <span class="c1">#     ]</span>
                <span class="c1">#     .dropna()</span>
                <span class="c1">#     .to_list()</span>
                <span class="c1"># )</span>
                <span class="c1"># onset_ctrl = []</span>
                <span class="c1"># for time in onset_ctrl_eprime:</span>
                <span class="c1">#     onset_ctrl.append((time - zero) / 1000)</span>
                <span class="c1"># onset_old_eprime = (</span>
                <span class="c1">#     df_reco[df_reco[&quot;CONDITION&quot;] == &quot;OLD&quot;][&quot;image.OnsetTime&quot;]</span>
                <span class="c1">#     .dropna()</span>
                <span class="c1">#     .to_list()</span>
                <span class="c1"># )</span>
                <span class="c1"># onset_old = []</span>
                <span class="c1"># for time in onset_old_eprime:</span>
                <span class="c1">#     onset_old.append((time - zero) / 1000)</span>
                <span class="c1"># data = {</span>
                <span class="c1">#     &quot;OLD&quot;: onset_old,</span>
                <span class="c1">#     &quot;CONTROL&quot;: onset_ctrl,</span>
                <span class="c1">#     &quot;NEW&quot;: onset_new,</span>
                <span class="c1"># }</span>
                <span class="c1"># df_onset_reco = pd.DataFrame(data)</span>
                <span class="c1"># df_onset_reco.to_csv(self.outputs[&quot;csv_reco&quot;], index=False)</span>

                <span class="c1"># Get encodage regressor from reco</span>
                <span class="c1"># Create a dataframe with only the OLD condition</span>
                <span class="c1"># And get encodage, if good anwser = 2 and if not encodage = 1</span>
                <span class="n">df_old</span> <span class="o">=</span> <span class="n">df_reco</span><span class="p">[</span><span class="n">df_reco</span><span class="p">[</span><span class="s2">&quot;CONDITION&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;OLD&quot;</span><span class="p">]</span>
                <span class="n">info_responses</span> <span class="o">=</span> <span class="n">df_old</span><span class="p">[</span>
                    <span class="p">[</span><span class="s2">&quot;IMAGE&quot;</span><span class="p">,</span> <span class="s2">&quot;REPONSE&quot;</span><span class="p">,</span> <span class="s2">&quot;image.RESP&quot;</span><span class="p">]</span>
                <span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="s2">&quot;records&quot;</span><span class="p">)</span>
                <span class="n">encodage_old</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">good_response_old</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">bad_response_old</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">info_responses</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;image.RESP&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;REPONSE&quot;</span><span class="p">]:</span>
                        <span class="n">encodage_old</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                        <span class="n">good_response_old</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># bad response or no response</span>
                        <span class="n">encodage_old</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                        <span class="n">bad_response_old</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">cr_old</span> <span class="o">=</span> <span class="p">(</span><span class="n">good_response_old</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">info_responses</span><span class="p">))</span> <span class="o">*</span> <span class="mi">100</span>
                <span class="n">er_old</span> <span class="o">=</span> <span class="p">(</span><span class="n">bad_response_old</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">info_responses</span><span class="p">))</span> <span class="o">*</span> <span class="mi">100</span>

                <span class="k">def</span> <span class="nf">sort_list</span><span class="p">(</span><span class="n">list1</span><span class="p">,</span> <span class="n">list2</span><span class="p">):</span>
<span class="w">                    </span><span class="sd">&quot;&quot;&quot;Sort list1 using list2 order&quot;&quot;&quot;</span>
                    <span class="n">zipped_pairs</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">list2</span><span class="p">,</span> <span class="n">list1</span><span class="p">)</span>
                    <span class="n">z</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">zipped_pairs</span><span class="p">)]</span>
                    <span class="k">return</span> <span class="n">z</span>

                <span class="c1"># Sort encodage following the order during generation task</span>
                <span class="n">order_gene</span> <span class="o">=</span> <span class="n">df_old</span><span class="p">[</span><span class="s2">&quot;ORDRE_GENERATION&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
                <span class="n">encodage_old_sort</span> <span class="o">=</span> <span class="n">sort_list</span><span class="p">(</span><span class="n">encodage_old</span><span class="p">,</span> <span class="n">order_gene</span><span class="p">)</span>
                <span class="c1"># Duplicate encodage because generation during 2TR</span>
                <span class="n">encodage_old</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">encodage_old_sort</span><span class="p">:</span>
                    <span class="n">encodage_old</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">])</span>
                <span class="c1"># Add encodage = 0 during rest and  1 during controlcontrol</span>
                <span class="c1"># rest = 4 TR ctrl = 8 * 2TR</span>
                <span class="n">encodage_old_all</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">encodage_old_all</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">encodage_old</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">16</span><span class="p">])</span>
                <span class="n">encodage_old_all</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span>
                <span class="n">encodage_old_all</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">16</span><span class="p">)</span>
                <span class="n">encodage_old_all</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">encodage_old</span><span class="p">[</span><span class="mi">16</span><span class="p">:</span><span class="mi">32</span><span class="p">])</span>
                <span class="n">encodage_old_all</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span>
                <span class="n">encodage_old_all</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">16</span><span class="p">)</span>
                <span class="n">encodage_old_all</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">encodage_old</span><span class="p">[</span><span class="mi">32</span><span class="p">:</span><span class="mi">48</span><span class="p">])</span>
                <span class="n">encodage_old_all</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span>
                <span class="n">encodage_old_all</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">16</span><span class="p">)</span>
                <span class="n">encodage_old_all</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">encodage_old</span><span class="p">[</span><span class="mi">48</span><span class="p">:</span><span class="mi">64</span><span class="p">])</span>
                <span class="n">encodage_old_all</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span>
                <span class="n">encodage_old_all</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">16</span><span class="p">)</span>
                <span class="n">encodage_old_all</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">encodage_old</span><span class="p">[</span><span class="mi">64</span><span class="p">:</span><span class="mi">80</span><span class="p">])</span>
                <span class="n">encodage_old_all</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span>
                <span class="n">encodage_old_all</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">16</span><span class="p">)</span>

                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;csv_encodage_reco&quot;</span><span class="p">],</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span>
                <span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">write</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                    <span class="n">write</span><span class="o">.</span><span class="n">writerow</span><span class="p">([</span><span class="s2">&quot;ENCODAGE&quot;</span><span class="p">])</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">encodage_old_all</span><span class="p">:</span>
                        <span class="n">write</span><span class="o">.</span><span class="n">writerow</span><span class="p">([</span><span class="n">i</span><span class="p">])</span>

                <span class="c1"># Variable for level1design brick</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;sess_regress_level1design&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">[{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;ENCODAGE&quot;</span><span class="p">,</span> <span class="s2">&quot;val&quot;</span><span class="p">:</span> <span class="n">encodage_old_all</span><span class="p">}]</span>
                <span class="p">]</span>

                <span class="c1"># Get correct response / error for NEW condition</span>
                <span class="n">df_new</span> <span class="o">=</span> <span class="n">df_reco</span><span class="p">[</span><span class="n">df_reco</span><span class="p">[</span><span class="s2">&quot;CONDITION&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;NEW&quot;</span><span class="p">]</span>
                <span class="n">info_responses</span> <span class="o">=</span> <span class="n">df_new</span><span class="p">[</span>
                    <span class="p">[</span><span class="s2">&quot;IMAGE&quot;</span><span class="p">,</span> <span class="s2">&quot;REPONSE&quot;</span><span class="p">,</span> <span class="s2">&quot;image.RESP&quot;</span><span class="p">]</span>
                <span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="s2">&quot;records&quot;</span><span class="p">)</span>
                <span class="n">good_response_new</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">bad_response_new</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">info_responses</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;image.RESP&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;REPONSE&quot;</span><span class="p">]:</span>
                        <span class="n">good_response_new</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># bad response or no response</span>
                        <span class="n">bad_response_new</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">cr_new</span> <span class="o">=</span> <span class="p">(</span><span class="n">good_response_new</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">info_responses</span><span class="p">))</span> <span class="o">*</span> <span class="mi">100</span>
                <span class="n">er_new</span> <span class="o">=</span> <span class="p">(</span><span class="n">bad_response_new</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">info_responses</span><span class="p">))</span> <span class="o">*</span> <span class="mi">100</span>

                <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;correct_old&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">cr_old</span><span class="p">],</span>
                    <span class="s2">&quot;error_old&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">er_old</span><span class="p">],</span>
                    <span class="s2">&quot;correct_new&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">cr_new</span><span class="p">],</span>
                    <span class="s2">&quot;error_new&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">er_new</span><span class="p">],</span>
                <span class="p">}</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;csv_correct_response&quot;</span><span class="p">],</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">:</span>
            <span class="c1"># self.tags_inheritance(</span>
            <span class="c1">#     in_file=self.eprime_file, out_file=self.outputs[&quot;csv_gene&quot;]</span>
            <span class="c1"># )</span>
            <span class="c1"># self.tags_inheritance(</span>
            <span class="c1">#     in_file=self.eprime_file, out_file=self.outputs[&quot;csv_reco&quot;]</span>
            <span class="c1"># )</span>
            <span class="c1"># self.tags_inheritance(</span>
            <span class="c1">#     in_file=self.eprime_file, out_file=self.outputs[&quot;csv_recall&quot;]</span>
            <span class="c1"># )</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tags_inheritance</span><span class="p">(</span>
                <span class="n">in_file</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">eprime_file</span><span class="p">,</span>
                <span class="n">out_file</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;csv_encodage_reco&quot;</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tags_inheritance</span><span class="p">(</span>
                <span class="n">in_file</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">eprime_file</span><span class="p">,</span>
                <span class="n">out_file</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;csv_correct_response&quot;</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;notInDb&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;sess_regress_level1design&quot;</span><span class="p">]</span>

        <span class="c1"># Return the requirement, outputs and inheritance_dict</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_initResult</span><span class="p">()</span></div>

<div class="viewcode-block" id="Get_Eprime_Info_GE2REC.run_process_mia"><a class="viewcode-back" href="../../../../mia_processes.bricks.tools.html#mia_processes.bricks.tools.tools.Get_Eprime_Info_GE2REC.run_process_mia">[docs]</a>    <span class="k">def</span> <span class="nf">run_process_mia</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Dedicated to the process launch step of the brick.&quot;&quot;&quot;</span>
        <span class="c1"># super(Get_Eprime_Info_GE2REC, self).run_process_mia()</span>
        <span class="k">return</span></div></div>


<div class="viewcode-block" id="Get_Patient_Name"><a class="viewcode-back" href="../../../../mia_processes.bricks.tools.html#mia_processes.bricks.tools.tools.Get_Patient_Name">[docs]</a><span class="k">class</span> <span class="nc">Get_Patient_Name</span><span class="p">(</span><span class="n">ProcessMIA</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    *Get patient name from a file*</span>

<span class="sd">    Please, see the complete documentation for the `Get_Patient_Name brick</span>
<span class="sd">    in the mia_processes website</span>
<span class="sd">    &lt;https://populse.github.io/mia_processes/html/documentation/bricks/tools/Get_Patient_Name.html&gt;`_</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Get_Patient_Name.__init__"><a class="viewcode-back" href="../../../../mia_processes.bricks.tools.html#mia_processes.bricks.tools.tools.Get_Patient_Name.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Dedicated to the attributes initialisation/instantiation.</span>

<span class="sd">        The input and output plugs are defined here. The special</span>
<span class="sd">        &#39;self.requirement&#39; attribute (optional) is used to define the</span>
<span class="sd">        third-party products necessary for the running of the brick.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Initialisation of the objects needed for the launch of the brick</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Get_Patient_Name</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1"># Inputs description</span>
        <span class="n">in_file_desc</span> <span class="o">=</span> <span class="s2">&quot;In file&quot;</span>

        <span class="c1"># Outputs description</span>
        <span class="n">patient_name_desc</span> <span class="o">=</span> <span class="s2">&quot;Patient name.&quot;</span>

        <span class="c1"># Input traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;in_file&quot;</span><span class="p">,</span>
            <span class="n">File</span><span class="p">(</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">copyfile</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">in_file_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># Output traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;patient_name&quot;</span><span class="p">,</span> <span class="n">traits</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">patient_name_desc</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">init_default_traits</span><span class="p">()</span></div>

<div class="viewcode-block" id="Get_Patient_Name.list_outputs"><a class="viewcode-back" href="../../../../mia_processes.bricks.tools.html#mia_processes.bricks.tools.tools.Get_Patient_Name.list_outputs">[docs]</a>    <span class="k">def</span> <span class="nf">list_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_plugged</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Dedicated to the initialisation step of the brick.</span>

<span class="sd">        The main objective of this method is to produce the outputs of the</span>
<span class="sd">        bricks (self.outputs) and the associated tags (self.inheritance_dic),</span>
<span class="sd">        if defined here. In order not to include an output in the database,</span>
<span class="sd">        this output must be a value of the optional key &#39;notInDb&#39; of the</span>
<span class="sd">        self.outputs dictionary. To work properly this method must return</span>
<span class="sd">        self.make_initResult() object.</span>

<span class="sd">        :param is_plugged: the state, linked or not, of the plugs.</span>
<span class="sd">        :returns: a dictionary with requirement, outputs and inheritance_dict.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Using the inheritance to ProcessMIA class, list_outputs method</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Get_Patient_Name</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">list_outputs</span><span class="p">()</span>

        <span class="c1"># Outputs definition and tags inheritance (optional)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_file</span><span class="p">:</span>
            <span class="n">sub_name</span> <span class="o">=</span> <span class="n">get_dbFieldValue</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_file</span><span class="p">,</span> <span class="s2">&quot;PatientName&quot;</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">sub_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s2">&quot;(Get_Patient_Name brick: Please, fill &#39;PatientName&#39; tag &quot;</span>
                    <span class="s2">&quot;in the database for in file&quot;</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_initResult</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;patient_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sub_name</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;notInDb&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;patient_name&quot;</span><span class="p">]</span>

        <span class="c1"># Return the requirement, outputs and inheritance_dict</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_initResult</span><span class="p">()</span></div>

<div class="viewcode-block" id="Get_Patient_Name.run_process_mia"><a class="viewcode-back" href="../../../../mia_processes.bricks.tools.html#mia_processes.bricks.tools.tools.Get_Patient_Name.run_process_mia">[docs]</a>    <span class="k">def</span> <span class="nf">run_process_mia</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Dedicated to the process launch step of the brick.&quot;&quot;&quot;</span>
        <span class="k">return</span></div></div>


<div class="viewcode-block" id="Get_Regressors_From_csv"><a class="viewcode-back" href="../../../../mia_processes.bricks.tools.html#mia_processes.bricks.tools.tools.Get_Regressors_From_csv">[docs]</a><span class="k">class</span> <span class="nc">Get_Regressors_From_csv</span><span class="p">(</span><span class="n">ProcessMIA</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    *Get regressors information (regressors names, values and session)</span>
<span class="sd">    for Level1Design brick using csv files.*</span>

<span class="sd">    Please, see the complete documentation for</span>
<span class="sd">    the `Get_Regressors_From_csv brick</span>
<span class="sd">    in the mia_processes website</span>
<span class="sd">    &lt;https://populse.github.io/mia_processes/html/documentation/bricks/tools/Get_Regressors_From_csv.html&gt;`_</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Get_Regressors_From_csv.__init__"><a class="viewcode-back" href="../../../../mia_processes.bricks.tools.html#mia_processes.bricks.tools.tools.Get_Regressors_From_csv.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Dedicated to the attributes initialisation/instantiation.</span>

<span class="sd">        The input and output plugs are defined here. The special</span>
<span class="sd">        &#39;self.requirement&#39; attribute (optional) is used to define the</span>
<span class="sd">        third-party products necessary for the running of the brick.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Initialisation of the objects needed for the launch of the brick</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Get_Regressors_From_csv</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1"># Inputs description</span>
        <span class="n">csv_files_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;.csv files contening the regressors (one column by regressors),&quot;</span>
            <span class="s2">&quot;one for each session (existing .csv files)&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Outputs description</span>
        <span class="n">sess_regress_level1design_desc</span> <span class="o">=</span> <span class="s2">&quot;Informations for sess_regress&quot;</span>

        <span class="c1"># Input traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;csv_files&quot;</span><span class="p">,</span>
            <span class="n">InputMultiPath</span><span class="p">(</span>
                <span class="n">traits</span><span class="o">.</span><span class="n">File</span><span class="p">(),</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">csv_files_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># Output traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;sess_regress_level1design&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">(</span>
                <span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">(</span>
                    <span class="n">traits</span><span class="o">.</span><span class="n">Dict</span><span class="p">(</span>
                        <span class="n">traits</span><span class="o">.</span><span class="n">Enum</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;val&quot;</span><span class="p">),</span>
                        <span class="n">traits</span><span class="o">.</span><span class="n">Union</span><span class="p">(</span><span class="n">traits</span><span class="o">.</span><span class="n">Str</span><span class="p">,</span> <span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">traits</span><span class="o">.</span><span class="n">Float</span><span class="p">())),</span>
                    <span class="p">)</span>
                <span class="p">),</span>
                <span class="n">value</span><span class="o">=</span><span class="p">[[]],</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">sess_regress_level1design_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">init_default_traits</span><span class="p">()</span></div>

<div class="viewcode-block" id="Get_Regressors_From_csv.list_outputs"><a class="viewcode-back" href="../../../../mia_processes.bricks.tools.html#mia_processes.bricks.tools.tools.Get_Regressors_From_csv.list_outputs">[docs]</a>    <span class="k">def</span> <span class="nf">list_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_plugged</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Dedicated to the initialisation step of the brick.</span>

<span class="sd">        The main objective of this method is to produce the outputs of the</span>
<span class="sd">        bricks (self.outputs) and the associated tags (self.inheritance_dic),</span>
<span class="sd">        if defined here. In order not to include an output in the database,</span>
<span class="sd">        this output must be a value of the optional key &#39;notInDb&#39; of the</span>
<span class="sd">        self.outputs dictionary. To work properly this method must return</span>
<span class="sd">        self.make_initResult() object.</span>

<span class="sd">        :param is_plugged: the state, linked or not, of the plugs.</span>
<span class="sd">        :returns: a dictionary with requirement, outputs and inheritance_dict.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Using the inheritance to ProcessMIA class, list_outputs method</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Get_Regressors_From_csv</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">list_outputs</span><span class="p">()</span>
        <span class="n">sess_regress_level1design</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">csv_file</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">csv_files</span><span class="p">:</span>
            <span class="c1"># Check extension</span>
            <span class="n">valid_bool</span><span class="p">,</span> <span class="n">in_ext</span><span class="p">,</span> <span class="n">file_name</span> <span class="o">=</span> <span class="n">checkFileExt</span><span class="p">(</span>
                <span class="n">csv_file</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;csv&quot;</span><span class="p">:</span> <span class="s2">&quot;csv&quot;</span><span class="p">}</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_bool</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Get_Regressors_From_csv brick: Initialization &quot;</span>
                    <span class="s2">&quot;failed... One of the file is not a .csv file ...!&quot;</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_initResult</span><span class="p">()</span>

            <span class="n">regressor_sess</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">csv_file</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">dico</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">col</span><span class="p">,</span> <span class="s2">&quot;val&quot;</span><span class="p">:</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()}</span>
                <span class="n">regressor_sess</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dico</span><span class="p">)</span>
            <span class="n">sess_regress_level1design</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">regressor_sess</span><span class="p">)</span>

        <span class="c1"># Outputs definition and tags inheritance (optional)</span>
        <span class="k">if</span> <span class="n">sess_regress_level1design</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;sess_regress_level1design&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">sess_regress_level1design</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;notInDb&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="s2">&quot;sess_regress_level1design&quot;</span><span class="p">,</span>
            <span class="p">]</span>

        <span class="c1"># Return the requirement, outputs and inheritance_dict</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_initResult</span><span class="p">()</span></div>

<div class="viewcode-block" id="Get_Regressors_From_csv.run_process_mia"><a class="viewcode-back" href="../../../../mia_processes.bricks.tools.html#mia_processes.bricks.tools.tools.Get_Regressors_From_csv.run_process_mia">[docs]</a>    <span class="k">def</span> <span class="nf">run_process_mia</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Dedicated to the process launch step of the brick.&quot;&quot;&quot;</span>
        <span class="c1"># super(Get_Regressors_From_csv, self).run_process_mia()</span>
        <span class="k">return</span></div></div>


<div class="viewcode-block" id="Import_Data"><a class="viewcode-back" href="../../../../mia_processes.bricks.tools.html#mia_processes.bricks.tools.tools.Import_Data">[docs]</a><span class="k">class</span> <span class="nc">Import_Data</span><span class="p">(</span><span class="n">ProcessMIA</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    *Import reference data into the current pipeline*</span>

<span class="sd">    - This brick was originally written to select regions of interest.</span>
<span class="sd">      The rois_list parameter is used to filter the data to be imported from</span>
<span class="sd">      a library defined by lib_dir. If roi_list is a list, each element of</span>
<span class="sd">      it will be a filename filter applied for retrieval. If roi_list is a</span>
<span class="sd">      list of lists, the filters will result from concatenating the elements</span>
<span class="sd">      of each internal list (e.g. [[&quot;foo&quot;, &quot;1&quot;], [&quot;faa&quot;, &quot;2&quot;]] gives two</span>
<span class="sd">      filters, &quot;foo_1&quot; and &quot;faa_2&quot;.</span>
<span class="sd">    - If lib_dir is not set, use the miaresources/ROIs/ file.</span>
<span class="sd">    - The file_in_db file is used only to retrieve the value of the</span>
<span class="sd">      associated PatientName tag.</span>
<span class="sd">    - The reference data is imported into the</span>
<span class="sd">      output_directory/PatientName_data/ROI_data/raw_data directory.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Import_Data.__init__"><a class="viewcode-back" href="../../../../mia_processes.bricks.tools.html#mia_processes.bricks.tools.tools.Import_Data.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Dedicated to the attributes initialisation/instantiation.</span>

<span class="sd">        The input and output plugs are defined here. The special</span>
<span class="sd">        &#39;self.requirement&#39; attribute (optional) is used to define the</span>
<span class="sd">        third-party products necessary for the running of the brick.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># initialisation of the objects needed for the launch of the brick</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Import_Data</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1"># Inputs description</span>
        <span class="n">rois_list_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;A list or a list of lists of strings, defining the &quot;</span>
            <span class="s2">&quot;data to import.&quot;</span>
        <span class="p">)</span>
        <span class="n">lib_dir_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;The path to a data library (if not defined, it uses &quot;</span>
            <span class="s2">&quot;the default resources path, i.e. miaresources/ROIs/).&quot;</span>
        <span class="p">)</span>
        <span class="n">file_in_db_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;A file in database, only used to catch &quot;</span>
            <span class="s2">&quot;the PatientName tag value.&quot;</span>
        <span class="p">)</span>
        <span class="n">starts_with_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;If True applies the file filter only to the &quot;</span>
            <span class="s2">&quot;beginning of the names, otherwise to the whole &quot;</span>
            <span class="s2">&quot;names (a boolean).&quot;</span>
        <span class="p">)</span>
        <span class="c1"># Outputs description</span>
        <span class="n">rois_files_desc</span> <span class="o">=</span> <span class="s2">&quot;The list of resulting available files.&quot;</span>

        <span class="c1"># Inputs traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;rois_list&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">Either</span><span class="p">(</span>
                <span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">traits</span><span class="o">.</span><span class="n">String</span><span class="p">()),</span>
                <span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">(</span>
                    <span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">(</span>
                        <span class="n">traits</span><span class="o">.</span><span class="n">String</span><span class="p">(),</span>
                        <span class="n">minlen</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                        <span class="n">maxlen</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">),</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">rois_list_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">),</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;lib_dir&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">Directory</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">lib_dir_desc</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lib_dir</span> <span class="o">=</span> <span class="n">traits</span><span class="o">.</span><span class="n">Undefined</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;file_in_db&quot;</span><span class="p">,</span>
            <span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">file_in_db_desc</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;starts_with&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">Bool</span><span class="p">(</span>
                <span class="n">default_value</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">starts_with_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># Outputs traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;rois_files&quot;</span><span class="p">,</span>
            <span class="n">OutputMultiPath</span><span class="p">(</span><span class="n">File</span><span class="p">(),</span> <span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">rois_files_desc</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># Special parameter used as a messenger for the run_process_mia method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;dict4runtime&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">Dict</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">userlevel</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">init_default_traits</span><span class="p">()</span></div>

<div class="viewcode-block" id="Import_Data.list_outputs"><a class="viewcode-back" href="../../../../mia_processes.bricks.tools.html#mia_processes.bricks.tools.tools.Import_Data.list_outputs">[docs]</a>    <span class="k">def</span> <span class="nf">list_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_plugged</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Dedicated to the initialisation step of the brick.</span>

<span class="sd">        The main objective of this method is to produce the outputs of the</span>
<span class="sd">        bricks (self.outputs) and the associated tags (self.inheritance_dic),</span>
<span class="sd">        if defined here. In order not to include an output in the database,</span>
<span class="sd">        this output must be a value of the optional key &#39;notInDb&#39; of the</span>
<span class="sd">        self.outputs dictionary. To work properly this method must return</span>
<span class="sd">        self.make_initResult() object.</span>

<span class="sd">        :param is_plugged: the state, linked or not, of the plugs.</span>
<span class="sd">        :returns: a dictionary with requirement, outputs and inheritance_dict.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Using the inheritance to ProcessMIA class, list_outputs method</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Import_Data</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">list_outputs</span><span class="p">()</span>

        <span class="c1"># Outputs definition and tags inheritance (optional)</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rois_list</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="n">traits</span><span class="o">.</span><span class="n">Undefined</span><span class="p">,</span> <span class="p">[],</span> <span class="p">[[]])</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_in_db</span> <span class="o">!=</span> <span class="n">traits</span><span class="o">.</span><span class="n">Undefined</span>
        <span class="p">):</span>
            <span class="n">patient_name</span> <span class="o">=</span> <span class="n">get_dbFieldValue</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_in_db</span><span class="p">,</span> <span class="s2">&quot;PatientName&quot;</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">patient_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Import_Data brick:</span><span class="se">\n</span><span class="s2"> The &#39;PatientName&#39; tag is not &quot;</span>
                    <span class="s2">&quot;filled in the database for the </span><span class="si">{}</span><span class="s2"> file ...</span><span class="se">\n</span><span class="s2"> The &quot;</span>
                    <span class="s2">&quot;calculation is aborted...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_in_db</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_initResult</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">dict4runtime</span><span class="p">[</span><span class="s2">&quot;patient_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">patient_name</span>
            <span class="n">roi_raw_data_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span>
                <span class="n">patient_name</span> <span class="o">+</span> <span class="s2">&quot;_data&quot;</span><span class="p">,</span>
                <span class="s2">&quot;ROI_data&quot;</span><span class="p">,</span>
                <span class="s2">&quot;raw_data&quot;</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lib_dir</span> <span class="ow">in</span> <span class="p">(</span><span class="n">traits</span><span class="o">.</span><span class="n">Undefined</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">):</span>
                <span class="n">config</span> <span class="o">=</span> <span class="n">Config</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lib_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="n">config</span><span class="o">.</span><span class="n">get_resources_path</span><span class="p">(),</span> <span class="s2">&quot;ROIs&quot;</span>
                <span class="p">)</span>

            <span class="c1"># list the content of self.lib_dir</span>
            <span class="n">elts</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lib_dir</span><span class="p">)</span>
            <span class="c1"># filtering only the files</span>
            <span class="n">all_ref_files</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">f</span>
                <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">elts</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lib_dir</span><span class="p">,</span> <span class="n">f</span><span class="p">))</span>
            <span class="p">]</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rois_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">filters</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">rois_list</span><span class="p">]</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">filters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rois_list</span>

            <span class="n">list_out</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">ref_file</span> <span class="ow">in</span> <span class="n">all_ref_files</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">_filter</span> <span class="ow">in</span> <span class="n">filters</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">starts_with</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">and</span> <span class="n">ref_file</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span>
                        <span class="n">_filter</span>
                    <span class="p">):</span>
                        <span class="n">keep</span> <span class="o">=</span> <span class="kc">True</span>

                    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">starts_with</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">and</span> <span class="n">_filter</span> <span class="ow">in</span> <span class="n">ref_file</span><span class="p">:</span>
                        <span class="n">keep</span> <span class="o">=</span> <span class="kc">True</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">keep</span> <span class="o">=</span> <span class="kc">False</span>

                    <span class="k">if</span> <span class="n">keep</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="n">list_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">roi_raw_data_dir</span><span class="p">,</span> <span class="n">ref_file</span><span class="p">)</span>
                        <span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">dict4runtime</span><span class="p">[</span>
                            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lib_dir</span><span class="p">,</span> <span class="n">ref_file</span><span class="p">)</span>
                        <span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">roi_raw_data_dir</span><span class="p">,</span> <span class="n">ref_file</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;rois_files&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">list_out</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;notInDb&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;rois_files&quot;</span><span class="p">]</span>

        <span class="c1"># Return the requirement, outputs and inheritance_dict</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_initResult</span><span class="p">()</span></div>

<div class="viewcode-block" id="Import_Data.run_process_mia"><a class="viewcode-back" href="../../../../mia_processes.bricks.tools.html#mia_processes.bricks.tools.tools.Import_Data.run_process_mia">[docs]</a>    <span class="k">def</span> <span class="nf">run_process_mia</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Dedicated to the process launch step of the brick.&quot;&quot;&quot;</span>
        <span class="c1"># No need the next line (we don&#39;t use self.process and SPM)</span>
        <span class="c1"># super(Import_Data, self).run_process_mia()</span>

        <span class="n">patient_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dict4runtime</span><span class="p">[</span><span class="s2">&quot;patient_name&quot;</span><span class="p">]</span>

        <span class="n">pat_name_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span> <span class="n">patient_name</span> <span class="o">+</span> <span class="s2">&quot;_data&quot;</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">pat_name_dir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">pat_name_dir</span><span class="p">)</span>

        <span class="n">roi_data_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pat_name_dir</span><span class="p">,</span> <span class="s2">&quot;ROI_data&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">roi_data_dir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">roi_data_dir</span><span class="p">)</span>

        <span class="n">roi_raw_data_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">roi_data_dir</span><span class="p">,</span> <span class="s2">&quot;raw_data&quot;</span><span class="p">)</span>

        <span class="n">tmp</span> <span class="o">=</span> <span class="s2">&quot;None&quot;</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">roi_raw_data_dir</span><span class="p">):</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mktemp</span><span class="p">(</span><span class="nb">dir</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">roi_data_dir</span><span class="p">))</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">roi_raw_data_dir</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="s2">&quot;raw_data&quot;</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">ImportData brick:</span><span class="se">\n</span><span class="s1">A &quot;</span><span class="si">{}</span><span class="s1">&quot; folder already exists, &#39;</span>
                <span class="s2">&quot;it will be overwritten by this new &quot;</span>
                <span class="s2">&quot;calculation...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">roi_raw_data_dir</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">roi_raw_data_dir</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">tmp</span><span class="p">):</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>

        <span class="c1"># Copying the selected ROIs from the selected resources folder</span>
        <span class="c1"># to roi_raw_data_dir</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dict4runtime</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="s2">&quot;patient_name&quot;</span><span class="p">:</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dict4runtime</span><span class="p">[</span><span class="n">k</span><span class="p">])</span></div></div>


<div class="viewcode-block" id="Input_Filter"><a class="viewcode-back" href="../../../../mia_processes.bricks.tools.html#mia_processes.bricks.tools.tools.Input_Filter">[docs]</a><span class="k">class</span> <span class="nc">Input_Filter</span><span class="p">(</span><span class="n">ProcessMIA</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    *To filter the Data Browser tab or the output data of another brick*</span>

<span class="sd">    Please, see the complete documentation for the</span>
<span class="sd">    `Input_Filter in the mia_processes website</span>
<span class="sd">    &lt;https://populse.github.io/mia_processes/html/documentation/bricks/tools/Input_Filter.html&gt;`_</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Input_Filter.__init__"><a class="viewcode-back" href="../../../../mia_processes.bricks.tools.html#mia_processes.bricks.tools.tools.Input_Filter.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Dedicated to the attributes initialisation/instantiation.</span>

<span class="sd">        The input and output plugs are defined here. The special</span>
<span class="sd">        &#39;self.requirement&#39; attribute (optional) is used to define the</span>
<span class="sd">        third-party products necessary for the running of the brick.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># initialisation of the objects needed for the launch of the brick</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Input_Filter</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1"># Third party softwares required for the execution of the brick</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requirement</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># no need of third party software!</span>

        <span class="c1"># Inputs description</span>
        <span class="n">input_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;A list corresponding to the data from the Data Browser &quot;</span>
            <span class="s2">&quot;or the output data from another brick.&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Outputs description</span>
        <span class="n">output_desc</span> <span class="o">=</span> <span class="s2">&quot;A list with the result of the filter applied.&quot;</span>

        <span class="c1"># Inputs traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;input&quot;</span><span class="p">,</span> <span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">traits</span><span class="o">.</span><span class="n">File</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">input_desc</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input</span> <span class="o">=</span> <span class="n">traits</span><span class="o">.</span><span class="n">Undefined</span>

        <span class="c1"># Outputs traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;output&quot;</span><span class="p">,</span> <span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">traits</span><span class="o">.</span><span class="n">File</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">output_desc</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output</span> <span class="o">=</span> <span class="n">traits</span><span class="o">.</span><span class="n">Undefined</span>

        <span class="c1"># Instantiation of the filter object</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filter</span> <span class="o">=</span> <span class="n">Filter</span><span class="p">(</span>
            <span class="kc">None</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;&quot;</span><span class="p">],</span> <span class="p">[[</span><span class="s2">&quot;FileName&quot;</span><span class="p">]],</span> <span class="p">[],</span> <span class="p">[</span><span class="s2">&quot;CONTAINS&quot;</span><span class="p">],</span> <span class="s2">&quot;&quot;</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">init_default_traits</span><span class="p">()</span></div>

<div class="viewcode-block" id="Input_Filter.list_outputs"><a class="viewcode-back" href="../../../../mia_processes.bricks.tools.html#mia_processes.bricks.tools.tools.Input_Filter.list_outputs">[docs]</a>    <span class="k">def</span> <span class="nf">list_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_plugged</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Dedicated to the initialisation step of the brick.</span>

<span class="sd">        The main objective of this method is to produce the outputs of the</span>
<span class="sd">        bricks (self.outputs) and the associated tags (self.inheritance_dic),</span>
<span class="sd">        if defined here. In order not to include an output in the database,</span>
<span class="sd">        this output must be a value of the optional key &#39;notInDb&#39; of the</span>
<span class="sd">        self.outputs dictionary. To work properly this method must return</span>
<span class="sd">        self.make_initResult() object.</span>

<span class="sd">        :param is_plugged: the state, linked or not, of the plugs.</span>
<span class="sd">        :returns: a dictionary with requirement, outputs and inheritance_dict.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Using the inheritance to ProcessMIA class, list_outputs method</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Input_Filter</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">list_outputs</span><span class="p">()</span>

        <span class="c1"># TODO: MAYBE WE DON&#39;T NEED THAT, IT SHOULD BE DONE IN</span>
        <span class="c1">#       open_filter of PipelineEditor?</span>

        <span class="c1"># Outputs definition and tags inheritance (optional)</span>

        <span class="c1"># Getting the input:</span>
        <span class="c1"># The current way for obtaining input data and filtering them is very</span>
        <span class="c1"># permissive. Indeed, it is possible to obtain the data from the output</span>
        <span class="c1"># of a previous brick or from the database (using Export to</span>
        <span class="c1"># database_scans, or not) and of course to perform a filtering from it.</span>
        <span class="c1"># But also, if no data is sent in, we get all the data from the</span>
        <span class="c1"># database (self.project.session.get_documents_names(</span>
        <span class="c1"># COLLECTION_CURRENT), below). It can maybe lead to side effects</span>
        <span class="c1"># (however it also allows for example not to connect the input to</span>
        <span class="c1"># something and to have the whole database by default...</span>
        <span class="c1"># Is it really desirable????</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scans_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scans_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get_documents_names</span><span class="p">(</span>
                <span class="n">COLLECTION_CURRENT</span>
            <span class="p">)</span>

        <span class="c1"># The data to filter are always a relative path</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scans_list</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scans_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scans_list</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">relpath</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">folder</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scans_list</span>
            <span class="p">]</span>

        <span class="c1"># Apply the filter to the input</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter</span><span class="o">.</span><span class="n">generate_filter</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scans_list</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get_shown_tags</span><span class="p">(),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;notInDb&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">]</span>

        <span class="c1"># The output data are always an absolute path</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">element</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">]):</span>
            <span class="n">full_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="o">.</span><span class="n">folder</span><span class="p">,</span> <span class="n">element</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;output&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">full_path</span>

        <span class="c1"># Return the requirement, outputs and inheritance_dict</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_initResult</span><span class="p">()</span></div>

<div class="viewcode-block" id="Input_Filter.run_process_mia"><a class="viewcode-back" href="../../../../mia_processes.bricks.tools.html#mia_processes.bricks.tools.tools.Input_Filter.run_process_mia">[docs]</a>    <span class="k">def</span> <span class="nf">run_process_mia</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Dedicated to the process launch step of the brick.&quot;&quot;&quot;</span>
        <span class="k">return</span></div></div>


<div class="viewcode-block" id="List_Duplicate"><a class="viewcode-back" href="../../../../mia_processes.bricks.tools.html#mia_processes.bricks.tools.tools.List_Duplicate">[docs]</a><span class="k">class</span> <span class="nc">List_Duplicate</span><span class="p">(</span><span class="n">ProcessMIA</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    *From a file name, generate a list containing that file name and the</span>
<span class="sd">    file name itself*</span>

<span class="sd">    Please, see the complete documentation for the</span>
<span class="sd">    `List_Duplicate in the mia_processes website</span>
<span class="sd">    &lt;https://populse.github.io/mia_processes/html/documentation/bricks/tools/List_Duplicate.html&gt;`_</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="List_Duplicate.__init__"><a class="viewcode-back" href="../../../../mia_processes.bricks.tools.html#mia_processes.bricks.tools.tools.List_Duplicate.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Dedicated to the attributes initialisation / instantiation.</span>

<span class="sd">        The input and output plugs are defined here. The special</span>
<span class="sd">        &#39;self.requirement&#39; attribute (optional) is used to define the</span>
<span class="sd">        third-party products necessary for the running of the brick.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># initialisation of the objects needed for the launch of the brick</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">List_Duplicate</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1"># Third party softwares required for the execution of the brick</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requirement</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># no need of third party software!</span>

        <span class="c1"># Inputs description</span>
        <span class="n">file_name_desc</span> <span class="o">=</span> <span class="s2">&quot;A string corresponding to an existing path file.&quot;</span>

        <span class="c1"># Outputs description</span>
        <span class="n">out_file_desc</span> <span class="o">=</span> <span class="s2">&quot;A string corresponding to an existing path file.&quot;</span>
        <span class="n">out_list_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;A list with one string element corresponding &quot;</span>
            <span class="s2">&quot; to an existing path file.&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Inputs traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;file_name&quot;</span><span class="p">,</span> <span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">file_name_desc</span><span class="p">))</span>

        <span class="c1"># Outputs traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;out_file&quot;</span><span class="p">,</span> <span class="n">traits</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">out_file_desc</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">out_file</span> <span class="o">=</span> <span class="n">traits</span><span class="o">.</span><span class="n">Undefined</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;out_list&quot;</span><span class="p">,</span> <span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">out_list_desc</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">out_list</span> <span class="o">=</span> <span class="n">traits</span><span class="o">.</span><span class="n">Undefined</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">init_default_traits</span><span class="p">()</span></div>

<div class="viewcode-block" id="List_Duplicate.list_outputs"><a class="viewcode-back" href="../../../../mia_processes.bricks.tools.html#mia_processes.bricks.tools.tools.List_Duplicate.list_outputs">[docs]</a>    <span class="k">def</span> <span class="nf">list_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_plugged</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Dedicated to the initialisation step of the brick.</span>

<span class="sd">        The main objective of this method is to produce the outputs of the</span>
<span class="sd">        bricks (self.outputs) and the associated tags (self.inheritance_dic),</span>
<span class="sd">        if defined here. In order not to include an output in the database,</span>
<span class="sd">        this output must be a value of the optional key &#39;notInDb&#39; of the</span>
<span class="sd">        self.outputs dictionary. To work properly this method must return</span>
<span class="sd">        self.make_initResult() object.</span>

<span class="sd">        :param is_plugged: the state, linked or not, of the plugs.</span>
<span class="sd">        :returns: a dictionary with requirement, outputs and inheritance_dict.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Using the inheritance to ProcessMIA class, list_outputs method</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">List_Duplicate</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">list_outputs</span><span class="p">()</span>

        <span class="c1"># Outputs definition and tags inheritance (optional)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_name</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;out_list&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">file_name</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;out_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_name</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;notInDb&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;out_list&quot;</span><span class="p">,</span> <span class="s2">&quot;out_file&quot;</span><span class="p">]</span>

        <span class="c1"># Return the requirement, outputs and inheritance_dict</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_initResult</span><span class="p">()</span></div>

<div class="viewcode-block" id="List_Duplicate.run_process_mia"><a class="viewcode-back" href="../../../../mia_processes.bricks.tools.html#mia_processes.bricks.tools.tools.List_Duplicate.run_process_mia">[docs]</a>    <span class="k">def</span> <span class="nf">run_process_mia</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Dedicated to the process launch step of the brick.&quot;&quot;&quot;</span>
        <span class="k">return</span></div></div>


<div class="viewcode-block" id="List_To_File"><a class="viewcode-back" href="../../../../mia_processes.bricks.tools.html#mia_processes.bricks.tools.tools.List_To_File">[docs]</a><span class="k">class</span> <span class="nc">List_To_File</span><span class="p">(</span><span class="n">ProcessMIA</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    *From several filenames, selects and generates a file*</span>

<span class="sd">    Please, see the complete documentation for the</span>
<span class="sd">    `List_To_File in the mia_processes website</span>
<span class="sd">    &lt;https://populse.github.io/mia_processes/html/documentation/bricks/tools/List_To_File.html&gt;`_</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="List_To_File.__init__"><a class="viewcode-back" href="../../../../mia_processes.bricks.tools.html#mia_processes.bricks.tools.tools.List_To_File.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Dedicated to the attributes initialisation / instantiation.</span>

<span class="sd">        The input and output plugs are defined here. The special</span>
<span class="sd">        &#39;self.requirement&#39; attribute (optional) is used to define the</span>
<span class="sd">        third-party products necessary for the running of the brick.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># initialisation of the objects needed for the launch of the brick</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">List_To_File</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1"># Third party softwares required for the execution of the brick</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requirement</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># no need of third party software!</span>

        <span class="c1"># Inputs description</span>
        <span class="n">file_list_desc</span> <span class="o">=</span> <span class="s2">&quot;The list of elements to be filtered.&quot;</span>
        <span class="n">index_filter_desc</span> <span class="o">=</span> <span class="s2">&quot;A list of 0 to 1 indexes for filtering.&quot;</span>

        <span class="c1"># Outputs description</span>
        <span class="n">file_desc</span> <span class="o">=</span> <span class="s2">&quot;The corresponding filtering result (a file).&quot;</span>

        <span class="c1"># Inputs traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;file_list&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">traits</span><span class="o">.</span><span class="n">File</span><span class="p">(),</span> <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">file_list_desc</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_list</span> <span class="o">=</span> <span class="n">traits</span><span class="o">.</span><span class="n">Undefined</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;index_filter&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">(</span>
                <span class="n">value</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">trait</span><span class="o">=</span><span class="n">traits</span><span class="o">.</span><span class="n">Range</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="kc">None</span><span class="p">),</span>
                <span class="n">minlen</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">maxlen</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">index_filter_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># Outputs traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;file&quot;</span><span class="p">,</span> <span class="n">traits</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">file_desc</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file</span> <span class="o">=</span> <span class="n">traits</span><span class="o">.</span><span class="n">Undefined</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">init_default_traits</span><span class="p">()</span></div>

<div class="viewcode-block" id="List_To_File.list_outputs"><a class="viewcode-back" href="../../../../mia_processes.bricks.tools.html#mia_processes.bricks.tools.tools.List_To_File.list_outputs">[docs]</a>    <span class="k">def</span> <span class="nf">list_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_plugged</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Dedicated to the initialisation step of the brick.</span>

<span class="sd">        The main objective of this method is to produce the outputs of the</span>
<span class="sd">        bricks (self.outputs) and the associated tags (self.inheritance_dic),</span>
<span class="sd">        if defined here. In order not to include an output in the database,</span>
<span class="sd">        this output must be a value of the optional key &#39;notInDb&#39; of the</span>
<span class="sd">        self.outputs dictionary. To work properly this method must return</span>
<span class="sd">        self.make_initResult() object.</span>

<span class="sd">        :param is_plugged: the state, linked or not, of the plugs.</span>
<span class="sd">        :returns: a dictionary with requirement, outputs and inheritance_dict.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Using the inheritance to ProcessMIA class, list_outputs method</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">List_To_File</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">list_outputs</span><span class="p">()</span>

        <span class="c1"># Outputs definition and tags inheritance (optional)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_list</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_list</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="s2">&quot;&lt;undefined&gt;&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">Undefined</span><span class="p">,</span>
        <span class="p">]:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_filter</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">file_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index_filter</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">index_filter</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_list</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">file_list</span><span class="p">[</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">index_filter</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
                    <span class="p">]</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">List_To_File brick brick: Initialisation failed &quot;</span>
                        <span class="s2">&quot;because the index_filter parameter is greater than &quot;</span>
                        <span class="s2">&quot;the length of file_list parameter ...</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;notInDb&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;file&quot;</span><span class="p">]</span>

        <span class="c1"># Return the requirement, outputs and inheritance_dict</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_initResult</span><span class="p">()</span></div>

<div class="viewcode-block" id="List_To_File.run_process_mia"><a class="viewcode-back" href="../../../../mia_processes.bricks.tools.html#mia_processes.bricks.tools.tools.List_To_File.run_process_mia">[docs]</a>    <span class="k">def</span> <span class="nf">run_process_mia</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Dedicated to the process launch step of the brick.&quot;&quot;&quot;</span>
        <span class="k">return</span></div></div>


<div class="viewcode-block" id="Make_A_List"><a class="viewcode-back" href="../../../../mia_processes.bricks.tools.html#mia_processes.bricks.tools.tools.Make_A_List">[docs]</a><span class="k">class</span> <span class="nc">Make_A_List</span><span class="p">(</span><span class="n">ProcessMIA</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    *From 2 objects, generating a list containing all these objects*</span>

<span class="sd">    Please, see the complete documentation for the</span>
<span class="sd">    `Make_A_List in the mia_processes website</span>
<span class="sd">    &lt;https://populse.github.io/mia_processes/html/documentation/bricks/tools/Make_A_List.html&gt;`_</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Make_A_List.__init__"><a class="viewcode-back" href="../../../../mia_processes.bricks.tools.html#mia_processes.bricks.tools.tools.Make_A_List.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Dedicated to the attributes initialisation / instantiation.</span>

<span class="sd">        The input and output plugs are defined here. The special</span>
<span class="sd">        &#39;self.requirement&#39; attribute (optional) is used to define the</span>
<span class="sd">        third-party products necessary for the running of the brick.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># initialisation of the objects needed for the launch of the brick</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Make_A_List</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1"># Third party softwares required for the execution of the brick</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requirement</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># no need of third party software!</span>

        <span class="c1"># Inputs description</span>
        <span class="n">obj1_desc</span> <span class="o">=</span> <span class="s2">&quot;An object ...&quot;</span>
        <span class="n">obj2_desc</span> <span class="o">=</span> <span class="s2">&quot;An optional object ...&quot;</span>

        <span class="c1"># Outputs description</span>
        <span class="n">obj_list_desc</span> <span class="o">=</span> <span class="s2">&quot;A list of objects.&quot;</span>

        <span class="c1"># Inputs traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;obj1&quot;</span><span class="p">,</span> <span class="n">traits</span><span class="o">.</span><span class="n">Any</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">obj1_desc</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">obj1</span> <span class="o">=</span> <span class="n">traits</span><span class="o">.</span><span class="n">Undefined</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;obj2&quot;</span><span class="p">,</span> <span class="n">traits</span><span class="o">.</span><span class="n">Any</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">obj2_desc</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">obj2</span> <span class="o">=</span> <span class="n">traits</span><span class="o">.</span><span class="n">Undefined</span>

        <span class="c1"># Outputs traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;obj_list&quot;</span><span class="p">,</span> <span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">obj_list_desc</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">obj_list</span> <span class="o">=</span> <span class="n">traits</span><span class="o">.</span><span class="n">Undefined</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">init_default_traits</span><span class="p">()</span></div>

<div class="viewcode-block" id="Make_A_List.list_outputs"><a class="viewcode-back" href="../../../../mia_processes.bricks.tools.html#mia_processes.bricks.tools.tools.Make_A_List.list_outputs">[docs]</a>    <span class="k">def</span> <span class="nf">list_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_plugged</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Dedicated to the initialisation step of the brick.</span>
<span class="sd">        The main objective of this method is to produce the outputs of the</span>
<span class="sd">        bricks (self.outputs) and the associated tags (self.inheritance_dic),</span>
<span class="sd">        if defined here. In order not to include an output in the database,</span>
<span class="sd">        this output must be a value of the optional key &#39;notInDb&#39; of the</span>
<span class="sd">        self.outputs dictionary. To work properly this method must return</span>
<span class="sd">        self.make_initResult() object.</span>
<span class="sd">        :param is_plugged: the state, linked or not, of the plugs.</span>
<span class="sd">        :returns: a dictionary with requirement, outputs and inheritance_dict.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Using the inheritance to ProcessMIA class, list_outputs method</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Make_A_List</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">list_outputs</span><span class="p">()</span>

        <span class="c1"># Outputs definition and tags inheritance (optional)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">obj1</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">obj1</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;&lt;undefined&gt;&quot;</span><span class="p">,</span> <span class="n">traits</span><span class="o">.</span><span class="n">Undefined</span><span class="p">]:</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">objt1</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obj1</span><span class="p">)</span>

            <span class="k">except</span> <span class="p">(</span><span class="ne">SyntaxError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
                <span class="c1">#  TODO: is it enough to do just that?</span>
                <span class="n">objt1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">obj1</span>

            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">obj2</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">obj2</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;&lt;undefined&gt;&quot;</span><span class="p">,</span> <span class="n">traits</span><span class="o">.</span><span class="n">Undefined</span><span class="p">]</span>
            <span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;obj_list&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">objt1</span><span class="p">]</span>

            <span class="k">else</span><span class="p">:</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">objt2</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obj2</span><span class="p">)</span>

                <span class="k">except</span> <span class="p">(</span><span class="ne">SyntaxError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
                    <span class="c1">#  TODO: is it enough to do just that?</span>
                    <span class="n">objt2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">obj2</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;obj_list&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">objt1</span><span class="p">,</span> <span class="n">objt2</span><span class="p">]</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;notInDb&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;obj_list&quot;</span><span class="p">]</span>

        <span class="c1"># Return the requirement, outputs and inheritance_dict</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_initResult</span><span class="p">()</span></div>

<div class="viewcode-block" id="Make_A_List.run_process_mia"><a class="viewcode-back" href="../../../../mia_processes.bricks.tools.html#mia_processes.bricks.tools.tools.Make_A_List.run_process_mia">[docs]</a>    <span class="k">def</span> <span class="nf">run_process_mia</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Dedicated to the process launch step of the brick.&quot;&quot;&quot;</span>
        <span class="k">return</span></div></div>


<div class="viewcode-block" id="Make_AIF"><a class="viewcode-back" href="../../../../mia_processes.bricks.tools.html#mia_processes.bricks.tools.tools.Make_AIF">[docs]</a><span class="k">class</span> <span class="nc">Make_AIF</span><span class="p">(</span><span class="n">ProcessMIA</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creating an Arterial Input Function (AIF) for Dynamic Susceptibility</span>
<span class="sd">    Contrast (DSC) Magnetic Resonance Imaging (MRI)</span>

<span class="sd">    Please, see the complete documentation for the</span>
<span class="sd">    `Make_AIF in the mia_processes website</span>
<span class="sd">    &lt;https://populse.github.io/mia_processes/html/documentation/bricks/tools/Make_AIF.html&gt;`_</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Make_AIF.__init__"><a class="viewcode-back" href="../../../../mia_processes.bricks.tools.html#mia_processes.bricks.tools.tools.Make_AIF.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Dedicated to the attributes initialisation / instantiation.</span>

<span class="sd">        The input and output plugs are defined here. The special</span>
<span class="sd">        &#39;self.requirement&#39; attribute (optional) is used to define the</span>
<span class="sd">        third-party products necessary for the running of the brick.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># initialisation of the objects needed for the launch of the brick</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Make_AIF</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1"># Third party softwares required for the execution of the brick</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requirement</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># no need of third party software!</span>

        <span class="c1"># Inputs description</span>
        <span class="n">func_file_desc</span> <span class="o">=</span> <span class="s2">&quot;The DSC MRI scan (a NIfTI file)&quot;</span>

        <span class="c1"># Outputs description</span>
        <span class="n">aif_file_desc</span> <span class="o">=</span> <span class="s2">&quot;The file containing the calculated AIF (a .mat file)&quot;</span>

        <span class="c1"># Inputs traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;func_file&quot;</span><span class="p">,</span>
            <span class="n">Either</span><span class="p">(</span>
                <span class="n">ImageFileSPM</span><span class="p">(),</span>
                <span class="n">Undefined</span><span class="p">,</span>
                <span class="n">copyfile</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">func_file_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">func_file</span> <span class="o">=</span> <span class="n">traits</span><span class="o">.</span><span class="n">Undefined</span>

        <span class="c1"># Outputs traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;aif_file&quot;</span><span class="p">,</span> <span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">aif_file_desc</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cvr_reg</span> <span class="o">=</span> <span class="n">traits</span><span class="o">.</span><span class="n">Undefined</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">init_default_traits</span><span class="p">()</span></div>

<div class="viewcode-block" id="Make_AIF.bol_ar_time"><a class="viewcode-back" href="../../../../mia_processes.bricks.tools.html#mia_processes.bricks.tools.tools.Make_AIF.bol_ar_time">[docs]</a>    <span class="k">def</span> <span class="nf">bol_ar_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute bolus arrival time</span>

<span class="sd">        :param data:</span>
<span class="sd">        :returns: the bolus arrival time</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">window_size</span> <span class="o">=</span> <span class="mi">8</span>
        <span class="n">th</span> <span class="o">=</span> <span class="mf">2.0</span>
        <span class="n">dim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">mean</span> <span class="o">=</span> <span class="n">std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">dim</span> <span class="o">-</span> <span class="n">window_size</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dim</span> <span class="o">-</span> <span class="n">window_size</span><span class="p">):</span>
            <span class="c1"># fmt: off</span>
            <span class="n">mean</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">t</span><span class="p">:</span><span class="n">t</span> <span class="o">+</span> <span class="n">window_size</span><span class="p">])</span>
            <span class="n">std</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">t</span><span class="p">:</span><span class="n">t</span> <span class="o">+</span> <span class="n">window_size</span><span class="p">])</span>
            <span class="c1"># fmt: on</span>

        <span class="n">tlog</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">window_size</span><span class="p">:]</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">mean</span> <span class="o">-</span> <span class="n">th</span> <span class="o">*</span> <span class="n">std</span><span class="p">)</span>
        <span class="n">t0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">tlog</span><span class="p">)</span>
        <span class="n">t0</span> <span class="o">+=</span> <span class="n">window_size</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">ttp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">t0</span> <span class="o">==</span> <span class="n">window_size</span> <span class="ow">or</span> <span class="n">t0</span> <span class="o">&gt;</span> <span class="n">ttp</span><span class="p">:</span>
            <span class="n">t0</span> <span class="o">=</span> <span class="mi">40</span>

        <span class="k">return</span> <span class="n">t0</span></div>

<div class="viewcode-block" id="Make_AIF.list_outputs"><a class="viewcode-back" href="../../../../mia_processes.bricks.tools.html#mia_processes.bricks.tools.tools.Make_AIF.list_outputs">[docs]</a>    <span class="k">def</span> <span class="nf">list_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_plugged</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Dedicated to the initialisation step of the brick.</span>
<span class="sd">        The main objective of this method is to produce the outputs of the</span>
<span class="sd">        bricks (self.outputs) and the associated tags (self.inheritance_dic),</span>
<span class="sd">        if defined here. In order not to include an output in the database,</span>
<span class="sd">        this output must be a value of the optional key &#39;notInDb&#39; of the</span>
<span class="sd">        self.outputs dictionary. To work properly this method must return</span>
<span class="sd">        self.make_initResult() object.</span>
<span class="sd">        :param is_plugged: the state, linked or not, of the plugs.</span>
<span class="sd">        :returns: a dictionary with requirement, outputs and inheritance_dict.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Using the inheritance to ProcessMIA class, list_outputs method</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Make_AIF</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">list_outputs</span><span class="p">()</span>

        <span class="c1"># Outputs definition and tags inheritance (optional)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">func_file</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">func_file</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="s2">&quot;&lt;undefined&gt;&quot;</span><span class="p">,</span>
            <span class="n">traits</span><span class="o">.</span><span class="n">Undefined</span><span class="p">,</span>
        <span class="p">]:</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">:</span>
                <span class="n">_</span><span class="p">,</span> <span class="n">file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">func_file</span><span class="p">)</span>
                <span class="n">file_name_no_ext</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;aif_file&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span> <span class="n">file_name_no_ext</span> <span class="o">+</span> <span class="s2">&quot;_aif.mat&quot;</span>
                <span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s2">&quot;Make_AIF brick: No output directory found, &quot;</span>
                    <span class="s2">&quot;initialization step cannot be performed...!</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_initResult</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">tags_inheritance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">func_file</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;aif_file&quot;</span><span class="p">])</span>

        <span class="c1"># Return the requirement, outputs and inheritance_dict</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_initResult</span><span class="p">()</span></div>

<div class="viewcode-block" id="Make_AIF.load_nii"><a class="viewcode-back" href="../../../../mia_processes.bricks.tools.html#mia_processes.bricks.tools.tools.Make_AIF.load_nii">[docs]</a>    <span class="k">def</span> <span class="nf">load_nii</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_path</span><span class="p">,</span> <span class="n">scaled</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">matlab_like</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the header and the data of a nibabel image object</span>

<span class="sd">        MATLAB and Python (in particular NumPy) treat the order of dimensions</span>
<span class="sd">        and the origin of the coordinate system differently. MATLAB uses main</span>
<span class="sd">        column order (also known as Fortran order). NumPy (and Python in</span>
<span class="sd">        general) uses the order of the main rows (C order). For a 3D array</span>
<span class="sd">        data(x, y, z) in MATLAB, the equivalent in NumPy is data[y, x, z].</span>
<span class="sd">        MATLAB and NumPy also handle the origin of the coordinate system</span>
<span class="sd">        differently:</span>
<span class="sd">        MATLAB&#39;s coordinate system starts with the origin in the lower</span>
<span class="sd">        left-hand corner (as in traditional matrix mathematics).</span>
<span class="sd">        NumPy&#39;s coordinate system starts with the origin in the top left-hand</span>
<span class="sd">        corner.</span>
<span class="sd">        When taking matlab_like=True as argument, the numpy matrix is</span>
<span class="sd">        rearranged to follow MATLAB conventions.</span>
<span class="sd">        Using scaled=False generates a raw unscaled data matrix (as in MATLAB</span>
<span class="sd">        with `header = loadnifti(fnii)` and `header.reco.data`).</span>

<span class="sd">        :param file_path: the path to a NIfTI file</span>
<span class="sd">        :param scaled: A boolean, if True the data is scaled</span>
<span class="sd">        :param matlab_like: A Boolean, if True the data is rearranged to match</span>
<span class="sd">                            the order of the dimensions and the origin of the</span>
<span class="sd">                            coordinate system in Matlab</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
        <span class="n">header</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">header</span>

        <span class="k">if</span> <span class="n">scaled</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">()</span>

        <span class="k">elif</span> <span class="n">scaled</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">dataobj</span><span class="o">.</span><span class="n">get_unscaled</span><span class="p">()</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Make_AIF brick: scaled argument must be True or False&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">matlab_like</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>

            <span class="c1"># TODO: Should transpose for ndim&gt;4 cases be implemented?</span>

            <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">header</span><span class="p">,</span> <span class="n">data</span></div>

<div class="viewcode-block" id="Make_AIF.run_process_mia"><a class="viewcode-back" href="../../../../mia_processes.bricks.tools.html#mia_processes.bricks.tools.tools.Make_AIF.run_process_mia">[docs]</a>    <span class="k">def</span> <span class="nf">run_process_mia</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Dedicated to the process launch step of the brick.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Make_AIF</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">run_process_mia</span><span class="p">()</span>
        <span class="n">header</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_nii</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">func_file</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="c1"># TODO: Perhaps we should do here a test to find out whether it&#39;s a</span>
        <span class="c1">#       4D or a 3D? using a try statement ?</span>
        <span class="n">ncol</span><span class="p">,</span> <span class="n">nrow</span><span class="p">,</span> <span class="n">nslices</span><span class="p">,</span> <span class="n">ndynamics</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span>
        <span class="c1"># TODO: Do we really need thres?</span>
        <span class="n">thres</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nslices</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">aux</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nslices</span><span class="p">):</span>
            <span class="n">thres</span><span class="p">[</span><span class="n">aux</span><span class="p">]</span> <span class="o">=</span> <span class="n">threshold_otsu</span><span class="p">(</span><span class="n">data</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">aux</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>

        <span class="n">head_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="c1"># AIF computation</span>
        <span class="c1">##################################################</span>
        <span class="c1"># data length report</span>
        <span class="n">wmaxr</span> <span class="o">=</span> <span class="mf">0.5</span>
        <span class="c1"># ??</span>
        <span class="n">nb_vox_cand</span> <span class="o">=</span> <span class="mi">50</span>
        <span class="c1"># ??</span>
        <span class="n">nb_vox</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="c1"># score of each selected voxel, the number of warnings, and the reasons</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="p">[[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="mi">9</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nb_vox</span><span class="p">)]</span>
        <span class="n">wmax</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">wmaxr</span> <span class="o">*</span> <span class="n">ndynamics</span><span class="p">)</span>
        <span class="c1"># TODO: can we use head_mask directly instead of roi?</span>
        <span class="n">roi</span> <span class="o">=</span> <span class="n">head_mask</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="c1"># remove voxels with inf and NaN values (not necessarily required)</span>
        <span class="n">roi</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">3</span>
        <span class="p">)</span>
        <span class="c1"># remove null voxels</span>
        <span class="n">roi</span> <span class="o">&amp;=</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="c1"># remove noisy voxels</span>
        <span class="n">data_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">roi</span><span class="p">])</span>
        <span class="n">noisy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">data_mean</span>
        <span class="n">roi</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">noisy</span>
        <span class="c1"># calculation of peak heights</span>
        <span class="n">base_line</span> <span class="o">=</span> <span class="n">min_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ncol</span><span class="p">,</span> <span class="n">nrow</span><span class="p">,</span> <span class="n">nslices</span><span class="p">))</span>
        <span class="c1"># Replicate the roi array ndynamics times along the 4th dimension</span>
        <span class="n">roi_replicated</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">roi</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span> <span class="n">ndynamics</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="c1"># Apply the mask to data</span>
        <span class="n">masked_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">roi_replicated</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">ndynamics</span><span class="p">)</span>
        <span class="c1"># Calculate the mean along the second axis</span>
        <span class="c1"># (ignoring the first frame, so use frames 2-6)</span>
        <span class="n">mean_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">masked_data</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">6</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1"># Assign the mean values to base_line at the positions of roi</span>
        <span class="n">base_line</span><span class="p">[</span><span class="n">roi</span><span class="p">]</span> <span class="o">=</span> <span class="n">mean_values</span>
        <span class="n">min_val</span><span class="p">[</span><span class="n">roi</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">roi</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">delta_base_min</span> <span class="o">=</span> <span class="n">base_line</span> <span class="o">-</span> <span class="n">min_val</span>
        <span class="c1"># calculation of peak widths</span>
        <span class="n">half_width_peak</span> <span class="o">=</span> <span class="n">ndynamics</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">ncol</span><span class="p">,</span> <span class="n">nrow</span><span class="p">,</span> <span class="n">nslices</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">roi</span><span class="p">)):</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
            <span class="n">condition</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">min_val</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+</span> <span class="n">delta_base_min</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">condition</span><span class="p">):</span>
                <span class="n">half_width_peak</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">condition</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span>
                    <span class="n">condition</span>
                <span class="p">)</span>

        <span class="n">half_width_peak</span><span class="p">[</span><span class="n">half_width_peak</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ndynamics</span>
        <span class="c1"># keep only non-saturated voxels</span>
        <span class="n">saturated_voxel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ncol</span><span class="p">,</span> <span class="n">nrow</span><span class="p">,</span> <span class="n">nslices</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">roi</span><span class="p">)):</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
            <span class="n">t1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span>
                <span class="n">data</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">min_val</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">])</span>
            <span class="p">)</span>
            <span class="n">t2</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span>
                <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">idx</span><span class="p">][::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">min_val</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">]))[</span>
                    <span class="p">::</span><span class="o">-</span><span class="mi">1</span>
                <span class="p">]</span>
            <span class="p">)</span>
            <span class="n">saturated_voxel</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="n">t1</span><span class="p">:</span><span class="n">t2</span><span class="p">],</span> <span class="n">n</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>

        <span class="n">roi</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">saturated_voxel</span>
        <span class="c1"># keep only voxels with a width less than a specified value</span>
        <span class="n">roi</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">half_width_peak</span> <span class="o">&lt;</span> <span class="n">wmax</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">half_width_peak</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">tmp_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">roi</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">ndynamics</span><span class="p">)</span>
        <span class="c1"># sorting of voxels, the height is recalculated beforehand to remove</span>
        <span class="c1"># voxels with excessive width</span>
        <span class="n">delta_base_min</span><span class="p">[</span><span class="o">~</span><span class="n">roi</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">tmp_delta_base_min</span> <span class="o">=</span> <span class="n">delta_base_min</span><span class="p">[</span><span class="n">roi</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">sorting</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">tmp_delta_base_min</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="c1"># score calculation</span>
        <span class="n">idx_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">score</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nb_vox_cand</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nb_vox_cand</span><span class="p">):</span>
            <span class="c1"># calculation of arrival time</span>
            <span class="n">t0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bol_ar_time</span><span class="p">(</span><span class="n">tmp_data</span><span class="p">[</span><span class="n">sorting</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="p">:])</span>
            <span class="n">initslop</span> <span class="o">=</span> <span class="n">delta_base_min</span><span class="o">.</span><span class="n">flatten</span><span class="p">()[</span><span class="n">sorting</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">/</span> <span class="p">(</span>
                <span class="n">idx_min</span><span class="o">.</span><span class="n">flatten</span><span class="p">()[</span><span class="n">sorting</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">-</span> <span class="n">t0</span>
            <span class="p">)</span>
            <span class="n">score</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">delta_base_min</span><span class="o">.</span><span class="n">flatten</span><span class="p">()[</span><span class="n">sorting</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">*</span> <span class="n">initslop</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span>
                <span class="n">half_width_peak</span><span class="o">.</span><span class="n">flatten</span><span class="p">()[</span><span class="n">sorting</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">*</span> <span class="n">t0</span>
            <span class="p">)</span>

        <span class="n">sorted_score</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">score</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">aif</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">tmp_data</span><span class="p">[</span><span class="n">sorting</span><span class="p">[</span><span class="n">sorted_score</span><span class="p">[:</span><span class="n">nb_vox</span><span class="p">]],</span> <span class="p">:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">roi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ncol</span><span class="p">,</span> <span class="n">nrow</span><span class="p">,</span> <span class="n">nslices</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nb_vox</span><span class="p">):</span>
            <span class="n">roi</span><span class="o">.</span><span class="n">flat</span><span class="p">[</span><span class="n">sorting</span><span class="p">[</span><span class="n">sorted_score</span><span class="p">[</span><span class="n">i</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># i, j, k correspond to the indexes in the brain (3D) for</span>
        <span class="c1"># the best results</span>
        <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">roi</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nb_vox</span><span class="p">):</span>
            <span class="n">warn</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">scores</span><span class="p">[</span><span class="n">v</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">score</span><span class="p">[</span><span class="n">sorted_score</span><span class="p">[</span><span class="n">v</span><span class="p">]],</span> <span class="n">i</span><span class="p">[</span><span class="n">v</span><span class="p">],</span> <span class="n">j</span><span class="p">[</span><span class="n">v</span><span class="p">],</span> <span class="n">k</span><span class="p">[</span><span class="n">v</span><span class="p">]]</span>

            <span class="c1"># Pre-bolus baseline test</span>
            <span class="n">std_basepre</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">tmp_data</span><span class="p">[</span><span class="n">sorting</span><span class="p">[</span><span class="n">sorted_score</span><span class="p">[</span><span class="n">v</span><span class="p">]],</span> <span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">])</span>
            <span class="n">mean_basepre</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">tmp_data</span><span class="p">[</span><span class="n">sorting</span><span class="p">[</span><span class="n">sorted_score</span><span class="p">[</span><span class="n">v</span><span class="p">]],</span> <span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">std_basepre</span> <span class="o">&gt;=</span> <span class="n">mean_basepre</span> <span class="o">/</span> <span class="mi">10</span><span class="p">:</span>
                <span class="n">warn</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">scores</span><span class="p">[</span><span class="n">v</span><span class="p">][</span><span class="mi">4</span> <span class="o">+</span> <span class="n">warn</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;The pre-bolus baseline of the voxel &quot;</span> <span class="s2">&quot;is too noisy&quot;</span>
                <span class="p">)</span>

            <span class="c1"># Post-bolus baseline test</span>
            <span class="n">std_basepost</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">tmp_data</span><span class="p">[</span><span class="n">sorting</span><span class="p">[</span><span class="n">sorted_score</span><span class="p">[</span><span class="n">v</span><span class="p">]],</span> <span class="o">-</span><span class="mi">6</span><span class="p">:])</span>
            <span class="n">mean_basepost</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">tmp_data</span><span class="p">[</span><span class="n">sorting</span><span class="p">[</span><span class="n">sorted_score</span><span class="p">[</span><span class="n">v</span><span class="p">]],</span> <span class="o">-</span><span class="mi">6</span><span class="p">:])</span>

            <span class="k">if</span> <span class="n">std_basepost</span> <span class="o">&gt;=</span> <span class="n">mean_basepost</span> <span class="o">/</span> <span class="mi">10</span><span class="p">:</span>
                <span class="n">warn</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">scores</span><span class="p">[</span><span class="n">v</span><span class="p">][</span><span class="mi">4</span> <span class="o">+</span> <span class="n">warn</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s2">&quot;The post-bolus baseline of the voxel &quot;</span> <span class="s2">&quot;is too noisy&quot;</span>
                <span class="p">)</span>

            <span class="c1"># t0 point test</span>
            <span class="n">t0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bol_ar_time</span><span class="p">(</span><span class="n">tmp_data</span><span class="p">[</span><span class="n">sorting</span><span class="p">[</span><span class="n">sorted_score</span><span class="p">[</span><span class="n">v</span><span class="p">]],</span> <span class="p">:])</span>

            <span class="k">if</span> <span class="n">tmp_data</span><span class="p">[</span><span class="n">sorting</span><span class="p">[</span><span class="n">sorted_score</span><span class="p">[</span><span class="n">v</span><span class="p">]],</span> <span class="n">t0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mf">1.1</span> <span class="o">*</span> <span class="n">mean_basepre</span><span class="p">:</span>
                <span class="n">warn</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">scores</span><span class="p">[</span><span class="n">v</span><span class="p">][</span><span class="mi">4</span> <span class="o">+</span> <span class="n">warn</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;The voxel value at t0 is too high&quot;</span>

            <span class="c1"># Pre-bolus baseline length test</span>
            <span class="k">if</span> <span class="n">t0</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">:</span>
                <span class="n">warn</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">scores</span><span class="p">[</span><span class="n">v</span><span class="p">][</span><span class="mi">4</span> <span class="o">+</span> <span class="n">warn</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;The voxel baseline is too short&quot;</span>

            <span class="n">scores</span><span class="p">[</span><span class="n">v</span><span class="p">][</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">warn</span>
        <span class="c1">###################################################</span>
        <span class="c1"># TODO: May be we don&#39;t need to save in matlab file format?</span>
        <span class="n">io</span><span class="o">.</span><span class="n">savemat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">aif_file</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;aif&quot;</span><span class="p">:</span> <span class="n">aif</span><span class="p">,</span> <span class="s2">&quot;scores&quot;</span><span class="p">:</span> <span class="n">scores</span><span class="p">})</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Make_AIF brick: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">aif_file</span><span class="si">}</span><span class="s2"> created!&quot;</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="Make_CVR_reg_physio"><a class="viewcode-back" href="../../../../mia_processes.bricks.tools.html#mia_processes.bricks.tools.tools.Make_CVR_reg_physio">[docs]</a><span class="k">class</span> <span class="nc">Make_CVR_reg_physio</span><span class="p">(</span><span class="n">ProcessMIA</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    *Generate the physiological regressor for CVR*</span>

<span class="sd">    Please, see the complete documentation for the</span>
<span class="sd">    `Make_CVR_reg_physio in the mia_processes website</span>
<span class="sd">    &lt;https://populse.github.io/mia_processes/html/documentation/bricks/tools/Make_CVR_reg_physio.html&gt;`_</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Make_CVR_reg_physio.__init__"><a class="viewcode-back" href="../../../../mia_processes.bricks.tools.html#mia_processes.bricks.tools.tools.Make_CVR_reg_physio.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Dedicated to the attributes initialisation / instantiation.</span>

<span class="sd">        The input and output plugs are defined here. The special</span>
<span class="sd">        &#39;self.requirement&#39; attribute (optional) is used to define the</span>
<span class="sd">        third-party products necessary for the running of the brick.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># initialisation of the objects needed for the launch of the brick</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Make_CVR_reg_physio</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1"># Third party softwares required for the execution of the brick</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requirement</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># no need of third party software!</span>

        <span class="c1"># Inputs description</span>
        <span class="n">func_file_desc</span> <span class="o">=</span> <span class="s2">&quot;The fMRI scan under hypercapnia (a file)&quot;</span>
        <span class="n">trigger_data_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;The trigger data (a file with extension &quot;</span>
            <span class="s2">&quot;in [&#39;.txt&#39;, &#39;.csv&#39;, &#39;.log&#39;])&quot;</span>
        <span class="p">)</span>
        <span class="n">physio_data_desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;The physiological data (a file with extension &quot;</span>
            <span class="s2">&quot;in [&#39;.txt&#39;, &#39;.csv&#39;])&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Outputs description</span>
        <span class="n">cvr_reg_desc</span> <span class="o">=</span> <span class="s2">&quot;The physiological regressor for CVR (a file)&quot;</span>

        <span class="c1"># Inputs traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;func_file&quot;</span><span class="p">,</span>
            <span class="n">Either</span><span class="p">(</span>
                <span class="n">ImageFileSPM</span><span class="p">(),</span>
                <span class="n">Undefined</span><span class="p">,</span>
                <span class="n">copyfile</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">optional</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">desc</span><span class="o">=</span><span class="n">func_file_desc</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">func_file</span> <span class="o">=</span> <span class="n">traits</span><span class="o">.</span><span class="n">Undefined</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;trigger_data&quot;</span><span class="p">,</span>
            <span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">trigger_data_desc</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trigger_data</span> <span class="o">=</span> <span class="n">traits</span><span class="o">.</span><span class="n">Undefined</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span>
            <span class="s2">&quot;physio_data&quot;</span><span class="p">,</span>
            <span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">physio_data_desc</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">physio_data</span> <span class="o">=</span> <span class="n">traits</span><span class="o">.</span><span class="n">Undefined</span>

        <span class="c1"># Outputs traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;cvr_reg&quot;</span><span class="p">,</span> <span class="n">File</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="n">cvr_reg_desc</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cvr_reg</span> <span class="o">=</span> <span class="n">traits</span><span class="o">.</span><span class="n">Undefined</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">init_default_traits</span><span class="p">()</span></div>

<div class="viewcode-block" id="Make_CVR_reg_physio.gaussfir"><a class="viewcode-back" href="../../../../mia_processes.bricks.tools.html#mia_processes.bricks.tools.tools.Make_CVR_reg_physio.gaussfir">[docs]</a>    <span class="k">def</span> <span class="nf">gaussfir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bt</span><span class="p">,</span> <span class="n">nt</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">of</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate a Gaussian FIR filter</span>

<span class="sd">        with a specified bandwidth-time product (bt),</span>
<span class="sd">        number of taps (nt), and oversampling factor (of)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">convert_to_t</span><span class="p">(</span><span class="n">of</span><span class="p">,</span> <span class="n">nt</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Convert to t in which to compute the filter coefficients.&quot;&quot;&quot;</span>
            <span class="c1"># Filter Length</span>
            <span class="n">filt_len</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">of</span> <span class="o">*</span> <span class="n">nt</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">nt</span><span class="p">,</span> <span class="n">nt</span><span class="p">,</span> <span class="n">filt_len</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">t</span>

        <span class="n">t</span> <span class="o">=</span> <span class="n">convert_to_t</span><span class="p">(</span><span class="n">of</span><span class="p">,</span> <span class="n">nt</span><span class="p">)</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">bt</span><span class="p">)</span>
        <span class="n">h</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">/</span> <span class="n">alpha</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">((</span><span class="n">t</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="n">alpha</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>
        <span class="c1"># Normalize coefficients</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">h</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">h</span></div>

<div class="viewcode-block" id="Make_CVR_reg_physio.gfb_conv"><a class="viewcode-back" href="../../../../mia_processes.bricks.tools.html#mia_processes.bricks.tools.tools.Make_CVR_reg_physio.gfb_conv">[docs]</a>    <span class="k">def</span> <span class="nf">gfb_conv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="s2">&quot;full&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a subsection of the convolution, as specified by the</span>
<span class="sd">        shape parameter.</span>

<span class="sd">        :param a: a vector (a ndarray numpy object)</span>
<span class="sd">        :param b: a vector (a ndarray numpy object)</span>
<span class="sd">        :param shape: sub-section of the convolution (a string in</span>
<span class="sd">                      [&#39;full&#39;, &#39;same&#39;, &#39;valid&#39;])</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">shape</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;full&quot;</span><span class="p">,</span> <span class="s2">&quot;same&quot;</span><span class="p">,</span> <span class="s2">&quot;valid&quot;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Make_CVR_reg_physio brick: Invalid value for &#39;shape&#39;. &quot;</span>
                <span class="s2">&quot;It must be &#39;full&#39;, &#39;same&#39;, or &#39;valid&#39;.&quot;</span>
            <span class="p">)</span>

        <span class="n">na</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">nb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">b</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="c1"># Check if a is a column vector</span>
        <span class="n">iscolumn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">a</span><span class="p">))</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="c1"># Reshape a and b into column vectors</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

        <span class="c1"># Determine the size of the output convolution array</span>
        <span class="k">if</span> <span class="n">shape</span> <span class="o">==</span> <span class="s2">&quot;full&quot;</span><span class="p">:</span>
            <span class="n">k_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">na</span> <span class="o">+</span> <span class="n">nb</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">ia</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">k_max</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">shape</span> <span class="o">==</span> <span class="s2">&quot;same&quot;</span><span class="p">:</span>
            <span class="n">k_max</span> <span class="o">=</span> <span class="n">na</span>
            <span class="n">ia</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">k_max</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">nb</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">shape</span> <span class="o">==</span> <span class="s2">&quot;valid&quot;</span><span class="p">:</span>
            <span class="n">k_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">na</span> <span class="o">-</span> <span class="nb">max</span><span class="p">(</span><span class="n">nb</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">ia</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">k_max</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="nb">max</span><span class="p">(</span><span class="n">nb</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="n">ia</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">ia</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">nb</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">j</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nb</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">k_max</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">ia</span> <span class="o">=</span> <span class="n">ia</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">j</span>
        <span class="n">valid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">ia</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ia</span> <span class="o">&lt;=</span> <span class="n">na</span><span class="p">)</span>
        <span class="n">ia</span><span class="p">[</span><span class="o">~</span><span class="n">valid</span><span class="p">]</span> <span class="o">=</span> <span class="n">na</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># Add zero to end of a</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="n">ia</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">b</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">c</span> <span class="k">if</span> <span class="n">iscolumn</span> <span class="k">else</span> <span class="n">c</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span></div>

<div class="viewcode-block" id="Make_CVR_reg_physio.list_outputs"><a class="viewcode-back" href="../../../../mia_processes.bricks.tools.html#mia_processes.bricks.tools.tools.Make_CVR_reg_physio.list_outputs">[docs]</a>    <span class="k">def</span> <span class="nf">list_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_plugged</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Dedicated to the initialisation step of the brick.</span>
<span class="sd">        The main objective of this method is to produce the outputs of the</span>
<span class="sd">        bricks (self.outputs) and the associated tags (self.inheritance_dic),</span>
<span class="sd">        if defined here. In order not to include an output in the database,</span>
<span class="sd">        this output must be a value of the optional key &#39;notInDb&#39; of the</span>
<span class="sd">        self.outputs dictionary. To work properly this method must return</span>
<span class="sd">        self.make_initResult() object.</span>
<span class="sd">        :param is_plugged: the state, linked or not, of the plugs.</span>
<span class="sd">        :returns: a dictionary with requirement, outputs and inheritance_dict.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Using the inheritance to ProcessMIA class, list_outputs method</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Make_CVR_reg_physio</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">list_outputs</span><span class="p">()</span>

        <span class="c1"># Outputs definition and tags inheritance (optional)</span>
        <span class="c1"># if self.outputs:</span>
        <span class="c1">#     self.outputs = {}</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">func_file</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;&lt;undefined&gt;&quot;</span><span class="p">,</span> <span class="n">traits</span><span class="o">.</span><span class="n">Undefined</span><span class="p">]:</span>
            <span class="n">patient_name</span> <span class="o">=</span> <span class="n">get_dbFieldValue</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">func_file</span><span class="p">,</span> <span class="s2">&quot;PatientName&quot;</span>
            <span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;Make_CVR_reg_physio brick: The mandatory &#39;func_file&#39; input &quot;</span>
                <span class="s2">&quot;parameter is not defined ...&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_initResult</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">patient_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;Make_CVR_reg_physio brick: Please, fill &#39;PatientName&#39; &quot;</span>
                <span class="s2">&quot;tag in the database for </span><span class="si">{}</span><span class="s2"> ...&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">func_file</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_initResult</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">:</span>
            <span class="c1"># Create a data directory for this patient</span>
            <span class="n">out_directory</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span> <span class="n">patient_name</span> <span class="o">+</span> <span class="s2">&quot;_data&quot;</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">out_directory</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">out_directory</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;Make_CVR_reg_physio brick: No output_directory was &quot;</span>
                <span class="s2">&quot;found...!</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_initResult</span><span class="p">()</span>

        <span class="n">fname_reg</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">out_directory</span><span class="p">,</span> <span class="s2">&quot;CVR_physio_reg.mat&quot;</span><span class="p">)</span>
        <span class="n">all_tags_to_add</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Add the reg state (individual or standard), in database</span>
        <span class="n">tag_to_add</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Regressor state&quot;</span>
        <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;field_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;string&quot;</span>
        <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;Indicates the state of the physiological regressor for CVR &quot;</span>
            <span class="s2">&quot;(Individual or Standard)&quot;</span>
        <span class="p">)</span>
        <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;visibility&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;origin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;user&quot;</span>
        <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;unit&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;default_value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Individual&quot;</span>
            <span class="c1"># TODO: The following attributes are currently hard-coded, but</span>
            <span class="c1">#       we could add them as input of the brick if necessary?</span>
            <span class="c1"># the number of last dyns to be deleted</span>
            <span class="n">end_dyn_sup</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="c1"># delay between respiration and EtCO2 variation (s)</span>
            <span class="n">delay_for_etco2</span> <span class="o">=</span> <span class="mf">4.8</span>
            <span class="n">tr</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">get_dbFieldValue</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">func_file</span><span class="p">,</span> <span class="s2">&quot;RepetitionTime&quot;</span>
                <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="o">/</span> <span class="mi">1000</span>
            <span class="p">)</span>
            <span class="c1"># TODO: glover_hrf(tr) don&#39;t give good result yet. While waiting</span>
            <span class="c1">#       to make a good hrf, we use the hrf calculated as in spm</span>
            <span class="c1"># from nilearn.glm.first_level.hemodynamic_models import glover_hrf</span>
            <span class="c1"># hrf = glover_hrf(tr)</span>
            <span class="n">hrf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spm_hrf</span><span class="p">(</span><span class="n">tr</span><span class="p">,</span> <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">32</span><span class="p">])</span>
            <span class="n">nb_dyn</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">get_dbFieldValue</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">project</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">func_file</span><span class="p">,</span>
                    <span class="s2">&quot;Dataset dimensions (Count, X,Y,Z,T...)&quot;</span><span class="p">,</span>
                <span class="p">)[</span><span class="mi">4</span><span class="p">]</span>
                <span class="o">-</span> <span class="n">end_dyn_sup</span>
            <span class="p">)</span>
            <span class="c1"># ---- Start of making phys_trig_data ----</span>
            <span class="c1"># record some data prior to start and after end of scan,</span>
            <span class="c1"># typically the duration of one hrf</span>
            <span class="n">time_margin</span> <span class="o">=</span> <span class="mi">30</span>  <span class="c1"># seconds</span>
            <span class="n">status_sample_freq</span> <span class="o">=</span> <span class="mf">37.127</span>
            <span class="c1"># ---- Start of making trigdata ----</span>
            <span class="n">starttime</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">endtime</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
            <span class="n">n_pulses</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="c1"># Read data from different types of files</span>
            <span class="n">file_extension</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trigger_data</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">file_extension</span> <span class="o">==</span> <span class="s2">&quot;txt&quot;</span><span class="p">:</span>
                <span class="c1"># TODO: Not yet tested</span>

                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trigger_data</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fil</span><span class="p">:</span>
                    <span class="n">lines</span> <span class="o">=</span> <span class="n">fil</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>

                    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>

                        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">starttime</span><span class="p">):</span>
                            <span class="n">colonidxs</span> <span class="o">=</span> <span class="p">[</span>
                                <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="s2">&quot;:&quot;</span>
                            <span class="p">]</span>

                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">colonidxs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                                <span class="c1"># fmt: off</span>
                                <span class="n">this_time_s</span> <span class="o">=</span> <span class="p">(</span>
                                    <span class="mi">3600</span> <span class="o">*</span> <span class="nb">int</span><span class="p">(</span>
                                        <span class="n">line</span><span class="p">[</span><span class="n">colonidxs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span><span class="p">:</span><span class="n">colonidxs</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                                    <span class="p">)</span> <span class="o">+</span> <span class="mi">60</span> <span class="o">*</span> <span class="nb">int</span><span class="p">(</span>
                                        <span class="n">line</span><span class="p">[</span><span class="n">colonidxs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span><span class="n">colonidxs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                                    <span class="p">)</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span>
                                        <span class="n">line</span><span class="p">[</span><span class="n">colonidxs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span><span class="n">colonidxs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span>
                                    <span class="p">)</span>
                                <span class="p">)</span>
                                <span class="c1"># fmt: on</span>
                                <span class="n">starttime</span> <span class="o">=</span> <span class="n">this_time_s</span>

                        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;E11&quot;</span><span class="p">):</span>
                            <span class="n">this_data</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
                            <span class="n">dt_ms</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">this_data</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
                            <span class="n">dt_s</span> <span class="o">=</span> <span class="n">dt_ms</span> <span class="o">/</span> <span class="mi">1000</span>
                            <span class="n">next_line</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">lines</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
                            <span class="n">trig_times_ms</span> <span class="o">=</span> <span class="p">[</span>
                                <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">next_line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
                            <span class="p">]</span>
                            <span class="n">trig_times_s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">trig_times_ms</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span>
                            <span class="n">endtime</span> <span class="o">=</span> <span class="n">starttime</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">trig_times_s</span><span class="p">)</span> <span class="o">*</span> <span class="n">dt_s</span>
                            <span class="k">break</span>

                <span class="n">tr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">trig_times_s</span><span class="p">))</span>

            <span class="k">elif</span> <span class="n">file_extension</span> <span class="o">==</span> <span class="s2">&quot;log&quot;</span><span class="p">:</span>
                <span class="c1"># tested: OK</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trigger_data</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fil</span><span class="p">:</span>
                    <span class="n">lines</span> <span class="o">=</span> <span class="n">fil</span><span class="o">.</span><span class="n">readlines</span><span class="p">()[</span><span class="mi">5</span><span class="p">:]</span>  <span class="c1"># Skip header lines</span>
                    <span class="n">trig_times</span> <span class="o">=</span> <span class="p">[]</span>

                    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>

                        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">starttime</span><span class="p">):</span>
                            <span class="n">colonidxs</span> <span class="o">=</span> <span class="p">[</span>
                                <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="k">if</span> <span class="n">c</span> <span class="o">==</span> <span class="s2">&quot;:&quot;</span>
                            <span class="p">]</span>

                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">colonidxs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                                <span class="c1"># fmt: off</span>
                                <span class="n">this_time_s</span> <span class="o">=</span> <span class="p">(</span>
                                    <span class="mi">3600</span> <span class="o">*</span> <span class="nb">int</span><span class="p">(</span>
                                        <span class="n">line</span><span class="p">[</span><span class="n">colonidxs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span><span class="p">:</span><span class="n">colonidxs</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                                    <span class="p">)</span> <span class="o">+</span> <span class="mi">60</span> <span class="o">*</span> <span class="nb">int</span><span class="p">(</span>
                                        <span class="n">line</span><span class="p">[</span><span class="n">colonidxs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span><span class="n">colonidxs</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
                                    <span class="p">)</span> <span class="o">+</span> <span class="nb">float</span><span class="p">(</span>
                                        <span class="n">line</span><span class="p">[</span><span class="n">colonidxs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span><span class="n">colonidxs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">5</span><span class="p">]</span>
                                    <span class="p">)</span>
                                <span class="p">)</span>
                                <span class="c1"># fmt: on</span>
                                <span class="n">starttime_abs</span> <span class="o">=</span> <span class="n">this_time_s</span>
                                <span class="n">tab_pos</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>
                                <span class="n">starttime_rel</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">tab_pos</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">/</span> <span class="mi">10000</span>
                                <span class="n">starttime</span> <span class="o">=</span> <span class="n">starttime_abs</span> <span class="o">-</span> <span class="n">starttime_rel</span>

                        <span class="k">if</span> <span class="s2">&quot;Pulse&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                            <span class="n">tab_pos</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>
                            <span class="n">trig_times</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">tab_pos</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>

                <span class="n">trig_times_s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">trig_times</span><span class="p">)</span> <span class="o">/</span> <span class="mi">10000</span>
                <span class="n">starttime</span> <span class="o">=</span> <span class="n">starttime</span> <span class="o">+</span> <span class="n">trig_times_s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">dt_s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">trig_times_s</span><span class="p">)</span>
                <span class="n">tr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">dt_s</span><span class="p">)</span>
                <span class="n">endtime</span> <span class="o">=</span> <span class="n">starttime</span> <span class="o">+</span> <span class="n">trig_times_s</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">trig_times_s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">tr</span>
                <span class="n">trig_times_s</span> <span class="o">=</span> <span class="n">trig_times_s</span> <span class="o">-</span> <span class="n">trig_times_s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">n_pulses</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">endtime</span> <span class="o">-</span> <span class="n">starttime</span><span class="p">)</span> <span class="o">/</span> <span class="n">tr</span><span class="p">)</span>
                <span class="c1"># look for missing triggers</span>
                <span class="n">dn</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">trig_times_s</span><span class="p">)</span> <span class="o">/</span> <span class="n">tr</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
                <span class="n">dn_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">dn</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">dn_pos</span><span class="o">.</span><span class="n">size</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>

                    <span class="k">for</span> <span class="n">pos</span> <span class="ow">in</span> <span class="n">dn_pos</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                        <span class="c1"># fmt: off</span>
                        <span class="n">trig_times_s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
                            <span class="p">[</span>
                                <span class="n">trig_times_s</span><span class="p">[:</span><span class="n">pos</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span>
                                <span class="p">[</span><span class="n">tr</span> <span class="o">+</span> <span class="n">trig_times_s</span><span class="p">[</span><span class="n">pos</span><span class="p">]],</span>
                                <span class="n">trig_times_s</span><span class="p">[</span><span class="n">pos</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:],</span>
                            <span class="p">]</span>
                        <span class="p">)</span>
                        <span class="c1"># fmt: on</span>

            <span class="k">elif</span> <span class="n">file_extension</span> <span class="o">==</span> <span class="s2">&quot;csv&quot;</span><span class="p">:</span>
                <span class="c1"># TODO: Not yet tested</span>
                <span class="c1"># Extract start time from file name</span>
                <span class="n">short_fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trigger_data</span><span class="p">)</span>
                <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">starttime</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">short_fname</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>

                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trigger_data</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fil</span><span class="p">:</span>
                    <span class="n">lines</span> <span class="o">=</span> <span class="n">fil</span><span class="o">.</span><span class="n">readlines</span><span class="p">()[</span><span class="mi">2</span><span class="p">:]</span>  <span class="c1"># Skip header lines</span>
                    <span class="n">trig_times</span> <span class="o">=</span> <span class="p">[]</span>

                    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
                        <span class="n">data</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">)</span>
                        <span class="n">trig_times</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

                <span class="n">trig_times_s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">trig_times</span><span class="p">)</span>
                <span class="n">starttime</span> <span class="o">=</span> <span class="n">starttime</span> <span class="o">+</span> <span class="n">trig_times_s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">tr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">trig_times_s</span><span class="p">))</span>
                <span class="n">endtime</span> <span class="o">=</span> <span class="n">starttime</span> <span class="o">+</span> <span class="n">trig_times_s</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">tr</span>
                <span class="n">trig_times_s</span> <span class="o">=</span> <span class="n">trig_times_s</span> <span class="o">-</span> <span class="n">trig_times_s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">n_pulses</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">trig_times_s</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span>
                    <span class="s2">&quot;Make_CVR_reg_physio brick: The Only &quot;</span>
                    <span class="s2">&quot;.csv, .log and .txt extensions are &quot;</span>
                    <span class="s2">&quot;allowed for the trigger_data &quot;</span>
                    <span class="s2">&quot;parameter. The individual regressor &quot;</span>
                    <span class="s2">&quot;cannot be generated... &quot;</span>
                <span class="p">)</span>
            <span class="c1"># ---- End of making trigdata ----</span>
            <span class="n">starttime</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">starttime</span><span class="p">)</span>
            <span class="n">endtime</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">endtime</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">physio_data</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.csv&quot;</span><span class="p">):</span>
                <span class="c1"># tested: OK</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Data from Magdata software detected ...&quot;</span><span class="p">)</span>
                <span class="n">times</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">data_s</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">paramnames</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">physio_data</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fid</span><span class="p">:</span>

                    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">fid</span><span class="p">:</span>
                        <span class="n">times</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">[:</span><span class="mi">9</span><span class="p">])</span>

                        <span class="k">if</span> <span class="n">line</span><span class="p">[</span><span class="mi">9</span><span class="p">:]</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">):</span>
                            <span class="n">data_s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">9</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>

                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">data_s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">9</span><span class="p">:])</span>

                <span class="n">nlines</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">times</span><span class="p">)</span>
                <span class="n">phys_trig_data</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">time_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nlines</span><span class="p">)</span>
                <span class="n">datapoint</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">have_format</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nlines</span><span class="p">):</span>
                    <span class="n">this_times</span> <span class="o">=</span> <span class="n">times</span><span class="p">[</span><span class="n">line</span><span class="p">]</span>

                    <span class="k">try</span><span class="p">:</span>
                        <span class="c1"># convert to seconds since midnight</span>
                        <span class="n">this_time_s</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
                            <span class="p">[</span>
                                <span class="n">time</span> <span class="o">*</span> <span class="n">factor</span>
                                <span class="k">for</span> <span class="n">time</span><span class="p">,</span> <span class="n">factor</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                                    <span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">this_times</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)),</span>
                                    <span class="p">[</span><span class="mi">3600</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                                <span class="p">)</span>
                            <span class="p">]</span>
                        <span class="p">)</span>

                    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>

                        <span class="k">if</span> <span class="n">have_format</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                            <span class="n">formatline</span> <span class="o">=</span> <span class="n">this_times</span> <span class="o">+</span> <span class="n">data_s</span><span class="p">[</span><span class="n">line</span><span class="p">]</span>
                            <span class="n">paramnames</span> <span class="o">=</span> <span class="n">formatline</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
                            <span class="c1"># We&#39;re not interested in the &#39;Time&#39; field</span>
                            <span class="c1"># at the beginning</span>
                            <span class="n">paramnames</span> <span class="o">=</span> <span class="n">paramnames</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                            <span class="c1"># Replace spaces with underscores and</span>
                            <span class="c1"># &#39;%&#39; with &#39;perc&#39;</span>
                            <span class="n">paramnames</span> <span class="o">=</span> <span class="p">[</span>
                                <span class="n">name</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                                <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>
                                <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;%&quot;</span><span class="p">,</span> <span class="s2">&quot;perc&quot;</span><span class="p">)</span>
                                <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">paramnames</span>
                            <span class="p">]</span>

                            <span class="c1"># If &#39;IBP2_wm2&#39; is not present,</span>
                            <span class="c1"># insert the missing field right after &#39;IBP2_wm1&#39;</span>
                            <span class="k">if</span> <span class="s2">&quot;IBP2_wm2&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">paramnames</span><span class="p">:</span>
                                <span class="n">position</span> <span class="o">=</span> <span class="n">paramnames</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;IBP2_wm1&quot;</span><span class="p">)</span>
                                <span class="n">paramnames</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">position</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;IBP2_wm2&quot;</span><span class="p">)</span>

                            <span class="c1"># Fix typos in magdata-provided field names</span>
                            <span class="n">paramnames</span> <span class="o">=</span> <span class="p">[</span>
                                <span class="n">name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;Satus&quot;</span><span class="p">,</span> <span class="s2">&quot;Status&quot;</span><span class="p">)</span>
                                <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">paramnames</span>
                            <span class="p">]</span>
                            <span class="n">n_params</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">paramnames</span><span class="p">)</span>
                            <span class="c1"># Mark data as unread</span>
                            <span class="n">data_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">nlines</span><span class="p">,</span> <span class="n">n_params</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                            <span class="n">have_format</span> <span class="o">=</span> <span class="kc">True</span>

                    <span class="k">else</span><span class="p">:</span>

                        <span class="k">if</span> <span class="n">starttime</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">starttime</span> <span class="o">=</span> <span class="n">this_time_s</span>
                            <span class="n">this_time_s</span> <span class="o">=</span> <span class="mi">0</span>

                        <span class="k">else</span><span class="p">:</span>

                            <span class="k">if</span> <span class="n">this_time_s</span> <span class="o">&lt;</span> <span class="n">starttime</span> <span class="o">-</span> <span class="n">time_margin</span><span class="p">:</span>
                                <span class="k">continue</span>  <span class="c1"># discard this line</span>

                            <span class="k">elif</span> <span class="n">this_time_s</span> <span class="o">&gt;</span> <span class="n">endtime</span> <span class="o">+</span> <span class="n">time_margin</span><span class="p">:</span>
                                <span class="c1"># don&#39;t expect to find any interesting</span>
                                <span class="c1"># data after this point</span>
                                <span class="k">break</span>

                            <span class="n">this_time_s</span> <span class="o">=</span> <span class="n">this_time_s</span> <span class="o">-</span> <span class="n">starttime</span>

                        <span class="n">this_data</span> <span class="o">=</span> <span class="p">[</span>
                            <span class="nb">int</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="k">if</span> <span class="n">val</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                            <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">data_s</span><span class="p">[</span><span class="n">line</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
                        <span class="p">]</span>
                        <span class="n">this_nvalues</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">this_data</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
                        <span class="n">datapoint</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">data_matrix</span><span class="p">[</span><span class="n">datapoint</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:</span><span class="n">this_nvalues</span><span class="p">]</span> <span class="o">=</span> <span class="n">this_data</span><span class="p">[</span>
                            <span class="mi">1</span><span class="p">:</span>
                        <span class="p">]</span>
                        <span class="n">time_matrix</span><span class="p">[</span><span class="n">datapoint</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">this_time_s</span>

                <span class="n">n_datapoints</span> <span class="o">=</span> <span class="n">datapoint</span>
                <span class="n">data_matrix</span> <span class="o">=</span> <span class="n">data_matrix</span><span class="p">[:</span><span class="n">n_datapoints</span><span class="p">,</span> <span class="p">:]</span>
                <span class="n">time_matrix</span> <span class="o">=</span> <span class="n">time_matrix</span><span class="p">[:</span><span class="n">n_datapoints</span><span class="p">]</span>

                <span class="c1"># Correcting time data</span>
                <span class="n">status_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">data_matrix</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]))[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">time_stat</span> <span class="o">=</span> <span class="n">time_matrix</span><span class="p">[</span><span class="n">status_idx</span><span class="p">]</span>
                <span class="n">n_timepoints</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">time_stat</span><span class="p">)</span>

                <span class="c1"># Smoothing time data</span>
                <span class="n">n_interp</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="mi">25</span> <span class="o">*</span> <span class="n">status_sample_freq</span><span class="p">),</span> <span class="n">n_timepoints</span><span class="p">)</span>
                <span class="n">coeff_beg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lstsq</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span>
                        <span class="p">[(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_interp</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n_interp</span><span class="p">)]</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
                    <span class="n">time_stat</span><span class="p">[:</span><span class="n">n_interp</span><span class="p">],</span>
                    <span class="n">rcond</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">coeff_end</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lstsq</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span>
                        <span class="p">[</span>
                            <span class="p">(</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span>
                                    <span class="n">n_timepoints</span> <span class="o">-</span> <span class="n">n_interp</span><span class="p">,</span> <span class="n">n_timepoints</span>
                                <span class="p">)</span>
                                <span class="o">+</span> <span class="mi">1</span>
                            <span class="p">),</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n_interp</span><span class="p">),</span>
                        <span class="p">]</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
                    <span class="n">time_stat</span><span class="p">[</span><span class="o">-</span><span class="n">n_interp</span><span class="p">:],</span>
                    <span class="n">rcond</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gaussfir</span><span class="p">(</span><span class="mf">0.3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="nb">round</span><span class="p">(</span><span class="n">status_sample_freq</span><span class="p">))</span>
                <span class="n">n_extrap_beg</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">h</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>
                <span class="n">n_extrap_end</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">h</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">n_extrap_beg</span>
                <span class="n">time_extrap_beg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span>
                        <span class="p">(</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="n">n_extrap_beg</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">n_extrap_beg</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span>
                        <span class="p">)</span>
                    <span class="p">),</span>
                    <span class="n">coeff_beg</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">time_extrap_end</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">(</span>
                        <span class="p">(</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span>
                                <span class="n">n_timepoints</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                                <span class="n">n_timepoints</span> <span class="o">+</span> <span class="n">n_extrap_end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                            <span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">n_extrap_end</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span>
                        <span class="p">)</span>
                    <span class="p">),</span>
                    <span class="n">coeff_end</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">time_extrap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
                    <span class="p">(</span><span class="n">time_extrap_beg</span><span class="p">,</span> <span class="n">time_stat</span><span class="p">,</span> <span class="n">time_extrap_end</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="n">time_stat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gfb_conv</span><span class="p">(</span><span class="n">time_extrap</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="s2">&quot;valid&quot;</span><span class="p">)</span>
                <span class="c1"># We can also use np.convolve()!</span>
                <span class="c1"># time_stat = np.convolve(</span>
                <span class="c1">#     time_extrap.astype(int), h, mode=&quot;valid&quot;</span>
                <span class="c1"># )</span>

                <span class="c1"># Check for points where time stands still</span>
                <span class="n">time_stat_d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(([</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">time_stat</span><span class="p">)))</span>
                <span class="c1"># time_stat_d = np.diff(time_stat, prepend=0)</span>
                <span class="n">stall_points</span> <span class="o">=</span> <span class="n">time_stat_d</span> <span class="o">&lt;</span> <span class="mf">0.75</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">status_sample_freq</span><span class="p">)</span>
                <span class="n">stall_end</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">stall_points</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">stall_points</span><span class="p">)</span>
                    <span class="k">else</span> <span class="mi">0</span>
                <span class="p">)</span>
                <span class="n">regress_valid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span>
                    <span class="p">(</span>
                        <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">stall_end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n_timepoints</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)),</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">n_timepoints</span> <span class="o">-</span> <span class="n">stall_end</span><span class="p">,)),</span>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="n">time_stat</span><span class="p">[</span><span class="n">stall_end</span><span class="p">:]</span> <span class="o">=</span> <span class="n">regress_valid</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lstsq</span><span class="p">(</span>
                        <span class="n">regress_valid</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">time_stat</span><span class="p">[</span><span class="n">stall_end</span><span class="p">:],</span> <span class="n">rcond</span><span class="o">=</span><span class="kc">None</span>
                    <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="p">)</span>

                <span class="k">while</span> <span class="n">stall_end</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">stall_start</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                            <span class="n">time_stat_d</span><span class="p">[:</span><span class="n">stall_end</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">status_sample_freq</span>
                        <span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span>
                            <span class="n">time_stat_d</span><span class="p">[:</span><span class="n">stall_end</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">status_sample_freq</span>
                        <span class="p">)</span>
                        <span class="k">else</span> <span class="mi">0</span>
                    <span class="p">)</span>
                    <span class="n">sample_interv_ok</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">time_stat_d</span><span class="p">[:</span> <span class="n">stall_start</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
                        <span class="o">&lt;=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">status_sample_freq</span>
                    <span class="p">)</span>
                    <span class="n">avg_sample_interv_ok</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">time_stat</span><span class="p">[</span><span class="n">stall_end</span><span class="p">]</span> <span class="o">-</span> <span class="n">time_stat</span><span class="p">[:</span> <span class="n">stall_start</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
                    <span class="p">)</span> <span class="o">/</span> <span class="p">(</span>
                        <span class="n">stall_end</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">stall_start</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">status_sample_freq</span>
                    <span class="n">drift_start</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">sample_interv_ok</span> <span class="o">&amp;</span> <span class="n">avg_sample_interv_ok</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span>
                            <span class="o">-</span><span class="mi">1</span>
                        <span class="p">]</span>
                        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">sample_interv_ok</span> <span class="o">&amp;</span> <span class="n">avg_sample_interv_ok</span><span class="p">)</span>
                        <span class="k">else</span> <span class="mi">0</span>
                    <span class="p">)</span>
                    <span class="n">old_stall_end</span> <span class="o">=</span> <span class="n">stall_end</span>
                    <span class="n">time_stat_d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">time_stat</span><span class="p">[:</span> <span class="n">drift_start</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
                    <span class="n">stall_points</span> <span class="o">=</span> <span class="n">time_stat_d</span> <span class="o">&lt;</span> <span class="mf">0.75</span> <span class="o">*</span> <span class="p">(</span>
                        <span class="mi">1</span> <span class="o">/</span> <span class="n">status_sample_freq</span>
                    <span class="p">)</span>
                    <span class="n">stall_end</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">stall_points</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">stall_points</span><span class="p">)</span>
                        <span class="k">else</span> <span class="mi">0</span>
                    <span class="p">)</span>
                    <span class="n">regress_valid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span>
                        <span class="p">[</span>
                            <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">stall_end</span><span class="p">,</span> <span class="n">drift_start</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">drift_start</span> <span class="o">-</span> <span class="n">stall_end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
                        <span class="p">]</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">T</span>
                    <span class="c1"># fmt: off</span>
                    <span class="n">time_stat</span><span class="p">[</span><span class="n">stall_end</span><span class="p">:</span><span class="n">drift_start</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span>
                        <span class="n">regress_valid</span><span class="p">,</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lstsq</span><span class="p">(</span>
                            <span class="n">regress_valid</span><span class="p">,</span>
                            <span class="n">time_stat</span><span class="p">[</span><span class="n">stall_end</span><span class="p">:</span><span class="n">drift_start</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span>
                            <span class="n">rcond</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="p">)</span>
                    <span class="n">time_stat</span><span class="p">[</span><span class="n">drift_start</span><span class="p">:</span><span class="n">old_stall_end</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span>
                        <span class="n">time_stat</span><span class="p">[</span><span class="n">drift_start</span><span class="p">],</span>
                        <span class="n">time_stat</span><span class="p">[</span><span class="n">old_stall_end</span><span class="p">],</span>
                        <span class="n">old_stall_end</span> <span class="o">-</span> <span class="n">drift_start</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="c1"># fmt: on</span>

                <span class="k">if</span> <span class="n">paramnames</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="s2">&quot;Make_CVR_reg_physio brick: the &quot;</span>
                        <span class="s2">&quot;names of the physiological &quot;</span>
                        <span class="s2">&quot;parameters could not be found &quot;</span>
                        <span class="s2">&quot;in the physiological parameters &quot;</span>
                        <span class="s2">&quot;file!</span><span class="se">\n</span><span class="s2">The individual regressor &quot;</span>
                        <span class="s2">&quot;cannot be generated... &quot;</span>
                    <span class="p">)</span>

                <span class="c1"># Transfer data to the phys_trig_data dictionary</span>
                <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">paramnames</span><span class="p">)):</span>
                    <span class="n">this_fieldname</span> <span class="o">=</span> <span class="n">paramnames</span><span class="p">[</span><span class="n">field</span><span class="p">]</span>
                    <span class="n">this_field_datapoints</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">data_matrix</span><span class="p">[:,</span> <span class="n">field</span><span class="p">])</span>
                    <span class="n">this_field_datapoints</span><span class="p">[:</span> <span class="nb">min</span><span class="p">(</span><span class="n">status_idx</span><span class="p">)]</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="c1"># fmt: off</span>
                    <span class="n">this_field_datapoints</span><span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="n">status_idx</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="c1"># fmt: on</span>

                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">this_field_datapoints</span><span class="p">):</span>
                        <span class="n">indx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">this_field_datapoints</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">indx</span><span class="p">,</span> <span class="n">status_idx</span><span class="p">,</span> <span class="n">time_stat</span><span class="p">)</span>
                        <span class="n">data</span> <span class="o">=</span> <span class="n">data_matrix</span><span class="p">[</span><span class="n">this_field_datapoints</span><span class="p">,</span> <span class="n">field</span><span class="p">]</span>
                        <span class="n">phys_trig_data</span><span class="p">[</span><span class="n">this_fieldname</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="s2">&quot;indx&quot;</span><span class="p">:</span> <span class="n">indx</span><span class="p">,</span>
                            <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="n">time</span><span class="p">,</span>
                            <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">data</span><span class="p">,</span>
                        <span class="p">}</span>

                <span class="c1"># Correct other bugs in magdata software</span>
                <span class="n">problem_timepoints</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">phys_trig_data</span><span class="p">[</span><span class="s2">&quot;Waveform_Status3&quot;</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="p">(</span>
                    <span class="n">phys_trig_data</span><span class="p">[</span><span class="s2">&quot;Pleth_wm2&quot;</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="o">==</span> <span class="n">n_timepoints</span>
                <span class="p">):</span>
                    <span class="n">problem_timepoints</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span>
                        <span class="n">problem_timepoints</span><span class="p">,</span>
                        <span class="n">phys_trig_data</span><span class="p">[</span><span class="s2">&quot;Pleth_wm2&quot;</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">103</span><span class="p">,</span>
                    <span class="p">)</span>

                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">problem_timepoints</span><span class="p">):</span>
                    <span class="n">valid_timepoints</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="n">problem_timepoints</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

                    <span class="k">if</span> <span class="p">(</span>
                        <span class="n">phys_trig_data</span><span class="p">[</span><span class="s2">&quot;Resp_wm&quot;</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="o">==</span> <span class="n">phys_trig_data</span><span class="p">[</span><span class="s2">&quot;Capno_wm1&quot;</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="p">):</span>
                        <span class="n">phys_trig_data</span><span class="p">[</span><span class="s2">&quot;Capno_wm1&quot;</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">][</span>
                            <span class="n">problem_timepoints</span>
                        <span class="p">]</span> <span class="o">=</span> <span class="n">phys_trig_data</span><span class="p">[</span><span class="s2">&quot;Resp_wm&quot;</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">][</span>
                            <span class="n">problem_timepoints</span>
                        <span class="p">]</span>
                        <span class="n">problem_problem_timepoints</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
                            <span class="n">problem_timepoints</span><span class="p">,</span>
                            <span class="n">phys_trig_data</span><span class="p">[</span><span class="s2">&quot;Resp_wm&quot;</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="p">)</span>
                        <span class="n">phys_trig_data</span><span class="p">[</span><span class="s2">&quot;Capno_wm1&quot;</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">][</span>
                            <span class="n">problem_problem_timepoints</span>
                        <span class="p">]</span> <span class="o">=</span> <span class="n">phys_trig_data</span><span class="p">[</span><span class="s2">&quot;Waveform_Status1&quot;</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">][</span>
                            <span class="n">problem_problem_timepoints</span>
                        <span class="p">]</span>
                        <span class="n">phys_trig_data</span><span class="p">[</span><span class="s2">&quot;Resp_wm&quot;</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">][</span>
                            <span class="n">problem_timepoints</span>
                        <span class="p">]</span> <span class="o">=</span> <span class="n">phys_trig_data</span><span class="p">[</span><span class="s2">&quot;Pleth_wm2&quot;</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">][</span>
                            <span class="n">problem_timepoints</span>
                        <span class="p">]</span>
                        <span class="n">phys_trig_data</span><span class="p">[</span><span class="s2">&quot;Pleth_wm2&quot;</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">][</span>
                            <span class="n">problem_timepoints</span>
                        <span class="p">]</span> <span class="o">=</span> <span class="n">phys_trig_data</span><span class="p">[</span><span class="s2">&quot;Pleth_wm1&quot;</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">][</span>
                            <span class="n">problem_timepoints</span>
                        <span class="p">]</span>
                        <span class="n">problem_timepoints</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">problem_timepoints</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">phys_trig_data</span><span class="p">[</span><span class="s2">&quot;Waveform_Status1&quot;</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">][</span>
                            <span class="n">problem_timepoints</span>
                        <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span>
                            <span class="n">phys_trig_data</span><span class="p">[</span><span class="s2">&quot;Waveform_Status1&quot;</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">][</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">problem_timepoints</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                            <span class="p">],</span>
                            <span class="n">phys_trig_data</span><span class="p">[</span><span class="s2">&quot;Waveform_Status1&quot;</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">][</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span>
                                    <span class="n">problem_timepoints</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                                    <span class="n">phys_trig_data</span><span class="p">[</span><span class="s2">&quot;Waveform_Status1&quot;</span><span class="p">][</span>
                                        <span class="s2">&quot;data&quot;</span>
                                    <span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                <span class="p">)</span>
                            <span class="p">],</span>
                        <span class="p">)</span>
                        <span class="n">phys_trig_data</span><span class="p">[</span><span class="s2">&quot;Waveform_Status4&quot;</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">][</span>
                            <span class="n">problem_timepoints</span>
                        <span class="p">]</span> <span class="o">=</span> <span class="mi">128</span> <span class="o">*</span> <span class="p">(</span>
                            <span class="p">(</span>
                                <span class="n">phys_trig_data</span><span class="p">[</span><span class="s2">&quot;Waveform_Status4&quot;</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">][</span>
                                    <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">problem_timepoints</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                                <span class="p">]</span>
                                <span class="o">&gt;</span> <span class="mi">64</span>
                            <span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span>
                            <span class="ow">or</span> <span class="p">(</span>
                                <span class="n">phys_trig_data</span><span class="p">[</span><span class="s2">&quot;Waveform_Status4&quot;</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">][</span>
                                    <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span>
                                        <span class="n">problem_timepoints</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                                        <span class="n">phys_trig_data</span><span class="p">[</span><span class="s2">&quot;Waveform_Status4&quot;</span><span class="p">][</span>
                                            <span class="s2">&quot;data&quot;</span>
                                        <span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                        <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
                                    <span class="p">)</span>
                                <span class="p">]</span>
                                <span class="o">&gt;</span> <span class="mi">64</span>
                            <span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span>
                        <span class="p">)</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">phys_trig_data</span><span class="p">[</span><span class="s2">&quot;Capno_wm1&quot;</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">][</span>
                            <span class="n">problem_timepoints</span>
                        <span class="p">]</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span>
                            <span class="n">phys_trig_data</span><span class="p">[</span><span class="s2">&quot;Capno_wm1&quot;</span><span class="p">][</span><span class="s2">&quot;time&quot;</span><span class="p">][</span>
                                <span class="n">valid_timepoints</span>
                            <span class="p">],</span>
                            <span class="n">phys_trig_data</span><span class="p">[</span><span class="s2">&quot;Capno_wm1&quot;</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">][</span>
                                <span class="n">valid_timepoints</span>
                            <span class="p">],</span>
                            <span class="n">fill_value</span><span class="o">=</span><span class="s2">&quot;extrapolate&quot;</span><span class="p">,</span>
                        <span class="p">)(</span>
                            <span class="n">phys_trig_data</span><span class="p">[</span><span class="s2">&quot;Capno_wm1&quot;</span><span class="p">][</span><span class="s2">&quot;time&quot;</span><span class="p">][</span>
                                <span class="n">problem_timepoints</span>
                            <span class="p">]</span>
                        <span class="p">)</span>

                        <span class="k">if</span> <span class="p">(</span>
                            <span class="n">data_matrix</span><span class="p">[</span><span class="s2">&quot;Pleth_wm2&quot;</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="o">==</span> <span class="n">n_timepoints</span>
                        <span class="p">):</span>
                            <span class="n">phys_trig_data</span><span class="p">[</span><span class="s2">&quot;Pleth_wm2&quot;</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">][</span>
                                <span class="n">problem_timepoints</span>
                            <span class="p">]</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span>
                                <span class="n">phys_trig_data</span><span class="p">[</span><span class="s2">&quot;Pleth_wm2&quot;</span><span class="p">][</span><span class="s2">&quot;time&quot;</span><span class="p">][</span>
                                    <span class="n">valid_timepoints</span>
                                <span class="p">],</span>
                                <span class="n">phys_trig_data</span><span class="p">[</span><span class="s2">&quot;Pleth_wm2&quot;</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">][</span>
                                    <span class="n">valid_timepoints</span>
                                <span class="p">],</span>
                                <span class="n">fill_value</span><span class="o">=</span><span class="s2">&quot;extrapolate&quot;</span><span class="p">,</span>
                            <span class="p">)(</span>
                                <span class="n">phys_trig_data</span><span class="p">[</span><span class="s2">&quot;Pleth_wm2&quot;</span><span class="p">][</span><span class="s2">&quot;time&quot;</span><span class="p">][</span>
                                    <span class="n">problem_timepoints</span>
                                <span class="p">]</span>
                            <span class="p">)</span>
                        <span class="n">problem_timepoints</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">problem_timepoints</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">phys_trig_data</span><span class="p">[</span><span class="s2">&quot;Waveform_Status1&quot;</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">][</span>
                            <span class="n">problem_timepoints</span>
                        <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span>
                            <span class="n">phys_trig_data</span><span class="p">[</span><span class="s2">&quot;Waveform_Status1&quot;</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">][</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">problem_timepoints</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                            <span class="p">],</span>
                            <span class="n">phys_trig_data</span><span class="p">[</span><span class="s2">&quot;Waveform_Status1&quot;</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">][</span>
                                <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span>
                                    <span class="n">problem_timepoints</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                                    <span class="n">phys_trig_data</span><span class="p">[</span><span class="s2">&quot;Waveform_Status1&quot;</span><span class="p">][</span>
                                        <span class="s2">&quot;data&quot;</span>
                                    <span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                <span class="p">)</span>
                            <span class="p">],</span>
                        <span class="p">)</span>
                        <span class="n">phys_trig_data</span><span class="p">[</span><span class="s2">&quot;Waveform_Status4&quot;</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">][</span>
                            <span class="n">problem_timepoints</span>
                        <span class="p">]</span> <span class="o">=</span> <span class="mi">128</span> <span class="o">*</span> <span class="p">(</span>
                            <span class="p">(</span>
                                <span class="n">phys_trig_data</span><span class="p">[</span><span class="s2">&quot;Waveform_Status4&quot;</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">][</span>
                                    <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">problem_timepoints</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                                <span class="p">]</span>
                                <span class="o">&gt;</span> <span class="mi">64</span>
                            <span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span>
                            <span class="ow">or</span> <span class="p">(</span>
                                <span class="n">phys_trig_data</span><span class="p">[</span><span class="s2">&quot;Waveform_Status4&quot;</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">][</span>
                                    <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span>
                                        <span class="n">problem_timepoints</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                                        <span class="n">phys_trig_data</span><span class="p">[</span><span class="s2">&quot;Waveform_Status4&quot;</span><span class="p">][</span>
                                            <span class="s2">&quot;data&quot;</span>
                                        <span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                        <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
                                    <span class="p">)</span>
                                <span class="p">]</span>
                                <span class="o">&gt;</span> <span class="mi">64</span>
                            <span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span>
                        <span class="p">)</span>

                <span class="k">if</span> <span class="n">n_pulses</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">phys_trig_data</span><span class="p">[</span><span class="s2">&quot;trigger&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="n">trig_times_s</span><span class="p">,</span>
                        <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">trig_times_s</span><span class="p">),</span>
                    <span class="p">}</span>

                <span class="n">phys_trig_data</span><span class="p">[</span><span class="s2">&quot;starttime&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">starttime</span>

            <span class="c1"># Read CoolTerm capture log</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">physio_data</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.txt&quot;</span><span class="p">):</span>
                <span class="c1"># tested: OK</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Data from CoolTerm application detected ...&quot;</span><span class="p">)</span>

                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">physio_data</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fid</span><span class="p">:</span>
                    <span class="n">lines</span> <span class="o">=</span> <span class="n">fid</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>

                <span class="c1"># Replacing multiple delimiters with single delimiter</span>
                <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[, \t]+&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span>
                <span class="p">]</span>
                <span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">]</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="p">(</span>
                    <span class="n">comp_date</span><span class="p">,</span>
                    <span class="n">comp_time</span><span class="p">,</span>
                    <span class="n">monitor_date</span><span class="p">,</span>
                    <span class="n">monitor_time</span><span class="p">,</span>
                    <span class="n">HR</span><span class="p">,</span>
                    <span class="n">SPO2t</span><span class="p">,</span>
                    <span class="n">_</span><span class="p">,</span>
                    <span class="n">_</span><span class="p">,</span>
                    <span class="n">_</span><span class="p">,</span>
                    <span class="n">_</span><span class="p">,</span>
                    <span class="n">_</span><span class="p">,</span>
                    <span class="n">_</span><span class="p">,</span>
                    <span class="n">_</span><span class="p">,</span>
                    <span class="n">_</span><span class="p">,</span>
                    <span class="n">_</span><span class="p">,</span>
                    <span class="n">SpO2</span><span class="p">,</span>
                    <span class="n">BR</span><span class="p">,</span>
                    <span class="n">ETCO2</span><span class="p">,</span>
                    <span class="n">ICO2</span><span class="p">,</span>
                    <span class="n">_</span><span class="p">,</span>
                    <span class="n">_</span><span class="p">,</span>
                    <span class="n">_</span><span class="p">,</span>
                    <span class="n">_</span><span class="p">,</span>
                    <span class="n">_</span><span class="p">,</span>
                    <span class="n">_</span><span class="p">,</span>
                <span class="p">)</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">data</span><span class="p">)</span>

                <span class="c1"># Convert sample start and end times to seconds since midnight</span>
                <span class="k">def</span> <span class="nf">time_to_seconds</span><span class="p">(</span><span class="n">time_str</span><span class="p">):</span>
<span class="w">                    </span><span class="sd">&quot;&quot;&quot;Convert time in seconds&quot;&quot;&quot;</span>
                    <span class="n">hours</span><span class="p">,</span> <span class="n">minutes</span><span class="p">,</span> <span class="n">seconds</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">time_str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">))</span>
                    <span class="k">return</span> <span class="mi">3600</span> <span class="o">*</span> <span class="n">hours</span> <span class="o">+</span> <span class="mi">60</span> <span class="o">*</span> <span class="n">minutes</span> <span class="o">+</span> <span class="n">seconds</span>

                <span class="n">sampletime</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">time_to_seconds</span><span class="p">(</span><span class="n">time_str</span><span class="p">)</span> <span class="k">for</span> <span class="n">time_str</span> <span class="ow">in</span> <span class="n">comp_time</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="n">keep_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
                        <span class="n">sampletime</span> <span class="o">&gt;=</span> <span class="n">starttime</span> <span class="o">-</span> <span class="n">time_margin</span><span class="p">,</span>
                        <span class="n">sampletime</span> <span class="o">&lt;=</span> <span class="n">endtime</span> <span class="o">+</span> <span class="n">time_margin</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">sampletime</span> <span class="o">=</span> <span class="n">sampletime</span><span class="p">[</span><span class="n">keep_idx</span><span class="p">]</span> <span class="o">-</span> <span class="n">starttime</span>
                <span class="n">HR</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">HR</span><span class="p">)[</span><span class="n">keep_idx</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
                <span class="n">BR</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">BR</span><span class="p">)[</span><span class="n">keep_idx</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
                <span class="n">ICO2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ICO2</span><span class="p">)[</span><span class="n">keep_idx</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
                <span class="n">ETCO2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ETCO2</span><span class="p">)[</span><span class="n">keep_idx</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
                <span class="n">SpO2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">SpO2</span><span class="p">)[</span><span class="n">keep_idx</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>

                <span class="c1"># Transfer data to phys_trig_data dictionary</span>
                <span class="n">phys_trig_data</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;HR&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;indx&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">HR</span><span class="p">))[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="n">sampletime</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">HR</span><span class="p">)],</span>
                        <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">HR</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">HR</span><span class="p">)],</span>
                    <span class="p">},</span>
                    <span class="s2">&quot;Resp_Rate&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;indx&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">BR</span><span class="p">))[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="n">sampletime</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">BR</span><span class="p">)],</span>
                        <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">BR</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">BR</span><span class="p">)],</span>
                    <span class="p">},</span>
                    <span class="s2">&quot;ICO2&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;indx&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">ICO2</span><span class="p">))[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="n">sampletime</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">ICO2</span><span class="p">)],</span>
                        <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">ICO2</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">ICO2</span><span class="p">)],</span>
                    <span class="p">},</span>
                    <span class="s2">&quot;ETCO2&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;indx&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">ETCO2</span><span class="p">))[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="n">sampletime</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">ETCO2</span><span class="p">)],</span>
                        <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">ETCO2</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">ETCO2</span><span class="p">)],</span>
                    <span class="p">},</span>
                    <span class="s2">&quot;SpO2_perc&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;indx&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">SpO2</span><span class="p">))[</span><span class="mi">0</span><span class="p">],</span>
                        <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="n">sampletime</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">SpO2</span><span class="p">)],</span>
                        <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">SpO2</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">SpO2</span><span class="p">)],</span>
                    <span class="p">},</span>
                <span class="p">}</span>

                <span class="k">if</span> <span class="n">n_pulses</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># We have read a trigger file</span>
                    <span class="n">phys_trig_data</span><span class="p">[</span><span class="s2">&quot;trigger&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="n">trig_times_s</span><span class="p">,</span>
                        <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">trig_times_s</span><span class="p">),</span>
                    <span class="p">}</span>

                <span class="c1"># In units of seconds since midnight</span>
                <span class="n">phys_trig_data</span><span class="p">[</span><span class="s2">&quot;starttime&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">starttime</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span>
                    <span class="s2">&quot;Make_CVR_reg_physio brick: The Only &quot;</span>
                    <span class="s2">&quot;.csv and .txt extensions are &quot;</span>
                    <span class="s2">&quot;allowed for the physio_data &quot;</span>
                    <span class="s2">&quot;parameter. The individual regressor &quot;</span>
                    <span class="s2">&quot;cannot be generated... &quot;</span>
                <span class="p">)</span>
            <span class="c1"># ---- End of making phys_trig_data ----</span>

            <span class="c1"># performed for all odd frames</span>
            <span class="n">triggers</span> <span class="o">=</span> <span class="n">phys_trig_data</span><span class="p">[</span><span class="s2">&quot;trigger&quot;</span><span class="p">][</span><span class="s2">&quot;time&quot;</span><span class="p">]</span>
            <span class="n">trig_TR</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">triggers</span><span class="p">))</span>
            <span class="n">etco2data</span> <span class="o">=</span> <span class="n">phys_trig_data</span><span class="p">[</span><span class="s2">&quot;ETCO2&quot;</span><span class="p">][</span><span class="s2">&quot;data&quot;</span><span class="p">]</span>
            <span class="n">etco2time</span> <span class="o">=</span> <span class="n">phys_trig_data</span><span class="p">[</span><span class="s2">&quot;ETCO2&quot;</span><span class="p">][</span><span class="s2">&quot;time&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">delay_for_etco2</span>
            <span class="n">outliers_etco2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">etco2data</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">,</span> <span class="n">etco2data</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">)</span>
            <span class="n">valid_etco2</span> <span class="o">=</span> <span class="o">~</span><span class="n">outliers_etco2</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">etco2time</span><span class="p">[</span><span class="n">valid_etco2</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Make_CVR_reg_physio brick: The time relative to the &quot;</span>
                    <span class="s2">&quot;EtCO2 recording does not seem to be strictly monotonic &quot;</span>
                    <span class="s2">&quot;and increasing !!!</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="s2">&quot;This makes no physical sense and the calculation of &quot;</span>
                    <span class="s2">&quot;the hypercapnic individual regressor will certainly &quot;</span>
                    <span class="s2">&quot;fail.</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="p">)</span>

                <span class="nb">print</span><span class="p">(</span>
                    <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Make_CVR_reg_physio brick: Trying to fix the &quot;</span>
                    <span class="s2">&quot;issue!!!</span><span class="se">\n</span><span class="s2">Please check the result carefully, this &quot;</span>
                    <span class="s2">&quot;is an automatic process ....</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                <span class="p">)</span>

                <span class="n">x</span> <span class="o">=</span> <span class="n">etco2time</span><span class="p">[</span><span class="n">valid_etco2</span><span class="p">]</span>
                <span class="n">x2</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">return_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">etco2data</span><span class="p">[</span><span class="n">outliers_etco2</span><span class="p">[</span><span class="n">index</span><span class="p">]]</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span>
                    <span class="n">etco2time</span><span class="p">[</span><span class="n">outliers_etco2</span><span class="p">],</span> <span class="n">x2</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;cubic&quot;</span>
                <span class="p">)(</span><span class="n">etco2data</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">etco2data</span><span class="p">[</span><span class="n">outliers_etco2</span><span class="p">]</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span>
                    <span class="n">etco2time</span><span class="p">[</span><span class="n">valid_etco2</span><span class="p">],</span>
                    <span class="n">etco2data</span><span class="p">[</span><span class="n">valid_etco2</span><span class="p">],</span>
                    <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;cubic&quot;</span><span class="p">,</span>
                <span class="p">)(</span><span class="n">etco2time</span><span class="p">[</span><span class="n">outliers_etco2</span><span class="p">])</span>

            <span class="k">for</span> <span class="nb">iter</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span>
                <span class="c1"># clean the etco2 data:</span>
                <span class="c1"># second derivative to get local outliers</span>
                <span class="n">etco2data_pp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">etco2data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">),</span> <span class="n">n</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                <span class="c1"># detect outliers (very crude)</span>
                <span class="n">outliers</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">etco2data_pp</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">15</span>
                <span class="c1"># a single outlier creates three points of high curvature.</span>
                <span class="c1"># retain central point only:</span>
                <span class="c1"># TODO: Here, we can also use self.gfb_conv(). Test it out!</span>
                <span class="n">outliers</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span>
                        <span class="n">outliers</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;same&quot;</span>
                    <span class="p">)</span>
                    <span class="o">==</span> <span class="mi">3</span>
                <span class="p">)</span>
                <span class="c1"># correct shift due to derivative above</span>
                <span class="n">outliers</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">outliers</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">etco2data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">etco2data</span><span class="p">,</span> <span class="n">outliers</span><span class="p">)</span>
                <span class="n">etco2time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">etco2time</span><span class="p">,</span> <span class="n">outliers</span><span class="p">)</span>

            <span class="c1"># sort data and combine data from identical timepoints</span>
            <span class="n">etco2time</span><span class="p">,</span> <span class="n">sort_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">etco2time</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">etco2time</span><span class="p">)</span>
            <span class="n">etco2data</span> <span class="o">=</span> <span class="n">etco2data</span><span class="p">[</span><span class="n">sort_idx</span><span class="p">]</span>
            <span class="n">step_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">etco2time</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">step_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">union1d</span><span class="p">(</span><span class="n">step_points</span><span class="p">,</span> <span class="n">step_points</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">step_times</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">etco2time</span><span class="p">[</span><span class="n">step_points</span><span class="p">])</span>

            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">step_times</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">this_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">etco2time</span> <span class="o">==</span> <span class="n">step_times</span><span class="p">[</span><span class="n">k</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">etco2data</span><span class="p">[</span><span class="n">this_points</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">etco2data</span><span class="p">[</span><span class="n">this_points</span><span class="p">])</span>
                <span class="n">etco2data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">etco2data</span><span class="p">,</span> <span class="n">this_points</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
                <span class="n">etco2time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">etco2time</span><span class="p">,</span> <span class="n">this_points</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>

            <span class="c1"># add artificial triggers before and after scan (while we have</span>
            <span class="c1"># data) to help with convolution of regressors with hrf</span>
            <span class="n">num_init_trigs</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">((</span><span class="nb">min</span><span class="p">(</span><span class="n">triggers</span><span class="p">)</span> <span class="o">-</span> <span class="nb">min</span><span class="p">(</span><span class="n">etco2time</span><span class="p">))</span> <span class="o">/</span> <span class="n">trig_TR</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">num_post_trigs</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">((</span><span class="nb">max</span><span class="p">(</span><span class="n">etco2time</span><span class="p">)</span> <span class="o">-</span> <span class="nb">max</span><span class="p">(</span><span class="n">triggers</span><span class="p">))</span> <span class="o">/</span> <span class="n">trig_TR</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">triggers</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
                <span class="p">(</span>
                    <span class="n">trig_TR</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_init_trigs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
                    <span class="o">+</span> <span class="nb">min</span><span class="p">(</span><span class="n">triggers</span><span class="p">),</span>
                    <span class="n">triggers</span><span class="p">,</span>
                    <span class="nb">max</span><span class="p">(</span><span class="n">triggers</span><span class="p">)</span> <span class="o">+</span> <span class="n">trig_TR</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_post_trigs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">etco2data</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span><span class="n">etco2time</span><span class="p">,</span> <span class="n">etco2data</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;cubic&quot;</span><span class="p">)(</span><span class="n">triggers</span><span class="p">)</span>
            <span class="c1"># value separating &#39;hypercapnia&#39; from &#39;normocapnia&#39;</span>
            <span class="n">median_etco2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">etco2data</span><span class="p">)</span>
            <span class="c1"># average of &#39;normocapnia&#39;</span>
            <span class="n">baseline_etco2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">etco2data</span><span class="p">[</span><span class="n">etco2data</span> <span class="o">&lt;</span> <span class="n">median_etco2</span><span class="p">])</span>
            <span class="c1"># shift baseline hc to zero, approximately</span>
            <span class="n">etco2data_shift</span> <span class="o">=</span> <span class="n">etco2data</span> <span class="o">-</span> <span class="n">baseline_etco2</span>
            <span class="n">etco2data_bold</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">etco2data_shift</span><span class="p">,</span> <span class="n">hrf</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;full&quot;</span><span class="p">)</span>
            <span class="c1"># fmt: off</span>
            <span class="n">io</span><span class="o">.</span><span class="n">savemat</span><span class="p">(</span>
                <span class="n">fname_reg</span><span class="p">,</span>
                <span class="p">{</span>
                    <span class="s2">&quot;R&quot;</span><span class="p">:</span> <span class="n">etco2data_bold</span><span class="p">[</span>
                        <span class="n">num_init_trigs</span><span class="p">:</span><span class="n">num_init_trigs</span> <span class="o">+</span> <span class="n">nb_dyn</span>
                    <span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
                <span class="p">},</span>
            <span class="p">)</span>
            <span class="c1"># fmt: on</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Make_CVR_reg_physio brick: &quot;</span>
                <span class="s2">&quot;individual regressor generated!&quot;</span>
            <span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Make_CVR_reg_physio brick: The generation of the &quot;</span>
                <span class="s2">&quot;individual regressor has failed!</span><span class="se">\n</span><span class="s2">Traceback:&quot;</span>
            <span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_tb</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">__traceback__</span><span class="p">)),</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">: </span><span class="si">{1}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">...Using the standard regressor...</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">tag_to_add</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Standard&quot;</span>
            <span class="n">config</span> <span class="o">=</span> <span class="n">Config</span><span class="p">()</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="n">config</span><span class="o">.</span><span class="n">get_resources_path</span><span class="p">(),</span>
                    <span class="s2">&quot;reference_population_data&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;regressor_physio_EtCO2_standard.mat&quot;</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">fname_reg</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Make_CVR_reg_physio brick: &quot;</span> <span class="s2">&quot;standard regressor generated!&quot;</span>
            <span class="p">)</span>

        <span class="n">all_tags_to_add</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tag_to_add</span><span class="p">)</span>
        <span class="c1"># TODO: Can we simply add new tags without inheritance (I&#39;m not sure</span>
        <span class="c1">#       this possibility was considered when we coded the</span>
        <span class="c1">#       tags_inheritance function)? As in this case, it might be</span>
        <span class="c1">#       preferable not to inherit from the functional but simply to</span>
        <span class="c1">#       add new tags.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tags_inheritance</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">func_file</span><span class="p">,</span> <span class="n">fname_reg</span><span class="p">,</span> <span class="n">own_tags</span><span class="o">=</span><span class="n">all_tags_to_add</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;cvr_reg&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fname_reg</span>
        <span class="c1"># Return the requirement, outputs and inheritance_dict</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_initResult</span><span class="p">()</span></div>

<div class="viewcode-block" id="Make_CVR_reg_physio.spm_hrf"><a class="viewcode-back" href="../../../../mia_processes.bricks.tools.html#mia_processes.bricks.tools.tools.Make_CVR_reg_physio.spm_hrf">[docs]</a>    <span class="k">def</span> <span class="nf">spm_hrf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rt</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">32</span><span class="p">],</span> <span class="n">t</span><span class="o">=</span><span class="mi">16</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Hemodynamic response function.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        - rt: scan repeat time</span>
<span class="sd">        - p: parameters of the response function (two Gamma functions)</span>
<span class="sd">        (Default: [6, 16, 1, 1, 6, 0, 32])</span>
<span class="sd">        - t: microtime resolution (Default: 16)</span>

<span class="sd">        Returns:</span>
<span class="sd">        - hrf: hemodynamic response function</span>
<span class="sd">        - p: parameters of the response function</span>

<span class="sd">        Note: Adapted from SPM12 matlab code (spm_hrf.m)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">gam_dis_pdf</span><span class="p">(</span><span class="n">ga</span><span class="p">,</span> <span class="n">sh</span><span class="p">,</span> <span class="n">sc</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Probability Density Function (PDF) of Gamma distribution.</span>

<span class="sd">            Parameters:</span>
<span class="sd">            - ga: Gamma-variate (Gamma has range [0,Inf))</span>
<span class="sd">            - sh: Shape parameter (h &gt; 0)</span>
<span class="sd">            - sc: Scale parameter (l &gt; 0)</span>

<span class="sd">            Returns:</span>
<span class="sd">            - f: PDF of Gamma-distribution with shape &amp; scale parameters</span>

<span class="sd">            Note: Adapted from SPM12 matlab code (spm_Gpdf.m).</span>
<span class="sd">                  Warning: very specific to the spm_hrf case,</span>
<span class="sd">                  no argument validity test is performed.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="c1"># Initialise result to zeros</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ga</span><span class="p">))</span>
            <span class="c1"># Compute</span>
            <span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span>
                <span class="p">(</span><span class="n">sh</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">ga</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
                <span class="o">+</span> <span class="n">sh</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">sc</span><span class="p">)</span>
                <span class="o">-</span> <span class="n">sc</span> <span class="o">*</span> <span class="n">ga</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
                <span class="o">-</span> <span class="n">gammaln</span><span class="p">(</span><span class="n">sh</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="k">return</span> <span class="n">f</span>

        <span class="c1"># from scipy.stats import gamma</span>
        <span class="c1"># Modelled hemodynamic response function - {mixture of Gammas}</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">rt</span> <span class="o">/</span> <span class="n">t</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">/</span> <span class="n">dt</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">p</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">/</span> <span class="n">dt</span>
        <span class="c1"># hrf = (gamma.pdf(u, p[0] / p[2], scale=dt / p[2]) -</span>
        <span class="c1">#        gamma.pdf(u, p[1] / p[3], scale=dt / p[3]) / p[4])</span>
        <span class="c1"># We can also use the self.gam_dis_pdf() function:</span>
        <span class="n">hrf</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">gam_dis_pdf</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">dt</span> <span class="o">/</span> <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            <span class="o">-</span> <span class="n">gam_dis_pdf</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">p</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">dt</span> <span class="o">/</span> <span class="n">p</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">/</span> <span class="n">p</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">hrf</span> <span class="o">=</span> <span class="n">hrf</span><span class="p">[(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">//</span> <span class="n">rt</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">t</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)]</span>
        <span class="n">hrf</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">hrf</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">hrf</span></div>

<div class="viewcode-block" id="Make_CVR_reg_physio.run_process_mia"><a class="viewcode-back" href="../../../../mia_processes.bricks.tools.html#mia_processes.bricks.tools.tools.Make_CVR_reg_physio.run_process_mia">[docs]</a>    <span class="k">def</span> <span class="nf">run_process_mia</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Dedicated to the process launch step of the brick.&quot;&quot;&quot;</span>
        <span class="c1"># The regressor is created at initialisation time rather than at</span>
        <span class="c1"># runtime because some bricks that use this regressor need to consult</span>
        <span class="c1"># it at initialisation time (e.g. Level1Design)!</span>
        <span class="k">return</span></div></div>
</pre></div>

      </div>
      <div class="bottomnav" role="navigation" aria-label="bottom navigation">
      
        <p>
        <a class="uplink" href="../../../../index.html">Contents</a>
        </p>

      </div>

    <div class="footer" role="contentinfo">
    &#169; Copyright 2019, populse.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.1.2.
    </div>
  </body>
</html>