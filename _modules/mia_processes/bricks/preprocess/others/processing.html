
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>mia_processes.bricks.preprocess.others.processing &#8212; mia_processes 2.0.1-dev+a88eee2 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../../../_static/haiku.css" />
    <script data-url_root="../../../../../" id="documentation_options" src="../../../../../_static/documentation_options.js"></script>
    <script src="../../../../../_static/jquery.js"></script>
    <script src="../../../../../_static/underscore.js"></script>
    <script src="../../../../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../search.html" /> 
  </head><body>
      <div class="header" role="banner"><h1 class="heading"><a href="../../../../../index.html">
          <span>mia_processes 2.0.1-dev+a88eee2 documentation</span></a></h1>
        <h2 class="heading"><span>mia_processes.bricks.preprocess.others.processing</span></h2>
      </div>
      <div class="topnav" role="navigation" aria-label="top navigation">
      
        <p>
        <a class="uplink" href="../../../../../index.html">Contents</a>
        </p>

      </div>
      <div class="content" role="main">
        
        
  <h1>Source code for mia_processes.bricks.preprocess.others.processing</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;The other preprocess library of the mia_processe package.</span>

<span class="sd">The purpose of this module is to provide bricks generally necessary for the </span>
<span class="sd">pre-processing steps, which are not found in nipype.</span>

<span class="sd">:Contains:</span>
<span class="sd">    :Class:</span>
<span class="sd">        - Resample</span>
<span class="sd">        - Threshold</span>
<span class="sd">    :Function:</span>
<span class="sd">        - threshold</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="c1">##########################################################################</span>
<span class="c1"># mia_processes - Copyright (C) IRMaGe/CEA, 2018</span>
<span class="c1"># Distributed under the terms of the CeCILL license, as published by</span>
<span class="c1"># the CEA-CNRS-INRIA. Refer to the LICENSE file or to</span>
<span class="c1"># http://www.cecill.info/licences/Licence_CeCILL_V2.1-en.html</span>
<span class="c1"># for details.</span>
<span class="c1">##########################################################################</span>

<span class="c1"># nibabel import</span>
<span class="kn">import</span> <span class="nn">nibabel</span> <span class="k">as</span> <span class="nn">nib</span>
<span class="kn">import</span> <span class="nn">nibabel.processing</span> <span class="k">as</span> <span class="nn">nibp</span>

<span class="c1"># nipype import</span>
<span class="kn">from</span> <span class="nn">nipype.interfaces.base</span> <span class="kn">import</span> <span class="p">(</span><span class="n">OutputMultiPath</span><span class="p">,</span> <span class="n">InputMultiPath</span><span class="p">,</span> <span class="n">File</span><span class="p">,</span>
                                    <span class="n">traits</span><span class="p">,</span> <span class="n">TraitListObject</span><span class="p">,</span> <span class="n">Undefined</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">nipype.interfaces.spm.base</span> <span class="kn">import</span> <span class="n">ImageFileSPM</span>

<span class="c1"># populse_mia import</span>
<span class="kn">from</span> <span class="nn">populse_mia.user_interface.pipeline_manager.process_mia</span> <span class="kn">import</span> <span class="n">ProcessMIA</span>

<span class="c1"># soma-base imports</span>
<span class="kn">from</span> <span class="nn">soma.qt_gui.qt_backend.Qt</span> <span class="kn">import</span> <span class="n">QMessageBox</span>

<span class="c1"># Other import</span>
<span class="kn">import</span> <span class="nn">os</span>


<div class="viewcode-block" id="Resample"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.others.html#mia_processes.bricks.preprocess.others.processing.Resample">[docs]</a><span class="k">class</span> <span class="nc">Resample</span><span class="p">(</span><span class="n">ProcessMIA</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    *Resamples an image to the resolution of a reference image*</span>

<span class="sd">    Please, see the complete documention for the `Resample brick in the populse.mia_processes web site</span>
<span class="sd">    https://populse.github.io/mia_processes/documentation/bricks/preprocess/other/Resample.html</span>

<span class="sd">   &quot;&quot;&quot;</span>
    
<div class="viewcode-block" id="Resample.__init__"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.others.html#mia_processes.bricks.preprocess.others.processing.Resample.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the attributes initialisation / instanciation.</span>
<span class="sd">        </span>
<span class="sd">        The input and output plugs are defined here. The special</span>
<span class="sd">        &#39;self.requirement&#39; attribute (optional) is used to define the</span>
<span class="sd">        third-party products necessary for the running of the brick.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Initialisation of the objects needed for the launch of the brick</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Resample</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1"># Third party softwares required for the execution of the brick</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requirement</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Inputs description</span>
        <span class="n">reference_image_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;A 3D or 4D image used as reference to &#39;</span>
                                <span class="s1">&#39;resample the files_to_resample images (a &#39;</span>
                                <span class="s1">&#39;pathlike object or string representing a file &#39;</span>
                                <span class="s1">&#39;with extension in [.img, .nii, .hdr]).&#39;</span><span class="p">)</span>
        
        <span class="n">files_to_resample_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;The 3D images that will be resampled (a &#39;</span>
                                  <span class="s1">&#39;list of pathlike object or string &#39;</span>
                                  <span class="s1">&#39;representing a file or a list of items &#39;</span>
                                  <span class="s1">&#39;which are a pathlike object or string &#39;</span>
                                  <span class="s1">&#39;representing a file, valid extensions: &#39;</span>
                                  <span class="s1">&#39;[.img, .nii, .hdr]).&#39;</span><span class="p">)</span>
        <span class="n">suffix_to_delete_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;The suffix to delete from the &#39;</span>
                                 <span class="s1">&#39;files_to_resample, when creating the &#39;</span>
                                 <span class="s1">&#39;out_files (a string).&#39;</span><span class="p">)</span>
        <span class="n">suffix_desc</span> <span class="o">=</span> <span class="s1">&#39;The suffix for the out_files image (a string).&#39;</span>
        <span class="n">prefix_desc</span> <span class="o">=</span> <span class="s1">&#39;The prefix for the  out_files image (a string).&#39;</span>
        <span class="n">interp_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;The order of the spline interpolation (an integer &#39;</span>
                       <span class="s1">&#39;between 0 and 5; trilinear == 3).&#39;</span><span class="p">)</span>
        
        <span class="c1"># Outputs description</span>
        <span class="n">out_files_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;The resulting image after resampling (a pathlike &#39;</span>
                         <span class="s1">&#39;object or string representing a file, or a list of &#39;</span>
                         <span class="s1">&#39;pathlike objects or strings representing a file).&#39;</span><span class="p">)</span>
        
        <span class="c1"># Inputs traits</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;reference_image&quot;</span><span class="p">,</span>
                       <span class="n">ImageFileSPM</span><span class="p">(</span><span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                    <span class="n">desc</span><span class="o">=</span><span class="n">reference_image_desc</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;files_to_resample&quot;</span><span class="p">,</span>
                       <span class="n">InputMultiPath</span><span class="p">(</span><span class="n">ImageFileSPM</span><span class="p">(),</span>
                                      <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                      <span class="n">desc</span><span class="o">=</span><span class="n">files_to_resample_desc</span><span class="p">))</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;suffix_to_delete&quot;</span><span class="p">,</span>
                       <span class="n">traits</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="s2">&quot;_002&quot;</span><span class="p">,</span>
                                     <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                     <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                     <span class="n">desc</span><span class="o">=</span><span class="n">suffix_to_delete_desc</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;suffix&quot;</span><span class="p">,</span>
                       <span class="n">traits</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="s2">&quot;_003&quot;</span><span class="p">,</span>
                                     <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                     <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                     <span class="n">desc</span><span class="o">=</span><span class="n">suffix_desc</span><span class="p">))</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;prefix&quot;</span><span class="p">,</span>
                       <span class="n">traits</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span>
                                     <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                     <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                     <span class="n">desc</span><span class="o">=</span><span class="n">prefix_desc</span><span class="p">))</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;interp&quot;</span><span class="p">,</span>
                       <span class="n">traits</span><span class="o">.</span><span class="n">Range</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                                    <span class="n">low</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                    <span class="n">high</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                                    <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                    <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                    <span class="n">desc</span><span class="o">=</span><span class="n">interp_desc</span><span class="p">))</span>

        <span class="c1"># Outputs traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;out_files&quot;</span><span class="p">,</span>
                       <span class="n">OutputMultiPath</span><span class="p">(</span><span class="n">File</span><span class="p">(),</span>
                                       <span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                       <span class="n">desc</span><span class="o">=</span><span class="n">out_files_desc</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">init_default_traits</span><span class="p">()</span></div>

<div class="viewcode-block" id="Resample.list_outputs"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.others.html#mia_processes.bricks.preprocess.others.processing.Resample.list_outputs">[docs]</a>    <span class="k">def</span> <span class="nf">list_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_plugged</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the initialisation step of the brick.</span>

<span class="sd">        The main objective of this method is to produce the outputs of the</span>
<span class="sd">        bricks (self.outputs) and the associated tags (self.inheritance_dic),</span>
<span class="sd">        if defined here. To work properly this method must return </span>
<span class="sd">        self.make_initResult() object.</span>

<span class="sd">        :param is_plugged: the state, linked or not, of the plugs.</span>
<span class="sd">        :returns: a dictionary with requirement, outputs and inheritance_dict.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Using the inheritance to ProcessMIA class, list_outputs method</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Resample</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">list_outputs</span><span class="p">()</span>

        <span class="c1"># Outputs definition</span>
        <span class="k">if</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">reference_image</span><span class="p">)</span> <span class="ow">and</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files_to_resample</span><span class="p">)</span> <span class="ow">and</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">interp</span><span class="p">)):</span>
            <span class="n">files</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">files_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">files_to_resample</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">refName</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reference_image</span><span class="p">)</span>
                
            <span class="k">except</span> <span class="p">(</span><span class="n">nib</span><span class="o">.</span><span class="n">filebasedimages</span><span class="o">.</span><span class="n">ImageFileError</span><span class="p">,</span>
                    <span class="ne">FileNotFoundError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Error with reference_image, during initialisation: &quot;</span><span class="p">,</span>
                      <span class="n">e</span><span class="p">)</span>
                <span class="n">refName</span> <span class="o">=</span> <span class="kc">None</span>
            
            <span class="k">if</span> <span class="p">((</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">suffix_to_delete</span><span class="p">)</span> <span class="ow">or</span>
                    <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">suffix_to_delete</span><span class="o">.</span><span class="n">isspace</span><span class="p">())</span> <span class="ow">or</span>
                    <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">suffix_to_delete</span> <span class="ow">in</span> <span class="p">[</span><span class="n">Undefined</span><span class="p">,</span> <span class="s2">&quot;&lt;undefined&gt;&quot;</span><span class="p">])):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">suffix_to_delete</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span>

            <span class="k">if</span> <span class="p">((</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span><span class="p">)</span> <span class="ow">or</span>
                    <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">isspace</span><span class="p">())</span> <span class="ow">or</span>
                    <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">suffix</span> <span class="ow">in</span> <span class="p">[</span><span class="n">Undefined</span><span class="p">,</span> <span class="s2">&quot;&lt;undefined&gt;&quot;</span><span class="p">])):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span>

            <span class="k">if</span> <span class="p">((</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="p">)</span> <span class="ow">or</span>
                    <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="o">.</span><span class="n">isspace</span><span class="p">())</span> <span class="ow">or</span>
                    <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span> <span class="ow">in</span> <span class="p">[</span><span class="n">Undefined</span><span class="p">,</span> <span class="s2">&quot;&lt;undefined&gt;&quot;</span><span class="p">])):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span>
           
            <span class="k">for</span> <span class="n">file_name</span> <span class="ow">in</span> <span class="n">files_name</span><span class="p">:</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">fileName</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>

                <span class="k">except</span> <span class="p">(</span><span class="n">nib</span><span class="o">.</span><span class="n">filebasedimages</span><span class="o">.</span><span class="n">ImageFileError</span><span class="p">,</span>
                        <span class="ne">FileNotFoundError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Error with files_to_resample, during &quot;</span>
                           <span class="s2">&quot;initialisation: &quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
                    <span class="n">fileName</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">refName</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">fileName</span><span class="p">):</span>

                    <span class="k">if</span> <span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">fileName</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">)</span> <span class="ow">or</span>
                                               <span class="p">(</span><span class="mi">3</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">refName</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)):</span>
                        <span class="n">msg</span> <span class="o">=</span> <span class="n">QMessageBox</span><span class="p">()</span>
                        <span class="n">msg</span><span class="o">.</span><span class="n">setIcon</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Warning</span><span class="p">)</span>
                        <span class="n">msg</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="s2">&quot;mia_processes - &quot;</span>
                                           <span class="s2">&quot;Resample brick Warning!&quot;</span><span class="p">)</span>
                        <span class="n">msg</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="s2">&quot;Currently, the Resample brick only allows &quot;</span>
                                    <span class="s2">&quot;to resample 3D images from 3D or 4D &quot;</span>
                                    <span class="s2">&quot;reference images.</span><span class="se">\n\n</span><span class="s2"> However the &#39;</span><span class="si">{0}</span><span class="s2">&#39; &quot;</span>
                                    <span class="s2">&quot;reference image is a </span><span class="si">{1}</span><span class="s2">D and the &#39;</span><span class="si">{2}</span><span class="s2">&#39; &quot;</span>
                                    <span class="s2">&quot;image is a </span><span class="si">{3}</span><span class="s2">D ...</span><span class="se">\n\n</span><span class="s2">Please, modify &quot;</span>
                                    <span class="s2">&quot;your input and initialise again this &quot;</span>
                                    <span class="s2">&quot;brick.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reference_image</span><span class="p">,</span>
                                                    <span class="nb">len</span><span class="p">(</span><span class="n">refName</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span>
                                                    <span class="n">file_name</span><span class="p">,</span>
                                                    <span class="nb">len</span><span class="p">(</span><span class="n">fileName</span><span class="o">.</span><span class="n">shape</span><span class="p">)))</span>
                        <span class="n">msg</span><span class="o">.</span><span class="n">setStandardButtons</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Close</span><span class="p">)</span>
                        <span class="n">msg</span><span class="o">.</span><span class="n">buttonClicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
                        <span class="n">msg</span><span class="o">.</span><span class="n">exec</span><span class="p">()</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Resample brick: Initialisation failed ... &quot;</span>
                              <span class="s2">&quot;Please check the input parameters!&quot;</span><span class="p">)</span>
                        <span class="n">files_name</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="k">break</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="n">QMessageBox</span><span class="p">()</span>
                    <span class="n">msg</span><span class="o">.</span><span class="n">setIcon</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Warning</span><span class="p">)</span>
                    <span class="n">msg</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="s2">&quot;mia_processes - &quot;</span>
                                       <span class="s2">&quot;Resample brick Warning!&quot;</span><span class="p">)</span>
                    <span class="n">msg</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="s2">&quot;files_to_resample &#39;</span><span class="si">{0}</span><span class="s2">&#39; or/and &quot;</span>
                                <span class="s2">&quot;reference_image &#39;</span><span class="si">{1}</span><span class="s2">&#39; is (are) empty ... Do &quot;</span>
                                <span class="s2">&quot;you want to continue? </span><span class="se">\n\n</span><span class="s2">&quot;</span>
                                <span class="s2">&quot;- To correct the input parameters &quot;</span>
                                <span class="s2">&quot;click &#39;Abort&#39;.</span><span class="se">\n\n</span><span class="s2">&quot;</span>
                                <span class="s2">&quot;- If the Resample brick is located in a &quot;</span>
                                <span class="s2">&quot;pipeline, it may be usual that this(these) &quot;</span>
                                <span class="s2">&quot;parameter(s) is(are) empty at the &quot;</span>
                                <span class="s2">&quot;initialisation time. In this case, if the &quot;</span>
                                <span class="s2">&quot;files_to_resample and the reference_image &quot;</span>
                                <span class="s2">&quot;parameters correspond to a 3D image and a 3D &quot;</span>
                                <span class="s2">&quot;or a 4D, respectively, click &#39;Yes&#39;, &quot;</span>
                                <span class="s2">&quot;otherwise click &#39;Abort&#39; and change the input &quot;</span>
                                <span class="s2">&quot;parameters.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span>
                                                     <span class="bp">self</span><span class="o">.</span><span class="n">reference_image</span><span class="p">))</span>
                    <span class="n">msg</span><span class="o">.</span><span class="n">setStandardButtons</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Yes</span> <span class="o">|</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">Abort</span><span class="p">)</span>
                    <span class="n">retval</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">exec_</span><span class="p">()</span>
                    
                    <span class="k">if</span> <span class="n">retval</span> <span class="o">==</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">Yes</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Resample brick Warning!: Empty input file(s). &quot;</span>
                              <span class="s2">&quot;No check of the dimensions of the input images &quot;</span>
                              <span class="s2">&quot;is done ... (files_to_resample must be a 3D and &quot;</span>
                              <span class="s2">&quot;reference_image must be a 3D or a 4D) ...&quot;</span><span class="p">)</span>

                    <span class="k">else</span><span class="p">:</span>
                         <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Resample brick: Initialisation failed ... &quot;</span>
                               <span class="s2">&quot;Please check the input parameters!&quot;</span><span class="p">)</span>
                         <span class="n">files_name</span> <span class="o">=</span> <span class="kc">None</span>
                         <span class="k">break</span>
                
                <span class="n">path</span><span class="p">,</span> <span class="n">file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
                <span class="n">file_name_no_ext</span><span class="p">,</span> <span class="n">file_extension</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>

                <span class="k">if</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">suffix_to_delete</span> <span class="o">!=</span> <span class="s2">&quot; &quot;</span><span class="p">)</span> <span class="ow">and</span>
                        <span class="p">(</span><span class="n">file_name_no_ext</span><span class="p">[</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">suffix_to_delete</span><span class="p">):]</span> <span class="o">==</span>
                                                        <span class="bp">self</span><span class="o">.</span><span class="n">suffix_to_delete</span><span class="p">)):</span>
                    <span class="n">file_name_no_ext</span> <span class="o">=</span> <span class="p">(</span>
                                 <span class="n">file_name_no_ext</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">suffix_to_delete</span><span class="p">)])</span>
                    
                <span class="n">files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span>
                                          <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">+</span>
                                                 <span class="n">file_name_no_ext</span> <span class="o">+</span>
                                                 <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">+</span>
                                                 <span class="n">file_extension</span><span class="p">)))</span>
                
            <span class="c1"># May overwrite an input image with an output image</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">suffix</span> <span class="o">==</span> <span class="s2">&quot; &quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span> <span class="o">==</span> <span class="s2">&quot; &quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">files_name</span><span class="p">):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="n">QMessageBox</span><span class="p">()</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">setIcon</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Warning</span><span class="p">)</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="s2">&quot;mia_processes - &quot;</span>
                                   <span class="s2">&quot;Resample brick Warning!&quot;</span><span class="p">)</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="s2">&quot;Suffix and prefix input parameters are not &quot;</span>
                            <span class="s2">&quot;defined or consist only of one or more white &quot;</span>
                            <span class="s2">&quot;spaces.</span><span class="se">\n\n</span><span class="s2">The files_to_resample input parameter &quot;</span>
                            <span class="s2">&quot;(if suffix_to_delete input parameter is not set) &quot;</span>
                            <span class="s2">&quot;or other files (if suffix_to_delete input &quot;</span>
                            <span class="s2">&quot;parameter is set) could be overwritten ... this &quot;</span>
                            <span class="s2">&quot;concerns the following images:</span><span class="se">\n</span><span class="si">{}</span><span class="se">\n\n</span><span class="s2">Do you &quot;</span>
                            <span class="s2">&quot;agree to use these input &quot;</span>
                            <span class="s2">&quot;parameters?&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">files</span><span class="p">)))</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">setStandardButtons</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Yes</span> <span class="o">|</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">Abort</span><span class="p">)</span>
                <span class="n">retval</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">exec_</span><span class="p">()</span>

                <span class="k">if</span> <span class="n">retval</span> <span class="o">==</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">Yes</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Resample brick warning: suffix and prefix input &#39;</span>
                          <span class="s1">&#39;parameters are not defined, the following files &#39;</span>
                          <span class="s1">&#39;could be overwrite!:</span><span class="se">\n</span><span class="si">{0}</span><span class="s1"> ...</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">files</span><span class="p">)))</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">files_name</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="c1"># Two (at least) input images give the same output image</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">files</span><span class="p">)))</span> <span class="ow">and</span> <span class="p">(</span><span class="n">files_name</span><span class="p">):</span>
                <span class="n">dupes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                <span class="n">seen</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>

                    <span class="k">if</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
                        <span class="n">dupes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

                    <span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

                <span class="n">msg</span> <span class="o">=</span> <span class="n">QMessageBox</span><span class="p">()</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">setIcon</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Warning</span><span class="p">)</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="s2">&quot;mia_processes - &quot;</span>
                                   <span class="s2">&quot;Resample brick Warning!&quot;</span><span class="p">)</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="s2">&quot;The suffix, prefix and suffix_to_delete input &quot;</span>
                            <span class="s2">&quot;parameters combination seems to create for at &quot;</span>
                            <span class="s2">&quot;least two different input images the same output &quot;</span>
                            <span class="s2">&quot;image:</span><span class="se">\n</span><span class="si">{}</span><span class="se">\n\n</span><span class="s2">Please change the suffix, prefix &quot;</span>
                            <span class="s2">&quot;and suffix_to_delete input parameters combination &quot;</span>
                            <span class="s2">&quot;and initialise again this brick.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dupes</span><span class="p">))</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">setStandardButtons</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Close</span><span class="p">)</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">buttonClicked</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">close</span><span class="p">)</span>
                <span class="n">msg</span><span class="o">.</span><span class="n">exec</span><span class="p">()</span>
                <span class="n">files_name</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="n">files_name</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;out_files&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">files</span>

        <span class="c1">#Tags inheritance (optional)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">:</span>

            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;out_files&quot;</span><span class="p">:</span>

                    <span class="k">for</span> <span class="n">in_val</span><span class="p">,</span> <span class="n">out_val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">files_name</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
                        <span class="n">_</span><span class="p">,</span> <span class="n">fileOval</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">out_val</span><span class="p">)</span>
                        <span class="n">fileOval_no_ext</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">fileOval</span><span class="p">)</span>

                        <span class="k">if</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">suffix</span> <span class="o">!=</span> <span class="s2">&quot; &quot;</span><span class="p">)</span> <span class="ow">and</span>
                                <span class="p">(</span><span class="n">fileOval_no_ext</span><span class="p">[</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">suffix</span><span class="p">):]</span> <span class="o">==</span>
                                                                  <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span><span class="p">)):</span>
                            <span class="n">fileOval_no_ext</span> <span class="o">=</span> <span class="n">fileOval_no_ext</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span>
                                                                        <span class="n">suffix</span><span class="p">)]</span>

                        <span class="k">if</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span> <span class="o">!=</span> <span class="s2">&quot; &quot;</span><span class="p">)</span> <span class="ow">and</span>
                                <span class="p">(</span><span class="n">fileOval_no_ext</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="p">)]</span> <span class="o">==</span>
                                                                  <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="p">)):</span>
                            <span class="n">fileOval_no_ext</span> <span class="o">=</span> <span class="p">(</span><span class="n">fileOval_no_ext</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span>
                                                                      <span class="n">prefix</span><span class="p">):])</span>

                        <span class="n">_</span><span class="p">,</span> <span class="n">fileIval</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">in_val</span><span class="p">)</span>
                        <span class="n">fileIval_no_ext</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">fileIval</span><span class="p">)</span>

                        <span class="k">if</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">suffix_to_delete</span> <span class="o">!=</span> <span class="s2">&quot; &quot;</span><span class="p">)</span> <span class="ow">and</span>
                            <span class="p">(</span><span class="n">fileIval_no_ext</span><span class="p">[</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">suffix_to_delete</span><span class="p">):]</span> <span class="o">==</span>
                                                        <span class="bp">self</span><span class="o">.</span><span class="n">suffix_to_delete</span><span class="p">)):</span>
                            <span class="n">fileOval_no_ext</span> <span class="o">=</span> <span class="p">(</span><span class="n">fileOval_no_ext</span> <span class="o">+</span>
                                               <span class="bp">self</span><span class="o">.</span><span class="n">suffix_to_delete</span><span class="p">)</span>

                        <span class="k">if</span> <span class="n">fileOval_no_ext</span> <span class="o">==</span> <span class="n">fileIval_no_ext</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">inheritance_dict</span><span class="p">[</span><span class="n">out_val</span><span class="p">]</span> <span class="o">=</span> <span class="n">in_val</span>

        <span class="c1"># Return the requirement, outputs and inheritance_dict</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_initResult</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_check_interp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Checks the order of the splines interpolation.</span>

<span class="sd">        :returns: a message according to the selected order</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># skimage.transform.resize (does not seem to be the best solution for</span>
        <span class="c1"># resampling):</span>
        <span class="c1"># - B-splines of the order 0 and 1 correspond to nearest neighbour and</span>
        <span class="c1">#   linear interpolation, respectively.</span>
        <span class="c1"># - B-splines of a higher order can be defined by a repetitive</span>
        <span class="c1">#   convolution of the zeroth-order spline (the box function) with</span>
        <span class="c1">#   itself.</span>
        <span class="c1">#</span>
        <span class="c1"># nibabel.processing.resample_from_to (seems to be a good solution, but</span>
        <span class="c1"># can give non-zero intensity for the background -&gt; needs thresolding ?)</span>
        <span class="c1">#</span>
        <span class="c1"># nilearn.image.resample_to_img (seems to be a good solution, no</span>
        <span class="c1"># non-zero intensity for the background observed)</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interp</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># skimage and nibabel: Nearest neighbour</span>
            <span class="k">return</span> <span class="s2">&quot;spline interpolation of order 0 (Nearest-neighbour)&quot;</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">interp</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># skimage: It seems that with dimensions=3 and B-spline order=1,</span>
            <span class="c1">#          the interpolation would be equivalent to &quot;trilinear&quot;</span>
            <span class="c1">#return (&quot;Bi-linear (with dimensions=3, Bi-linear is equivalent &quot;</span>
            <span class="c1">#        &quot;to &#39;trilinear&#39;)&quot;)</span>

            <span class="c1"># nibabel: spline interpolation of order 1</span>
            <span class="k">return</span> <span class="s2">&quot;spline interpolation of order 1&quot;</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">interp</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="c1"># skimage:</span>
            <span class="c1"># return &quot;Bi-quadratic&quot;</span>

            <span class="c1"># nibabel: spline interpolation of order 2</span>
            <span class="k">return</span> <span class="s2">&quot;spline interpolation of order 2&quot;</span>
        
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">interp</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="c1"># skimage</span>
            <span class="c1"># return &quot;Bi-cubic&quot;</span>

            <span class="c1"># nibabel: spline interpolation of order 3: trilinear</span>
            <span class="k">return</span> <span class="s2">&quot;spline interpolation of order 3 (trilinear)&quot;</span>
        
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">interp</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="c1"># skimage</span>
            <span class="c1"># return &quot;Bi-quartic&quot;</span>

            <span class="c1"># nibabel: spline interpolation of order 4</span>
            <span class="k">return</span> <span class="s2">&quot;spline interpolation of order 4&quot;</span>
         
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">interp</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
            <span class="c1"># skimage</span>
            <span class="c1"># return &quot;Bi-quintic&quot;</span>

            <span class="c1"># nibabel: spline interpolation of order 5</span>
            <span class="k">return</span> <span class="s2">&quot;spline interpolation of order 5&quot;</span>

<div class="viewcode-block" id="Resample.run_process_mia"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.others.html#mia_processes.bricks.preprocess.others.processing.Resample.run_process_mia">[docs]</a>    <span class="k">def</span> <span class="nf">run_process_mia</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the process launch step of the brick.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Resample</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">run_process_mia</span><span class="p">()</span>
        <span class="n">files_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">files_to_resample</span>
        <span class="n">refName</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reference_image</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Resample process from mia_processes: </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span>
              <span class="bp">self</span><span class="o">.</span><span class="n">_check_interp</span><span class="p">(),</span> <span class="s1">&#39; </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">file_name</span> <span class="ow">in</span> <span class="n">files_name</span><span class="p">:</span>
            <span class="n">fileName</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
            <span class="c1">#mask_data = mask.get_fdata()  # skimage</span>
              
            <span class="c1"># Currently, resampling is only done for 3D images using 3D</span>
            <span class="c1"># or 4D images for reference. It would be interesting to widen the</span>
            <span class="c1"># possibilities to more cases (at least a 4D using a 3D, and why</span>
            <span class="c1"># not, to larger dimensions?). Currently we use</span>
            <span class="c1"># nibabel.processing.resample_from_to(), (see</span>
            <span class="c1"># https://mail.python.org/pipermail/neuroimaging/2019-January/001902.html).</span>
            <span class="c1"># It seems this method produces a little noise (can give non-zero</span>
            <span class="c1"># intensity for the background). In addition to the resolution</span>
            <span class="c1"># settings it seems the size of the reference_image are also</span>
            <span class="c1"># transferred to the resampled image but not the orientations and</span>
            <span class="c1"># positions (output space comes from the affine of</span>
            <span class="c1"># files_to_resample).</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fileName</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">refName</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="c1"># nibabel:</span>
                <span class="n">fileFinal</span> <span class="o">=</span> <span class="n">nibp</span><span class="o">.</span><span class="n">resample_from_to</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span>
                                                  <span class="n">refName</span><span class="p">,</span>
                                                  <span class="n">order</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">interp</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fileName</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">refName</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                <span class="c1"># skimage</span>
                <span class="c1">#ref_size = ref_data.shape[:3]</span>
                <span class="c1">#resized_mask_data = resize(mask_data,</span>
                <span class="c1">#                           ref_size,</span>
                <span class="c1">#                           order=self.interp,</span>
                <span class="c1">#                           mode=&#39;reflect&#39;)</span>
                <span class="c1"># TODO: Taking info of mask&#39;s or ref&#39;s header?</span>
                <span class="c1">#mask_final = nib.Nifti1Image(resized_mask_data,</span>
                <span class="c1">#                             ref.affine,</span>
                <span class="c1">#                             ref.header)</span>

                <span class="c1"># nibabel:</span>
                <span class="n">fileFinal</span> <span class="o">=</span> <span class="n">nibp</span><span class="o">.</span><span class="n">resample_from_to</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span>
                                                  <span class="n">refName</span><span class="o">.</span><span class="n">slicer</span><span class="p">[:,:,:,</span><span class="mi">0</span><span class="p">],</span>
                                                  <span class="n">order</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">interp</span><span class="p">)</span>

            <span class="c1"># Image save</span>
            <span class="n">path</span><span class="p">,</span> <span class="n">file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
            <span class="n">file_name_no_ext</span><span class="p">,</span> <span class="n">file_extension</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>

            <span class="k">if</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">suffix_to_delete</span> <span class="o">!=</span> <span class="s2">&quot; &quot;</span><span class="p">)</span> <span class="ow">and</span>
                        <span class="p">(</span><span class="n">file_name_no_ext</span><span class="p">[</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">suffix_to_delete</span><span class="p">):]</span> <span class="o">==</span>
                                                        <span class="bp">self</span><span class="o">.</span><span class="n">suffix_to_delete</span><span class="p">)):</span>
                <span class="n">file_name_no_ext</span> <span class="o">=</span> <span class="p">(</span>
                                 <span class="n">file_name_no_ext</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">suffix_to_delete</span><span class="p">)])</span>
                    
            <span class="n">file_out</span><span class="o">=</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span>
                                    <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">+</span>
                                     <span class="n">file_name_no_ext</span> <span class="o">+</span>
                                     <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">+</span>
                                     <span class="n">file_extension</span><span class="p">)))</span>
            <span class="n">nib</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">fileFinal</span><span class="p">,</span> <span class="n">file_out</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="Threshold"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.others.html#mia_processes.bricks.preprocess.others.processing.Threshold">[docs]</a><span class="k">class</span> <span class="nc">Threshold</span><span class="p">(</span><span class="n">ProcessMIA</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    *Image thresholding*</span>

<span class="sd">    Please, see the complete documention for the `Threshold brick in the populse.mia_processes web site</span>
<span class="sd">    https://populse.github.io/mia_processes/documentation/bricks/preprocess/other/Threshold.html</span>

<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="Threshold.__init__"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.others.html#mia_processes.bricks.preprocess.others.processing.Threshold.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the attributes initialisation / instanciation.</span>
<span class="sd">        </span>
<span class="sd">        The input and output plugs are defined here. The special</span>
<span class="sd">        &#39;self.requirement&#39; attribute (optional) is used to define the</span>
<span class="sd">        third-party products necessary for the running of the brick.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Initialisation of the objects needed for the launch of the brick</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Threshold</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1"># Third party softwares required for the execution of the brick</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requirement</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Inputs description</span>
        <span class="n">in_files_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;A list of items with string elements corresponding &#39;</span>
                         <span class="s1">&#39;to existing path files.&#39;</span><span class="p">)</span>
        <span class="n">threshold_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Value for the applied threshold (a float between 0 &#39;</span>
                          <span class="s1">&#39;and 1).&#39;</span><span class="p">)</span>
        <span class="n">GM_filtering_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Filtering (based on the keyword c1) to keep only &#39;</span>
                             <span class="s1">&#39;grey matter images (a boolean)&#39;</span><span class="p">)</span>
        <span class="n">suffix_desc</span> <span class="o">=</span> <span class="s1">&#39;Suffix of the output image (a string).&#39;</span>
        <span class="n">prefix_desc</span> <span class="o">=</span> <span class="s1">&#39;Prefix of the output image (a string).&#39;</span>
        
        <span class="c1"># Outputs description</span>
        <span class="n">out_files_desc</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Path of the scan after application of the threshold &#39;</span>
                         <span class="s1">&#39;(a pathlike object or string representing a file, or &#39;</span>
                         <span class="s1">&#39;a list of pathlike objects or strings representing a &#39;</span>
                         <span class="s1">&#39;file).&#39;</span><span class="p">)</span>
        
        <span class="c1"># Inputs traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;in_files&quot;</span><span class="p">,</span>
                       <span class="n">InputMultiPath</span><span class="p">(</span><span class="n">traits</span><span class="o">.</span><span class="n">Either</span><span class="p">(</span><span class="n">ImageFileSPM</span><span class="p">(),</span>
                                                   <span class="n">traits</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">ImageFileSPM</span><span class="p">())),</span>
                                      <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                      <span class="n">desc</span><span class="o">=</span><span class="n">in_files_desc</span><span class="p">))</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;threshold&quot;</span><span class="p">,</span>
                       <span class="n">traits</span><span class="o">.</span><span class="n">Range</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span>
                                    <span class="n">low</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                                    <span class="n">high</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                                    <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                    <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                    <span class="n">desc</span><span class="o">=</span><span class="n">threshold_desc</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;GM_filtering&quot;</span><span class="p">,</span>
                       <span class="n">traits</span><span class="o">.</span><span class="n">Bool</span><span class="p">(</span><span class="n">default_value</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                   <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">desc</span><span class="o">=</span><span class="n">GM_filtering_desc</span><span class="p">))</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;suffix&quot;</span><span class="p">,</span>
                       <span class="n">traits</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="s2">&quot;_002&quot;</span><span class="p">,</span>
                                     <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                     <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                     <span class="n">desc</span><span class="o">=</span><span class="n">suffix_desc</span><span class="p">))</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;prefix&quot;</span><span class="p">,</span>
                       <span class="n">traits</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                                     <span class="n">output</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                     <span class="n">optional</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                     <span class="n">desc</span><span class="o">=</span><span class="n">prefix_desc</span><span class="p">))</span>

        <span class="c1"># Outputs traits</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_trait</span><span class="p">(</span><span class="s2">&quot;out_files&quot;</span><span class="p">,</span>
                       <span class="n">OutputMultiPath</span><span class="p">(</span><span class="n">File</span><span class="p">(),</span>
                                       <span class="n">output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                       <span class="n">desc</span><span class="o">=</span><span class="n">out_files_desc</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">init_default_traits</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_namesFilter</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Filtering of in_files input parameter in order to keep only GM.</span>

<span class="sd">        :returns: GM images (containing &quot;c1&quot; in the first 5 characters)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">files</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">file_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_files</span><span class="p">:</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="n">TraitListObject</span><span class="p">)):</span>
                <span class="n">file_name</span> <span class="o">=</span> <span class="n">file_name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="c1"># Take the first 5 characters in the case if the GM was processed</span>
            <span class="c1"># ex. normalisation = wc1, normalisation then smooth = swc1 ...</span>
            <span class="c1"># This is not the cleaner way ... in case of a file name</span>
            <span class="c1"># (PatientName) starting with c1 !</span>
            <span class="k">if</span> <span class="s1">&#39;c1&#39;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">file_name</span><span class="p">))[:</span><span class="mi">5</span><span class="p">]:</span>
                <span class="n">files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">files</span>

<div class="viewcode-block" id="Threshold.list_outputs"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.others.html#mia_processes.bricks.preprocess.others.processing.Threshold.list_outputs">[docs]</a>    <span class="k">def</span> <span class="nf">list_outputs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_plugged</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the initialisation step of the brick.</span>

<span class="sd">        The main objective of this method is to produce the outputs of the</span>
<span class="sd">        bricks (self.outputs) and the associated tags (self.inheritance_dic),</span>
<span class="sd">        if defined here. To work properly this method must return </span>
<span class="sd">        self.make_initResult() object.</span>

<span class="sd">        :param is_plugged: the state, linked or not, of the plugs.</span>
<span class="sd">        :returns: a dictionary with requirement, outputs and inheritance_dict.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Using the inheritance to ProcessMIA class, list_outputs method</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Threshold</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">list_outputs</span><span class="p">()</span>

        <span class="c1"># Outputs definition</span>
        <span class="k">if</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">in_files</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="p">)):</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">GM_filtering</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">files_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_namesFilter</span><span class="p">()</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">files_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_files</span>

            <span class="k">if</span> <span class="p">((</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">isspace</span><span class="p">())</span> <span class="ow">or</span>
                                     <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span> <span class="ow">in</span> <span class="p">[</span><span class="n">Undefined</span><span class="p">,</span> <span class="s2">&quot;&lt;undefined&gt;&quot;</span><span class="p">]):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span>

            <span class="k">if</span> <span class="p">((</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="o">.</span><span class="n">isspace</span><span class="p">())</span> <span class="ow">or</span>
                                   <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span> <span class="ow">in</span> <span class="p">[</span><span class="n">Undefined</span><span class="p">,</span> <span class="s2">&quot;&lt;undefined&gt;&quot;</span><span class="p">])):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span>

            <span class="n">files</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">flag</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1"># If False, suf/pref check will not be performed later</span>
            <span class="n">retval</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">for</span> <span class="n">file_name1</span> <span class="ow">in</span> <span class="n">files_name</span><span class="p">:</span>
                <span class="n">path</span><span class="p">,</span> <span class="n">file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">file_name1</span><span class="p">)</span>

                <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">suffix</span> <span class="o">==</span> <span class="s2">&quot; &quot;</span> <span class="ow">and</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">prefix</span> <span class="o">==</span> <span class="s2">&quot; &quot;</span> <span class="ow">and</span>
                            <span class="n">path</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span> <span class="ow">and</span> <span class="n">flag</span> <span class="ow">is</span> <span class="kc">True</span> <span class="p">):</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="n">QMessageBox</span><span class="p">()</span>
                    <span class="n">msg</span><span class="o">.</span><span class="n">setIcon</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Warning</span><span class="p">)</span>
                    <span class="n">msg</span><span class="o">.</span><span class="n">setWindowTitle</span><span class="p">(</span><span class="s2">&quot;mia_processes - &quot;</span>
                                       <span class="s2">&quot;Threshold brick Warning!&quot;</span><span class="p">)</span>
                    <span class="n">msg</span><span class="o">.</span><span class="n">setText</span><span class="p">(</span><span class="s2">&quot;Suffix and prefix input parameters are not &quot;</span>
                                <span class="s2">&quot;defined or consist only of one or more white &quot;</span>
                                <span class="s2">&quot;spaces.</span><span class="se">\n</span><span class="s2">The </span><span class="si">{0}</span><span class="s2"> input parameter will be &quot;</span>
                                <span class="s2">&quot;overwritten ...</span><span class="se">\n</span><span class="s2"> Yes or &quot;</span>
                                <span class="s2">&quot;Abort?&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file_name1</span><span class="p">))</span>
                    <span class="n">msg</span><span class="o">.</span><span class="n">setStandardButtons</span><span class="p">(</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">Yes</span><span class="o">|</span><span class="n">QMessageBox</span><span class="o">.</span><span class="n">YesToAll</span><span class="o">|</span>
                                           <span class="n">QMessageBox</span><span class="o">.</span><span class="n">Abort</span><span class="p">)</span>
                    <span class="n">retval</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">exec_</span><span class="p">()</span>

                    <span class="k">if</span> <span class="n">retval</span> <span class="o">!=</span>  <span class="n">QMessageBox</span><span class="o">.</span><span class="n">Abort</span><span class="p">:</span>
                        <span class="p">(</span><span class="n">file_name_no_ext</span><span class="p">,</span>
                         <span class="n">file_extension</span><span class="p">)</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
                        <span class="n">files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span>
                                                  <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">+</span>
                                                   <span class="n">file_name_no_ext</span> <span class="o">+</span>
                                                   <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">+</span>
                                                   <span class="n">file_extension</span><span class="p">)))</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Threshold brick warning: the out_files output &#39;</span>
                              <span class="s1">&#39;parameter is the same as the in_files input &#39;</span>
                              <span class="s1">&#39;parameter (suffix and prefix are not defined):&#39;</span>
                              <span class="s1">&#39;</span><span class="se">\n</span><span class="si">{0}</span><span class="s1"> will be overwrited ...&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file_name1</span><span class="p">))</span>

                        <span class="k">if</span> <span class="n">retval</span> <span class="o">==</span> <span class="n">QMessageBox</span><span class="o">.</span><span class="n">YesToAll</span><span class="p">:</span>
                            <span class="n">flag</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">YesToAll selected: end of overwrite &#39;</span>
                                  <span class="s1">&#39;checks on input images ...&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">files_name</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Aborted. Please check your input parameters ...&#39;</span><span class="p">)</span>
                        <span class="k">break</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="p">(</span><span class="n">file_name_no_ext</span><span class="p">,</span>
                         <span class="n">file_extension</span><span class="p">)</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
                    <span class="n">files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span>
                                              <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">+</span>
                                               <span class="n">file_name_no_ext</span> <span class="o">+</span>
                                               <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">+</span>
                                               <span class="n">file_extension</span><span class="p">)))</span>

            <span class="k">if</span> <span class="n">files_name</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="s1">&#39;out_files&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">files</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;- There was no output file deducted during &#39;</span>
                      <span class="s1">&#39;initialisation. Please check the input parameters...!&#39;</span><span class="p">)</span>

        <span class="c1"># tags inheritance (optional)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">:</span>

            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">key</span> <span class="o">==</span> <span class="s2">&quot;out_files&quot;</span><span class="p">):</span>

                    <span class="k">for</span> <span class="n">in_val</span><span class="p">,</span> <span class="n">out_val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">files_name</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
                        <span class="n">_</span><span class="p">,</span> <span class="n">fileOval</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">out_val</span><span class="p">)</span>
                        <span class="n">fileOval_no_ext</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">fileOval</span><span class="p">)</span>
                        <span class="n">_</span><span class="p">,</span> <span class="n">fileIval</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">in_val</span><span class="p">)</span>
                        <span class="n">fileIval_no_ext</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">fileIval</span><span class="p">)</span>

                        <span class="k">if</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="p">)</span> <span class="ow">and</span>
                                     <span class="p">(</span><span class="n">fileOval_no_ext</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="p">))):</span>
                            <span class="n">fileOval_no_ext</span> <span class="o">=</span> <span class="n">fileOval_no_ext</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="p">):]</span>

                        <span class="k">if</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">suffix</span><span class="p">)</span> <span class="ow">and</span>
                                       <span class="p">(</span><span class="n">fileOval_no_ext</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">suffix</span><span class="p">))):</span>
                            <span class="n">fileOval_no_ext</span> <span class="o">=</span> <span class="n">fileOval_no_ext</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span>
                                                                   <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span><span class="p">)]</span>
                        
                        <span class="k">if</span> <span class="n">fileOval_no_ext</span> <span class="o">==</span> <span class="n">fileIval_no_ext</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">inheritance_dict</span><span class="p">[</span><span class="n">out_val</span><span class="p">]</span> <span class="o">=</span> <span class="n">in_val</span>

        <span class="c1"># Return the requirement, outputs and inheritance_dict</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_initResult</span><span class="p">()</span></div>

<div class="viewcode-block" id="Threshold.run_process_mia"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.others.html#mia_processes.bricks.preprocess.others.processing.Threshold.run_process_mia">[docs]</a>    <span class="k">def</span> <span class="nf">run_process_mia</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dedicated to the process launch step of the brick.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Threshold</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">run_process_mia</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">GM_filtering</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">files_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_namesFilter</span><span class="p">()</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">files_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_files</span>

        <span class="k">for</span> <span class="n">file_name</span> <span class="ow">in</span> <span class="n">files_name</span><span class="p">:</span>
            <span class="c1"># Image processing</span>
            <span class="n">img_final</span> <span class="o">=</span> <span class="n">threshold</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="p">)</span>

            <span class="c1"># Image save</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
            <span class="n">file_name_no_ext</span><span class="p">,</span> <span class="n">file_extension</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
            <span class="n">out_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span>
                                    <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prefix</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">+</span>
                                     <span class="n">file_name_no_ext</span> <span class="o">+</span>
                                     <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">+</span>
                                     <span class="n">file_extension</span><span class="p">))</span>
            <span class="n">nib</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">img_final</span><span class="p">,</span> <span class="n">out_file</span><span class="p">)</span></div></div>

<div class="viewcode-block" id="threshold"><a class="viewcode-back" href="../../../../../mia_processes.bricks.preprocess.others.html#mia_processes.bricks.preprocess.others.processing.threshold">[docs]</a><span class="k">def</span> <span class="nf">threshold</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">thresh</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Basic method for image thresholding</span>

<span class="sd">    :param file_name: Image to be thresholded</span>
<span class="sd">    :param thresh: Threshold value (a float between 0 and 1)</span>
<span class="sd">    :returns: Image after thresholding</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
    <span class="n">img_data</span> <span class="o">=</span> <span class="n">img</span><span class="o">.</span><span class="n">get_fdata</span><span class="p">()</span>
    <span class="n">_max</span> <span class="o">=</span>  <span class="n">img_data</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">img_thresh</span> <span class="o">=</span> <span class="p">(</span><span class="n">img_data</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">_max</span><span class="o">*</span><span class="n">thresh</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">img_final</span> <span class="o">=</span> <span class="n">nib</span><span class="o">.</span><span class="n">Nifti1Image</span><span class="p">(</span><span class="n">img_thresh</span><span class="p">,</span> <span class="n">img</span><span class="o">.</span><span class="n">affine</span><span class="p">,</span> <span class="n">img</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">img_final</span></div>
</pre></div>

      </div>
      <div class="bottomnav" role="navigation" aria-label="bottom navigation">
      
        <p>
        <a class="uplink" href="../../../../../index.html">Contents</a>
        </p>

      </div>

    <div class="footer" role="contentinfo">
        &#169; Copyright 2019, populse.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 4.0.2.
    </div>
  </body>
</html>